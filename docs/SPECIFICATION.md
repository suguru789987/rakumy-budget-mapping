# 予算シミュレーター v17マッピング対応版 機能仕様書

## 1. 概要

### 1.1 目的
顧客が作成した年間予算CSVファイルを読み込み、ラクミー経営管理システムへの入力値に自動変換するシミュレーターツール。

### 1.2 主要機能
- 顧客予算CSVの自動解析・インポート
- 科目コード・科目名による三層マッピング
- MQシミュレーション（売上・利益計算）
- ラクミー入力値の自動生成
- 予算一覧の出力
- 複数店舗対応
- マッピング管理機能（編集・CSV入出力・未使用検出・類似マッチング）
- 出力データ履歴管理
- 0値行の非表示機能
- 予算試算（What-If分析）機能
- 試算履歴の保存・読込機能（localStorage）

### 1.3 バージョン情報
- バージョン: v17マッピング対応版
- 前バージョン: v5.8（顧客CSV対応版）
- 主な変更: v17番号体系への対応、科目コードマッピング追加

---

## 2. システム構成

### 2.1 ファイル構成
```
v15_予算シミュレーター_v17マッピング対応版.html
├── HTML構造（UI）
├── CSS（スタイル）
└── JavaScript（ロジック）
    ├── CODE_BASED_MAP（科目コードマッピング）
    ├── NAME_BASED_MAP（科目名マッピング）
    ├── ITEMS（項目定義）
    ├── CALC_RULES（演算ルール）
    └── RAKUMY_ITEMS（ラクミー項目定義）
```

### 2.2 処理フロー
```
┌─────────────────┐
│ CSVファイル選択 │
└────────┬────────┘
         ↓
┌─────────────────┐
│ CSV解析・店舗検出 │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 月別予算列検出   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 科目コードマッピング │ ← CODE_BASED_MAP
└────────┬────────┘
         ↓ マッチしない場合
┌─────────────────┐
│ 科目名マッピング │ ← NAME_BASED_MAP
└────────┬────────┘
         ↓
┌─────────────────┐
│ 入力前演算実行   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ ラクミー入力値生成│
└────────┬────────┘
         ↓
┌─────────────────┐
│ MQシミュレーション│
└────────┬────────┘
         ↓
┌─────────────────┐
│ 予算一覧・サマリー│
└────────┬────────┘
         ↓
┌─────────────────┐
│ 出力データ履歴保存│
└─────────────────┘
```

---

## 3. データ構造

### 3.1 グローバル変数

| 変数名 | 型 | 説明 |
|--------|------|------|
| `activeMonths` | Array | アクティブな月のインデックス配列 |
| `monthLabels` | Array | 月ラベル配列（例：['4月', '5月', ...]） |
| `budgetColumnPositions` | Array | 各月の予算列位置 |
| `annualData` | Object | 年間予算データ（v17番号→月別値） |
| `calcResults` | Object | 演算結果 |
| `rakumyInputs` | Object | ラクミー入力値 |
| `mqOutputs` | Object | MQシミュレーション出力 |
| `judgments` | Object | 費用設定判定結果 |
| `allStoresData` | Object | 全店舗データ |
| `isEditMode` | Boolean | マッピング編集モードフラグ |
| `unusedMappings` | Array | 未使用マッピングリスト |

### 3.2 三層マッピングシステム

#### CODE_BASED_MAP（科目コードベース）
科目コードから直接v17番号を特定：
```javascript
CODE_BASED_MAP = {
    '461': { v17No: 6, category: '原価', name: '食材仕入高' },
    '512': { v17No: 53, category: '固定費', name: 'ロイヤリティ' },
    // ...
};
```

#### NAME_BASED_MAP（科目名ベース）
科目コードでマッチしない場合のフォールバック：
```javascript
NAME_BASED_MAP = {
    '食材仕入高': { v17No: 6, category: '原価' },
    'ロイヤリティ': { v17No: 53, category: '固定費' },
    '店舗補填': { v17No: 54, category: '固定費' },
    '店舗補てん': { v17No: 54, category: '固定費' },  // 表記揺れ対応
    // ...
};
```

#### 合成値・計算値のNAME_BASED_MAP優先ルール（重要）

**基本方針**: 予算項目の合成値・計算値（合計・小計・差額等）は、科目コードではなくNAME_BASED_MAPで読み取りインポートする。

**理由**:
- 顧客予算表では合成値のコード（9640等）が誤って別の値に貼られている場合がある
- NAME_BASED_MAPは項目名で直接マッピングするため、コード誤りの影響を受けない

**対象項目**（CUSTOMER_CODE_MAP / CODE_TO_V17_MAPから削除済み）:
| 項目名 | v17No | 科目コード（不使用） | 備考 |
|--------|-------|---------------------|------|
| 営業利益 | 63 | 9640 | トリプルチェック実装済み |
| 売上総利益 | 15 | 9580 | 売上高-売上原価 |
| 原価合計 | 14 | 9570 | 食材原価+ドリンク原価 |
| 人件費合計 | 26 | 9605 | 各人件費項目の合計 |
| 販売管理費合計 | 62 | 9630 | 販管費項目の合計 |
| 変動費合計 | 52 | - | 集計項目 |
| 固定費合計 | 60 | - | 集計項目 |
| 限界利益 | - | - | 売上高-変動費 |
| 店舗営業利益 | 61 | - | 売上総利益-販管費 |

**検証機能**: 営業利益にはトリプルチェック機能を実装（NAME_BASED_MAP確認/9640警告/計算検証）

#### ITEMS（項目定義）
v17番号から項目属性を取得：
```javascript
ITEMS = {
    2: { name: '店舗売上高', category: '売上', inputStyle: 'A.そのまま入力' },
    53: { name: 'ロイヤリティ', category: '固定費', inputStyle: 'A.そのまま入力' },
    54: { name: '店舗補填', category: '固定費', inputStyle: 'A.そのまま入力' },
    // ...
};
```

### 3.3 演算ルール（CALC_RULES）

| ルール名 | 計算式 | 説明 |
|----------|--------|------|
| 売上合計 | item:5 | 売上高合計 |
| FD仕入費合計 | item:6 + item:7 | 食材仕入高+ドリンク仕入高 |
| FD仕入費率 | FD仕入費合計 / 売上合計 × 100 | FD原価率 |
| PA人件費合計 | item:13 + item:19 | 雑給+ヘルプ人件費 |
| PA人件費率 | PA人件費合計 / 売上合計 × 100 | PA人件費率 |
| 固定人件費合計 | item:10+14+15+16+17+18 | 固定人件費合計 |
| ランチ売上比率 | item:2 / 売上合計 × 100 | ランチ売上構成比 |
| ディナー売上比率 | item:3 / 売上合計 × 100 | ディナー売上構成比 |
| 地代家賃合計 | item:56 + item:57 | 家賃+賃借料 |
| 資材費合計 | item:58 + item:59 | 警備料+リース料 |

---

## 4. マッピング管理機能

### 4.1 概要
顧客予算項目の変更に柔軟に対応するためのマッピング管理機能。

### 4.2 機能一覧

| 機能 | 関数 | 説明 |
|------|------|------|
| 編集モード切替 | `toggleEditMode()` | マッピング編集UIの表示/非表示 |
| マッピング編集 | `editMapping(code)` | 個別マッピングの編集 |
| マッピング保存 | `saveEditMapping(code)` | 編集内容の保存 |
| マッピング削除 | `deleteMapping(code)` | 個別マッピングの削除 |
| マッピング追加 | `addMapping()` | 新規マッピングの追加 |
| CSV読込 | `importMappingCSV(event)` | CSVからマッピング定義を読込 |
| CSV出力 | `exportMappingCSV()` | マッピング定義をCSV出力 |
| 未使用検出 | `detectUnusedMappings()` | 未使用マッピングの検出 |
| 未使用削除 | `removeUnusedMappings()` | 未使用マッピングの一括削除 |
| 類似検索 | `findSimilarItems()` | 未マッチ項目の類似候補検索 |
| 類似適用 | `applyMappingSuggestion()` | 類似候補からマッピング作成 |

---

## 5. ラクミー入力値構造

### 5.1 費用予算設定（固定費用）

年間を通して同一値を設定する項目：

| キー | 項目名 | データソース |
|------|--------|--------------|
| rent | 地代家賃 | 地代家賃合計（家賃+賃借料） |
| fixedLabor | 固定人件費 | 固定人件費合計 |
| depreciation | 減価償却費 | item:55 |
| material | 資材費 | 資材費合計（警備料+リース料） |
| promotion | 販売促進費 | item:27 |
| ... | ... | ... |
| misc | 雑費 | item:51 |

### 5.2 予算設定（変動費用）

| キー | 項目名 | 説明 |
|------|--------|------|
| fdRate | FD仕入費率 | FD仕入費÷売上×100 |
| paRate | PA人件費率 | PA人件費÷売上×100 |
| targetUnitPrice | 目標客単価（税抜） | 売上÷客数（逆算） |
| targetCustomers | 目標客数 | 自動計算 |
| lunchRatio | ランチ売上比率 | ランチ売上÷売上×100 |
| dinnerRatio | ディナー売上比率 | ディナー売上÷売上×100 |

---

## 6. MQシミュレーション

### 6.1 ラクミーMQ計算の基本概念

ラクミーでは「MQ逆算式」を使用して、**目標月次利益から予算売上を逆算**する。

**入力パラメータ（顧客予算から合成）**：
- 固定費用合計: 費用予算設定の固定費項目を合計
- 変動費率: FD仕入費率 + PA人件費率
- 目標月次利益: 顧客予算の営業利益（No.63）を使用
- 目標客単価: ユーザー設定値

### 6.2 MQ逆算式（重要）

```javascript
// ★★★ MQ逆算式 ★★★
// 入力: 固定費、変動費率、目標月次利益、目標客単価
// 出力: 目標客数、予算売上、予算営業利益

// 1. 必要な限界利益 = 固定費 + 目標月次利益
requiredGrossProfit = fixedCost + targetProfit

// 2. 必要な売上 = 限界利益 / (1 - 変動費率)
//    ※ 限界利益 = 売上 × (1 - 変動費率) なので逆算
grossProfitRate = 1 - variableRate
requiredSales = requiredGrossProfit / grossProfitRate

// 3. 目標客数 = 売上 × 1000 / 客単価
//    ※ 売上は千円単位、客単価は円単位
targetCustomers = Math.round(requiredSales * 1000 / targetUnitPrice)

// 4. 検算：客数 × 客単価で売上を再計算（端数調整）
sales = targetCustomers * targetUnitPrice / 1000
```

### 6.3 順算式（検証用）

```javascript
// 変動費 = 売上 × 変動費率
variableCost = sales × variableRate

// 限界利益 = 売上 - 変動費
grossProfit = sales - variableCost

// 営業利益 = 限界利益 - 固定費
operatingProfit = grossProfit - fixedCost
```

### 6.4 顧客予算からの入力値合成

```javascript
// 固定費用合計（費用予算設定の固定費項目を合計）
fixedCostTotal = 地代家賃合計 + 固定人件費合計 + 減価償却費 + 資材費合計 +
                 販売促進費 + メニューコピー + 調査費 + ... + 雑費

// 変動費率（FD仕入費率 + PA人件費率）
variableRate = (fdRate + paRate) / 100

// 目標月次利益 = 顧客予算の営業利益（No.63）
targetProfit = annualData[63][m]

// 目標客単価 = ユーザー設定
targetUnitPrice = getTargetUnitPrice()
```

### 6.5 重要事項

**顧客予算との差異について**：
- **MQ売上 ≠ 顧客予算売上**: 逆算式で算出するため異なる値になる
- **MQ営業利益 ≈ 顧客予算営業利益**: 目標利益として使用するため近い値（端数調整で若干の差異あり）

**ロイヤリティ（No.53）と店舗補填（No.54）について**：
- これらはv17マッピング表に存在しない顧客独自項目
- 表示のみで、MQ固定費計算には含めない
- 含めると営業利益がマイナスになる可能性あり

### 6.6 出力項目

| 項目 | 説明 | 算出方法 |
|------|------|----------|
| 客数 | 目標客数 | MQ逆算 |
| 客単価 | 目標客単価 | ユーザー設定 |
| 売上 | 予算売上 | MQ逆算 |
| 変動費 | 変動費合計 | 売上×変動費率 |
| 変動費率 | FD+PA率 | 顧客予算から合成 |
| 限界利益 | 売上-変動費 | 計算値 |
| 限界利益率 | 限界利益÷売上×100 | 計算値 |
| 固定費 | 固定費合計 | 顧客予算から合成 |
| 営業利益 | 限界利益-固定費 | MQ計算結果 |
| 営業利益率 | 営業利益÷売上×100 | 計算値 |

### 6.7 MQ計算結果サマリー表示

MQ再計算ボタンを押すと、ボタン下に計算結果サマリーテーブルが表示される。

**表示項目**：
| 項目 | 説明 | 単位 |
|------|------|------|
| 🎯 目標客数 | MQ逆算で算出された必要客数 | 人 |
| 💰 目標売上 | 客数 × 客単価 | 千円 |
| 📈 目標営業利益 | 売上 - 変動費 - 固定費 | 千円 |
| 📊 限界利益単価M | P × (1 - VR) | 円 |

**表示形式**：
- 月別表示（取込月数に応じて動的生成）
- 最終列に合計/平均を表示

### 6.8 目標客単価（ランチ/ディナー）

目標客単価は総合・ランチ・ディナーの3種類を月別に設定可能。

```javascript
// getMQInputs() で取得
monthlyInputs[m] = {
    targetUnitPrice: unitPrice,          // 総合
    targetUnitPriceLunch: lunchUnitPrice, // ランチ
    targetUnitPriceDinner: dinnerUnitPrice // ディナー
};
```

**デフォルト値**：
- 店舗別にデフォルト客単価を設定（DEFAULT_UNIT_PRICES）
- 例: なかめのてっぺん系 → 総合5000円、ランチ0円、ディナー5000円

### 6.9 予算比較サマリー（新UI）

予算試算タブの最上部に「予算比較サマリー」を配置。顧客予算とMQ試算の結果を一目で比較できる。

**比較テーブル構成**：
| 項目 | 顧客予算 | MQ試算 | 差異 | 判定 |
|------|---------|--------|------|------|
| 💰 売上高（千円） | XX,XXX | YY,YYY | +Z,ZZZ | ✅/⚠️ |
| 📈 営業利益（千円） | X,XXX | X,XXX | ±0 | - |
| 🎯 MQ目標客数（人） | - | N,NNN | - | 🎯 |

**達成判定ロジック**：
```javascript
// 顧客予算売上 >= MQ必要売上 → 達成可能
isAchievable = custSales >= mqSales
judgmentText = isAchievable ? '✅ 達成可能' : '⚠️ 要調整'
```

**結論表示**：
- 達成可能時: 「顧客予算売上（XX千円）でMQ必要売上（YY千円）を達成可能です。売上余裕 +ZZ千円」
- 要調整時: 「MQ必要売上に対し、顧客予算売上がZZ千円不足しています。売上増または費用削減が必要です。」

### 6.10 予算試算タブUI構成

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 予算比較サマリー（顧客予算 vs MQ試算）                     │
│   ・売上高/営業利益/目標客数の比較テーブル                   │
│   ・達成判定（✅達成可能/⚠️要調整）と結論文                 │
├─────────────────────────────────────────────────────────────┤
│ ▶ 顧客予算詳細（編集可能）      クリックで展開              │
│ ▶ ラクミー予算詳細（MQ試算結果）  クリックで展開            │
├─────────────────────────────────────────────────────────────┤
│ MQ指標: FD率/PA率/変動費率/粗利率/目標客単価/粗利単価       │
└─────────────────────────────────────────────────────────────┘
```

**ラクミー予算詳細の表示順序**：
1. **MQ試算結果**（赤背景・最上部）: 目標客数/必要売上/目標営業利益/必要粗利/粗利単価
2. **変動費予算**: FD仕入費/PA人件費/変動費合計
3. **固定人件費**: 給料手当/店長昇給/社員給与/etc
4. **固定費**: 販売促進費/etc/固定費合計
5. **損益**: 限界利益/営業利益
6. **MQ計算パラメータ**（グレー背景・最下部）: F/G/FD%/PA%/VR/P

---

## 7. 表示グルーピング

### 7.1 顧客予算項目の表示構造

```
売上予算
├─ No.2  店舗売上高
├─ No.3  ドリンク売上
├─ No.4  その他売上高
└─ No.5  売上高合計 [ハイライト]

変動費予算
├─ No.6  食材仕入高
├─ No.7  ドリンク仕入高
├─ No.13 雑給（PA人件費）
├─ No.19 ヘルプ人件費
└─ [変動費合計] [ハイライト]

固定人件費
├─ No.10 給料手当
├─ No.14 法定福利費
├─ ...
└─ [固定人件費合計] [ハイライト]

固定費（その他経費 + 従来の固定費）
├─ No.27 販売促進費
├─ ...
├─ No.51 雑費
├─ No.52 その他経費小計 [ハイライト]
├─ No.53 ロイヤリティ
├─ No.54 店舗補填
├─ No.55 減価償却費
├─ No.56 家賃
├─ ...
└─ No.60 固定費合計 [ハイライト]

損益
└─ [営業利益]
```

### 7.2 変更点（v5.8からの変更）

- 「その他変動費」（No.27-51）を「固定費」セクションに統合
- セクション名を「その他変動費」から「固定費」に変更
- No.52の項目名を「その他変動費合計」から「その他経費小計」に変更
- ラクミー予算項目を全個別項目表示に拡張

---

## 8. 0値行の非表示機能

### 8.1 概要
インポート取り込みデータ表示において、合計が0の行を非表示にする機能。

### 8.2 実装

```javascript
// renderInputTable関数内
// 合計を先に計算（0値の行を非表示にするため）
var total = 0;
for (var m = 0; m < activeMonths.length; m++) {
    var val = item.rowData ? (item.rowData[m] || 0) : 0;
    total += val;
}
// 合計が0の行はスキップ（非表示）
if (total === 0) return;
```

### 8.3 適用範囲

| 画面 | 0値非表示 |
|------|----------|
| インポート取り込みデータ表示 | 適用 |
| 予算試算テーブル | 非適用（全項目表示） |

---

## 9. CSVエクスポート機能

### 9.1 全店舗エクスポート

「全店舗を選択」チェック時は全店舗データを1つのCSVに縦連結。

### 9.2 出力ファイル名規則

| 条件 | ファイル名 |
|------|-----------|
| 単一店舗 | `{種別}_{店舗名}_{YYYY-MM-DD}.csv` |
| 全店舗 | `{種別}_全店舗_{YYYY-MM-DD}.csv` |

### 9.3 共通仕様

| 項目 | 仕様 |
|------|------|
| 文字コード | UTF-8 with BOM（Excel対応） |
| 金額 | 千円単位、整数、カンマなし |
| 率 | 整数%表示（小数点なし） |

---

## 10. 出力データ履歴管理

### 10.1 概要
エクスポートしたデータをlocalStorageに保存し、後から表示・ダウンロード・削除できる機能。

### 10.2 出力データ種別（カテゴリ）

| カテゴリ | キー | アイコン | 色 |
|----------|------|----------|-----|
| ラクミー入力値CSV | ラクミー入力値CSV | 📊 | 緑 (#4caf50) |
| 予算一覧CSV | 予算一覧CSV | 📋 | 青 (#2196f3) |
| MQ出力CSV | MQ出力CSV | 📈 | 紫 (#9c27b0) |
| 設定JSON | 設定JSON | ⚙️ | グレー (#607d8b) |

### 10.3 制限事項

- 最大保存件数: 100件
- 保存容量: localStorageの制限に依存（通常5MB）
- 容量超過時はエラー通知

---

## 11. インポート履歴管理機能

### 11.1 概要
インポートしたデータをlocalStorageに保存し、後から復元できる機能。

### 11.2 保存データ構造
```json
{
  "id": "1703593200000",
  "title": "2024-12-26_21:30_店舗A, 店舗B",
  "dateTime": "2024-12-26_21:30",
  "storeNames": ["店舗A", "店舗B"],
  "storeCount": 2,
  "data": { /* allStoresData */ },
  "savedAt": "2024-12-26T12:30:00.000Z"
}
```

---

## 12. 費用設定判定ロジック

### 12.1 判定基準
- **全月同一**: 12ヶ月すべて同じ値 → 費用予算設定（年間デフォルト）
- **月別差異**: 月によって値が異なる → 単月費用予算

### 12.2 表示ロジック
```
費用予算設定:
  月別差異あり → 「-」表示 + 「単月設定」バッジ
  全月同一 → 年間デフォルト値表示 + 「年間固定」バッジ

単月費用予算:
  月別差異あり → 実際の月別値を表示
  全月同一 → 非表示（項目自体を表示しない）
```

---

## 13. エラーハンドリング

### 13.1 CSVパースエラー
- 行数不足
- 月列検出失敗
- 文字コード問題

### 13.2 データ検証
- 必須項目の欠落
- 数値変換エラー
- 範囲外の値

### 13.3 ストレージエラー
- localStorage容量超過
- 読み込み/書き込み失敗

---

## 14. 変更履歴

### v17マッピング対応版（最新）

| 変更項目 | 変更内容 |
|---------|---------|
| マッピングシステム | v15番号体系からv17番号体系に変更 |
| 科目コードマッピング | CODE_BASED_MAP追加（科目コード優先マッチ） |
| ロイヤリティマッピング | 科目コード512→v17No:53に修正 |
| 店舗補填追加 | v17No:54として新規追加 |
| 表示グルーピング | 「その他変動費」を「固定費」に統合 |
| 0値行非表示 | インポートデータ表示に0値行非表示機能追加 |
| ラクミー項目表示 | 全個別項目表示に拡張 |

### カテゴリマッピング設定・表示順機能（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| BUDGET_CATEGORY_MAP | 13カテゴリ（売上高/売上原価/人件費等）の出力先・表示順・色定義を追加 |
| CUSTOMER_CODE_MAP拡張 | budgetCategory・sortOrder属性を全項目に追加 |
| カテゴリ表示順設定UI | 設定インポートタブに↑↓ボタンによるカテゴリ順序変更UI追加 |
| カテゴリ内項目順設定UI | カテゴリセレクターと項目順序変更UIを追加 |
| LocalStorage保存 | カテゴリ順・項目順設定の保存/読込機能（rakumy_category_order） |
| CSVダブルチェック | CSV予算カテゴリ列とマッピング定義のカテゴリ不一致を警告ログ出力 |
| validateCategoryMapping | コード/名前マッチとCSVカテゴリの整合性検証関数 |
| matchedItems拡張 | budgetCategory・sortOrder属性を含むよう拡張 |

### 予算試算UI大幅リニューアル（2026-01-02 午後）

| 変更項目 | 変更内容 |
|---------|---------|
| **予算比較サマリー** | 最上部に比較テーブル追加（顧客予算 vs MQ試算：売上・利益・目標客数） |
| 達成判定 | 顧客予算売上 >= MQ必要売上 で「✅達成可能」、不足時は「⚠️要調整」を表示 |
| 結論表示 | 差異金額と達成可否を文章で明示 |
| **ラクミー予算構成** | MQ試算結果（目標客数・必要売上・営業利益）を最上部に配置 |
| MQ計算パラメータ | F/G/FD%/PA%/VR/Pを最下部に移動（グレー表示・参照用） |
| **詳細テーブル折りたたみ** | 顧客予算詳細・ラクミー予算詳細を`<details>`タグで折りたたみ式に変更 |
| MQ試算フロー | 「MQ試算実行」ボタン → 客単価確認モーダル → 結果表示の3ステップに改善 |
| 客単価編集モーダル | 店舗別デフォルト値を自動反映（initSimUnitPrices呼び出し修正） |

### 金額表示の円単位対応（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| 表示単位変更 | 全ての金額表示を千円単位から円単位（×1000）に変更 |
| fmtYen関数追加 | 内部データ（千円）を円表示に変換する関数を追加 |
| ラベル変更 | 「千円」→「円」、「千円/日」→「円/日」に統一 |
| 入力フィールド対応 | 入力欄は円単位で表示・入力、内部は千円単位で保存 |
| data-yen属性追加 | 金額入力フィールドにdata-yen="true"属性を追加、updateSimulationValueで÷1000変換 |
| 三桁カンマ区切り | toLocaleString('ja-JP')でカンマ区切り表示を維持 |

### MQ試算結果比較・試算サマリー日次表示（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| MQ試算結果比較サマリー | 5項目（顧客予算売上/MQ算出売上/売上差異/MQ目標客数/目標営業利益）を日次メイン表示 |
| 試算サマリー | タイトルを「日次・月次換算」に変更、売上高/営業利益を日次メイン表示 |
| 注釈追加 | 両サマリーに「※営業日数25日/月想定」「※月平均＝取込期間合計÷Nヶ月」を追加 |

### 日次表示・試算値反映・画面順序改善（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| 日次・月次表示 | 年間値ではなく日次をメイン表示（店長向け）、月平均を補足表示 |
| 計算定義注釈 | 「※営業日数25日/月想定」「※月平均＝取込期間合計÷Nヶ月」を追加 |
| MQ再計算ボタン | ラベルを「🔄 MQ再計算を実行」に変更、顧客予算編集・客単価変更両対応 |
| 画面順序変更 | STEP1/STEP2パネル → MQ再計算ボタン → MQ試算結果比較表 の順に変更 |
| 試算値反映バグ修正 | ボタンonclick関数名不一致を修正（applySimulationToMain→applySimulationData） |
| 試算値反映強化 | annualDataに加え、rakumyInputs・mqOutputsも本データに反映 |

### 試算履歴機能・UI配置改善（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| 試算履歴機能 | localStorage使用、最大10件保存、名前・メモ付き保存 |
| 履歴読込 | 店舗自動選択、店舗不一致時の確認ダイアログ対応 |
| 明細項目編集 | 合計行は表示のみ（編集不可）、明細項目のみ編集可能に変更 |
| UI配置改善 | 試算履歴ボタン・保存ボタンを対比表の直上に移動 |
| 店舗選択エリア | シンプル化（店舗選択、元に戻す、本データ反映のみ） |
| MQ試算ボタン | 対比表下部に移動、MQパラメータも同位置に集約 |

### エクスポートCSVの円単位対応（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| exportRakumyInputsCSV | 費用予算設定・単月費用予算・予算設定の金額を×1000で円単位出力 |
| exportBudgetListCSV | addRow()にisYenAlreadyパラメータ追加、金額を円単位変換 |
| exportMQOutputCSV | mqItemsにisPerson/isYen/isMoneyフラグ追加、金額を円単位変換 |
| 変換ルール | 千円→×1000、円単位（客単価等）→そのまま、率・人数→そのまま |

### 売上比較セクション日次・月次表示対応（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| 判定結果バー改善 | 売上比較を日次（円/日）・月次（円/月）・期間計で階層表示 |
| 3カラムレイアウト | 顧客予算売上 ｜ 差異 ｜ MQ必要売上 のグリッド配置 |
| 差異表示 | 中央に差異を日次・月次で表示（+/- 符号付き） |
| 店長向け最適化 | 日次売上をメイン表示（大きく）、月次・期間計は補足表示 |

### 金額表示の円単位対応完了（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| renderOutputTable | outputItems、売上・営業利益比較セクションをfmtYen()に統一 |
| renderBudgetListTable | addRow()ヘルパーの金額表示をfmtYen()に変更 |
| renderLinkedSimulation | 月別・合計金額表示をfmtYen()に変更（isYen/isPerson除く） |
| updateMQRefDisplay | 月別固定費表示をfmtYen()に変更 |
| 変換ルール確立 | 千円データ→fmtYen()、円データ（P,M）→fmt()、人数→fmt() |

### MQ計算結果サマリー・UI改善（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| MQ計算結果サマリー | MQ再計算ボタン下に結果テーブルを表示（目標客数/売上/営業利益/限界利益単価M） |
| ランチ/ディナー客単価 | `getMQInputs()`にランチ/ディナー客単価取得を追加 |
| rakumyInputs拡張 | `targetUnitPriceLunch`/`targetUnitPriceDinner`を保存 |
| 予算一覧修正 | ランチ/ディナー客単価を入力値から直接参照（推定計算を廃止） |
| バグ修正 | `recalculateMQ()`内の`generateCalculations`→`executeCalcRules`に修正 |
| 動的月別テーブル | MQパラメータ/目標客単価テーブルを取込月数に応じて動的生成 |

### データ連動・エクスポート修正（2026-01-01）

| 変更項目 | 変更内容 |
|---------|---------|
| renderInputTable | データソースを`matchedItems.rowData`から`annualData[v17No]`に統一 |
| タブ切替連動 | 予算試算タブ切替時に`saveCurrentStoreData()`を実行し最新データを反映 |
| 店舗切替連動 | `switchStore()`で予算試算タブの店舗セレクトも同期 |
| 予算一覧CSV | 月次目標利益のマッピングをNo.60→No.63（営業利益）に修正 |
| MQ出力CSV | 顧客予算売上のマッピングをNo.5→No.4（売上高合計）に修正 |
| MQ出力CSV | 顧客予算営業利益のマッピングをNo.60→No.63（営業利益）に修正 |

### インポートタブ分割・設定インポート機能追加（2026-01-02）

| 変更項目 | 変更内容 |
|---------|---------|
| インポートタブ分割 | 「予算インポート」と「設定インポート」の2つのサブタブに分割 |
| 予算インポートサブタブ | 既存のCSVインポート機能を移動、予算テンプレートダウンロード機能を追加 |
| 設定インポートサブタブ | 店番インポート機能と予算項目コードインポート機能を新規追加 |
| 店番テンプレート | 店番・店舗名のCSVテンプレートダウンロード機能 |
| 予算テンプレート | 空の予算CSVテンプレート（コード・項目名・12ヶ月列）ダウンロード機能 |
| 予算項目コードテンプレート | 現在のマッピング定義をCSVでダウンロード（コード・項目名・v17No・カテゴリ・入力スタイル） |
| 店番インポート | CSVからDEFAULT_UNIT_PRICESに店舗を追加 |
| サブタブスタイル | アクティブ時青グラデーション、設定タブ表示時に一覧を自動更新 |

### NAME_BASED_MAP大幅拡張（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| マッピング件数拡大 | 約98件→284件（約3倍に拡張） |
| **売上高関連** | フード/ﾌｰﾄﾞ（半角カタカナ）、F売上、売上合計、売上計、総売上高など |
| **売上原価関連** | 食材原価、フード原価、F原価、FD原価、売上原価合計、粗利益、粗利、GPなど |
| **人件費関連** | PA人件費、パート人件費、アルバイト人件費、労務費合計、福利厚生費、ボーナスなど |
| **その他変動費関連** | 販促費、広告宣伝費、修繕費、電気料、電力費、振込手数料、決済手数料など |
| **集計値** | 変動費合計、変動費計、経費合計、固定費計、販管費合計、販管費、限界利益額、貢献利益など |
| **固定費関連** | 地代、店舗家賃、賃料、警備費、セキュリティ費、機器リースなど |
| **利益関連** | 店舗利益、店利益、店別営業利益、経常損益、税引前利益など |
| **KPI関連** | 来客数、来店客数、平均客単価、ランチ比率、ディナー比率など |
| 半角カタカナ対応 | ﾌｰﾄﾞ、ﾄﾞﾘﾝｸ、ﾊﾟｰﾄ、ｱﾙﾊﾞｲﾄ、ﾍﾙﾌﾟ、ﾛｲﾔﾘﾃｨ、ｶﾞｽ、ｸﾚｼﾞｯﾄ等 |

### 営業利益（No.63）計算ロジック修正（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| CALC_RULESに営業利益追加 | `type: 'diff'`（減算タイプ）を新規追加、営業利益=店舗営業利益(No.61)-販売管理費合計(No.62) |
| evaluateRule関数拡張 | 減算タイプ`diff`のサポートを追加（minuend - subtrahend） |
| annualData[63]自動計算 | executeCalcRules()内で計算値をannualData[63]に反映（C.自動演算タイプのため常に計算値を使用） |
| CUSTOMER_CODE_MAP修正 | コード'9640'のマッピングをNo.61→No.63に修正、inputStyleを'C.自動演算'に変更 |
| デバッグログ追加 | 営業利益の自動計算時にCSVインポート値と計算結果をコンソールログ出力 |

### 店番テンプレート改善・月別客単価インポート（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| DEFAULT_UNIT_PRICESにstoreCode追加 | 各店舗にstoreCodeプロパティ追加（101, 103, 201等の実際の店番コード） |
| 店番テンプレートフォーマット変更 | ヘッダーを「店番,店名」に変更、連番ではなく実際の店番コードを出力 |
| 店番インポート強化 | 新店追加時にstoreCode保存、既存店舗の店番更新に対応 |
| 店舗一覧表示改善 | 店番列を追加、未設定の場合は「未設定」と表示 |
| マスタ履歴表示改善 | 店番マスタ・客単価マスタで実際の店番コードを表示 |

### 月別客単価インポート機能追加（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| 設定インポートに新セクション追加 | 「月別客単価インポート」セクションを追加 |
| 月別客単価テンプレートダウンロード | 店番,店名,客単価タイプ,4月〜3月の15列CSVテンプレート |
| CSVフォーマット | 1店舗につき3行（総合/ランチ/ディナー）× 12ヶ月 |
| インポート処理 | DEFAULT_UNIT_PRICESのmonthlyオブジェクトにデータを反映 |
| 店番連携 | インポート時にstoreCodeも同時に取り込み |

### 営業利益トリプルチェック実装（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| チェック①: NAME_BASED_MAPマッピング確認 | 項目名「営業利益」でNo.63に正しくマッピングされたか確認 |
| チェック②: コード9640検出警告 | CSVに9640が存在する場合は警告（顧客予算表のコード誤り対策） |
| チェック③: 計算検証 | 店舗営業利益(61) - 販売管理費合計(62) = 営業利益(63) か検証 |
| 差異検出 | 1000円以上の差異がある月は警告ログを出力 |
| 処理ログ表示 | トリプルチェック結果を処理ログセクションに表示 |
| 総合判定 | すべてOK / 一部警告あり の判定結果を表示 |

### マスタデータ履歴カテゴリフィルター（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| カテゴリフィルターボタン追加 | 履歴プルダウン上部に「すべて」「店番マスタ」「予算項目コード」「客単価」の4ボタンを追加 |
| カテゴリ別読込 | 選択カテゴリのみ読み込む機能を実装（すべて/店番のみ/コードのみ/客単価のみ） |
| プレビュー表示改善 | カテゴリに応じた背景色・表示内容に変化（店番は緑、コードは橙、客単価は青） |
| 履歴ラベル改善 | カテゴリに応じて適切な件数表示（店舗数/項目数/客単価数） |
| switchHistoryCategory関数追加 | カテゴリ切替時に選択をリセットしてリスト再描画 |

### MQ試算モーダルからの客単価マスタ保存（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| 客単価マスタ保存機能 | MQ試算モーダルで編集した客単価をDEFAULT_UNIT_PRICESに保存可能に |
| ボタン分割 | 「この値でMQ試算」→「MQ試算のみ」(橙) + 「💾マスタ保存+MQ試算」(緑) に分割 |
| saveSimUnitPricesToMaster関数 | 月別客単価をマスタデータに保存する関数を追加 |
| saveAndExecuteSimMQ関数 | マスタ保存後にMQ試算を実行する関数を追加 |
| monthlyデータ保存 | 月別の客単価データをDEFAULT_UNIT_PRICES[storeName].monthlyに保存 |
| 履歴連携 | 保存したデータは「💾現在のデータを保存」で履歴に保存可能 |

### 客単価マスタ履歴自動保存（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| 自動保存機能 | 「💾マスタ保存+MQ試算」ボタン押下時にマスタ履歴へ自動保存 |
| saveAndExecuteSimMQ拡張 | saveMasterDataToHistory()を自動呼び出し |
| 履歴管理統合 | MQ試算モーダルからの保存が即座に履歴一覧に反映 |

### 客単価カテゴリ月別プレビュー対応（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| 月別表示対応 | 客単価カテゴリのプレビューで月別データを「4月:5000円, 5月:5200円...」形式で表示 |
| monthlyデータ検出 | prices.monthlyオブジェクトの有無を判定して表示分岐 |
| 年平均と月別の併記 | 「平均: 5000円」の下に月別詳細を追加表示 |

### 取り込みデータ履歴管理機能強化（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| 保存ボタン追加 | インポート画面の「取り込みデータ履歴を見る」モーダルに「💾 現在のデータを保存」ボタン追加 |
| 保存済み履歴セクション | モーダル内に「保存済み取り込みデータ履歴」セクション追加（LocalStorage使用） |
| 履歴モーダル構成 | 上部: 現在のセッション（未保存）、下部: 保存済みデータ履歴 の2段構成 |
| saveCurrentImportData関数 | 現在のallStoresDataをLocalStorageに保存 |
| renderSavedHistoryList関数 | 保存済み履歴一覧を描画 |
| loadFromHistoryAndClose関数 | 履歴から読み込んでモーダルを閉じる |
| deleteFromHistoryAndRefresh関数 | 履歴削除後にリスト再描画 |

### 保存済み履歴プレビュー機能（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| プレビューボタン追加 | 保存済み履歴各項目に「🔍 プレビュー」ボタン追加 |
| プレビューパネル | モーダル下部にプレビューパネル表示（店舗別データ詳細） |
| 表示内容 | マッチ済み項目（項目名/コード/年間合計）、未マッチ項目、月別データテーブル |
| previewSavedHistory関数 | 選択した履歴のデータをプレビュー表示 |
| loadPreviewedData関数 | プレビュー中のデータを読み込み |
| closeHistoryPreview関数 | プレビューパネルを閉じる |
| データ確認フロー | プレビューでデータ内容を確認→「このデータを読み込み」で確定 |

### インポート列マッピング機能強化（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| **予算インポートタブへ移動** | 列マッピング設定UIを設定インポートタブから予算インポートタブに移動 |
| **プリセット選択** | 顧客プリセット選択ドロップダウンを予算テンプレート行に配置 |
| **列無効化機能** | オプション列（月列）の有効/無効切り替えチェックボックスを追加 |
| **列グループ化機能** | グループ化なし/四半期(Q1-Q4)/半期(上期・下期)の選択オプション |
| **クイック無効化** | 四半期/半期グループ単位での一括有効/無効トグルボタン |
| **カスタム列機能** | 顧客CSV独自列を「その他データ」として追加・保持する機能 |
| **CSVフォーマット設定** | ヘッダー行位置/文字コード/区切り文字の設定UI |
| **データ変換設定** | 数値カンマ区切り/空白値扱い/金額単位/前後空白の設定UI |

#### データ構造追加

```javascript
// フォーマット設定
var currentFormatSettings = {
    headerRow: 1,           // ヘッダー行（1から）
    encoding: 'auto',       // auto, utf8, shiftjis
    delimiter: 'auto',      // auto, comma, tab, semicolon
    numberFormat: 'auto',   // auto, comma, none
    emptyValue: 'zero',     // zero, null, skip
    amountUnit: 1,          // 1, 1000, 10000
    trimSpaces: true,       // 前後空白除去
    dateFormat: 'auto'      // auto, ymd, mdy, dmy
};

// 無効化列
var currentDisabledColumns = { month1: true, month2: true, ... };

// カスタム列
var currentCustomColumns = [
    { key: 'manager', csvName: '担当者名' },
    { key: 'note', csvName: '備考' }
];

// 列グループ設定
var currentColumnGroups = { enabled: false, type: 'none' }; // none, quarter, half
```

### 会計年度設定機能（2026-01-03）

| 変更項目 | 変更内容 |
|---------|---------|
| **会計年度設定UI** | マスタ設定タブ最上部に「会計年度設定」セクションを配置 |
| **開始月設定** | 1月〜12月の会計年度開始月選択（デフォルト: 4月） |
| **対象年度設定** | 現在年度±5年の範囲から対象年度を選択 |
| **表記スタイル** | 月のみ / 年月 / スラッシュの3形式から選択 |
| **FISCAL_ORDER動的生成** | 設定に基づいてFISCAL_ORDERを動的に生成 |
| **全画面月表示連動** | アプリ内の全月表示（テーブルヘッダー、プルダウン等）がFISCAL_ORDERに連動 |
| **テンプレート対応** | 予算テンプレート・月別客単価テンプレートが会計年度設定を反映 |
| **年度をまたぐ表示** | 4月開始の場合: 2025年4月〜2026年3月などの年またぎ対応 |
| **CSV自動検出** | 顧客予算CSV取り込み時に月列情報から会計年度を自動検出・設定 |
| **LocalStorage保存** | 会計年度設定の保存/読み込み（rakumy_fiscal_year_settings） |

#### データ構造

```javascript
var fiscalYearSettings = {
    startMonth: 4,           // 会計年度開始月（1-12）
    year: 2026,              // 対象年度
    style: 'short'           // 表記スタイル: short, full, slash
};

// 表記スタイル例
// short: '4月', '5月', ..., '3月'
// full:  '2026年4月', '2026年5月', ..., '2027年3月'
// slash: '2026/4', '2026/5', ..., '2027/3'
```

#### 関連関数

| 関数名 | 説明 |
|--------|------|
| generateFiscalOrder() | 設定に基づきFISCAL_ORDERを生成 |
| generateFiscalMonthIndices() | 会計年度設定に基づく月インデックス配列を生成（例: 4月開始→[3,4,5,...,0,1,2]） |
| getFiscalYearInfo() | 年度範囲情報を取得（label, range） |
| getFiscalMonthInfo(monthIndex) | 月インデックスから年・月を取得 |
| updateFiscalYearSettings() | UI変更時の設定反映 |
| saveFiscalYearSettings() | LocalStorageに保存 |
| loadFiscalYearSettings() | LocalStorageから読み込み |
| resetFiscalYearSettings() | 初期設定（4月開始）に戻す |
| initFiscalYearSelector() | 年度セレクター初期化 |
| renderFiscalYearPreview() | プレビュー表示 |
| autoDetectFiscalYearFromCSV() | 予算CSV読込時に月情報から会計年度を自動検出・適用 |

#### 月表示連動箇所

全ての月表示部分がFISCAL_ORDERグローバル変数に連動：
- MQシミュレーション結果テーブル
- 予算一覧テーブル
- 客単価設定テーブル
- マスタ履歴プレビュー・編集モーダル
- 月選択プルダウン（単月・複数月）
- シミュレーション入力テーブル
- 比較レポートテーブル

### v5.8（前バージョン）

- 顧客CSV対応版・変換ロジック強化
- マッピング管理機能追加
- 出力データ履歴管理追加
