# 予算シミュレーター v17マッピング対応版 機能仕様書

## 1. 概要

### 1.1 目的
顧客が作成した年間予算CSVファイルを読み込み、ラクミー経営管理システムへの入力値に自動変換するシミュレーターツール。

### 1.2 主要機能
- 顧客予算CSVの自動解析・インポート
- 科目コード・科目名による三層マッピング
- MQシミュレーション（売上・利益計算）
- ラクミー入力値の自動生成
- 予算一覧の出力
- 複数店舗対応
- マッピング管理機能（編集・CSV入出力・未使用検出・類似マッチング）
- 出力データ履歴管理
- 0値行の非表示機能

### 1.3 バージョン情報
- バージョン: v17マッピング対応版
- 前バージョン: v5.8（顧客CSV対応版）
- 主な変更: v17番号体系への対応、科目コードマッピング追加

---

## 2. システム構成

### 2.1 ファイル構成
```
v15_予算シミュレーター_v17マッピング対応版.html
├── HTML構造（UI）
├── CSS（スタイル）
└── JavaScript（ロジック）
    ├── CODE_BASED_MAP（科目コードマッピング）
    ├── NAME_BASED_MAP（科目名マッピング）
    ├── ITEMS（項目定義）
    ├── CALC_RULES（演算ルール）
    └── RAKUMY_ITEMS（ラクミー項目定義）
```

### 2.2 処理フロー
```
┌─────────────────┐
│ CSVファイル選択 │
└────────┬────────┘
         ↓
┌─────────────────┐
│ CSV解析・店舗検出 │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 月別予算列検出   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 科目コードマッピング │ ← CODE_BASED_MAP
└────────┬────────┘
         ↓ マッチしない場合
┌─────────────────┐
│ 科目名マッピング │ ← NAME_BASED_MAP
└────────┬────────┘
         ↓
┌─────────────────┐
│ 入力前演算実行   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ ラクミー入力値生成│
└────────┬────────┘
         ↓
┌─────────────────┐
│ MQシミュレーション│
└────────┬────────┘
         ↓
┌─────────────────┐
│ 予算一覧・サマリー│
└────────┬────────┘
         ↓
┌─────────────────┐
│ 出力データ履歴保存│
└─────────────────┘
```

---

## 3. データ構造

### 3.1 グローバル変数

| 変数名 | 型 | 説明 |
|--------|------|------|
| `activeMonths` | Array | アクティブな月のインデックス配列 |
| `monthLabels` | Array | 月ラベル配列（例：['4月', '5月', ...]） |
| `budgetColumnPositions` | Array | 各月の予算列位置 |
| `annualData` | Object | 年間予算データ（v17番号→月別値） |
| `calcResults` | Object | 演算結果 |
| `rakumyInputs` | Object | ラクミー入力値 |
| `mqOutputs` | Object | MQシミュレーション出力 |
| `judgments` | Object | 費用設定判定結果 |
| `allStoresData` | Object | 全店舗データ |
| `isEditMode` | Boolean | マッピング編集モードフラグ |
| `unusedMappings` | Array | 未使用マッピングリスト |

### 3.2 三層マッピングシステム

#### CODE_BASED_MAP（科目コードベース）
科目コードから直接v17番号を特定：
```javascript
CODE_BASED_MAP = {
    '461': { v17No: 6, category: '原価', name: '食材仕入高' },
    '512': { v17No: 53, category: '固定費', name: 'ロイヤリティ' },
    // ...
};
```

#### NAME_BASED_MAP（科目名ベース）
科目コードでマッチしない場合のフォールバック：
```javascript
NAME_BASED_MAP = {
    '食材仕入高': { v17No: 6, category: '原価' },
    'ロイヤリティ': { v17No: 53, category: '固定費' },
    '店舗補填': { v17No: 54, category: '固定費' },
    '店舗補てん': { v17No: 54, category: '固定費' },  // 表記揺れ対応
    // ...
};
```

#### ITEMS（項目定義）
v17番号から項目属性を取得：
```javascript
ITEMS = {
    2: { name: '店舗売上高', category: '売上', inputStyle: 'A.そのまま入力' },
    53: { name: 'ロイヤリティ', category: '固定費', inputStyle: 'A.そのまま入力' },
    54: { name: '店舗補填', category: '固定費', inputStyle: 'A.そのまま入力' },
    // ...
};
```

### 3.3 演算ルール（CALC_RULES）

| ルール名 | 計算式 | 説明 |
|----------|--------|------|
| 売上合計 | item:5 | 売上高合計 |
| FD仕入費合計 | item:6 + item:7 | 食材仕入高+ドリンク仕入高 |
| FD仕入費率 | FD仕入費合計 / 売上合計 × 100 | FD原価率 |
| PA人件費合計 | item:13 + item:19 | 雑給+ヘルプ人件費 |
| PA人件費率 | PA人件費合計 / 売上合計 × 100 | PA人件費率 |
| 固定人件費合計 | item:10+14+15+16+17+18 | 固定人件費合計 |
| ランチ売上比率 | item:2 / 売上合計 × 100 | ランチ売上構成比 |
| ディナー売上比率 | item:3 / 売上合計 × 100 | ディナー売上構成比 |
| 地代家賃合計 | item:56 + item:57 | 家賃+賃借料 |
| 資材費合計 | item:58 + item:59 | 警備料+リース料 |

---

## 4. マッピング管理機能

### 4.1 概要
顧客予算項目の変更に柔軟に対応するためのマッピング管理機能。

### 4.2 機能一覧

| 機能 | 関数 | 説明 |
|------|------|------|
| 編集モード切替 | `toggleEditMode()` | マッピング編集UIの表示/非表示 |
| マッピング編集 | `editMapping(code)` | 個別マッピングの編集 |
| マッピング保存 | `saveEditMapping(code)` | 編集内容の保存 |
| マッピング削除 | `deleteMapping(code)` | 個別マッピングの削除 |
| マッピング追加 | `addMapping()` | 新規マッピングの追加 |
| CSV読込 | `importMappingCSV(event)` | CSVからマッピング定義を読込 |
| CSV出力 | `exportMappingCSV()` | マッピング定義をCSV出力 |
| 未使用検出 | `detectUnusedMappings()` | 未使用マッピングの検出 |
| 未使用削除 | `removeUnusedMappings()` | 未使用マッピングの一括削除 |
| 類似検索 | `findSimilarItems()` | 未マッチ項目の類似候補検索 |
| 類似適用 | `applyMappingSuggestion()` | 類似候補からマッピング作成 |

---

## 5. ラクミー入力値構造

### 5.1 費用予算設定（固定費用）

年間を通して同一値を設定する項目：

| キー | 項目名 | データソース |
|------|--------|--------------|
| rent | 地代家賃 | 地代家賃合計（家賃+賃借料） |
| fixedLabor | 固定人件費 | 固定人件費合計 |
| depreciation | 減価償却費 | item:55 |
| material | 資材費 | 資材費合計（警備料+リース料） |
| promotion | 販売促進費 | item:27 |
| ... | ... | ... |
| misc | 雑費 | item:51 |

### 5.2 予算設定（変動費用）

| キー | 項目名 | 説明 |
|------|--------|------|
| fdRate | FD仕入費率 | FD仕入費÷売上×100 |
| paRate | PA人件費率 | PA人件費÷売上×100 |
| targetUnitPrice | 目標客単価（税抜） | 売上÷客数（逆算） |
| targetCustomers | 目標客数 | 自動計算 |
| lunchRatio | ランチ売上比率 | ランチ売上÷売上×100 |
| dinnerRatio | ディナー売上比率 | ディナー売上÷売上×100 |

---

## 6. MQシミュレーション

### 6.1 ラクミーMQ計算の基本概念

ラクミーでは「MQ逆算式」を使用して、**目標月次利益から予算売上を逆算**する。

**入力パラメータ（顧客予算から合成）**：
- 固定費用合計: 費用予算設定の固定費項目を合計
- 変動費率: FD仕入費率 + PA人件費率
- 目標月次利益: 顧客予算の営業利益（No.63）を使用
- 目標客単価: ユーザー設定値

### 6.2 MQ逆算式（重要）

```javascript
// ★★★ MQ逆算式 ★★★
// 入力: 固定費、変動費率、目標月次利益、目標客単価
// 出力: 目標客数、予算売上、予算営業利益

// 1. 必要な限界利益 = 固定費 + 目標月次利益
requiredGrossProfit = fixedCost + targetProfit

// 2. 必要な売上 = 限界利益 / (1 - 変動費率)
//    ※ 限界利益 = 売上 × (1 - 変動費率) なので逆算
grossProfitRate = 1 - variableRate
requiredSales = requiredGrossProfit / grossProfitRate

// 3. 目標客数 = 売上 × 1000 / 客単価
//    ※ 売上は千円単位、客単価は円単位
targetCustomers = Math.round(requiredSales * 1000 / targetUnitPrice)

// 4. 検算：客数 × 客単価で売上を再計算（端数調整）
sales = targetCustomers * targetUnitPrice / 1000
```

### 6.3 順算式（検証用）

```javascript
// 変動費 = 売上 × 変動費率
variableCost = sales × variableRate

// 限界利益 = 売上 - 変動費
grossProfit = sales - variableCost

// 営業利益 = 限界利益 - 固定費
operatingProfit = grossProfit - fixedCost
```

### 6.4 顧客予算からの入力値合成

```javascript
// 固定費用合計（費用予算設定の固定費項目を合計）
fixedCostTotal = 地代家賃合計 + 固定人件費合計 + 減価償却費 + 資材費合計 +
                 販売促進費 + メニューコピー + 調査費 + ... + 雑費

// 変動費率（FD仕入費率 + PA人件費率）
variableRate = (fdRate + paRate) / 100

// 目標月次利益 = 顧客予算の営業利益（No.63）
targetProfit = annualData[63][m]

// 目標客単価 = ユーザー設定
targetUnitPrice = getTargetUnitPrice()
```

### 6.5 重要事項

**顧客予算との差異について**：
- **MQ売上 ≠ 顧客予算売上**: 逆算式で算出するため異なる値になる
- **MQ営業利益 ≈ 顧客予算営業利益**: 目標利益として使用するため近い値（端数調整で若干の差異あり）

**ロイヤリティ（No.53）と店舗補填（No.54）について**：
- これらはv17マッピング表に存在しない顧客独自項目
- 表示のみで、MQ固定費計算には含めない
- 含めると営業利益がマイナスになる可能性あり

### 6.6 出力項目

| 項目 | 説明 | 算出方法 |
|------|------|----------|
| 客数 | 目標客数 | MQ逆算 |
| 客単価 | 目標客単価 | ユーザー設定 |
| 売上 | 予算売上 | MQ逆算 |
| 変動費 | 変動費合計 | 売上×変動費率 |
| 変動費率 | FD+PA率 | 顧客予算から合成 |
| 限界利益 | 売上-変動費 | 計算値 |
| 限界利益率 | 限界利益÷売上×100 | 計算値 |
| 固定費 | 固定費合計 | 顧客予算から合成 |
| 営業利益 | 限界利益-固定費 | MQ計算結果 |
| 営業利益率 | 営業利益÷売上×100 | 計算値 |

---

## 7. 表示グルーピング

### 7.1 顧客予算項目の表示構造

```
売上予算
├─ No.2  店舗売上高
├─ No.3  ドリンク売上
├─ No.4  その他売上高
└─ No.5  売上高合計 [ハイライト]

変動費予算
├─ No.6  食材仕入高
├─ No.7  ドリンク仕入高
├─ No.13 雑給（PA人件費）
├─ No.19 ヘルプ人件費
└─ [変動費合計] [ハイライト]

固定人件費
├─ No.10 給料手当
├─ No.14 法定福利費
├─ ...
└─ [固定人件費合計] [ハイライト]

固定費（その他経費 + 従来の固定費）
├─ No.27 販売促進費
├─ ...
├─ No.51 雑費
├─ No.52 その他経費小計 [ハイライト]
├─ No.53 ロイヤリティ
├─ No.54 店舗補填
├─ No.55 減価償却費
├─ No.56 家賃
├─ ...
└─ No.60 固定費合計 [ハイライト]

損益
└─ [営業利益]
```

### 7.2 変更点（v5.8からの変更）

- 「その他変動費」（No.27-51）を「固定費」セクションに統合
- セクション名を「その他変動費」から「固定費」に変更
- No.52の項目名を「その他変動費合計」から「その他経費小計」に変更
- ラクミー予算項目を全個別項目表示に拡張

---

## 8. 0値行の非表示機能

### 8.1 概要
インポート取り込みデータ表示において、合計が0の行を非表示にする機能。

### 8.2 実装

```javascript
// renderInputTable関数内
// 合計を先に計算（0値の行を非表示にするため）
var total = 0;
for (var m = 0; m < activeMonths.length; m++) {
    var val = item.rowData ? (item.rowData[m] || 0) : 0;
    total += val;
}
// 合計が0の行はスキップ（非表示）
if (total === 0) return;
```

### 8.3 適用範囲

| 画面 | 0値非表示 |
|------|----------|
| インポート取り込みデータ表示 | 適用 |
| 予算試算テーブル | 非適用（全項目表示） |

---

## 9. CSVエクスポート機能

### 9.1 全店舗エクスポート

「全店舗を選択」チェック時は全店舗データを1つのCSVに縦連結。

### 9.2 出力ファイル名規則

| 条件 | ファイル名 |
|------|-----------|
| 単一店舗 | `{種別}_{店舗名}_{YYYY-MM-DD}.csv` |
| 全店舗 | `{種別}_全店舗_{YYYY-MM-DD}.csv` |

### 9.3 共通仕様

| 項目 | 仕様 |
|------|------|
| 文字コード | UTF-8 with BOM（Excel対応） |
| 金額 | 千円単位、整数、カンマなし |
| 率 | 整数%表示（小数点なし） |

---

## 10. 出力データ履歴管理

### 10.1 概要
エクスポートしたデータをlocalStorageに保存し、後から表示・ダウンロード・削除できる機能。

### 10.2 出力データ種別（カテゴリ）

| カテゴリ | キー | アイコン | 色 |
|----------|------|----------|-----|
| ラクミー入力値CSV | ラクミー入力値CSV | 📊 | 緑 (#4caf50) |
| 予算一覧CSV | 予算一覧CSV | 📋 | 青 (#2196f3) |
| MQ出力CSV | MQ出力CSV | 📈 | 紫 (#9c27b0) |
| 設定JSON | 設定JSON | ⚙️ | グレー (#607d8b) |

### 10.3 制限事項

- 最大保存件数: 100件
- 保存容量: localStorageの制限に依存（通常5MB）
- 容量超過時はエラー通知

---

## 11. インポート履歴管理機能

### 11.1 概要
インポートしたデータをlocalStorageに保存し、後から復元できる機能。

### 11.2 保存データ構造
```json
{
  "id": "1703593200000",
  "title": "2024-12-26_21:30_店舗A, 店舗B",
  "dateTime": "2024-12-26_21:30",
  "storeNames": ["店舗A", "店舗B"],
  "storeCount": 2,
  "data": { /* allStoresData */ },
  "savedAt": "2024-12-26T12:30:00.000Z"
}
```

---

## 12. 費用設定判定ロジック

### 12.1 判定基準
- **全月同一**: 12ヶ月すべて同じ値 → 費用予算設定（年間デフォルト）
- **月別差異**: 月によって値が異なる → 単月費用予算

### 12.2 表示ロジック
```
費用予算設定:
  月別差異あり → 「-」表示 + 「単月設定」バッジ
  全月同一 → 年間デフォルト値表示 + 「年間固定」バッジ

単月費用予算:
  月別差異あり → 実際の月別値を表示
  全月同一 → 非表示（項目自体を表示しない）
```

---

## 13. エラーハンドリング

### 13.1 CSVパースエラー
- 行数不足
- 月列検出失敗
- 文字コード問題

### 13.2 データ検証
- 必須項目の欠落
- 数値変換エラー
- 範囲外の値

### 13.3 ストレージエラー
- localStorage容量超過
- 読み込み/書き込み失敗

---

## 14. 変更履歴

### v17マッピング対応版（最新）

| 変更項目 | 変更内容 |
|---------|---------|
| マッピングシステム | v15番号体系からv17番号体系に変更 |
| 科目コードマッピング | CODE_BASED_MAP追加（科目コード優先マッチ） |
| ロイヤリティマッピング | 科目コード512→v17No:53に修正 |
| 店舗補填追加 | v17No:54として新規追加 |
| 表示グルーピング | 「その他変動費」を「固定費」に統合 |
| 0値行非表示 | インポートデータ表示に0値行非表示機能追加 |
| ラクミー項目表示 | 全個別項目表示に拡張 |

### データ連動・エクスポート修正（2026-01-01）

| 変更項目 | 変更内容 |
|---------|---------|
| renderInputTable | データソースを`matchedItems.rowData`から`annualData[v17No]`に統一 |
| タブ切替連動 | 予算試算タブ切替時に`saveCurrentStoreData()`を実行し最新データを反映 |
| 店舗切替連動 | `switchStore()`で予算試算タブの店舗セレクトも同期 |
| 予算一覧CSV | 月次目標利益のマッピングをNo.60→No.63（営業利益）に修正 |
| MQ出力CSV | 顧客予算売上のマッピングをNo.5→No.4（売上高合計）に修正 |
| MQ出力CSV | 顧客予算営業利益のマッピングをNo.60→No.63（営業利益）に修正 |

### v5.8（前バージョン）

- 顧客CSV対応版・変換ロジック強化
- マッピング管理機能追加
- 出力データ履歴管理追加
