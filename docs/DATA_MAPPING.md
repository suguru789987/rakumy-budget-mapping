# 予算シミュレーター v17マッピング対応版 データマッピング仕様書

## 1. CSV入力フォーマット

### 1.1 想定フォーマット
```
店舗名行: , 店舗名, , , ...
空行または説明行: ...
ヘッダー行: 勘定科目コード, 勘定科目名, ..., 4月, , 5月, , ...
           (各月に「実績」「予算」の2列)
データ行: 461, 食材仕入高, ..., 実績値, 予算値, ...
```

### 1.2 月検出ロジック
1. ヘッダー行から「○月」パターンを検出
2. 各月の次列に「予算」があるか確認
3. 「予算」列の位置を`budgetColumnPositions`に保存

### 1.3 会計年度
- 4月始まり（4月〜翌3月）
- 検出された月を会計年度順にソート

---

## 2. マッピングシステム概要

### 2.1 三層マッピング構造

v17マッピング対応版では、3つのマッピング方式を併用：

```
┌─────────────────────────────────────────────────────────────┐
│                    CSV入力データ                             │
│  科目コード: 461, 科目名: 食材仕入高                          │
└──────────────────────┬──────────────────────────────────────┘
                       ↓
        ┌──────────────┴──────────────┐
        ↓                              ↓
┌───────────────────┐         ┌───────────────────┐
│  CODE_BASED_MAP   │         │  NAME_BASED_MAP   │
│  科目コード優先    │         │  科目名で補完     │
│  '461' → v17No:6  │         │  '食材仕入高'→6   │
└─────────┬─────────┘         └─────────┬─────────┘
          └──────────┬────────────────────┘
                     ↓
          ┌─────────────────────┐
          │       ITEMS         │
          │  v17No → 項目定義    │
          │  6: { name: '...' } │
          └─────────────────────┘
```

### 2.2 CODE_BASED_MAP（科目コードベース）

科目コードから直接v17番号を特定する一次マッピング：

| 科目コード | v17No | カテゴリ | 項目名 |
|-----------|-------|----------|--------|
| 810 | 2 | 売上 | 店舗売上高 |
| 811 | 3 | 売上 | ドリンク売上 |
| 812 | 4 | 売上 | その他売上高 |
| 461 | 6 | 原価 | 食材仕入高 |
| 462 | 7 | 原価 | ドリンク仕入高 |
| 501 | 10 | 固定人件費 | 給料手当 |
| 509 | 13 | PA人件費 | 雑給（PA人件費） |
| 504 | 14 | 固定人件費 | 法定福利費 |
| 530 | 15 | 固定人件費 | 旅費交通費（通勤費） |
| 506 | 16 | 固定人件費 | 賞与引当金繰入 |
| 553 | 17 | 固定人件費 | 社宅家賃 |
| 503 | 19 | PA人件費 | ヘルプ人件費 |
| 510 | 27 | その他変動費 | 販売促進費 |
| 541 | 28 | その他変動費 | メニューコピー |
| 516 | 29 | その他変動費 | 調査費 |
| 514 | 30 | その他変動費 | 衛生費 |
| 542 | 31 | その他変動費 | サービス費 |
| 520 | 32 | その他変動費 | 電気代 |
| 521 | 33 | その他変動費 | ガス代 |
| 522 | 34 | その他変動費 | 水道代 |
| 523 | 35 | その他変動費 | 消耗品費 |
| 526 | 36 | その他変動費 | 保守修繕費 |
| 527 | 37 | その他変動費 | 租税公課 |
| 529 | 38 | その他変動費 | 接待交際費 |
| 530 | 39 | その他変動費 | 旅費交通費 |
| 531 | 40 | その他変動費 | 通信費 |
| 5321 | 41 | その他変動費 | クレジット手数料 |
| 532 | 42 | その他変動費 | 支払手数料 |
| 533 | 43 | その他変動費 | 会議費 |
| 534 | 44 | その他変動費 | 諸会費 |
| 536 | 45 | その他変動費 | 図書教育費 |
| 546 | 46 | その他変動費 | 研修費 |
| 537 | 47 | その他変動費 | 業態研究費 |
| 518 | 48 | その他変動費 | 採用費 |
| 550 | 49 | その他変動費 | IT費 |
| 2128 | 50 | その他変動費 | 外注費 |
| 539 | 51 | その他変動費 | 雑費 |
| **512** | **53** | **固定費** | **ロイヤリティ** |
| **2124** | **53** | **固定費** | **ロイヤリティ（店舗別）** |
| 528 | 55 | 固定費 | 減価償却費 |
| 554 | 56 | 固定費 | 家賃 |
| 524 | 57 | 固定費 | 賃借料 |
| 552 | 58 | 固定費 | 警備料 |

### 2.3 NAME_BASED_MAP（科目名ベース）

科目コードでマッチしない場合のフォールバック：

| 科目名 | v17No | カテゴリ |
|--------|-------|----------|
| 店舗売上高 | 2 | 売上 |
| ドリンク売上 | 3 | 売上 |
| その他売上高 | 4 | 売上 |
| 食材仕入高 | 6 | 原価 |
| ドリンク仕入高 | 7 | 原価 |
| 給料手当 | 10 | 固定人件費 |
| 雑給 | 13 | PA人件費 |
| PA人件費 | 13 | PA人件費 |
| 法定福利費 | 14 | 固定人件費 |
| 通勤費 | 15 | 固定人件費 |
| 通勤交通費 | 15 | 固定人件費 |
| 賞与引当金繰入 | 16 | 固定人件費 |
| 社宅家賃 | 17 | 固定人件費 |
| ヘルプ人件費 | 19 | PA人件費 |
| **ロイヤリティ** | **53** | **固定費** |
| **店舗補填** | **54** | **固定費** |
| **店舗補てん** | **54** | **固定費** |
| ... | ... | ... |

### 2.4 ITEMS定義（v17番号→項目属性）

v17番号から項目属性を取得：

| v17No | 項目名 | カテゴリ | 入力スタイル |
|-------|--------|----------|--------------|
| 2 | 店舗売上高 | 売上 | A.そのまま入力 |
| 3 | ドリンク売上 | 売上 | A.そのまま入力 |
| 4 | その他売上高 | 売上 | A.そのまま入力 |
| 5 | 売上高合計 | 売上 | 集計項目 |
| 6 | 食材仕入高 | 原価 | A.そのまま入力 |
| 7 | ドリンク仕入高 | 原価 | A.そのまま入力 |
| ... | ... | ... | ... |
| 53 | ロイヤリティ | 固定費 | A.そのまま入力 |
| 54 | 店舗補填 | 固定費 | A.そのまま入力 |
| 55 | 減価償却費 | 固定費 | A.そのまま入力 |
| 56 | 家賃 | 固定費 | A.そのまま入力 |
| ... | ... | ... | ... |

---

## 3. 科目コードマスタ

### 3.1 マスタ一覧（抜粋）

| 科目コード | 科目名 | 備考 |
|-----------|--------|------|
| - | 本部スタッフ | コードなし |
| - | 店舗補てん | コードなし |
| 461 | 食材仕入高 | |
| 462 | ドリンク仕入高 | |
| 500 | 役員報酬 | |
| 501 | 給料手当 | |
| 503 | ヘルプ人件費 | |
| 504 | 法定福利費 | |
| 509 | 雑給 | |
| 510 | 販売促進費 | |
| 512 | ロイヤリティ | |
| 520 | 電気代 | |
| 521 | ガス代 | |
| 522 | 水道代 | |
| 528 | 減価償却費 | |
| 539 | 雑費 | |
| 554 | 家賃 | |
| 2124 | ロイヤリティ | 店舗別 |
| 2128 | 外注費 | |
| 5321 | クレジット手数料 | |

---

## 4. 項目マッピング詳細（v17体系）

### 4.1 売上関連（v17: 2-5）

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 2 | 店舗売上高 | 810 | 売上 |
| 3 | ドリンク売上 | 811 | 売上 |
| 4 | その他売上高 | 812 | 売上 |
| 5 | 売上高合計 | - | 売上（集計） |

**計算式**: 売上高合計（5）= 店舗売上高（2）+ ドリンク売上（3）+ その他売上（4）

---

### 4.2 原価関連（v17: 6-12）

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 6 | 食材仕入高 | 461 | 原価 |
| 7 | ドリンク仕入高 | 462 | 原価 |
| 8 | 食材原価 | - | 原価（集計） |
| 9 | ドリンク原価 | - | 原価（集計） |
| 10 | 内部振替 | - | 原価 |
| 11 | 原価合計 | - | 原価（集計） |
| 12 | 売上総利益 | - | 集計 |

**FD仕入費合計** = 食材仕入高（6）+ ドリンク仕入高（7）

---

### 4.3 人件費関連（v17: 13-26）

#### 固定人件費

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 10 | 給料手当 | 501 | 固定人件費 |
| 14 | 法定福利費 | 504 | 固定人件費 |
| 15 | 通勤費（旅費交通費） | 530 | 固定人件費 |
| 16 | 賞与引当金繰入 | 506 | 固定人件費 |
| 17 | 社宅家賃 | 553 | 固定人件費 |
| 18 | 休業手当 | - | 固定人件費 |

**固定人件費合計** = 給料手当（10）+ 法定福利費（14）+ 通勤費（15）+ 賞与（16）+ 社宅（17）+ 休業手当（18）

#### PA人件費（変動人件費）

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 13 | 雑給（PA人件費） | 509 | PA人件費 |
| 19 | ヘルプ人件費 | 503 | PA人件費 |

**PA人件費合計** = 雑給（13）+ ヘルプ人件費（19）

---

### 4.4 その他変動費（v17: 27-52）→ 固定費としてグルーピング

**重要**: 顧客予算では「その他変動費」はラクミーへの入力時に固定費として扱う

| v17番号 | 項目名 | 科目コード |
|---------|--------|-----------|
| 27 | 販売促進費 | 510 |
| 28 | メニューコピー | 541 |
| 29 | 調査費 | 516 |
| 30 | 衛生費 | 514 |
| 31 | サービス費 | 542 |
| 32 | 電気代 | 520 |
| 33 | ガス代 | 521 |
| 34 | 水道代 | 522 |
| 35 | 消耗品費 | 523 |
| 36 | 保守修繕費 | 526 |
| 37 | 租税公課 | 527 |
| 38 | 接待交際費 | 529 |
| 39 | 旅費交通費 | 530 |
| 40 | 通信費 | 531 |
| 41 | クレジット手数料 | 5321 |
| 42 | 支払手数料 | 532 |
| 43 | 会議費 | 533 |
| 44 | 諸会費 | 534 |
| 45 | 図書教育費 | 536 |
| 46 | 研修費 | 546 |
| 47 | 業態研究費 | 537 |
| 48 | 採用費 | 518 |
| 49 | IT費 | 550 |
| 50 | 外注費 | 2128 |
| 51 | 雑費 | 539 |
| 52 | その他経費小計 | - |

---

### 4.5 固定費関連（v17: 53-60）

| v17番号 | 項目名 | 科目コード | 備考 |
|---------|--------|-----------|------|
| **53** | **ロイヤリティ** | **512, 2124** | **顧客独自項目** |
| **54** | **店舗補填** | **-** | **顧客独自項目（コードなし）** |
| 55 | 減価償却費 | 528 | |
| 56 | 家賃 | 554 | |
| 57 | 賃借料 | 524 | |
| 58 | 警備料 | 552 | |
| 59 | リース料 | - | |
| 60 | 固定費合計 | - | 集計 |

**地代家賃合計** = 家賃（56）+ 賃借料（57）
**資材費合計** = 警備料（58）+ リース料（59）

---

## 5. MQ計算ロジック

### 5.1 変動費の定義

MQ（Management Quotient）計算における変動費：

```
変動費 = FD仕入費 + PA人件費
       = (食材仕入高 + ドリンク仕入高) + (雑給 + ヘルプ人件費)
       = (No.6 + No.7) + (No.13 + No.19)
```

### 5.2 固定費の定義

固定費 = 上記以外のすべての費用

```
固定費合計 = 固定人件費合計 + 地代家賃合計 + 資材費合計 + 減価償却費 + その他経費
```

**重要**: ロイヤリティ（No.53）と店舗補填（No.54）はMQ固定費計算に含めない
- これらはv17マッピング表に存在しない顧客独自項目
- 表示のみで、MQ計算からは除外

### 5.3 MQ出力計算

```javascript
// 売上 = 客数 × 客単価
sales = customers × unitPrice / 1000  // 千円単位

// 変動費 = 売上 × (FD仕入費率 + PA人件費率)
variableCost = sales × (fdRate + paRate) / 100

// 粗利 = 売上 - 変動費
grossProfit = sales - variableCost

// 固定費 = 固定人件費 + 地代家賃 + 資材費 + 減価償却費 + その他経費
fixedCost = fixedLabor + rent + material + depreciation + otherExpenses

// 営業利益 = 粗利 - 固定費
operatingProfit = grossProfit - fixedCost
```

---

## 6. 表示グルーピング

### 6.1 顧客予算項目の表示構造

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   No.2  店舗売上高                          │
│   No.3  ドリンク売上                        │
│   No.4  その他売上高                        │
│   No.5  売上高合計（ハイライト）             │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   No.6  食材仕入高                          │
│   No.7  ドリンク仕入高                      │
│   No.13 雑給（PA人件費）                    │
│   No.19 ヘルプ人件費                        │
│   [変動費合計]（ハイライト）                 │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   No.10 給料手当                           │
│   No.14 法定福利費                         │
│   ...                                      │
│   [固定人件費合計]（ハイライト）             │
├────────────────────────────────────────────┤
│ 固定費（その他経費 + 従来の固定費）           │
│   No.27 販売促進費                         │
│   No.28 メニューコピー                      │
│   ...                                      │
│   No.51 雑費                               │
│   No.52 その他経費小計（ハイライト）         │
│   No.53 ロイヤリティ                        │
│   No.54 店舗補填                           │
│   No.55 減価償却費                         │
│   No.56 家賃                               │
│   ...                                      │
│   No.60 固定費合計（ハイライト）             │
├────────────────────────────────────────────┤
│ 損益                                       │
│   [営業利益]                               │
└────────────────────────────────────────────┘
```

### 6.2 ラクミー予算項目の表示構造

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   売上（税抜）                              │
│   ランチ売上                                │
│   ディナー売上                              │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   FD仕入費                                 │
│   PA人件費                                 │
│   変動費合計（ハイライト）                   │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   給料手当                                  │
│   法定福利費                                │
│   ...（全項目表示）                         │
│   固定人件費合計（ハイライト）               │
├────────────────────────────────────────────┤
│ 固定費                                     │
│   販売促進費                                │
│   メニューコピー                            │
│   ...（全項目表示）                         │
│   ロイヤリティ                              │
│   店舗補填                                  │
│   減価償却費                                │
│   家賃                                     │
│   ...                                      │
│   固定費合計（ハイライト）                   │
├────────────────────────────────────────────┤
│ 損益                                       │
│   粗利                                     │
│   営業利益                                  │
└────────────────────────────────────────────┘
```

---

## 7. 0値行の非表示機能

### 7.1 対象

取り込みデータ表示（インポートデータ）のみ

### 7.2 ロジック

```javascript
// 合計を先に計算（0値の行を非表示にするため）
var total = 0;
for (var m = 0; m < activeMonths.length; m++) {
    var val = item.rowData ? (item.rowData[m] || 0) : 0;
    total += val;
}
// 合計が0の行はスキップ（非表示）
if (total === 0) return;
```

### 7.3 適用範囲

- インポート取り込みデータ表示: 適用
- 予算試算テーブル: 非適用（全項目表示）

---

## 8. データフロー図

```
┌──────────────────────────────────────────────────────────────┐
│                    顧客予算CSV                               │
│  (科目コード, 科目名, 月別予算値...)                          │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│              CODE_BASED_MAP（科目コードマッチ）                │
│  科目コード → v17番号 マッピング                              │
└─────────────────────────┬────────────────────────────────────┘
                          ↓ マッチしない場合
┌──────────────────────────────────────────────────────────────┐
│              NAME_BASED_MAP（科目名マッチ）                    │
│  科目名 → v17番号 マッピング                                  │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    annualData                                │
│  { v17番号: [月1, 月2, ..., 月12] }                           │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    CALC_RULES                                │
│  演算ルール（合計、率計算など）                                │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    calcResults                               │
│  { 月index: { ルール名: 計算値 } }                            │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   RAKUMY_ITEMS                               │
│  ラクミー項目定義（ソース、変換タイプ）                         │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   rakumyInputs                               │
│  { 月index: { key: 値 } }                                    │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   MQシミュレーション                          │
│  売上=客数×客単価, 営業利益=粗利-固定費                        │
│  ※ロイヤリティ・店舗補填は固定費計算に含まない                  │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    mqOutputs                                 │
│  { 月index: { sales, variableCost, grossProfit, ... } }      │
└──────────────────────────────────────────────────────────────┘
```

---

## 9. マッピング修正履歴

### 9.1 v17対応で修正した主な項目

| 修正内容 | 修正前 | 修正後 | 理由 |
|---------|--------|--------|------|
| ロイヤリティの科目コード | 512→v17No:51（雑費） | 512→v17No:53 | マッピングミス修正 |
| 店舗補填の追加 | 未定義 | v17No:54 | 顧客独自項目として追加 |
| ITEMS No.53定義 | 変動費合計（集計） | ロイヤリティ | 顧客予算構造に統一 |
| ITEMS No.54定義 | 限界利益（集計） | 店舗補填 | 顧客予算構造に統一 |

### 9.2 注意事項

- ロイヤリティ（No.53）と店舗補填（No.54）はv17マッピング表に存在しない顧客独自項目
- これらはMQ固定費計算には含めず、表示のみ
- 店舗補填は科目コードが存在しないため、NAME_BASED_MAPでのみマッチ

---

## 10. v18マッピング表

科目コード付きのv18マッピング表は以下の場所に保存：
`/Users/sugurutsutsui/Downloads/顧客予算_ラクミー_パイプラインマッピング表_v18_科目コード付き.csv`

### 主な追加項目

| v17No | 項目名 | 科目コード | 科目名（マスタ） | 備考 |
|-------|--------|-----------|------------------|------|
| 71 | ロイヤリティ | 512 | ロイヤリティ | 顧客独自項目 |
| 72 | 店舗補填 | - | 店舗補てん | 顧客独自項目（コードなし） |
