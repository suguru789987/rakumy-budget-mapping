# 予算シミュレーター v17マッピング対応版 データマッピング仕様書

## 1. CSV入力フォーマット

### 1.1 想定フォーマット
```
店舗名行: , 店舗名, , , ...
空行または説明行: ...
ヘッダー行: 勘定科目コード, 勘定科目名, ..., 4月, , 5月, , ...
           (各月に「実績」「予算」の2列)
データ行: 461, 食材仕入高, ..., 実績値, 予算値, ...
```

### 1.2 月検出ロジック
1. ヘッダー行から「○月」パターンを検出
2. 各月の次列に「予算」があるか確認
3. 「予算」列の位置を`budgetColumnPositions`に保存

### 1.3 会計年度
- 4月始まり（4月〜翌3月）
- 検出された月を会計年度順にソート

---

## 2. マッピングシステム概要

### 2.1 三層マッピング構造

v17マッピング対応版では、3つのマッピング方式を併用：

```
┌─────────────────────────────────────────────────────────────┐
│                    CSV入力データ                             │
│  科目コード: 461, 科目名: 食材仕入高                          │
└──────────────────────┬──────────────────────────────────────┘
                       ↓
        ┌──────────────┴──────────────┐
        ↓                              ↓
┌───────────────────┐         ┌───────────────────┐
│  CODE_BASED_MAP   │         │  NAME_BASED_MAP   │
│  科目コード優先    │         │  科目名で補完     │
│  '461' → v17No:6  │         │  '食材仕入高'→6   │
└─────────┬─────────┘         └─────────┬─────────┘
          └──────────┬────────────────────┘
                     ↓
          ┌─────────────────────┐
          │       ITEMS         │
          │  v17No → 項目定義    │
          │  6: { name: '...' } │
          └─────────────────────┘
```

### 2.2 CODE_BASED_MAP（科目コードベース）

科目コードから直接v17番号を特定する一次マッピング：

| 科目コード | v17No | カテゴリ | 項目名 |
|-----------|-------|----------|--------|
| 810 | 2 | 売上 | 店舗売上高 |
| 811 | 3 | 売上 | ドリンク売上 |
| 812 | 4 | 売上 | その他売上高 |
| 461 | 6 | 原価 | 食材仕入高 |
| 462 | 7 | 原価 | ドリンク仕入高 |
| 501 | 10 | 固定人件費 | 給料手当 |
| 509 | 13 | PA人件費 | 雑給（PA人件費） |
| 504 | 14 | 固定人件費 | 法定福利費 |
| 530 | 15 | 固定人件費 | 旅費交通費（通勤費） |
| 506 | 16 | 固定人件費 | 賞与引当金繰入 |
| 553 | 17 | 固定人件費 | 社宅家賃 |
| 503 | 19 | PA人件費 | ヘルプ人件費 |
| 510 | 27 | その他変動費 | 販売促進費 |
| 541 | 28 | その他変動費 | メニューコピー |
| 516 | 29 | その他変動費 | 調査費 |
| 514 | 30 | その他変動費 | 衛生費 |
| 542 | 31 | その他変動費 | サービス費 |
| 520 | 32 | その他変動費 | 電気代 |
| 521 | 33 | その他変動費 | ガス代 |
| 522 | 34 | その他変動費 | 水道代 |
| 523 | 35 | その他変動費 | 消耗品費 |
| 526 | 36 | その他変動費 | 保守修繕費 |
| 527 | 37 | その他変動費 | 租税公課 |
| 529 | 38 | その他変動費 | 接待交際費 |
| 530 | 39 | その他変動費 | 旅費交通費 |
| 531 | 40 | その他変動費 | 通信費 |
| 5321 | 41 | その他変動費 | クレジット手数料 |
| 532 | 42 | その他変動費 | 支払手数料 |
| 533 | 43 | その他変動費 | 会議費 |
| 534 | 44 | その他変動費 | 諸会費 |
| 536 | 45 | その他変動費 | 図書教育費 |
| 546 | 46 | その他変動費 | 研修費 |
| 537 | 47 | その他変動費 | 業態研究費 |
| 518 | 48 | その他変動費 | 採用費 |
| 550 | 49 | その他変動費 | IT費 |
| 2128 | 50 | その他変動費 | 外注費 |
| 539 | 51 | その他変動費 | 雑費 |
| **512** | **53** | **固定費** | **ロイヤリティ** |
| **2124** | **53** | **固定費** | **ロイヤリティ（店舗別）** |
| 528 | 55 | 固定費 | 減価償却費 |
| 554 | 56 | 固定費 | 家賃 |
| 524 | 57 | 固定費 | 賃借料 |
| 552 | 58 | 固定費 | 警備料 |

### 2.3 NAME_BASED_MAP（科目名ベース）

科目コードでマッチしない場合のフォールバック：

| 科目名 | v17No | カテゴリ |
|--------|-------|----------|
| 店舗売上高 | 2 | 売上 |
| ドリンク売上 | 3 | 売上 |
| その他売上高 | 4 | 売上 |
| 食材仕入高 | 6 | 原価 |
| ドリンク仕入高 | 7 | 原価 |
| 給料手当 | 10 | 固定人件費 |
| 雑給 | 13 | PA人件費 |
| PA人件費 | 13 | PA人件費 |
| 法定福利費 | 14 | 固定人件費 |
| 通勤費 | 15 | 固定人件費 |
| 通勤交通費 | 15 | 固定人件費 |
| 賞与引当金繰入 | 16 | 固定人件費 |
| 社宅家賃 | 17 | 固定人件費 |
| ヘルプ人件費 | 19 | PA人件費 |
| **ロイヤリティ** | **53** | **固定費** |
| **店舗補填** | **54** | **固定費** |
| **店舗補てん** | **54** | **固定費** |
| ... | ... | ... |

### 2.4 ITEMS定義（v17番号→項目属性）

v17番号から項目属性を取得：

| v17No | 項目名 | カテゴリ | 入力スタイル |
|-------|--------|----------|--------------|
| 2 | 店舗売上高 | 売上 | A.そのまま入力 |
| 3 | ドリンク売上 | 売上 | A.そのまま入力 |
| 4 | その他売上高 | 売上 | A.そのまま入力 |
| 5 | 売上高合計 | 売上 | 集計項目 |
| 6 | 食材仕入高 | 原価 | A.そのまま入力 |
| 7 | ドリンク仕入高 | 原価 | A.そのまま入力 |
| ... | ... | ... | ... |
| 53 | ロイヤリティ | 固定費 | A.そのまま入力 |
| 54 | 店舗補填 | 固定費 | A.そのまま入力 |
| 55 | 減価償却費 | 固定費 | A.そのまま入力 |
| 56 | 家賃 | 固定費 | A.そのまま入力 |
| ... | ... | ... | ... |

---

## 3. 科目コードマスタ

### 3.1 マスタ一覧（抜粋）

| 科目コード | 科目名 | 備考 |
|-----------|--------|------|
| - | 本部スタッフ | コードなし |
| - | 店舗補てん | コードなし |
| 461 | 食材仕入高 | |
| 462 | ドリンク仕入高 | |
| 500 | 役員報酬 | |
| 501 | 給料手当 | |
| 503 | ヘルプ人件費 | |
| 504 | 法定福利費 | |
| 509 | 雑給 | |
| 510 | 販売促進費 | |
| 512 | ロイヤリティ | |
| 520 | 電気代 | |
| 521 | ガス代 | |
| 522 | 水道代 | |
| 528 | 減価償却費 | |
| 539 | 雑費 | |
| 554 | 家賃 | |
| 2124 | ロイヤリティ | 店舗別 |
| 2128 | 外注費 | |
| 5321 | クレジット手数料 | |

---

## 4. 項目マッピング詳細（v17体系）

### 4.1 売上関連（v17: 2-5）

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 2 | 店舗売上高 | 810 | 売上 |
| 3 | ドリンク売上 | 811 | 売上 |
| 4 | その他売上高 | 812 | 売上 |
| 5 | 売上高合計 | - | 売上（集計） |

**計算式**: 売上高合計（5）= 店舗売上高（2）+ ドリンク売上（3）+ その他売上（4）

---

### 4.2 原価関連（v17: 6-12）

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 6 | 食材仕入高 | 461 | 原価 |
| 7 | ドリンク仕入高 | 462 | 原価 |
| 8 | 食材原価 | - | 原価（集計） |
| 9 | ドリンク原価 | - | 原価（集計） |
| 10 | 内部振替 | - | 原価 |
| 11 | 原価合計 | - | 原価（集計） |
| 12 | 売上総利益 | - | 集計 |

**FD仕入費合計** = 食材仕入高（6）+ ドリンク仕入高（7）

---

### 4.3 人件費関連（v17: 13-26）

#### 固定人件費

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 10 | 給料手当 | 501 | 固定人件費 |
| 14 | 法定福利費 | 504 | 固定人件費 |
| 15 | 通勤費（旅費交通費） | 530 | 固定人件費 |
| 16 | 賞与引当金繰入 | 506 | 固定人件費 |
| 17 | 社宅家賃 | 553 | 固定人件費 |
| 18 | 休業手当 | - | 固定人件費 |

**固定人件費合計** = 給料手当（10）+ 法定福利費（14）+ 通勤費（15）+ 賞与（16）+ 社宅（17）+ 休業手当（18）

#### PA人件費（変動人件費）

| v17番号 | 項目名 | 科目コード | カテゴリ |
|---------|--------|-----------|----------|
| 13 | 雑給（PA人件費） | 509 | PA人件費 |
| 19 | ヘルプ人件費 | 503 | PA人件費 |

**PA人件費合計** = 雑給（13）+ ヘルプ人件費（19）

---

### 4.4 その他変動費（v17: 27-52）→ 固定費としてグルーピング

**重要**: 顧客予算では「その他変動費」はラクミーへの入力時に固定費として扱う

| v17番号 | 項目名 | 科目コード |
|---------|--------|-----------|
| 27 | 販売促進費 | 510 |
| 28 | メニューコピー | 541 |
| 29 | 調査費 | 516 |
| 30 | 衛生費 | 514 |
| 31 | サービス費 | 542 |
| 32 | 電気代 | 520 |
| 33 | ガス代 | 521 |
| 34 | 水道代 | 522 |
| 35 | 消耗品費 | 523 |
| 36 | 保守修繕費 | 526 |
| 37 | 租税公課 | 527 |
| 38 | 接待交際費 | 529 |
| 39 | 旅費交通費 | 530 |
| 40 | 通信費 | 531 |
| 41 | クレジット手数料 | 5321 |
| 42 | 支払手数料 | 532 |
| 43 | 会議費 | 533 |
| 44 | 諸会費 | 534 |
| 45 | 図書教育費 | 536 |
| 46 | 研修費 | 546 |
| 47 | 業態研究費 | 537 |
| 48 | 採用費 | 518 |
| 49 | IT費 | 550 |
| 50 | 外注費 | 2128 |
| 51 | 雑費 | 539 |
| 52 | その他経費小計 | - |

---

### 4.5 固定費関連（v17: 53-60）

| v17番号 | 項目名 | 科目コード | 備考 |
|---------|--------|-----------|------|
| **53** | **ロイヤリティ** | **512, 2124** | **顧客独自項目** |
| **54** | **店舗補填** | **-** | **顧客独自項目（コードなし）** |
| 55 | 減価償却費 | 528 | |
| 56 | 家賃 | 554 | |
| 57 | 賃借料 | 524 | |
| 58 | 警備料 | 552 | |
| 59 | リース料 | - | |
| 60 | 固定費合計 | - | 集計 |

**地代家賃合計** = 家賃（56）+ 賃借料（57）
**資材費合計** = 警備料（58）+ リース料（59）

---

## 5. MQ計算ロジック

### 5.1 変動費の定義

MQ（Management Quotient）計算における変動費：

```
変動費 = FD仕入費 + PA人件費
       = (食材仕入高 + ドリンク仕入高) + (雑給 + ヘルプ人件費)
       = (No.6 + No.7) + (No.13 + No.19)
```

### 5.2 固定費の定義

固定費 = 上記以外のすべての費用

```
固定費合計 = 固定人件費合計 + 地代家賃合計 + 資材費合計 + 減価償却費 + その他経費
```

**重要**: ロイヤリティ（No.53）と店舗補填（No.54）はMQ固定費計算に含めない
- これらはv17マッピング表に存在しない顧客独自項目
- 表示のみで、MQ計算からは除外

### 5.3 MQ出力計算

```javascript
// 売上 = 客数 × 客単価
sales = customers × unitPrice / 1000  // 千円単位

// 変動費 = 売上 × (FD仕入費率 + PA人件費率)
variableCost = sales × (fdRate + paRate) / 100

// 粗利 = 売上 - 変動費
grossProfit = sales - variableCost

// 固定費 = 固定人件費 + 地代家賃 + 資材費 + 減価償却費 + その他経費
fixedCost = fixedLabor + rent + material + depreciation + otherExpenses

// 営業利益 = 粗利 - 固定費
operatingProfit = grossProfit - fixedCost
```

---

## 6. 表示グルーピング

### 6.1 顧客予算項目の表示構造

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   No.2  店舗売上高                          │
│   No.3  ドリンク売上                        │
│   No.4  その他売上高                        │
│   No.5  売上高合計（ハイライト）             │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   No.6  食材仕入高                          │
│   No.7  ドリンク仕入高                      │
│   No.13 雑給（PA人件費）                    │
│   No.19 ヘルプ人件費                        │
│   [変動費合計]（ハイライト）                 │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   No.10 給料手当                           │
│   No.14 法定福利費                         │
│   ...                                      │
│   [固定人件費合計]（ハイライト）             │
├────────────────────────────────────────────┤
│ 固定費（その他経費 + 従来の固定費）           │
│   No.27 販売促進費                         │
│   No.28 メニューコピー                      │
│   ...                                      │
│   No.51 雑費                               │
│   No.52 その他経費小計（ハイライト）         │
│   No.53 ロイヤリティ                        │
│   No.54 店舗補填                           │
│   No.55 減価償却費                         │
│   No.56 家賃                               │
│   ...                                      │
│   No.60 固定費合計（ハイライト）             │
├────────────────────────────────────────────┤
│ 損益                                       │
│   [営業利益]                               │
└────────────────────────────────────────────┘
```

### 6.2 ラクミー予算項目の表示構造

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   売上（税抜）                              │
│   ランチ売上                                │
│   ディナー売上                              │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   FD仕入費                                 │
│   PA人件費                                 │
│   変動費合計（ハイライト）                   │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   給料手当                                  │
│   法定福利費                                │
│   ...（全項目表示）                         │
│   固定人件費合計（ハイライト）               │
├────────────────────────────────────────────┤
│ 固定費                                     │
│   販売促進費                                │
│   メニューコピー                            │
│   ...（全項目表示）                         │
│   ロイヤリティ                              │
│   店舗補填                                  │
│   減価償却費                                │
│   家賃                                     │
│   ...                                      │
│   固定費合計（ハイライト）                   │
├────────────────────────────────────────────┤
│ 損益                                       │
│   粗利                                     │
│   営業利益                                  │
└────────────────────────────────────────────┘
```

---

## 7. 0値行の非表示機能

### 7.1 対象

取り込みデータ表示（インポートデータ）のみ

### 7.2 ロジック

```javascript
// 合計を先に計算（0値の行を非表示にするため）
var total = 0;
for (var m = 0; m < activeMonths.length; m++) {
    var val = item.rowData ? (item.rowData[m] || 0) : 0;
    total += val;
}
// 合計が0の行はスキップ（非表示）
if (total === 0) return;
```

### 7.3 適用範囲

- インポート取り込みデータ表示: 適用
- 予算試算テーブル: 非適用（全項目表示）

---

## 8. データフロー図

```
┌──────────────────────────────────────────────────────────────┐
│                    顧客予算CSV                               │
│  (科目コード, 科目名, 月別予算値...)                          │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│              CODE_BASED_MAP（科目コードマッチ）                │
│  科目コード → v17番号 マッピング                              │
└─────────────────────────┬────────────────────────────────────┘
                          ↓ マッチしない場合
┌──────────────────────────────────────────────────────────────┐
│              NAME_BASED_MAP（科目名マッチ）                    │
│  科目名 → v17番号 マッピング                                  │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    annualData                                │
│  { v17番号: [月1, 月2, ..., 月12] }                           │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    CALC_RULES                                │
│  演算ルール（合計、率計算など）                                │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    calcResults                               │
│  { 月index: { ルール名: 計算値 } }                            │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   RAKUMY_ITEMS                               │
│  ラクミー項目定義（ソース、変換タイプ）                         │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   rakumyInputs                               │
│  { 月index: { key: 値 } }                                    │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   MQシミュレーション                          │
│  売上=客数×客単価, 営業利益=粗利-固定費                        │
│  ※ロイヤリティ・店舗補填は固定費計算に含まない                  │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    mqOutputs                                 │
│  { 月index: { sales, variableCost, grossProfit, ... } }      │
└──────────────────────────────────────────────────────────────┘
```

---

## 9. マッピング修正履歴

### 9.1 v17対応で修正した主な項目

| 修正内容 | 修正前 | 修正後 | 理由 |
|---------|--------|--------|------|
| ロイヤリティの科目コード | 512→v17No:51（雑費） | 512→v17No:53 | マッピングミス修正 |
| 店舗補填の追加 | 未定義 | v17No:54 | 顧客独自項目として追加 |
| ITEMS No.53定義 | 変動費合計（集計） | ロイヤリティ | 顧客予算構造に統一 |
| ITEMS No.54定義 | 限界利益（集計） | 店舗補填 | 顧客予算構造に統一 |

### 9.2 注意事項

- ロイヤリティ（No.53）と店舗補填（No.54）はv17マッピング表に存在しない顧客独自項目
- これらはMQ固定費計算には含めず、表示のみ
- 店舗補填は科目コードが存在しないため、NAME_BASED_MAPでのみマッチ

---

## 10. エクスポート機能マッピング

### 10.1 予算一覧CSV

| 出力項目 | データソース | v17No | 備考 |
|---------|-------------|-------|------|
| 月次目標利益 | stAnnualData[63] | 63 | 営業利益 |
| 売上（税抜） | stAnnualData[4] | 4 | 売上高合計 |
| FD仕入費 | FD仕入費合計 | - | calcResults |
| PA人件費 | PA人件費合計 | - | calcResults |
| 固定人件費 | 固定人件費合計 | - | calcResults |
| 固定費（その他経費） | その他経費小計 | 52 | - |

### 10.2 MQ出力CSV

| 出力項目 | データソース | v17No | 備考 |
|---------|-------------|-------|------|
| 顧客予算売上 | stAnnualData[4] | 4 | 売上高合計 |
| 顧客予算変動費 | FD仕入費+PA人件費 | - | calcResults |
| 顧客予算粗利 | 売上-変動費 | - | 計算値 |
| 顧客予算固定費 | 固定費合計 | - | calcResults |
| 顧客予算営業利益 | stAnnualData[63] | 63 | 営業利益 |

### 10.3 ラクミー入力値CSV

RAKUMY_ITEMS定義に基づいてrakumyInputsから出力。

### 10.4 マッピング修正履歴

| 修正日 | 対象 | 修正前 | 修正後 | 理由 |
|-------|------|--------|--------|------|
| 2026-01-01 | 予算一覧CSV・月次目標利益 | No.60 | No.63 | No.60は販管費合計、No.63が営業利益 |
| 2026-01-01 | MQ出力CSV・顧客予算売上 | No.5 | No.4 | No.5は売上高合計（集計）、No.4が正しい |
| 2026-01-01 | MQ出力CSV・顧客予算営業利益 | No.60 | No.63 | No.60は販管費合計、No.63が営業利益 |

---

## 11. v18マッピング表

科目コード付きのv18マッピング表は以下の場所に保存：
`/Users/sugurutsutsui/Downloads/顧客予算_ラクミー_パイプラインマッピング表_v18_科目コード付き.csv`

### 主な追加項目

| v17No | 項目名 | 科目コード | 科目名（マスタ） | 備考 |
|-------|--------|-----------|------------------|------|
| 71 | ロイヤリティ | 512 | ロイヤリティ | 顧客独自項目 |
| 72 | 店舗補填 | - | 店舗補てん | 顧客独自項目（コードなし） |

---

## 12. データ連動仕様

### 12.1 annualDataの役割

`annualData`はすべてのテーブル表示で使用される統一データソース：

```javascript
annualData = {
    [v17No]: [月1値, 月2値, ..., 月12値],
    ...
}
```

### 12.2 データフロー（インポート→表示）

```
CSVパース → マッピング → annualData格納 → allStoresData保存
                                ↓
            ┌──────────────────┼──────────────────┐
            ↓                  ↓                  ↓
    renderInputTable    renderCalcTable    renderRakumyTable
    (annualData参照)    (annualData参照)    (annualData参照)
```

### 12.3 タブ切替時の連動

予算試算タブへの切替時：
1. `saveCurrentStoreData()` - 現在のデータを保存
2. `updateSimulationStoreSelect()` - 店舗セレクト更新
3. `loadSimulationData()` - 選択店舗のデータをロード

### 12.4 店舗切替時の連動

`switchStore(name)` 実行時：
1. 現在の店舗データを保存
2. 新店舗のデータをannualData/calcResultsに復元
3. 各テーブルを再描画
4. 予算試算タブの店舗セレクトも同期

---

## 13. CUSTOMER_CODE_MAP（予算テンプレートコードマップ）

### 13.1 概要

顧客予算テンプレートCSVの科目コード（101, 201...）をv17番号にマッピング。
**screen属性**により値種別フラグが自動判定される。

### 13.2 データ構造

```javascript
CUSTOMER_CODE_MAP = {
    '101': {
        v15No: 1,                    // v17番号（内部項目ID）
        name: '店舗売上高',           // 項目名
        category: '売上高',           // カテゴリ
        budgetCategory: '売上高',     // 予算カテゴリ（表示順制御用）
        sortOrder: 1,                // カテゴリ内表示順
        inputStyle: 'C.自動演算',     // 入力スタイル
        screen: '自動'               // ★ 出力先画面（フラグ判定に使用）
    },
    '301': {
        v15No: 16,
        name: '給料手当',
        category: '人件費',
        budgetCategory: '人件費',
        sortOrder: 1,
        inputStyle: 'B.合算して入力',
        screen: '設定>費用予算設定'   // → 費用出力フラグ=true
    },
    '201': {
        v15No: 5,
        name: '食材期首棚',
        category: '売上原価',
        budgetCategory: '売上原価',
        sortOrder: 1,
        inputStyle: 'D.参照のみ',
        screen: '参照のみ'           // → 参照のみフラグ=true
    },
    // ...
};
```

### 13.3 screen属性の値と意味

| screen属性 | 意味 | 出力先 |
|-----------|------|--------|
| `'設定>費用予算設定'` | 費用予算設定画面に出力 | 費用予算設定 |
| `'設定>月次予算設定'` | MQ計算に使用 | MQ計算 |
| `'設定>月次予算設定>売上構成比設定'` | 売上構成比設定 | MQ計算 |
| `'参照のみ'` | 出力なし（参照用） | なし |
| `'自動'` | 自動演算項目 | 自動 |

---

## 14. 値種別フラグシステム

### 14.1 フラグ一覧

顧客予算項目をインポートする際、以下のフラグで出力先・計算方法を判定：

| フラグ名 | 説明 | UI表示 |
|---------|------|--------|
| `isCostInput` | 費用予算設定に出力 | 費用出力 |
| `isBudgetInput` | MQ計算に出力 | MQ出力 |
| `isReferenceOnly` | 参照のみ（出力なし） | 参照のみ |
| `isTotal` | 合計値（個別項目の合計） | 合計 |
| `isCalculated` | 演算値（合計値同士の演算結果） | 演算 |

### 14.2 screen属性からのフラグ自動判定

CSVインポート時、CUSTOMER_CODE_MAPのscreen属性から自動でフラグを設定：

| screen属性 | isCostInput | isBudgetInput | isReferenceOnly |
|-----------|-------------|---------------|-----------------|
| `'設定>費用予算設定'` | ✅ true | false | false |
| `'設定>月次予算設定'` | false | ✅ true | false |
| `'設定>月次予算設定>売上構成比設定'` | false | ✅ true | false |
| `'参照のみ'` | false | false | ✅ true |
| `'自動'` | false | false | false |

### 14.3 inputStyleからのフラグ自動判定

isTotal・isCalculatedはinputStyleと項目名から判定：

| 条件 | isTotal | isCalculated |
|------|---------|--------------|
| `inputStyle='C.自動演算'` かつ 名前に「合計」「小計」 | ✅ true | false |
| `inputStyle='C.自動演算'` かつ CALCULATED_ITEMSに含まれる or 「利益」 | false | ✅ true |
| その他 | false | false |

### 14.4 CALCULATED_ITEMS（演算項目リスト）

以下の項目名はisCalculated=trueとして判定：

```javascript
var CALCULATED_ITEMS = [
    '売上総利益', '粗利', '粗利益',
    '限界利益', '限界利益額',
    '営業利益', '店舗営業利益', '経常利益',
    '変動費合計', '固定費合計', '販売管理費合計'
];
```

### 14.5 フラグ判定ロジック（実装）

```javascript
function determineFlags(item, screen, inputStyle) {
    var flags = {
        isCostInput: false,
        isBudgetInput: false,
        isReferenceOnly: false,
        isTotal: false,
        isCalculated: false
    };

    // screen属性からフラグ判定
    if (screen === '設定>費用予算設定') {
        flags.isCostInput = true;
    } else if (screen === '設定>月次予算設定' ||
               screen === '設定>月次予算設定>売上構成比設定') {
        flags.isBudgetInput = true;
    } else if (screen === '参照のみ') {
        flags.isReferenceOnly = true;
    }

    // inputStyleからisTotal/isCalculated判定
    if (inputStyle === 'C.自動演算') {
        var name = item.name || '';
        if (name.indexOf('合計') >= 0 || name.indexOf('小計') >= 0) {
            flags.isTotal = true;
        } else if (CALCULATED_ITEMS.indexOf(name) >= 0 ||
                   name.indexOf('利益') >= 0) {
            flags.isCalculated = true;
        }
    }

    return flags;
}
```

---

## 15. マッピング優先順位

### 15.1 CSVインポート時のマッピング検索順序

```
1. CUSTOMER_CODE_MAP（予算テンプレートコード）
   └─ screen属性からフラグ判定 ★
         ↓ マッチしない場合
2. CODE_BASED_MAP（勘定科目コード）
         ↓ マッチしない場合
3. NAME_BASED_MAP（項目名）
         ↓
4. ITEMS[v17No]で正式な項目情報を参照
```

### 15.2 マッピングの使い分け

| マッピング | 用途 | 特徴 |
|-----------|------|------|
| CUSTOMER_CODE_MAP | 予算テンプレートCSV | screen属性でフラグ自動判定 |
| CODE_BASED_MAP | 勘定科目コード形式CSV | 勘定科目コードで直接マッチ |
| NAME_BASED_MAP | 項目名のみのCSV | 表記揺れに対応（多数のバリエーション） |

### 15.3 v17No（v17番号）の範囲

| 範囲 | 内容 |
|------|------|
| 1-4 | 売上高（店舗売上、ドリンク、その他、合計） |
| 5-15 | 売上原価（棚卸、仕入、原価、利益） |
| 16-26 | 人件費 |
| 27-51 | 各種経費（販促費、水道光熱費、管理費等） |
| 52-54 | 変動費合計、ロイヤリティ、店舗補填 |
| 55-60 | 固定費（減価償却、家賃、リース等） |
| 61-63 | 損益（店舗営業利益、販管費合計、営業利益） |
