# 予算シミュレーター v5.8 データマッピング仕様書

## 1. CSV入力フォーマット

### 1.1 想定フォーマット
```
店舗名行: , 店舗名, , , ...
空行または説明行: ...
ヘッダー行: 勘定科目コード, 勘定科目名, ..., 4月, , 5月, , ...
           (各月に「実績」「予算」の2列)
データ行: A0001, 売上高合計, ..., 実績値, 予算値, ...
```

### 1.2 月検出ロジック
1. ヘッダー行から「○月」パターンを検出
2. 各月の次列に「予算」があるか確認
3. 「予算」列の位置を`budgetColumnPositions`に保存

### 1.3 会計年度
- 4月始まり（4月〜翌3月）
- 検出された月を会計年度順にソート

---

## 2. マッピング管理機能

### 2.1 概要
顧客予算項目の変更に柔軟に対応するための動的マッピング管理機能。

### 2.2 ワークフロー

```
┌────────────────────────────────────────────────────────────┐
│                  新規CSVインポート                          │
└──────────────────────┬─────────────────────────────────────┘
                       ↓
┌────────────────────────────────────────────────────────────┐
│              項目マッチング処理                             │
│  CUSTOMER_CODE_MAP と CSV項目を照合                        │
└──────────────────────┬─────────────────────────────────────┘
                       ↓
            ┌──────────┴──────────┐
            ↓                     ↓
┌─────────────────────┐  ┌─────────────────────┐
│   マッチ項目        │  │   未マッチ項目      │
│   →データ変換実行   │  │   →未マッチリスト表示│
└─────────────────────┘  └──────────┬──────────┘
                                    ↓
                       ┌────────────┴────────────┐
                       ↓                         ↓
              ┌────────────────┐       ┌────────────────┐
              │ 類似候補あり  │       │ 類似候補なし  │
              │ →提案を表示  │       │ →手動追加    │
              └───────┬────────┘       └───────┬────────┘
                      ↓                        ↓
              ┌────────────────┐       ┌────────────────┐
              │ 適用ボタン押下 │       │ +追加ボタン   │
              │ →マッピング追加│       │ →新規フォーム │
              └────────────────┘       └────────────────┘
```

### 2.3 編集モード

#### 通常モード（編集モードOFF）
- マッチした項目のみ表示
- 編集・削除ボタン非表示

#### 編集モード（編集モードON）
- 全マッピング定義を表示
- 各行に編集・削除ボタン表示
- インライン編集可能

### 2.4 マッピングCSVフォーマット

#### エクスポート形式
```csv
顧客コード,v15番号,項目名,カテゴリ
A0001,5,売上高合計,売上
A0051,2,ランチ売上,売上
A0052,3,ディナー売上,売上
B0001,6,フード仕入,原価
B0002,7,ドリンク仕入,原価
...
```

#### インポート仕様
- 文字コード: UTF-8（BOMあり/なし両対応）
- ヘッダー行: 必須（1行目はスキップ）
- 空行: スキップ
- 重複コード: 後の定義で上書き

### 2.5 未使用マッピング検出

インポートされたCSVに存在しないマッピング定義を検出：

```javascript
// 検出ロジック
function detectUnusedMappings() {
    var csvCodes = new Set();
    // CSVデータからコードを収集
    rawCSVData.forEach(row => {
        if (row[0]) csvCodes.add(row[0].trim());
    });

    // マッピング定義から未使用を特定
    unusedMappings = [];
    Object.keys(CUSTOMER_CODE_MAP).forEach(code => {
        if (!csvCodes.has(code)) {
            unusedMappings.push({
                code: code,
                info: CUSTOMER_CODE_MAP[code]
            });
        }
    });

    return unusedMappings;
}
```

### 2.6 類似項目マッチング

未マッチ項目に対して類似候補を提案：

```javascript
// 類似度計算（簡易版）
function calculateSimilarity(str1, str2) {
    str1 = str1.toLowerCase();
    str2 = str2.toLowerCase();

    // 完全一致
    if (str1 === str2) return 1.0;

    // 部分一致
    if (str1.includes(str2) || str2.includes(str1)) return 0.8;

    // 共通文字数による類似度
    var common = 0;
    for (var char of str1) {
        if (str2.includes(char)) common++;
    }
    return common / Math.max(str1.length, str2.length);
}

// 類似候補検索
function findSimilarItems(unmatchedName) {
    var suggestions = [];
    Object.entries(CUSTOMER_CODE_MAP).forEach(([code, info]) => {
        var similarity = calculateSimilarity(unmatchedName, info.name);
        if (similarity > 0.5) {
            suggestions.push({
                code: code,
                v15No: info.v15No,
                name: info.name,
                category: info.category,
                similarity: similarity
            });
        }
    });
    return suggestions.sort((a, b) => b.similarity - a.similarity).slice(0, 3);
}
```

---

## 3. 項目マッピング詳細

### 3.1 売上関連（v15: 2-5）

| v15番号 | 項目名 | 顧客コード例 | カテゴリ |
|---------|--------|--------------|----------|
| 2 | ランチ売上 | A0051 | 売上 |
| 3 | ディナー売上 | A0052 | 売上 |
| 4 | その他売上 | A0090 | 売上 |
| 5 | 売上高合計 | A0001 | 売上 |

**注意**: 売上高合計（5）= ランチ売上（2）+ ディナー売上（3）+ その他売上（4）

---

### 3.2 原価関連（v15: 6-7）

| v15番号 | 項目名 | 顧客コード例 | カテゴリ |
|---------|--------|--------------|----------|
| 6 | フード仕入 | B0001 | 原価 |
| 7 | ドリンク仕入 | B0002 | 原価 |

**FD仕入費合計** = フード仕入（6）+ ドリンク仕入（7）

---

### 3.3 固定人件費関連（v15: 10, 14-18）

| v15番号 | 項目名 | 顧客コード例 | カテゴリ |
|---------|--------|--------------|----------|
| 10 | 給料 | C0010 | 固定人件費 |
| 14 | 法定福利 | C0020 | 固定人件費 |
| 15 | 通勤費 | C0030 | 固定人件費 |
| 16 | 賞与 | C0040 | 固定人件費 |
| 17 | 社宅 | C0050 | 固定人件費 |
| 18 | 休業手当 | C0060 | 固定人件費 |

**固定人件費合計** = 給料（10）+ 法定福利（14）+ 通勤費（15）+ 賞与（16）+ 社宅（17）+ 休業手当（18）

---

### 3.4 PA人件費関連（v15: 13, 19）

| v15番号 | 項目名 | 顧客コード例 | カテゴリ |
|---------|--------|--------------|----------|
| 13 | PA人件費 | C0001 | PA人件費 |
| 19 | ヘルプ人件費 | C0002 | PA人件費 |

**PA人件費合計** = PA人件費（13）+ ヘルプ人件費（19）

---

### 3.5 経費関連（v15: 21-45）

| v15番号 | 項目名 | 顧客コード例 |
|---------|--------|--------------|
| 21 | 販売促進費 | D0001 |
| 22 | メニューコピー | D0002 |
| 23 | 調査費 | D0003 |
| 24 | 衛生費 | D0004 |
| 25 | サービス費 | D0005 |
| 26 | 電気代 | D0010 |
| 27 | ガス代 | D0011 |
| 28 | 水道代 | D0012 |
| 29 | 消耗品費 | D0020 |
| 30 | 保守修繕費 | D0021 |
| 31 | 租税公課 | D0030 |
| 32 | 接待交際費 | D0031 |
| 33 | 旅費交通費 | D0032 |
| 34 | 通信費 | D0033 |
| 35 | クレジット手数料 | D0040 |
| 36 | 支払手数料 | D0041 |
| 37 | 会議費 | D0050 |
| 38 | 諸会費 | D0051 |
| 39 | 図書教育費 | D0060 |
| 40 | 研修費 | D0061 |
| 41 | 業態研究費 | D0062 |
| 42 | 採用費 | D0063 |
| 43 | IT費 | D0070 |
| 44 | 外注費 | D0071 |
| 45 | 雑費 | D0080 |

---

### 3.6 固定費関連（v15: 46-50）

| v15番号 | 項目名 | 顧客コード例 |
|---------|--------|--------------|
| 46 | 減価償却費 | E0001 |
| 47 | 家賃 | E0010 |
| 48 | 賃借料 | E0011 |
| 49 | 警備料 | E0020 |
| 50 | リース料 | E0021 |

**地代家賃合計** = 家賃（47）+ 賃借料（48）
**資材費合計** = 警備料（49）+ リース料（50）

---

### 3.7 利益関連（v15: 60）

| v15番号 | 項目名 | 顧客コード例 |
|---------|--------|--------------|
| 60 | 店舗営業利益 | Z0001 |

---

## 4. ラクミー出力マッピング

### 4.1 費用予算設定（固定費用）→ ラクミー項目

| ラクミー項目 | データソース | 変換タイプ |
|--------------|--------------|------------|
| 地代家賃 | v15:47 + v15:48 | 合計 |
| 固定人件費 | v15:10+14+15+16+17+18 | 合計 |
| 減価償却費 | v15:46 | 直接 |
| 資材費 | v15:49 + v15:50 | 合計 |
| 販売促進費 | v15:21 | 直接 |
| メニューコピー | v15:22 | 直接 |
| 調査費 | v15:23 | 直接 |
| 衛生費 | v15:24 | 直接 |
| サービス費 | v15:25 | 直接 |
| 電気代 | v15:26 | 直接 |
| ガス代 | v15:27 | 直接 |
| 水道代 | v15:28 | 直接 |
| 消耗品費 | v15:29 | 直接 |
| 保守修繕費 | v15:30 | 直接 |
| 租税公課 | v15:31 | 直接 |
| 接待交際費 | v15:32 | 直接 |
| 旅費交通費 | v15:33 | 直接 |
| 通信費 | v15:34 | 直接 |
| クレジット手数料 | v15:35 | 直接 |
| 支払手数料 | v15:36 | 直接 |
| 会議費 | v15:37 | 直接 |
| 諸会費 | v15:38 | 直接 |
| 図書教育費 | v15:39 | 直接 |
| 研修費 | v15:40 | 直接 |
| 業態研究費 | v15:41 | 直接 |
| 採用費 | v15:42 | 直接 |
| IT費 | v15:43 | 直接 |
| 外注費 | v15:44 | 直接 |
| 雑費 | v15:45 | 直接 |

---

### 4.2 予算設定（変動費用）→ ラクミー項目

| ラクミー項目 | 計算式 | 変換タイプ |
|--------------|--------|------------|
| FD仕入費率 | (v15:6 + v15:7) / v15:5 × 100 | 率 |
| PA人件費率 | (v15:13 + v15:19) / v15:5 × 100 | 率 |
| 目標客単価 | v15:5 × 1000 / 客数 | 逆算 |
| 目標客数 | 自動計算 | 出力 |
| ランチ売上比率 | v15:2 / v15:5 × 100 | 率 |
| ディナー売上比率 | v15:3 / v15:5 × 100 | 率 |
| フード売上比率 | 推定（デフォルト70%） | 率 |
| ドリンク売上比率 | 推定（デフォルト30%） | 率 |
| その他売上比率 | v15:4 / v15:5 × 100 | 率 |

### 4.3 ラクミー入力値CSVセクション構成

#### セクション定義
| セクション | category | 内容 | 表示条件 |
|-----------|----------|------|----------|
| 費用予算設定 | cost | 固定費用（29項目） | 常に表示 |
| 単月費用予算 | monthly | 月別差異のある固定費用（28項目） | 月別差異がある場合のみ |
| 予算設定 | budget | 変動費用（9項目） | 常に表示 |

#### 月別差異判定ロジック
```javascript
function hasMonthlyVariation(key) {
    if (stActiveMonths.length < 2) return false;
    var firstVal = stRakumyInputs[0] ? (stRakumyInputs[0][key] || 0) : 0;
    for (var m = 1; m < stActiveMonths.length; m++) {
        if (Math.abs((stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0) - firstVal) > 0.01) return true;
    }
    return false;
}
```

#### 表示ルール
| 判定 | 費用予算設定 | 単月費用予算 |
|------|-------------|-------------|
| 全月同一 | 実際の値を表示 | 非表示（項目自体を出力しない） |
| 月別差異 | 「単月設定」を表示 | 実際の月別値を表示 |

---

## 5. MQ出力計算マッピング

### 5.1 入力パラメータ

| パラメータ | ソース |
|-----------|--------|
| 客数 | 目標客数（逆算） |
| 客単価 | 目標客単価 |
| FD仕入費率 | 計算値 |
| PA人件費率 | 計算値 |
| 固定費 | 費用予算設定合計 |

### 5.2 出力項目計算

```
売上 = 客数 × 客単価 / 1000 (千円)
変動費 = 売上 × (FD仕入費率 + PA人件費率) / 100
変動費率 = FD仕入費率 + PA人件費率
粗利 = 売上 - 変動費
粗利率 = 粗利 / 売上 × 100
固定費 = Σ(費用予算設定全項目)
営業利益 = 粗利 - 固定費
営業利益率 = 営業利益 / 売上 × 100
```

### 5.3 MQ出力CSV項目（14項目）

| 項目 | キー | 計算式 | 単位 |
|------|------|--------|------|
| 客数 | customers | 目標客数 | 人 |
| 客単価 | unitPrice | 目標客単価 | 円 |
| 売上 | sales | 客数×客単価/1000 | 千円 |
| 変動費 | variableCost | 売上×変動費率/100 | 千円 |
| 変動費率 | variableRate | FD仕入費率+PA人件費率 | % |
| 粗利 | grossProfit | 売上-変動費 | 千円 |
| 粗利率 | grossProfitRate | 粗利÷売上×100 | % |
| 固定費 | fixedCost | Σ(費用予算設定全項目) | 千円 |
| 営業利益 | operatingProfit | 粗利-固定費 | 千円 |
| 営業利益率 | operatingProfitRate | 営業利益÷売上×100 | % |
| 顧客予算売上 | - | annualData[5] | 千円 |
| 売上差異（MQ-予算） | - | MQ売上-顧客予算売上 | 千円 |
| 顧客予算営業利益 | - | annualData[60] | 千円 |
| 営業利益差異（MQ-予算） | - | MQ営業利益-顧客予算営業利益 | 千円 |

### 5.4 差異表示フォーマット

- 正の差異: `+xxx`（プラス記号付き）
- 負の差異: `-xxx`
- 平均列: `-`（差異項目は平均なし）

---

## 6. 費用設定判定マッピング

### 6.1 判定対象項目

```javascript
[10, 15, 16, 17, 18, 19, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46,
 47, 48, 49, 50]
```

### 6.2 判定ロジック

```javascript
function judgeSettings() {
  対象項目.forEach(itemNo => {
    values = 全月の値を取得;
    allSame = 全値が同一か判定（誤差0.01以内）;
    judgments[itemNo] = { isAnnual: allSame };
  });
}
```

### 6.3 表示振り分け

| 判定 | 費用予算設定 | 単月費用予算 |
|------|-------------|-------------|
| 全月同一 | 年間デフォルト値表示 | 非表示 |
| 月別差異 | 「-」表示 | 月別値表示 |

---

## 7. データフロー図

```
┌──────────────────────────────────────────────────────────────┐
│                    顧客予算CSV                               │
│  (勘定科目コード, 勘定科目名, 月別予算値...)                    │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                  CUSTOMER_CODE_MAP                           │
│  顧客コード → v15番号 マッピング                               │
│  ※ 編集モードで動的に変更可能                                 │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    annualData                                │
│  { v15番号: [月1, 月2, ..., 月12] }                           │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    CALC_RULES                                │
│  演算ルール（合計、率計算など）                                │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    calcResults                               │
│  { 月index: { ルール名: 計算値 } }                            │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   RAKUMY_ITEMS                               │
│  ラクミー項目定義（ソース、変換タイプ）                         │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   rakumyInputs                               │
│  { 月index: { key: 値 } }                                    │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                   MQシミュレーション                          │
│  売上=客数×客単価, 営業利益=粗利-固定費                        │
└─────────────────────────┬────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────────┐
│                    mqOutputs                                 │
│  { 月index: { sales, variableCost, grossProfit, ... } }      │
└──────────────────────────────────────────────────────────────┘
```

---

## 8. 設定ファイルフォーマット

### 8.1 JSON構造

```json
{
  "version": "5.8",
  "mapping": {
    "A0001": { "v15No": 5, "name": "売上高合計", "category": "売上" },
    "B0001": { "v15No": 6, "name": "フード仕入", "category": "原価" }
  },
  "calcRules": {
    "売上合計": { "type": "sum", "items": [5] },
    "FD仕入費率": { "type": "rate", "numerator": "FD仕入費合計", "denominator": "item:5" }
  },
  "rakumyItems": {
    "rent": { "name": "地代家賃", "source": "calc:地代家賃合計", "type": "sum", "category": "cost" }
  },
  "items": {
    "5": { "name": "売上高合計", "category": "売上" }
  },
  "allStoresData": {
    "店舗A": { "annualData": {...}, "calcResults": {...}, ... }
  }
}
```

---

## 9. 新規項目追加ワークフロー

### 9.1 その他変動費に新項目が追加された場合

1. **CSVインポート**
   - 新項目は未マッチ項目として検出される

2. **類似候補確認**
   - 類似候補セクションに候補が表示される
   - 適用ボタンで即座にマッピング追加

3. **手動追加**
   - 類似候補がない場合、「+追加」ボタンから手動追加
   - 顧客コード、v15番号、項目名、カテゴリを入力

4. **マッピング保存**
   - 追加したマッピングはCUSTOMER_CODE_MAPに反映
   - 次回インポート時から自動マッチ

### 9.2 既存項目が削除された場合

1. **未使用検出実行**
   - 「未使用検出」ボタンをクリック
   - CSVに存在しないマッピングを一覧表示

2. **個別削除または一括削除**
   - 個別: 各項目の「×」ボタン
   - 一括: 「未使用を一括削除」ボタン

### 9.3 マッピングのバックアップ

1. **CSV出力**
   - 「マッピングCSV出力」で現在の定義を保存
   - ファイル名: `マッピング定義_YYYY-MM-DD.csv`

2. **CSV読込**
   - 保存したCSVからマッピング定義を復元
   - 既存定義は上書きされる
