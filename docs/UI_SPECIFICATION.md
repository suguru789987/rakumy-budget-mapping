# 予算シミュレーター v17マッピング対応版 UI仕様書

## 1. 画面構成

### 1.1 全体レイアウト（3タブ構造）

```
┌─────────────────────────────────────────────────────────────┐
│                       ヘッダー                               │
│  予算シミュレーター v17マッピング対応版                        │
├─────────────────────────────────────────────────────────────┤
│  メインタブナビゲーション                                     │
│  [インポート] [予算設定] [エクスポート]                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    タブコンテンツ                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 メインタブ構成

| タブ | 内容 |
|------|------|
| インポート | CSVファイル取込、マッピング設定 |
| 予算設定 | 予算入力・演算・ラクミー入力値・MQ出力・予算一覧・サマリー |
| エクスポート | 出力データ履歴一覧、CSVダウンロード |

---

## 2. ヘッダー

### 2.1 スタイル
```css
.header {
  background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
  color: white;
  padding: 15px 20px;
}
```

### 2.2 要素
- タイトル: 「予算シミュレーター v17マッピング対応版」
- サブタイトル: 「科目コード対応・MQ計算強化」

---

## 3. メインタブナビゲーション

### 3.1 タブ構成

| タブ | 内容 | アイコン |
|------|------|----------|
| インポート | CSV取込・マッピング設定 | 📥 |
| 予算設定 | 予算データ確認・編集 | 📊 |
| エクスポート | 出力データ履歴・ダウンロード | 📤 |

### 3.2 スタイル
```css
.main-tabs {
  display: flex;
  gap: 0;
  margin-bottom: 20px;
}
.main-tab {
  padding: 12px 30px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  background: #e0e0e0;
}
.main-tab.active {
  background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
  color: white;
}
```

---

## 4. インポートタブ

### 4.1 構成

```
┌─────────────────────────────────────────────────────────────┐
│ CSVインポートセクション                                       │
│  [ファイル選択] [インポート実行] [シミュレーション実行]         │
│  設定: [設定JSON] [設定読込] [全店舗クリア]                   │
├─────────────────────────────────────────────────────────────┤
│                   店舗セレクター                             │
├─────────────────────────────────────────────────────────────┤
│                     情報バー                                │
│  店舗名 │ 会計年度 │ 検出月数 │ マッチ項目 │ 未マッチ項目     │
├─────────────────────────────────────────────────────────────┤
│                 マッピング設定セクション                      │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ マッピング管理ツールバー                              │  │
│  │ [編集モード] [CSV読込] [CSV出力] [未使用検出]         │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │ 未使用マッピングセクション                            │  │
│  │ 類似候補セクション                                   │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │ 取り込みデータ表示（0値行非表示）                      │  │
│  │ 未マッチ項目セクション                                │  │
│  │ マッピング一覧テーブル                                │  │
│  │ 処理ログ                                            │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 取り込みデータ表示

#### 0値行の非表示
合計が0の行は自動的に非表示にする：

```javascript
// 合計を先に計算（0値の行を非表示にするため）
var total = 0;
for (var m = 0; m < activeMonths.length; m++) {
    var val = item.rowData ? (item.rowData[m] || 0) : 0;
    total += val;
}
// 合計が0の行はスキップ（非表示）
if (total === 0) return;
```

### 4.3 マッピング管理ツールバー

```html
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:8px;">
    <button class="btn btn-primary" onclick="toggleEditMode()">
        <span id="editModeLabel">✏️ 編集モード</span>
    </button>
    <label class="btn btn-info" style="cursor:pointer;margin:0;">
        📥 マッピングCSV読込
        <input type="file" accept=".csv" onchange="importMappingCSV(event)" style="display:none;">
    </label>
    <button class="btn btn-secondary" onclick="exportMappingCSV()">📤 マッピングCSV出力</button>
    <button class="btn btn-warning" onclick="detectUnusedMappings()">🔍 未使用検出</button>
</div>
```

---

## 5. 予算設定タブ

### 5.1 サブタブ構成

```
┌─────────────────────────────────────────────────────────────┐
│  サブタブナビゲーション                                       │
│  [1.予算入力][2.入力前演算][3.ラクミー入力値]                   │
│  [4.MQ出力][5.予算一覧][6.サマリー]                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                   サブタブコンテンツ                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 サブタブ一覧

| タブ | ID | テキスト | ヘッダー色 |
|------|-----|---------|-----------|
| 予算入力 | tab-input | 【1】予算入力 | オレンジグラデーション |
| 入力前演算 | tab-calc | 【2】入力前演算 | シアングラデーション |
| ラクミー入力値 | tab-rakumy | 【3】ラクミー入力値 | グリーングラデーション |
| MQ出力 | tab-output | 【4】MQ出力 | インディゴグラデーション |
| 予算一覧 | tab-budget-list | 【5】予算一覧 | パープルグラデーション |
| サマリー | tab-summary | 【6】サマリー | バイオレットグラデーション |

### 5.3 予算入力タブ（【1】）

#### 表示グルーピング（v17対応版）

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   [2] 店舗売上高                           │
│   [3] ドリンク売上                         │
│   [4] その他売上高                         │
│   [5] 売上高合計 ← ハイライト              │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   [6] 食材仕入高                           │
│   [7] ドリンク仕入高                        │
│   [13] 雑給（PA人件費）                     │
│   [19] ヘルプ人件費                         │
│   [変動費合計] ← ハイライト                 │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   [10] 給料手当                            │
│   [14] 法定福利費                          │
│   ...                                      │
│   [固定人件費合計] ← ハイライト             │
├────────────────────────────────────────────┤
│ 固定費（その他経費 + 従来の固定費）           │
│   [27] 販売促進費                          │
│   [28] メニューコピー                       │
│   ...                                      │
│   [51] 雑費                                │
│   [52] その他経費小計 ← ハイライト          │
│   [53] ロイヤリティ ← 顧客独自項目          │
│   [54] 店舗補填 ← 顧客独自項目              │
│   [55] 減価償却費                          │
│   [56] 家賃                                │
│   ...                                      │
│   [60] 固定費合計 ← ハイライト              │
├────────────────────────────────────────────┤
│ 損益                                       │
│   [営業利益]                               │
└────────────────────────────────────────────┘
```

### 5.4 ラクミー入力値タブ（【3】）

#### ラクミー予算項目の表示構造（全項目表示）

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   売上（税抜）                              │
│   ランチ売上                                │
│   ディナー売上                              │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   FD仕入費                                 │
│   PA人件費                                 │
│   変動費合計 ← ハイライト                   │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   給料手当                                  │
│   法定福利費                                │
│   通勤費                                   │
│   賞与                                     │
│   社宅                                     │
│   休業手当                                  │
│   固定人件費合計 ← ハイライト               │
├────────────────────────────────────────────┤
│ 固定費                                     │
│   販売促進費                                │
│   メニューコピー                            │
│   ...（全項目表示）                         │
│   ロイヤリティ ← 顧客独自項目               │
│   店舗補填 ← 顧客独自項目                   │
│   減価償却費                                │
│   家賃                                     │
│   賃借料                                   │
│   警備料                                   │
│   リース料                                  │
│   固定費合計 ← ハイライト                   │
├────────────────────────────────────────────┤
│ 損益                                       │
│   粗利                                     │
│   営業利益                                  │
└────────────────────────────────────────────┘
```

### 5.5 MQ出力タブ（【4】）

#### 重要事項

ロイヤリティ（No.53）と店舗補填（No.54）はMQ固定費計算に含まない：
- これらはv17マッピング表に存在しない顧客独自項目
- 含めると営業利益がマイナスになる可能性あり
- 表示のみで、計算からは除外

#### 固定費合計の計算式

```javascript
固定費合計 = 固定人件費合計 + 地代家賃合計 + 資材費合計 + 減価償却費 + その他経費
// ※ロイヤリティ・店舗補填は含まない
```

---

## 6. エクスポートタブ

### 6.1 構成

```
┌─────────────────────────────────────────────────────────────┐
│                 出力データ履歴一覧                            │
├─────────────────────────────────────────────────────────────┤
│ ヘッダー: 出力データ履歴一覧（N件）    [全履歴クリア]          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📊 ラクミー入力値CSV（N件）                                 │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
│  📋 予算一覧CSV（N件）                                       │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
│  📈 MQ出力CSV（N件）                                         │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
│  ⚙️ 設定JSON（N件）                                          │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 カテゴリ別グループ表示

| カテゴリ | ラベル | メインカラー | 背景色 |
|----------|--------|--------------|--------|
| ラクミー入力値CSV | 📊 ラクミー入力値CSV | #4caf50（緑） | #e8f5e9 |
| 予算一覧CSV | 📋 予算一覧CSV | #2196f3（青） | #e3f2fd |
| MQ出力CSV | 📈 MQ出力CSV | #9c27b0（紫） | #f3e5f5 |
| 設定JSON | ⚙️ 設定JSON | #607d8b（グレー） | #eceff1 |

---

## 7. 店舗セレクター

### 7.1 表示条件
- 複数店舗がある場合のみ表示

### 7.2 要素
```html
<div class="store-selector">
  <span>店舗選択 (N店舗):</span>
  <div class="store-chips">
    <span class="store-chip active" onclick="switchStore('店舗名')">店舗名</span>
    ...
  </div>
</div>
```

### 7.3 店舗チップスタイル
```css
.store-chip {
  padding: 4px 12px;
  border-radius: 15px;
  background: #e0e0e0;
  cursor: pointer;
  font-size: 11px;
}
.store-chip.active {
  background: #1565c0;
  color: white;
}
```

---

## 8. CSVエクスポート仕様

### 8.1 全店舗エクスポート

「全店舗を選択」時は1つのCSVに全店舗データを縦に連結。

### 8.2 ファイル名規則

| 条件 | ファイル名 |
|------|-----------|
| 単一店舗 | `{種別}_{店舗名}_{YYYY-MM-DD}.csv` |
| 全店舗 | `{種別}_全店舗_{YYYY-MM-DD}.csv` |

### 8.3 出力形式

- 文字コード: UTF-8 with BOM（Excel対応）
- 金額: 千円単位、整数
- 率: 整数%表示

---

## 9. テーブル共通仕様

### 9.1 基本スタイル
```css
.annual-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10px;
}
.annual-table th, .annual-table td {
  border: 1px solid #ddd;
  padding: 6px 8px;
  text-align: right;
}
.annual-table th {
  background: #f5f5f5;
  font-weight: bold;
}
```

### 9.2 合計・平均列
```css
.total-col { background: #fff9c4; font-weight: bold; }
.avg-col { background: #e3f2fd; }
```

### 9.3 ハイライト行
```css
.highlight-row {
  background: #e3f2fd;
  font-weight: bold;
}
```

---

## 10. 数値フォーマット

### 10.1 金額（千円単位）
```javascript
function fmt(val) {
  return Math.round(val).toLocaleString();
}
```

### 10.2 率（%）
```javascript
function fmtRate(val) {
  return val.toFixed(1);
}
```

---

## 11. レスポンシブ対応

### 11.1 テーブルスクロール
- 横スクロール対応 `overflow-x: auto`

### 11.2 グリッドレイアウト
- 画面幅に応じて列数を自動調整
- `grid-template-columns: repeat(auto-fill, minmax(300px, 1fr))`

---

## 12. 変更履歴（v5.8からの変更）

### 12.1 表示グルーピング変更

| 変更前（v5.8） | 変更後（v17対応版） |
|--------------|-------------------|
| その他変動費セクション | 固定費セクションに統合 |
| その他変動費合計（No.52） | その他経費小計に名称変更 |
| ラクミー項目は集計表示 | 全個別項目表示 |

### 12.2 新機能

| 機能 | 説明 |
|------|------|
| 0値行非表示 | インポートデータ表示で合計0の行を非表示 |
| ロイヤリティ・店舗補填 | 顧客独自項目として表示（MQ計算除外） |
| 科目コードマッピング | CODE_BASED_MAPによる優先マッチ |

---

## 13. 予算試算タブ（What-If分析）

### 13.1 概要

顧客予算値を編集して、ラクミー予算への影響をリアルタイムで確認できる機能。

### 13.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ 🧮 予算試算（What-If分析）                                   │
│ 顧客予算値を編集して、ラクミー予算への影響をリアルタイムで確認   │
├─────────────────────────────────────────────────────────────┤
│ 店舗選択エリア                                               │
│  試算対象店舗: [プルダウン] [🔄元に戻す] [✅試算値を本データに反映] │
├─────────────────────────────────────────────────────────────┤
│ 試算履歴ボタンエリア（右寄せ）                                │
│                    [📚試算履歴 N] [💾現在の試算を保存]        │
├─────────────────────────────────────────────────────────────┤
│ 試算履歴セクション（展開時のみ表示）                          │
│  📚 試算履歴                              [履歴を閉じる]     │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 履歴1: 名前 (店舗名) 日時        [表示] [削除]      │    │
│  │ 履歴2: 名前 (店舗名) 日時        [表示] [削除]      │    │
│  └────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│ 📊 MQ試算結果（顧客予算 vs MQ予算）        [判定バッジ]       │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 対比表（月別比較）                                   │    │
│  │  項目 │ 4月 │ 5月 │ ... │ 合計 │ 平均              │    │
│  │  売上高合計（顧客予算）                              │    │
│  │  売上高合計（MQ予算）                               │    │
│  │  差異                                             │    │
│  │  営業利益（顧客予算）                               │    │
│  │  営業利益（MQ予算）                                │    │
│  │  差異                                             │    │
│  └────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│ 顧客予算 ⇔ MQ予算 LIVE連動                                  │
│ ┌──────────────────────┬──────────────────────┐           │
│ │ STEP1: 顧客予算編集    │ STEP2: 連動ラクミー予算│           │
│ │ (明細項目を編集可能)   │ (自動計算・表示のみ)  │           │
│ └──────────────────────┴──────────────────────┘           │
├─────────────────────────────────────────────────────────────┤
│ MQ試算エリア                                                │
│  MQパラメータ: 客単価 [    ]円   変動費率: XX%              │
│  [🔧 客単価を変更してMQ再計算]                               │
└─────────────────────────────────────────────────────────────┘
```

### 13.3 店舗選択エリア

| 要素 | 機能 |
|------|------|
| 試算対象店舗 | プルダウンで店舗選択、選択時にデータ読込 |
| 🔄 元に戻す | 編集内容を破棄して元データに戻す |
| ✅ 試算値を本データに反映 | 試算結果を予算設定タブに反映 |

### 13.4 試算履歴機能

#### 保存仕様
- localStorage使用（キー: `budgetSimulationHistory`）
- 最大保存件数: 10件（超過時は古い順に削除）
- 保存項目: 名前、メモ、店舗名、日時、annualData、rakumyInputs、mqOutputs

#### 履歴カード表示
```html
<div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
        <strong>保存名</strong>
        <span>(店舗名)</span>
        <span>YYYY/MM/DD HH:mm</span>
        <span>メモ内容...</span>
    </div>
    <div>
        <button onclick="loadSimulationFromHistory(id)">表示</button>
        <button onclick="deleteSimulationHistory(id)">削除</button>
    </div>
</div>
```

#### 履歴読込処理
1. 店舗未選択時 → 履歴の店舗を自動選択
2. 店舗不一致時 → 確認ダイアログで切替or継続選択
3. simulationData初期化（未定義の場合）
4. データ復元（annualData、rakumyInputs、mqOutputs）
5. MQ再計算（mqOutputsがない場合）
6. 画面再描画

### 13.5 顧客予算編集（STEP1）

#### 編集可能な明細項目

| セクション | 項目 | MQ影響 |
|-----------|------|--------|
| 売上 | 店舗売上高、ドリンク売上、その他売上高 | 売上高 |
| 売上 | **売上高合計**（表示のみ） | - |
| 原価 | 食材仕入高、ドリンク仕入高 | FD率 |
| 原価 | **原価合計**（表示のみ） | - |
| 人件費 | 雑給（PA人件費）、ヘルプ人件費 | PA人件費 |
| 人件費 | 給料手当、法定福利費、通勤費、賞与、社宅、休業手当 | 固定人件費 |
| 人件費 | **固定人件費合計**（表示のみ） | - |
| 固定費 | 販売促進費、メニューコピー、広告宣伝費、備消品 等 | 固定費 |
| 固定費 | **固定費合計**（表示のみ） | - |
| 目標 | 営業利益（目標） | 目標G |

※ 太字の合計行は編集不可（グレーアウト表示）

### 13.6 連動ラクミー予算（STEP2）

顧客予算の編集に連動して自動計算・表示される項目:

| ラクミー項目 | 算出元 |
|------------|--------|
| 売上（税抜） | 売上高合計 |
| FD仕入費 | 食材仕入高 + ドリンク仕入高 |
| PA人件費 | 雑給 + ヘルプ人件費 |
| 固定人件費合計 | 給料手当 + 法定福利費 + ... |
| 固定費合計 | 固定費項目の合計 |
| 変動費合計 | FD仕入費 + PA人件費 |
| 粗利 | 売上 - FD仕入費 |
| 営業利益 | 売上 - 変動費 - 固定人件費 - 固定費 |

### 13.7 MQ試算

#### MQパラメータ
- **客単価（P）**: 手動入力可能（デフォルト: 顧客予算平均値）
- **変動費率（VR）**: 自動計算（変動費合計 / 売上高合計）

#### MQ逆算式
```
Q = (F + G) / M
M = P × (1 - VR)

Q: 必要客数
F: 固定費合計（固定人件費 + その他固定費）
G: 目標営業利益
M: 1客あたり限界利益
P: 客単価
VR: 変動費率
```

### 13.8 スタイル仕様

| 要素 | スタイル |
|------|---------|
| STEP1パネル | 背景: #fff3e0, ボーダー: #ff9800 |
| STEP2パネル | 背景: #e8f5e9, ボーダー: #4caf50 |
| LIVEインジケータ | 背景: #ffeb3b, アニメーション: pulse |
| 編集可能セル | 背景: #fffde7 |
| 表示のみセル | 背景: #f5f5f5, 色: #999 |
| 試算履歴ボタン | 背景: #5c6bc0（紫系） |
| 保存ボタン | 背景: #7b1fa2（ディープパープル） |
