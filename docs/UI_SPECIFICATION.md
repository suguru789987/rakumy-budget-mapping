# 予算シミュレーター v17マッピング対応版 UI仕様書

## 1. 画面構成

### 1.1 全体レイアウト（3タブ構造）

```
┌─────────────────────────────────────────────────────────────┐
│                       ヘッダー                               │
│  予算シミュレーター v17マッピング対応版                        │
├─────────────────────────────────────────────────────────────┤
│  メインタブナビゲーション                                     │
│  [インポート] [予算設定] [エクスポート]                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    タブコンテンツ                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 メインタブ構成

| タブ | 内容 |
|------|------|
| インポート | CSVファイル取込、マッピング設定 |
| 予算設定 | 予算入力・演算・ラクミー入力値・MQ出力・予算一覧・サマリー |
| エクスポート | 出力データ履歴一覧、CSVダウンロード |

---

## 2. ヘッダー

### 2.1 スタイル
```css
.header {
  background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
  color: white;
  padding: 15px 20px;
}
```

### 2.2 要素
- タイトル: 「予算シミュレーター v17マッピング対応版」
- サブタイトル: 「科目コード対応・MQ計算強化」

---

## 3. メインタブナビゲーション

### 3.1 タブ構成

| タブ | 内容 | アイコン |
|------|------|----------|
| インポート | CSV取込・マッピング設定 | 📥 |
| 予算設定 | 予算データ確認・編集 | 📊 |
| エクスポート | 出力データ履歴・ダウンロード | 📤 |

### 3.2 スタイル
```css
.main-tabs {
  display: flex;
  gap: 0;
  margin-bottom: 20px;
}
.main-tab {
  padding: 12px 30px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  background: #e0e0e0;
}
.main-tab.active {
  background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
  color: white;
}
```

---

## 4. インポートタブ

### 4.1 構成

```
┌─────────────────────────────────────────────────────────────┐
│ CSVインポートセクション                                       │
│  [ファイル選択] [インポート実行] [シミュレーション実行]         │
│  設定: [設定JSON] [設定読込] [全店舗クリア]                   │
├─────────────────────────────────────────────────────────────┤
│                   店舗セレクター                             │
├─────────────────────────────────────────────────────────────┤
│                     情報バー                                │
│  店舗名 │ 会計年度 │ 検出月数 │ マッチ項目 │ 未マッチ項目     │
├─────────────────────────────────────────────────────────────┤
│                 マッピング設定セクション                      │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ マッピング管理ツールバー                              │  │
│  │ [編集モード] [CSV読込] [CSV出力] [未使用検出]         │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │ 未使用マッピングセクション                            │  │
│  │ 類似候補セクション                                   │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │ 取り込みデータ表示（0値行非表示）                      │  │
│  │ 未マッチ項目セクション                                │  │
│  │ マッピング一覧テーブル                                │  │
│  │ 処理ログ                                            │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 取り込みデータ表示

#### 0値行の非表示
合計が0の行は自動的に非表示にする：

```javascript
// 合計を先に計算（0値の行を非表示にするため）
var total = 0;
for (var m = 0; m < activeMonths.length; m++) {
    var val = item.rowData ? (item.rowData[m] || 0) : 0;
    total += val;
}
// 合計が0の行はスキップ（非表示）
if (total === 0) return;
```

### 4.3 マッピング管理ツールバー

```html
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:8px;">
    <button class="btn btn-primary" onclick="toggleEditMode()">
        <span id="editModeLabel">✏️ 編集モード</span>
    </button>
    <label class="btn btn-info" style="cursor:pointer;margin:0;">
        📥 マッピングCSV読込
        <input type="file" accept=".csv" onchange="importMappingCSV(event)" style="display:none;">
    </label>
    <button class="btn btn-secondary" onclick="exportMappingCSV()">📤 マッピングCSV出力</button>
    <button class="btn btn-warning" onclick="detectUnusedMappings()">🔍 未使用検出</button>
</div>
```

---

## 5. 予算設定タブ

### 5.1 サブタブ構成

```
┌─────────────────────────────────────────────────────────────┐
│  サブタブナビゲーション                                       │
│  [1.予算入力][2.入力前演算][3.ラクミー入力値]                   │
│  [4.MQ出力][5.予算一覧][6.サマリー]                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                   サブタブコンテンツ                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 サブタブ一覧

| タブ | ID | テキスト | ヘッダー色 |
|------|-----|---------|-----------|
| 予算入力 | tab-input | 【1】予算入力 | オレンジグラデーション |
| 入力前演算 | tab-calc | 【2】入力前演算 | シアングラデーション |
| ラクミー入力値 | tab-rakumy | 【3】ラクミー入力値 | グリーングラデーション |
| MQ出力 | tab-output | 【4】MQ出力 | インディゴグラデーション |
| 予算一覧 | tab-budget-list | 【5】予算一覧 | パープルグラデーション |
| サマリー | tab-summary | 【6】サマリー | バイオレットグラデーション |

### 5.3 予算入力タブ（【1】）

#### 表示グルーピング（v17対応版）

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   [2] 店舗売上高                           │
│   [3] ドリンク売上                         │
│   [4] その他売上高                         │
│   [5] 売上高合計 ← ハイライト              │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   [6] 食材仕入高                           │
│   [7] ドリンク仕入高                        │
│   [13] 雑給（PA人件費）                     │
│   [19] ヘルプ人件費                         │
│   [変動費合計] ← ハイライト                 │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   [10] 給料手当                            │
│   [14] 法定福利費                          │
│   ...                                      │
│   [固定人件費合計] ← ハイライト             │
├────────────────────────────────────────────┤
│ 固定費（その他経費 + 従来の固定費）           │
│   [27] 販売促進費                          │
│   [28] メニューコピー                       │
│   ...                                      │
│   [51] 雑費                                │
│   [52] その他経費小計 ← ハイライト          │
│   [53] ロイヤリティ ← 顧客独自項目          │
│   [54] 店舗補填 ← 顧客独自項目              │
│   [55] 減価償却費                          │
│   [56] 家賃                                │
│   ...                                      │
│   [60] 固定費合計 ← ハイライト              │
├────────────────────────────────────────────┤
│ 損益                                       │
│   [営業利益]                               │
└────────────────────────────────────────────┘
```

### 5.4 ラクミー入力値タブ（【3】）

#### ラクミー予算項目の表示構造（全項目表示）

```
┌────────────────────────────────────────────┐
│ 売上予算                                    │
│   売上（税抜）                              │
│   ランチ売上                                │
│   ディナー売上                              │
├────────────────────────────────────────────┤
│ 変動費予算                                  │
│   FD仕入費                                 │
│   PA人件費                                 │
│   変動費合計 ← ハイライト                   │
├────────────────────────────────────────────┤
│ 固定人件費                                  │
│   給料手当                                  │
│   法定福利費                                │
│   通勤費                                   │
│   賞与                                     │
│   社宅                                     │
│   休業手当                                  │
│   固定人件費合計 ← ハイライト               │
├────────────────────────────────────────────┤
│ 固定費                                     │
│   販売促進費                                │
│   メニューコピー                            │
│   ...（全項目表示）                         │
│   ロイヤリティ ← 顧客独自項目               │
│   店舗補填 ← 顧客独自項目                   │
│   減価償却費                                │
│   家賃                                     │
│   賃借料                                   │
│   警備料                                   │
│   リース料                                  │
│   固定費合計 ← ハイライト                   │
├────────────────────────────────────────────┤
│ 損益                                       │
│   粗利                                     │
│   営業利益                                  │
└────────────────────────────────────────────┘
```

### 5.5 MQ出力タブ（【4】）

#### 重要事項

ロイヤリティ（No.53）と店舗補填（No.54）はMQ固定費計算に含まない：
- これらはv17マッピング表に存在しない顧客独自項目
- 含めると営業利益がマイナスになる可能性あり
- 表示のみで、計算からは除外

#### 固定費合計の計算式

```javascript
固定費合計 = 固定人件費合計 + 地代家賃合計 + 資材費合計 + 減価償却費 + その他経費
// ※ロイヤリティ・店舗補填は含まない
```

---

## 6. エクスポートタブ

### 6.1 構成

```
┌─────────────────────────────────────────────────────────────┐
│                 出力データ履歴一覧                            │
├─────────────────────────────────────────────────────────────┤
│ ヘッダー: 出力データ履歴一覧（N件）    [全履歴クリア]          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📊 ラクミー入力値CSV（N件）                                 │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
│  📋 予算一覧CSV（N件）                                       │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
│  📈 MQ出力CSV（N件）                                         │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
│  ⚙️ 設定JSON（N件）                                          │
│  ├─ [履歴カード1] [履歴カード2] ...                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 カテゴリ別グループ表示

| カテゴリ | ラベル | メインカラー | 背景色 |
|----------|--------|--------------|--------|
| ラクミー入力値CSV | 📊 ラクミー入力値CSV | #4caf50（緑） | #e8f5e9 |
| 予算一覧CSV | 📋 予算一覧CSV | #2196f3（青） | #e3f2fd |
| MQ出力CSV | 📈 MQ出力CSV | #9c27b0（紫） | #f3e5f5 |
| 設定JSON | ⚙️ 設定JSON | #607d8b（グレー） | #eceff1 |

---

## 7. 店舗セレクター

### 7.1 表示条件
- 複数店舗がある場合のみ表示

### 7.2 要素
```html
<div class="store-selector">
  <span>店舗選択 (N店舗):</span>
  <div class="store-chips">
    <span class="store-chip active" onclick="switchStore('店舗名')">店舗名</span>
    ...
  </div>
</div>
```

### 7.3 店舗チップスタイル
```css
.store-chip {
  padding: 4px 12px;
  border-radius: 15px;
  background: #e0e0e0;
  cursor: pointer;
  font-size: 11px;
}
.store-chip.active {
  background: #1565c0;
  color: white;
}
```

---

## 8. CSVエクスポート仕様

### 8.1 全店舗エクスポート

「全店舗を選択」時は1つのCSVに全店舗データを縦に連結。

### 8.2 ファイル名規則

| 条件 | ファイル名 |
|------|-----------|
| 単一店舗 | `{種別}_{店舗名}_{YYYY-MM-DD}.csv` |
| 全店舗 | `{種別}_全店舗_{YYYY-MM-DD}.csv` |

### 8.3 出力形式

- 文字コード: UTF-8 with BOM（Excel対応）
- 金額: 千円単位、整数
- 率: 整数%表示

---

## 9. テーブル共通仕様

### 9.1 基本スタイル
```css
.annual-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10px;
}
.annual-table th, .annual-table td {
  border: 1px solid #ddd;
  padding: 6px 8px;
  text-align: right;
}
.annual-table th {
  background: #f5f5f5;
  font-weight: bold;
}
```

### 9.2 合計・平均列
```css
.total-col { background: #fff9c4; font-weight: bold; }
.avg-col { background: #e3f2fd; }
```

### 9.3 ハイライト行
```css
.highlight-row {
  background: #e3f2fd;
  font-weight: bold;
}
```

---

## 10. 数値フォーマット

### 10.1 金額（千円単位）
```javascript
function fmt(val) {
  return Math.round(val).toLocaleString();
}
```

### 10.2 率（%）
```javascript
function fmtRate(val) {
  return val.toFixed(1);
}
```

---

## 11. レスポンシブ対応

### 11.1 テーブルスクロール
- 横スクロール対応 `overflow-x: auto`

### 11.2 グリッドレイアウト
- 画面幅に応じて列数を自動調整
- `grid-template-columns: repeat(auto-fill, minmax(300px, 1fr))`

---

## 12. 変更履歴（v5.8からの変更）

### 12.1 表示グルーピング変更

| 変更前（v5.8） | 変更後（v17対応版） |
|--------------|-------------------|
| その他変動費セクション | 固定費セクションに統合 |
| その他変動費合計（No.52） | その他経費小計に名称変更 |
| ラクミー項目は集計表示 | 全個別項目表示 |

### 12.2 新機能

| 機能 | 説明 |
|------|------|
| 0値行非表示 | インポートデータ表示で合計0の行を非表示 |
| ロイヤリティ・店舗補填 | 顧客独自項目として表示（MQ計算除外） |
| 科目コードマッピング | CODE_BASED_MAPによる優先マッチ |

---

## 13. 予算試算タブ（What-If分析）

### 13.1 概要

顧客予算値を編集して、ラクミー予算への影響をリアルタイムで確認できる機能。

### 13.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ 🧮 予算試算（What-If分析）                                   │
│ 顧客予算値を編集して、ラクミー予算への影響をリアルタイムで確認   │
├─────────────────────────────────────────────────────────────┤
│ 店舗選択エリア                                               │
│  試算対象店舗: [プルダウン] [🔄元に戻す] [✅試算値を本データに反映] │
├─────────────────────────────────────────────────────────────┤
│ 試算履歴ボタンエリア（右寄せ）                                │
│                    [📚試算履歴 N] [💾現在の試算を保存]        │
├─────────────────────────────────────────────────────────────┤
│ 試算履歴セクション（展開時のみ表示）                          │
│  📚 試算履歴                              [履歴を閉じる]     │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 履歴1: 名前 (店舗名) 日時        [表示] [削除]      │    │
│  │ 履歴2: 名前 (店舗名) 日時        [表示] [削除]      │    │
│  └────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│ 📊 MQ試算結果（顧客予算 vs MQ予算）        [判定バッジ]       │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 対比表（月別比較）                                   │    │
│  │  項目 │ 4月 │ 5月 │ ... │ 合計 │ 平均              │    │
│  │  売上高合計（顧客予算）                              │    │
│  │  売上高合計（MQ予算）                               │    │
│  │  差異                                             │    │
│  │  営業利益（顧客予算）                               │    │
│  │  営業利益（MQ予算）                                │    │
│  │  差異                                             │    │
│  └────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│ 顧客予算 ⇔ MQ予算 LIVE連動                                  │
│ ┌──────────────────────┬──────────────────────┐           │
│ │ STEP1: 顧客予算編集    │ STEP2: 連動ラクミー予算│           │
│ │ (明細項目を編集可能)   │ (自動計算・表示のみ)  │           │
│ └──────────────────────┴──────────────────────┘           │
├─────────────────────────────────────────────────────────────┤
│ MQ試算エリア                                                │
│  MQパラメータ: 客単価 [    ]円   変動費率: XX%              │
│  [🔧 客単価を変更してMQ再計算]                               │
└─────────────────────────────────────────────────────────────┘
```

### 13.3 店舗選択エリア

| 要素 | 機能 |
|------|------|
| 試算対象店舗 | プルダウンで店舗選択、選択時にデータ読込 |
| 🔄 元に戻す | 編集内容を破棄して元データに戻す |
| ✅ 試算値を本データに反映 | 試算結果を予算設定タブに反映 |

### 13.4 試算履歴機能

#### 保存仕様
- localStorage使用（キー: `budgetSimulationHistory`）
- 最大保存件数: 10件（超過時は古い順に削除）
- 保存項目: 名前、メモ、店舗名、日時、annualData、rakumyInputs、mqOutputs

#### 履歴カード表示
```html
<div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
        <strong>保存名</strong>
        <span>(店舗名)</span>
        <span>YYYY/MM/DD HH:mm</span>
        <span>メモ内容...</span>
    </div>
    <div>
        <button onclick="loadSimulationFromHistory(id)">表示</button>
        <button onclick="deleteSimulationHistory(id)">削除</button>
    </div>
</div>
```

#### 履歴読込処理
1. 店舗未選択時 → 履歴の店舗を自動選択
2. 店舗不一致時 → 確認ダイアログで切替or継続選択
3. simulationData初期化（未定義の場合）
4. データ復元（annualData、rakumyInputs、mqOutputs）
5. MQ再計算（mqOutputsがない場合）
6. 画面再描画

### 13.5 顧客予算編集（STEP1）

#### 編集可能な明細項目

| セクション | 項目 | MQ影響 |
|-----------|------|--------|
| 売上 | 店舗売上高、ドリンク売上、その他売上高 | 売上高 |
| 売上 | **売上高合計**（表示のみ） | - |
| 原価 | 食材仕入高、ドリンク仕入高 | FD率 |
| 原価 | **原価合計**（表示のみ） | - |
| 人件費 | 雑給（PA人件費）、ヘルプ人件費 | PA人件費 |
| 人件費 | 給料手当、法定福利費、通勤費、賞与、社宅、休業手当 | 固定人件費 |
| 人件費 | **固定人件費合計**（表示のみ） | - |
| 固定費 | 販売促進費、メニューコピー、広告宣伝費、備消品 等 | 固定費 |
| 固定費 | **固定費合計**（表示のみ） | - |
| 目標 | 営業利益（目標） | 目標G |

※ 太字の合計行は編集不可（グレーアウト表示）

### 13.6 連動ラクミー予算（STEP2）

顧客予算の編集に連動して自動計算・表示される項目:

| ラクミー項目 | 算出元 |
|------------|--------|
| 売上（税抜） | 売上高合計 |
| FD仕入費 | 食材仕入高 + ドリンク仕入高 |
| PA人件費 | 雑給 + ヘルプ人件費 |
| 固定人件費合計 | 給料手当 + 法定福利費 + ... |
| 固定費合計 | 固定費項目の合計 |
| 変動費合計 | FD仕入費 + PA人件費 |
| 粗利 | 売上 - FD仕入費 |
| 営業利益 | 売上 - 変動費 - 固定人件費 - 固定費 |

### 13.7 MQ試算

#### MQパラメータ
- **客単価（P）**: 手動入力可能（デフォルト: 顧客予算平均値）
- **変動費率（VR）**: 自動計算（変動費合計 / 売上高合計）

#### MQ逆算式
```
Q = (F + G) / M
M = P × (1 - VR)

Q: 必要客数
F: 固定費合計（固定人件費 + その他固定費）
G: 目標営業利益
M: 1客あたり限界利益
P: 客単価
VR: 変動費率
```

### 13.8 スタイル仕様

| 要素 | スタイル |
|------|---------|
| STEP1パネル | 背景: #fff3e0, ボーダー: #ff9800 |
| STEP2パネル | 背景: #e8f5e9, ボーダー: #4caf50 |
| LIVEインジケータ | 背景: #ffeb3b, アニメーション: pulse |
| 編集可能セル | 背景: #fffde7 |
| 表示のみセル | 背景: #f5f5f5, 色: #999 |
| 試算履歴ボタン | 背景: #5c6bc0（紫系） |
| 保存ボタン | 背景: #7b1fa2（ディープパープル） |

### 13.9 日次・月次表示（店長向け）

サマリー表示は店長が日々確認しやすいよう日次をメインに表示:

```
┌─────────────────┐  ┌─────────────────┐
│  目標客数        │  │  必要売上        │
│   74人/日       │  │  446千円/日     │
│  月 2,232人     │  │  月 11,161千円  │
└─────────────────┘  └─────────────────┘
※営業日数 25日/月 想定
※月平均＝取込期間合計÷Nヶ月　日平均＝月平均÷25日
```

#### 計算式
```javascript
var numMonths = monthIndices.length;      // 取込月数
var OPERATING_DAYS = 25;                  // 営業日数/月
var monthlyValue = totalValue / numMonths;
var dailyValue = monthlyValue / OPERATING_DAYS;
```

### 13.10 画面表示順序

操作フロー（編集 → 再計算 → 結果確認）に沿った順序:

```
1. 試算履歴ボタン・保存ボタン
2. STEP1 顧客予算編集 ↔ STEP2 MQ試算結果（横並び）
3. MQ再計算ボタン
4. MQ試算結果比較表（詳細）
5. 試算サマリー
```

### 13.11 エクスポートへの反映

| タブ | 反映方法 | タイミング |
|------|---------|----------|
| 予算設定タブ | 自動保存 | タブ切替時に`saveCurrentStoreData()`実行 |
| 予算試算タブ | 手動反映 | 「✅ 試算値を本データに反映」ボタン押下 |

#### 試算値反映時の更新データ
- `annualData` - 顧客予算データ
- `rakumyInputs` - ラクミー入力値
- `mqOutputs` - MQ出力値

### 13.12 MQ試算結果比較サマリー（日次・月次表示）

店長・本部向けに日次をメイン表示:

```
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│顧客予算売上 │ │MQ算出売上   │ │売上差異     │ │MQ目標客数   │ │目標営業利益 │
│ 446千円/日 │ │ 447千円/日 │ │ +1千円/日  │ │  89人/日   │ │ 31千円/日  │
│月11,150千円│ │月11,161千円│ │月+11千円   │ │月2,232人   │ │月786千円   │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
※営業日数 25日/月 想定
※月平均＝取込期間合計÷Nヶ月　日平均＝月平均÷25日
```

| 表示項目 | 説明 |
|---------|------|
| 顧客予算売上 | 顧客が設定した予算売上 |
| MQ算出売上 | 目標利益達成に必要な売上（MQ逆算） |
| 売上差異 | MQ算出売上 - 顧客予算売上 |
| MQ目標客数 | 目標達成に必要な客数 |
| 目標営業利益 | 顧客予算の営業利益目標 |

### 13.13 試算サマリー（日次・月次換算）

編集前後の比較を日次・月次で表示:

```
┌─────────────────┐ ┌─────────────────┐
│     売上高       │ │    営業利益      │
│   446千円/日    │ │    31千円/日    │
│  月 11,150千円  │ │   月 786千円    │
│  ▲ 0千円/日    │ │  ▲ 0千円/日    │
└─────────────────┘ └─────────────────┘
※営業日数 25日/月 想定
※月平均＝取込期間合計÷Nヶ月　日平均＝月平均÷25日
```

- ▲: 編集後の増加分（日次・月次）
- ▼: 編集後の減少分（日次・月次）

### 13.14 金額表示（円単位）

#### 概要
ラクミーの表記スタイルに合わせ、全ての金額を円単位（下三桁省略せず）で表示。

#### 内部データと表示の関係
- 内部データ: 千円単位で保存
- 表示: 円単位（内部データ×1000）
- 入力: 円単位で入力、保存時に÷1000で千円単位に変換

#### フォーマット関数
```javascript
// 千円単位を円単位で表示（カンマ区切り）
function fmtYen(n) {
    return n !== undefined && n !== null
        ? Math.round(n * 1000).toLocaleString('ja-JP')
        : '-';
}
```

#### 入力フィールドの処理
```html
<!-- 円単位表示、data-yen属性で識別 -->
<input type="number" data-no="4" data-month="0" data-yen="true"
       value="1234000" onchange="updateSimulationValue(this)">
```

```javascript
function updateSimulationValue(input) {
    var value = parseFloat(input.value) || 0;
    // 円単位入力を千円単位に変換
    if (input.dataset.yen === 'true') {
        value = value / 1000;
    }
    simulationData.annualData[no][month] = value;
}
```

#### 表示例
| 内部データ（千円） | 表示（円） |
|-----------------|----------|
| 1234 | 1,234,000円 |
| 500 | 500,000円/月 |
| 20 | 20,000円/日 |

### 13.15 売上比較セクション（日次・月次表示）

#### 概要
店長や本部社員が直感的に理解できるよう、売上比較を日次・月次・期間計で階層表示。

#### レイアウト
```
┌────────────────────────────────────────────────────────────────────┐
│ ⚠️ 売上不足                                                        │
│ 顧客予算売上 ＜ MQ必要売上 → 売上増または費用削減が必要               │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌─────────────────┐    ┌───────────┐    ┌─────────────────┐      │
│  │ 📊 顧客予算売上  │    │   差異    │    │ 🎯 MQ必要売上   │      │
│  │                 │    │           │    │                 │      │
│  │  445,333円/日   │ vs │ -433円/日 │    │  446,433円/日   │      │
│  │ 月 11,133,333円 │    │月-10,833円│    │ 月 11,161,666円 │      │
│  │期間計133,800,000円│   │           │    │期間計133,930,000円│     │
│  └─────────────────┘    └───────────┘    └─────────────────┘      │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### 表示階層
| 階層 | 説明 | サイズ |
|------|------|--------|
| メイン | 円/日（日次売上） | 24px、太字 |
| サブ | 円/月（月次売上） | 11px |
| 参考 | 円（期間合計） | 9px、グレー |

#### 計算式
```javascript
var OPERATING_DAYS = 25;  // 営業日数
var numMonths = monthIndices.length || 12;

// 月次
var custSalesMonthly = custSales / numMonths;
var mqSalesMonthly = mqSales / numMonths;

// 日次
var custSalesDaily = custSalesMonthly / OPERATING_DAYS;
var mqSalesDaily = mqSalesMonthly / OPERATING_DAYS;

// 差異
var salesDiffMonthly = salesDiff / numMonths;
var salesDiffDaily = salesDiffMonthly / OPERATING_DAYS;
```

#### 差異表示
- 正値（余裕あり）: 緑色（#2e7d32）、+符号付き
- 負値（不足）: 赤色（#c62828）、-符号付き
- 背景: 正値→薄緑（#e8f5e9）、負値→薄赤（#ffebee）

#### カード配色
| 要素 | 色 |
|------|-----|
| 顧客予算売上 | 青系（#1976d2） |
| MQ必要売上 | 紫系（#7b1fa2） |
| 差異（余裕） | 緑系（#2e7d32） |
| 差異（不足） | 赤系（#c62828） |

### 13.16 エクスポートCSV（円単位出力）

#### 概要
CSVエクスポートデータもラクミー表記スタイルに合わせて円単位で出力。

#### 変換ルール
| データ種別 | 内部データ | CSV出力 |
|-----------|----------|---------|
| 売上・費用・利益 | 千円単位 | ×1000で円表示 |
| 客単価（P） | 円単位 | そのまま |
| 率（FD率、PA率等）| % | そのまま |
| 人数（客数） | 人 | そのまま |

#### 対象エクスポート機能
1. **ラクミー入力値CSV** (`exportRakumyInputsCSV`)
   - 費用予算設定: ×1000
   - 単月費用予算: ×1000
   - 予算設定: 金額×1000、率はそのまま

2. **予算一覧CSV** (`exportBudgetListCSV`)
   - 目標客単価: そのまま（isYenAlready=true）
   - その他金額: ×1000

3. **MQ出力CSV** (`exportMQOutputCSV`)
   - 客数: そのまま（isPerson=true）
   - 客単価: そのまま（isYen=true）
   - 売上/変動費/粗利/固定費/営業利益: ×1000（isMoney=true）
   - 各種率: そのまま（isRate=true）

#### 出力例（変換後）
| 項目 | 変換前（千円） | 変換後（円） |
|------|-------------|------------|
| 地代家賃 | 1460 | 1,460,000 |
| 固定人件費 | 2706 | 2,706,000 |
| 電気代 | 738 | 738,000 |

### 13.17 インポートタブ（サブタブ構成）

#### 概要
インポートタブを「予算インポート」と「設定インポート」の2つのサブタブに分割。

#### サブタブナビゲーション
```
┌─────────────────────────────────────────────────────────────────────┐
│ [📥 予算インポート]  [⚙️ 設定インポート]                              │
├─────────────────────────────────────────────────────────────────────┤
│ （選択したサブタブの内容が表示される）                                  │
└─────────────────────────────────────────────────────────────────────┘
```

#### 予算インポートサブタブ

| 機能 | 説明 |
|------|------|
| 予算テンプレートダウンロード | 空の予算CSVテンプレート（コード・項目名・12ヶ月列） |
| CSVドラッグ&ドロップ | 既存の顧客予算CSVインポート機能 |
| ファイル選択 | 複数ファイル選択・一括インポート |
| 取り込みデータ履歴 | 既存の履歴表示機能 |
| マッピング結果 | 既存のマッピング管理機能 |

#### 設定インポートサブタブ

| 機能 | 説明 |
|------|------|
| **店番インポート** | |
| 店番テンプレートダウンロード | 店番・店舗名のCSVテンプレート |
| 店番CSVインポート | CSVからDEFAULT_UNIT_PRICESに店舗追加 |
| 現在の登録店舗一覧 | 折りたたみ式で店舗・客単価一覧表示 |
| **予算項目コードインポート** | |
| 項目コードテンプレートダウンロード | 現在のマッピング定義をCSVでダウンロード |
| 項目コードCSVインポート | CUSTOMER_CODE_MAPにマッピング追加 |
| 現在のマッピング定義一覧 | 折りたたみ式でコード・項目名・v17No・カテゴリ一覧 |

#### テンプレートフォーマット

**予算テンプレート**
```csv
コード,項目名,4月,5月,6月,7月,8月,9月,10月,11月,12月,1月,2月,3月
810,店舗売上高,,,,,,,,,,,,,
820,出前売上高,,,,,,,,,,,,,
...
```

**店番テンプレート**
```csv
店番,店舗名
001,なかめのてっぺん　本店
002,店舗B
...
```

**予算項目コードテンプレート**
```csv
コード,項目名,v17No,カテゴリ,入力スタイル
810,店舗売上高,1,売上高,C.自動演算
820,出前売上高,2,売上高,B.通常入力
...
```

#### サブタブスタイル
| 状態 | スタイル |
|------|---------|
| 非アクティブ | 背景:#f5f5f5、文字色:#666 |
| ホバー | 背景:#e0e0e0 |
| アクティブ | 背景:青グラデーション（#2196f3→#1565c0）、文字色:白 |

#### 関連関数
| 関数名 | 機能 |
|--------|------|
| `switchImportSubtab(tabName)` | サブタブ切替 |
| `downloadBudgetTemplate()` | 予算テンプレートCSVダウンロード |
| `downloadStoreTemplate()` | 店番テンプレートCSVダウンロード |
| `downloadMappingTemplate()` | 項目コードテンプレートCSVダウンロード |
| `handleStoreDrop(event)` | 店番CSVドロップ処理 |
| `handleStoreFileSelect(event)` | 店番CSVファイル選択処理 |
| `importStoreCSV(file)` | 店番CSVインポート処理 |
| `handleMappingDrop(event)` | 項目コードCSVドロップ処理 |
| `updateCurrentStoreList()` | 登録店舗一覧の更新 |
| `updateCurrentMappingList()` | マッピング定義一覧の更新 |

---

## 14. 月別客単価インポートセクション（2026-01-03追加）

### 14.1 概要
設定インポートタブ内に「月別客単価インポート」セクションを追加。店舗別・月別の目標客単価をCSVでインポート可能。

### 14.2 UI構成
```
┌─────────────────────────────────────────────────────────────┐
│ 💰 月別客単価インポート                                       │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 月別客単価テンプレート                                    │ │
│ │ [📄 月別客単価テンプレートをダウンロード]                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌ - - - - - - - - - - - - - - - - - - - - - - - - - - - -┐ │
│ │               💰                                        │ │
│ │    月別客単価CSVをここにドラッグ＆ドロップ               │ │
│ │                  または                                 │ │
│ │            [ファイルを選択]                             │ │
│ └ - - - - - - - - - - - - - - - - - - - - - - - - - - - -┘ │
│                                                             │
│ CSVフォーマット:                                            │
│ 1行目: 店番,店名,客単価タイプ,4月,5月,...,3月              │
│ 2行目以降: 101,店舗A,総合,5000,5000,...                    │
└─────────────────────────────────────────────────────────────┘
```

### 14.3 CSVフォーマット
```csv
店番,店名,客単価タイプ,4月,5月,6月,7月,8月,9月,10月,11月,12月,1月,2月,3月
101,なかめのてっぺん　本店,総合,5000,5000,5000,5000,5000,5000,5000,5000,5000,5000,5000,5000
101,なかめのてっぺん　本店,ランチ,0,0,0,0,0,0,0,0,0,0,0,0
101,なかめのてっぺん　本店,ディナー,5000,5000,5000,5000,5000,5000,5000,5000,5000,5000,5000,5000
```

### 14.4 関連関数
| 関数名 | 機能 |
|--------|------|
| `downloadUnitPriceMonthlyTemplate()` | 月別客単価テンプレートダウンロード |
| `handleUnitPriceDrop(event)` | CSVドロップ処理 |
| `handleUnitPriceFileSelect(event)` | ファイル選択処理 |
| `importUnitPriceMonthlyCSV(file)` | CSVインポート処理 |

---

## 15. 店番テンプレート改善（2026-01-03更新）

### 15.1 概要
店番テンプレートを科目コードマッピング表の形式に統一。storeCodeプロパティを追加し、実際の店番コード（101, 103, 201等）を使用。

### 15.2 新CSVフォーマット
```csv
店番,店名
101,なかめのてっぺん　本店
103,なかめのてっぺん　丸の内
,新店A（店番未設定）
```

### 15.3 店舗一覧表示
| 店番 | 店名 | 客単価(総合) | 客単価(ランチ) | 客単価(ディナー) |
|------|------|-------------|---------------|-----------------|
| 101 | なかめのてっぺん　本店 | 5,000円 | 0円 | 5,000円 |
| 未設定 | 新店A | 5,000円 | 0円 | 5,000円 |

---

## 16. 営業利益トリプルチェック（2026-01-03追加）

### 16.1 概要
予算CSVインポート時に営業利益（No.63）のマッピングを3段階で検証。顧客予算表のコード誤り対策。

### 16.2 チェック内容
| チェック | 内容 | OK条件 |
|----------|------|--------|
| ① NAME_BASED_MAPマッピング | 項目名「営業利益」でNo.63にマッピング | CSVに「営業利益」行あり |
| ② コード9640検出 | CSVに9640が存在するか | 9640なし |
| ③ 計算検証 | 店舗営業利益(61)-販売管理費合計(62)=営業利益(63) | 差異1000円未満 |

### 16.3 処理ログ表示例
```
=== 営業利益トリプルチェック ===
① NAME_BASED_MAPマッピング: ✅ OK
② コード9640検出: ⚠️ 警告 - CSVに9640が存在します（値は無視されNAME_BASED_MAP優先）
③ 計算検証: ✅ OK（店舗営業利益 - 販売管理費合計 ≒ 営業利益）

【営業利益トリプルチェック結果】⚠️ 一部警告あり（NAME_BASED_MAPの値を採用）
```

### 16.4 差異検出時の表示
```
③ 計算検証: ⚠️ 差異あり（顧客予算表のコード誤りの可能性）
   4月: 店舗営業利益(2000000) - 販売管理費(500000) = 1500000 ≠ 営業利益(1703000) [差異: 203000]
   → NAME_BASED_MAPの値を採用（コード9640の誤マッピング対策）
```

---

## 17. マスタデータ履歴カテゴリフィルター（2026-01-03追加）

### 17.1 概要
マスタデータ履歴一覧のプルダウン上部にカテゴリフィルターボタンを追加。3つのマスタカテゴリを個別に選択・読込可能。

### 17.2 カテゴリボタン
| カテゴリ | ボタン | アクティブ色 | 読込対象 |
|----------|--------|--------------|----------|
| すべて | 📋 すべて | #7b1fa2（紫） | 3カテゴリ全て |
| 店番マスタ | 🏪 店番マスタ | #4caf50（緑） | 店舗名リストのみ |
| 予算項目コード | 📋 予算項目コード | #ff9800（橙） | CUSTOMER_CODE_MAP + NAME_BASED_MAP |
| 客単価 | 💰 客単価 | #2196f3（青） | 客単価データのみ |

### 17.3 画面レイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 📂 保存済みマスタ履歴（最大10件）                             │
├─────────────────────────────────────────────────────────────┤
│ カテゴリフィルター                                            │
│ [📋 すべて] [🏪 店番マスタ] [📋 予算項目コード] [💰 客単価]    │
├─────────────────────────────────────────────────────────────┤
│ 履歴選択                                                     │
│ [プルダウン: 履歴選択]  [📥 読込] [🗑 削除]                   │
├─────────────────────────────────────────────────────────────┤
│ プレビュー表示（カテゴリに応じた内容）                         │
└─────────────────────────────────────────────────────────────┘
```

### 17.4 カテゴリ別読込動作
| カテゴリ | 読込処理 | 上書き対象 |
|----------|----------|------------|
| すべて | 全データ復元 | DEFAULT_UNIT_PRICES, CUSTOMER_CODE_MAP, NAME_BASED_MAP |
| 店番マスタ | 店舗追加（既存維持） | DEFAULT_UNIT_PRICES（新規店舗のみ追加） |
| 予算項目コード | コードマップ上書き | CUSTOMER_CODE_MAP, NAME_BASED_MAP |
| 客単価 | 客単価上書き | DEFAULT_UNIT_PRICES |

### 17.5 プレビュー表示
カテゴリに応じて表示内容とスタイルが変化：
- すべて: 紫背景、全カテゴリのバッジと店舗一覧
- 店番マスタ: 緑背景、店番のみ（客単価非表示）
- 予算項目コード: 橙背景、コード一覧と名前ベース件数
- 客単価: 青背景、店舗と客単価表示

---

## 18. MQ試算モーダルからの客単価マスタ保存（2026-01-03追加）

### 18.1 概要
MQ試算の目標客単価編集モーダルで編集した値をマスタデータに保存し、履歴から復元可能にする機能。

### 18.2 モーダルボタン構成
| ボタン | 色 | 動作 |
|--------|-----|------|
| デフォルトにリセット | グレー | 店舗のデフォルト値に戻す |
| キャンセル | グレー | モーダルを閉じる |
| MQ試算のみ | オレンジ | 編集値でMQ計算（マスタ未保存） |
| 💾 マスタ保存 + MQ試算 | 緑 | DEFAULT_UNIT_PRICESに保存後MQ計算 |

### 18.3 保存データ構造
```javascript
DEFAULT_UNIT_PRICES[storeName] = {
    storeCode: '101',
    total: 5000,      // 月平均（総合）
    lunch: 0,         // 月平均（ランチ）
    dinner: 5000,     // 月平均（ディナー）
    monthly: {        // 月別データ
        0: { total: 5000, lunch: 0, dinner: 5000 },  // 4月
        1: { total: 5200, lunch: 0, dinner: 5200 },  // 5月
        // ...
    }
};
```

### 18.4 保存フロー
1. ユーザーがMQ試算モーダルで月別客単価を編集
2. 「💾 マスタ保存 + MQ試算」ボタンをクリック
3. `saveSimUnitPricesToMaster()` 実行
   - 入力値の月平均を計算
   - DEFAULT_UNIT_PRICES[storeName]に反映
   - monthly オブジェクトに月別値を保存
4. `renderMasterPricesContent()` で表示更新
5. MQ試算実行

### 18.5 マスタ履歴への保存
- 「💾 現在のデータを保存」ボタンでマスタ履歴に保存
- 「客単価」カテゴリから履歴を選択して復元可能

---

## 19. 取り込みデータ履歴モーダル（2026-01-03追加）

### 19.1 概要
インポートした予算データをLocalStorageに保存し、後から復元できる機能。モーダル内で現在のセッションデータと保存済み履歴を一元管理。

### 19.2 モーダル構成
```
┌─────────────────────────────────────────────────────────────┐
│ 📋 取り込みデータ履歴一覧                     [✕ 閉じる]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 📂 現在の取り込みデータ（未保存）    [💾 現在のデータを保存] │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 店舗A (4月〜3月)         [表示] [保存] [削除]           │ │
│ │ 店舗B (4月〜3月)         [表示] [保存] [削除]           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 💾 保存済み取り込みデータ履歴                    [🗑 全削除] │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 💾 2026-01-03_02:31_店舗A                               │ │
│ │   📅 保存日時: 2026/1/3 2:31:51  🏪 1店舗              │ │
│ │   [🔍 プレビュー] [読み込み] [削除]                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 🔍 データプレビュー: （タイトル）                        │ │
│ │   [📥 このデータを読み込み] [✕ 閉じる]                  │ │
│ │                                                         │ │
│ │   🏪 店舗名                                             │ │
│ │   ✅ マッチ済み項目（N件）                              │ │
│ │   ❌ 未マッチ項目（N件）                                │ │
│ │   📊 月別データ（主要項目）                             │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 19.3 現在のセッションセクション

| 要素 | 機能 |
|------|------|
| 店舗カード | インポート済み店舗ごとにカード表示 |
| 表示ボタン | 該当店舗を選択して画面を閉じる |
| 保存ボタン | 該当店舗を日時付きで個別保存 |
| 削除ボタン | 該当店舗をセッションから削除 |
| 💾 現在のデータを保存 | 全店舗をまとめてLocalStorageに保存 |

### 19.4 保存済み履歴セクション

| 要素 | 機能 |
|------|------|
| 履歴カード | 保存済みデータごとにカード表示 |
| 🔍 プレビュー | データ内容をプレビューパネルで確認 |
| 読み込み | データをセッションに復元（確認ダイアログあり） |
| 削除 | 履歴から削除 |
| 🗑 全削除 | 全履歴を削除 |

### 19.5 プレビューパネル

| 表示項目 | 内容 |
|---------|------|
| 店舗名 | 保存データに含まれる店舗 |
| マッチ済み項目 | 項目名、コード、年間合計（最大15件） |
| 未マッチ項目 | 赤バッジで表示（最大10件） |
| 月別データ | 主要10項目×12ヶ月のテーブル |

### 19.6 関連関数

| 関数名 | 機能 |
|--------|------|
| `showDataHistoryPage()` | モーダル表示 |
| `hideDataHistoryPage()` | モーダル非表示 |
| `renderDataHistoryList()` | 現在のセッション一覧描画 |
| `renderSavedHistoryList()` | 保存済み履歴一覧描画 |
| `saveCurrentImportData()` | 現在の全データを保存 |
| `saveStoreWithDateTime(name)` | 店舗を個別保存 |
| `loadFromHistory(id)` | 履歴から復元 |
| `loadFromHistoryAndClose(id)` | 復元してモーダルを閉じる |
| `deleteFromHistory(id)` | 履歴削除 |
| `deleteFromHistoryAndRefresh(id)` | 削除して再描画 |
| `previewSavedHistory(id)` | プレビュー表示 |
| `loadPreviewedData()` | プレビュー中のデータを読み込み |
| `closeHistoryPreview()` | プレビューを閉じる |
| `clearAllHistory()` | 全履歴削除 |

### 19.7 保存データ構造
```json
{
  "id": "1704234711234",
  "title": "2026-01-03_02:31_店舗A",
  "dateTime": "2026-01-03 02:31:51",
  "storeNames": ["店舗A"],
  "storeCount": 1,
  "data": {
    "店舗A": {
      "annualData": { ... },
      "calcResults": { ... },
      "rakumyInputs": { ... },
      "mqOutputs": { ... },
      "matchedItems": [ ... ],
      "unmatchedItems": [ ... ],
      "monthLabels": ["4月", "5月", ...]
    }
  },
  "savedAt": "2026-01-03T02:31:51.234Z"
}
```

### 19.8 スタイル仕様

| 要素 | スタイル |
|------|---------|
| 現在のセッションカード | border-left: 4px solid #1565c0（青） |
| 保存済み履歴カード | border-left: 4px solid #7b1fa2（紫） |
| プレビューパネル | border: 3px solid #1565c0、背景白 |
| プレビューボタン | 背景 #1565c0（青） |
| 読み込みボタン | 背景 #4caf50（緑）から変更なし |
| 削除ボタン | 背景 #f44336（赤） |

### 19.9 読み込み確認ダイアログ

```
現在のデータを置き換えますか？
[キャンセル] [OK]
```

- 現在のセッションにデータがある場合のみ表示
- OKで現在のデータを完全に置き換え
- キャンセルで読み込みを中止

---

## 20. 客単価カテゴリ月別プレビュー（2026-01-03追加）

### 20.1 概要
マスタデータ履歴の客単価カテゴリで、月別客単価データをプレビュー表示。

### 20.2 表示形式

**月別データがある場合:**
```
💰 店舗A
総合 平均: 5,000円
  4月:5,000円, 5月:5,200円, 6月:5,000円, 7月:4,800円, ...
ランチ 平均: 0円
ディナー 平均: 5,000円
  4月:5,000円, 5月:5,200円, ...
```

**月別データがない場合:**
```
💰 店舗A
総合: 5,000円 | ランチ: 0円 | ディナー: 5,000円
```

### 20.3 データ判定ロジック
```javascript
if (prices.monthly && Object.keys(prices.monthly).length > 0) {
    // 月別表示
    var monthlyStr = '';
    for (var m = 0; m < 12; m++) {
        if (prices.monthly[m]) {
            monthlyStr += FISCAL_ORDER[m] + ':' +
                         prices.monthly[m].total.toLocaleString() + '円, ';
        }
    }
} else {
    // 年平均のみ表示
}
```

## 21. カテゴリマッピング設定セクション（2026-01-03追加）

### 21.1 概要
設定インポートタブ内に配置された予算カテゴリの表示順序設定機能。

### 21.2 位置
- メインタブ: 📥 インポート
- サブタブ: ⚙️ 設定インポート
- セクション: マスタ設定の下部

### 21.3 UI構成
```
┌─────────────────────────────────────────────────────────────┐
│ 📊 カテゴリマッピング設定                                     │
├─────────────────────────────────────────────────────────────┤
│ [📋 カテゴリ表示順設定] [📄 カテゴリ内項目順設定]              │
├─────────────────────────────────────────────────────────────┤
│ ▼ カテゴリ表示順設定                                         │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 順番 │ カテゴリ名    │ 出力先      │ 色    │ 操作      │ │
│ │  1   │ 売上高        │ MQ計算      │ 🟢    │ [↑][↓]   │ │
│ │  2   │ 売上原価      │ MQ計算      │ 🟠    │ [↑][↓]   │ │
│ │  3   │ 人件費        │ 両方        │ 🔵    │ [↑][↓]   │ │
│ │ ...  │ ...          │ ...        │ ...   │ ...      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [💾 表示順設定を保存] [🔄 初期設定に戻す]                      │
└─────────────────────────────────────────────────────────────┘
```

### 21.4 カテゴリ内項目順設定パネル
```
┌─────────────────────────────────────────────────────────────┐
│ ▼ カテゴリ内項目表示順設定                                   │
│ カテゴリ選択: [売上高 ▼]                                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 順番 │ コード │ 項目名         │ 操作                   │ │
│ │  1   │ 810   │ 店舗売上高      │ [↑][↓]                │ │
│ │  2   │ 811   │ ドリンク売上    │ [↑][↓]                │ │
│ │  3   │ 812   │ その他売上高    │ [↑][↓]                │ │
│ │  4   │ 999   │ 売上高合計     │ [↑][↓]                │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 21.5 データ構造

**BUDGET_CATEGORY_MAP:**
```javascript
var BUDGET_CATEGORY_MAP = {
    '売上高': {
        output: 'mq',           // mq=MQ計算, cost=費用予算設定, both=両方
        type: 'sales',
        displayOrder: 1,
        color: '#4caf50',
        items: []
    },
    '売上原価': { output: 'mq', type: 'cost_of_sales', displayOrder: 2, color: '#ff9800', items: [] },
    '人件費': { output: 'both', type: 'labor', displayOrder: 3, color: '#2196f3', items: [] },
    // ... 13カテゴリ
};
```

**CUSTOMER_CODE_MAP拡張:**
```javascript
'810': {
    v15No: 1,
    name: '店舗売上高',
    category: '売上高',
    budgetCategory: '売上高',  // ★追加
    sortOrder: 1,              // ★追加
    inputStyle: 'C.自動演算',
    screen: '自動'
}
```

### 21.6 関連JavaScript関数

| 関数名 | 説明 |
|-------|------|
| showCategoryOrderPanel() | カテゴリ表示順パネル表示 |
| showItemOrderPanel() | カテゴリ内項目順パネル表示 |
| renderCategoryOrderSettings() | カテゴリ表示順テーブル描画 |
| moveCategoryUp(name) | カテゴリを上に移動 |
| moveCategoryDown(name) | カテゴリを下に移動 |
| renderCategorySelectOptions() | カテゴリセレクター描画 |
| renderItemOrderSettings(cat) | カテゴリ内項目テーブル描画 |
| moveItemUp(code, cat) | 項目を上に移動 |
| moveItemDown(code, cat) | 項目を下に移動 |
| saveCategorySettings() | LocalStorage保存 |
| loadCategorySettings() | LocalStorage読込 |
| resetCategorySettings() | 初期設定に戻す |
| validateCategoryMapping(code, name, csvCat) | CSVカテゴリ検証 |

### 21.7 LocalStorageキー
```javascript
var CATEGORY_ORDER_KEY = 'rakumy_category_order';

// 保存形式
{
    categoryOrder: { '売上高': 1, '売上原価': 2, ... },
    itemOrder: {
        '売上高': { '810': 1, '811': 2, ... },
        '売上原価': { '2028': 1, '461': 2, ... }
    },
    savedAt: '2026-01-03T...'
}
```

### 21.8 CSVダブルチェック機能

CSVインポート時、予算カテゴリ列（A列）とマッピング定義のカテゴリを比較し、
不一致があれば警告ログを出力。

```javascript
// 使用例
var validation = validateCategoryMapping('810', '店舗売上高', '売上高');
if (validation.warning) {
    addLog('⚠️【カテゴリ不一致】' + validation.warning, 'warn');
}
```

---

## 22. インポート列マッピング機能強化（2026-01-03追加）

### 22.1 概要
予算インポートタブ内の列マッピング設定を強化。オプション列の無効化、カスタム列追加、列グループ設定、CSVフォーマット設定機能を追加。

### 22.2 列マッピング設定UI
```
┌─────────────────────────────────────────────────────────────┐
│ 予算インポートセクション                                       │
├─────────────────────────────────────────────────────────────┤
│ 予算テンプレート: [📄 テンプレートをダウンロード]                │
│ 列マッピング設定: [プリセット選択▼] [✏️編集] [➕新規]           │
│ 適用中: 標準（デフォルト）                                     │
└─────────────────────────────────────────────────────────────┘
```

### 22.3 列マッピングエディタモーダル

```
┌─────────────────────────────────────────────────────────────┐
│ 📋 列マッピング設定                                  [✕]    │
├─────────────────────────────────────────────────────────────┤
│ プリセット名: [________________]                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 📐 CSVフォーマット設定                                       │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ■ 基本フォーマット（フェーズ1）                          │ │
│ │   ヘッダー行: [1] (データ開始行番号)                     │ │
│ │   文字コード: [自動検出▼]                               │ │
│ │   区切り文字: [自動検出▼]                               │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ ■ データ変換設定（フェーズ2）                           │ │
│ │   数値フォーマット: [自動検出▼]                         │ │
│ │   空白セルの扱い: [0として処理▼]                        │ │
│ │   金額単位: [円(×1)▼]                                  │ │
│ │   前後空白を除去: [✓]                                  │ │
│ │   日付フォーマット: [自動検出▼]                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 🔧 列グループ設定                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ グループモード: [なし▼]                                  │ │
│ │                                                         │ │
│ │ ● なし - 各月を個別に設定                               │ │
│ │ ● 四半期 - Q1〜Q4でグループ化                           │ │
│ │ ● 半期 - H1/H2でグループ化                              │ │
│ │                                                         │ │
│ │ ※四半期選択時:                                          │ │
│ │   [Q1(1-3月)] [Q2(4-6月)] [Q3(7-9月)] [Q4(10-12月)]     │ │
│ │                                                         │ │
│ │ ※半期選択時:                                            │ │
│ │   [上期(1-6月)] [下期(7-12月)]                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 📊 マッピング列一覧                                          │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ キー          │ ラクミー項目名       │ CSV列名     │有効│ │
│ │ category      │ 予算カテゴリ         │ 予算カテゴリ │ ✓ │ │
│ │ code          │ 科目コード           │ 科目コード   │ ✓ │ │
│ │ name          │ 予算項目名           │ 予算項目名   │ ✓ │ │
│ │ month1        │ 1月                 │ 1月         │ ☐ │ │
│ │ month2        │ 2月                 │ 2月         │ ✓ │ │
│ │ ...           │ ...                 │ ...         │ ...│ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ➕ カスタム列                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ キー          │ CSV列名              │ 操作              │ │
│ │ custom1       │ 備考                 │ [🗑]              │ │
│ │ custom2       │ 担当者               │ [🗑]              │ │
│ │                                                         │ │
│ │ [➕ カスタム列を追加]                                    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [💾 保存] [プリセットを削除] [キャンセル]                     │
└─────────────────────────────────────────────────────────────┘
```

### 22.4 CSVフォーマット設定（フェーズ1: 基本フォーマット）

| 設定項目 | 説明 | オプション |
|---------|------|-----------|
| ヘッダー行 | データ開始行番号 | 1〜10（デフォルト: 1） |
| 文字コード | CSVの文字エンコーディング | 自動検出, UTF-8, Shift-JIS |
| 区切り文字 | 列の区切り文字 | 自動検出, カンマ, タブ, セミコロン |

### 22.5 データ変換設定（フェーズ2）

| 設定項目 | 説明 | オプション |
|---------|------|-----------|
| 数値フォーマット | 数値のカンマ区切り | 自動検出, カンマ区切り, なし |
| 空白セルの扱い | 空セルの処理方法 | 0として処理, null, スキップ |
| 金額単位 | 金額の単位変換 | ×1（円）, ×1,000（千円）, ×10,000（万円） |
| 前後空白を除去 | 文字列のトリム | ON/OFF |
| 日付フォーマット | 日付列の解釈 | 自動検出, Y/M/D, M/D/Y, D/M/Y |

### 22.6 列グループ設定

| モード | 説明 | グループ |
|--------|------|---------|
| なし | 各月を個別に有効/無効設定 | - |
| 四半期 | Q1〜Q4で一括設定 | Q1(1-3月), Q2(4-6月), Q3(7-9月), Q4(10-12月) |
| 半期 | 上期/下期で一括設定 | H1(1-6月), H2(7-12月) |

### 22.7 オプション列の無効化

月列（month1〜month12）はオプション列として、個別に有効/無効を切り替え可能。
無効化された列はCSVインポート時に無視される。

| 列種別 | 必須/オプション | 無効化可能 |
|--------|---------------|-----------|
| category, code, name | 必須 | ✕ |
| month1〜month12 | オプション | ✓ |
| カスタム列 | オプション | ✓（削除で対応） |

### 22.8 カスタム列追加

顧客固有のCSV列をマッピングに追加可能。

**使用例:**
- 備考列
- 担当者列
- 部門コード列
- メモ・コメント列

**データ構造:**
```javascript
currentCustomColumns = [
    { key: 'custom1', csvName: '備考' },
    { key: 'custom2', csvName: '担当者' }
];
```

### 22.9 関連JavaScript関数

| 関数名 | 説明 |
|--------|------|
| toggleColumnDisabled(key) | 列の有効/無効切替 |
| setColumnGroupType(type) | グループモード設定 |
| toggleQuarterGroup(quarterKey) | 四半期一括切替 |
| toggleHalfGroup(halfKey) | 半期一括切替 |
| addCustomColumn() | カスタム列追加 |
| updateCustomColumnKey(idx, value) | カスタム列キー更新 |
| updateCustomColumnCsvName(idx, value) | カスタム列名更新 |
| removeCustomColumn(idx) | カスタム列削除 |
| updateFormatSetting(key, value) | フォーマット設定更新 |
| getDefaultFormatSettings() | デフォルト設定取得 |

### 22.10 データ構造

**グローバル変数:**
```javascript
var currentDisabledColumns = {};     // 無効化された列
var currentCustomColumns = [];       // カスタム列
var currentColumnGroups = {};        // 列グループ設定
var currentFormatSettings = {};      // フォーマット設定
```

**COLUMN_GROUPS定義:**
```javascript
var COLUMN_GROUPS = {
    q1: { name: 'Q1（1-3月）', months: ['month1', 'month2', 'month3'] },
    q2: { name: 'Q2（4-6月）', months: ['month4', 'month5', 'month6'] },
    q3: { name: 'Q3（7-9月）', months: ['month7', 'month8', 'month9'] },
    q4: { name: 'Q4（10-12月）', months: ['month10', 'month11', 'month12'] },
    h1: { name: '上期（1-6月）', months: ['month1', 'month2', 'month3', 'month4', 'month5', 'month6'] },
    h2: { name: '下期（7-12月）', months: ['month7', 'month8', 'month9', 'month10', 'month11', 'month12'] }
};
```

**プリセット保存形式:**
```javascript
{
    name: 'カスタムプリセット',
    mappings: { category: '予算カテゴリ', code: '科目コード', ... },
    disabledColumns: { month1: true, month2: true },
    customColumns: [{ key: 'custom1', csvName: '備考' }],
    columnGroups: { type: 'quarter' },
    formatSettings: {
        headerRow: 1,
        encoding: 'auto',
        delimiter: 'auto',
        numberFormat: 'auto',
        emptyValue: 'zero',
        amountUnit: 1,
        trimSpaces: true,
        dateFormat: 'auto'
    }
}
```

### 22.11 LocalStorageキー
```javascript
var COLUMN_MAPPING_PRESETS_KEY = 'rakumy_column_mapping_presets';
```

---

## 23. 会計年度設定機能（2026-01-03追加）

### 23.1 概要
テンプレートダウンロードや月列表示で使用する会計年度を設定する機能。日本標準の4月始まりだけでなく、1月始まりやその他の開始月にも対応。

### 23.2 設定インポートタブ内の配置
```
┌─────────────────────────────────────────────────────────────┐
│ ⚙️ 設定インポート                                            │
├─────────────────────────────────────────────────────────────┤
│ 📅 会計年度設定                     ← 最上部に新規配置       │
├─────────────────────────────────────────────────────────────┤
│ 🏪 店番インポート                                            │
├─────────────────────────────────────────────────────────────┤
│ 📋 予算項目コードインポート                                  │
├─────────────────────────────────────────────────────────────┤
│ 💰 月別客単価インポート                                      │
└─────────────────────────────────────────────────────────────┘
```

### 23.3 会計年度設定UI
```
┌─────────────────────────────────────────────────────────────┐
│ 📅 会計年度設定                                              │
│ テンプレートや表示で使用する会計年度を設定します              │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │📆 会計年度開始月 │ │📅 対象年度      │ │🏷️ 年度表記スタイル│ │
│ │[4月（日本標準）▼]│ │[2026年度▼]     │ │[月のみ(4月...)▼] │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 📊 会計年度プレビュー                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [4月][5月][6月][7月][8月][9月][10月][11月][12月][1月][2月][3月] │
│ └─────────────────────────────────────────────────────────┘ │
│ 2026年度 = 2026年4月〜2027年3月                              │
├─────────────────────────────────────────────────────────────┤
│ [💾 会計年度設定を保存] [🔄 初期設定に戻す]                   │
└─────────────────────────────────────────────────────────────┘
```

### 23.4 設定項目

| 設定項目 | 説明 | 選択肢 |
|---------|------|--------|
| 会計年度開始月 | 会計年度の開始月 | 1月〜12月（デフォルト: 4月） |
| 対象年度 | テンプレートに使用する年度 | 現在年±2〜+3年の範囲 |
| 年度表記スタイル | 月ラベルの表示形式 | 月のみ / 年月 / スラッシュ |

### 23.5 年度表記スタイル

| スタイル | 説明 | 表示例 |
|---------|------|--------|
| short | 月のみ | 4月, 5月, ..., 3月 |
| full | 年月 | 2026年4月, 2026年5月, ..., 2027年3月 |
| slash | スラッシュ | 2026/4, 2026/5, ..., 2027/3 |

### 23.6 テンプレートへの反映

会計年度設定は以下のテンプレートダウンロードに反映されます：

| テンプレート | ファイル名例 | ヘッダー月列 |
|-------------|--------------|-------------|
| 予算テンプレート | 予算テンプレート_2026年度_2026-01-03.csv | 設定に従った月列 |
| 月別客単価テンプレート | 月別客単価テンプレート_2026年度_2026-01-03.csv | 設定に従った月列 |

### 23.7 プレビュー表示

- 月ラベルをバッジ形式で12個表示
- 前半6ヶ月（濃い紫）・後半6ヶ月（薄い紫）で色分け
- 年度範囲を「2026年度 = 2026年4月〜2027年3月」形式で表示

### 23.8 LocalStorage保存

```javascript
var FISCAL_YEAR_SETTINGS_KEY = 'rakumy_fiscal_year_settings';

// 保存形式
{
    "startMonth": 4,
    "year": 2026,
    "style": "short"
}
```

### 23.9 関連JavaScript関数

| 関数名 | 説明 |
|--------|------|
| generateFiscalOrder() | FISCAL_ORDERを動的生成 |
| getFiscalYearInfo() | 年度範囲情報を取得 |
| getFiscalMonthInfo(index) | 月インデックスから年・月を取得 |
| updateFiscalYearSettings() | 設定変更時の処理 |
| saveFiscalYearSettings() | LocalStorageに保存 |
| loadFiscalYearSettings() | LocalStorageから読み込み |
| resetFiscalYearSettings() | 初期設定（4月）に戻す |
| initFiscalYearSelector() | 年度セレクター初期化 |
| renderFiscalYearPreview() | プレビュー描画 |

### 23.10 スタイル仕様

| 要素 | スタイル |
|------|---------|
| セクションボーダー | border-left: 4px solid #673ab7（紫） |
| 見出し色 | #512da8 |
| プレビュー背景 | #ede7f6（薄い紫） |
| プレビューボーダー | #b39ddb |
| 月バッジ（前半） | #673ab7 |
| 月バッジ（後半） | #9575cd |
| 保存ボタン | #673ab7 |
| リセットボタン | #9e9e9e（グレー） |
