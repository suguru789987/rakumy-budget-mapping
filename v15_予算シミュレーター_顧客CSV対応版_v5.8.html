<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v15 äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆé¡§å®¢CSVå¯¾å¿œç‰ˆ v5.8 å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–ï¼‰</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background: #f0f2f5; padding: 15px; font-size: 11px; }
        .container { max-width: 1900px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 5px; font-size: 20px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 15px; font-size: 12px; }

        .import-section { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .import-section h2 { font-size: 14px; margin-bottom: 10px; color: #333; }
        .import-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: #fff; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn:hover { opacity: 0.85; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .info-bar { display: flex; gap: 20px; align-items: center; padding: 12px 15px; background: #e8f5e9; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #4caf50; flex-wrap: wrap; }
        .info-label { font-weight: bold; color: #333; }
        .info-value { font-size: 14px; font-weight: bold; color: #1b5e20; }

        .column-detection { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #17a2b8; }
        .column-detection h3 { font-size: 13px; margin-bottom: 10px; color: #0c5460; }
        .month-cols-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 8px; }
        .month-col-card { padding: 8px; background: #f8f9fa; border-radius: 4px; text-align: center; font-size: 10px; border: 2px solid transparent; }
        .month-col-card.ok { border-color: #28a745; background: #d4edda; }
        .month-col-card.warn { border-color: #ffc107; background: #fff3cd; }
        .month-col-card.error { border-color: #dc3545; background: #f8d7da; }
        .month-name { font-weight: bold; font-size: 12px; }
        .col-info { color: #666; margin-top: 3px; }
        .sub-header { color: #007bff; font-weight: bold; }

        .section { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; overflow: hidden; }
        .section-header { padding: 12px 15px; font-weight: bold; font-size: 13px; }
        .section-body { padding: 15px; overflow-x: auto; }

        .header-mapping { background: #e1bee7; color: #6a1b9a; }
        .header-input { background: #fff3cd; color: #856404; }
        .header-calc { background: #d1ecf1; color: #0c5460; }
        .header-rakumy { background: #cce5ff; color: #004085; }
        .header-output { background: #d4edda; color: #155724; }
        .header-summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }

        .annual-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .annual-table th, .annual-table td { padding: 5px 6px; text-align: right; border: 1px solid #e0e0e0; white-space: nowrap; }
        .annual-table th { background: #f5f5f5; font-weight: bold; text-align: center; }
        .annual-table th:first-child { text-align: left; min-width: 150px; }
        .annual-table td:first-child { text-align: left; font-weight: bold; }
        .annual-table .month-header { background: #e3f2fd; }
        .annual-table .total-col { background: #fff8e1; font-weight: bold; }
        .annual-table .avg-col { background: #f3e5f5; }

        .input-cell { background: #fffde7; }
        .calc-cell { background: #e0f7fa; }
        .rakumy-cell { background: #e3f2fd; }
        .output-cell { background: #e8f5e9; }

        .annual-badge { background: #4caf50; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px; }
        .monthly-badge { background: #ff9800; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px; }

        /* å¤‰æ›ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸ */
        .type-direct { background: #2196f3; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-sum { background: #9c27b0; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-rate { background: #e91e63; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-input { background: #4caf50; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-output { background: #607d8b; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }

        /* ãƒ©ã‚¯ãƒŸãƒ¼ã‚«ãƒ†ã‚´ãƒª */
        .rakumy-category { margin-bottom: 20px; }
        .rakumy-category h4 { font-size: 12px; padding: 8px 12px; margin-bottom: 10px; border-radius: 4px; }
        .rakumy-category.cost h4 { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }
        .rakumy-category.budget h4 { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }
        .rakumy-category.monthly h4 { background: #fff3e0; color: #e65100; border-left: 4px solid #ff9800; }

        .transform-legend { display: flex; gap: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 15px; flex-wrap: wrap; font-size: 10px; }
        .transform-legend span { display: flex; align-items: center; gap: 5px; }

        .summary-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
        .summary-card { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; text-align: center; }
        .summary-label { font-size: 11px; opacity: 0.9; margin-bottom: 5px; }
        .summary-value { font-size: 22px; font-weight: bold; }
        .summary-sub { font-size: 10px; opacity: 0.8; margin-top: 3px; }

        .status-bar { padding: 10px 15px; border-radius: 4px; margin-top: 10px; font-size: 11px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-info { background: #d1ecf1; color: #0c5460; }

        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 0; flex-wrap: wrap; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; font-size: 11px; font-weight: bold; }
        .tab:hover { background: #f5f5f5; }
        .tab.active { border-bottom-color: #007bff; color: #007bff; background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .mapping-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 15px; }
        .mapping-table th, .mapping-table td { padding: 6px 8px; border: 1px solid #ddd; text-align: left; }
        .mapping-table th { background: #f0f0f0; }

        .unmatched-section { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107; }
        .unmatched-section h3 { color: #856404; margin-bottom: 10px; }

        .form-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .form-row label { min-width: 100px; font-weight: bold; }
        .form-row input, .form-row select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; }

        .preprocess-log { background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 9px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
        .log-info { color: #4ec9b0; }
        .log-warn { color: #dcdcaa; }
        .log-error { color: #f48771; }
        .log-success { color: #6a9955; }
        .log-data { color: #ce9178; }
        .log-month { color: #569cd6; }

        .sample-values { margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; }
        .sample-values h4 { margin-bottom: 8px; }
        .sample-table { font-size: 9px; }
        .sample-table th, .sample-table td { padding: 3px 6px; }

        .store-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; padding: 12px 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .store-selector label { font-weight: bold; color: #333; }
        .store-selector select { padding: 8px 12px; border: 2px solid #007bff; border-radius: 4px; font-size: 12px; font-weight: bold; min-width: 200px; }
        .store-list { display: flex; gap: 8px; flex-wrap: wrap; margin-left: 20px; }
        .store-chip { padding: 4px 10px; background: #e3f2fd; border-radius: 15px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; cursor: pointer; }
        .store-chip.active { background: #1565c0; color: #fff; }
        .store-chip .remove { margin-left: 5px; color: #f44336; cursor: pointer; font-weight: bold; }

        .all-stores-summary { background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .all-stores-summary h3 { margin-bottom: 15px; font-size: 16px; }
        .all-stores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .store-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; }
        .store-card h4 { margin-bottom: 10px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; }
        .store-card .metric { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .store-card .metric-value { font-weight: bold; }
        .store-card.total { background: rgba(255,193,7,0.3); border: 2px solid #ffc107; }

        /* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
        .drop-zone {
            border: 2px dashed #90caf9;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .drop-zone:hover { border-color: #1565c0; background: #e3f2fd; }
        .drop-zone.drag-over { border-color: #4caf50; background: #e8f5e9; border-style: solid; }
        .drop-zone-content { pointer-events: none; }
        .drop-zone-content button { pointer-events: auto; }

        /* é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .selected-files-section {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        /* ç¸¦ç©ã¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ */
        .file-list-vertical {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 4px solid #1565c0;
        }
        .file-item:hover { background: #e3f2fd; }
        .file-item .file-info { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        .file-item .file-icon { font-size: 18px; }
        .file-item .file-name { font-weight: bold; font-size: 12px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-item .file-size { font-size: 10px; color: #666; white-space: nowrap; }
        .file-item .remove-btn { background: #f44336; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; font-size: 10px; cursor: pointer; }
        .file-item .remove-btn:hover { background: #d32f2f; }

        /* å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ */
        .imported-data-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .data-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .data-item:hover { border-color: #1565c0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .data-item .data-info { flex: 1; }
        .data-item .data-name { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 5px; }
        .data-item .data-meta { font-size: 11px; color: #666; display: flex; gap: 15px; flex-wrap: wrap; }
        .data-item .data-meta span { background: #f5f5f5; padding: 2px 8px; border-radius: 10px; }
        .data-item .data-actions { display: flex; gap: 8px; }
        .data-item .data-actions button { padding: 8px 15px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .data-item .save-btn { background: #4caf50; color: #fff; }
        .data-item .save-btn:hover { background: #43a047; }
        .data-item .view-btn { background: #2196f3; color: #fff; }
        .data-item .view-btn:hover { background: #1e88e5; }
        .data-item .delete-btn { background: #f44336; color: #fff; }
        .data-item .delete-btn:hover { background: #e53935; }
        .empty-message { text-align: center; padding: 30px; color: #999; font-size: 14px; }

        /* å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ */
        .data-history-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f2f5;
            z-index: 1000;
            overflow-y: auto;
        }
        .data-history-header {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: #fff;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-history-header h2 { margin: 0; font-size: 20px; }
        .data-history-content {
            padding: 20px 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .data-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .history-data-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s;
        }
        .history-data-item:hover {
            border-color: #1565c0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .history-data-item .item-info { flex: 1; }
        .history-data-item .item-name {
            font-weight: bold;
            font-size: 16px;
            color: #1565c0;
            margin-bottom: 8px;
        }
        .history-data-item .item-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 12px;
            color: #666;
        }
        .history-data-item .item-meta span {
            background: #f5f5f5;
            padding: 4px 12px;
            border-radius: 15px;
        }
        .history-data-item .item-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .history-data-item .item-actions button {
            padding: 10px 20px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .history-data-item .btn-view { background: #2196f3; color: #fff; }
        .history-data-item .btn-view:hover { background: #1976d2; }
        .history-data-item .btn-save { background: #4caf50; color: #fff; }
        .history-data-item .btn-save:hover { background: #43a047; }
        .history-data-item .btn-delete { background: #f44336; color: #fff; }
        .history-data-item .btn-delete:hover { background: #e53935; }

        /* å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .history-section { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .history-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; }
        .history-item { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .history-item:hover { border-color: #1565c0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .history-title { font-weight: bold; font-size: 12px; color: #1565c0; }
        .history-meta { font-size: 10px; color: #666; }
        .history-stores { font-size: 10px; color: #888; }
        .history-actions { display: flex; gap: 5px; margin-top: 5px; }
        .history-actions button { padding: 4px 10px; font-size: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .history-actions .load-btn { background: #1565c0; color: #fff; }
        .history-actions .delete-btn { background: #f44336; color: #fff; }

        /* ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« */
        .data-view-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .data-view-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
        }
        .data-view-container {
            position: relative;
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }
        .data-view-header {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: #fff;
            padding: 15px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-view-header h3 { margin: 0; font-size: 16px; }
        .data-view-body {
            padding: 20px;
            overflow: auto;
            flex: 1;
        }
        .data-view-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .data-view-table th, .data-view-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
        }
        .data-view-table th {
            background: #e3f2fd;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .data-view-table tr:nth-child(even) { background: #f9f9f9; }
        .data-view-table tr:hover { background: #e8f4fc; }

        /* ãƒˆãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– */
        .main-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: #fff;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .main-nav-tab {
            padding: 15px 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            background: transparent;
            border: none;
        }
        .main-nav-tab:hover { background: #f5f5f5; }
        .main-nav-tab.active {
            color: #fff;
        }
        .main-nav-tab.import-tab.active {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
        }
        .main-nav-tab.budget-tab.active {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }
        .main-nav-tab.export-tab.active {
            background: linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);
        }
        .main-nav-tab .tab-icon { font-size: 24px; }
        .main-page { display: none; }
        .main-page.active { display: block; }

        @media (max-width: 768px) {
            .summary-grid { grid-template-columns: repeat(3, 1fr); }
            .month-cols-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>v15 äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆé¡§å®¢CSVå¯¾å¿œç‰ˆ v5.8ï¼‰</h1>
        <p class="subtitle">å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–ï¼šé¡§å®¢äºˆç®—â†’ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›ã®å¤‰æ›ã‚¿ã‚¤ãƒ—ï¼ˆç›´æ¥/åˆè¨ˆ/ç‡/å‡ºåŠ›ï¼‰ã‚’æ˜ç¤ºåŒ–</p>

        <!-- ===== ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– ===== -->
        <div class="main-nav">
            <button class="main-nav-tab import-tab active" onclick="showMainPage('import')">
                <span class="tab-icon">ğŸ“¥</span>
                <span>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
            </button>
            <button class="main-nav-tab budget-tab" onclick="showMainPage('budget')">
                <span class="tab-icon">ğŸ“Š</span>
                <span>äºˆç®—è¨­å®š</span>
            </button>
            <button class="main-nav-tab export-tab" onclick="showMainPage('export')">
                <span class="tab-icon">ğŸ“¤</span>
                <span>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
            </button>
        </div>

        <!-- ===== ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ ===== -->
        <div id="page-import" class="main-page active">
            <div class="import-section" style="border-left:4px solid #2196f3;">
                <h2 style="color:#1565c0;font-size:18px;margin-bottom:20px;">ğŸ“¥ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>

                <!-- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
                <div id="dropZone" class="drop-zone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="drop-zone-content">
                        <div style="font-size:50px;margin-bottom:15px;">ğŸ“</div>
                        <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div style="font-size:12px;color:#666;margin-bottom:15px;">ã¾ãŸã¯</div>
                        <input type="file" id="csvFile" accept=".csv" multiple onchange="handleFileSelect(event)" style="display:none;">
                        <button class="btn btn-primary" style="padding:12px 30px;font-size:14px;" onclick="document.getElementById('csvFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</button>
                    </div>
                </div>

                <!-- é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆç¸¦ç©ã¿ï¼‰ -->
                <div id="selectedFilesList" class="selected-files-section" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <div style="font-weight:bold;font-size:14px;">é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ (<span id="fileCount">0</span>ä»¶)</div>
                        <div>
                            <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()" style="padding:6px 15px;font-size:11px;">ï¼‹è¿½åŠ </button>
                            <button class="btn" style="background:#ff5722;color:#fff;padding:6px 15px;font-size:11px;" onclick="clearSelectedFiles()">å…¨ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                    <div id="fileListContainer" class="file-list-vertical"></div>
                    <div style="margin-top:15px;">
                        <button class="btn btn-success" onclick="importAllCSVs()" id="importBtn" style="width:100%;padding:15px;font-size:16px;">ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                    </div>
                </div>

                <div id="importStatus" style="margin-top:10px;"></div>

                <!-- å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ãƒœã‚¿ãƒ³ -->
                <div style="margin-top:20px;padding-top:20px;border-top:2px solid #e0e0e0;">
                    <button class="btn" style="background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);color:#fff;padding:15px 30px;width:100%;font-size:16px;border-radius:8px;" onclick="showDataHistoryPage()">
                        ğŸ“‹ å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ã‚’è¦‹ã‚‹ (<span id="importedStoreCount">0</span>ä»¶)
                    </button>
                </div>

                <!-- æ¤œå‡ºçµæœè¡¨ç¤º -->
                <div class="info-bar" style="margin-top:15px;">
                    <div><span class="info-label">åº—èˆ—å:</span> <span class="info-value" id="detectedStore">-</span></div>
                    <div><span class="info-label">æ¤œå‡ºæœˆæ•°:</span> <span class="info-value" id="detectedMonthCount">-</span></div>
                    <div><span class="info-label">ãƒãƒƒãƒé …ç›®:</span> <span class="info-value" id="detectedItemCount">-</span></div>
                    <div><span class="info-label">æœªãƒãƒƒãƒé …ç›®:</span> <span class="info-value" id="unmatchedCount">-</span></div>
                </div>
            </div>

            <!-- åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ -->
            <div class="store-selector" id="storeSelector" style="display:none;">
                <label>è¡¨ç¤ºåº—èˆ—:</label>
                <select id="storeSelect" onchange="switchStore(this.value)">
                    <option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>
                </select>
                <div class="store-list" id="storeList"></div>
                <span style="margin-left:auto; font-size:10px; color:#666;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆ: <strong id="storeCount">0</strong>åº—èˆ—</span>
            </div>

            <!-- ãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚µãƒãƒªãƒ¼ -->
            <div class="section" style="margin-top:15px;">
                <div class="section-header header-mapping">ãƒãƒƒãƒ”ãƒ³ã‚°çµæœ</div>
                <div class="section-body">
                    <!-- ãƒãƒƒãƒçµæœã‚µãƒãƒªãƒ¼ -->
                    <div style="display:flex;gap:20px;align-items:center;margin-bottom:15px;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="background:#4caf50;color:#fff;padding:6px 15px;border-radius:20px;font-weight:bold;">
                                âœ“ ãƒãƒƒãƒ: <span id="matchedCountDisplay">0</span>ä»¶
                            </span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span id="unmatchedBadge" style="background:#f44336;color:#fff;padding:6px 15px;border-radius:20px;font-weight:bold;display:none;">
                                âœ— æœªãƒãƒƒãƒ: <span id="unmatchedCountDisplay">0</span>ä»¶
                            </span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span id="unusedBadge" style="background:#ff9800;color:#fff;padding:6px 15px;border-radius:20px;font-weight:bold;display:none;">
                                âš  æœªä½¿ç”¨: <span id="unusedCountDisplay">0</span>ä»¶
                            </span>
                        </div>
                    </div>

                    <!-- æœªãƒãƒƒãƒé …ç›®ï¼ˆã‚ã‚Œã°è¡¨ç¤ºï¼‰ -->
                    <div id="unmatchedSection" style="display:none;background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:15px;margin-bottom:15px;">
                        <h4 style="color:#856404;margin-bottom:10px;">âš ï¸ æœªãƒãƒƒãƒé …ç›®ï¼ˆCSVã«ã‚ã‚‹ãŒãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ãŒãªã„ï¼‰</h4>
                        <div id="unmatchedList" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                        <div id="similarSuggestions" style="margin-top:10px;"></div>
                        <div class="form-row" style="margin-top:15px;padding-top:15px;border-top:1px solid #ddd;">
                            <label>æ–°è¦ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ :</label>
                            <input type="text" id="newCode" placeholder="ã‚³ãƒ¼ãƒ‰" style="width:80px;">
                            <input type="text" id="newName" placeholder="é …ç›®å" style="width:120px;">
                            <input type="number" id="newV15No" placeholder="v15ç•ªå·" style="width:80px;">
                            <select id="newCategory">
                                <option value="å£²ä¸Š">å£²ä¸Š</option>
                                <option value="åŸä¾¡">åŸä¾¡</option>
                                <option value="å›ºå®šäººä»¶è²»">å›ºå®šäººä»¶è²»</option>
                                <option value="PAäººä»¶è²»">PAäººä»¶è²»</option>
                                <option value="çµŒè²»">çµŒè²»</option>
                                <option value="å›ºå®šè²»">å›ºå®šè²»</option>
                                <option value="åˆ©ç›Š">åˆ©ç›Š</option>
                            </select>
                            <button class="btn btn-success" onclick="addMapping()">è¿½åŠ </button>
                        </div>
                    </div>

                    <!-- æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚ã‚Œã°è¡¨ç¤ºï¼‰ -->
                    <div id="unusedSection" style="display:none;background:#fff8e1;border:2px solid #ff9800;border-radius:8px;padding:15px;margin-bottom:15px;">
                        <h4 style="color:#e65100;margin-bottom:10px;">âš ï¸ æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®šç¾©ã¯ã‚ã‚‹ãŒCSVã«å­˜åœ¨ã—ãªã„ï¼‰</h4>
                        <div id="unusedList" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                        <button class="btn btn-warning" style="margin-top:10px;" onclick="removeUnusedMappings()">æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤</button>
                    </div>

                    <!-- ãƒãƒƒãƒ”ãƒ³ã‚°ç®¡ç†ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:8px;">
                        <button class="btn btn-primary" onclick="toggleEditMode()">
                            <span id="editModeLabel">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
                        </button>
                        <label class="btn btn-info" style="cursor:pointer;margin:0;">
                            ğŸ“¥ ãƒãƒƒãƒ”ãƒ³ã‚°CSVèª­è¾¼
                            <input type="file" accept=".csv" onchange="importMappingCSV(event)" style="display:none;">
                        </label>
                        <button class="btn btn-secondary" onclick="exportMappingCSV()">ğŸ“¤ ãƒãƒƒãƒ”ãƒ³ã‚°CSVå‡ºåŠ›</button>
                        <button class="btn btn-warning" onclick="detectUnusedMappings()">ğŸ” æœªä½¿ç”¨æ¤œå‡º</button>
                    </div>

                    <!-- æŠ˜ã‚ŠãŸãŸã¿å¼ãƒãƒƒãƒ”ãƒ³ã‚°è©³ç´° -->
                    <details style="margin-top:10px;" id="mappingDetails">
                        <summary style="cursor:pointer;padding:10px;background:#f5f5f5;border-radius:4px;font-weight:bold;color:#666;">
                            ğŸ“‹ ãƒãƒƒãƒ”ãƒ³ã‚°è©³ç´°ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰
                        </summary>
                        <div id="mappingTable" style="margin-top:10px;"></div>
                    </details>
                </div>
            </div>

            <!-- äºˆç®—å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section" style="margin-top:15px;">
                <div class="section-header header-input">ã€1ã€‘é¡§å®¢äºˆç®—å…¥åŠ›ï¼ˆCSVå–è¾¼å€¤ï¼‰</div>
                <div class="section-body">
                    <table class="annual-table" id="inputTable"></table>
                </div>
            </div>

            <!-- å‡¦ç†ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section" style="margin-top:15px;">
                <div class="section-header" style="background:#455a64;color:#fff;">å‡¦ç†ãƒ­ã‚°</div>
                <div class="section-body">
                    <div id="preprocessLog" class="preprocess-log">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„</div>
                </div>
            </div>
        </div>

        <!-- ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ ===== -->
        <div id="page-export" class="main-page">
            <div class="import-section" style="border-left:4px solid #9c27b0;">
                <h2 style="color:#7b1fa2;font-size:18px;margin-bottom:20px;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>

                <!-- åº—èˆ—é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <h3 style="font-size:14px;color:#333;margin-bottom:12px;">å‡ºåŠ›å¯¾è±¡åº—èˆ—</h3>
                    <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <label style="font-weight:bold;font-size:12px;">åº—èˆ—é¸æŠ:</label>
                            <select id="exportStoreSelect" style="padding:8px 12px;border:2px solid #9c27b0;border-radius:4px;font-size:12px;min-width:200px;" onchange="updateExportStoreSelection()">
                                <option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>
                            </select>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
                            <input type="checkbox" id="exportAllStores" onchange="toggleExportAllStores()">
                            <span style="font-weight:bold;">å…¨åº—èˆ—ã‚’é¸æŠ</span>
                        </label>
                        <span id="exportSelectedCount" style="font-size:11px;color:#666;margin-left:auto;">é¸æŠä¸­: 0åº—èˆ—</span>
                    </div>
                </div>

                <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ -->
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:15px;">
                    <button class="btn" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportRakumyInputsCSV()">
                        <div style="font-size:32px;margin-bottom:10px;">ğŸ“Š</div>
                        <div style="font-weight:bold;">ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">è²»ç”¨äºˆç®—è¨­å®šç”¨ãƒ‡ãƒ¼ã‚¿</div>
                    </button>
                    <button class="btn" style="background:linear-gradient(135deg, #2196f3 0%, #1565c0 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportBudgetListCSV()">
                        <div style="font-size:32px;margin-bottom:10px;">ğŸ“‹</div>
                        <div style="font-weight:bold;">äºˆç®—ä¸€è¦§CSV</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">è©³ç´°äºˆç®—ãƒ‡ãƒ¼ã‚¿</div>
                    </button>
                    <button class="btn" style="background:linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportMQOutputCSV()">
                        <div style="font-size:32px;margin-bottom:10px;">ğŸ“ˆ</div>
                        <div style="font-weight:bold;">MQå‡ºåŠ›CSV</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">MQã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
                    </button>
                    <button class="btn" style="background:linear-gradient(135deg, #607d8b 0%, #37474f 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportAllConfig()">
                        <div style="font-size:32px;margin-bottom:10px;">âš™ï¸</div>
                        <div style="font-weight:bold;">è¨­å®šJSON</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãƒ‡ãƒ¼ã‚¿</div>
                    </button>
                </div>

                <!-- å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ãƒœã‚¿ãƒ³ -->
                <div style="margin-top:20px;padding-top:20px;border-top:2px solid #e0e0e0;">
                    <button class="btn" style="background:linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);color:#fff;padding:15px 30px;width:100%;font-size:16px;border-radius:8px;" onclick="showExportHistoryPage()">
                        ğŸ“‹ å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ (<span id="exportHistoryCount">0</span>ä»¶)
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ===== -->
        <div id="exportHistoryPage" class="data-history-page" style="display:none;">
            <div class="data-history-header" style="background:linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);">
                <h2>ğŸ“‹ å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§</h2>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-danger" onclick="clearAllExportHistory()">å…¨å±¥æ­´ã‚¯ãƒªã‚¢</button>
                    <button class="btn btn-secondary" onclick="hideExportHistoryPage()">âœ• é–‰ã˜ã‚‹</button>
                </div>
            </div>
            <div class="data-history-content">
                <div id="exportHistoryList" class="data-history-list"></div>
            </div>
        </div>

        <!-- ===== ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
        <div id="dataViewModal" class="data-view-modal" style="display:none;">
            <div class="data-view-overlay" onclick="hideDataViewModal()"></div>
            <div class="data-view-container">
                <div class="data-view-header">
                    <h3 id="dataViewTitle">ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h3>
                    <button class="btn btn-secondary" onclick="hideDataViewModal()">âœ• é–‰ã˜ã‚‹</button>
                </div>
                <div class="data-view-body" id="dataViewContent"></div>
            </div>
        </div>

        <!-- ===== äºˆç®—è¨­å®šãƒšãƒ¼ã‚¸ ===== -->
        <div id="page-budget" class="main-page">
            <!-- å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼ -->
            <div class="all-stores-summary" id="allStoresSummary" style="display:none;">
                <h3>å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼</h3>
                <div class="all-stores-grid" id="allStoresGrid"></div>
            </div>

            <!-- æœˆåˆ—æ¤œå‡ºçµæœ -->
            <div class="column-detection" id="columnDetection" style="display:none;">
                <h3>æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—æ¤œå‡ºçµæœï¼ˆ3è¡Œç›®:æœˆå + 4è¡Œç›®:ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ ã®ç…§åˆï¼‰</h3>
                <div class="month-cols-grid" id="monthColsGrid"></div>
                <div class="sample-values" id="sampleValues"></div>
            </div>

            <!-- ã‚µãƒ–ã‚¿ãƒ– -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('tab-calc')">ã€2ã€‘å…¥åŠ›å‰æ¼”ç®—</div>
                <div class="tab" onclick="showTab('tab-rakumy')">ã€3ã€‘ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤</div>
                <div class="tab" onclick="showTab('tab-output')">ã€4ã€‘MQå‡ºåŠ›</div>
                <div class="tab" onclick="showTab('tab-budget-list')">ã€5ã€‘äºˆç®—ä¸€è¦§</div>
                <div class="tab" onclick="showTab('tab-summary')">ã€6ã€‘ã‚µãƒãƒªãƒ¼</div>
            </div>

        <!-- å…¥åŠ›å‰æ¼”ç®—ã‚¿ãƒ– -->
        <div id="tab-calc" class="tab-content active">
            <div class="section">
                <div class="section-header header-calc">ã€2ã€‘å…¥åŠ›å‰æ¼”ç®—çµæœ</div>
                <div class="section-body">
                    <table class="annual-table" id="calcTable"></table>
                </div>
            </div>
        </div>

        <!-- ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤ã‚¿ãƒ– -->
        <div id="tab-rakumy" class="tab-content">
            <div class="section">
                <div class="section-header header-rakumy">ã€3ã€‘ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤</div>
                <div class="section-body">
                    <!-- å¤‰æ›ã‚¿ã‚¤ãƒ—å‡¡ä¾‹ -->
                    <div class="transform-legend">
                        <span>å¤‰æ›ã‚¿ã‚¤ãƒ—:</span>
                        <span><span class="type-direct">ç›´æ¥</span> é¡§å®¢äºˆç®—ã‚’ãã®ã¾ã¾è»¢è¨˜</span>
                        <span><span class="type-sum">åˆè¨ˆ</span> è¤‡æ•°é …ç›®ã‚’åˆç®—</span>
                        <span><span class="type-rate">ç‡</span> å£²ä¸Šã«å¯¾ã™ã‚‹ç‡ã‚’è¨ˆç®—</span>
                        <span><span class="type-input">å…¥åŠ›</span> ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤</span>
                        <span><span class="type-output">å‡ºåŠ›</span> MQè¨ˆç®—ã§ç®—å‡ºï¼ˆå…¥åŠ›ä¸å¯ï¼‰</span>
                    </div>

                    <!-- è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- 29é …ç›® -->
                    <div class="rakumy-category cost">
                        <h4>è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- 29é …ç›®ï¼ˆå¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</h4>
                        <table class="annual-table" id="rakumyCostTable"></table>
                    </div>

                    <!-- å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- 28é …ç›® -->
                    <div class="rakumy-category monthly">
                        <h4>å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- 28é …ç›®ï¼ˆæœˆåˆ¥èª¿æ•´ç”¨ã€åœ°ä»£å®¶è³ƒé™¤ãï¼‰</h4>
                        <table class="annual-table" id="rakumyMonthlyTable"></table>
                    </div>

                    <!-- äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰- MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
                    <div class="rakumy-category budget">
                        <h4>äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰</h4>
                        <table class="annual-table" id="rakumyBudgetTable"></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MQå‡ºåŠ›ã‚¿ãƒ– -->
        <div id="tab-output" class="tab-content">
            <div class="section">
                <div class="section-header header-output">ã€4ã€‘MQã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡ºåŠ›</div>
                <div class="section-body">
                    <table class="annual-table" id="outputTable"></table>
                </div>
            </div>
        </div>

        <!-- äºˆç®—ä¸€è¦§ã‚¿ãƒ– -->
        <div id="tab-budget-list" class="tab-content">
            <div class="section">
                <div class="section-header" style="background:linear-gradient(135deg, #1a237e 0%, #4a148c 100%);color:#fff;">ã€5ã€‘äºˆç®—ä¸€è¦§ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœï¼‰</div>
                <div class="section-body">
                    <table class="annual-table" id="budgetListTable"></table>
                </div>
            </div>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼ã‚¿ãƒ– -->
        <div id="tab-summary" class="tab-content">
            <div class="section">
                <div class="section-header header-summary">ã€6ã€‘ã‚µãƒãƒªãƒ¼</div>
                <div class="section-body" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 20px;">
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>
            </div>
            <div class="section">
                <div class="section-header" style="background:#f5f5f5;">è²»ç”¨è¨­å®šåˆ¤å®šçµæœ</div>
                <div class="section-body" id="judgmentResults"></div>
            </div>
        </div>
        </div><!-- äºˆç®—è¨­å®šãƒšãƒ¼ã‚¸çµ‚äº† -->

        <!-- ===== å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ===== -->
        <div id="dataHistoryPage" class="data-history-page" style="display:none;">
            <div class="data-history-header">
                <h2>ğŸ“‹ å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§</h2>
                <button class="btn btn-secondary" onclick="hideDataHistoryPage()">âœ• é–‰ã˜ã‚‹</button>
            </div>
            <div class="data-history-content">
                <div id="dataHistoryList" class="data-history-list"></div>
            </div>
        </div>
    </div>

    <script>
        // å®šæ•°
        var CALENDAR_MONTHS = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        var FISCAL_ORDER = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        var activeMonths = [];
        var monthLabels = [];
        var budgetColumnPositions = []; // å„æœˆã®ã€Œäºˆç®—ã€åˆ—ä½ç½®
        var monthDetectionResults = []; // æœˆæ¤œå‡ºçµæœï¼ˆè¡¨ç¤ºç”¨ï¼‰
        var firstDataCol = 5;
        var preprocessLog = [];
        var storeName = '';
        var annualData = {};
        var calcResults = {};
        var rakumyInputs = {};
        var mqOutputs = {};
        var judgments = {};
        var matchedItems = [];
        var unmatchedItems = [];
        var csvLines = []; // ãƒ‡ãƒãƒƒã‚°ç”¨

        // â˜… è¤‡æ•°åº—èˆ—å¯¾å¿œ
        var allStoresData = {}; // { storeName: { annualData, calcResults, rakumyInputs, mqOutputs, judgments, matchedItems, unmatchedItems, activeMonths, monthLabels } }
        var currentStoreName = '';
        var selectedFiles = []; // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¾¤

        // è¨­å®šãƒ‡ãƒ¼ã‚¿
        var CUSTOMER_CODE_MAP = {
            '810': { v15No: 2, name: 'åº—èˆ—å£²ä¸Šé«˜ï¼ˆãƒ•ãƒ¼ãƒ‰ï¼‰', category: 'å£²ä¸Š' },
            '811': { v15No: 3, name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š', category: 'å£²ä¸Š' },
            '812': { v15No: 4, name: 'ãã®ä»–å£²ä¸Šé«˜', category: 'å£²ä¸Š' },
            '999': { v15No: 5, name: 'å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰', category: 'å£²ä¸Š' },
            '461': { v15No: 6, name: 'é£Ÿæä»•å…¥é«˜', category: 'åŸä¾¡' },
            '462': { v15No: 7, name: 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜', category: 'åŸä¾¡' },
            '501': { v15No: 10, name: 'çµ¦æ–™æ‰‹å½“', category: 'å›ºå®šäººä»¶è²»' },
            '509': { v15No: 13, name: 'é›‘çµ¦ï¼ˆPAï¼‰', category: 'PAäººä»¶è²»' },
            '503': { v15No: 14, name: 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»', category: 'PAäººä»¶è²»' },
            '504': { v15No: 15, name: 'æ³•å®šç¦åˆ©è²»', category: 'å›ºå®šäººä»¶è²»' },
            '508': { v15No: 16, name: 'é€šå‹¤äº¤é€šè²»', category: 'å›ºå®šäººä»¶è²»' },
            '506': { v15No: 17, name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥', category: 'å›ºå®šäººä»¶è²»' },
            '553': { v15No: 18, name: 'ç¤¾å®…å®¶è³ƒ', category: 'å›ºå®šäººä»¶è²»' },
            '2105': { v15No: 19, name: 'ä¼‘æ¥­æ‰‹å½“', category: 'å›ºå®šäººä»¶è²»' },
            '510': { v15No: 21, name: 'è²©å£²ä¿ƒé€²è²»', category: 'çµŒè²»' },
            '541': { v15No: 22, name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', category: 'çµŒè²»' },
            '516': { v15No: 23, name: 'èª¿æŸ»è²»', category: 'çµŒè²»' },
            '514': { v15No: 24, name: 'è¡›ç”Ÿè²»', category: 'çµŒè²»' },
            '542': { v15No: 25, name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', category: 'çµŒè²»' },
            '520': { v15No: 26, name: 'é›»æ°—ä»£', category: 'çµŒè²»' },
            '521': { v15No: 27, name: 'ã‚¬ã‚¹ä»£', category: 'çµŒè²»' },
            '522': { v15No: 28, name: 'æ°´é“ä»£', category: 'çµŒè²»' },
            '523': { v15No: 29, name: 'æ¶ˆè€—å“è²»', category: 'çµŒè²»' },
            '526': { v15No: 30, name: 'ä¿å®ˆä¿®ç¹•è²»', category: 'çµŒè²»' },
            '527': { v15No: 31, name: 'ç§Ÿç¨å…¬èª²', category: 'çµŒè²»' },
            '529': { v15No: 32, name: 'æ¥å¾…äº¤éš›è²»', category: 'çµŒè²»' },
            '530': { v15No: 33, name: 'æ—…è²»äº¤é€šè²»', category: 'çµŒè²»' },
            '531': { v15No: 34, name: 'é€šä¿¡è²»', category: 'çµŒè²»' },
            '5321': { v15No: 35, name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', category: 'çµŒè²»' },
            '532': { v15No: 36, name: 'æ”¯æ‰•æ‰‹æ•°æ–™', category: 'çµŒè²»' },
            '533': { v15No: 37, name: 'ä¼šè­°è²»', category: 'çµŒè²»' },
            '534': { v15No: 38, name: 'è«¸ä¼šè²»', category: 'çµŒè²»' },
            '536': { v15No: 39, name: 'å›³æ›¸æ•™è‚²è²»', category: 'çµŒè²»' },
            '546': { v15No: 40, name: 'ç ”ä¿®è²»', category: 'çµŒè²»' },
            '537': { v15No: 41, name: 'æ¥­æ…‹ç ”ç©¶è²»', category: 'çµŒè²»' },
            '518': { v15No: 42, name: 'æ¡ç”¨è²»', category: 'çµŒè²»' },
            '550': { v15No: 43, name: 'ITè²»', category: 'çµŒè²»' },
            '2128': { v15No: 44, name: 'å¤–æ³¨è²»', category: 'çµŒè²»' },
            '539': { v15No: 45, name: 'é›‘è²»', category: 'çµŒè²»' },
            '528': { v15No: 46, name: 'æ¸›ä¾¡å„Ÿå´è²»', category: 'å›ºå®šè²»' },
            '554': { v15No: 47, name: 'å®¶è³ƒ', category: 'å›ºå®šè²»' },
            '552': { v15No: 48, name: 'è­¦å‚™æ–™', category: 'å›ºå®šè²»' },
            '5241': { v15No: 49, name: 'ãƒªãƒ¼ã‚¹æ–™', category: 'å›ºå®šè²»' },
            '524': { v15No: 50, name: 'è³ƒå€Ÿæ–™', category: 'å›ºå®šè²»' },
            '9640': { v15No: 60, name: 'åº—èˆ—å–¶æ¥­åˆ©ç›Š', category: 'åˆ©ç›Š' }
        };

        // â˜… è¨ˆç®—ãƒ«ãƒ¼ãƒ«ï¼ˆé¡§å®¢äºˆç®— â†’ ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›ã¸ã®å¤‰æ›ï¼‰
        var CALC_RULES = {
            // === åŸä¾¡ç³»ï¼ˆç‡è¨ˆç®—ï¼‰ ===
            'FDä»•å…¥è²»': { type: 'sum', items: [6, 7], desc: 'é£ŸæåŸä¾¡+ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡' },
            'FDä»•å…¥è²»ç‡': { type: 'rate', numerator: 'FDä»•å…¥è²»', denominator: 'item:5', desc: 'FDä»•å…¥è²»Ã·å£²ä¸Šé«˜Ã—100' },

            // === äººä»¶è²»ç³»ï¼ˆåˆè¨ˆãƒ»ç‡è¨ˆç®—ï¼‰ ===
            'å›ºå®šäººä»¶è²»åˆè¨ˆ': { type: 'sum', items: [10, 15, 16, 17, 18, 19], desc: 'çµ¦æ–™æ‰‹å½“+æ³•å®šç¦åˆ©è²»+é€šå‹¤äº¤é€šè²»+è³ä¸å¼•å½“é‡‘+ç¤¾å®…å®¶è³ƒ+ä¼‘æ¥­æ‰‹å½“' },
            'PAäººä»¶è²»åˆè¨ˆ': { type: 'sum', items: [13, 14], desc: 'é›‘çµ¦PA+ãƒ˜ãƒ«ãƒ—äººä»¶è²»' },
            'PAäººä»¶è²»ç‡': { type: 'rate', numerator: 'PAäººä»¶è²»åˆè¨ˆ', denominator: 'item:5', desc: 'PAäººä»¶è²»Ã·å£²ä¸Šé«˜Ã—100' },

            // === å›ºå®šè²»ç³»ï¼ˆåˆè¨ˆï¼‰ ===
            'åœ°ä»£å®¶è³ƒåˆè¨ˆ': { type: 'sum', items: [47, 50], desc: 'å®¶è³ƒ+è³ƒå€Ÿæ–™' },
            'è³‡æè²»åˆè¨ˆ': { type: 'sum', items: [48, 49], desc: 'è­¦å‚™æ–™+ãƒªãƒ¼ã‚¹æ–™' },

            // === çµŒè²»ç³»ï¼ˆåˆè¨ˆï¼‰ ===
            'æ°´é“å…‰ç†±è²»åˆè¨ˆ': { type: 'sum', items: [26, 27, 28], desc: 'é›»æ°—ä»£+ã‚¬ã‚¹ä»£+æ°´é“ä»£' },
            'è²©ç®¡è²»åˆè¨ˆ': { type: 'sum', items: [21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45], desc: 'å…¨çµŒè²»åˆè¨ˆ' },

            // === å£²ä¸Šæ¯”ç‡ï¼ˆç‡è¨ˆç®—ï¼‰ ===
            'ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'item:2', denominator: 'item:5', desc: 'ãƒ•ãƒ¼ãƒ‰å£²ä¸ŠÃ·å£²ä¸Šé«˜Ã—100' },
            'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'item:3', denominator: 'item:5', desc: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸ŠÃ·å£²ä¸Šé«˜Ã—100' },
            'ãã®ä»–å£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'item:4', denominator: 'item:5', desc: 'ãã®ä»–å£²ä¸ŠÃ·å£²ä¸Šé«˜Ã—100' },
            // ãƒ©ãƒ³ãƒãƒ»ãƒ‡ã‚£ãƒŠãƒ¼æ¯”ç‡ï¼ˆé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã«ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
            'ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡': { type: 'default', value: 40, desc: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ40%' },
            'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡': { type: 'default', value: 60, desc: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60%' },

            // === å›ºå®šè²»åˆè¨ˆï¼ˆMQè¨ˆç®—ç”¨ï¼‰ ===
            'å›ºå®šè²»åˆè¨ˆ': { type: 'sum', items: [46, 47, 48, 49, 50, 10, 15, 16, 17, 18, 19, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45], desc: 'å…¨å›ºå®šè²»' }
        };

        var ITEMS = {
            2: { name: 'ãƒ•ãƒ¼ãƒ‰å£²ä¸Š', category: 'å£²ä¸Š' },
            3: { name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š', category: 'å£²ä¸Š' },
            4: { name: 'ãã®ä»–å£²ä¸Š', category: 'å£²ä¸Š' },
            5: { name: 'å£²ä¸Šé«˜åˆè¨ˆ', category: 'å£²ä¸Š' },
            6: { name: 'é£ŸæåŸä¾¡', category: 'åŸä¾¡' },
            7: { name: 'ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡', category: 'åŸä¾¡' },
            10: { name: 'çµ¦æ–™æ‰‹å½“', category: 'å›ºå®šäººä»¶è²»' },
            13: { name: 'é›‘çµ¦ï¼ˆPAï¼‰', category: 'PAäººä»¶è²»' },
            14: { name: 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»', category: 'PAäººä»¶è²»' },
            15: { name: 'æ³•å®šç¦åˆ©è²»', category: 'å›ºå®šäººä»¶è²»' },
            16: { name: 'é€šå‹¤äº¤é€šè²»', category: 'å›ºå®šäººä»¶è²»' },
            17: { name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥', category: 'å›ºå®šäººä»¶è²»' },
            18: { name: 'ç¤¾å®…å®¶è³ƒ', category: 'å›ºå®šäººä»¶è²»' },
            19: { name: 'ä¼‘æ¥­æ‰‹å½“', category: 'å›ºå®šäººä»¶è²»' },
            21: { name: 'è²©å£²ä¿ƒé€²è²»', category: 'çµŒè²»' },
            22: { name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', category: 'çµŒè²»' },
            23: { name: 'èª¿æŸ»è²»', category: 'çµŒè²»' },
            24: { name: 'è¡›ç”Ÿè²»', category: 'çµŒè²»' },
            25: { name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', category: 'çµŒè²»' },
            26: { name: 'é›»æ°—ä»£', category: 'çµŒè²»' },
            27: { name: 'ã‚¬ã‚¹ä»£', category: 'çµŒè²»' },
            28: { name: 'æ°´é“ä»£', category: 'çµŒè²»' },
            29: { name: 'æ¶ˆè€—å“è²»', category: 'çµŒè²»' },
            30: { name: 'ä¿å®ˆä¿®ç¹•è²»', category: 'çµŒè²»' },
            31: { name: 'ç§Ÿç¨å…¬èª²', category: 'çµŒè²»' },
            32: { name: 'æ¥å¾…äº¤éš›è²»', category: 'çµŒè²»' },
            33: { name: 'æ—…è²»äº¤é€šè²»', category: 'çµŒè²»' },
            34: { name: 'é€šä¿¡è²»', category: 'çµŒè²»' },
            35: { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', category: 'çµŒè²»' },
            36: { name: 'æ”¯æ‰•æ‰‹æ•°æ–™', category: 'çµŒè²»' },
            37: { name: 'ä¼šè­°è²»', category: 'çµŒè²»' },
            38: { name: 'è«¸ä¼šè²»', category: 'çµŒè²»' },
            39: { name: 'å›³æ›¸æ•™è‚²è²»', category: 'çµŒè²»' },
            40: { name: 'ç ”ä¿®è²»', category: 'çµŒè²»' },
            41: { name: 'æ¥­æ…‹ç ”ç©¶è²»', category: 'çµŒè²»' },
            42: { name: 'æ¡ç”¨è²»', category: 'çµŒè²»' },
            43: { name: 'ITè²»', category: 'çµŒè²»' },
            44: { name: 'å¤–æ³¨è²»', category: 'çµŒè²»' },
            45: { name: 'é›‘è²»', category: 'çµŒè²»' },
            46: { name: 'æ¸›ä¾¡å„Ÿå´è²»', category: 'å›ºå®šè²»' },
            47: { name: 'å®¶è³ƒ', category: 'å›ºå®šè²»' },
            48: { name: 'è­¦å‚™æ–™', category: 'å›ºå®šè²»' },
            49: { name: 'ãƒªãƒ¼ã‚¹æ–™', category: 'å›ºå®šè²»' },
            50: { name: 'è³ƒå€Ÿæ–™', category: 'å›ºå®šè²»' },
            60: { name: 'åº—èˆ—å–¶æ¥­åˆ©ç›Š', category: 'åˆ©ç›Š' }
        };

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function fmt(n) { return n !== undefined && n !== null ? Math.round(n).toLocaleString('ja-JP') : '-'; }
        function fmtRate(n) { return n !== undefined && n !== null ? n.toFixed(1) : '-'; }

        function addLog(msg, type) {
            var cssClass = 'log-' + (type || 'info');
            var prefix = { info: '[INFO] ', warn: '[WARN] ', error: '[ERROR] ', success: '[OK] ', data: '  â†’ ', month: '[æœˆ] ' }[type] || '';
            preprocessLog.push('<span class="' + cssClass + '">' + prefix + escapeHtml(msg) + '</span>');
        }

        function escapeHtml(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ/äºˆç®—è¨­å®š/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰åˆ‡ã‚Šæ›¿ãˆ
        function showMainPage(page) {
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.main-nav-tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            // ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.main-page').forEach(function(p) {
                p.classList.remove('active');
            });
            // é¸æŠã—ãŸã‚¿ãƒ–ã¨ãƒšãƒ¼ã‚¸ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (page === 'import') {
                document.querySelector('.import-tab').classList.add('active');
                document.getElementById('page-import').classList.add('active');
            } else if (page === 'budget') {
                document.querySelector('.budget-tab').classList.add('active');
                document.getElementById('page-budget').classList.add('active');
            } else if (page === 'export') {
                document.querySelector('.export-tab').classList.add('active');
                document.getElementById('page-export').classList.add('active');
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');

            var files = event.dataTransfer.files;
            if (files.length > 0) {
                addFilesToSelection(Array.from(files));
            }
        }

        function handleFileSelect(event) {
            var newFiles = Array.from(event.target.files);
            if (newFiles.length > 0) {
                addFilesToSelection(newFiles);
            }
            // å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«ã™ã‚‹ï¼‰
            event.target.value = '';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠãƒªã‚¹ãƒˆã«è¿½åŠ 
        function addFilesToSelection(newFiles) {
            newFiles.forEach(function(newFile) {
                // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è¿½åŠ 
                if (!newFile.name.toLowerCase().endsWith('.csv')) {
                    showStatus('error', newFile.name + ' ã¯CSVãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                var exists = selectedFiles.some(function(f) { return f.name === newFile.name && f.size === newFile.size; });
                if (!exists) {
                    selectedFiles.push(newFile);
                }
            });
            updateFileListDisplay();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆç¸¦ç©ã¿ï¼‰
        function updateFileListDisplay() {
            var container = document.getElementById('fileListContainer');
            var listSection = document.getElementById('selectedFilesList');
            var fileCount = document.getElementById('fileCount');
            var dropZone = document.getElementById('dropZone');

            if (selectedFiles.length === 0) {
                listSection.style.display = 'none';
                dropZone.style.display = 'block';
                return;
            }

            listSection.style.display = 'block';
            dropZone.style.display = 'none';
            fileCount.textContent = selectedFiles.length;

            var html = '';
            selectedFiles.forEach(function(file, index) {
                html += '<div class="file-item">';
                html += '  <div class="file-info">';
                html += '    <span class="file-icon">ğŸ“„</span>';
                html += '    <span class="file-name" title="' + escapeHtml(file.name) + '">' + escapeHtml(file.name) + '</span>';
                html += '    <span class="file-size">' + formatFileSize(file.size) + '</span>';
                html += '  </div>';
                html += '  <button class="remove-btn" onclick="removeSelectedFile(' + index + ')">å‰Šé™¤</button>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        function removeSelectedFile(index) {
            selectedFiles.splice(index, 1);
            updateFileListDisplay();
        }

        // é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
        function clearSelectedFiles() {
            selectedFiles = [];
            updateFileListDisplay();
        }

        // =====================
        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§æ©Ÿèƒ½
        // =====================

        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
        function showDataHistoryPage() {
            document.getElementById('dataHistoryPage').style.display = 'block';
            document.body.style.overflow = 'hidden'; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ–
            renderDataHistoryList();
        }

        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’éè¡¨ç¤º
        function hideDataHistoryPage() {
            document.getElementById('dataHistoryPage').style.display = 'none';
            document.body.style.overflow = ''; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ–
        }

        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ã‚’æç”»
        function renderDataHistoryList() {
            var container = document.getElementById('dataHistoryList');
            var storeNames = Object.keys(allStoresData);

            if (storeNames.length === 0) {
                container.innerHTML = '<div class="empty-message" style="background:#fff;border-radius:10px;padding:50px;">å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }

            var html = '';
            storeNames.forEach(function(name) {
                var data = allStoresData[name];
                var totalSales = 0;
                var totalProfit = 0;
                var monthCount = 0;
                if (data.mqOutputs) {
                    for (var m = 0; m < 12; m++) {
                        if (data.mqOutputs[m]) {
                            totalSales += data.mqOutputs[m].sales || 0;
                            totalProfit += data.mqOutputs[m].operatingProfit || 0;
                            monthCount++;
                        }
                    }
                }
                var profitRate = totalSales > 0 ? (totalProfit / totalSales * 100).toFixed(1) : 0;

                html += '<div class="history-data-item">';
                html += '  <div class="item-info">';
                html += '    <div class="item-name">ğŸª ' + escapeHtml(name) + '</div>';
                html += '    <div class="item-meta">';
                html += '      <span>ğŸ“… ' + monthCount + 'ãƒ¶æœˆåˆ†</span>';
                html += '      <span>ğŸ’° å¹´é–“å£²ä¸Š: ' + fmt(totalSales) + 'åƒå††</span>';
                html += '      <span>ğŸ“ˆ å–¶æ¥­åˆ©ç›Š: ' + fmt(totalProfit) + 'åƒå†† (' + profitRate + '%)</span>';
                html += '    </div>';
                html += '  </div>';
                html += '  <div class="item-actions">';
                html += '    <button class="btn-view" onclick="viewAndCloseHistory(\'' + escapeJs(name) + '\')">è¡¨ç¤º</button>';
                html += '    <button class="btn-save" onclick="saveStoreWithDateTime(\'' + escapeJs(name) + '\')">ä¿å­˜</button>';
                html += '    <button class="btn-delete" onclick="deleteStoreFromHistory(\'' + escapeJs(name) + '\')">å‰Šé™¤</button>';
                html += '  </div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // JavaScriptç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeJs(str) {
            return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // è¡¨ç¤ºã—ã¦å±¥æ­´ç”»é¢ã‚’é–‰ã˜ã‚‹
        function viewAndCloseHistory(name) {
            hideDataHistoryPage();
            switchStore(name);
        }

        // å¹´æœˆæ—¥æ™‚åˆ»_åº—å å½¢å¼ã§ä¿å­˜
        function saveStoreWithDateTime(name) {
            if (!allStoresData[name]) {
                alert('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            var sec = ('0' + now.getSeconds()).slice(-2);
            var saveName = y + m + d + h + min + sec + '_' + name;

            var history = loadHistory();

            var newEntry = {
                id: Date.now().toString(),
                title: saveName,
                dateTime: y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec,
                storeNames: [name],
                storeCount: 1,
                data: { [name]: JSON.parse(JSON.stringify(allStoresData[name])) },
                savedAt: now.toISOString()
            };

            history.unshift(newEntry);
            if (history.length > 50) history = history.slice(0, 50);

            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                showStatus('success', 'ä¿å­˜ã—ã¾ã—ãŸ: ' + saveName);
                renderHistoryList();
                alert('ä¿å­˜å®Œäº†: ' + saveName);
            } catch (e) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            }
        }

        // å±¥æ­´ç”»é¢ã‹ã‚‰åº—èˆ—ã‚’å‰Šé™¤
        function deleteStoreFromHistory(name) {
            if (!confirm('ã€Œ' + name + 'ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            delete allStoresData[name];

            if (currentStoreName === name) {
                var remaining = Object.keys(allStoresData);
                if (remaining.length > 0) {
                    switchStore(remaining[0]);
                } else {
                    currentStoreName = '';
                }
            }

            updateStoreSelector();
            updateDataCounts();
            renderDataHistoryList();
            showStatus('info', 'ã€Œ' + name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’æ›´æ–°
        function updateDataCounts() {
            var count = Object.keys(allStoresData).length;
            document.getElementById('importedStoreCount').textContent = count;
            updateExportStoreSelect(); // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨åº—èˆ—ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
        }

        // ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ç®¡ç† =====
        var EXPORT_HISTORY_KEY = 'rakumy_export_history';
        var exportHistory = [];

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
        function showExportHistoryPage() {
            document.getElementById('exportHistoryPage').style.display = 'block';
            document.body.style.overflow = 'hidden';
            renderExportHistoryList();
        }

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’éè¡¨ç¤º
        function hideExportHistoryPage() {
            document.getElementById('exportHistoryPage').style.display = 'none';
            document.body.style.overflow = '';
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨åº—èˆ—é¸æŠãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateExportStoreSelect() {
            var select = document.getElementById('exportStoreSelect');
            if (!select) return;

            var storeNames = Object.keys(allStoresData);
            var currentValue = select.value;

            select.innerHTML = '<option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>';
            storeNames.forEach(function(name) {
                var opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });

            if (storeNames.indexOf(currentValue) >= 0) {
                select.value = currentValue;
            }

            updateExportSelectedCount();
        }

        // åº—èˆ—é¸æŠå¤‰æ›´æ™‚
        function updateExportStoreSelection() {
            document.getElementById('exportAllStores').checked = false;
            updateExportSelectedCount();
        }

        // å…¨åº—èˆ—é¸æŠãƒˆã‚°ãƒ«
        function toggleExportAllStores() {
            var checkbox = document.getElementById('exportAllStores');
            var select = document.getElementById('exportStoreSelect');
            if (checkbox.checked) {
                select.value = '';
            }
            updateExportSelectedCount();
        }

        // é¸æŠåº—èˆ—æ•°ã‚’æ›´æ–°
        function updateExportSelectedCount() {
            var checkbox = document.getElementById('exportAllStores');
            var select = document.getElementById('exportStoreSelect');
            var countSpan = document.getElementById('exportSelectedCount');

            var count = 0;
            if (checkbox && checkbox.checked) {
                count = Object.keys(allStoresData).length;
            } else if (select && select.value) {
                count = 1;
            }

            if (countSpan) {
                countSpan.textContent = 'é¸æŠä¸­: ' + count + 'åº—èˆ—';
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡åº—èˆ—ã‚’å–å¾—
        function getExportTargetStores() {
            var checkbox = document.getElementById('exportAllStores');
            var select = document.getElementById('exportStoreSelect');

            if (checkbox && checkbox.checked) {
                return Object.keys(allStoresData);
            } else if (select && select.value) {
                return [select.value];
            } else if (currentStoreName) {
                return [currentStoreName];
            }
            return Object.keys(allStoresData);
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadExportHistory() {
            try {
                var data = localStorage.getItem(EXPORT_HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                return [];
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ã‚’ä¿å­˜
        function saveExportHistory(history) {
            try {
                localStorage.setItem(EXPORT_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('Export history save failed:', e);
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ã«è¿½åŠ 
        function addToExportHistory(exportType, storeNames, data) {
            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            var sec = ('0' + now.getSeconds()).slice(-2);

            var storeName = storeNames.length === 1 ? storeNames[0] : storeNames.length + 'åº—èˆ—';
            var saveName = y + m + d + h + min + sec + '_' + storeName + '_' + exportType;

            var history = loadExportHistory();

            var entry = {
                id: Date.now().toString(),
                title: saveName,
                exportType: exportType,
                storeNames: storeNames,
                storeCount: storeNames.length,
                dateTime: y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec,
                data: data,
                savedAt: now.toISOString()
            };

            history.unshift(entry);
            if (history.length > 100) history = history.slice(0, 100);

            saveExportHistory(history);
            updateExportHistoryCount();
            return saveName;
        }

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä»¶æ•°ã‚’æ›´æ–°
        function updateExportHistoryCount() {
            var history = loadExportHistory();
            var countSpan = document.getElementById('exportHistoryCount');
            if (countSpan) {
                countSpan.textContent = history.length;
            }
        }

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ã‚’æç”»
        function renderExportHistoryList() {
            var container = document.getElementById('exportHistoryList');
            var history = loadExportHistory();

            if (history.length === 0) {
                container.innerHTML = '<div class="empty-message" style="background:#fff;border-radius:10px;padding:50px;">å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã¨å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>';
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªå®šç¾©
            var categories = [
                { key: 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV', label: 'ğŸ“Š ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV', color: '#4caf50', bgColor: '#e8f5e9' },
                { key: 'äºˆç®—ä¸€è¦§CSV', label: 'ğŸ“‹ äºˆç®—ä¸€è¦§CSV', color: '#2196f3', bgColor: '#e3f2fd' },
                { key: 'MQå‡ºåŠ›CSV', label: 'ğŸ“ˆ MQå‡ºåŠ›CSV', color: '#9c27b0', bgColor: '#f3e5f5' },
                { key: 'è¨­å®šJSON', label: 'âš™ï¸ è¨­å®šJSON', color: '#607d8b', bgColor: '#eceff1' }
            ];

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            var grouped = {};
            categories.forEach(function(cat) { grouped[cat.key] = []; });
            history.forEach(function(entry) {
                if (grouped[entry.exportType]) {
                    grouped[entry.exportType].push(entry);
                }
            });

            var html = '';

            categories.forEach(function(cat) {
                var items = grouped[cat.key];
                if (items.length === 0) return;

                html += '<div class="export-category-section" style="margin-bottom:25px;">';
                html += '  <div class="export-category-header" style="display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:' + cat.bgColor + ';border-left:4px solid ' + cat.color + ';border-radius:8px;margin-bottom:12px;">';
                html += '    <h3 style="margin:0;font-size:16px;color:' + cat.color + ';">' + cat.label + '</h3>';
                html += '    <span style="background:' + cat.color + ';color:#fff;padding:4px 12px;border-radius:15px;font-size:12px;font-weight:bold;">' + items.length + 'ä»¶</span>';
                html += '  </div>';
                html += '  <div class="export-category-items" style="display:flex;flex-direction:column;gap:10px;">';

                items.forEach(function(entry) {
                    var storeInfo = entry.storeCount === 1 ? entry.storeNames[0] : entry.storeCount + 'åº—èˆ—';

                    html += '<div class="history-data-item" style="border-left:3px solid ' + cat.color + ';">';
                    html += '  <div class="item-info">';
                    html += '    <div class="item-name" style="color:' + cat.color + ';">' + escapeHtml(storeInfo) + '</div>';
                    html += '    <div class="item-meta">';
                    html += '      <span>ğŸ“… ' + entry.dateTime + '</span>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '  <div class="item-actions">';
                    html += '    <button class="btn-view" onclick="viewExportHistoryItem(\'' + entry.id + '\')">è¡¨ç¤º</button>';
                    html += '    <button class="btn-save" onclick="downloadExportHistoryItem(\'' + entry.id + '\')">ä¿å­˜</button>';
                    html += '    <button class="btn-delete" onclick="deleteExportHistoryItem(\'' + entry.id + '\')">å‰Šé™¤</button>';
                    html += '  </div>';
                    html += '</div>';
                });

                html += '  </div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // å±¥æ­´ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadExportHistoryItem(id) {
            var history = loadExportHistory();
            var entry = history.find(function(h) { return h.id === id; });
            if (!entry) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            var filename = entry.title;
            var data = entry.data;
            var mimeType = 'text/csv;charset=utf-8;';
            var ext = '.csv';

            if (entry.exportType === 'è¨­å®šJSON') {
                mimeType = 'application/json;charset=utf-8;';
                ext = '.json';
                data = JSON.stringify(entry.data, null, 2);
            }

            if (!filename.endsWith(ext)) {
                filename += ext;
            }

            var blob = new Blob([data], { type: mimeType });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        function viewExportHistoryItem(id) {
            var history = loadExportHistory();
            var entry = history.find(function(h) { return h.id === id; });
            if (!entry) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            showDataViewModal(entry);
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDataViewModal(entry) {
            var modal = document.getElementById('dataViewModal');
            var title = document.getElementById('dataViewTitle');
            var content = document.getElementById('dataViewContent');

            title.textContent = entry.title;

            // CSVãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            var data = entry.data || '';
            // BOMã‚’é™¤å»
            if (data.charCodeAt(0) === 0xFEFF) {
                data = data.substring(1);
            }
            var lines = data.split('\n');
            var html = '<table class="data-view-table">';
            var isFirstDataRow = true;
            lines.forEach(function(line) {
                if (!line.trim()) return;
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã€ã€‘ã§å§‹ã¾ã‚‹è¡Œï¼‰
                var trimmedLine = line.trim();
                if (trimmedLine.indexOf('ã€') === 0) return;
                // æœ€åˆã®ã‚»ãƒ«ãŒç©ºã§ã‚¿ã‚¤ãƒˆãƒ«ã£ã½ã„è¡Œã‚‚ã‚¹ã‚­ãƒƒãƒ—
                var cells = line.split(',');
                if (cells.length > 1 && !cells[0].trim() && cells[1].trim().indexOf('ã€') === 0) return;

                var tag = isFirstDataRow ? 'th' : 'td';
                html += '<tr>';
                cells.forEach(function(cell) {
                    html += '<' + tag + '>' + escapeHtml(cell) + '</' + tag + '>';
                });
                html += '</tr>';
                isFirstDataRow = false;
            });
            html += '</table>';

            content.innerHTML = html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function hideDataViewModal() {
            var modal = document.getElementById('dataViewModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        // å±¥æ­´ã‹ã‚‰å‰Šé™¤
        function deleteExportHistoryItem(id) {
            if (!confirm('ã“ã®å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            var history = loadExportHistory();
            history = history.filter(function(h) { return h.id !== id; });
            saveExportHistory(history);
            renderExportHistoryList();
            updateExportHistoryCount();
            showStatus('info', 'å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å…¨å±¥æ­´ã‚¯ãƒªã‚¢
        function clearAllExportHistory() {
            if (!confirm('å…¨ã¦ã®å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            saveExportHistory([]);
            renderExportHistoryList();
            updateExportHistoryCount();
            showStatus('info', 'å…¨ã¦ã®å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // â˜… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†æ™‚ã«å…¨åº—èˆ—ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆ
        function generateExportDataForAllStores() {
            var storeNames = Object.keys(allStoresData);
            if (storeNames.length === 0) return;

            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            var sec = ('0' + now.getSeconds()).slice(-2);
            var dateTimeStr = y + m + d + h + min + sec;
            var dateTimeDisplay = y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec;

            var history = loadExportHistory();

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            storeNames.forEach(function(name) {
                var storeData = allStoresData[name];
                if (!storeData) return;

                // ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                var rakumyData = generateRakumyInputData(name, storeData);
                var mqData = generateMQOutputData(name, storeData);

                // ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤ã‚’å±¥æ­´ã«è¿½åŠ 
                var rakumyEntry = {
                    id: Date.now().toString() + '_rakumy_' + name,
                    title: dateTimeStr + '_' + name + '_ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤',
                    exportType: 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV',
                    storeNames: [name],
                    storeCount: 1,
                    dateTime: dateTimeDisplay,
                    data: rakumyData,
                    savedAt: now.toISOString()
                };
                history.unshift(rakumyEntry);

                // MQå‡ºåŠ›ã‚’å±¥æ­´ã«è¿½åŠ 
                var mqEntry = {
                    id: Date.now().toString() + '_mq_' + name,
                    title: dateTimeStr + '_' + name + '_MQå‡ºåŠ›',
                    exportType: 'MQå‡ºåŠ›CSV',
                    storeNames: [name],
                    storeCount: 1,
                    dateTime: dateTimeDisplay,
                    data: mqData,
                    savedAt: now.toISOString()
                };
                history.unshift(mqEntry);
            });

            // å±¥æ­´ã‚’ä¿å­˜ï¼ˆæœ€å¤§100ä»¶ï¼‰
            if (history.length > 100) history = history.slice(0, 100);
            saveExportHistory(history);
            updateExportHistoryCount();
        }

        // ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generateRakumyInputData(storeName, storeData) {
            var csv = [];
            var BOM = '\uFEFF';
            var stActiveMonths = storeData.activeMonths || [];
            var labels = storeData.monthLabels || [];
            var stRakumyInputs = storeData.rakumyInputs || {};

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            var header = ['åº—èˆ—å', 'ã‚»ã‚¯ã‚·ãƒ§ãƒ³', 'é …ç›®å', 'å¤‰æ›ã‚¿ã‚¤ãƒ—'];
            labels.forEach(function(label) { header.push(label); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            // æœˆåˆ¥å·®ç•°ãƒã‚§ãƒƒã‚¯
            function hasMonthlyVariation(key) {
                if (stActiveMonths.length < 2) return false;
                var firstVal = stRakumyInputs[0] ? (stRakumyInputs[0][key] || 0) : 0;
                for (var m = 1; m < stActiveMonths.length; m++) {
                    if (Math.abs((stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0) - firstVal) > 0.01) return true;
                }
                return false;
            }

            // === è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰===
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                if (item.category !== 'cost') continue;

                var hasDiff = hasMonthlyVariation(key);
                var row = [storeName, 'è²»ç”¨äºˆç®—è¨­å®š', item.name, item.type];

                if (hasDiff) {
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        row.push('å˜æœˆè¨­å®š');
                    }
                    row.push('-', '-');
                } else {
                    var val = stRakumyInputs[0] ? (stRakumyInputs[0][key] || 0) : 0;
                    var total = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        row.push(Math.round(val));
                        total += val;
                    }
                    row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                }
                csv.push(row.join(','));
            }

            // === å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰===
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                if (item.category !== 'monthly') continue;

                var baseKey = key.replace('m_', '');
                if (!hasMonthlyVariation(baseKey)) continue;

                var row = [storeName, 'å˜æœˆè²»ç”¨äºˆç®—', item.name, item.type];
                var total = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                    total += val;
                    row.push(Math.round(val));
                }
                row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                csv.push(row.join(','));
            }

            // === äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰===
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                if (item.category !== 'budget') continue;

                var isRate = item.type === 'rate' || key.indexOf('Ratio') > -1;
                var row = [storeName, 'äºˆç®—è¨­å®š', item.name, item.type];
                var total = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                    total += val;
                    row.push(isRate ? Math.round(val) + '%' : Math.round(val));
                }
                if (isRate) {
                    row.push('-', Math.round(total / stActiveMonths.length) + '%');
                } else {
                    row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                }
                csv.push(row.join(','));
            }

            return BOM + csv.join('\n');
        }

        // MQå‡ºåŠ›CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generateMQOutputData(storeName, storeData) {
            var csv = [];
            var BOM = '\uFEFF';
            var stActiveMonths = storeData.activeMonths || [];
            var labels = storeData.monthLabels || [];
            var stMqOutputs = storeData.mqOutputs || {};
            var stAnnualData = storeData.annualData || {};

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            var header = ['åº—èˆ—å', 'é …ç›®'];
            labels.forEach(function(label) { header.push(label); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            // MQé …ç›®
            var mqItems = [
                { key: 'customers', name: 'å®¢æ•°', isRate: false },
                { key: 'unitPrice', name: 'å®¢å˜ä¾¡', isRate: false },
                { key: 'sales', name: 'å£²ä¸Š', isRate: false },
                { key: 'variableCost', name: 'å¤‰å‹•è²»', isRate: false },
                { key: 'variableRate', name: 'å¤‰å‹•è²»ç‡', isRate: true },
                { key: 'grossProfit', name: 'ç²—åˆ©', isRate: false },
                { key: 'grossProfitRate', name: 'ç²—åˆ©ç‡', isRate: true },
                { key: 'fixedCost', name: 'å›ºå®šè²»', isRate: false },
                { key: 'operatingProfit', name: 'å–¶æ¥­åˆ©ç›Š', isRate: false },
                { key: 'operatingProfitRate', name: 'å–¶æ¥­åˆ©ç›Šç‡', isRate: true }
            ];

            mqItems.forEach(function(item) {
                var row = [storeName, item.name];
                var total = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stMqOutputs[m] ? (stMqOutputs[m][item.key] || 0) : 0;
                    total += val;
                    row.push(item.isRate ? val.toFixed(1) + '%' : Math.round(val));
                }
                if (item.isRate) {
                    row.push('-', (total / stActiveMonths.length).toFixed(1) + '%');
                } else {
                    row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                }
                csv.push(row.join(','));
            });

            // é¡§å®¢äºˆç®—å£²ä¸Š
            var budgetSalesRow = [storeName, 'é¡§å®¢äºˆç®—å£²ä¸Š'];
            var budgetSalesTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var val = stAnnualData[5] ? (stAnnualData[5][m] || 0) : 0;
                budgetSalesTotal += val;
                budgetSalesRow.push(Math.round(val));
            }
            budgetSalesRow.push(Math.round(budgetSalesTotal), Math.round(budgetSalesTotal / stActiveMonths.length));
            csv.push(budgetSalesRow.join(','));

            // å£²ä¸Šå·®ç•°
            var salesDiffRow = [storeName, 'å£²ä¸Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
            var salesDiffTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var mqSales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                var budgetSales = stAnnualData[5] ? (stAnnualData[5][m] || 0) : 0;
                var diff = mqSales - budgetSales;
                salesDiffTotal += diff;
                salesDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff));
            }
            salesDiffRow.push((salesDiffTotal >= 0 ? '+' : '') + Math.round(salesDiffTotal), '-');
            csv.push(salesDiffRow.join(','));

            // é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Š
            var budgetProfitRow = [storeName, 'é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Š'];
            var budgetProfitTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var val = stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0;
                budgetProfitTotal += val;
                budgetProfitRow.push(Math.round(val));
            }
            budgetProfitRow.push(Math.round(budgetProfitTotal), Math.round(budgetProfitTotal / stActiveMonths.length));
            csv.push(budgetProfitRow.join(','));

            // å–¶æ¥­åˆ©ç›Šå·®ç•°
            var profitDiffRow = [storeName, 'å–¶æ¥­åˆ©ç›Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
            var profitDiffTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var mqProfit = stMqOutputs[m] ? (stMqOutputs[m].operatingProfit || 0) : 0;
                var budgetProfit = stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0;
                var diff = mqProfit - budgetProfit;
                profitDiffTotal += diff;
                profitDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff));
            }
            profitDiffRow.push((profitDiffTotal >= 0 ? '+' : '') + Math.round(profitDiffTotal), '-');
            csv.push(profitDiffRow.join(','));

            return BOM + csv.join('\n');
        }

        // â˜… è¤‡æ•°CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importAllCSVs() {
            if (selectedFiles.length === 0) return;

            var filesToImport = selectedFiles.slice(); // ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
            var totalFiles = filesToImport.length;
            var importCount = 0;
            var errorCount = 0;

            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showStatus('info', totalFiles + 'ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');

            filesToImport.forEach(function(file, index) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        preprocessLog = [];
                        addLog('CSVãƒ•ã‚¡ã‚¤ãƒ« ' + (index + 1) + '/' + totalFiles + ': ' + file.name, 'info');
                        parseCustomerCSV(e.target.result);

                        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                        runSimulation();

                        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        saveCurrentStoreData();
                        importCount++;

                        addLog('åº—èˆ—ã€Œ' + storeName + 'ã€ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', 'success');
                    } catch (err) {
                        addLog('ã‚¨ãƒ©ãƒ¼ï¼ˆ' + file.name + 'ï¼‰: ' + err.message, 'error');
                        errorCount++;
                    }

                    // å…¨ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å®Œäº†
                    if (importCount + errorCount === totalFiles) {
                        updateStoreSelector();
                        renderAllStoresSummary();
                        updateDataCounts();

                        // æœ€åˆã®åº—èˆ—ã‚’é¸æŠ
                        var storeNames = Object.keys(allStoresData);
                        if (storeNames.length > 0 && !currentStoreName) {
                            switchStore(storeNames[0]);
                        }

                        document.getElementById('preprocessLog').innerHTML = preprocessLog.join('\n');
                        showStatus('success', importCount + 'åº—èˆ—ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†' + (errorCount > 0 ? 'ï¼ˆ' + errorCount + 'ä»¶ã‚¨ãƒ©ãƒ¼ï¼‰' : ''));

                        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†å¾Œã€è‡ªå‹•çš„ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                        generateExportDataForAllStores();

                        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†å¾Œã€é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
                        clearSelectedFiles();
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        // â˜… ç¾åœ¨ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveCurrentStoreData() {
            if (!storeName) return;

            allStoresData[storeName] = {
                annualData: JSON.parse(JSON.stringify(annualData)),
                calcResults: JSON.parse(JSON.stringify(calcResults)),
                rakumyInputs: JSON.parse(JSON.stringify(rakumyInputs)),
                mqOutputs: JSON.parse(JSON.stringify(mqOutputs)),
                judgments: JSON.parse(JSON.stringify(judgments)),
                matchedItems: JSON.parse(JSON.stringify(matchedItems)),
                unmatchedItems: JSON.parse(JSON.stringify(unmatchedItems)),
                activeMonths: activeMonths.slice(),
                monthLabels: monthLabels.slice(),
                budgetColumnPositions: JSON.parse(JSON.stringify(budgetColumnPositions)),
                monthDetectionResults: JSON.parse(JSON.stringify(monthDetectionResults))
            };
        }

        // â˜… åº—èˆ—åˆ‡ã‚Šæ›¿ãˆ
        function switchStore(name) {
            if (!name || !allStoresData[name]) return;

            currentStoreName = name;
            var data = allStoresData[name];

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å¾©å…ƒ
            storeName = name;
            annualData = data.annualData;
            calcResults = data.calcResults;
            rakumyInputs = data.rakumyInputs;
            mqOutputs = data.mqOutputs;
            judgments = data.judgments;
            matchedItems = data.matchedItems;
            unmatchedItems = data.unmatchedItems;
            activeMonths = data.activeMonths;
            monthLabels = data.monthLabels;
            budgetColumnPositions = data.budgetColumnPositions;
            monthDetectionResults = data.monthDetectionResults;

            // UIæ›´æ–°
            document.getElementById('storeSelect').value = name;
            document.getElementById('detectedStore').textContent = name;
            document.getElementById('detectedMonthCount').textContent = activeMonths.length + 'ãƒ¶æœˆ';
            document.getElementById('detectedItemCount').textContent = matchedItems.length + 'é …ç›®';
            document.getElementById('unmatchedCount').textContent = unmatchedItems.length + 'é …ç›®';

            // åº—èˆ—ãƒãƒƒãƒ—ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.store-chip').forEach(function(chip) {
                chip.classList.toggle('active', chip.dataset.store === name);
            });

            // ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»
            renderMappingTable();
            renderUnmatchedItems();
            renderMonthColsGrid();
            renderAllTables();

            showStatus('info', 'åº—èˆ—ã€Œ' + name + 'ã€ã‚’è¡¨ç¤ºä¸­');
        }

        // â˜… åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°
        function updateStoreSelector() {
            var storeNames = Object.keys(allStoresData);

            document.getElementById('storeSelector').style.display = storeNames.length > 0 ? 'flex' : 'none';
            document.getElementById('storeCount').textContent = storeNames.length;

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ›´æ–°
            var select = document.getElementById('storeSelect');
            select.innerHTML = '<option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>';
            storeNames.forEach(function(name) {
                var opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            if (currentStoreName) select.value = currentStoreName;

            // åº—èˆ—ãƒãƒƒãƒ—æ›´æ–°
            var listEl = document.getElementById('storeList');
            listEl.innerHTML = '';
            storeNames.forEach(function(name) {
                var chip = document.createElement('span');
                chip.className = 'store-chip' + (name === currentStoreName ? ' active' : '');
                chip.dataset.store = name;
                chip.innerHTML = name + '<span class="remove" onclick="removeStore(\'' + name.replace(/'/g, "\\'") + '\', event)">&times;</span>';
                chip.onclick = function() { switchStore(name); };
                listEl.appendChild(chip);
            });
        }

        // â˜… åº—èˆ—å‰Šé™¤
        function removeStore(name, event) {
            event.stopPropagation();
            if (!confirm('ã€Œ' + name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            delete allStoresData[name];

            if (currentStoreName === name) {
                currentStoreName = '';
                var remaining = Object.keys(allStoresData);
                if (remaining.length > 0) {
                    switchStore(remaining[0]);
                }
            }

            updateStoreSelector();
            renderAllStoresSummary();
        }

        // â˜… å…¨åº—èˆ—ã‚¯ãƒªã‚¢
        function clearAllStores() {
            if (!confirm('å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;

            allStoresData = {};
            currentStoreName = '';
            storeName = '';
            annualData = {};
            calcResults = {};
            rakumyInputs = {};
            mqOutputs = {};

            updateStoreSelector();
            updateDataCounts();
            document.getElementById('allStoresSummary').style.display = 'none';
            document.getElementById('importedDataSection').style.display = 'none';
            document.getElementById('exportDataSection').style.display = 'none';
            document.getElementById('detectedStore').textContent = '-';
            document.getElementById('detectedMonthCount').textContent = '-';
            document.getElementById('detectedItemCount').textContent = '-';
            document.getElementById('unmatchedCount').textContent = '-';

            showStatus('info', 'å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // â˜… ç¾åœ¨ã®åº—èˆ—ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function runSimulationForCurrentStore() {
            if (!currentStoreName) {
                showStatus('error', 'åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            runSimulation();
            saveCurrentStoreData(); // çµæœã‚’ä¿å­˜
            renderAllStoresSummary();
        }

        // â˜… å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼æç”»
        function renderAllStoresSummary() {
            var storeNames = Object.keys(allStoresData);
            if (storeNames.length === 0) {
                document.getElementById('allStoresSummary').style.display = 'none';
                return;
            }

            document.getElementById('allStoresSummary').style.display = 'block';

            var totalSales = 0, totalProfit = 0, totalCustomers = 0;
            var cardsHtml = '';

            storeNames.forEach(function(name) {
                var data = allStoresData[name];
                var storeSales = 0, storeProfit = 0, storeCustomers = 0;

                if (data.mqOutputs) {
                    for (var m in data.mqOutputs) {
                        storeSales += data.mqOutputs[m].sales || 0;
                        storeProfit += data.mqOutputs[m].operatingProfit || 0;
                        storeCustomers += data.mqOutputs[m].customers || 0;
                    }
                }

                totalSales += storeSales;
                totalProfit += storeProfit;
                totalCustomers += storeCustomers;

                var profitRate = storeSales > 0 ? (storeProfit / storeSales * 100) : 0;

                cardsHtml += '<div class="store-card' + (name === currentStoreName ? ' active' : '') + '" onclick="switchStore(\'' + name.replace(/'/g, "\\'") + '\')">';
                cardsHtml += '<h4>' + name + '</h4>';
                cardsHtml += '<div class="metric"><span>å¹´é–“å£²ä¸Š</span><span class="metric-value">' + fmt(storeSales) + ' åƒå††</span></div>';
                cardsHtml += '<div class="metric"><span>å¹´é–“å–¶æ¥­åˆ©ç›Š</span><span class="metric-value">' + fmt(storeProfit) + ' åƒå††</span></div>';
                cardsHtml += '<div class="metric"><span>å–¶æ¥­åˆ©ç›Šç‡</span><span class="metric-value">' + fmtRate(profitRate) + '%</span></div>';
                cardsHtml += '<div class="metric"><span>å¹´é–“å®¢æ•°</span><span class="metric-value">' + fmt(storeCustomers) + ' äºº</span></div>';
                cardsHtml += '</div>';
            });

            // åˆè¨ˆã‚«ãƒ¼ãƒ‰
            var totalProfitRate = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
            cardsHtml += '<div class="store-card total">';
            cardsHtml += '<h4>å…¨åº—èˆ—åˆè¨ˆ</h4>';
            cardsHtml += '<div class="metric"><span>å¹´é–“å£²ä¸Šåˆè¨ˆ</span><span class="metric-value">' + fmt(totalSales) + ' åƒå††</span></div>';
            cardsHtml += '<div class="metric"><span>å¹´é–“å–¶æ¥­åˆ©ç›Šåˆè¨ˆ</span><span class="metric-value">' + fmt(totalProfit) + ' åƒå††</span></div>';
            cardsHtml += '<div class="metric"><span>å¹³å‡å–¶æ¥­åˆ©ç›Šç‡</span><span class="metric-value">' + fmtRate(totalProfitRate) + '%</span></div>';
            cardsHtml += '<div class="metric"><span>å¹´é–“å®¢æ•°åˆè¨ˆ</span><span class="metric-value">' + fmt(totalCustomers) + ' äºº</span></div>';
            cardsHtml += '</div>';

            document.getElementById('allStoresGrid').innerHTML = cardsHtml;
        }

        function showStatus(type, msg) {
            var el = document.getElementById('importStatus');
            el.className = 'status-bar status-' + type;
            el.textContent = msg;
            el.style.display = 'block';
        }

        // CSVãƒ‘ãƒ¼ã‚µãƒ¼
        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseCustomNumber(str) {
            if (!str || str === '-' || str === '' || str === '#N/A' || str === '#DIV/0!') return 0;
            var s = String(str).trim().replace(/"/g, '');
            var isNegative = s.charAt(0) === '(' && s.charAt(s.length - 1) === ')';
            if (isNegative) s = s.substring(1, s.length - 1);
            s = s.replace(/[\s,]/g, '').replace(/%/g, '');
            var num = parseFloat(s);
            if (isNaN(num)) return 0;
            return isNegative ? -num : num;
        }

        function extractItemCode(fullCode) {
            var str = String(fullCode).trim();
            if (str.length >= 6) return str.substring(3);
            return str;
        }

        function isNumericOrEmpty(str) {
            if (!str || str.trim() === '') return true;
            var s = str.trim();
            if (s === '#N/A' || s === '#DIV/0!' || s === '#REF!' || s === '#VALUE!' || s === '-') return true;
            var cleaned = s.replace(/[,\s"()%]/g, '');
            return !isNaN(parseFloat(cleaned));
        }

        function extractItemNameFromCols(cols, endCol) {
            var nameParts = [];
            var scanEnd = Math.min(endCol, cols.length);
            for (var i = 1; i < scanEnd; i++) {
                var val = cols[i] ? cols[i].trim() : '';
                if (val && val.length > 0 && !isNumericOrEmpty(val)) {
                    nameParts.push({ col: i, value: val });
                }
            }
            var primaryName = nameParts.length > 0 ? nameParts[nameParts.length - 1].value : '';
            var hierarchy = nameParts.map(function(p) { return p.value; }).join(' > ');
            return { name: primaryName, hierarchy: hierarchy };
        }

        // â˜… æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—ã®æ­£ç¢ºãªæ¤œå‡º
        function detectBudgetColumns(lines) {
            if (lines.length < 4) return [];

            var row2 = parseCSVLine(lines[2]); // æœˆåè¡Œï¼ˆ3è¡Œç›®ï¼‰
            var row3 = parseCSVLine(lines[3]); // ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ4è¡Œç›®ï¼‰

            addLog('=== æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—ã®æ¤œå‡ºé–‹å§‹ ===', 'info');
            addLog('3è¡Œç›®ï¼ˆæœˆåè¡Œï¼‰åˆ—æ•°: ' + row2.length, 'data');
            addLog('4è¡Œç›®ï¼ˆã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼‰åˆ—æ•°: ' + row3.length, 'data');

            // ã¾ãšã€ã™ã¹ã¦ã®æœˆåã®ä½ç½®ã‚’æ¤œå‡º
            var monthNamePositions = [];
            for (var i = 0; i < row2.length; i++) {
                var cell = row2[i].trim();
                if (CALENDAR_MONTHS.indexOf(cell) >= 0) {
                    monthNamePositions.push({ month: cell, col: i });
                }
            }

            addLog('æœˆåæ¤œå‡º: ' + monthNamePositions.length + 'å€‹', 'info');

            // å„æœˆã«ã¤ã„ã¦ã€ã€Œäºˆç®—ã€åˆ—ã‚’æ¢ã™
            var results = [];
            monthDetectionResults = [];

            for (var mi = 0; mi < monthNamePositions.length; mi++) {
                var monthInfo = monthNamePositions[mi];
                var month = monthInfo.month;
                var monthCol = monthInfo.col;

                // ã“ã®æœˆã®ç¯„å›²ï¼ˆæ¬¡ã®æœˆã®æ‰‹å‰ã¾ã§ï¼‰
                var nextMonthCol = (mi < monthNamePositions.length - 1) ? monthNamePositions[mi + 1].col : row3.length;

                // 4è¡Œç›®ã§ã“ã®æœˆã®ç¯„å›²å†…ã®ã€Œäºˆç®—ã€ã‚’æ¢ã™
                var budgetCol = -1;
                var subHeaderAtMonthCol = row3[monthCol] ? row3[monthCol].trim() : '';

                // ã¾ãšæœˆåã®åˆ—ã®ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                if (subHeaderAtMonthCol === 'äºˆç®—') {
                    budgetCol = monthCol;
                    addLog(month + ': åˆ—' + monthCol + ' (ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼: ' + subHeaderAtMonthCol + ') â†’ OK', 'success');
                } else {
                    // æœˆåã®åˆ—ãŒã€Œäºˆç®—ã€ã§ãªã„å ´åˆã€ãã®æœˆã®ç¯„å›²å†…ã§ã€Œäºˆç®—ã€ã‚’æ¢ã™
                    addLog(month + ': åˆ—' + monthCol + ' ã®ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã€Œ' + subHeaderAtMonthCol + 'ã€ï¼ˆäºˆç®—ã§ã¯ãªã„ï¼‰', 'warn');

                    for (var j = monthCol; j < nextMonthCol && j < row3.length; j++) {
                        var subHeader = row3[j] ? row3[j].trim() : '';
                        if (subHeader === 'äºˆç®—') {
                            budgetCol = j;
                            addLog(month + ': åˆ—' + j + ' ã§ã€Œäºˆç®—ã€ã‚’ç™ºè¦‹', 'success');
                            break;
                        }
                    }

                    if (budgetCol === -1) {
                        // ã€Œäºˆç®—ã€ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœˆåã®åˆ—ã‚’ãã®ã¾ã¾ä½¿ç”¨
                        budgetCol = monthCol;
                        addLog(month + ': ã€Œäºˆç®—ã€åˆ—ãŒè¦‹ã¤ã‹ã‚‰ãšã€æœˆååˆ—(' + monthCol + ')ã‚’ä½¿ç”¨', 'warn');
                    }
                }

                var finalSubHeader = row3[budgetCol] ? row3[budgetCol].trim() : '';
                var status = finalSubHeader === 'äºˆç®—' ? 'ok' : (finalSubHeader ? 'warn' : 'error');

                results.push({
                    month: month,
                    budgetCol: budgetCol,
                    subHeader: finalSubHeader,
                    status: status
                });

                monthDetectionResults.push({
                    month: month,
                    budgetCol: budgetCol,
                    monthNameCol: monthCol,
                    subHeader: finalSubHeader,
                    status: status
                });
            }

            return results;
        }

        // æœˆåˆ—æ¤œå‡ºçµæœã®è¡¨ç¤º
        function renderMonthColsGrid() {
            document.getElementById('columnDetection').style.display = 'block';
            var grid = document.getElementById('monthColsGrid');

            var html = '';
            monthDetectionResults.forEach(function(r) {
                html += '<div class="month-col-card ' + r.status + '">';
                html += '<div class="month-name">' + r.month + '</div>';
                html += '<div class="col-info">åˆ—' + r.budgetCol + '</div>';
                html += '<div class="sub-header">' + (r.subHeader || '(ç©º)') + '</div>';
                html += '</div>';
            });

            grid.innerHTML = html;

            // ã‚µãƒ³ãƒ—ãƒ«å€¤ã®è¡¨ç¤º
            if (csvLines.length > 5) {
                var sampleHtml = '<h4>å£²ä¸Šé«˜åˆè¨ˆ(999)ã®ã‚µãƒ³ãƒ—ãƒ«å€¤</h4><table class="mapping-table sample-table"><tr><th>æœˆ</th>';
                monthDetectionResults.forEach(function(r) {
                    sampleHtml += '<th>' + r.month + '</th>';
                });
                sampleHtml += '</tr><tr><td>åˆ—ä½ç½®</td>';
                monthDetectionResults.forEach(function(r) {
                    sampleHtml += '<td>åˆ—' + r.budgetCol + '</td>';
                });
                sampleHtml += '</tr><tr><td>å€¤</td>';

                // å£²ä¸Šé«˜åˆè¨ˆã®è¡Œã‚’æ¢ã™
                var sampleRow = null;
                for (var i = 4; i < csvLines.length; i++) {
                    var cols = parseCSVLine(csvLines[i]);
                    var code = extractItemCode(cols[0] || '');
                    if (code === '999') {
                        sampleRow = cols;
                        break;
                    }
                }

                if (sampleRow) {
                    monthDetectionResults.forEach(function(r) {
                        var val = sampleRow[r.budgetCol] || '';
                        var parsed = parseCustomNumber(val);
                        sampleHtml += '<td>' + fmt(parsed) + '</td>';
                    });
                } else {
                    monthDetectionResults.forEach(function() {
                        sampleHtml += '<td>-</td>';
                    });
                }

                sampleHtml += '</tr></table>';
                document.getElementById('sampleValues').innerHTML = sampleHtml;
            }
        }

        // ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ 
        function addMapping() {
            var code = document.getElementById('newCode').value.trim();
            var name = document.getElementById('newName').value.trim();
            var v15No = parseInt(document.getElementById('newV15No').value);
            var category = document.getElementById('newCategory').value;

            if (!code || !name || isNaN(v15No)) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            CUSTOMER_CODE_MAP[code] = { v15No: v15No, name: name, category: category };
            ITEMS[v15No] = { name: name, category: category };

            document.getElementById('newCode').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newV15No').value = '';

            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ : ' + code + ' â†’ [' + v15No + '] ' + name);

            if (document.getElementById('csvFile').files[0]) {
                importCSV();
            }
        }

        function quickAddMapping(code, name) {
            document.getElementById('newCode').value = code;
            document.getElementById('newName').value = name;
            var usedNos = Object.values(CUSTOMER_CODE_MAP).map(function(m) { return m.v15No; });
            for (var i = 51; i <= 100; i++) {
                if (usedNos.indexOf(i) < 0) {
                    document.getElementById('newV15No').value = i;
                    break;
                }
            }
        }

        function deleteMapping(code) {
            if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                delete CUSTOMER_CODE_MAP[code];
                renderMappingTable();
            }
        }

        function renderMappingTable() {
            var html = '<table class="mapping-table">';

            if (isEditMode) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šå…¨ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã‚’è¡¨ç¤º
                html += '<tr><th>ã‚³ãƒ¼ãƒ‰</th><th>é …ç›®å</th><th>v15 No</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ“ä½œ</th></tr>';

                var codes = Object.keys(CUSTOMER_CODE_MAP).sort(function(a, b) {
                    return CUSTOMER_CODE_MAP[a].v15No - CUSTOMER_CODE_MAP[b].v15No;
                });

                codes.forEach(function(code) {
                    var item = CUSTOMER_CODE_MAP[code];
                    var isEditing = (editingCode === code);

                    if (isEditing) {
                        // ç·¨é›†ä¸­ã®è¡Œ
                        html += '<tr style="background:#fff3cd;">';
                        html += '<td><strong>' + code + '</strong></td>';
                        html += '<td><input type="text" id="edit_name_' + code + '" value="' + item.name + '" style="width:150px;padding:3px;"></td>';
                        html += '<td><input type="number" id="edit_v15no_' + code + '" value="' + item.v15No + '" style="width:60px;padding:3px;"></td>';
                        html += '<td><select id="edit_category_' + code + '" style="padding:3px;">';
                        ['å£²ä¸Š', 'åŸä¾¡', 'å›ºå®šäººä»¶è²»', 'PAäººä»¶è²»', 'çµŒè²»', 'å›ºå®šè²»', 'åˆ©ç›Š'].forEach(function(cat) {
                            html += '<option value="' + cat + '"' + (item.category === cat ? ' selected' : '') + '>' + cat + '</option>';
                        });
                        html += '</select></td>';
                        html += '<td>';
                        html += '<button class="btn btn-success" style="padding:2px 8px;font-size:9px;margin-right:3px;" onclick="saveEditMapping(\'' + code + '\')">ä¿å­˜</button>';
                        html += '<button class="btn btn-secondary" style="padding:2px 8px;font-size:9px;" onclick="cancelEditMapping()">å–æ¶ˆ</button>';
                        html += '</td></tr>';
                    } else {
                        // é€šå¸¸è¡¨ç¤ºã®è¡Œ
                        html += '<tr>';
                        html += '<td><strong>' + code + '</strong></td>';
                        html += '<td>' + item.name + '</td>';
                        html += '<td>' + item.v15No + '</td>';
                        html += '<td><span style="background:#e0e0e0;padding:2px 6px;border-radius:3px;font-size:10px;">' + item.category + '</span></td>';
                        html += '<td>';
                        html += '<button class="btn btn-primary" style="padding:2px 8px;font-size:9px;margin-right:3px;" onclick="editMapping(\'' + code + '\')">ç·¨é›†</button>';
                        html += '<button class="btn btn-danger" style="padding:2px 8px;font-size:9px;" onclick="deleteMapping(\'' + code + '\')">å‰Šé™¤</button>';
                        html += '</td></tr>';
                    }
                });
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒƒãƒã—ãŸé …ç›®ã®ã¿è¡¨ç¤º
                html += '<tr><th>ã‚³ãƒ¼ãƒ‰</th><th>é …ç›®å</th><th>â†’</th><th>v15 No</th><th>v15é …ç›®å</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th></th></tr>';
                if (matchedItems && matchedItems.length > 0) {
                    matchedItems.forEach(function(item) {
                        html += '<tr><td>' + item.code + '</td><td>' + item.name + '</td><td style="color:#28a745;">â†’</td>';
                        html += '<td>' + item.v15No + '</td><td>' + item.v15Name + '</td><td>' + item.category + '</td>';
                        html += '<td><button class="btn btn-danger" style="padding:2px 6px;font-size:9px;" onclick="deleteMapping(\'' + item.code + '\')">å‰Šé™¤</button></td></tr>';
                    });
                } else {
                    html += '<tr><td colspan="7" style="text-align:center;color:#666;padding:20px;">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ãƒãƒƒãƒã—ãŸé …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</td></tr>';
                }
            }

            html += '</table>';

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ä»¶æ•°ã‚’è¡¨ç¤º
            if (isEditMode) {
                html += '<div style="margin-top:10px;font-size:11px;color:#666;">å…¨ ' + Object.keys(CUSTOMER_CODE_MAP).length + ' ä»¶ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©</div>';
            }

            document.getElementById('mappingTable').innerHTML = html;
        }

        function renderUnmatchedItems() {
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
            var matchedCount = matchedItems ? matchedItems.length : 0;
            var unmatchedCount = unmatchedItems ? unmatchedItems.length : 0;

            var matchedDisplay = document.getElementById('matchedCountDisplay');
            var unmatchedDisplay = document.getElementById('unmatchedCountDisplay');
            var unmatchedBadge = document.getElementById('unmatchedBadge');

            if (matchedDisplay) matchedDisplay.textContent = matchedCount;
            if (unmatchedDisplay) unmatchedDisplay.textContent = unmatchedCount;

            // æœªãƒãƒƒãƒãƒãƒƒã‚¸ã®è¡¨ç¤º/éè¡¨ç¤º
            if (unmatchedBadge) {
                unmatchedBadge.style.display = unmatchedCount > 0 ? 'inline-block' : 'none';
            }

            // æœªãƒãƒƒãƒã‚»ã‚¯ã‚·ãƒ§ãƒ³
            var section = document.getElementById('unmatchedSection');
            if (unmatchedCount === 0) {
                if (section) section.style.display = 'none';
                return;
            }

            if (section) section.style.display = 'block';

            // æœªãƒãƒƒãƒé …ç›®ã‚’ãƒãƒƒãƒ—å½¢å¼ã§è¡¨ç¤º
            var html = '';
            unmatchedItems.forEach(function(item) {
                html += '<div style="display:inline-flex;align-items:center;gap:5px;background:#fff;border:1px solid #ffc107;border-radius:20px;padding:5px 12px;font-size:11px;">';
                html += '<span style="font-weight:bold;color:#856404;">' + item.code + '</span>';
                html += '<span style="color:#666;">' + (item.name || '(åç§°ãªã—)') + '</span>';
                html += '<button style="background:#17a2b8;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer;" onclick="quickAddMapping(\'' + item.code + '\', \'' + (item.name || '').replace(/'/g, "\\'") + '\')">+è¿½åŠ </button>';
                html += '</div>';
            });

            var listEl = document.getElementById('unmatchedList');
            if (listEl) listEl.innerHTML = html;

            // é¡ä¼¼ãƒãƒƒãƒãƒ³ã‚°å€™è£œã‚’è¡¨ç¤º
            renderSimilarSuggestions();
        }

        // â˜… ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        var isEditMode = false;

        function toggleEditMode() {
            isEditMode = !isEditMode;
            var label = document.getElementById('editModeLabel');
            if (label) {
                label.textContent = isEditMode ? 'âœ… ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
            }
            renderMappingTable();

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ONæ™‚ã¯ãƒãƒƒãƒ”ãƒ³ã‚°è©³ç´°ã‚’è‡ªå‹•å±•é–‹
            if (isEditMode) {
                var details = document.getElementById('mappingDetails');
                if (details) details.open = true;
            }

            showStatus('info', isEditMode ? 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ' : 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸ');
        }

        // â˜… ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†é–‹å§‹
        var editingCode = null;

        function editMapping(code) {
            editingCode = code;
            renderMappingTable();
        }

        function cancelEditMapping() {
            editingCode = null;
            renderMappingTable();
        }

        function saveEditMapping(code) {
            var nameInput = document.getElementById('edit_name_' + code);
            var v15NoInput = document.getElementById('edit_v15no_' + code);
            var categorySelect = document.getElementById('edit_category_' + code);

            if (!nameInput || !v15NoInput || !categorySelect) return;

            var newName = nameInput.value.trim();
            var newV15No = parseInt(v15NoInput.value);
            var newCategory = categorySelect.value;

            if (!newName || isNaN(newV15No)) {
                alert('é …ç›®åã¨v15ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            CUSTOMER_CODE_MAP[code] = {
                v15No: newV15No,
                name: newName,
                category: newCategory
            };
            ITEMS[newV15No] = { name: newName, category: newCategory };

            editingCode = null;
            renderMappingTable();
            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ' + code);
        }

        // â˜… ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importMappingCSV(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var lines = content.split('\n');
                var importCount = 0;
                var errorCount = 0;

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ€åˆã®è¡Œï¼‰
                for (var i = 1; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line) continue;

                    var cols = line.split(',');
                    if (cols.length < 4) {
                        errorCount++;
                        continue;
                    }

                    var code = cols[0].trim();
                    var name = cols[1].trim();
                    var v15No = parseInt(cols[2].trim());
                    var category = cols[3].trim();

                    if (!code || !name || isNaN(v15No)) {
                        errorCount++;
                        continue;
                    }

                    CUSTOMER_CODE_MAP[code] = { v15No: v15No, name: name, category: category };
                    ITEMS[v15No] = { name: name, category: category };
                    importCount++;
                }

                renderMappingTable();
                showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ: ' + importCount + 'ä»¶' + (errorCount > 0 ? 'ï¼ˆã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶ï¼‰' : ''));

                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = '';
            };
            reader.readAsText(file, 'UTF-8');
        }

        // â˜… ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportMappingCSV() {
            var csv = [];
            var BOM = '\uFEFF';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            csv.push('ã‚³ãƒ¼ãƒ‰,é …ç›®å,v15ç•ªå·,ã‚«ãƒ†ã‚´ãƒª');

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            for (var code in CUSTOMER_CODE_MAP) {
                var item = CUSTOMER_CODE_MAP[code];
                csv.push([code, item.name, item.v15No, item.category].join(','));
            }

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();

            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // â˜… æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œå‡º
        var unusedMappings = [];

        function detectUnusedMappings() {
            unusedMappings = [];

            // CSVã«å­˜åœ¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’åé›†
            var usedCodes = {};
            if (matchedItems) {
                matchedItems.forEach(function(item) {
                    usedCodes[item.code] = true;
                });
            }

            // å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒCSVã«å­˜åœ¨ã—ãªã„ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º
            for (var code in CUSTOMER_CODE_MAP) {
                if (!usedCodes[code]) {
                    unusedMappings.push({
                        code: code,
                        name: CUSTOMER_CODE_MAP[code].name,
                        v15No: CUSTOMER_CODE_MAP[code].v15No,
                        category: CUSTOMER_CODE_MAP[code].category
                    });
                }
            }

            // è¡¨ç¤ºæ›´æ–°
            var unusedBadge = document.getElementById('unusedBadge');
            var unusedDisplay = document.getElementById('unusedCountDisplay');
            var unusedSection = document.getElementById('unusedSection');

            if (unusedBadge) {
                unusedBadge.style.display = unusedMappings.length > 0 ? 'inline-block' : 'none';
            }
            if (unusedDisplay) {
                unusedDisplay.textContent = unusedMappings.length;
            }

            if (unusedMappings.length === 0) {
                if (unusedSection) unusedSection.style.display = 'none';
                showStatus('success', 'æœªä½¿ç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (unusedSection) unusedSection.style.display = 'block';

            // æœªä½¿ç”¨é …ç›®ã‚’ãƒãƒƒãƒ—å½¢å¼ã§è¡¨ç¤º
            var html = '';
            unusedMappings.forEach(function(item) {
                html += '<div style="display:inline-flex;align-items:center;gap:5px;background:#fff;border:1px solid #ff9800;border-radius:20px;padding:5px 12px;font-size:11px;">';
                html += '<span style="font-weight:bold;color:#e65100;">' + item.code + '</span>';
                html += '<span style="color:#666;">' + item.name + '</span>';
                html += '<button style="background:#dc3545;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer;" onclick="deleteSingleUnused(\'' + item.code + '\')">å‰Šé™¤</button>';
                html += '</div>';
            });

            var listEl = document.getElementById('unusedList');
            if (listEl) listEl.innerHTML = html;

            showStatus('warning', 'æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ¤œå‡ºã—ã¾ã—ãŸ: ' + unusedMappings.length + 'ä»¶');
        }

        function deleteSingleUnused(code) {
            if (confirm('ãƒãƒƒãƒ”ãƒ³ã‚°ã€Œ' + code + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                delete CUSTOMER_CODE_MAP[code];
                detectUnusedMappings();
                renderMappingTable();
            }
        }

        function removeUnusedMappings() {
            if (unusedMappings.length === 0) {
                alert('æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!confirm(unusedMappings.length + 'ä»¶ã®æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            unusedMappings.forEach(function(item) {
                delete CUSTOMER_CODE_MAP[item.code];
            });

            unusedMappings = [];
            detectUnusedMappings();
            renderMappingTable();
            showStatus('success', 'æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // â˜… é¡ä¼¼é …ç›®ãƒãƒƒãƒãƒ³ã‚°
        function findSimilarItems(targetName) {
            var suggestions = [];
            var targetLower = targetName.toLowerCase();

            for (var code in CUSTOMER_CODE_MAP) {
                var item = CUSTOMER_CODE_MAP[code];
                var nameLower = item.name.toLowerCase();

                // å®Œå…¨ä¸€è‡´ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´ã‚’ãƒã‚§ãƒƒã‚¯
                if (nameLower.indexOf(targetLower) >= 0 || targetLower.indexOf(nameLower) >= 0) {
                    suggestions.push({
                        code: code,
                        name: item.name,
                        v15No: item.v15No,
                        category: item.category,
                        matchType: 'partial'
                    });
                }
            }

            // ãƒ©ã‚¯ãƒŸãƒ¼é …ç›®ã‹ã‚‰ã‚‚å€™è£œã‚’æ¤œç´¢
            for (var key in RAKUMY_ITEMS) {
                var rakumyItem = RAKUMY_ITEMS[key];
                if (!rakumyItem.name) continue;
                var rakumyLower = rakumyItem.name.toLowerCase();

                if (rakumyLower.indexOf(targetLower) >= 0 || targetLower.indexOf(rakumyLower) >= 0) {
                    // æ—¢ã«å€™è£œã«ãªã„ã‹ç¢ºèª
                    var exists = suggestions.some(function(s) { return s.name === rakumyItem.name; });
                    if (!exists) {
                        suggestions.push({
                            code: null,
                            name: rakumyItem.name,
                            v15No: null,
                            category: rakumyItem.category || 'ä¸æ˜',
                            matchType: 'rakumy'
                        });
                    }
                }
            }

            return suggestions.slice(0, 5); // æœ€å¤§5ä»¶
        }

        function renderSimilarSuggestions() {
            var container = document.getElementById('similarSuggestions');
            if (!container || !unmatchedItems || unmatchedItems.length === 0) {
                if (container) container.innerHTML = '';
                return;
            }

            var html = '<div style="background:#e3f2fd;border-radius:8px;padding:10px;margin-top:10px;">';
            html += '<h5 style="color:#1565c0;margin-bottom:10px;">ğŸ’¡ é¡ä¼¼é …ç›®ã®å€™è£œ</h5>';

            var hasSuggestions = false;
            unmatchedItems.forEach(function(unmatchedItem) {
                var suggestions = findSimilarItems(unmatchedItem.name || '');
                if (suggestions.length === 0) return;

                hasSuggestions = true;
                html += '<div style="margin-bottom:10px;padding:8px;background:#fff;border-radius:4px;">';
                html += '<strong style="color:#d32f2f;">' + unmatchedItem.code + ' (' + (unmatchedItem.name || 'åç§°ãªã—') + ')</strong>';
                html += '<div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:5px;">';

                suggestions.forEach(function(suggestion) {
                    var bgColor = suggestion.matchType === 'rakumy' ? '#e8f5e9' : '#fff3e0';
                    var label = suggestion.matchType === 'rakumy' ? 'ãƒ©ã‚¯ãƒŸãƒ¼' : suggestion.code;
                    html += '<span style="background:' + bgColor + ';border-radius:4px;padding:3px 8px;font-size:10px;">';
                    html += '<strong>' + label + '</strong>: ' + suggestion.name;
                    if (suggestion.code) {
                        html += ' <button style="background:#4caf50;color:#fff;border:none;border-radius:3px;padding:1px 5px;font-size:9px;cursor:pointer;" onclick="applyMappingSuggestion(\'' + unmatchedItem.code + '\', \'' + (unmatchedItem.name || '').replace(/'/g, "\\'") + '\', ' + suggestion.v15No + ', \'' + suggestion.category + '\')">é©ç”¨</button>';
                    }
                    html += '</span>';
                });

                html += '</div></div>';
            });

            if (!hasSuggestions) {
                html += '<p style="color:#666;font-size:11px;">é¡ä¼¼ã™ã‚‹é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function applyMappingSuggestion(code, name, v15No, category) {
            CUSTOMER_CODE_MAP[code] = { v15No: v15No, name: name, category: category };
            ITEMS[v15No] = { name: name, category: category };

            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨ã—ã¾ã—ãŸ: ' + code + ' â†’ [' + v15No + ']');

            // å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦æ›´æ–°
            if (document.getElementById('csvFile').files[0]) {
                importCSV();
            }
        }

        // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function exportAllConfig() {
            var config = {
                version: '5.8',
                mapping: CUSTOMER_CODE_MAP,
                calcRules: CALC_RULES,
                rakumyItems: RAKUMY_ITEMS,
                items: ITEMS,
                allStoresData: allStoresData // å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜
            };
            var blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'budget_config_v5.8_' + new Date().toISOString().slice(0,10) + '.json';
            link.click();
        }

        // â˜… ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportRakumyInputsCSV() {
            var targetStores = getExportTargetStores();
            if (targetStores.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var csv = [];
            var BOM = '\uFEFF'; // Excelç”¨BOM
            var isMultiStore = targetStores.length > 1;

            // å…±é€šã®æœˆãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆæœ€åˆã®åº—èˆ—ã‹ã‚‰ï¼‰
            var firstStoreData = allStoresData[targetStores[0]];
            var commonMonthLabels = firstStoreData.monthLabels || monthLabels || [];
            var commonActiveMonths = firstStoreData.activeMonths || activeMonths || [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var header = ['åº—èˆ—å', 'ã‚»ã‚¯ã‚·ãƒ§ãƒ³', 'é …ç›®å', 'å¤‰æ›ã‚¿ã‚¤ãƒ—'];
            commonMonthLabels.forEach(function(m) { header.push(m); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
            targetStores.forEach(function(stName, storeIndex) {
                var storeData = allStoresData[stName];
                if (!storeData || !storeData.rakumyInputs) return;

                var stRakumyInputs = storeData.rakumyInputs;
                var stActiveMonths = storeData.activeMonths || [];

                // åº—èˆ—é–“åŒºåˆ‡ã‚Š
                if (storeIndex > 0) {
                    csv.push('');
                }

                // æœˆåˆ¥å·®ç•°ãƒã‚§ãƒƒã‚¯ï¼ˆåº—èˆ—ã”ã¨ï¼‰
                function hasMonthlyVariation(key) {
                    if (stActiveMonths.length < 2) return false;
                    var firstVal = stRakumyInputs[0] ? (stRakumyInputs[0][key] || 0) : 0;
                    for (var m = 1; m < stActiveMonths.length; m++) {
                        if (Math.abs((stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0) - firstVal) > 0.01) return true;
                    }
                    return false;
                }

                // === è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰===
                for (var key in RAKUMY_ITEMS) {
                    var item = RAKUMY_ITEMS[key];
                    if (item.category !== 'cost') continue;

                    var hasDiff = hasMonthlyVariation(key);
                    var row = [stName, 'è²»ç”¨äºˆç®—è¨­å®š', item.name, item.type];

                    if (hasDiff) {
                        for (var m = 0; m < stActiveMonths.length; m++) {
                            row.push('å˜æœˆè¨­å®š');
                        }
                        row.push('-', '-');
                    } else {
                        var val = stRakumyInputs[0] ? (stRakumyInputs[0][key] || 0) : 0;
                        var total = 0;
                        for (var m = 0; m < stActiveMonths.length; m++) {
                            row.push(Math.round(val));
                            total += val;
                        }
                        row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                    }
                    csv.push(row.join(','));
                }

                // === å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰===
                for (var key in RAKUMY_ITEMS) {
                    var item = RAKUMY_ITEMS[key];
                    if (item.category !== 'monthly') continue;

                    var baseKey = key.replace('m_', '');
                    if (!hasMonthlyVariation(baseKey)) continue;

                    var row = [stName, 'å˜æœˆè²»ç”¨äºˆç®—', item.name, item.type];
                    var total = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                        total += val;
                        row.push(Math.round(val));
                    }
                    row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                    csv.push(row.join(','));
                }

                // === äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰===
                for (var key in RAKUMY_ITEMS) {
                    var item = RAKUMY_ITEMS[key];
                    if (item.category !== 'budget') continue;

                    var isRate = item.type === 'rate' || key.indexOf('Ratio') > -1;
                    var row = [stName, 'äºˆç®—è¨­å®š', item.name, item.type];
                    var total = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                        total += val;
                        row.push(isRate ? Math.round(val) + '%' : Math.round(val));
                    }
                    if (isRate) {
                        row.push('-', Math.round(total / stActiveMonths.length) + '%');
                    } else {
                        row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                    }
                    csv.push(row.join(','));
                }
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            var filename = isMultiStore
                ? 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤_å…¨' + targetStores.length + 'åº—èˆ—_' + new Date().toISOString().slice(0,10) + '.csv'
                : 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤_' + targetStores[0] + '_' + new Date().toISOString().slice(0,10) + '.csv';

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            // å±¥æ­´ã«è¿½åŠ 
            addToExportHistory('ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV', targetStores, BOM + csv.join('\n'));
            showStatus('success', 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ' + targetStores.length + 'åº—èˆ—ï¼‰');
        }

        // â˜… äºˆç®—ä¸€è¦§CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportBudgetListCSV() {
            var targetStores = getExportTargetStores();
            if (targetStores.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var csv = [];
            var BOM = '\uFEFF';
            var isMultiStore = targetStores.length > 1;

            // å…±é€šã®æœˆãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆæœ€åˆã®åº—èˆ—ã‹ã‚‰ï¼‰
            var firstStoreData = allStoresData[targetStores[0]];
            var commonMonthLabels = firstStoreData.monthLabels || monthLabels || [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var header = ['åº—èˆ—å', 'ã‚»ã‚¯ã‚·ãƒ§ãƒ³', 'é …ç›®å'];
            commonMonthLabels.forEach(function(m) { header.push(m); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            var expenseKeys = ['rent', 'depreciation', 'material', 'promotion', 'sanitary', 'service',
                'electricity', 'gas', 'water', 'consumables', 'maintenance', 'communication',
                'creditFee', 'paymentFee', 'membership', 'it', 'outsource', 'misc'];

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
            targetStores.forEach(function(stName, storeIndex) {
                var storeData = allStoresData[stName];
                if (!storeData || !storeData.rakumyInputs || !storeData.mqOutputs) return;

                var stRakumyInputs = storeData.rakumyInputs;
                var stMqOutputs = storeData.mqOutputs;
                var stAnnualData = storeData.annualData || {};
                var stActiveMonths = storeData.activeMonths || [];

                // åº—èˆ—é–“åŒºåˆ‡ã‚Š
                if (storeIndex > 0) {
                    csv.push('');
                }

                function addRow(section, name, values, isRate) {
                    var row = [stName, section, name];
                    var total = 0;
                    for (var m = 0; m < values.length; m++) {
                        var val = values[m] || 0;
                        total += val;
                        row.push(isRate ? val.toFixed(1) + '%' : Math.round(val));
                    }
                    if (isRate) {
                        row.push('-', (total / values.length).toFixed(1) + '%');
                    } else {
                        row.push(Math.round(total), Math.round(total / values.length));
                    }
                    csv.push(row.join(','));
                }

                function getMonthlyData(getValue) {
                    var result = [];
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        result.push(getValue(m));
                    }
                    return result;
                }

                // ç›®æ¨™è¨­å®š
                addRow('ç›®æ¨™è¨­å®š', 'æœˆæ¬¡ç›®æ¨™åˆ©ç›Š', getMonthlyData(function(m) { return stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0; }), false);
                addRow('ç›®æ¨™è¨­å®š', 'ç›®æ¨™FDä»•å…¥è²»ç‡', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].fdRate || 0) : 0; }), true);
                addRow('ç›®æ¨™è¨­å®š', 'ç›®æ¨™PAäººä»¶è²»ç‡', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0; }), true);
                addRow('ç›®æ¨™è¨­å®š', 'ç›®æ¨™å®¢å˜ä¾¡', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].targetUnitPrice || 0) : 0; }), false);

                // å£²ä¸Š
                addRow('å£²ä¸Š', 'å£²ä¸Š è¨ˆ', getMonthlyData(function(m) { return stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0; }), false);
                addRow('å£²ä¸Š', 'ãƒ•ãƒ¼ãƒ‰å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var ratio = stRakumyInputs[m] ? (stRakumyInputs[m].foodRatio || 0) : 0;
                    return Math.round(sales * ratio / 100);
                }), false);
                addRow('å£²ä¸Š', 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var ratio = stRakumyInputs[m] ? (stRakumyInputs[m].drinkRatio || 0) : 0;
                    return Math.round(sales * ratio / 100);
                }), false);
                addRow('å£²ä¸Š', 'ãã®ä»–å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var ratio = stRakumyInputs[m] ? (stRakumyInputs[m].otherRatio || 0) : 0;
                    return Math.round(sales * ratio / 100);
                }), false);

                // FLã‚³ã‚¹ãƒˆ
                addRow('FLã‚³ã‚¹ãƒˆ', 'FLã‚³ã‚¹ãƒˆ è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var fdRate = stRakumyInputs[m] ? (stRakumyInputs[m].fdRate || 0) : 0;
                    var fixedLabor = stRakumyInputs[m] ? (stRakumyInputs[m].fixedLabor || 0) : 0;
                    var paRate = stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0;
                    return Math.round(sales * fdRate / 100 + fixedLabor + sales * paRate / 100);
                }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'FDä»•å…¥ è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var fdRate = stRakumyInputs[m] ? (stRakumyInputs[m].fdRate || 0) : 0;
                    return Math.round(sales * fdRate / 100);
                }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'äººä»¶è²» è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var fixedLabor = stRakumyInputs[m] ? (stRakumyInputs[m].fixedLabor || 0) : 0;
                    var paRate = stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0;
                    return Math.round(fixedLabor + sales * paRate / 100);
                }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'å›ºå®šäººä»¶è²»', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].fixedLabor || 0) : 0; }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'PAäººä»¶è²»', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var paRate = stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0;
                    return Math.round(sales * paRate / 100);
                }), false);

                // ãã®ä»–çµŒè²»
                addRow('ãã®ä»–çµŒè²»', 'ãã®ä»–çµŒè²» è¨ˆ', getMonthlyData(function(m) {
                    var total = 0;
                    expenseKeys.forEach(function(key) { total += stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0; });
                    return total;
                }), false);
                expenseKeys.forEach(function(key) {
                    var name = RAKUMY_ITEMS[key] ? RAKUMY_ITEMS[key].name : key;
                    addRow('ãã®ä»–çµŒè²»', name, getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0; }), false);
                });

                // å–¶æ¥­åˆ©ç›Š
                addRow('å–¶æ¥­åˆ©ç›Š', 'å–¶æ¥­åˆ©ç›Š', getMonthlyData(function(m) { return stMqOutputs[m] ? (stMqOutputs[m].operatingProfit || 0) : 0; }), false);
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            var filename = isMultiStore
                ? 'äºˆç®—ä¸€è¦§_å…¨' + targetStores.length + 'åº—èˆ—_' + new Date().toISOString().slice(0,10) + '.csv'
                : 'äºˆç®—ä¸€è¦§_' + targetStores[0] + '_' + new Date().toISOString().slice(0,10) + '.csv';

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            // å±¥æ­´ã«è¿½åŠ 
            addToExportHistory('äºˆç®—ä¸€è¦§CSV', targetStores, BOM + csv.join('\n'));
            showStatus('success', 'äºˆç®—ä¸€è¦§CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ' + targetStores.length + 'åº—èˆ—ï¼‰');
        }

        // â˜… MQå‡ºåŠ›CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportMQOutputCSV() {
            var targetStores = getExportTargetStores();
            if (targetStores.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var csv = [];
            var BOM = '\uFEFF';
            var isMultiStore = targetStores.length > 1;

            // å…±é€šã®æœˆãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆæœ€åˆã®åº—èˆ—ã‹ã‚‰ï¼‰
            var firstStoreData = allStoresData[targetStores[0]];
            var commonMonthLabels = firstStoreData.monthLabels || monthLabels || [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var header = ['åº—èˆ—å', 'é …ç›®'];
            commonMonthLabels.forEach(function(m) { header.push(m); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            var mqItems = [
                { key: 'customers', name: 'å®¢æ•°', isRate: false },
                { key: 'unitPrice', name: 'å®¢å˜ä¾¡', isRate: false },
                { key: 'sales', name: 'å£²ä¸Š', isRate: false },
                { key: 'variableCost', name: 'å¤‰å‹•è²»', isRate: false },
                { key: 'variableRate', name: 'å¤‰å‹•è²»ç‡', isRate: true },
                { key: 'grossProfit', name: 'ç²—åˆ©', isRate: false },
                { key: 'grossProfitRate', name: 'ç²—åˆ©ç‡', isRate: true },
                { key: 'fixedCost', name: 'å›ºå®šè²»', isRate: false },
                { key: 'operatingProfit', name: 'å–¶æ¥­åˆ©ç›Š', isRate: false },
                { key: 'operatingProfitRate', name: 'å–¶æ¥­åˆ©ç›Šç‡', isRate: true }
            ];

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
            targetStores.forEach(function(stName, storeIndex) {
                var storeData = allStoresData[stName];
                if (!storeData || !storeData.mqOutputs) return;

                var stMqOutputs = storeData.mqOutputs;
                var stAnnualData = storeData.annualData || {};
                var stActiveMonths = storeData.activeMonths || [];

                // åº—èˆ—é–“åŒºåˆ‡ã‚Š
                if (storeIndex > 0) {
                    csv.push('');
                }

                // MQé …ç›®
                mqItems.forEach(function(item) {
                    var row = [stName, item.name];
                    var total = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        var val = stMqOutputs[m] ? (stMqOutputs[m][item.key] || 0) : 0;
                        total += val;
                        row.push(item.isRate ? val.toFixed(1) + '%' : Math.round(val));
                    }
                    if (item.isRate) {
                        row.push('-', (total / stActiveMonths.length).toFixed(1) + '%');
                    } else {
                        row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                    }
                    csv.push(row.join(','));
                });

                // é¡§å®¢äºˆç®—ã¨ã®æ¯”è¼ƒ
                // é¡§å®¢äºˆç®—å£²ä¸Š
                var budgetSalesRow = [stName, 'é¡§å®¢äºˆç®—å£²ä¸Š'];
                var budgetSalesTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stAnnualData[5] ? (stAnnualData[5][m] || 0) : 0;
                    budgetSalesTotal += val;
                    budgetSalesRow.push(Math.round(val));
                }
                budgetSalesRow.push(Math.round(budgetSalesTotal), Math.round(budgetSalesTotal / stActiveMonths.length));
                csv.push(budgetSalesRow.join(','));

                // å£²ä¸Šå·®ç•°
                var salesDiffRow = [stName, 'å£²ä¸Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
                var salesDiffTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var mqSales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var budgetSales = stAnnualData[5] ? (stAnnualData[5][m] || 0) : 0;
                    var diff = mqSales - budgetSales;
                    salesDiffTotal += diff;
                    salesDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff));
                }
                salesDiffRow.push((salesDiffTotal >= 0 ? '+' : '') + Math.round(salesDiffTotal), '-');
                csv.push(salesDiffRow.join(','));

                // é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Š
                var budgetProfitRow = [stName, 'é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Š'];
                var budgetProfitTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0;
                    budgetProfitTotal += val;
                    budgetProfitRow.push(Math.round(val));
                }
                budgetProfitRow.push(Math.round(budgetProfitTotal), Math.round(budgetProfitTotal / stActiveMonths.length));
                csv.push(budgetProfitRow.join(','));

                // å–¶æ¥­åˆ©ç›Šå·®ç•°
                var profitDiffRow = [stName, 'å–¶æ¥­åˆ©ç›Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
                var profitDiffTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var mqProfit = stMqOutputs[m] ? (stMqOutputs[m].operatingProfit || 0) : 0;
                    var budgetProfit = stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0;
                    var diff = mqProfit - budgetProfit;
                    profitDiffTotal += diff;
                    profitDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff));
                }
                profitDiffRow.push((profitDiffTotal >= 0 ? '+' : '') + Math.round(profitDiffTotal), '-');
                csv.push(profitDiffRow.join(','));
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            var filename = isMultiStore
                ? 'MQå‡ºåŠ›_å…¨' + targetStores.length + 'åº—èˆ—_' + new Date().toISOString().slice(0,10) + '.csv'
                : 'MQå‡ºåŠ›_' + targetStores[0] + '_' + new Date().toISOString().slice(0,10) + '.csv';

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            // å±¥æ­´ã«è¿½åŠ 
            addToExportHistory('MQå‡ºåŠ›CSV', targetStores, BOM + csv.join('\n'));
            showStatus('success', 'MQå‡ºåŠ›CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ' + targetStores.length + 'åº—èˆ—ï¼‰');
        }

        function importAllConfig(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var config = JSON.parse(e.target.result);
                    if (config.mapping) CUSTOMER_CODE_MAP = config.mapping;
                    if (config.calcRules) CALC_RULES = config.calcRules;
                    if (config.rakumyItems) RAKUMY_ITEMS = config.rakumyItems;
                    if (config.items) ITEMS = config.items;

                    // å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                    if (config.allStoresData) {
                        allStoresData = config.allStoresData;
                        updateStoreSelector();
                        renderAllStoresSummary();

                        var storeNames = Object.keys(allStoresData);
                        if (storeNames.length > 0) {
                            switchStore(storeNames[0]);
                        }
                        showStatus('success', 'è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ' + storeNames.length + 'åº—èˆ—ï¼‰');
                    } else {
                        showStatus('success', 'è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    }
                } catch (err) {
                    showStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importCSV() {
            var file = document.getElementById('csvFile').files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    preprocessLog = [];
                    addLog('CSVãƒ•ã‚¡ã‚¤ãƒ«: ' + file.name, 'info');
                    parseCustomerCSV(e.target.result);
                    document.getElementById('preprocessLog').innerHTML = preprocessLog.join('\n');
                    renderMappingTable();
                    renderUnmatchedItems();
                    renderMonthColsGrid();
                    showStatus('success', 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: ' + storeName + 'ï¼ˆ' + matchedItems.length + 'é …ç›®ãƒãƒƒãƒï¼‰');
                    runSimulation();
                } catch (err) {
                    addLog('ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
                    console.error(err);
                    document.getElementById('preprocessLog').innerHTML = preprocessLog.join('\n');
                    showStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCustomerCSV(csv) {
            var lines = csv.split(/\r?\n/).filter(function(l) { return l.trim(); });
            csvLines = lines; // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ä¿å­˜
            if (lines.length < 5) throw new Error('CSVã®è¡Œæ•°ãŒä¸è¶³');

            addLog('ç·è¡Œæ•°: ' + lines.length, 'info');

            // 1è¡Œç›®: åº—èˆ—æƒ…å ±
            var firstRow = parseCSVLine(lines[0]);
            storeName = '';
            for (var i = 1; i < Math.min(firstRow.length, 5); i++) {
                var cell = firstRow[i].trim();
                if (cell && cell.length > 0 && !/^\d+$/.test(cell)) {
                    storeName = cell;
                    break;
                }
            }
            if (!storeName) storeName = 'åº—èˆ—åä¸æ˜';
            document.getElementById('detectedStore').textContent = storeName;
            addLog('åº—èˆ—å: ' + storeName, 'success');

            // â˜… æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—ã®æ­£ç¢ºãªæ¤œå‡º
            var budgetResults = detectBudgetColumns(lines);

            if (budgetResults.length === 0) throw new Error('æœˆã®ã€Œäºˆç®—ã€åˆ—ãŒæ¤œå‡ºã§ãã¾ã›ã‚“');

            // ä¼šè¨ˆå¹´åº¦é †ã«ã‚½ãƒ¼ãƒˆ
            budgetColumnPositions = [];
            activeMonths = [];
            monthLabels = [];

            for (var j = 0; j < FISCAL_ORDER.length; j++) {
                var m = FISCAL_ORDER[j];
                for (var k = 0; k < budgetResults.length; k++) {
                    if (budgetResults[k].month === m) {
                        budgetColumnPositions.push(budgetResults[k]);
                        activeMonths.push(budgetColumnPositions.length - 1);
                        monthLabels.push(m);
                        break;
                    }
                }
            }

            addLog('', '');
            addLog('ä¼šè¨ˆå¹´åº¦é †: ' + monthLabels.join(' â†’ '), 'month');
            addLog('äºˆç®—åˆ—ä½ç½®: ' + budgetColumnPositions.map(function(p) { return p.month + ':åˆ—' + p.budgetCol; }).join(', '), 'data');

            document.getElementById('detectedMonthCount').textContent = activeMonths.length + 'ãƒ¶æœˆ';

            // é …ç›®åæ¤œå‡ºç”¨ã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿åˆ—
            firstDataCol = Math.min.apply(null, budgetColumnPositions.map(function(p) { return p.budgetCol; }));

            // â˜… Phase 1: å…¨è¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€Œãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã€ï¼ˆé …ç›®åã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰ãªã—ï¼‰ã‚’åé›†
            addLog('', '');
            addLog('=== Phase 1: ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®åé›† ===', 'info');

            var headerRowNames = {}; // lineIdx -> itemName
            var lastSeenItemName = '';

            for (var lineIdx = 4; lineIdx < lines.length; lineIdx++) {
                var cols = parseCSVLine(lines[lineIdx]);
                if (cols.length < 3) continue;

                var fullCode = cols[0].trim();
                var hasValidCode = fullCode && /^\d{6,}$/.test(fullCode); // 6æ¡ä»¥ä¸Šã®æ•°å­—

                // é …ç›®åã‚’æ¢ç´¢ï¼ˆåˆ—1ã€œfirstDataColï¼‰
                var nameInfo = extractItemNameFromCols(cols, firstDataCol);

                if (!hasValidCode && nameInfo.name) {
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼šã‚³ãƒ¼ãƒ‰ãªã—ã€é …ç›®åã‚ã‚Š
                    headerRowNames[lineIdx] = nameInfo.name;
                    lastSeenItemName = nameInfo.name;
                    addLog('è¡Œ' + lineIdx + ': ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã€Œ' + nameInfo.name + 'ã€', 'data');
                }
            }

            addLog('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: ' + Object.keys(headerRowNames).length + 'ä»¶', 'info');

            // â˜… Phase 2: ãƒ‡ãƒ¼ã‚¿è¡Œã®è§£æï¼ˆé …ç›®åãŒç©ºãªã‚‰ç›´å‰ã®è¡Œã‹ã‚‰ç¶™æ‰¿ï¼‰
            annualData = {};
            matchedItems = [];
            unmatchedItems = [];
            var processedCodes = {};

            addLog('', '');
            addLog('=== Phase 2: ãƒ‡ãƒ¼ã‚¿è¡Œã®è§£æ ===', 'info');

            for (var lineIdx = 4; lineIdx < lines.length; lineIdx++) {
                var cols = parseCSVLine(lines[lineIdx]);
                if (cols.length < 6) continue;

                var fullCode = cols[0].trim();

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (headerRowNames[lineIdx]) {
                    continue;
                }

                if (!fullCode || /^[^\d]/.test(fullCode)) continue;

                var itemCode = extractItemCode(fullCode);
                if (processedCodes[itemCode]) continue;
                processedCodes[itemCode] = true;

                var nameInfo = extractItemNameFromCols(cols, firstDataCol);

                // â˜… é …ç›®åãŒç©ºã®å ´åˆã€ç›´å‰1ã€œ3è¡Œã‚’é¡ã£ã¦é …ç›®åã‚’æ¢ã™
                var finalItemName = nameInfo.name;
                var inheritedFrom = '';
                if (!finalItemName) {
                    // ç›´å‰ã®è¡Œã‹ã‚‰é …ç›®åã‚’æ¢ã™ï¼ˆæœ€å¤§3è¡Œã¾ã§é¡ã‚‹ï¼‰
                    for (var lookBack = 1; lookBack <= 3 && lineIdx - lookBack >= 4; lookBack++) {
                        var prevLineIdx = lineIdx - lookBack;
                        if (headerRowNames[prevLineIdx]) {
                            finalItemName = headerRowNames[prevLineIdx];
                            inheritedFrom = '(ç¶™æ‰¿:è¡Œ' + prevLineIdx + ')';
                            addLog('ã‚³ãƒ¼ãƒ‰' + itemCode + ': ç›´å‰' + lookBack + 'è¡Œç›®ã‹ã‚‰ç¶™æ‰¿ã€Œ' + finalItemName + 'ã€', 'success');
                            break;
                        }
                    }
                }

                var mapping = CUSTOMER_CODE_MAP[itemCode];

                if (mapping) {
                    var v15No = mapping.v15No;
                    annualData[v15No] = annualData[v15No] || {};

                    for (var mi = 0; mi < budgetColumnPositions.length; mi++) {
                        var budgetCol = budgetColumnPositions[mi].budgetCol;
                        var rawValue = cols[budgetCol] || '';
                        var value = parseCustomNumber(rawValue);
                        annualData[v15No][mi] = (annualData[v15No][mi] || 0) + value;
                    }

                    // â˜… ãƒãƒƒãƒ”ãƒ³ã‚°æ¸ˆã¿ã®å ´åˆã€CUSTOMER_CODE_MAPã®åå‰ã‚’å„ªå…ˆï¼ˆç¶™æ‰¿åã‚ˆã‚Šä¿¡é ¼æ€§ãŒé«˜ã„ï¼‰
                    var displayName = finalItemName || mapping.name;
                    if (inheritedFrom && displayName !== mapping.name) {
                        // ç¶™æ‰¿åã¨ãƒãƒƒãƒ”ãƒ³ã‚°åãŒç•°ãªã‚‹å ´åˆã€ãƒãƒƒãƒ”ãƒ³ã‚°åã‚’ä½¿ç”¨
                        displayName = mapping.name;
                        addLog('ã‚³ãƒ¼ãƒ‰' + itemCode + ': ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©åã‚’ä½¿ç”¨ã€Œ' + displayName + 'ã€(ç¶™æ‰¿ã€Œ' + finalItemName + 'ã€ã¯ä¸æ¡ç”¨)', 'warn');
                    }

                    matchedItems.push({
                        code: itemCode,
                        name: displayName,
                        hierarchy: nameInfo.hierarchy || displayName,
                        v15No: v15No,
                        v15Name: mapping.name,
                        category: mapping.category
                    });
                } else {
                    var hasValue = false;
                    var sampleValue = 0;
                    for (var mi = 0; mi < budgetColumnPositions.length; mi++) {
                        var val = parseCustomNumber(cols[budgetColumnPositions[mi].budgetCol] || '');
                        if (val !== 0) {
                            hasValue = true;
                            if (mi === 0) sampleValue = val;
                        }
                    }
                    if (hasValue) {
                        unmatchedItems.push({
                            code: itemCode,
                            name: finalItemName + inheritedFrom,
                            sampleValue: sampleValue
                        });
                    }
                }
            }

            addLog('ãƒãƒƒãƒ: ' + matchedItems.length + 'é …ç›®ã€æœªãƒãƒƒãƒ: ' + unmatchedItems.length + 'é …ç›®', 'info');
            document.getElementById('detectedItemCount').textContent = matchedItems.length + 'é …ç›®';
            document.getElementById('unmatchedCount').textContent = unmatchedItems.length + 'é …ç›®';
        }

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function runSimulation() {
            if (activeMonths.length === 0) return;
            executeCalcRules();
            judgeSettings();
            generateRakumyInputs();
            runMQSimulation();
            renderAllTables();
            showStatus('success', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†');
        }

        function executeCalcRules() {
            calcResults = {};
            for (var m = 0; m < activeMonths.length; m++) {
                calcResults[m] = {};
                for (var iter = 0; iter < 3; iter++) {
                    for (var ruleName in CALC_RULES) {
                        var rule = CALC_RULES[ruleName];
                        try {
                            calcResults[m][ruleName] = evaluateRule(rule, m);
                        } catch (e) {}
                    }
                }
            }
        }

        function evaluateRule(rule, mi) {
            var get = function(no) { return annualData[no] ? (annualData[no][mi] || 0) : 0; };
            if (rule.type === 'sum') {
                var sum = 0;
                for (var i = 0; i < rule.items.length; i++) sum += get(rule.items[i]);
                return sum;
            } else if (rule.type === 'rate') {
                var num = parseSourceValue(rule.numerator, mi);
                var denom = parseSourceValue(rule.denominator, mi);
                return denom > 0 ? (num / denom * 100) : 0;
            } else if (rule.type === 'default') {
                return rule.value || 0;
            }
            return 0;
        }

        function parseSourceValue(source, mi) {
            if (typeof source === 'string') {
                if (source.startsWith('item:')) {
                    var no = parseInt(source.substring(5));
                    return annualData[no] ? (annualData[no][mi] || 0) : 0;
                }
                return calcResults[mi][source] || 0;
            }
            return 0;
        }

        function judgeSettings() {
            judgments = {};
            [10, 15, 16, 17, 18, 19, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50].forEach(function(itemNo) {
                var values = activeMonths.map(function(mi) { return annualData[itemNo] ? (annualData[itemNo][mi] || 0) : 0; });
                var allSame = values.every(function(v) { return Math.abs(v - values[0]) < 0.01; });
                judgments[itemNo] = { isAnnual: allSame };
            });
        }

        // â˜… ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤ã®ç”Ÿæˆï¼ˆå¤‰æ›ã‚¿ã‚¤ãƒ—ã‚’æ˜ç¤ºï¼‰
        // transformType: 'direct'=ç›´æ¥è»¢è¨˜, 'sum'=åˆè¨ˆ, 'rate'=ç‡è¨ˆç®—, 'calc'=é€†ç®—
        // category: 'cost'=è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰, 'budget'=äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰, 'monthly'=å˜æœˆè²»ç”¨äºˆç®—
        var RAKUMY_ITEMS = {
            // === è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- 29é …ç›®ã™ã¹ã¦ ===
            rent: { name: 'åœ°ä»£å®¶è³ƒ', source: 'calc:åœ°ä»£å®¶è³ƒåˆè¨ˆ', type: 'sum', category: 'cost', desc: 'å®¶è³ƒ+è³ƒå€Ÿæ–™' },
            fixedLabor: { name: 'å›ºå®šäººä»¶è²»', source: 'calc:å›ºå®šäººä»¶è²»åˆè¨ˆ', type: 'sum', category: 'cost', desc: 'çµ¦æ–™+æ³•å®šç¦åˆ©+é€šå‹¤+è³ä¸+ç¤¾å®…+ä¼‘æ¥­' },
            depreciation: { name: 'æ¸›ä¾¡å„Ÿå´è²»', source: 'item:46', type: 'direct', category: 'cost', desc: '' },
            material: { name: 'è³‡æè²»', source: 'calc:è³‡æè²»åˆè¨ˆ', type: 'sum', category: 'cost', desc: 'è­¦å‚™æ–™+ãƒªãƒ¼ã‚¹æ–™' },
            promotion: { name: 'è²©å£²ä¿ƒé€²è²»', source: 'item:21', type: 'direct', category: 'cost', desc: '' },
            menuCopy: { name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', source: 'item:22', type: 'direct', category: 'cost', desc: '' },
            survey: { name: 'èª¿æŸ»è²»', source: 'item:23', type: 'direct', category: 'cost', desc: '' },
            sanitary: { name: 'è¡›ç”Ÿè²»', source: 'item:24', type: 'direct', category: 'cost', desc: '' },
            service: { name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', source: 'item:25', type: 'direct', category: 'cost', desc: '' },
            electricity: { name: 'é›»æ°—ä»£', source: 'item:26', type: 'direct', category: 'cost', desc: '' },
            gas: { name: 'ã‚¬ã‚¹ä»£', source: 'item:27', type: 'direct', category: 'cost', desc: '' },
            water: { name: 'æ°´é“ä»£', source: 'item:28', type: 'direct', category: 'cost', desc: '' },
            consumables: { name: 'æ¶ˆè€—å“è²»', source: 'item:29', type: 'direct', category: 'cost', desc: '' },
            maintenance: { name: 'ä¿å®ˆä¿®ç¹•è²»', source: 'item:30', type: 'direct', category: 'cost', desc: '' },
            taxes: { name: 'ç§Ÿç¨å…¬èª²', source: 'item:31', type: 'direct', category: 'cost', desc: '' },
            entertainment: { name: 'æ¥å¾…äº¤éš›è²»', source: 'item:32', type: 'direct', category: 'cost', desc: '' },
            travel: { name: 'æ—…è²»äº¤é€šè²»', source: 'item:33', type: 'direct', category: 'cost', desc: '' },
            communication: { name: 'é€šä¿¡è²»', source: 'item:34', type: 'direct', category: 'cost', desc: '' },
            creditFee: { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', source: 'item:35', type: 'direct', category: 'cost', desc: '' },
            paymentFee: { name: 'æ”¯æ‰•æ‰‹æ•°æ–™', source: 'item:36', type: 'direct', category: 'cost', desc: '' },
            meeting: { name: 'ä¼šè­°è²»', source: 'item:37', type: 'direct', category: 'cost', desc: '' },
            membership: { name: 'è«¸ä¼šè²»', source: 'item:38', type: 'direct', category: 'cost', desc: '' },
            education: { name: 'å›³æ›¸æ•™è‚²è²»', source: 'item:39', type: 'direct', category: 'cost', desc: '' },
            training: { name: 'ç ”ä¿®è²»', source: 'item:40', type: 'direct', category: 'cost', desc: '' },
            research: { name: 'æ¥­æ…‹ç ”ç©¶è²»', source: 'item:41', type: 'direct', category: 'cost', desc: '' },
            recruitment: { name: 'æ¡ç”¨è²»', source: 'item:42', type: 'direct', category: 'cost', desc: '' },
            it: { name: 'ITè²»', source: 'item:43', type: 'direct', category: 'cost', desc: '' },
            outsource: { name: 'å¤–æ³¨è²»', source: 'item:44', type: 'direct', category: 'cost', desc: '' },
            misc: { name: 'é›‘è²»', source: 'item:45', type: 'direct', category: 'cost', desc: '' },

            // === äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰- MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===
            fdRate: { name: 'FDä»•å…¥è²»ç‡', source: 'calc:FDä»•å…¥è²»ç‡', type: 'rate', category: 'budget', desc: 'FDä»•å…¥è²»Ã·å£²ä¸ŠÃ—100' },
            paRate: { name: 'PAäººä»¶è²»ç‡', source: 'calc:PAäººä»¶è²»ç‡', type: 'rate', category: 'budget', desc: 'PAäººä»¶è²»Ã·å£²ä¸ŠÃ—100' },
            targetUnitPrice: { name: 'ç›®æ¨™å®¢å˜ä¾¡ï¼ˆç¨æŠœï¼‰', source: 'derived', type: 'input', category: 'budget', desc: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤' },
            targetCustomers: { name: 'ç›®æ¨™å®¢æ•°', source: 'derived', type: 'calc', category: 'budget', desc: 'è‡ªå‹•è¨ˆç®—' },
            lunchRatio: { name: 'ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ©ãƒ³ãƒå£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            dinnerRatio: { name: 'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            foodRatio: { name: 'ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ•ãƒ¼ãƒ‰å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            drinkRatio: { name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            otherRatio: { name: 'ãã®ä»–å£²ä¸Šæ¯”ç‡', source: 'calc:ãã®ä»–å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãã®ä»–å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },

            // === å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- 28é …ç›®ï¼ˆåœ°ä»£å®¶è³ƒã‚’é™¤ãï¼‰===
            m_fixedLabor: { name: 'å›ºå®šäººä»¶è²»', source: 'calc:å›ºå®šäººä»¶è²»åˆè¨ˆ', type: 'sum', category: 'monthly', desc: 'çµ¦æ–™+æ³•å®šç¦åˆ©+é€šå‹¤+è³ä¸+ç¤¾å®…+ä¼‘æ¥­' },
            m_depreciation: { name: 'æ¸›ä¾¡å„Ÿå´è²»', source: 'item:46', type: 'direct', category: 'monthly', desc: '' },
            m_material: { name: 'è³‡æè²»', source: 'calc:è³‡æè²»åˆè¨ˆ', type: 'sum', category: 'monthly', desc: 'è­¦å‚™æ–™+ãƒªãƒ¼ã‚¹æ–™' },
            m_promotion: { name: 'è²©å£²ä¿ƒé€²è²»', source: 'item:21', type: 'direct', category: 'monthly', desc: '' },
            m_menuCopy: { name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', source: 'item:22', type: 'direct', category: 'monthly', desc: '' },
            m_survey: { name: 'èª¿æŸ»è²»', source: 'item:23', type: 'direct', category: 'monthly', desc: '' },
            m_sanitary: { name: 'è¡›ç”Ÿè²»', source: 'item:24', type: 'direct', category: 'monthly', desc: '' },
            m_service: { name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', source: 'item:25', type: 'direct', category: 'monthly', desc: '' },
            m_electricity: { name: 'é›»æ°—ä»£', source: 'item:26', type: 'direct', category: 'monthly', desc: '' },
            m_gas: { name: 'ã‚¬ã‚¹ä»£', source: 'item:27', type: 'direct', category: 'monthly', desc: '' },
            m_water: { name: 'æ°´é“ä»£', source: 'item:28', type: 'direct', category: 'monthly', desc: '' },
            m_consumables: { name: 'æ¶ˆè€—å“è²»', source: 'item:29', type: 'direct', category: 'monthly', desc: '' },
            m_maintenance: { name: 'ä¿å®ˆä¿®ç¹•è²»', source: 'item:30', type: 'direct', category: 'monthly', desc: '' },
            m_taxes: { name: 'ç§Ÿç¨å…¬èª²', source: 'item:31', type: 'direct', category: 'monthly', desc: '' },
            m_entertainment: { name: 'æ¥å¾…äº¤éš›è²»', source: 'item:32', type: 'direct', category: 'monthly', desc: '' },
            m_travel: { name: 'æ—…è²»äº¤é€šè²»', source: 'item:33', type: 'direct', category: 'monthly', desc: '' },
            m_communication: { name: 'é€šä¿¡è²»', source: 'item:34', type: 'direct', category: 'monthly', desc: '' },
            m_creditFee: { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', source: 'item:35', type: 'direct', category: 'monthly', desc: '' },
            m_paymentFee: { name: 'æ”¯æ‰•æ‰‹æ•°æ–™', source: 'item:36', type: 'direct', category: 'monthly', desc: '' },
            m_meeting: { name: 'ä¼šè­°è²»', source: 'item:37', type: 'direct', category: 'monthly', desc: '' },
            m_membership: { name: 'è«¸ä¼šè²»', source: 'item:38', type: 'direct', category: 'monthly', desc: '' },
            m_education: { name: 'å›³æ›¸æ•™è‚²è²»', source: 'item:39', type: 'direct', category: 'monthly', desc: '' },
            m_training: { name: 'ç ”ä¿®è²»', source: 'item:40', type: 'direct', category: 'monthly', desc: '' },
            m_research: { name: 'æ¥­æ…‹ç ”ç©¶è²»', source: 'item:41', type: 'direct', category: 'monthly', desc: '' },
            m_recruitment: { name: 'æ¡ç”¨è²»', source: 'item:42', type: 'direct', category: 'monthly', desc: '' },
            m_it: { name: 'ITè²»', source: 'item:43', type: 'direct', category: 'monthly', desc: '' },
            m_outsource: { name: 'å¤–æ³¨è²»', source: 'item:44', type: 'direct', category: 'monthly', desc: '' },
            m_misc: { name: 'é›‘è²»', source: 'item:45', type: 'direct', category: 'monthly', desc: '' }
        };

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ³å®šå®¢å˜ä¾¡ï¼ˆå††ï¼‰- ã“ã‚Œã‚’åŸºã«å®¢æ•°ã‚’é€†ç®—
        var DEFAULT_UNIT_PRICE = 4500;

        function generateRakumyInputs() {
            rakumyInputs = {};
            for (var m = 0; m < activeMonths.length; m++) {
                var get = function(no) { return annualData[no] ? (annualData[no][m] || 0) : 0; };
                var getCalc = function(name) { return calcResults[m][name] || 0; };
                var sales = get(5); // å£²ä¸Šé«˜åˆè¨ˆï¼ˆåƒå††ï¼‰

                // â˜… ç›®æ¨™å®¢æ•°ãƒ»å®¢å˜ä¾¡ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„
                // å£²ä¸Šï¼ˆåƒå††ï¼‰ã‹ã‚‰å®¢æ•°ã‚’é€†ç®—: å®¢æ•° = å£²ä¸Š Ã— 1000 Ã· æƒ³å®šå®¢å˜ä¾¡
                var estimatedCustomers = sales > 0 ? Math.round(sales * 1000 / DEFAULT_UNIT_PRICE) : 3000;
                // å®¢å˜ä¾¡ã¯å£²ä¸Šã‹ã‚‰å®¢æ•°ã§é€†ç®—: å®¢å˜ä¾¡ = å£²ä¸Š Ã— 1000 Ã· å®¢æ•°
                var estimatedUnitPrice = estimatedCustomers > 0 ? Math.round(sales * 1000 / estimatedCustomers) : DEFAULT_UNIT_PRICE;

                rakumyInputs[m] = {
                    // è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- 29é …ç›®
                    rent: getCalc('åœ°ä»£å®¶è³ƒåˆè¨ˆ'),
                    fixedLabor: getCalc('å›ºå®šäººä»¶è²»åˆè¨ˆ'),
                    depreciation: get(46),
                    material: getCalc('è³‡æè²»åˆè¨ˆ'),
                    promotion: get(21), menuCopy: get(22), survey: get(23), sanitary: get(24), service: get(25),
                    electricity: get(26), gas: get(27), water: get(28), consumables: get(29), maintenance: get(30),
                    taxes: get(31), entertainment: get(32), travel: get(33), communication: get(34),
                    creditFee: get(35), paymentFee: get(36), meeting: get(37), membership: get(38),
                    education: get(39), training: get(40), research: get(41), recruitment: get(42),
                    it: get(43), outsource: get(44), misc: get(45),

                    // äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰- MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                    fdRate: getCalc('FDä»•å…¥è²»ç‡'),
                    paRate: getCalc('PAäººä»¶è²»ç‡'),
                    targetUnitPrice: estimatedUnitPrice,
                    targetCustomers: estimatedCustomers,
                    lunchRatio: getCalc('ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡'),
                    dinnerRatio: getCalc('ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡'),
                    foodRatio: getCalc('ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡'),
                    drinkRatio: getCalc('ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡'),
                    otherRatio: getCalc('ãã®ä»–å£²ä¸Šæ¯”ç‡'),

                    // å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- 28é …ç›®ï¼ˆåœ°ä»£å®¶è³ƒé™¤ãï¼‰
                    m_fixedLabor: getCalc('å›ºå®šäººä»¶è²»åˆè¨ˆ'),
                    m_depreciation: get(46),
                    m_material: getCalc('è³‡æè²»åˆè¨ˆ'),
                    m_promotion: get(21), m_menuCopy: get(22), m_survey: get(23), m_sanitary: get(24), m_service: get(25),
                    m_electricity: get(26), m_gas: get(27), m_water: get(28), m_consumables: get(29), m_maintenance: get(30),
                    m_taxes: get(31), m_entertainment: get(32), m_travel: get(33), m_communication: get(34),
                    m_creditFee: get(35), m_paymentFee: get(36), m_meeting: get(37), m_membership: get(38),
                    m_education: get(39), m_training: get(40), m_research: get(41), m_recruitment: get(42),
                    m_it: get(43), m_outsource: get(44), m_misc: get(45),

                    // å‚è€ƒå€¤ï¼ˆé¡§å®¢äºˆç®—ã®å£²ä¸Šï¼‰
                    budgetSales: sales
                };
            }
        }

        function runMQSimulation() {
            mqOutputs = {};
            for (var m = 0; m < activeMonths.length; m++) {
                var r = rakumyInputs[m];
                var sales = r.targetCustomers * r.targetUnitPrice / 1000;
                var variableRate = r.fdRate + r.paRate;
                var variableCost = sales * variableRate / 100;
                var grossProfit = sales - variableCost;
                var fixedCost = r.rent + r.fixedLabor + r.depreciation + r.material + r.promotion + r.menuCopy + r.survey + r.sanitary + r.service + r.electricity + r.gas + r.water + r.consumables + r.maintenance + r.taxes + r.entertainment + r.travel + r.communication + r.creditFee + r.paymentFee + r.meeting + r.membership + r.education + r.training + r.research + r.recruitment + r.it + r.outsource + r.misc;
                var operatingProfit = grossProfit - fixedCost;
                mqOutputs[m] = {
                    sales: Math.round(sales), variableCost: Math.round(variableCost), variableRate: variableRate,
                    grossProfit: Math.round(grossProfit), grossProfitRate: sales > 0 ? grossProfit / sales * 100 : 0,
                    fixedCost: Math.round(fixedCost), operatingProfit: Math.round(operatingProfit),
                    operatingProfitRate: sales > 0 ? operatingProfit / sales * 100 : 0,
                    unitPrice: r.targetUnitPrice, customers: r.targetCustomers
                };
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderAllTables() {
            renderInputTable();
            renderCalcTable();
            renderRakumyTables();
            renderOutputTable();
            renderBudgetListTable();
            renderSummary();
        }

        function createMonthHeaders() {
            var html = '<tr><th>é …ç›®</th>';
            for (var i = 0; i < monthLabels.length; i++) {
                html += '<th class="month-header">' + monthLabels[i] + '</th>';
            }
            html += '<th class="total-col">åˆè¨ˆ</th><th class="avg-col">å¹³å‡</th></tr>';
            return html;
        }

        function renderInputTable() {
            var table = document.getElementById('inputTable');
            var html = createMonthHeaders();
            var categories = { 'å£²ä¸Š': [5, 2, 3, 4], 'åŸä¾¡': [6, 7], 'äººä»¶è²»': [10, 13, 14, 15, 16, 17, 18, 19], 'çµŒè²»': [21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45], 'å›ºå®šè²»': [46, 47, 48, 49, 50], 'åˆ©ç›Š': [60] };
            for (var cat in categories) {
                categories[cat].forEach(function(no) {
                    if (!ITEMS[no] || !annualData[no]) return;
                    html += '<tr><td>[' + no + '] ' + ITEMS[no].name + '</td>';
                    var total = 0;
                    for (var m = 0; m < activeMonths.length; m++) {
                        var val = annualData[no][m] || 0;
                        total += val;
                        html += '<td class="input-cell">' + fmt(val) + '</td>';
                    }
                    html += '<td class="total-col">' + fmt(total) + '</td><td class="avg-col">' + fmt(total / activeMonths.length) + '</td></tr>';
                });
            }
            table.innerHTML = html;
        }

        function renderCalcTable() {
            var table = document.getElementById('calcTable');
            var html = createMonthHeaders();
            for (var name in CALC_RULES) {
                var isRate = CALC_RULES[name].type === 'rate';
                html += '<tr><td>' + name + '</td>';
                var total = 0;
                for (var m = 0; m < activeMonths.length; m++) {
                    var val = calcResults[m][name] || 0;
                    total += val;
                    html += '<td class="calc-cell">' + (isRate ? fmtRate(val) + '%' : fmt(val)) + '</td>';
                }
                html += isRate ? '<td class="total-col">-</td><td class="avg-col">' + fmtRate(total / activeMonths.length) + '%</td></tr>' : '<td class="total-col">' + fmt(total) + '</td><td class="avg-col">' + fmt(total / activeMonths.length) + '</td></tr>';
            }
            table.innerHTML = html;
        }

        function renderRakumyTables() {
            var costTable = document.getElementById('rakumyCostTable');
            var budgetTable = document.getElementById('rakumyBudgetTable');
            var monthlyTable = document.getElementById('rakumyMonthlyTable');

            var costHtml = createMonthHeaders();
            var budgetHtml = createMonthHeaders();
            var monthlyHtml = createMonthHeaders();
            var monthlyCount = 0; // å˜æœˆè²»ç”¨äºˆç®—ã«è¡¨ç¤ºã™ã‚‹é …ç›®æ•°

            // ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸ç”Ÿæˆ
            function getTypeBadge(type) {
                switch (type) {
                    case 'direct': return '<span class="type-direct">ç›´æ¥</span>';
                    case 'sum': return '<span class="type-sum">åˆè¨ˆ</span>';
                    case 'rate': return '<span class="type-rate">ç‡</span>';
                    case 'input': return '<span class="type-input">å…¥åŠ›</span>';
                    case 'calc': return '<span class="type-output">å‡ºåŠ›</span>';
                    default: return '';
                }
            }

            // æœˆåˆ¥å·®ç•°ãƒã‚§ãƒƒã‚¯ï¼ˆå€¤ãŒæœˆã«ã‚ˆã£ã¦ç•°ãªã‚‹ã‹ã©ã†ã‹ï¼‰
            function hasMonthlyVariation(key) {
                if (activeMonths.length < 2) return false;
                var firstVal = rakumyInputs[0][key] || 0;
                for (var m = 1; m < activeMonths.length; m++) {
                    var val = rakumyInputs[m][key] || 0;
                    if (Math.abs(val - firstVal) > 0.01) return true;
                }
                return false;
            }

            // RAKUMY_ITEMSã‚’ä½¿ã£ã¦ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«æç”»
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                var isRate = item.type === 'rate' || key.indexOf('Ratio') > -1;
                var typeBadge = getTypeBadge(item.type);
                var descText = item.desc ? ' <span style="color:#888;font-size:9px;">(' + item.desc + ')</span>' : '';

                // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«æŒ¯ã‚Šåˆ†ã‘
                if (item.category === 'cost') {
                    // è²»ç”¨äºˆç®—è¨­å®šï¼šæœˆåˆ¥å·®ç•°ãŒã‚ã‚‹ã‚‚ã®ã¯ã€Œå˜æœˆè¨­å®šã€ã€å…¨æœˆåŒä¸€ã®ã‚‚ã®ã¯å¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
                    var hasDiff = hasMonthlyVariation(key);
                    var rowHtml;
                    if (hasDiff) {
                        // æœˆåˆ¥å·®ç•°ã‚ã‚Š â†’ å˜æœˆè²»ç”¨äºˆç®—ã§è¨­å®šã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ã€Œå˜æœˆè¨­å®šã€ã¨è¡¨ç¤º
                        rowHtml = '<tr style="background:#fff3e0;"><td>' + item.name + ' ' + typeBadge + ' <span class="monthly-badge">å˜æœˆè¨­å®š</span>' + descText + '</td>';
                        for (var m = 0; m < activeMonths.length; m++) {
                            rowHtml += '<td class="rakumy-cell" style="color:#999;text-align:center;">-</td>';
                        }
                        rowHtml += '<td class="total-col" style="color:#999;">-</td><td class="avg-col" style="color:#999;">-</td></tr>';
                    } else {
                        // å…¨æœˆåŒä¸€ â†’ å¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
                        var annualVal = rakumyInputs[0][key] || 0;
                        rowHtml = '<tr><td>' + item.name + ' ' + typeBadge + ' <span class="annual-badge">å¹´é–“å›ºå®š</span>' + descText + '</td>';
                        for (var m = 0; m < activeMonths.length; m++) {
                            rowHtml += '<td class="rakumy-cell">' + fmt(annualVal) + '</td>';
                        }
                        var total = annualVal * activeMonths.length;
                        rowHtml += '<td class="total-col">' + fmt(total) + '</td><td class="avg-col">' + fmt(annualVal) + '</td></tr>';
                    }
                    costHtml += rowHtml;
                } else if (item.category === 'budget') {
                    var rowHtml = '<tr><td>' + item.name + ' ' + typeBadge + descText + '</td>';
                    var total = 0;
                    for (var m = 0; m < activeMonths.length; m++) {
                        var val = rakumyInputs[m][key] || 0;
                        total += val;
                        rowHtml += '<td class="rakumy-cell">' + (isRate ? fmtRate(val) + '%' : fmt(val)) + '</td>';
                    }
                    if (isRate) {
                        rowHtml += '<td class="total-col">-</td><td class="avg-col">' + fmtRate(total / activeMonths.length) + '%</td></tr>';
                    } else {
                        rowHtml += '<td class="total-col">' + fmt(total) + '</td><td class="avg-col">' + fmt(total / activeMonths.length) + '</td></tr>';
                    }
                    budgetHtml += rowHtml;
                } else if (item.category === 'monthly') {
                    // å˜æœˆè²»ç”¨äºˆç®—ï¼šæœˆåˆ¥å·®ç•°ãŒã‚ã‚‹é …ç›®ã®ã¿è¡¨ç¤ºï¼ˆå®Ÿéš›ã®æœˆåˆ¥æ•°å€¤ï¼‰
                    var baseKey = key.replace('m_', ''); // m_fixedLabor â†’ fixedLabor
                    if (hasMonthlyVariation(baseKey)) {
                        var rowHtml = '<tr><td>' + item.name + ' ' + typeBadge + descText + '</td>';
                        var total = 0;
                        for (var m = 0; m < activeMonths.length; m++) {
                            var val = rakumyInputs[m][key] || 0;
                            total += val;
                            rowHtml += '<td class="rakumy-cell">' + fmt(val) + '</td>';
                        }
                        rowHtml += '<td class="total-col">' + fmt(total) + '</td><td class="avg-col">' + fmt(total / activeMonths.length) + '</td></tr>';
                        monthlyHtml += rowHtml;
                        monthlyCount++;
                    }
                }
            }

            // å˜æœˆè²»ç”¨äºˆç®—ãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (monthlyCount === 0) {
                monthlyHtml += '<tr><td colspan="' + (activeMonths.length + 3) + '" style="text-align:center;color:#888;padding:20px;">å…¨é …ç›®ãŒå¹´é–“ã§åŒä¸€å€¤ã®ãŸã‚ã€å˜æœˆèª¿æ•´ã¯ä¸è¦ã§ã™ã€‚<br>è²»ç”¨äºˆç®—è¨­å®šã®å¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒå…¨æœˆã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</td></tr>';
            }

            // å‚è€ƒå€¤ï¼šé¡§å®¢äºˆç®—å£²ä¸Šï¼ˆMQå‡ºåŠ›ã¨ã®æ¯”è¼ƒç”¨ï¼‰
            budgetHtml += '<tr style="background:#fff3e0;"><td>ã€å‚è€ƒã€‘é¡§å®¢äºˆç®—å£²ä¸Š <span class="type-output">å‡ºåŠ›</span></td>';
            var refTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = rakumyInputs[m].budgetSales || 0;
                refTotal += val;
                budgetHtml += '<td class="rakumy-cell">' + fmt(val) + '</td>';
            }
            budgetHtml += '<td class="total-col">' + fmt(refTotal) + '</td><td class="avg-col">' + fmt(refTotal / activeMonths.length) + '</td></tr>';

            costTable.innerHTML = costHtml;
            budgetTable.innerHTML = budgetHtml;
            monthlyTable.innerHTML = monthlyHtml;

            // å˜æœˆè²»ç”¨äºˆç®—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            var monthlyHeader = document.querySelector('.rakumy-category.monthly h4');
            if (monthlyHeader) {
                monthlyHeader.textContent = 'å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- ' + monthlyCount + 'é …ç›®ï¼ˆæœˆåˆ¥å·®ç•°ãŒã‚ã‚‹é …ç›®ã®ã¿è¡¨ç¤ºï¼‰';
            }
        }

        function renderOutputTable() {
            var table = document.getElementById('outputTable');
            var html = createMonthHeaders();
            var items = [{ key: 'customers', name: 'å®¢æ•°' }, { key: 'unitPrice', name: 'å®¢å˜ä¾¡' }, { key: 'sales', name: 'å£²ä¸Š' }, { key: 'variableCost', name: 'å¤‰å‹•è²»' }, { key: 'variableRate', name: 'å¤‰å‹•è²»ç‡', isRate: true }, { key: 'grossProfit', name: 'ç²—åˆ©' }, { key: 'grossProfitRate', name: 'ç²—åˆ©ç‡', isRate: true }, { key: 'fixedCost', name: 'å›ºå®šè²»' }, { key: 'operatingProfit', name: 'å–¶æ¥­åˆ©ç›Š' }, { key: 'operatingProfitRate', name: 'å–¶æ¥­åˆ©ç›Šç‡', isRate: true }];
            items.forEach(function(item) {
                html += '<tr><td>' + item.name + '</td>';
                var total = 0;
                for (var m = 0; m < activeMonths.length; m++) {
                    var val = mqOutputs[m][item.key] || 0;
                    total += val;
                    html += '<td class="output-cell">' + (item.isRate ? fmtRate(val) + '%' : fmt(val)) + '</td>';
                }
                html += item.isRate ? '<td class="total-col">-</td><td class="avg-col">' + fmtRate(total / activeMonths.length) + '%</td></tr>' : '<td class="total-col">' + fmt(total) + '</td><td class="avg-col">' + fmt(total / activeMonths.length) + '</td></tr>';
            });

            // === é¡§å®¢äºˆç®—ã¨ã®æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===
            html += '<tr style="background:#1565c0;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;text-align:center;padding:12px;font-size:14px;">â”â”â” é¡§å®¢äºˆç®—ã¨ã®æ¯”è¼ƒ â”â”â”</td></tr>';

            // ===== å£²ä¸Šæ¯”è¼ƒã‚°ãƒ«ãƒ¼ãƒ— =====
            html += '<tr style="background:#263238;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;padding:8px;">ã€å£²ä¸Šã€‘å¯¾æ¯”</td></tr>';

            // MQè¨ˆç®—å£²ä¸Š
            html += '<tr style="background:#e3f2fd;border-left:4px solid #1565c0;"><td style="padding-left:20px;font-weight:bold;">MQè¨ˆç®—å€¤ï¼ˆå£²ä¸Šï¼‰</td>';
            var mqSalesTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = mqOutputs[m].sales || 0;
                mqSalesTotal += val;
                html += '<td class="output-cell" style="background:#e3f2fd;font-weight:bold;color:#1565c0;">' + fmt(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;font-weight:bold;color:#1565c0;">' + fmt(mqSalesTotal) + '</td><td class="avg-col" style="background:#bbdefb;">' + fmt(mqSalesTotal / activeMonths.length) + '</td></tr>';

            // é¡§å®¢äºˆç®—å£²ä¸Šï¼ˆItem 5ï¼‰
            html += '<tr style="background:#fff8e1;border-left:4px solid #f57c00;"><td style="padding-left:20px;font-weight:bold;">é¡§å®¢äºˆç®—ï¼ˆå£²ä¸Šï¼‰</td>';
            var budgetSalesTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = annualData[5] ? (annualData[5][m] || 0) : 0;
                budgetSalesTotal += val;
                html += '<td class="output-cell" style="background:#fff8e1;font-weight:bold;color:#e65100;">' + fmt(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#ffecb3;font-weight:bold;color:#e65100;">' + fmt(budgetSalesTotal) + '</td><td class="avg-col" style="background:#ffecb3;">' + fmt(budgetSalesTotal / activeMonths.length) + '</td></tr>';

            // å£²ä¸Šå·®ç•°
            html += '<tr style="background:#eceff1;border-left:4px solid #607d8b;"><td style="padding-left:20px;">å·®ç•°ï¼ˆMQ - äºˆç®—ï¼‰</td>';
            var salesDiffTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var mqSales = mqOutputs[m].sales || 0;
                var budgetSales = annualData[5] ? (annualData[5][m] || 0) : 0;
                var diff = mqSales - budgetSales;
                salesDiffTotal += diff;
                var color = diff >= 0 ? '#2e7d32' : '#c62828';
                var bgColor = diff >= 0 ? '#e8f5e9' : '#ffebee';
                html += '<td class="output-cell" style="color:' + color + ';background:' + bgColor + ';font-weight:bold;">' + (diff >= 0 ? '+' : '') + fmt(diff) + '</td>';
            }
            var diffColor = salesDiffTotal >= 0 ? '#2e7d32' : '#c62828';
            var diffBg = salesDiffTotal >= 0 ? '#c8e6c9' : '#ffcdd2';
            html += '<td class="total-col" style="color:' + diffColor + ';background:' + diffBg + ';font-weight:bold;">' + (salesDiffTotal >= 0 ? '+' : '') + fmt(salesDiffTotal) + '</td><td class="avg-col" style="background:#eceff1;">-</td></tr>';

            // ===== å–¶æ¥­åˆ©ç›Šæ¯”è¼ƒã‚°ãƒ«ãƒ¼ãƒ— =====
            html += '<tr style="background:#263238;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;padding:8px;">ã€å–¶æ¥­åˆ©ç›Šã€‘å¯¾æ¯”</td></tr>';

            // MQè¨ˆç®—å–¶æ¥­åˆ©ç›Š
            html += '<tr style="background:#e3f2fd;border-left:4px solid #1565c0;"><td style="padding-left:20px;font-weight:bold;">MQè¨ˆç®—å€¤ï¼ˆå–¶æ¥­åˆ©ç›Šï¼‰</td>';
            var mqProfitTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = mqOutputs[m].operatingProfit || 0;
                mqProfitTotal += val;
                html += '<td class="output-cell" style="background:#e3f2fd;font-weight:bold;color:#1565c0;">' + fmt(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;font-weight:bold;color:#1565c0;">' + fmt(mqProfitTotal) + '</td><td class="avg-col" style="background:#bbdefb;">' + fmt(mqProfitTotal / activeMonths.length) + '</td></tr>';

            // é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Šï¼ˆItem 60 = åº—èˆ—å–¶æ¥­åˆ©ç›Šï¼‰
            html += '<tr style="background:#fff8e1;border-left:4px solid #f57c00;"><td style="padding-left:20px;font-weight:bold;">é¡§å®¢äºˆç®—ï¼ˆå–¶æ¥­åˆ©ç›Šï¼‰</td>';
            var budgetProfitTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = annualData[60] ? (annualData[60][m] || 0) : 0;
                budgetProfitTotal += val;
                html += '<td class="output-cell" style="background:#fff8e1;font-weight:bold;color:#e65100;">' + fmt(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#ffecb3;font-weight:bold;color:#e65100;">' + fmt(budgetProfitTotal) + '</td><td class="avg-col" style="background:#ffecb3;">' + fmt(budgetProfitTotal / activeMonths.length) + '</td></tr>';

            // å–¶æ¥­åˆ©ç›Šå·®ç•°
            html += '<tr style="background:#eceff1;border-left:4px solid #607d8b;"><td style="padding-left:20px;">å·®ç•°ï¼ˆMQ - äºˆç®—ï¼‰</td>';
            var profitDiffTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var mqProfit = mqOutputs[m].operatingProfit || 0;
                var budgetProfit = annualData[60] ? (annualData[60][m] || 0) : 0;
                var diff = mqProfit - budgetProfit;
                profitDiffTotal += diff;
                var color = diff >= 0 ? '#2e7d32' : '#c62828';
                var bgColor = diff >= 0 ? '#e8f5e9' : '#ffebee';
                html += '<td class="output-cell" style="color:' + color + ';background:' + bgColor + ';font-weight:bold;">' + (diff >= 0 ? '+' : '') + fmt(diff) + '</td>';
            }
            var profitDiffColor = profitDiffTotal >= 0 ? '#2e7d32' : '#c62828';
            var profitDiffBg = profitDiffTotal >= 0 ? '#c8e6c9' : '#ffcdd2';
            html += '<td class="total-col" style="color:' + profitDiffColor + ';background:' + profitDiffBg + ';font-weight:bold;">' + (profitDiffTotal >= 0 ? '+' : '') + fmt(profitDiffTotal) + '</td><td class="avg-col" style="background:#eceff1;">-</td></tr>';

            table.innerHTML = html;
        }

        function renderBudgetListTable() {
            var table = document.getElementById('budgetListTable');
            var html = createMonthHeaders();

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function addRow(name, values, isRate, style) {
                var rowStyle = style ? ' style="' + style + '"' : '';
                html += '<tr' + rowStyle + '><td>' + name + '</td>';
                var total = 0;
                for (var m = 0; m < values.length; m++) {
                    var val = values[m] || 0;
                    total += val;
                    html += '<td class="output-cell">' + (isRate ? fmtRate(val) + '%' : fmt(val)) + '</td>';
                }
                if (isRate) {
                    html += '<td class="total-col">-</td><td class="avg-col">' + fmtRate(total / values.length) + '%</td></tr>';
                } else {
                    html += '<td class="total-col">' + fmt(total) + '</td><td class="avg-col">' + fmt(total / values.length) + '</td></tr>';
                }
            }

            function addSectionHeader(title, bgColor) {
                html += '<tr style="background:' + bgColor + ';color:#fff;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;padding:8px;">' + title + '</td></tr>';
            }

            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
            function getMonthlyData(getValue) {
                var result = [];
                for (var m = 0; m < activeMonths.length; m++) {
                    result.push(getValue(m));
                }
                return result;
            }

            // ===== ç›®æ¨™è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('ç›®æ¨™è¨­å®š', '#1565c0');
            addRow('æœˆæ¬¡ç›®æ¨™åˆ©ç›Š', getMonthlyData(function(m) { return annualData[60] ? (annualData[60][m] || 0) : 0; }), false);
            addRow('ç›®æ¨™FDä»•å…¥è²»ç‡', getMonthlyData(function(m) { return rakumyInputs[m].fdRate || 0; }), true);
            addRow('ç›®æ¨™PAäººä»¶è²»ç‡', getMonthlyData(function(m) { return rakumyInputs[m].paRate || 0; }), true);
            addRow('ç›®æ¨™å®¢å˜ä¾¡', getMonthlyData(function(m) { return rakumyInputs[m].targetUnitPrice || 0; }), false);
            // ãƒ©ãƒ³ãƒãƒ»ãƒ‡ã‚£ãƒŠãƒ¼å®¢å˜ä¾¡ã¯å£²ä¸Šæ§‹æˆæ¯”ã‹ã‚‰æ¨å®š
            addRow('ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ©ãƒ³ãƒï¼‰', getMonthlyData(function(m) {
                var unitPrice = rakumyInputs[m].targetUnitPrice || 0;
                var lunchRatio = rakumyInputs[m].lunchRatio || 0;
                return lunchRatio > 0 ? Math.round(unitPrice * 0.7) : 0; // ãƒ©ãƒ³ãƒã¯ç´„70%ã¨ä»®å®š
            }), false);
            addRow('ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ï¼‰', getMonthlyData(function(m) {
                var unitPrice = rakumyInputs[m].targetUnitPrice || 0;
                var dinnerRatio = rakumyInputs[m].dinnerRatio || 0;
                return dinnerRatio > 0 ? Math.round(unitPrice * 1.3) : 0; // ãƒ‡ã‚£ãƒŠãƒ¼ã¯ç´„130%ã¨ä»®å®š
            }), false);

            // ===== å£²ä¸Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('å£²ä¸Š', '#2e7d32');
            addRow('å£²ä¸Š è¨ˆ', getMonthlyData(function(m) { return mqOutputs[m].sales || 0; }), false);
            addRow('ãƒ•ãƒ¼ãƒ‰å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                var sales = mqOutputs[m].sales || 0;
                var foodRatio = rakumyInputs[m].foodRatio || 0;
                return Math.round(sales * foodRatio / 100);
            }), false);
            addRow('ã€€ãƒ•ãƒ¼ãƒ‰å£²ä¸Šãƒ©ãƒ³ãƒ', getMonthlyData(function(m) {
                var sales = mqOutputs[m].sales || 0;
                var foodRatio = rakumyInputs[m].foodRatio || 0;
                var lunchRatio = rakumyInputs[m].lunchRatio || 0;
                return Math.round(sales * foodRatio / 100 * lunchRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ•ãƒ¼ãƒ‰å£²ä¸Šãƒ‡ã‚£ãƒŠãƒ¼', getMonthlyData(function(m) {
                var sales = mqOutputs[m].sales || 0;
                var foodRatio = rakumyInputs[m].foodRatio || 0;
                var dinnerRatio = rakumyInputs[m].dinnerRatio || 0;
                return Math.round(sales * foodRatio / 100 * dinnerRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                var sales = mqOutputs[m].sales || 0;
                var drinkRatio = rakumyInputs[m].drinkRatio || 0;
                return Math.round(sales * drinkRatio / 100);
            }), false);
            addRow('ã€€ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šãƒ©ãƒ³ãƒ', getMonthlyData(function(m) {
                var sales = mqOutputs[m].sales || 0;
                var drinkRatio = rakumyInputs[m].drinkRatio || 0;
                var lunchRatio = rakumyInputs[m].lunchRatio || 0;
                return Math.round(sales * drinkRatio / 100 * lunchRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šãƒ‡ã‚£ãƒŠãƒ¼', getMonthlyData(function(m) {
                var sales = mqOutputs[m].sales || 0;
                var drinkRatio = rakumyInputs[m].drinkRatio || 0;
                var dinnerRatio = rakumyInputs[m].dinnerRatio || 0;
                return Math.round(sales * drinkRatio / 100 * dinnerRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ãã®ä»–å£²ä¸Š è¨ˆï¼ˆã‚µãƒ¼ãƒ“ã‚¹æ–™ç­‰ï¼‰', getMonthlyData(function(m) {
                var sales = mqOutputs[m].sales || 0;
                var otherRatio = rakumyInputs[m].otherRatio || 0;
                return Math.round(sales * otherRatio / 100);
            }), false);

            // ===== FLã‚³ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('FLã‚³ã‚¹ãƒˆ', '#f57c00');
            addRow('FLã‚³ã‚¹ãƒˆ è¨ˆ', getMonthlyData(function(m) {
                var fdCost = (mqOutputs[m].sales || 0) * (rakumyInputs[m].fdRate || 0) / 100;
                var fixedLabor = rakumyInputs[m].fixedLabor || 0;
                var paLabor = (mqOutputs[m].sales || 0) * (rakumyInputs[m].paRate || 0) / 100;
                return Math.round(fdCost + fixedLabor + paLabor);
            }), false);
            addRow('FDä»•å…¥ è¨ˆ', getMonthlyData(function(m) {
                return Math.round((mqOutputs[m].sales || 0) * (rakumyInputs[m].fdRate || 0) / 100);
            }), false);
            addRow('ã€€ãƒ•ãƒ¼ãƒ‰ä»•å…¥', getMonthlyData(function(m) {
                var fdCost = (mqOutputs[m].sales || 0) * (rakumyInputs[m].fdRate || 0) / 100;
                var foodRatio = rakumyInputs[m].foodRatio || 70;
                var totalRatio = foodRatio + (rakumyInputs[m].drinkRatio || 30);
                return Math.round(fdCost * foodRatio / totalRatio);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥', getMonthlyData(function(m) {
                var fdCost = (mqOutputs[m].sales || 0) * (rakumyInputs[m].fdRate || 0) / 100;
                var drinkRatio = rakumyInputs[m].drinkRatio || 30;
                var totalRatio = (rakumyInputs[m].foodRatio || 70) + drinkRatio;
                return Math.round(fdCost * drinkRatio / totalRatio);
            }), false, 'background:#f5f5f5;');
            addRow('äººä»¶è²» è¨ˆ', getMonthlyData(function(m) {
                var fixedLabor = rakumyInputs[m].fixedLabor || 0;
                var paLabor = (mqOutputs[m].sales || 0) * (rakumyInputs[m].paRate || 0) / 100;
                var helpLabor = annualData[19] ? (annualData[19][m] || 0) : 0;
                return Math.round(fixedLabor + paLabor + helpLabor);
            }), false);
            addRow('ã€€å›ºå®šäººä»¶è²»', getMonthlyData(function(m) { return rakumyInputs[m].fixedLabor || 0; }), false, 'background:#f5f5f5;');
            addRow('ã€€PAäººä»¶è²»', getMonthlyData(function(m) {
                return Math.round((mqOutputs[m].sales || 0) * (rakumyInputs[m].paRate || 0) / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ˜ãƒ«ãƒ—äººä»¶è²»', getMonthlyData(function(m) { return annualData[19] ? (annualData[19][m] || 0) : 0; }), false, 'background:#f5f5f5;');

            // ===== ãã®ä»–çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('ãã®ä»–çµŒè²»', '#7b1fa2');
            // ãã®ä»–çµŒè²»åˆè¨ˆ
            var otherExpenseItems = ['rent', 'depreciation', 'material', 'promotion', 'menuCopy', 'survey', 'sanitary', 'service',
                'electricity', 'gas', 'water', 'consumables', 'maintenance', 'taxes', 'entertainment', 'travel',
                'communication', 'creditFee', 'paymentFee', 'meeting', 'membership', 'education', 'training',
                'research', 'recruitment', 'it', 'outsource', 'misc'];

            addRow('ãã®ä»–çµŒè²» è¨ˆ', getMonthlyData(function(m) {
                var total = 0;
                otherExpenseItems.forEach(function(key) {
                    total += rakumyInputs[m][key] || 0;
                });
                return total;
            }), false);

            // å€‹åˆ¥çµŒè²»é …ç›®ï¼ˆè²»ç”¨äºˆç®—è¨­å®šã®å€¤ã‚’ä½¿ç”¨ï¼‰
            var expenseMapping = [
                { key: 'rent', name: 'åœ°ä»£å®¶è³ƒ' },
                { key: 'material', name: 'è³‡æè²»' },
                { key: 'it', name: 'ITè²»' },
                { key: 'gas', name: 'ã‚¬ã‚¹ä»£' },
                { key: 'service', name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»' },
                { key: 'maintenance', name: 'ä¿å®ˆä¿®ç¹•è²»' },
                { key: 'outsource', name: 'å¤–æ³¨è²»' },
                { key: 'paymentFee', name: 'æ”¯æ‰•æ‰‹æ•°æ–™' },
                { key: 'water', name: 'æ°´é“ä»£' },
                { key: 'consumables', name: 'æ¶ˆè€—å“è²»' },
                { key: 'depreciation', name: 'æ¸›ä¾¡å„Ÿå´è²»' },
                { key: 'sanitary', name: 'è¡›ç”Ÿè²»' },
                { key: 'survey', name: 'èª¿æŸ»è²»' },
                { key: 'membership', name: 'è«¸ä¼šè²»' },
                { key: 'promotion', name: 'è²©å£²ä¿ƒé€²è²»' },
                { key: 'communication', name: 'é€šä¿¡è²»' },
                { key: 'misc', name: 'é›‘è²»' },
                { key: 'electricity', name: 'é›»æ°—ä»£' },
                { key: 'creditFee', name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™' }
            ];

            expenseMapping.forEach(function(exp) {
                addRow('ã€€' + exp.name, getMonthlyData(function(m) { return rakumyInputs[m][exp.key] || 0; }), false, 'background:#f5f5f5;');
            });

            // ===== å–¶æ¥­åˆ©ç›Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('å–¶æ¥­åˆ©ç›Š', '#c62828');
            addRow('å–¶æ¥­åˆ©ç›Š', getMonthlyData(function(m) { return mqOutputs[m].operatingProfit || 0; }), false, 'font-weight:bold;');

            table.innerHTML = html;
        }

        function renderSummary() {
            var totalSales = 0, totalProfit = 0, totalCustomers = 0, totalVariableRate = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                totalSales += mqOutputs[m].sales || 0;
                totalProfit += mqOutputs[m].operatingProfit || 0;
                totalCustomers += mqOutputs[m].customers || 0;
                totalVariableRate += mqOutputs[m].variableRate || 0;
            }
            document.getElementById('summaryGrid').innerHTML = '<div class="summary-card"><div class="summary-label">å¹´é–“å£²ä¸Š</div><div class="summary-value">' + fmt(totalSales) + '</div><div class="summary-sub">åƒå††</div></div><div class="summary-card"><div class="summary-label">å¹´é–“å–¶æ¥­åˆ©ç›Š</div><div class="summary-value">' + fmt(totalProfit) + '</div><div class="summary-sub">åƒå††</div></div><div class="summary-card"><div class="summary-label">å–¶æ¥­åˆ©ç›Šç‡</div><div class="summary-value">' + fmtRate(totalSales > 0 ? totalProfit / totalSales * 100 : 0) + '%</div></div><div class="summary-card"><div class="summary-label">å¹´é–“å®¢æ•°</div><div class="summary-value">' + fmt(totalCustomers) + '</div><div class="summary-sub">äºº</div></div><div class="summary-card"><div class="summary-label">å¹³å‡å®¢å˜ä¾¡</div><div class="summary-value">' + fmt(totalCustomers > 0 ? Math.round(totalSales * 1000 / totalCustomers) : 0) + '</div><div class="summary-sub">å††</div></div><div class="summary-card"><div class="summary-label">å¤‰å‹•è²»ç‡</div><div class="summary-value">' + fmtRate(totalVariableRate / activeMonths.length) + '%</div></div>';

            var judgeHtml = '<table class="annual-table" style="max-width:500px;"><tr><th>é …ç›®</th><th>åˆ¤å®š</th><th>è¨­å®šå…ˆ</th></tr>';
            [{ name: 'åœ°ä»£å®¶è³ƒ', no: 47 }, { name: 'å›ºå®šäººä»¶è²»', no: 10 }, { name: 'é›»æ°—ä»£', no: 26 }, { name: 'ã‚¬ã‚¹ä»£', no: 27 }, { name: 'æ°´é“ä»£', no: 28 }].forEach(function(item) {
                var j = judgments[item.no];
                if (j) judgeHtml += '<tr><td>' + item.name + '</td><td>' + (j.isAnnual ? '<span class="annual-badge">å…¨æœˆåŒä¸€</span>' : '<span class="monthly-badge">æœˆåˆ¥å·®ç•°</span>') + '</td><td>' + (j.isAnnual ? 'è²»ç”¨äºˆç®—è¨­å®š' : 'å˜æœˆè²»ç”¨è¨­å®š') + '</td></tr>';
            });
            judgeHtml += '</table>';
            document.getElementById('judgmentResults').innerHTML = judgeHtml;
        }

        // =====================
        // å±¥æ­´ç®¡ç†æ©Ÿèƒ½
        // =====================
        var HISTORY_KEY = 'rakumy_budget_history';

        // ç¾åœ¨ã®æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime() {
            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            return y + '-' + m + '-' + d + '_' + h + ':' + min;
        }

        // å±¥æ­´ã‚’ä¿å­˜
        function saveToHistory() {
            if (Object.keys(allStoresData).length === 0) {
                alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            var history = loadHistory();
            var storeNames = Object.keys(allStoresData).join(', ');
            var dateTime = formatDateTime();
            var title = dateTime + '_' + storeNames;

            var newEntry = {
                id: Date.now().toString(),
                title: title,
                dateTime: dateTime,
                storeNames: Object.keys(allStoresData),
                storeCount: Object.keys(allStoresData).length,
                data: JSON.parse(JSON.stringify(allStoresData)), // Deep copy
                savedAt: new Date().toISOString()
            };

            history.unshift(newEntry); // æœ€æ–°ã‚’å…ˆé ­ã«

            // æœ€å¤§20ä»¶ã¾ã§ä¿æŒ
            if (history.length > 20) {
                history = history.slice(0, 20);
            }

            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                showStatus('success', 'å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ: ' + title);
                renderHistoryList();
            } catch (e) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                console.error(e);
            }
        }

        // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadHistory() {
            try {
                var data = localStorage.getItem(HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
                return [];
            }
        }

        // å±¥æ­´ã‹ã‚‰å¾©å…ƒ
        function loadFromHistory(id) {
            var history = loadHistory();
            var entry = history.find(function(h) { return h.id === id; });
            if (!entry) {
                alert('å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (Object.keys(allStoresData).length > 0) {
                if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            allStoresData = JSON.parse(JSON.stringify(entry.data)); // Deep copy

            // æœ€åˆã®åº—èˆ—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            var storeNames = Object.keys(allStoresData);
            if (storeNames.length > 0) {
                currentStoreName = storeNames[0];
                var storeData = allStoresData[currentStoreName];
                annualData = storeData.annualData || {};
                calcResults = storeData.calcResults || {};
                rakumyInputs = storeData.rakumyInputs || {};
                mqOutputs = storeData.mqOutputs || {};
                judgments = storeData.judgments || {};
                matchedItems = storeData.matchedItems || [];
                unmatchedItems = storeData.unmatchedItems || [];
                activeMonths = storeData.activeMonths || [];
                monthLabels = storeData.monthLabels || [];
                storeName = currentStoreName;
            }

            // UIæ›´æ–°
            updateStoreSelector();
            updateAllStoresSummary();
            renderAllTables();

            showStatus('success', 'å±¥æ­´ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ: ' + entry.title);
        }

        // å±¥æ­´ã‚’å‰Šé™¤
        function deleteFromHistory(id) {
            if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            var history = loadHistory();
            history = history.filter(function(h) { return h.id !== id; });

            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistoryList();
            showStatus('info', 'å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å…¨å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
        function clearAllHistory() {
            if (!confirm('å…¨ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            localStorage.removeItem(HISTORY_KEY);
            renderHistoryList();
            showStatus('info', 'å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å±¥æ­´ãƒªã‚¹ãƒˆã‚’æç”»
        function renderHistoryList() {
            var historySection = document.getElementById('historySection');
            var historyList = document.getElementById('historyList');
            var history = loadHistory();

            if (history.length === 0) {
                historySection.style.display = 'none';
                return;
            }

            historySection.style.display = 'block';
            var html = '';

            history.forEach(function(entry) {
                html += '<div class="history-item">';
                html += '<div class="history-title">' + escapeHtml(entry.title) + '</div>';
                html += '<div class="history-meta">';
                html += '<span>ä¿å­˜æ—¥æ™‚: ' + new Date(entry.savedAt).toLocaleString('ja-JP') + '</span>';
                html += '</div>';
                html += '<div class="history-stores">';
                html += '<span>åº—èˆ—æ•°: ' + entry.storeCount + 'åº—èˆ—</span>';
                if (entry.storeNames && entry.storeNames.length > 0) {
                    html += ' (' + entry.storeNames.slice(0, 3).join(', ');
                    if (entry.storeNames.length > 3) html += ' ä»–' + (entry.storeNames.length - 3) + 'åº—èˆ—';
                    html += ')';
                }
                html += '</div>';
                html += '<div class="history-actions">';
                html += '<button class="load-btn" onclick="loadFromHistory(\'' + entry.id + '\')">èª­ã¿è¾¼ã¿</button>';
                html += '<button class="delete-btn" onclick="deleteFromHistory(\'' + entry.id + '\')">å‰Šé™¤</button>';
                html += '</div>';
                html += '</div>';
            });

            historyList.innerHTML = html;
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#39;');
        }

        // å±¥æ­´åˆæœŸåŒ–
        function initHistory() {
            renderHistoryList();
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('info', 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            initHistory();
            updateExportHistoryCount();
        });
    </script>
</body>
</html>
