<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v15 äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆé¡§å®¢CSVå¯¾å¿œç‰ˆ v5.8 å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–ï¼‰</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background: #f0f2f5; padding: 15px; font-size: 11px; }
        .container { max-width: 1900px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 5px; font-size: 20px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 15px; font-size: 12px; }

        .import-section { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .import-section h2 { font-size: 14px; margin-bottom: 10px; color: #333; }
        .import-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: #fff; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn:hover { opacity: 0.85; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .info-bar { display: flex; gap: 20px; align-items: center; padding: 12px 15px; background: #e8f5e9; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #4caf50; flex-wrap: wrap; }
        .info-label { font-weight: bold; color: #333; }
        .info-value { font-size: 14px; font-weight: bold; color: #1b5e20; }

        .column-detection { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #17a2b8; }
        .column-detection h3 { font-size: 13px; margin-bottom: 10px; color: #0c5460; }
        .month-cols-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 8px; }
        .month-col-card { padding: 8px; background: #f8f9fa; border-radius: 4px; text-align: center; font-size: 10px; border: 2px solid transparent; }
        .month-col-card.ok { border-color: #28a745; background: #d4edda; }
        .month-col-card.warn { border-color: #ffc107; background: #fff3cd; }
        .month-col-card.error { border-color: #dc3545; background: #f8d7da; }
        .month-name { font-weight: bold; font-size: 12px; }
        .col-info { color: #666; margin-top: 3px; }
        .sub-header { color: #007bff; font-weight: bold; }

        .section { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; overflow: hidden; }
        .section-header { padding: 12px 15px; font-weight: bold; font-size: 13px; }
        .section-body { padding: 15px; overflow-x: auto; }

        .header-mapping { background: #e1bee7; color: #6a1b9a; }
        .header-input { background: #fff3cd; color: #856404; }
        .header-calc { background: #d1ecf1; color: #0c5460; }
        .header-rakumy { background: #cce5ff; color: #004085; }
        .header-output { background: #d4edda; color: #155724; }
        .header-summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }

        .annual-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .annual-table th, .annual-table td { padding: 5px 6px; text-align: right; border: 1px solid #e0e0e0; white-space: nowrap; }
        .annual-table th { font-weight: bold; text-align: center; }
        .annual-table thead tr[style*="background"] th { color: inherit; }
        .annual-table th:first-child { text-align: left; min-width: 150px; }
        .annual-table td:first-child { text-align: left; font-weight: bold; }
        .annual-table .month-header { background: #e3f2fd; }
        .annual-table .total-col { background: #fff8e1; font-weight: bold; }
        .annual-table .avg-col { background: #f3e5f5; }

        .input-cell { background: #fffde7; }
        .input-cell.zero-value { background: #f5f5f5; color: #bbb; }
        .calc-cell { background: #e0f7fa; }
        .rakumy-cell { background: #e3f2fd; }
        .output-cell { background: #e8f5e9; }

        .annual-badge { background: #4caf50; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px; }
        .monthly-badge { background: #ff9800; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px; }

        /* å¤‰æ›ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸ */
        .type-direct { background: #2196f3; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-sum { background: #9c27b0; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-rate { background: #e91e63; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-input { background: #4caf50; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }
        .type-output { background: #607d8b; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 8px; margin-left: 5px; }

        /* LIVEé€£å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        /* ãƒ©ã‚¯ãƒŸãƒ¼ã‚«ãƒ†ã‚´ãƒª */
        .rakumy-category { margin-bottom: 20px; }
        .rakumy-category h4 { font-size: 12px; padding: 8px 12px; margin-bottom: 10px; border-radius: 4px; }
        .rakumy-category.cost h4 { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }
        .rakumy-category.budget h4 { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }
        .rakumy-category.monthly h4 { background: #fff3e0; color: #e65100; border-left: 4px solid #ff9800; }

        .transform-legend { display: flex; gap: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 15px; flex-wrap: wrap; font-size: 10px; }
        .transform-legend span { display: flex; align-items: center; gap: 5px; }

        .summary-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
        .summary-card { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; text-align: center; }
        .summary-label { font-size: 11px; opacity: 0.9; margin-bottom: 5px; }
        .summary-value { font-size: 22px; font-weight: bold; }
        .summary-sub { font-size: 10px; opacity: 0.8; margin-top: 3px; }

        .status-bar { padding: 10px 15px; border-radius: 4px; margin-top: 10px; font-size: 11px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-info { background: #d1ecf1; color: #0c5460; }

        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 0; flex-wrap: wrap; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; font-size: 11px; font-weight: bold; }
        .tab:hover { background: #f5f5f5; }
        .tab.active { border-bottom-color: #007bff; color: #007bff; background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .mapping-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 15px; }
        .mapping-table th, .mapping-table td { padding: 6px 8px; border: 1px solid #ddd; text-align: left; }
        .mapping-table th { background: #f0f0f0; }

        .unmatched-section { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107; }
        .unmatched-section h3 { color: #856404; margin-bottom: 10px; }

        .form-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .form-row label { min-width: 100px; font-weight: bold; }
        .form-row input, .form-row select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; }

        .preprocess-log { background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 9px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
        .log-info { color: #4ec9b0; }
        .log-warn { color: #dcdcaa; }
        .log-error { color: #f48771; }
        .log-success { color: #6a9955; }
        .log-data { color: #ce9178; }
        .log-month { color: #569cd6; }

        .sample-values { margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; }
        .sample-values h4 { margin-bottom: 8px; }
        .sample-table { font-size: 9px; }
        .sample-table th, .sample-table td { padding: 3px 6px; }

        .store-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; padding: 12px 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .store-selector label { font-weight: bold; color: #333; }
        .store-selector select { padding: 8px 12px; border: 2px solid #007bff; border-radius: 4px; font-size: 12px; font-weight: bold; min-width: 200px; }
        .store-list { display: flex; gap: 8px; flex-wrap: wrap; margin-left: 20px; }
        .store-chip { padding: 4px 10px; background: #e3f2fd; border-radius: 15px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; cursor: pointer; }
        .store-chip.active { background: #1565c0; color: #fff; }
        .store-chip .remove { margin-left: 5px; color: #f44336; cursor: pointer; font-weight: bold; }

        .all-stores-summary { background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .all-stores-summary h3 { margin-bottom: 15px; font-size: 16px; }
        .all-stores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .store-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; }
        .store-card h4 { margin-bottom: 10px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; }
        .store-card .metric { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .store-card .metric-value { font-weight: bold; }
        .store-card.total { background: rgba(255,193,7,0.3); border: 2px solid #ffc107; }

        /* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
        .drop-zone {
            border: 2px dashed #90caf9;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .drop-zone:hover { border-color: #1565c0; background: #e3f2fd; }
        .drop-zone.drag-over { border-color: #4caf50; background: #e8f5e9; border-style: solid; }
        .drop-zone-content { pointer-events: none; }
        .drop-zone-content button { pointer-events: auto; }

        /* é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .selected-files-section {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        /* ç¸¦ç©ã¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ */
        .file-list-vertical {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 4px solid #1565c0;
        }
        .file-item:hover { background: #e3f2fd; }
        .file-item .file-info { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        .file-item .file-icon { font-size: 18px; }
        .file-item .file-name { font-weight: bold; font-size: 12px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-item .file-size { font-size: 10px; color: #666; white-space: nowrap; }
        .file-item .remove-btn { background: #f44336; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; font-size: 10px; cursor: pointer; }
        .file-item .remove-btn:hover { background: #d32f2f; }

        /* å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ */
        .imported-data-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .data-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .data-item:hover { border-color: #1565c0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .data-item .data-info { flex: 1; }
        .data-item .data-name { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 5px; }
        .data-item .data-meta { font-size: 11px; color: #666; display: flex; gap: 15px; flex-wrap: wrap; }
        .data-item .data-meta span { background: #f5f5f5; padding: 2px 8px; border-radius: 10px; }
        .data-item .data-actions { display: flex; gap: 8px; }
        .data-item .data-actions button { padding: 8px 15px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .data-item .save-btn { background: #4caf50; color: #fff; }
        .data-item .save-btn:hover { background: #43a047; }
        .data-item .view-btn { background: #2196f3; color: #fff; }
        .data-item .view-btn:hover { background: #1e88e5; }
        .data-item .delete-btn { background: #f44336; color: #fff; }
        .data-item .delete-btn:hover { background: #e53935; }
        .empty-message { text-align: center; padding: 30px; color: #999; font-size: 14px; }

        /* ä¿å­˜æ¸ˆã¿å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ */
        .history-item {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #fff;
            border-bottom: 1px solid #e1bee7;
            gap: 10px;
        }
        .history-item:last-child { border-bottom: none; }
        .history-item:hover { background: #fce4ec; }
        .history-title { font-weight: bold; color: #7b1fa2; font-size: 13px; }
        .history-meta { font-size: 11px; color: #666; }
        .history-stores { font-size: 11px; color: #4caf50; }
        .history-actions { display: flex; gap: 8px; }
        .history-actions .load-btn {
            background: #4caf50; color: #fff; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;
        }
        .history-actions .load-btn:hover { background: #43a047; }
        .history-actions .delete-btn {
            background: #f44336; color: #fff; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;
        }
        .history-actions .delete-btn:hover { background: #e53935; }

        /* å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ */
        .data-history-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f2f5;
            z-index: 1000;
            overflow-y: auto;
        }
        .data-history-header {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: #fff;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-history-header h2 { margin: 0; font-size: 20px; }
        .data-history-content {
            padding: 20px 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .data-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .history-data-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s;
        }
        .history-data-item:hover {
            border-color: #1565c0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .history-data-item .item-info { flex: 1; }
        .history-data-item .item-name {
            font-weight: bold;
            font-size: 16px;
            color: #1565c0;
            margin-bottom: 8px;
        }
        .history-data-item .item-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 12px;
            color: #666;
        }
        .history-data-item .item-meta span {
            background: #f5f5f5;
            padding: 4px 12px;
            border-radius: 15px;
        }
        .history-data-item .item-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .history-data-item .item-actions button {
            padding: 10px 20px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .history-data-item .btn-view { background: #2196f3; color: #fff; }
        .history-data-item .btn-view:hover { background: #1976d2; }
        .history-data-item .btn-save { background: #4caf50; color: #fff; }
        .history-data-item .btn-save:hover { background: #43a047; }
        .history-data-item .btn-delete { background: #f44336; color: #fff; }
        .history-data-item .btn-delete:hover { background: #e53935; }

        /* å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .history-section { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .history-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; }
        .history-item { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .history-item:hover { border-color: #1565c0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .history-title { font-weight: bold; font-size: 12px; color: #1565c0; }
        .history-meta { font-size: 10px; color: #666; }
        .history-stores { font-size: 10px; color: #888; }
        .history-actions { display: flex; gap: 5px; margin-top: 5px; }
        .history-actions button { padding: 4px 10px; font-size: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .history-actions .load-btn { background: #1565c0; color: #fff; }
        .history-actions .delete-btn { background: #f44336; color: #fff; }

        /* ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« */
        .data-view-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .data-view-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
        }
        .data-view-container {
            position: relative;
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }
        .data-view-header {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: #fff;
            padding: 15px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-view-header h3 { margin: 0; font-size: 16px; }
        .data-view-body {
            padding: 20px;
            overflow: auto;
            flex: 1;
        }
        .data-view-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .data-view-table th, .data-view-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
        }
        .data-view-table th {
            background: #e3f2fd;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .data-view-table tr:nth-child(even) { background: #f9f9f9; }
        .data-view-table tr:hover { background: #e8f4fc; }

        /* ãƒˆãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– */
        .main-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: #fff;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .main-nav-tab {
            padding: 15px 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            background: transparent;
            border: none;
        }
        .main-nav-tab:hover { background: #f5f5f5; }
        .main-nav-tab.active {
            color: #fff;
        }
        .main-nav-tab.import-tab.active {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
        }
        .main-nav-tab.budget-tab.active {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }
        .main-nav-tab.simulation-tab.active {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
        }
        .main-nav-tab.export-tab.active {
            background: linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);
        }
        .main-nav-tab .tab-icon { font-size: 24px; }
        .main-page { display: none; }
        .main-page.active { display: block; }

        /* ã‚µãƒ–ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .import-subtabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .subtab {
            padding: 12px 24px;
            border: none;
            background: #f5f5f5;
            color: #666;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
            transition: all 0.3s ease;
        }
        .subtab:hover {
            background: #e0e0e0;
        }
        .subtab.active {
            background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
            color: #fff;
        }
        .import-subtab-content {
            display: none;
        }
        .import-subtab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .summary-grid { grid-template-columns: repeat(3, 1fr); }
            .month-cols-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>v15 äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆé¡§å®¢CSVå¯¾å¿œç‰ˆ v5.8ï¼‰</h1>
        <p class="subtitle">å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–ï¼šé¡§å®¢äºˆç®—â†’ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›ã®å¤‰æ›ã‚¿ã‚¤ãƒ—ï¼ˆç›´æ¥/åˆè¨ˆ/ç‡/å‡ºåŠ›ï¼‰ã‚’æ˜ç¤ºåŒ–</p>

        <!-- ===== ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– ===== -->
        <div class="main-nav">
            <button class="main-nav-tab import-tab active" onclick="showMainPage('import')">
                <span class="tab-icon">ğŸ“¥</span>
                <span>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
            </button>
            <button class="main-nav-tab budget-tab" onclick="showMainPage('budget')">
                <span class="tab-icon">ğŸ“Š</span>
                <span>äºˆç®—è¨­å®š</span>
            </button>
            <button class="main-nav-tab simulation-tab" onclick="showMainPage('simulation')">
                <span class="tab-icon">ğŸ§®</span>
                <span>äºˆç®—è©¦ç®—</span>
            </button>
            <button class="main-nav-tab export-tab" onclick="showMainPage('export')">
                <span class="tab-icon">ğŸ“¤</span>
                <span>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
            </button>
        </div>

        <!-- ===== ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ ===== -->
        <div id="page-import" class="main-page active">
            <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="import-subtabs">
                <button class="subtab active" onclick="switchImportSubtab('budget')">ğŸ“¥ äºˆç®—ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="subtab" onclick="switchImportSubtab('settings')">âš™ï¸ è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="subtab" onclick="switchImportSubtab('master')">ğŸ”§ ãƒã‚¹ã‚¿è¨­å®š</button>
                <button class="subtab" onclick="switchImportSubtab('history')">ğŸ“‹ å–è¾¼å±¥æ­´</button>
            </div>

            <!-- ===== äºˆç®—ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚µãƒ–ã‚¿ãƒ– ===== -->
            <div id="import-subtab-budget" class="import-subtab-content active">
                <div class="import-section" style="border-left:4px solid #2196f3;">
                    <h2 style="color:#1565c0;font-size:18px;margin-bottom:20px;">ğŸ“¥ é¡§å®¢äºˆç®—CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>

                    <!-- äºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
                    <div style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-radius:8px;border:1px solid #90caf9;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <div style="font-size:12px;color:#1565c0;">
                                <strong>äºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</strong><br>
                                ç©ºã®äºˆç®—CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                            </div>
                            <button class="btn btn-info" onclick="downloadBudgetTemplate()" style="padding:8px 16px;font-size:12px;">
                                ğŸ“„ äºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>

                <!-- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
                <div id="dropZone" class="drop-zone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="drop-zone-content">
                        <div style="font-size:50px;margin-bottom:15px;">ğŸ“</div>
                        <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div style="font-size:12px;color:#666;margin-bottom:15px;">ã¾ãŸã¯</div>
                        <input type="file" id="csvFile" accept=".csv" multiple onchange="handleFileSelect(event)" style="display:none;">
                        <button class="btn btn-primary" style="padding:12px 30px;font-size:14px;" onclick="document.getElementById('csvFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</button>
                    </div>
                </div>

                <!-- é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆç¸¦ç©ã¿ï¼‰ -->
                <div id="selectedFilesList" class="selected-files-section" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <div style="font-weight:bold;font-size:14px;">é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ (<span id="fileCount">0</span>ä»¶)</div>
                        <div>
                            <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()" style="padding:6px 15px;font-size:11px;">ï¼‹è¿½åŠ </button>
                            <button class="btn" style="background:#ff5722;color:#fff;padding:6px 15px;font-size:11px;" onclick="clearSelectedFiles()">å…¨ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                    <div id="fileListContainer" class="file-list-vertical"></div>
                    <div style="margin-top:15px;">
                        <button class="btn btn-success" onclick="importAllCSVs()" id="importBtn" style="width:100%;padding:15px;font-size:16px;">ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                    </div>
                </div>

                <div id="importStatus" style="margin-top:10px;"></div>

                <!-- å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ãƒœã‚¿ãƒ³ -->
                <div style="margin-top:20px;padding-top:20px;border-top:2px solid #e0e0e0;">
                    <button class="btn" style="background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);color:#fff;padding:15px 30px;width:100%;font-size:16px;border-radius:8px;" onclick="showDataHistoryPage()">
                        ğŸ“‹ å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ã‚’è¦‹ã‚‹ (<span id="importedStoreCount">0</span>ä»¶)
                    </button>
                </div>

                <!-- æ¤œå‡ºçµæœè¡¨ç¤º -->
                <div class="info-bar" style="margin-top:15px;">
                    <div><span class="info-label">åº—èˆ—å:</span> <span class="info-value" id="detectedStore">-</span></div>
                    <div><span class="info-label">æ¤œå‡ºæœˆæ•°:</span> <span class="info-value" id="detectedMonthCount">-</span></div>
                    <div><span class="info-label">ãƒãƒƒãƒé …ç›®:</span> <span class="info-value" id="detectedItemCount">-</span></div>
                    <div><span class="info-label">æœªãƒãƒƒãƒé …ç›®:</span> <span class="info-value" id="unmatchedCount">-</span></div>
                </div>
            </div>

            <!-- åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ -->
            <div class="store-selector" id="storeSelector" style="display:none;">
                <label>è¡¨ç¤ºåº—èˆ—:</label>
                <select id="storeSelect" onchange="switchStore(this.value)">
                    <option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>
                </select>
                <div class="store-list" id="storeList"></div>
                <span style="margin-left:auto; font-size:10px; color:#666;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆ: <strong id="storeCount">0</strong>åº—èˆ—</span>
            </div>

            <!-- ãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚µãƒãƒªãƒ¼ -->
            <div class="section" style="margin-top:15px;">
                <div class="section-header header-mapping">ãƒãƒƒãƒ”ãƒ³ã‚°çµæœ</div>
                <div class="section-body">
                    <!-- ãƒãƒƒãƒçµæœã‚µãƒãƒªãƒ¼ -->
                    <div style="display:flex;gap:20px;align-items:center;margin-bottom:15px;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="background:#4caf50;color:#fff;padding:6px 15px;border-radius:20px;font-weight:bold;">
                                âœ“ ãƒãƒƒãƒ: <span id="matchedCountDisplay">0</span>ä»¶
                            </span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span id="unmatchedBadge" style="background:#f44336;color:#fff;padding:6px 15px;border-radius:20px;font-weight:bold;display:none;">
                                âœ— æœªãƒãƒƒãƒ: <span id="unmatchedCountDisplay">0</span>ä»¶
                            </span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span id="unusedBadge" style="background:#ff9800;color:#fff;padding:6px 15px;border-radius:20px;font-weight:bold;display:none;">
                                âš  æœªä½¿ç”¨: <span id="unusedCountDisplay">0</span>ä»¶
                            </span>
                        </div>
                    </div>

                    <!-- æœªãƒãƒƒãƒé …ç›®ï¼ˆã‚ã‚Œã°è¡¨ç¤ºï¼‰ -->
                    <div id="unmatchedSection" style="display:none;background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:15px;margin-bottom:15px;">
                        <h4 style="color:#856404;margin-bottom:10px;">âš ï¸ æœªãƒãƒƒãƒé …ç›®ï¼ˆCSVã«ã‚ã‚‹ãŒãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ãŒãªã„ï¼‰</h4>
                        <div id="unmatchedList" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                        <div id="similarSuggestions" style="margin-top:10px;"></div>
                        <div class="form-row" style="margin-top:15px;padding-top:15px;border-top:1px solid #ddd;">
                            <label>æ–°è¦ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ :</label>
                            <input type="text" id="newCode" placeholder="ã‚³ãƒ¼ãƒ‰" style="width:80px;">
                            <input type="text" id="newName" placeholder="é …ç›®å" style="width:120px;">
                            <input type="number" id="newV15No" placeholder="v15ç•ªå·" style="width:80px;">
                            <select id="newCategory">
                                <option value="å£²ä¸Š">å£²ä¸Š</option>
                                <option value="åŸä¾¡">åŸä¾¡</option>
                                <option value="å›ºå®šäººä»¶è²»">å›ºå®šäººä»¶è²»</option>
                                <option value="PAäººä»¶è²»">PAäººä»¶è²»</option>
                                <option value="çµŒè²»">çµŒè²»</option>
                                <option value="å›ºå®šè²»">å›ºå®šè²»</option>
                                <option value="åˆ©ç›Š">åˆ©ç›Š</option>
                            </select>
                            <button class="btn btn-success" onclick="addMapping()">è¿½åŠ </button>
                        </div>
                    </div>

                    <!-- æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚ã‚Œã°è¡¨ç¤ºï¼‰ -->
                    <div id="unusedSection" style="display:none;background:#fff8e1;border:2px solid #ff9800;border-radius:8px;padding:15px;margin-bottom:15px;">
                        <h4 style="color:#e65100;margin-bottom:10px;">âš ï¸ æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®šç¾©ã¯ã‚ã‚‹ãŒCSVã«å­˜åœ¨ã—ãªã„ï¼‰</h4>
                        <div id="unusedList" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                        <button class="btn btn-warning" style="margin-top:10px;" onclick="removeUnusedMappings()">æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤</button>
                    </div>

                    <!-- ãƒãƒƒãƒ”ãƒ³ã‚°ç®¡ç†ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:8px;">
                        <button class="btn btn-primary" onclick="toggleEditMode()">
                            <span id="editModeLabel">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
                        </button>
                        <label class="btn btn-info" style="cursor:pointer;margin:0;">
                            ğŸ“¥ ãƒãƒƒãƒ”ãƒ³ã‚°CSVèª­è¾¼
                            <input type="file" accept=".csv" onchange="importMappingCSV(event)" style="display:none;">
                        </label>
                        <button class="btn btn-secondary" onclick="exportMappingCSV()">ğŸ“¤ ãƒãƒƒãƒ”ãƒ³ã‚°CSVå‡ºåŠ›</button>
                        <button class="btn btn-warning" onclick="detectUnusedMappings()">ğŸ” æœªä½¿ç”¨æ¤œå‡º</button>
                        <button class="btn" style="background:linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);color:#fff;" onclick="runSmartImport()">ğŸ¤– ã‚¹ãƒãƒ¼ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    </div>

                    <!-- æŠ˜ã‚ŠãŸãŸã¿å¼ãƒãƒƒãƒ”ãƒ³ã‚°è©³ç´° -->
                    <details style="margin-top:10px;" id="mappingDetails">
                        <summary style="cursor:pointer;padding:10px;background:#f5f5f5;border-radius:4px;font-weight:bold;color:#666;">
                            ğŸ“‹ ãƒãƒƒãƒ”ãƒ³ã‚°è©³ç´°ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰
                        </summary>
                        <div id="mappingTable" style="margin-top:10px;"></div>
                    </details>
                </div>
            </div>

            <!-- äºˆç®—å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section" style="margin-top:15px;">
                <div class="section-header header-input">ã€1ã€‘é¡§å®¢äºˆç®—å…¥åŠ›ï¼ˆCSVå–è¾¼å€¤ï¼‰</div>
                <div class="section-body">
                    <table class="annual-table" id="inputTable"></table>
                </div>
            </div>

            <!-- å‡¦ç†ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section" style="margin-top:15px;">
                <div class="section-header" style="background:#455a64;color:#fff;">å‡¦ç†ãƒ­ã‚°</div>
                <div class="section-body">
                    <div id="preprocessLog" class="preprocess-log">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„</div>
                </div>
            </div>
            </div><!-- /import-subtab-budget -->

            <!-- ===== è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚µãƒ–ã‚¿ãƒ– ===== -->
            <div id="import-subtab-settings" class="import-subtab-content">
                <!-- åº—ç•ªã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="import-section" style="border-left:4px solid #4caf50;margin-bottom:20px;">
                    <h2 style="color:#2e7d32;font-size:18px;margin-bottom:20px;">ğŸª åº—ç•ªã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>

                    <!-- åº—ç•ªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
                    <div style="margin-bottom:20px;padding:15px;background:#e8f5e9;border-radius:8px;border:1px solid #a5d6a7;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <div style="font-size:12px;color:#2e7d32;">
                                <strong>åº—ç•ªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</strong><br>
                                åº—ç•ªãƒ»åº—èˆ—åã®CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                            </div>
                            <button class="btn" style="background:#4caf50;color:#fff;padding:8px 16px;font-size:12px;" onclick="downloadStoreTemplate()">
                                ğŸ“„ åº—ç•ªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>

                    <!-- åº—ç•ªCSVãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
                    <div id="storeDropZone" class="drop-zone" ondrop="handleStoreDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" style="border-color:#4caf50;">
                        <div class="drop-zone-content">
                            <div style="font-size:50px;margin-bottom:15px;">ğŸª</div>
                            <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">åº—ç•ªCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div style="font-size:12px;color:#666;margin-bottom:15px;">ã¾ãŸã¯</div>
                            <input type="file" id="storeCSVFile" accept=".csv" onchange="handleStoreFileSelect(event)" style="display:none;">
                            <button class="btn" style="background:#4caf50;color:#fff;padding:12px 30px;font-size:14px;" onclick="document.getElementById('storeCSVFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                        </div>
                    </div>
                    <div id="storeImportStatus" style="margin-top:10px;"></div>
                </div>

                <!-- äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="import-section" style="border-left:4px solid #ff9800;">
                    <h2 style="color:#e65100;font-size:18px;margin-bottom:20px;">ğŸ“‹ äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>

                    <!-- äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
                    <div style="margin-bottom:20px;padding:15px;background:#fff3e0;border-radius:8px;border:1px solid #ffcc80;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <div style="font-size:12px;color:#e65100;">
                                <strong>äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</strong><br>
                                ç¾åœ¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                            </div>
                            <button class="btn" style="background:#ff9800;color:#fff;padding:8px 16px;font-size:12px;" onclick="downloadMappingTemplate()">
                                ğŸ“„ é …ç›®ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>

                    <!-- äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰CSVãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
                    <div id="mappingDropZone" class="drop-zone" ondrop="handleMappingDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" style="border-color:#ff9800;">
                        <div class="drop-zone-content">
                            <div style="font-size:50px;margin-bottom:15px;">ğŸ“‹</div>
                            <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰CSVã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div style="font-size:12px;color:#666;margin-bottom:15px;">ã¾ãŸã¯</div>
                            <input type="file" id="mappingCSVFile" accept=".csv" onchange="importMappingCSV(event)" style="display:none;">
                            <button class="btn" style="background:#ff9800;color:#fff;padding:12px 30px;font-size:14px;" onclick="document.getElementById('mappingCSVFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                        </div>
                    </div>
                    <div id="mappingImportStatus" style="margin-top:10px;"></div>

                    <!-- ç¾åœ¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ä¸€è¦§ -->
                    <div style="margin-top:20px;">
                        <details>
                            <summary style="cursor:pointer;padding:10px;background:#fff3e0;border-radius:4px;font-weight:bold;color:#e65100;">
                                ğŸ“‹ ç¾åœ¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰
                            </summary>
                            <div id="currentMappingList" style="margin-top:10px;max-height:400px;overflow-y:auto;"></div>
                        </details>
                    </div>
                </div>

                <!-- æœˆåˆ¥å®¢å˜ä¾¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="import-section" style="border-left:4px solid #2196f3;">
                    <h2 style="color:#1565c0;font-size:18px;margin-bottom:20px;">ğŸ’° æœˆåˆ¥å®¢å˜ä¾¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>

                    <!-- æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
                    <div style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-radius:8px;border:1px solid #90caf9;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <div style="font-size:12px;color:#1565c0;">
                                <strong>æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</strong><br>
                                åº—èˆ—åˆ¥ãƒ»æœˆåˆ¥ï¼ˆ4æœˆã€œ3æœˆï¼‰ã®ç›®æ¨™å®¢å˜ä¾¡ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™
                            </div>
                            <button class="btn" style="background:#2196f3;color:#fff;padding:8px 16px;font-size:12px;" onclick="downloadUnitPriceMonthlyTemplate()">
                                ğŸ“„ æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>

                    <!-- æœˆåˆ¥å®¢å˜ä¾¡CSVãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
                    <div id="unitPriceDropZone" class="drop-zone" ondrop="handleUnitPriceDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" style="border-color:#2196f3;">
                        <div class="drop-zone-content">
                            <div style="font-size:50px;margin-bottom:15px;">ğŸ’°</div>
                            <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">æœˆåˆ¥å®¢å˜ä¾¡CSVã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div style="font-size:12px;color:#666;margin-bottom:15px;">ã¾ãŸã¯</div>
                            <input type="file" id="unitPriceCSVFile" accept=".csv" onchange="handleUnitPriceFileSelect(event)" style="display:none;">
                            <button class="btn" style="background:#2196f3;color:#fff;padding:12px 30px;font-size:14px;" onclick="document.getElementById('unitPriceCSVFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                        </div>
                    </div>
                    <div id="unitPriceImportStatus" style="margin-top:10px;"></div>

                    <!-- CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¬æ˜ -->
                    <div style="margin-top:15px;padding:10px;background:#e3f2fd;border-radius:8px;font-size:11px;color:#1565c0;">
                        <strong>CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</strong><br>
                        1è¡Œç›®: åº—ç•ª,åº—èˆ—å,å®¢å˜ä¾¡ã‚¿ã‚¤ãƒ—,4æœˆ,5æœˆ,6æœˆ,7æœˆ,8æœˆ,9æœˆ,10æœˆ,11æœˆ,12æœˆ,1æœˆ,2æœˆ,3æœˆ<br>
                        2è¡Œç›®ä»¥é™: 001,åº—èˆ—å,ç·åˆ,5000,5000,5000,... / 001,åº—èˆ—å,ãƒ©ãƒ³ãƒ,1000,... / 001,åº—èˆ—å,ãƒ‡ã‚£ãƒŠãƒ¼,5000,...
                    </div>
                </div>
            </div><!-- /import-subtab-settings -->

            <!-- ===== ãƒã‚¹ã‚¿è¨­å®šã‚µãƒ–ã‚¿ãƒ– ===== -->
            <div id="import-subtab-master" class="import-subtab-content">
                <!-- åº—ç•ªãƒã‚¹ã‚¿è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="import-section" style="border-left:4px solid #4caf50;margin-bottom:20px;">
                    <h2 style="color:#2e7d32;font-size:18px;margin-bottom:20px;">ğŸª åº—ç•ªãƒã‚¹ã‚¿è¨­å®š</h2>
                    <p style="color:#666;font-size:11px;margin-bottom:15px;">
                        åº—ç•ªã¨åº—åã®ç´ä»˜ã‘ã‚’ç·¨é›†ã§ãã¾ã™ã€‚ã“ã®è¨­å®šã¯äºˆç®—CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®åº—èˆ—ãƒãƒƒãƒãƒ³ã‚°ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
                    </p>

                    <!-- æ“ä½œãƒœã‚¿ãƒ³ç¾¤ -->
                    <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                        <button id="toggleStoreSummaryBtn" class="btn" style="background:#4caf50;color:#fff;padding:10px 20px;font-size:12px;" onclick="toggleStoreSummary()">
                            ğŸ“‹ åº—ç•ªä¸€è¦§
                        </button>
                        <button class="btn" style="background:#8bc34a;color:#fff;padding:10px 20px;font-size:12px;" onclick="showAddStoreModal()">
                            â• æ–°è¦åº—ç•ªè¿½åŠ 
                        </button>
                        <button class="btn" style="background:#2196f3;color:#fff;padding:10px 20px;font-size:12px;" onclick="saveStoreSettings()">
                            ğŸ’¾ åº—ç•ªè¨­å®šã‚’ä¿å­˜
                        </button>
                    </div>

                    <!-- åº—ç•ªä¸€è¦§ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
                    <div id="storeSummaryList" style="display:none;background:#fff;border:1px solid #e0e0e0;border-radius:8px;">
                        <!-- JavaScript ã§æç”» -->
                    </div>

                    <div id="storeSummaryGuide" style="display:none;margin-top:15px;padding:10px;background:#e8f5e9;border-radius:8px;font-size:11px;color:#558b2f;border:1px solid #c5e1a5;">
                        <strong>æ“ä½œã‚¬ã‚¤ãƒ‰:</strong><br>
                        ãƒ»<strong>â†‘â†“ãƒœã‚¿ãƒ³</strong>: åº—èˆ—ã®è¡¨ç¤ºé †ã‚’å¤‰æ›´<br>
                        ãƒ»<strong>âœï¸ ç·¨é›†</strong>: åº—ç•ªãƒ»åº—åã‚’ç·¨é›†<br>
                        ãƒ»<strong>ğŸ—‘ï¸ å‰Šé™¤</strong>: åº—èˆ—ã‚’å‰Šé™¤<br>
                        ãƒ»è¨­å®šã¯LocalStorageã«ä¿å­˜ã•ã‚Œã€æ¬¡å›èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«å¾©å…ƒã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>

                <!-- å®¢å˜ä¾¡ãƒã‚¹ã‚¿è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="import-section" style="border-left:4px solid #2196f3;margin-bottom:20px;">
                    <h2 style="color:#1565c0;font-size:18px;margin-bottom:20px;">ğŸ’° å®¢å˜ä¾¡ãƒã‚¹ã‚¿è¨­å®š</h2>
                    <p style="color:#666;font-size:11px;margin-bottom:15px;">
                        åº—èˆ—åˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¢å˜ä¾¡ã‚’ç·¨é›†ã§ãã¾ã™ã€‚ã“ã®è¨­å®šã¯äºˆç®—ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®åˆæœŸå€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
                    </p>

                    <!-- æ“ä½œãƒœã‚¿ãƒ³ç¾¤ -->
                    <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                        <button id="toggleUnitPriceSummaryBtn" class="btn" style="background:#2196f3;color:#fff;padding:10px 20px;font-size:12px;" onclick="toggleUnitPriceSummary()">
                            ğŸ“‹ å®¢å˜ä¾¡ä¸€è¦§
                        </button>
                        <button class="btn" style="background:#2196f3;color:#fff;padding:10px 20px;font-size:12px;" onclick="saveUnitPriceSettings()">
                            ğŸ’¾ å®¢å˜ä¾¡è¨­å®šã‚’ä¿å­˜
                        </button>
                    </div>

                    <!-- å®¢å˜ä¾¡ä¸€è¦§ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
                    <div id="unitPriceSummaryList" style="display:none;background:#fff;border:1px solid #e0e0e0;border-radius:8px;">
                        <!-- JavaScript ã§æç”» -->
                    </div>

                    <div id="unitPriceSummaryGuide" style="display:none;margin-top:15px;padding:10px;background:#e3f2fd;border-radius:8px;font-size:11px;color:#0277bd;border:1px solid #81d4fa;">
                        <strong>æ“ä½œã‚¬ã‚¤ãƒ‰:</strong><br>
                        ãƒ»<strong>âœï¸ ç·¨é›†</strong>: åº—èˆ—ã®å®¢å˜ä¾¡ï¼ˆç·åˆ/ãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰ã‚’ç·¨é›†<br>
                        ãƒ»<strong>ğŸ—‘ï¸ å‰Šé™¤</strong>: å®¢å˜ä¾¡è¨­å®šã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã‚‹ï¼‰<br>
                        ãƒ»è¨­å®šã¯LocalStorageã«ä¿å­˜ã•ã‚Œã€æ¬¡å›èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«å¾©å…ƒã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>

                <!-- äºˆç®—é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="import-section" style="border-left:4px solid #ff9800;margin-bottom:20px;">
                    <h2 style="color:#f57c00;font-size:18px;margin-bottom:20px;">âœï¸ äºˆç®—é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š</h2>
                    <p style="color:#666;font-size:11px;margin-bottom:15px;">
                        äºˆç®—ã‚«ãƒ†ã‚´ãƒªã¨äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ï¼ˆç§‘ç›®ã‚³ãƒ¼ãƒ‰ï¼‰ãƒ»äºˆç®—é …ç›®åã®ç´ä»˜ã‘ã‚’ç·¨é›†ã§ãã¾ã™ã€‚<br>
                        ã“ã®è¨­å®šã¯äºˆç®—CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®é …ç›®ãƒãƒƒãƒãƒ³ã‚°ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
                    </p>

                    <!-- æ“ä½œãƒœã‚¿ãƒ³ç¾¤ -->
                    <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                        <button id="toggleCategorySummaryBtn" class="btn" style="background:#ff9800;color:#fff;padding:10px 20px;font-size:12px;" onclick="toggleCategorySummary()">
                            ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªä¸€è¦§
                        </button>
                        <button class="btn" style="background:#4caf50;color:#fff;padding:10px 20px;font-size:12px;" onclick="showAddItemMappingModal()">
                            â• æ–°è¦é …ç›®è¿½åŠ 
                        </button>
                        <button class="btn" style="background:#2196f3;color:#fff;padding:10px 20px;font-size:12px;" onclick="saveCategorySettings()">
                            ğŸ’¾ è¨­å®šã‚’ä¿å­˜
                        </button>
                        <button class="btn" style="background:#9e9e9e;color:#fff;padding:10px 20px;font-size:12px;" onclick="resetCategorySettings()">
                            ğŸ”„ åˆæœŸè¨­å®šã«æˆ»ã™
                        </button>
                    </div>

                    <!-- ã‚«ãƒ†ã‚´ãƒªã‚µãƒãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
                    <div id="categorySummaryList" style="display:none;background:#fff;border:1px solid #e0e0e0;border-radius:8px;">
                        <!-- JavaScript ã§æç”» -->
                    </div>

                    <div id="categorySummaryGuide" style="display:none;margin-top:15px;padding:10px;background:#fff8e1;border-radius:8px;font-size:11px;color:#f57c00;border:1px solid #ffc107;">
                        <strong>æ“ä½œã‚¬ã‚¤ãƒ‰:</strong><br>
                        ãƒ»<strong>â†‘â†“ãƒœã‚¿ãƒ³</strong>: ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †ã‚’å¤‰æ›´<br>
                        ãƒ»<strong>ğŸ“‹ é …ç›®ä¸€è¦§</strong>: ã‚«ãƒ†ã‚´ãƒªå†…ã®é …ç›®ã‚’è¡¨ç¤ºãƒ»ç·¨é›†<br>
                        ãƒ»è¨­å®šã¯LocalStorageã«ä¿å­˜ã•ã‚Œã€æ¬¡å›èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«å¾©å…ƒã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>

                <!-- ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="import-section" style="border-left:4px solid #9c27b0;margin-bottom:20px;">
                    <h2 style="color:#7b1fa2;font-size:18px;margin-bottom:20px;">âš™ï¸ ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                    <div style="display:flex;gap:15px;flex-wrap:wrap;">
                        <button class="btn" style="background:linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);color:#fff;padding:15px 30px;font-size:14px;border-radius:8px;" onclick="showMasterDataModal()">
                            ğŸ“‹ ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§
                        </button>
                        <button class="btn" style="background:#4caf50;color:#fff;padding:15px 30px;font-size:14px;border-radius:8px;" onclick="saveMasterDataToHistory()">
                            ğŸ’¾ ç¾åœ¨ã®ãƒã‚¹ã‚¿ã‚’å±¥æ­´ã«ä¿å­˜
                        </button>
                    </div>
                    <div style="margin-top:15px;padding:10px;background:#f3e5f5;border-radius:8px;font-size:11px;color:#7b1fa2;">
                        <strong>ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã¯ï¼Ÿ</strong><br>
                        äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ï¼ˆCUSTOMER_CODE_MAP / NAME_BASED_MAPï¼‰ã¨åº—ç•ªï¼ˆDEFAULT_UNIT_PRICESï¼‰ã®è¨­å®šæƒ…å ±ã§ã™ã€‚<br>
                        å±¥æ­´ã«ä¿å­˜ã—ã¦ãŠãã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚æ¬¡å›èµ·å‹•æ™‚ã«å¾©å…ƒã§ãã¾ã™ã€‚
                    </div>
                </div>
            </div><!-- /import-subtab-master -->

            <!-- ===== å–è¾¼å±¥æ­´ã‚µãƒ–ã‚¿ãƒ– ===== -->
            <div id="import-subtab-history" class="import-subtab-content">
                <div class="import-section" style="border-left:4px solid #9c27b0;">
                    <h2 style="color:#7b1fa2;font-size:18px;margin-bottom:20px;">ğŸ“‹ å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´</h2>

                    <div style="margin-bottom:15px;padding:12px;background:#f3e5f5;border-radius:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <div style="font-size:12px;color:#7b1fa2;">
                                <strong>å±¥æ­´ã«ã¤ã„ã¦</strong><br>
                                ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸäºˆç®—ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
                                å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ç·¨é›†ãƒ»ç¢ºèªãƒ»å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå¯èƒ½ã§ã™ã€‚
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                <button onclick="saveCurrentToHistory()" class="btn" style="padding:8px 15px;font-size:11px;background:#4caf50;color:#fff;border:none;border-radius:4px;">
                                    ğŸ’¾ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                                </button>
                                <label class="btn" style="padding:8px 15px;font-size:11px;background:#ff9800;color:#fff;border:none;border-radius:4px;cursor:pointer;">
                                    ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–èª­è¾¼
                                    <input type="file" accept=".json" onchange="importBudgetArchive(event)" style="display:none;">
                                </label>
                                <button onclick="clearAllBudgetHistory()" class="btn" style="padding:8px 15px;font-size:11px;background:#f44336;color:#fff;border:none;border-radius:4px;">
                                    ğŸ—‘ï¸ å…¨å±¥æ­´å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                        <label style="font-size:12px;font-weight:bold;color:#333;">çµã‚Šè¾¼ã¿:</label>
                        <select id="historyStoreFilter" onchange="renderBudgetHistoryList()" style="padding:8px 12px;border:2px solid #9c27b0;border-radius:4px;font-size:12px;min-width:180px;">
                            <option value="">å…¨ã¦ã®åº—èˆ—</option>
                        </select>
                        <span id="historyCount" style="font-size:11px;color:#666;margin-left:auto;">å±¥æ­´: 0ä»¶</span>
                    </div>

                    <!-- å±¥æ­´ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div style="overflow-x:auto;">
                        <table class="data-table" style="width:100%;font-size:12px;" id="budgetHistoryTable">
                            <thead>
                                <tr style="background:#9c27b0;color:#fff;">
                                    <th style="padding:10px;text-align:left;min-width:150px;">åº—èˆ—å</th>
                                    <th style="padding:10px;text-align:center;min-width:140px;">å–è¾¼æ—¥æ™‚</th>
                                    <th style="padding:10px;text-align:center;min-width:80px;">å¯¾è±¡æœˆæ•°</th>
                                    <th style="padding:10px;text-align:center;min-width:100px;">é …ç›®æ•°</th>
                                    <th style="padding:10px;text-align:center;min-width:200px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="budgetHistoryBody">
                                <tr>
                                    <td colspan="5" style="text-align:center;padding:40px;color:#999;">
                                        å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                                        äºˆç®—CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨è‡ªå‹•çš„ã«å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- å±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ -->
                    <div style="margin-top:20px;padding:15px;background:#fff3e0;border-radius:8px;border:1px solid #ffcc80;display:none;" id="historyDetailPreview">
                        <h4 style="color:#e65100;margin:0 0 10px 0;font-size:14px;">ğŸ“Š é¸æŠä¸­ã®å±¥æ­´è©³ç´°</h4>
                        <div id="historyDetailContent" style="font-size:11px;color:#333;"></div>
                    </div>
                </div>
            </div><!-- /import-subtab-history -->

            <!-- äºˆç®—è¡¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="budgetPreviewModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1002;overflow-y:auto;">
                <div style="background:#fff;border-radius:12px;margin:30px auto;max-width:95%;width:1200px;box-shadow:0 4px 30px rgba(0,0,0,0.4);">
                    <div style="background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 id="budgetPreviewTitle" style="margin:0;font-size:18px;">ğŸ“Š äºˆç®—è¡¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                        <button onclick="hideBudgetPreviewModal()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:14px;">âœ• é–‰ã˜ã‚‹</button>
                    </div>
                    <div style="padding:20px;">
                        <!-- åº—èˆ—æƒ…å ± -->
                        <div id="budgetPreviewInfo" style="margin-bottom:15px;padding:12px;background:#f3e5f5;border-radius:6px;font-size:12px;"></div>
                        <!-- äºˆç®—è¡¨ãƒ†ãƒ¼ãƒ–ãƒ« -->
                        <div style="overflow-x:auto;max-height:70vh;">
                            <table class="data-table" style="width:100%;font-size:11px;border-collapse:collapse;" id="budgetPreviewTable">
                                <thead id="budgetPreviewHead"></thead>
                                <tbody id="budgetPreviewBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="itemMappingEditModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1001;overflow-y:auto;">
                <div style="background:#fff;border-radius:12px;margin:50px auto;max-width:600px;width:95%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 id="mappingModalTitle" style="margin:0;font-size:18px;">âœï¸ é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†</h3>
                        <button onclick="hideItemMappingModal()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;">âœ• é–‰ã˜ã‚‹</button>
                    </div>
                    <div style="padding:25px;">
                        <input type="hidden" id="mappingEditMode" value="add">
                        <input type="hidden" id="mappingEditOriginalCode" value="">

                        <!-- ç§‘ç›®ã‚³ãƒ¼ãƒ‰ -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">ç§‘ç›®ã‚³ãƒ¼ãƒ‰ï¼ˆå¿…é ˆï¼‰</label>
                            <input type="text" id="mappingEditCode" placeholder="ä¾‹: 810" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            <p style="font-size:10px;color:#666;margin-top:5px;">äºˆç®—CSVã®ç§‘ç›®ã‚³ãƒ¼ãƒ‰åˆ—ï¼ˆBåˆ—ï¼‰ã¨ç…§åˆã•ã‚Œã¾ã™</p>
                        </div>

                        <!-- äºˆç®—é …ç›®å -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">äºˆç®—é …ç›®åï¼ˆå¿…é ˆï¼‰</label>
                            <input type="text" id="mappingEditName" placeholder="ä¾‹: åº—èˆ—å£²ä¸Šé«˜" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            <p style="font-size:10px;color:#666;margin-top:5px;">äºˆç®—CSVã®é …ç›®ååˆ—ã¨ç…§åˆã•ã‚Œã¾ã™</p>
                        </div>

                        <!-- äºˆç®—ã‚«ãƒ†ã‚´ãƒª -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">äºˆç®—ã‚«ãƒ†ã‚´ãƒªï¼ˆå¿…é ˆï¼‰</label>
                            <select id="mappingEditCategory" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                                <!-- JavaScript ã§æç”» -->
                            </select>
                        </div>

                        <!-- v17No -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">v17ç•ªå·</label>
                            <input type="number" id="mappingEditV17No" placeholder="ä¾‹: 1" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            <p style="font-size:10px;color:#666;margin-top:5px;">ãƒ©ã‚¯ãƒŸãƒ¼äºˆç®—é …ç›®ã¨ã®ç´ä»˜ã‘ç•ªå·ï¼ˆ0=æœªè¨­å®šï¼‰</p>
                        </div>

                        <!-- å…¥åŠ›ã‚¹ã‚¿ã‚¤ãƒ« -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">å…¥åŠ›ã‚¹ã‚¿ã‚¤ãƒ«</label>
                            <select id="mappingEditInputStyle" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                                <option value="A.ãã®ã¾ã¾å…¥åŠ›">A.ãã®ã¾ã¾å…¥åŠ›</option>
                                <option value="B.åˆç®—ã—ã¦å…¥åŠ›">B.åˆç®—ã—ã¦å…¥åŠ›</option>
                                <option value="C.è‡ªå‹•æ¼”ç®—">C.è‡ªå‹•æ¼”ç®—</option>
                                <option value="D.å‚ç…§ã®ã¿">D.å‚ç…§ã®ã¿</option>
                            </select>
                        </div>

                        <!-- å‡ºåŠ›å…ˆç”»é¢ -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">å‡ºåŠ›å…ˆç”»é¢</label>
                            <select id="mappingEditScreen" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                                <option value="è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š">è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š</option>
                                <option value="è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š">è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š</option>
                                <option value="è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š>å£²ä¸Šæ§‹æˆæ¯”è¨­å®š">è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š>å£²ä¸Šæ§‹æˆæ¯”è¨­å®š</option>
                                <option value="è‡ªå‹•">è‡ªå‹•</option>
                                <option value="å‚ç…§ã®ã¿">å‚ç…§ã®ã¿</option>
                            </select>
                        </div>

                        <!-- ãƒœã‚¿ãƒ³ -->
                        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:25px;">
                            <button id="mappingDeleteBtn" onclick="deleteItemMapping()" style="background:#f44336;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;display:none;">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                            <button onclick="hideItemMappingModal()" style="background:#9e9e9e;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="saveItemMapping()" style="background:#4caf50;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                                ğŸ’¾ ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªé …ç›®ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆBæ¡ˆï¼‰ -->
            <div id="categoryItemsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1001;overflow-y:auto;">
                <div style="background:#fff;border-radius:12px;margin:30px auto;max-width:900px;width:95%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <div id="categoryItemsModalHeader" style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 id="categoryItemsModalTitle" style="margin:0;font-size:18px;">ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªé …ç›®ä¸€è¦§</h3>
                        <button onclick="hideCategoryItemsModal()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;">âœ• é–‰ã˜ã‚‹</button>
                    </div>
                    <div style="padding:20px;">
                        <input type="hidden" id="categoryItemsModalCategory" value="">
                        <p style="color:#666;font-size:11px;margin-bottom:15px;">
                            é …ç›®ã®è¡¨ç¤ºé †ã‚’â†‘â†“ãƒœã‚¿ãƒ³ã§å¤‰æ›´ã§ãã¾ã™ã€‚ç·¨é›†ãƒœã‚¿ãƒ³ã§é …ç›®ã®è©³ç´°ã‚’ç·¨é›†ã§ãã¾ã™ã€‚
                        </p>
                        <div id="categoryItemsList" style="max-height:500px;overflow-y:auto;">
                            <!-- JavaScript ã§æç”» -->
                        </div>
                        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                            <button onclick="hideCategoryItemsModal()" style="background:#9e9e9e;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                                é–‰ã˜ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº—ç•ªç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="storeEditModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1001;overflow-y:auto;">
                <div style="background:#fff;border-radius:12px;margin:50px auto;max-width:500px;width:95%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 id="storeModalTitle" style="margin:0;font-size:18px;">ğŸª åº—ç•ªç·¨é›†</h3>
                        <button onclick="hideStoreModal()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;">âœ• é–‰ã˜ã‚‹</button>
                    </div>
                    <div style="padding:25px;">
                        <input type="hidden" id="storeEditMode" value="add">
                        <input type="hidden" id="storeEditOriginalName" value="">

                        <!-- åº—ç•ª -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">åº—ç•ªï¼ˆå¿…é ˆï¼‰</label>
                            <input type="text" id="storeEditCode" placeholder="ä¾‹: 101" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            <p style="font-size:10px;color:#666;margin-top:5px;">äºˆç®—CSVã®åº—ç•ªåˆ—ã¨ç…§åˆã•ã‚Œã¾ã™</p>
                        </div>

                        <!-- åº—å -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">åº—åï¼ˆå¿…é ˆï¼‰</label>
                            <input type="text" id="storeEditName" placeholder="ä¾‹: ãªã‹ã‚ã®ã¦ã£ãºã‚“ æœ¬åº—" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            <p style="font-size:10px;color:#666;margin-top:5px;">åº—èˆ—ã®è¡¨ç¤ºåã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™</p>
                        </div>

                        <!-- å®¢å˜ä¾¡ï¼ˆåˆè¨ˆï¼‰ -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">ç›®æ¨™å®¢å˜ä¾¡ï¼ˆåˆè¨ˆï¼‰</label>
                            <input type="number" id="storeEditTotal" placeholder="ä¾‹: 5000" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                        </div>

                        <!-- å®¢å˜ä¾¡ï¼ˆãƒ©ãƒ³ãƒãƒ»ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰ -->
                        <div style="display:flex;gap:15px;margin-bottom:20px;">
                            <div style="flex:1;">
                                <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">ãƒ©ãƒ³ãƒå®¢å˜ä¾¡</label>
                                <input type="number" id="storeEditLunch" placeholder="0" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            </div>
                            <div style="flex:1;">
                                <label style="display:block;font-weight:bold;font-size:12px;color:#333;margin-bottom:8px;">ãƒ‡ã‚£ãƒŠãƒ¼å®¢å˜ä¾¡</label>
                                <input type="number" id="storeEditDinner" placeholder="5000" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                            </div>
                        </div>

                        <!-- ãƒœã‚¿ãƒ³ -->
                        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:25px;">
                            <button id="storeDeleteBtn" onclick="deleteStore()" style="background:#f44336;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;display:none;">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                            <button onclick="hideStoreModal()" style="background:#9e9e9e;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="saveStore()" style="background:#4caf50;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                                ğŸ’¾ ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®¢å˜ä¾¡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœˆåˆ¥å¯¾å¿œï¼‰ -->
            <div id="unitPriceEditModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1001;overflow-y:auto;">
                <div style="background:#fff;border-radius:12px;margin:30px auto;max-width:900px;width:95%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg, #2196f3 0%, #1565c0 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 id="unitPriceModalTitle" style="margin:0;font-size:18px;">ğŸ’° å®¢å˜ä¾¡ç·¨é›†</h3>
                        <button onclick="hideUnitPriceModal()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;">âœ• é–‰ã˜ã‚‹</button>
                    </div>
                    <div style="padding:25px;">
                        <input type="hidden" id="unitPriceEditStoreName" value="">

                        <!-- åº—èˆ—åï¼ˆè¡¨ç¤ºã®ã¿ï¼‰ -->
                        <div style="margin-bottom:20px;display:flex;align-items:center;gap:15px;">
                            <label style="font-weight:bold;font-size:12px;color:#333;">åº—èˆ—å:</label>
                            <div id="unitPriceStoreNameDisplay" style="padding:8px 15px;background:#e3f2fd;border-radius:6px;font-size:14px;color:#1565c0;font-weight:bold;"></div>
                        </div>

                        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¢å˜ä¾¡ -->
                        <div style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
                            <h4 style="margin:0 0 15px 0;font-size:13px;color:#333;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¢å˜ä¾¡ï¼ˆå…¨æœˆå…±é€šã®åˆæœŸå€¤ï¼‰</h4>
                            <div style="display:flex;gap:15px;flex-wrap:wrap;">
                                <div style="flex:1;min-width:120px;">
                                    <label style="display:block;font-size:11px;color:#666;margin-bottom:5px;">ç·åˆ</label>
                                    <input type="number" id="unitPriceEditTotal" placeholder="5000" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                                </div>
                                <div style="flex:1;min-width:120px;">
                                    <label style="display:block;font-size:11px;color:#666;margin-bottom:5px;">ãƒ©ãƒ³ãƒ</label>
                                    <input type="number" id="unitPriceEditLunch" placeholder="0" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                                </div>
                                <div style="flex:1;min-width:120px;">
                                    <label style="display:block;font-size:11px;color:#666;margin-bottom:5px;">ãƒ‡ã‚£ãƒŠãƒ¼</label>
                                    <input type="number" id="unitPriceEditDinner" placeholder="5000" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;">
                                </div>
                                <div style="display:flex;align-items:flex-end;">
                                    <button onclick="applyDefaultToAllMonths()" style="background:#4caf50;color:#fff;border:none;padding:10px 15px;border-radius:6px;font-size:11px;cursor:pointer;">å…¨æœˆã«é©ç”¨</button>
                                </div>
                            </div>
                        </div>

                        <!-- æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ« -->
                        <div style="margin-bottom:20px;">
                            <h4 style="margin:0 0 10px 0;font-size:13px;color:#333;">æœˆåˆ¥å®¢å˜ä¾¡ï¼ˆ4æœˆã€œ3æœˆï¼‰</h4>
                            <div style="overflow-x:auto;">
                                <table id="monthlyUnitPriceTable" style="width:100%;border-collapse:collapse;font-size:11px;min-width:800px;">
                                    <thead>
                                        <tr style="background:#e3f2fd;">
                                            <th style="padding:8px;text-align:center;width:60px;">ç¨®åˆ¥</th>
                                            <th style="padding:6px;text-align:center;">4æœˆ</th>
                                            <th style="padding:6px;text-align:center;">5æœˆ</th>
                                            <th style="padding:6px;text-align:center;">6æœˆ</th>
                                            <th style="padding:6px;text-align:center;">7æœˆ</th>
                                            <th style="padding:6px;text-align:center;">8æœˆ</th>
                                            <th style="padding:6px;text-align:center;">9æœˆ</th>
                                            <th style="padding:6px;text-align:center;">10æœˆ</th>
                                            <th style="padding:6px;text-align:center;">11æœˆ</th>
                                            <th style="padding:6px;text-align:center;">12æœˆ</th>
                                            <th style="padding:6px;text-align:center;">1æœˆ</th>
                                            <th style="padding:6px;text-align:center;">2æœˆ</th>
                                            <th style="padding:6px;text-align:center;">3æœˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monthlyUnitPriceBody">
                                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                                    </tbody>
                                </table>
                            </div>
                            <p style="font-size:10px;color:#666;margin-top:8px;">â€» ç©ºæ¬„ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒä½¿ç”¨ã•ã‚Œã¾ã™</p>
                        </div>

                        <!-- ãƒœã‚¿ãƒ³ -->
                        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;">
                            <button onclick="resetUnitPriceToDefault()" style="background:#ff9800;color:#fff;border:none;padding:12px 20px;border-radius:6px;font-size:12px;font-weight:bold;cursor:pointer;">
                                ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                            </button>
                            <button onclick="hideUnitPriceModal()" style="background:#9e9e9e;color:#fff;border:none;padding:12px 20px;border-radius:6px;font-size:12px;font-weight:bold;cursor:pointer;">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="saveUnitPrice()" style="background:#2196f3;color:#fff;border:none;padding:12px 25px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                                ğŸ’¾ ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="masterDataModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
                <div style="background:#fff;border-radius:12px;margin:30px auto;max-width:900px;width:95%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:18px;">ğŸ“‹ ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§</h3>
                        <div style="display:flex;gap:10px;">
                            <button onclick="saveMasterDataToHistory()" style="background:#4caf50;border:none;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;font-weight:bold;">ğŸ’¾ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
                            <button onclick="hideMasterDataModal()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;">âœ• é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                    <div style="padding:20px;">
                        <!-- ãƒã‚¹ã‚¿å±¥æ­´ãƒªã‚¹ãƒˆ -->
                        <div id="masterHistoryList" style="margin-bottom:20px;"></div>

                        <!-- ç¾åœ¨ã®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
                        <div style="border-top:2px solid #e0e0e0;padding-top:20px;">
                            <h4 style="color:#7b1fa2;margin:0 0 15px 0;">ç¾åœ¨ã®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿</h4>

                            <!-- ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆ3ã‚«ãƒ†ã‚´ãƒªï¼‰ -->
                            <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                                <button class="btn" id="masterTabStores" onclick="switchMasterTab('stores')" style="background:#4caf50;color:#fff;padding:10px 20px;">ğŸª åº—ç•ªãƒã‚¹ã‚¿</button>
                                <button class="btn" id="masterTabItems" onclick="switchMasterTab('items')" style="background:#e0e0e0;color:#333;padding:10px 20px;">ğŸ“‹ äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿</button>
                                <button class="btn" id="masterTabPrices" onclick="switchMasterTab('prices')" style="background:#e0e0e0;color:#333;padding:10px 20px;">ğŸ’° å®¢å˜ä¾¡ãƒã‚¹ã‚¿</button>
                            </div>

                            <!-- åº—ç•ªãƒã‚¹ã‚¿è¡¨ç¤º -->
                            <div id="masterStoresContent" style="max-height:400px;overflow-y:auto;"></div>

                            <!-- äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿è¡¨ç¤º -->
                            <div id="masterItemsContent" style="display:none;max-height:400px;overflow-y:auto;"></div>

                            <!-- å®¢å˜ä¾¡ãƒã‚¹ã‚¿è¡¨ç¤º -->
                            <div id="masterPricesContent" style="display:none;max-height:400px;overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== äºˆç®—è©¦ç®—ãƒšãƒ¼ã‚¸ ===== -->
        <div id="page-simulation" class="main-page">
            <div class="import-section" style="border-left:4px solid #ff9800;">
                <h2 style="color:#e65100;font-size:18px;margin-bottom:20px;">ğŸ§® äºˆç®—è©¦ç®—ï¼ˆWhat-Ifåˆ†æï¼‰</h2>
                <p style="color:#666;font-size:12px;margin-bottom:20px;">é¡§å®¢äºˆç®—å€¤ã‚’ç·¨é›†ã—ã¦ã€ãƒ©ã‚¯ãƒŸãƒ¼äºˆç®—ã¸ã®å½±éŸ¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™ã€‚</p>

                <!-- åº—èˆ—é¸æŠ -->
                <div style="background:#fff3e0;padding:15px;border-radius:8px;margin-bottom:20px;border:2px solid #ff9800;">
                    <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <label style="font-weight:bold;font-size:12px;color:#e65100;">è©¦ç®—å¯¾è±¡åº—èˆ—:</label>
                            <select id="simulationStoreSelect" style="padding:8px 12px;border:2px solid #ff9800;border-radius:4px;font-size:12px;min-width:200px;" onchange="loadSimulationData()">
                                <option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>
                            </select>
                        </div>
                        <button class="btn" style="background:#ff9800;color:#fff;padding:8px 15px;" onclick="resetSimulationData()">
                            ğŸ”„ å…ƒã«æˆ»ã™
                        </button>
                        <button class="btn" style="background:#4caf50;color:#fff;padding:8px 15px;" onclick="applySimulationData()">
                            âœ… è©¦ç®—å€¤ã‚’æœ¬ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
                        </button>
                    </div>
                </div>

                <!-- è©¦ç®—ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="saveSimulationModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                    <div style="background:#fff;border-radius:12px;padding:25px;max-width:400px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin:0 0 15px 0;color:#7b1fa2;">ğŸ’¾ è©¦ç®—çµæœã‚’ä¿å­˜</h3>
                        <div style="margin-bottom:15px;">
                            <label style="font-size:12px;color:#666;display:block;margin-bottom:5px;">ä¿å­˜åï¼ˆå¿…é ˆï¼‰</label>
                            <input type="text" id="simSaveName" placeholder="ä¾‹: å£²ä¸Š10%å¢—ã‚·ãƒŠãƒªã‚ª" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:13px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="font-size:12px;color:#666;display:block;margin-bottom:5px;">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                            <textarea id="simSaveMemo" placeholder="å¤‰æ›´å†…å®¹ã‚„ç›®çš„ãªã©" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:12px;height:60px;resize:none;box-sizing:border-box;"></textarea>
                        </div>
                        <div style="display:flex;gap:10px;justify-content:flex-end;">
                            <button class="btn" style="background:#9e9e9e;color:#fff;padding:10px 20px;" onclick="hideSaveSimulationModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button class="btn" style="background:#7b1fa2;color:#fff;padding:10px 20px;" onclick="saveSimulationHistory()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- â˜…â˜…â˜… æ–°UIæ§‹æˆ: MQè©¦ç®—ãƒ•ãƒ­ãƒ¼ â˜…â˜…â˜… -->
                <div id="simMqInputSection" style="display:none;">

                    <!-- è©¦ç®—å±¥æ­´ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆå¯¾æ¯”è¡¨ã®ä¸Šï¼‰ -->
                    <div style="display:flex;justify-content:flex-end;gap:10px;margin-bottom:15px;">
                        <button class="btn" style="background:#5c6bc0;color:#fff;padding:8px 15px;font-size:12px;" onclick="toggleSimHistoryList()">
                            ğŸ“š è©¦ç®—å±¥æ­´ <span id="simHistoryCount" style="background:#fff;color:#5c6bc0;padding:2px 6px;border-radius:10px;font-size:10px;margin-left:5px;">0</span>
                        </button>
                        <button class="btn" style="background:#7b1fa2;color:#fff;padding:8px 15px;font-size:12px;" onclick="showSaveSimulationModal()">
                            ğŸ’¾ ç¾åœ¨ã®è©¦ç®—ã‚’ä¿å­˜
                        </button>
                    </div>

                    <!-- è©¦ç®—å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå±•é–‹æ™‚ï¼‰ -->
                    <div id="simHistorySection" style="background:linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);padding:15px;border-radius:8px;margin-bottom:15px;border:2px solid #5c6bc0;display:none;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h4 style="margin:0;color:#3949ab;font-size:13px;">ğŸ“š è©¦ç®—å±¥æ­´</h4>
                            <button class="btn" style="background:#5c6bc0;color:#fff;padding:6px 12px;font-size:11px;" onclick="toggleSimHistoryList()">
                                å±¥æ­´ã‚’é–‰ã˜ã‚‹
                            </button>
                        </div>
                        <div id="simHistoryList" style="max-height:200px;overflow-y:auto;">
                            <!-- å±¥æ­´ãƒªã‚¹ãƒˆãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                            <p style="color:#666;font-size:11px;text-align:center;padding:20px;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>

                <!-- ===== ç›®æ¨™å®¢å˜ä¾¡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
                <div id="unitPriceConfirmModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                    <div style="background:#fff;border-radius:12px;padding:25px;max-width:400px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                        <h3 style="color:#1565c0;margin:0 0 15px 0;font-size:16px;">ğŸ“ ç›®æ¨™å®¢å˜ä¾¡ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ</h3>
                        <p style="color:#666;font-size:12px;margin:0 0 20px 0;">
                            MQè©¦ç®—ã§ã¯ç›®æ¨™å®¢å˜ä¾¡ï¼ˆPï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
                            ç¾åœ¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯å‰å¹´è¨­å®šå€¤ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚
                        </p>
                        <div style="display:flex;gap:10px;justify-content:center;">
                            <button onclick="executeSimMQWithoutEdit()" class="btn" style="padding:12px 25px;background:#4caf50;color:#fff;border:none;border-radius:6px;font-size:13px;">
                                ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨ˆç®—
                            </button>
                            <button onclick="showUnitPriceEditModal()" class="btn" style="padding:12px 25px;background:#ff9800;color:#fff;border:none;border-radius:6px;font-size:13px;">
                                å®¢å˜ä¾¡ã‚’ç·¨é›†
                            </button>
                        </div>
                        <div style="text-align:center;margin-top:15px;">
                            <button onclick="hideUnitPriceConfirmModal()" style="background:none;border:none;color:#999;font-size:11px;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>

                <!-- ===== ç›®æ¨™å®¢å˜ä¾¡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
                <div id="unitPriceEditModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1001;justify-content:center;align-items:center;overflow-y:auto;">
                    <div style="background:#fff;border-radius:12px;padding:25px;max-width:700px;width:95%;margin:20px auto;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                        <h3 style="color:#ff9800;margin:0 0 15px 0;font-size:16px;">ğŸ“ æœˆåˆ¥ç›®æ¨™å®¢å˜ä¾¡ç·¨é›†</h3>
                        <p style="color:#666;font-size:11px;margin:0 0 15px 0;">
                            <span id="simMonthCountDisplay2">0</span>ãƒ¶æœˆåˆ†ã®ç›®æ¨™å®¢å˜ä¾¡ã‚’ç·¨é›†ã§ãã¾ã™ï¼ˆåº—èˆ—åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šæ¸ˆã¿ï¼‰
                        </p>
                        <div style="overflow-x:auto;margin-bottom:15px;">
                            <table class="annual-table" style="font-size:11px;" id="simUnitPriceTable">
                                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                            </table>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <button onclick="resetSimUnitPricesToDefault()" class="btn" style="padding:8px 15px;font-size:11px;background:#9e9e9e;color:#fff;border:none;border-radius:4px;">
                                ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
                            </button>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <button onclick="hideUnitPriceEditModal()" class="btn" style="padding:10px 20px;background:#9e9e9e;color:#fff;border:none;border-radius:6px;">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                                <button onclick="executeSimMQWithEdit()" class="btn" style="padding:10px 20px;background:#ff9800;color:#fff;border:none;border-radius:6px;font-weight:bold;">
                                    MQè©¦ç®—ã®ã¿
                                </button>
                                <button onclick="saveAndExecuteSimMQ()" class="btn" style="padding:10px 20px;background:#4caf50;color:#fff;border:none;border-radius:6px;font-weight:bold;">
                                    ğŸ’¾ ãƒã‚¹ã‚¿ä¿å­˜ + MQè©¦ç®—
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è©¦ç®—ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div id="simulationContent" style="display:none;">
                    <!-- çµ±ä¸€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;">
                        <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <label style="font-size:12px;font-weight:bold;color:#333;">è¡¨ç¤ºæœŸé–“:</label>
                                <select id="simYear" style="padding:6px 10px;border:2px solid #ff9800;border-radius:4px;font-size:12px;" onchange="updateSimMonthOptions(); renderLinkedSimulation();">
                                </select>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <label style="font-size:12px;font-weight:bold;color:#333;">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</label>
                                <select id="simDisplayMode" style="padding:6px 10px;border:2px solid #ff9800;border-radius:4px;font-size:12px;min-width:120px;" onchange="changeDisplayMode()">
                                    <option value="all">å…¨æœˆè¡¨ç¤º</option>
                                    <option value="1H">ä¸ŠåŠæœŸï¼ˆ4-9æœˆï¼‰</option>
                                    <option value="2H">ä¸‹åŠæœŸï¼ˆ10-3æœˆï¼‰</option>
                                    <option value="Q1">Q1ï¼ˆ4-6æœˆï¼‰</option>
                                    <option value="Q2">Q2ï¼ˆ7-9æœˆï¼‰</option>
                                    <option value="Q3">Q3ï¼ˆ10-12æœˆï¼‰</option>
                                    <option value="Q4">Q4ï¼ˆ1-3æœˆï¼‰</option>
                                    <option value="single">å˜æœˆé¸æŠ</option>
                                    <option value="custom">è¤‡æ•°æœˆé¸æŠ</option>
                                </select>
                            </div>
                            <div id="singleMonthSelector" style="display:none;align-items:center;gap:5px;">
                                <select id="simMonth" style="padding:6px 10px;border:2px solid #ff9800;border-radius:4px;font-size:12px;min-width:80px;" onchange="renderLinkedSimulation();">
                                </select>
                                <button class="btn" style="background:#607d8b;color:#fff;padding:6px 10px;font-size:11px;" onclick="prevSimMonth()">â—€</button>
                                <button class="btn" style="background:#607d8b;color:#fff;padding:6px 10px;font-size:11px;" onclick="nextSimMonth()">â–¶</button>
                            </div>
                            <div style="margin-left:auto;font-size:11px;color:#666;">
                                <span style="background:#e3f2fd;padding:3px 8px;border-radius:3px;margin-right:5px;">ğŸ“ é’=é¡§å®¢äºˆç®—ï¼ˆå…¥åŠ›ï¼‰</span>
                                <span style="background:#f3e5f5;padding:3px 8px;border-radius:3px;">ğŸ“Š ç´«=ãƒ©ã‚¯ãƒŸãƒ¼äºˆç®—ï¼ˆå‡ºåŠ›ï¼‰</span>
                            </div>
                        </div>
                        <!-- è¤‡æ•°æœˆé¸æŠç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                        <div id="multiMonthSelector" style="display:none;padding:10px;background:#fff;border:1px solid #ddd;border-radius:4px;">
                            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                                <span style="font-size:11px;color:#666;margin-right:8px;">é¸æŠæœˆ:</span>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#e3f2fd;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="0" onchange="updateCustomMonths()"> 4æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#e3f2fd;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="1" onchange="updateCustomMonths()"> 5æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#e3f2fd;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="2" onchange="updateCustomMonths()"> 6æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#e3f2fd;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="3" onchange="updateCustomMonths()"> 7æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#e3f2fd;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="4" onchange="updateCustomMonths()"> 8æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#e3f2fd;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="5" onchange="updateCustomMonths()"> 9æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#f3e5f5;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="6" onchange="updateCustomMonths()"> 10æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#f3e5f5;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="7" onchange="updateCustomMonths()"> 11æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#f3e5f5;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="8" onchange="updateCustomMonths()"> 12æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#f3e5f5;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="9" onchange="updateCustomMonths()"> 1æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#f3e5f5;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="10" onchange="updateCustomMonths()"> 2æœˆ
                                </label>
                                <label style="display:flex;align-items:center;gap:3px;cursor:pointer;font-size:11px;padding:4px 8px;background:#f3e5f5;border-radius:3px;">
                                    <input type="checkbox" class="monthCheck" value="11" onchange="updateCustomMonths()"> 3æœˆ
                                </label>
                                <button class="btn" style="margin-left:10px;background:#2196f3;color:#fff;padding:4px 10px;font-size:10px;" onclick="selectAllMonths()">å…¨é¸æŠ</button>
                                <button class="btn" style="background:#9e9e9e;color:#fff;padding:4px 10px;font-size:10px;" onclick="clearAllMonths()">ã‚¯ãƒªã‚¢</button>
                            </div>
                        </div>
                    </div>

                    <!-- é€£å‹•æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼ï¼ˆSTEP1/STEP2ãƒ‘ãƒãƒ«ï¼‰ -->
                    <div id="linkedSimulationView"></div>

                    <!-- ===== MQè©¦ç®—çµæœæ¯”è¼ƒï¼ˆé¡§å®¢äºˆç®— vs MQäºˆç®—ï¼‰===== -->
                    <div id="simMqResultSection" style="display:none;background:linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);border-radius:8px;padding:20px;margin:20px 0;border:2px solid #2196f3;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                            <h4 style="color:#1565c0;margin:0;font-size:14px;">ğŸ“Š MQè©¦ç®—çµæœæ¯”è¼ƒï¼ˆé¡§å®¢äºˆç®— vs MQäºˆç®—ï¼‰</h4>
                            <span id="simMqResultStatus" style="font-size:11px;padding:4px 12px;border-radius:4px;"></span>
                        </div>
                        <div style="overflow-x:auto;margin-bottom:15px;">
                            <table class="annual-table" style="font-size:11px;" id="simMqResultTable">
                                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                            </table>
                        </div>
                        <div id="simMqComparisonSummary" style="background:#fff;border-radius:6px;padding:12px;border:1px solid #ddd;">
                            <!-- æ¯”è¼ƒã‚µãƒãƒªãƒ¼ãŒã“ã“ã«å‹•çš„ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- è©¦ç®—ã‚µãƒãƒªãƒ¼ -->
                    <div style="margin-top:20px;background:#fff8e1;border-radius:8px;padding:20px;border:2px solid #ffc107;">
                        <h3 style="color:#f57c00;font-size:14px;margin-bottom:15px;">ğŸ“ˆ è©¦ç®—ã‚µãƒãƒªãƒ¼ï¼ˆæ—¥æ¬¡ãƒ»æœˆæ¬¡æ›ç®—ï¼‰</h3>
                        <div id="simulationSummary"></div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div id="simulationNoData" style="text-align:center;padding:50px;color:#888;">
                    <div style="font-size:50px;margin-bottom:15px;">ğŸ“‹</div>
                    <div>å…ˆã«CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€ä¸Šã§åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
                </div>
            </div>
        </div>

        <!-- ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ ===== -->
        <div id="page-export" class="main-page">
            <div class="import-section" style="border-left:4px solid #9c27b0;">
                <h2 style="color:#7b1fa2;font-size:18px;margin-bottom:20px;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>

                <!-- åº—èˆ—é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <h3 style="font-size:14px;color:#333;margin-bottom:12px;">å‡ºåŠ›å¯¾è±¡åº—èˆ—</h3>
                    <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <label style="font-weight:bold;font-size:12px;">åº—èˆ—é¸æŠ:</label>
                            <select id="exportStoreSelect" style="padding:8px 12px;border:2px solid #9c27b0;border-radius:4px;font-size:12px;min-width:200px;" onchange="updateExportStoreSelection()">
                                <option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>
                            </select>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
                            <input type="checkbox" id="exportAllStores" onchange="toggleExportAllStores()">
                            <span style="font-weight:bold;">å…¨åº—èˆ—ã‚’é¸æŠ</span>
                        </label>
                        <span id="exportSelectedCount" style="font-size:11px;color:#666;margin-left:auto;">é¸æŠä¸­: 0åº—èˆ—</span>
                    </div>
                </div>

                <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ -->
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:15px;">
                    <button class="btn" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportRakumyInputsCSV()">
                        <div style="font-size:32px;margin-bottom:10px;">ğŸ“Š</div>
                        <div style="font-weight:bold;">ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">è²»ç”¨äºˆç®—è¨­å®šç”¨ãƒ‡ãƒ¼ã‚¿</div>
                    </button>
                    <button class="btn" style="background:linear-gradient(135deg, #2196f3 0%, #1565c0 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportBudgetListCSV()">
                        <div style="font-size:32px;margin-bottom:10px;">ğŸ“‹</div>
                        <div style="font-weight:bold;">äºˆç®—ä¸€è¦§CSV</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">è©³ç´°äºˆç®—ãƒ‡ãƒ¼ã‚¿</div>
                    </button>
                    <button class="btn" style="background:linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportMQOutputCSV()">
                        <div style="font-size:32px;margin-bottom:10px;">ğŸ“ˆ</div>
                        <div style="font-weight:bold;">MQå‡ºåŠ›CSV</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">MQã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
                    </button>
                    <button class="btn" style="background:linear-gradient(135deg, #607d8b 0%, #37474f 100%);color:#fff;padding:25px;border-radius:10px;font-size:14px;" onclick="exportAllConfig()">
                        <div style="font-size:32px;margin-bottom:10px;">âš™ï¸</div>
                        <div style="font-weight:bold;">è¨­å®šJSON</div>
                        <div style="font-size:11px;opacity:0.8;margin-top:5px;">ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãƒ‡ãƒ¼ã‚¿</div>
                    </button>
                </div>

                <!-- å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ãƒœã‚¿ãƒ³ -->
                <div style="margin-top:20px;padding-top:20px;border-top:2px solid #e0e0e0;">
                    <button class="btn" style="background:linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);color:#fff;padding:15px 30px;width:100%;font-size:16px;border-radius:8px;" onclick="showExportHistoryPage()">
                        ğŸ“‹ å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ (<span id="exportHistoryCount">0</span>ä»¶)
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ===== -->
        <div id="exportHistoryPage" class="data-history-page" style="display:none;">
            <div class="data-history-header" style="background:linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);">
                <h2>ğŸ“‹ å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§</h2>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-danger" onclick="clearAllExportHistory()">å…¨å±¥æ­´ã‚¯ãƒªã‚¢</button>
                    <button class="btn btn-secondary" onclick="hideExportHistoryPage()">âœ• é–‰ã˜ã‚‹</button>
                </div>
            </div>
            <div class="data-history-content">
                <div id="exportHistoryList" class="data-history-list"></div>
            </div>
        </div>

        <!-- ===== ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
        <div id="dataViewModal" class="data-view-modal" style="display:none;">
            <div class="data-view-overlay" onclick="hideDataViewModal()"></div>
            <div class="data-view-container">
                <div class="data-view-header">
                    <h3 id="dataViewTitle">ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h3>
                    <button class="btn btn-secondary" onclick="hideDataViewModal()">âœ• é–‰ã˜ã‚‹</button>
                </div>
                <div class="data-view-body" id="dataViewContent"></div>
            </div>
        </div>

        <!-- ===== äºˆç®—è¨­å®šãƒšãƒ¼ã‚¸ ===== -->
        <div id="page-budget" class="main-page">
            <!-- å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼ -->
            <div class="all-stores-summary" id="allStoresSummary" style="display:none;">
                <h3>å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼</h3>
                <div class="all-stores-grid" id="allStoresGrid"></div>
            </div>

            <!-- æœˆåˆ—æ¤œå‡ºçµæœ -->
            <div class="column-detection" id="columnDetection" style="display:none;">
                <h3>æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—æ¤œå‡ºçµæœï¼ˆ3è¡Œç›®:æœˆå + 4è¡Œç›®:ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ ã®ç…§åˆï¼‰</h3>
                <div class="month-cols-grid" id="monthColsGrid"></div>
                <div class="sample-values" id="sampleValues"></div>
            </div>

            <!-- ã‚µãƒ–ã‚¿ãƒ– -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('tab-calc')">ã€2ã€‘å…¥åŠ›å‰æ¼”ç®—</div>
                <div class="tab" onclick="showTab('tab-rakumy')">ã€3ã€‘ãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤</div>
                <div class="tab" onclick="showTab('tab-output')">ã€4ã€‘MQå‡ºåŠ›</div>
                <div class="tab" onclick="showTab('tab-budget-list')">ã€5ã€‘äºˆç®—ä¸€è¦§</div>
                <div class="tab" onclick="showTab('tab-summary')">ã€6ã€‘ã‚µãƒãƒªãƒ¼</div>
            </div>

        <!-- å…¥åŠ›å‰æ¼”ç®—ã‚¿ãƒ– -->
        <div id="tab-calc" class="tab-content active">
            <div class="section">
                <div class="section-header header-calc">ã€2ã€‘å…¥åŠ›å‰æ¼”ç®—çµæœ</div>
                <div class="section-body">
                    <table class="annual-table" id="calcTable"></table>
                </div>
            </div>
        </div>

        <!-- ãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤ã‚¿ãƒ–ï¼ˆçµ±åˆç‰ˆï¼‰ -->
        <div id="tab-rakumy" class="tab-content">
            <div class="section">
                <div class="section-header" style="background:linear-gradient(135deg, #1976d2 0%, #4caf50 100%);color:#fff;">ã€3ã€‘ãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤</div>
                <div class="section-body">

                    <!-- â˜…â˜…â˜… MQè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç›®æ¨™å®¢å˜ä¾¡ã®ã¿å…¥åŠ›ï¼‰â˜…â˜…â˜… -->
                    <div style="background:#e8f5e9;border-radius:8px;padding:20px;margin-bottom:20px;border:2px solid #4caf50;">
                        <h4 style="color:#2e7d32;margin:0 0 15px 0;">MQè¨­å®šï¼ˆç›®æ¨™å®¢å˜ä¾¡å…¥åŠ› + è‡ªå‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‚ç…§ï¼‰</h4>

                        <!-- è‡ªå‹•å‚ç…§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆæœˆåˆ¥è¡¨ç¤ºãƒ»å‹•çš„ç”Ÿæˆï¼‰ -->
                        <div style="background:#fff3e0;border-radius:6px;padding:12px;margin-bottom:15px;">
                            <div style="font-size:11px;color:#e65100;font-weight:bold;margin-bottom:10px;">MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆé¡§å®¢äºˆç®—ã‹ã‚‰è‡ªå‹•å–å¾—ãƒ»æœˆåˆ¥è¡¨ç¤ºï¼‰</div>
                            <div style="overflow-x:auto;">
                                <table class="annual-table" style="font-size:11px;" id="mqAutoParamsTable">
                                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                                </table>
                            </div>
                        </div>

                        <!-- åº—èˆ—æƒ…å ±ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div id="mqStoreNameDisplay" style="font-size:13px;color:#666;">åº—èˆ—: æœªé¸æŠ</div>
                            <button onclick="resetUnitPricesToDefault()" class="btn" style="padding:6px 15px;font-size:11px;background:#4caf50;color:#fff;border:none;border-radius:4px;">
                                ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>

                        <!-- æœˆåˆ¥ç›®æ¨™å®¢å˜ä¾¡å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‹•çš„ç”Ÿæˆï¼‰+ ä¿å­˜ãƒœã‚¿ãƒ³ -->
                        <div style="background:#e8f5e9;border-radius:8px;padding:15px;margin-bottom:20px;border:2px solid #4caf50;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px;">
                                <div style="font-size:12px;color:#2e7d32;font-weight:bold;">ğŸ“Š æœˆåˆ¥ç›®æ¨™å®¢å˜ä¾¡ï¼ˆ<span id="mqMonthCountDisplay">0</span>ãƒ¶æœˆåˆ†ãƒ»å‰å¹´å®Ÿç¸¾ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦è¨­å®šï¼‰</div>
                                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                    <button onclick="resetMQUnitPricesToDefault()" class="btn" style="padding:6px 12px;font-size:11px;background:#9e9e9e;border:none;border-radius:4px;color:#fff;font-weight:bold;">
                                        ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                                    </button>
                                    <button onclick="saveMQUnitPricesToMaster()" class="btn" style="padding:6px 12px;font-size:11px;background:#2e7d32;border:none;border-radius:4px;color:#fff;font-weight:bold;">
                                        ğŸ’¾ ãƒã‚¹ã‚¿ã«ä¿å­˜
                                    </button>
                                </div>
                            </div>
                            <div style="overflow-x:auto;background:#fff;border-radius:6px;padding:10px;">
                                <table class="annual-table" style="font-size:11px;" id="mqUnitPriceTable">
                                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                                </table>
                            </div>
                            <div style="font-size:10px;color:#558b2f;margin-top:8px;text-align:right;">â€»ã€Œãƒã‚¹ã‚¿ã«ä¿å­˜ã€ã§ç·¨é›†å†…å®¹ã‚’ãƒã‚¹ã‚¿è¨­å®šã‚¿ãƒ–ã«åæ˜ </div>
                        </div>

                        <!-- Step 2: MQå†è¨ˆç®—ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ -->
                        <div style="text-align:center;background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);border-radius:10px;padding:20px;border:2px solid #ff9800;">
                            <div style="font-size:12px;color:#e65100;margin-bottom:10px;font-weight:bold;">â–¼ å®¢å˜ä¾¡ãƒ»å£²ä¸Šè¨­å®šãŒå®Œäº†ã—ãŸã‚‰</div>
                            <button onclick="recalculateMQ()" class="btn btn-primary" style="padding:15px 60px;font-size:18px;background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);border:none;border-radius:8px;color:#fff;font-weight:bold;box-shadow:0 4px 15px rgba(255,152,0,0.4);cursor:pointer;">
                                ğŸ”„ MQå†è¨ˆç®—
                            </button>
                            <div style="font-size:11px;color:#bf360c;margin-top:8px;">å£²ä¸Šãƒ»å®¢å˜ä¾¡ã‹ã‚‰MQæç›Šã‚’è¨ˆç®—ã—ã¾ã™</div>
                        </div>

                        <!-- MQè¨ˆç®—çµæœã‚µãƒãƒªãƒ¼ -->
                        <div id="mqResultSummary" style="display:none;margin-top:15px;background:linear-gradient(135deg, #e8f5e9 0%, #fff3e0 100%);border-radius:8px;padding:15px;border:2px solid #4caf50;">
                            <div style="font-size:12px;font-weight:bold;color:#2e7d32;margin-bottom:12px;">ğŸ“Š MQè¨ˆç®—çµæœï¼ˆæœˆåˆ¥ï¼‰</div>
                            <div style="overflow-x:auto;">
                                <table class="annual-table" style="font-size:11px;" id="mqResultTable">
                                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- 29é …ç›® -->
                    <div class="rakumy-category cost">
                        <h4>è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- 29é …ç›®ï¼ˆå¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰<span style="font-size:11px;color:#666;font-weight:normal;margin-left:10px;">â€»é¡§å®¢äºˆç®—ã‹ã‚‰è‡ªå‹•è»¢è¨˜</span></h4>
                        <table class="annual-table" id="rakumyCostTable"></table>
                    </div>

                    <!-- å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- 28é …ç›® -->
                    <div class="rakumy-category monthly">
                        <h4>å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- 28é …ç›®ï¼ˆæœˆåˆ¥èª¿æ•´ç”¨ã€åœ°ä»£å®¶è³ƒé™¤ãï¼‰<span style="font-size:11px;color:#666;font-weight:normal;margin-left:10px;">â€»é¡§å®¢äºˆç®—ã‹ã‚‰è‡ªå‹•è»¢è¨˜</span></h4>
                        <table class="annual-table" id="rakumyMonthlyTable"></table>
                    </div>

                    <!-- äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰- MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
                    <div class="rakumy-category budget">
                        <h4>äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰- å‚ç…§<span style="font-size:11px;color:#666;font-weight:normal;margin-left:10px;">â€»MQè¨ˆç®—çµæœ</span></h4>
                        <table class="annual-table" id="rakumyBudgetTable"></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MQå‡ºåŠ›ã‚¿ãƒ– -->
        <div id="tab-output" class="tab-content">
            <div class="section">
                <div class="section-header header-output">ã€4ã€‘MQã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡ºåŠ›</div>
                <div class="section-body">
                    <table class="annual-table" id="outputTable"></table>
                </div>
            </div>
        </div>

        <!-- äºˆç®—ä¸€è¦§ã‚¿ãƒ– -->
        <div id="tab-budget-list" class="tab-content">
            <div class="section">
                <div class="section-header" style="background:linear-gradient(135deg, #1a237e 0%, #4a148c 100%);color:#fff;">ã€5ã€‘äºˆç®—ä¸€è¦§ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœï¼‰</div>
                <div class="section-body">
                    <table class="annual-table" id="budgetListTable"></table>
                </div>
            </div>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼ã‚¿ãƒ– -->
        <div id="tab-summary" class="tab-content">
            <div class="section">
                <div class="section-header header-summary">ã€6ã€‘ã‚µãƒãƒªãƒ¼</div>
                <div class="section-body" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 20px;">
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>
            </div>
            <div class="section">
                <div class="section-header" style="background:#f5f5f5;">è²»ç”¨è¨­å®šåˆ¤å®šçµæœ</div>
                <div class="section-body" id="judgmentResults"></div>
            </div>
        </div>
        </div><!-- äºˆç®—è¨­å®šãƒšãƒ¼ã‚¸çµ‚äº† -->

        <!-- ===== å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ===== -->
        <div id="dataHistoryPage" class="data-history-page" style="display:none;">
            <div class="data-history-header">
                <h2>ğŸ“‹ å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§</h2>
                <button class="btn btn-secondary" onclick="hideDataHistoryPage()">âœ• é–‰ã˜ã‚‹</button>
            </div>
            <div class="data-history-content">
                <!-- ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ï¼‰ -->
                <div style="margin-bottom:30px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h3 style="margin:0;color:#1565c0;font-size:18px;">ğŸ“‚ ç¾åœ¨ã®å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆæœªä¿å­˜ï¼‰</h3>
                        <button class="btn" style="background:#4caf50;color:#fff;padding:10px 20px;" onclick="saveCurrentImportData()">ğŸ’¾ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
                    </div>
                    <div id="dataHistoryList" class="data-history-list"></div>
                </div>

                <!-- ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆLocalStorageï¼‰ -->
                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h3 style="margin:0;color:#7b1fa2;font-size:18px;">ğŸ’¾ ä¿å­˜æ¸ˆã¿å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´</h3>
                        <button class="btn" style="background:#f44336;color:#fff;padding:8px 15px;font-size:12px;" onclick="clearAllHistory()">ğŸ—‘ å…¨å‰Šé™¤</button>
                    </div>
                    <div id="savedHistoryList" class="data-history-list"></div>
                </div>

                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ« -->
                <div id="savedHistoryPreview" style="display:none;margin-top:30px;background:#fff;border-radius:12px;padding:20px;border:3px solid #1565c0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="margin:0;color:#1565c0;font-size:18px;">ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: <span id="previewTitle"></span></h3>
                        <div>
                            <button class="btn" style="background:#4caf50;color:#fff;padding:10px 20px;margin-right:10px;" onclick="loadPreviewedData()">ğŸ“¥ ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
                            <button class="btn btn-secondary" onclick="closeHistoryPreview()">âœ• é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                    <div id="previewContent" style="max-height:500px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å®šæ•°
        var CALENDAR_MONTHS = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        var FISCAL_ORDER = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        var activeMonths = [];
        var monthLabels = [];
        var budgetColumnPositions = []; // å„æœˆã®ã€Œäºˆç®—ã€åˆ—ä½ç½®
        var monthDetectionResults = []; // æœˆæ¤œå‡ºçµæœï¼ˆè¡¨ç¤ºç”¨ï¼‰
        var firstDataCol = 5;
        var preprocessLog = [];
        var storeName = '';
        var annualData = {};
        var calcResults = {};
        var rakumyInputs = {};
        var mqOutputs = {};
        var judgments = {};
        var matchedItems = [];
        var unmatchedItems = [];
        var csvLines = []; // ãƒ‡ãƒãƒƒã‚°ç”¨

        // â˜… è¤‡æ•°åº—èˆ—å¯¾å¿œ
        var allStoresData = {}; // { storeName: { annualData, calcResults, rakumyInputs, mqOutputs, judgments, matchedItems, unmatchedItems, activeMonths, monthLabels } }
        var currentStoreName = '';
        var selectedFiles = []; // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¾¤

        // â˜…â˜…â˜… åº—èˆ—åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç›®æ¨™å®¢å˜ä¾¡ï¼ˆ2025å¹´å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹ï¼‰â˜…â˜…â˜…
        var DEFAULT_UNIT_PRICES = {
            'ãªã‹ã‚ã®ã¦ã£ãºã‚“ã€€æœ¬åº—': { storeCode: '101', total: 5000, lunch: 0, dinner: 5000 },
            'ãªã‹ã‚ã®ã¦ã£ãºã‚“ã€€ä¸¸ã®å†…': { storeCode: '103', total: 5000, lunch: 0, dinner: 5000 },
            'ãªã‹ã‚ã®ã¦ã£ãºã‚“ã€€æ¨ªæµœã¿ãªã¨ã¿ã‚‰ã„': { storeCode: '104', total: 5000, lunch: 0, dinner: 5000 },
            'ãªã‹ã‚ã®ã¦ã£ãºã‚“ã€€å“å·': { storeCode: '105', total: 5000, lunch: 0, dinner: 5000 },
            'ãªã‹ã‚ã®ã¦ã£ãºã‚“ã€€åå¤å±‹': { storeCode: '106', total: 5000, lunch: 0, dinner: 5000 },
            'ãªã‹ã‚ã®ã¦ã£ãºã‚“ã€€æ¸‹è°·ã‚¹ãƒˆãƒªãƒ¼ãƒ ': { storeCode: '107', total: 5000, lunch: 0, dinner: 5000 },
            'ã¯ã¾ãã‚Šå±‹ä¸²å·¦è¡›é–€': { storeCode: '201', total: 5000, lunch: 0, dinner: 5000 },
            'ç¯‰åœ°ã‚‚ã£ãŸã„ãªã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ é­šæ²»': { storeCode: '301', total: 5000, lunch: 0, dinner: 5000 },
            'å‰æ¬¡èŸ¹è”µ': { storeCode: '401', total: 5000, lunch: 0, dinner: 5000 },
            'é®¨ ã¤ãã†ã ': { storeCode: '501', total: 15000, lunch: 0, dinner: 15000 },
            'é®¨ ãŠã«ã‹ã„': { storeCode: '502', total: 15000, lunch: 0, dinner: 15000 },
            'é®¨ ãŠã«ã‹ã„+1': { storeCode: '503', total: 15000, lunch: 0, dinner: 15000 },
            'é‡æ¯›ã®ãŠã«ã‹ã„': { storeCode: '505', total: 15000, lunch: 0, dinner: 15000 },
            'å¤©å©¦ç¾… ã¿ã‚„ã—ã‚': { storeCode: '901', total: 15000, lunch: 0, dinner: 15000 },
            'ç„¼é³¥ ã²ã‚‰é‡': { storeCode: '1201', total: 13400, lunch: 0, dinner: 13400 },
            'ç«‹å–°ã™ã— é­šæ²³å²¸ å±±æ²»': { storeCode: '507', total: 5000, lunch: 0, dinner: 5000 },
            'é®¨ ãŠã«ã‹ã„Ã—2': { storeCode: '508', total: 15000, lunch: 0, dinner: 15000 },
            'å±…é…’å±‹ ã†ã¡ã‚„ã¾': { storeCode: '1301', total: 11000, lunch: 0, dinner: 11000 },
            'éŠ€åº§ç¨²è‘‰ï¼ˆMASAï¼‰': { storeCode: '1800', total: 40000, lunch: 0, dinner: 40000 },
            'ãƒ©ãƒ¼ãƒ¡ãƒ³ï¼ˆæ¥­å‹™å§”è¨—ï¼‰': { storeCode: '8001', total: 1000, lunch: 1000, dinner: 1000 },
            'éº»å¸ƒå°ã€€ç²‹ã€€ç¨²è‘‰': { storeCode: '', total: 12000, lunch: 0, dinner: 12000 },
            'éŠ€åº§ã€€ç‚ã€€ãŸã‚€ã‚‰': { storeCode: '', total: 30000, lunch: 0, dinner: 30000 },
            'ç„¼é³¥ã€€ã²ã‚‰é‡ã¨ãªã‚Š': { storeCode: '', total: 30000, lunch: 0, dinner: 30000 },
            'å°¾å¼µã€€ç²‹ã€€ç¨²è‘‰': { storeCode: '', total: 20000, lunch: 0, dinner: 20000 },
            'é®¨KOUMEI': { storeCode: '', total: 15000, lunch: 0, dinner: 15000 },
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆåº—èˆ—åãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰
            '_default': { storeCode: '', total: 5000, lunch: 0, dinner: 5000 }
        };

        // åº—èˆ—åˆ¥æœˆåˆ¥ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”¨ï¼‰
        var storeUnitPrices = {}; // { storeName: { 0: {total, lunch, dinner}, 1: {...}, ... } }

        // â˜…â˜…â˜… äºˆç®—ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºé †ãƒ»å‡ºåŠ›å…ˆè¨­å®šï¼‰ â˜…â˜…â˜…
        var BUDGET_CATEGORY_MAP = {
            'å£²ä¸Šé«˜': {
                output: 'mq',           // å‡ºåŠ›å…ˆ: mq=MQè¨ˆç®—, cost=è²»ç”¨äºˆç®—è¨­å®š, both=ä¸¡æ–¹
                type: 'sales',
                displayOrder: 1,
                color: '#4caf50',
                items: []               // ã‚«ãƒ†ã‚´ãƒªå†…é …ç›®ï¼ˆsortOrderé †ï¼‰
            },
            'å£²ä¸ŠåŸä¾¡': {
                output: 'mq',
                type: 'cost_of_sales',
                displayOrder: 2,
                color: '#ff9800',
                items: []
            },
            'äººä»¶è²»': {
                output: 'both',         // è©³ç´°ã§åˆ†å²ï¼ˆå›ºå®š/å¤‰å‹•ï¼‰
                type: 'labor',
                displayOrder: 3,
                color: '#2196f3',
                items: []
            },
            'æ°´é“å…‰ç†±è²»': {
                output: 'cost',
                type: 'utility',
                displayOrder: 4,
                color: '#9c27b0',
                items: []
            },
            'è²©ä¿ƒè²»': {
                output: 'cost',
                type: 'promotion',
                displayOrder: 5,
                color: '#e91e63',
                items: []
            },
            'åº—èˆ—é‹å–¶è²»': {
                output: 'cost',
                type: 'operation',
                displayOrder: 6,
                color: '#00bcd4',
                items: []
            },
            'ç®¡ç†è²»': {
                output: 'cost',
                type: 'admin',
                displayOrder: 7,
                color: '#607d8b',
                items: []
            },
            'æ•™è‚²ãƒ»æ¡ç”¨è²»': {
                output: 'cost',
                type: 'education',
                displayOrder: 8,
                color: '#795548',
                items: []
            },
            'ITãƒ»å¤–æ³¨è²»': {
                output: 'cost',
                type: 'it',
                displayOrder: 9,
                color: '#3f51b5',
                items: []
            },
            'å›ºå®šè²»': {
                output: 'cost',
                type: 'fixed',
                displayOrder: 10,
                color: '#f44336',
                items: []
            },
            'æç›Š': {
                output: 'mq',
                type: 'profit',
                displayOrder: 11,
                color: '#673ab7',
                items: []
            },
            'ãã®ä»–å¤‰å‹•è²»': {
                output: 'cost',
                type: 'variable',
                displayOrder: 12,
                color: '#009688',
                items: []
            },
            'KPI': {
                output: 'mq',
                type: 'kpi',
                displayOrder: 13,
                color: '#ff5722',
                items: []
            }
        };

        // è¨­å®šãƒ‡ãƒ¼ã‚¿ï¼ˆv17ãƒãƒƒãƒ”ãƒ³ã‚°æº–æ‹ ï¼‰
        // v17: é¡§å®¢äºˆç®—_ãƒ©ã‚¯ãƒŸãƒ¼_ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨_v17_MUGENé™å®š.csv
        // â˜… budgetCategory: äºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªã€sortOrder: ã‚«ãƒ†ã‚´ãƒªå†…è¡¨ç¤ºé †
        var CUSTOMER_CODE_MAP = {
            // === å£²ä¸Šé«˜ï¼ˆNo.1-4ï¼‰ ===
            '810': { v15No: 1, name: 'åº—èˆ—å£²ä¸Šé«˜', category: 'å£²ä¸Šé«˜', budgetCategory: 'å£²ä¸Šé«˜', sortOrder: 1, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            '811': { v15No: 2, name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š', category: 'å£²ä¸Šé«˜', budgetCategory: 'å£²ä¸Šé«˜', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š>å£²ä¸Šæ§‹æˆæ¯”è¨­å®š' },
            '812': { v15No: 3, name: 'ãã®ä»–å£²ä¸Šé«˜', category: 'å£²ä¸Šé«˜', budgetCategory: 'å£²ä¸Šé«˜', sortOrder: 3, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š>å£²ä¸Šæ§‹æˆæ¯”è¨­å®š' },
            '999': { v15No: 4, name: 'å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰', category: 'å£²ä¸Šé«˜', budgetCategory: 'å£²ä¸Šé«˜', sortOrder: 4, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === å£²ä¸ŠåŸä¾¡ï¼ˆNo.5-15ï¼‰ ===
            '2028': { v15No: 5, name: 'é£ŸææœŸé¦–æ£š', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '461': { v15No: 6, name: 'é£Ÿæä»•å…¥é«˜', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 2, inputStyle: 'D.å‚ç…§ã®ã¿', screen: 'å‚ç…§ã®ã¿' },
            '2029': { v15No: 7, name: 'é£ŸææœŸæœ«æ£š', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 3, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '4611': { v15No: 8, name: 'é£ŸæåŸä¾¡', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 4, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '2030': { v15No: 9, name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸé¦–æ£š', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 5, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '462': { v15No: 10, name: 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 6, inputStyle: 'D.å‚ç…§ã®ã¿', screen: 'å‚ç…§ã®ã¿' },
            '2031': { v15No: 11, name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸæœ«æ£š', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 7, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '4621': { v15No: 12, name: 'ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 8, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '9991': { v15No: 13, name: 'å†…éƒ¨æŒ¯æ›¿', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 9, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '9992': { v15No: 14, name: 'åŸä¾¡åˆè¨ˆ', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 10, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            '9993': { v15No: 15, name: 'å£²ä¸Šç·åˆ©ç›Š', category: 'å£²ä¸ŠåŸä¾¡', budgetCategory: 'å£²ä¸ŠåŸä¾¡', sortOrder: 11, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === äººä»¶è²»ï¼ˆNo.16-26ï¼‰ ===
            '501': { v15No: 16, name: 'çµ¦æ–™æ‰‹å½“', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 1, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '5011': { v15No: 17, name: 'åº—é•·æ–™ç†é•·æ˜‡çµ¦', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 2, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '5012': { v15No: 18, name: 'ç¤¾å“¡çµ¦ä¸', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 3, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '509': { v15No: 19, name: 'é›‘çµ¦', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 4, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '503': { v15No: 20, name: 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 5, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '504': { v15No: 21, name: 'æ³•å®šç¦åˆ©è²»', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 6, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '508': { v15No: 22, name: 'é€šå‹¤äº¤é€šè²»', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 7, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '506': { v15No: 23, name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 8, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '553': { v15No: 24, name: 'ç¤¾å®…å®¶è³ƒ', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 9, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '2105': { v15No: 25, name: 'ä¼‘æ¥­æ‰‹å½“', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 10, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '9994': { v15No: 26, name: 'äººä»¶è²»åˆè¨ˆ', category: 'äººä»¶è²»', budgetCategory: 'äººä»¶è²»', sortOrder: 11, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === æ°´é“å…‰ç†±è²»ï¼ˆNo.27-30ï¼‰ ===
            '520': { v15No: 32, name: 'é›»æ°—ä»£', category: 'æ°´é“å…‰ç†±è²»', budgetCategory: 'æ°´é“å…‰ç†±è²»', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '521': { v15No: 33, name: 'ã‚¬ã‚¹ä»£', category: 'æ°´é“å…‰ç†±è²»', budgetCategory: 'æ°´é“å…‰ç†±è²»', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '522': { v15No: 34, name: 'æ°´é“ä»£', category: 'æ°´é“å…‰ç†±è²»', budgetCategory: 'æ°´é“å…‰ç†±è²»', sortOrder: 3, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '9995': { v15No: 0, name: 'æ°´é“å…‰ç†±è²»åˆè¨ˆ', category: 'æ°´é“å…‰ç†±è²»', budgetCategory: 'æ°´é“å…‰ç†±è²»', sortOrder: 4, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === è²©ä¿ƒè²»ï¼ˆNo.31-35ï¼‰ ===
            '510': { v15No: 27, name: 'è²©å£²ä¿ƒé€²è²»', category: 'è²©ä¿ƒè²»', budgetCategory: 'è²©ä¿ƒè²»', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '541': { v15No: 28, name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', category: 'è²©ä¿ƒè²»', budgetCategory: 'è²©ä¿ƒè²»', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '516': { v15No: 29, name: 'èª¿æŸ»è²»', category: 'è²©ä¿ƒè²»', budgetCategory: 'è²©ä¿ƒè²»', sortOrder: 3, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '542': { v15No: 31, name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', category: 'è²©ä¿ƒè²»', budgetCategory: 'è²©ä¿ƒè²»', sortOrder: 4, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '9996': { v15No: 0, name: 'è²©ä¿ƒè²»åˆè¨ˆ', category: 'è²©ä¿ƒè²»', budgetCategory: 'è²©ä¿ƒè²»', sortOrder: 5, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === åº—èˆ—é‹å–¶è²»ï¼ˆNo.36-39ï¼‰ ===
            '514': { v15No: 30, name: 'è¡›ç”Ÿè²»', category: 'åº—èˆ—é‹å–¶è²»', budgetCategory: 'åº—èˆ—é‹å–¶è²»', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '523': { v15No: 35, name: 'æ¶ˆè€—å“è²»', category: 'åº—èˆ—é‹å–¶è²»', budgetCategory: 'åº—èˆ—é‹å–¶è²»', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '526': { v15No: 36, name: 'ä¿å®ˆä¿®ç¹•è²»', category: 'åº—èˆ—é‹å–¶è²»', budgetCategory: 'åº—èˆ—é‹å–¶è²»', sortOrder: 3, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '9997': { v15No: 0, name: 'åº—èˆ—é‹å–¶è²»åˆè¨ˆ', category: 'åº—èˆ—é‹å–¶è²»', budgetCategory: 'åº—èˆ—é‹å–¶è²»', sortOrder: 4, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === ç®¡ç†è²»ï¼ˆNo.40-49ï¼‰ ===
            '527': { v15No: 37, name: 'ç§Ÿç¨å…¬èª²', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '529': { v15No: 38, name: 'æ¥å¾…äº¤éš›è²»', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '530': { v15No: 39, name: 'æ—…è²»äº¤é€šè²»', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 3, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '531': { v15No: 40, name: 'é€šä¿¡è²»', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 4, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '5321': { v15No: 41, name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 5, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '532': { v15No: 42, name: 'æ”¯æ‰•æ‰‹æ•°æ–™', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 6, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '533': { v15No: 43, name: 'ä¼šè­°è²»', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 7, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '534': { v15No: 44, name: 'è«¸ä¼šè²»', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 8, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '539': { v15No: 51, name: 'é›‘è²»', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 9, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '9998': { v15No: 0, name: 'ç®¡ç†è²»åˆè¨ˆ', category: 'ç®¡ç†è²»', budgetCategory: 'ç®¡ç†è²»', sortOrder: 10, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === æ•™è‚²ãƒ»æ¡ç”¨è²»ï¼ˆNo.50-54ï¼‰ ===
            '536': { v15No: 45, name: 'å›³æ›¸æ•™è‚²è²»', category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', budgetCategory: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '546': { v15No: 46, name: 'ç ”ä¿®è²»', category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', budgetCategory: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '537': { v15No: 47, name: 'æ¥­æ…‹ç ”ç©¶è²»', category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', budgetCategory: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', sortOrder: 3, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '518': { v15No: 48, name: 'æ¡ç”¨è²»', category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', budgetCategory: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', sortOrder: 4, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '9999': { v15No: 0, name: 'æ•™è‚²ãƒ»æ¡ç”¨è²»åˆè¨ˆ', category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', budgetCategory: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', sortOrder: 5, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === ITãƒ»å¤–æ³¨è²»ï¼ˆNo.55-58ï¼‰ ===
            '550': { v15No: 49, name: 'ITè²»', category: 'ITãƒ»å¤–æ³¨è²»', budgetCategory: 'ITãƒ»å¤–æ³¨è²»', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '2128': { v15No: 50, name: 'å¤–æ³¨è²»', category: 'ITãƒ»å¤–æ³¨è²»', budgetCategory: 'ITãƒ»å¤–æ³¨è²»', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '99991': { v15No: 0, name: 'ITãƒ»å¤–æ³¨è²»åˆè¨ˆ', category: 'ITãƒ»å¤–æ³¨è²»', budgetCategory: 'ITãƒ»å¤–æ³¨è²»', sortOrder: 3, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            '99992': { v15No: 0, name: 'å¤‰å‹•è²»åˆè¨ˆ', category: 'ITãƒ»å¤–æ³¨è²»', budgetCategory: 'ITãƒ»å¤–æ³¨è²»', sortOrder: 4, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            '99993': { v15No: 0, name: 'é™ç•Œåˆ©ç›Š', category: 'ITãƒ»å¤–æ³¨è²»', budgetCategory: 'ITãƒ»å¤–æ³¨è²»', sortOrder: 5, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === å›ºå®šè²»ï¼ˆNo.59-64ï¼‰ ===
            '528': { v15No: 55, name: 'æ¸›ä¾¡å„Ÿå´è²»', category: 'å›ºå®šè²»', budgetCategory: 'å›ºå®šè²»', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '554': { v15No: 56, name: 'å®¶è³ƒ', category: 'å›ºå®šè²»', budgetCategory: 'å›ºå®šè²»', sortOrder: 2, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '552': { v15No: 57, name: 'è­¦å‚™æ–™', category: 'å›ºå®šè²»', budgetCategory: 'å›ºå®šè²»', sortOrder: 3, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '5241': { v15No: 58, name: 'ãƒªãƒ¼ã‚¹æ–™', category: 'å›ºå®šè²»', budgetCategory: 'å›ºå®šè²»', sortOrder: 4, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '524': { v15No: 59, name: 'è³ƒå€Ÿæ–™', category: 'å›ºå®šè²»', budgetCategory: 'å›ºå®šè²»', sortOrder: 5, inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›', screen: 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š' },
            '99994': { v15No: 0, name: 'å›ºå®šè²»åˆè¨ˆ', category: 'å›ºå®šè²»', budgetCategory: 'å›ºå®šè²»', sortOrder: 6, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === æç›Šï¼ˆNo.65-67ï¼‰ ===
            '99995': { v15No: 63, name: 'åº—èˆ—å–¶æ¥­åˆ©ç›Š', category: 'æç›Š', budgetCategory: 'æç›Š', sortOrder: 1, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            '99996': { v15No: 0, name: 'è²©å£²ç®¡ç†è²»åˆè¨ˆ', category: 'æç›Š', budgetCategory: 'æç›Š', sortOrder: 2, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            '9640': { v15No: 63, name: 'å–¶æ¥­åˆ©ç›Š', category: 'æç›Š', budgetCategory: 'æç›Š', sortOrder: 3, inputStyle: 'C.è‡ªå‹•æ¼”ç®—', screen: 'è‡ªå‹•' },
            // === KPIï¼ˆNo.64-70ï¼‰ ===
            '9641': { v15No: 64, name: 'å®¢æ•°', category: 'KPI', budgetCategory: 'KPI', sortOrder: 1, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' },
            '9642': { v15No: 65, name: 'å®¢å˜ä¾¡', category: 'KPI', budgetCategory: 'KPI', sortOrder: 2, inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›', screen: 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š' }
        };

        // â˜… é …ç›®åãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆEåˆ—ç©ºæ¬„ãƒ»ã‚»ãƒ«çµåˆè§£é™¤å¯¾å¿œï¼‰
        // ã‚³ãƒ¼ãƒ‰ãŒãªã„è¡Œã§ã‚‚é …ç›®åã‹ã‚‰å¯¾å¿œã™ã‚‹v17Noã‚’ç‰¹å®š
        // â˜…â˜…â˜… 2026-01-03 å¤§å¹…æ‹¡å¼µï¼šè¡¨è¨˜æºã‚Œãƒ»ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œå¼·åŒ– â˜…â˜…â˜…
        var NAME_BASED_MAP = {
            // === å£²ä¸Šé«˜ï¼ˆNo.1-4ï¼‰ ===
            'åº—èˆ—å£²ä¸Šé«˜': { v17No: 1, category: 'å£²ä¸Šé«˜' },
            'ãƒ•ãƒ¼ãƒ‰å£²ä¸Š': { v17No: 1, category: 'å£²ä¸Šé«˜' },
            'ï¾Œï½°ï¾„ï¾å£²ä¸Š': { v17No: 1, category: 'å£²ä¸Šé«˜' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ•ãƒ¼ãƒ‰å£²ä¸Šé«˜': { v17No: 1, category: 'å£²ä¸Šé«˜' },
            'ï¾Œï½°ï¾„ï¾å£²ä¸Šé«˜': { v17No: 1, category: 'å£²ä¸Šé«˜' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'Få£²ä¸Š': { v17No: 1, category: 'å£²ä¸Šé«˜' },
            'é£Ÿå£²ä¸Š': { v17No: 1, category: 'å£²ä¸Šé«˜' },
            'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š': { v17No: 2, category: 'å£²ä¸Šé«˜' },
            'ï¾„ï¾ï¾˜ï¾ï½¸å£²ä¸Š': { v17No: 2, category: 'å£²ä¸Šé«˜' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šé«˜': { v17No: 2, category: 'å£²ä¸Šé«˜' },
            'ï¾„ï¾ï¾˜ï¾ï½¸å£²ä¸Šé«˜': { v17No: 2, category: 'å£²ä¸Šé«˜' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'Då£²ä¸Š': { v17No: 2, category: 'å£²ä¸Šé«˜' },
            'é£²å£²ä¸Š': { v17No: 2, category: 'å£²ä¸Šé«˜' },
            'ãã®ä»–å£²ä¸Šé«˜': { v17No: 3, category: 'å£²ä¸Šé«˜' },
            'ãã®ä»–å£²ä¸Š': { v17No: 3, category: 'å£²ä¸Šé«˜' },
            'ä»–å£²ä¸Š': { v17No: 3, category: 'å£²ä¸Šé«˜' },
            'å£²ä¸Šé«˜åˆè¨ˆ': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'å£²ä¸Šé«˜åˆè¨ˆ(ç¨æŠœ)': { v17No: 4, category: 'å£²ä¸Šé«˜' },  // åŠè§’æ‹¬å¼§
            'å£²ä¸Šåˆè¨ˆ': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'å£²ä¸Šé«˜è¨ˆ': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'ç·å£²ä¸Šé«˜': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'å£²ä¸Šç·é¡': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'å£²ä¸Šè¨ˆ': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'åˆè¨ˆå£²ä¸Š': { v17No: 4, category: 'å£²ä¸Šé«˜' },
            'å£²ä¸Šé«˜': { v17No: 4, category: 'å£²ä¸Šé«˜' },  // å˜ç‹¬ã®å ´åˆã¯åˆè¨ˆæ‰±ã„
            // === å£²ä¸ŠåŸä¾¡ï¼ˆNo.5-15ï¼‰ ===
            'é£ŸææœŸé¦–æ£š': { v17No: 5, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£ŸææœŸé¦–æ£šå¸': { v17No: 5, category: 'å£²ä¸ŠåŸä¾¡' },
            'æœŸé¦–é£Ÿææ£šå¸': { v17No: 5, category: 'å£²ä¸ŠåŸä¾¡' },
            'FæœŸé¦–æ£š': { v17No: 5, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£Ÿæä»•å…¥é«˜': { v17No: 6, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£Ÿæä»•å…¥': { v17No: 6, category: 'å£²ä¸ŠåŸä¾¡' },
            'Fä»•å…¥': { v17No: 6, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£ŸææœŸæœ«æ£š': { v17No: 7, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£ŸææœŸæœ«æ£šå¸': { v17No: 7, category: 'å£²ä¸ŠåŸä¾¡' },
            'æœŸæœ«é£Ÿææ£šå¸': { v17No: 7, category: 'å£²ä¸ŠåŸä¾¡' },
            'FæœŸæœ«æ£š': { v17No: 7, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£ŸæåŸä¾¡': { v17No: 8, category: 'å£²ä¸ŠåŸä¾¡' },
            'ãƒ•ãƒ¼ãƒ‰åŸä¾¡': { v17No: 8, category: 'å£²ä¸ŠåŸä¾¡' },
            'ï¾Œï½°ï¾„ï¾åŸä¾¡': { v17No: 8, category: 'å£²ä¸ŠåŸä¾¡' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'FåŸä¾¡': { v17No: 8, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£ŸåŸä¾¡': { v17No: 8, category: 'å£²ä¸ŠåŸä¾¡' },
            'ãƒ‰ãƒªãƒ³ã‚¯æœŸé¦–æ£š': { v17No: 9, category: 'å£²ä¸ŠåŸä¾¡' },
            'ï¾„ï¾ï¾˜ï¾ï½¸æœŸé¦–æ£š': { v17No: 9, category: 'å£²ä¸ŠåŸä¾¡' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ‰ãƒªãƒ³ã‚¯æœŸé¦–æ£šå¸': { v17No: 9, category: 'å£²ä¸ŠåŸä¾¡' },
            'æœŸé¦–ãƒ‰ãƒªãƒ³ã‚¯æ£šå¸': { v17No: 9, category: 'å£²ä¸ŠåŸä¾¡' },
            'DæœŸé¦–æ£š': { v17No: 9, category: 'å£²ä¸ŠåŸä¾¡' },
            'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜': { v17No: 10, category: 'å£²ä¸ŠåŸä¾¡' },
            'ï¾„ï¾ï¾˜ï¾ï½¸ä»•å…¥é«˜': { v17No: 10, category: 'å£²ä¸ŠåŸä¾¡' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥': { v17No: 10, category: 'å£²ä¸ŠåŸä¾¡' },
            'Dä»•å…¥': { v17No: 10, category: 'å£²ä¸ŠåŸä¾¡' },
            'ãƒ‰ãƒªãƒ³ã‚¯æœŸæœ«æ£š': { v17No: 11, category: 'å£²ä¸ŠåŸä¾¡' },
            'ï¾„ï¾ï¾˜ï¾ï½¸æœŸæœ«æ£š': { v17No: 11, category: 'å£²ä¸ŠåŸä¾¡' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ‰ãƒªãƒ³ã‚¯æœŸæœ«æ£šå¸': { v17No: 11, category: 'å£²ä¸ŠåŸä¾¡' },
            'æœŸæœ«ãƒ‰ãƒªãƒ³ã‚¯æ£šå¸': { v17No: 11, category: 'å£²ä¸ŠåŸä¾¡' },
            'DæœŸæœ«æ£š': { v17No: 11, category: 'å£²ä¸ŠåŸä¾¡' },
            'ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡': { v17No: 12, category: 'å£²ä¸ŠåŸä¾¡' },
            'ï¾„ï¾ï¾˜ï¾ï½¸åŸä¾¡': { v17No: 12, category: 'å£²ä¸ŠåŸä¾¡' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'DåŸä¾¡': { v17No: 12, category: 'å£²ä¸ŠåŸä¾¡' },
            'é£²åŸä¾¡': { v17No: 12, category: 'å£²ä¸ŠåŸä¾¡' },
            'å†…éƒ¨æŒ¯æ›¿': { v17No: 13, category: 'å£²ä¸ŠåŸä¾¡' },
            'ç¤¾å†…æŒ¯æ›¿': { v17No: 13, category: 'å£²ä¸ŠåŸä¾¡' },
            'æŒ¯æ›¿': { v17No: 13, category: 'å£²ä¸ŠåŸä¾¡' },
            'åŸä¾¡åˆè¨ˆ': { v17No: 14, category: 'å£²ä¸ŠåŸä¾¡' },
            'å£²ä¸ŠåŸä¾¡åˆè¨ˆ': { v17No: 14, category: 'å£²ä¸ŠåŸä¾¡' },
            'å£²ä¸ŠåŸä¾¡è¨ˆ': { v17No: 14, category: 'å£²ä¸ŠåŸä¾¡' },
            'ä»•å…¥åŸä¾¡åˆè¨ˆ': { v17No: 14, category: 'å£²ä¸ŠåŸä¾¡' },
            'åŸä¾¡è¨ˆ': { v17No: 14, category: 'å£²ä¸ŠåŸä¾¡' },
            'FDåŸä¾¡åˆè¨ˆ': { v17No: 14, category: 'å£²ä¸ŠåŸä¾¡' },
            'FDåŸä¾¡': { v17No: 14, category: 'å£²ä¸ŠåŸä¾¡' },
            'å£²ä¸Šç·åˆ©ç›Š': { v17No: 15, category: 'å£²ä¸ŠåŸä¾¡' },
            'ç²—åˆ©ç›Š': { v17No: 15, category: 'å£²ä¸ŠåŸä¾¡' },
            'ç²—åˆ©': { v17No: 15, category: 'å£²ä¸ŠåŸä¾¡' },
            'å£²ä¸Šç·åˆ©ç›Šé¡': { v17No: 15, category: 'å£²ä¸ŠåŸä¾¡' },
            'ç·åˆ©ç›Š': { v17No: 15, category: 'å£²ä¸ŠåŸä¾¡' },
            'GP': { v17No: 15, category: 'å£²ä¸ŠåŸä¾¡' },  // Gross Profit
            // === äººä»¶è²»ï¼ˆNo.16-26ï¼‰ ===
            'çµ¦æ–™æ‰‹å½“': { v17No: 16, category: 'äººä»¶è²»' },
            'çµ¦ä¸æ‰‹å½“': { v17No: 16, category: 'äººä»¶è²»' },
            'çµ¦æ–™': { v17No: 16, category: 'äººä»¶è²»' },
            'åŸºæœ¬çµ¦': { v17No: 16, category: 'äººä»¶è²»' },
            'åº—é•·æ–™ç†é•·æ˜‡çµ¦': { v17No: 17, category: 'äººä»¶è²»' },
            'åº—é•·æ˜‡çµ¦': { v17No: 17, category: 'äººä»¶è²»' },
            'æ–™ç†é•·æ˜‡çµ¦': { v17No: 17, category: 'äººä»¶è²»' },
            'æ˜‡çµ¦': { v17No: 17, category: 'äººä»¶è²»' },
            'ç¤¾å“¡çµ¦ä¸': { v17No: 18, category: 'äººä»¶è²»' },
            'æ­£ç¤¾å“¡çµ¦ä¸': { v17No: 18, category: 'äººä»¶è²»' },
            'ç¤¾å“¡çµ¦æ–™': { v17No: 18, category: 'äººä»¶è²»' },
            'æ­£ç¤¾å“¡çµ¦æ–™': { v17No: 18, category: 'äººä»¶è²»' },
            'é›‘çµ¦': { v17No: 19, category: 'äººä»¶è²»' },
            'PAäººä»¶è²»': { v17No: 19, category: 'äººä»¶è²»' },
            'ãƒ‘ãƒ¼ãƒˆäººä»¶è²»': { v17No: 19, category: 'äººä»¶è²»' },
            'ï¾Šï¾Ÿï½°ï¾„äººä»¶è²»': { v17No: 19, category: 'äººä»¶è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ã‚¢ãƒ«ãƒã‚¤ãƒˆäººä»¶è²»': { v17No: 19, category: 'äººä»¶è²»' },
            'ï½±ï¾™ï¾Šï¾ï½²ï¾„äººä»¶è²»': { v17No: 19, category: 'äººä»¶è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ‘ãƒ¼ãƒˆçµ¦ä¸': { v17No: 19, category: 'äººä»¶è²»' },
            'ã‚¢ãƒ«ãƒã‚¤ãƒˆçµ¦ä¸': { v17No: 19, category: 'äººä»¶è²»' },
            'ãƒ˜ãƒ«ãƒ—äººä»¶è²»': { v17No: 20, category: 'äººä»¶è²»' },
            'ï¾ï¾™ï¾Œï¾Ÿäººä»¶è²»': { v17No: 20, category: 'äººä»¶è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ˜ãƒ«ãƒ—': { v17No: 20, category: 'äººä»¶è²»' },
            'å¿œæ´äººä»¶è²»': { v17No: 20, category: 'äººä»¶è²»' },
            'æ³•å®šç¦åˆ©è²»': { v17No: 21, category: 'äººä»¶è²»' },
            'ç¦åˆ©åšç”Ÿè²»': { v17No: 21, category: 'äººä»¶è²»' },
            'ç¤¾ä¼šä¿é™ºæ–™': { v17No: 21, category: 'äººä»¶è²»' },
            'é€šå‹¤äº¤é€šè²»': { v17No: 22, category: 'äººä»¶è²»' },
            'äº¤é€šè²»': { v17No: 22, category: 'äººä»¶è²»' },
            'é€šå‹¤è²»': { v17No: 22, category: 'äººä»¶è²»' },
            'è³ä¸å¼•å½“é‡‘ç¹°å…¥': { v17No: 23, category: 'äººä»¶è²»' },
            'è³ä¸å¼•å½“é‡‘': { v17No: 23, category: 'äººä»¶è²»' },
            'è³ä¸': { v17No: 23, category: 'äººä»¶è²»' },
            'ãƒœãƒ¼ãƒŠã‚¹': { v17No: 23, category: 'äººä»¶è²»' },
            'ï¾ï¾ï½°ï¾…ï½½': { v17No: 23, category: 'äººä»¶è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ç¤¾å®…å®¶è³ƒ': { v17No: 24, category: 'äººä»¶è²»' },
            'ç¤¾å®…è²»': { v17No: 24, category: 'äººä»¶è²»' },
            'ä½å®…æ‰‹å½“': { v17No: 24, category: 'äººä»¶è²»' },
            'ä¼‘æ¥­æ‰‹å½“': { v17No: 25, category: 'äººä»¶è²»' },
            'ä¼‘æ¥­è£œå„Ÿ': { v17No: 25, category: 'äººä»¶è²»' },
            'äººä»¶è²»åˆè¨ˆ': { v17No: 26, category: 'äººä»¶è²»' },
            'äººä»¶è²»è¨ˆ': { v17No: 26, category: 'äººä»¶è²»' },
            'åŠ´å‹™è²»åˆè¨ˆ': { v17No: 26, category: 'äººä»¶è²»' },
            'åŠ´å‹™è²»è¨ˆ': { v17No: 26, category: 'äººä»¶è²»' },
            'ç·äººä»¶è²»': { v17No: 26, category: 'äººä»¶è²»' },
            'äººä»¶è²»ç·é¡': { v17No: 26, category: 'äººä»¶è²»' },
            // === ãã®ä»–å¤‰å‹•è²»ï¼ˆNo.27-51ï¼‰ ===
            'è²©å£²ä¿ƒé€²è²»': { v17No: 27, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'è²©ä¿ƒè²»': { v17No: 27, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'åºƒå‘Šå®£ä¼è²»': { v17No: 27, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼': { v17No: 28, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ï¾’ï¾†ï½­ï½°ï½ºï¾‹ï¾Ÿï½°': { v17No: 28, category: 'ãã®ä»–å¤‰å‹•è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ¡ãƒ‹ãƒ¥ãƒ¼å°åˆ·': { v17No: 28, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'èª¿æŸ»è²»': { v17No: 29, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'å¸‚å ´èª¿æŸ»è²»': { v17No: 29, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'è¡›ç”Ÿè²»': { v17No: 30, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'è¡›ç”Ÿç®¡ç†è²»': { v17No: 30, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¸…æƒè²»': { v17No: 30, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ã‚µãƒ¼ãƒ“ã‚¹è²»': { v17No: 31, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ï½»ï½°ï¾‹ï¾ï½½è²»': { v17No: 31, category: 'ãã®ä»–å¤‰å‹•è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'é›»æ°—ä»£': { v17No: 32, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'é›»æ°—æ–™': { v17No: 32, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'é›»åŠ›è²»': { v17No: 32, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ã‚¬ã‚¹ä»£': { v17No: 33, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ï½¶ï¾ï½½ä»£': { v17No: 33, category: 'ãã®ä»–å¤‰å‹•è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ã‚¬ã‚¹æ–™': { v17No: 33, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ°´é“ä»£': { v17No: 34, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ°´é“æ–™': { v17No: 34, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ä¸Šä¸‹æ°´é“': { v17No: 34, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¶ˆè€—å“è²»': { v17No: 35, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¶ˆè€—å“': { v17No: 35, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'äº‹å‹™ç”¨å“è²»': { v17No: 35, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ä¿å®ˆä¿®ç¹•è²»': { v17No: 36, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ä¿®ç¹•è²»': { v17No: 36, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ä¿®ç†è²»': { v17No: 36, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ä¿å®ˆè²»': { v17No: 36, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ç§Ÿç¨å…¬èª²': { v17No: 37, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ç¨é‡‘': { v17No: 37, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'å…¬ç§Ÿå…¬èª²': { v17No: 37, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¥å¾…äº¤éš›è²»': { v17No: 38, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'äº¤éš›è²»': { v17No: 38, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¥å¾…è²»': { v17No: 38, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ—…è²»äº¤é€šè²»': { v17No: 39, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ—…è²»': { v17No: 39, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'å‡ºå¼µè²»': { v17No: 39, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'é€šä¿¡è²»': { v17No: 40, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'é›»è©±ä»£': { v17No: 40, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆè²»': { v17No: 40, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ï½²ï¾ï¾€ï½°ï¾ˆï½¯ï¾„è²»': { v17No: 40, category: 'ãã®ä»–å¤‰å‹•è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™': { v17No: 41, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ï½¸ï¾šï½¼ï¾ï½¯ï¾„æ‰‹æ•°æ–™': { v17No: 41, category: 'ãã®ä»–å¤‰å‹•è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ã‚«ãƒ¼ãƒ‰æ‰‹æ•°æ–™': { v17No: 41, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ï½¶ï½°ï¾„ï¾æ‰‹æ•°æ–™': { v17No: 41, category: 'ãã®ä»–å¤‰å‹•è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'æ±ºæ¸ˆæ‰‹æ•°æ–™': { v17No: 41, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ”¯æ‰•æ‰‹æ•°æ–™': { v17No: 42, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æŒ¯è¾¼æ‰‹æ•°æ–™': { v17No: 42, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ‰‹æ•°æ–™': { v17No: 42, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ä¼šè­°è²»': { v17No: 43, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'è«¸ä¼šè²»': { v17No: 44, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'çµ„åˆè²»': { v17No: 44, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ä¼šè²»': { v17No: 44, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'å›³æ›¸æ•™è‚²è²»': { v17No: 45, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ•™è‚²è²»': { v17No: 45, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'å›³æ›¸è²»': { v17No: 45, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ç ”ä¿®è²»': { v17No: 46, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ•™è‚²ç ”ä¿®è²»': { v17No: 46, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¥­æ…‹ç ”ç©¶è²»': { v17No: 47, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ç ”ç©¶é–‹ç™ºè²»': { v17No: 47, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¡ç”¨è²»': { v17No: 48, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ±‚äººè²»': { v17No: 48, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'äººææ¡ç”¨è²»': { v17No: 48, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ITè²»': { v17No: 49, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ã‚·ã‚¹ãƒ†ãƒ è²»': { v17No: 49, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ï½¼ï½½ï¾ƒï¾‘è²»': { v17No: 49, category: 'ãã®ä»–å¤‰å‹•è²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è²»': { v17No: 49, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'å¤–æ³¨è²»': { v17No: 50, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'æ¥­å‹™å§”è¨—è²»': { v17No: 50, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'é›‘è²»': { v17No: 51, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'ãã®ä»–çµŒè²»': { v17No: 51, category: 'ãã®ä»–å¤‰å‹•è²»' },
            'é›‘æå¤±': { v17No: 51, category: 'ãã®ä»–å¤‰å‹•è²»' },
            // === é›†è¨ˆï¼ˆNo.52, 60, 62, 75ï¼‰ ===
            'ãã®ä»–å¤‰å‹•è²»åˆè¨ˆ': { v17No: 52, category: 'é›†è¨ˆ' },
            'ãã®ä»–å¤‰å‹•è²»è¨ˆ': { v17No: 52, category: 'é›†è¨ˆ' },
            'å¤‰å‹•è²»åˆè¨ˆ': { v17No: 52, category: 'é›†è¨ˆ' },
            'å¤‰å‹•è²»è¨ˆ': { v17No: 52, category: 'é›†è¨ˆ' },
            'çµŒè²»åˆè¨ˆ': { v17No: 52, category: 'é›†è¨ˆ' },
            'çµŒè²»è¨ˆ': { v17No: 52, category: 'é›†è¨ˆ' },
            'è«¸çµŒè²»åˆè¨ˆ': { v17No: 52, category: 'é›†è¨ˆ' },
            'é™ç•Œåˆ©ç›Š': { v17No: 75, category: 'é›†è¨ˆ' },
            'é™ç•Œåˆ©ç›Šé¡': { v17No: 75, category: 'é›†è¨ˆ' },
            'è²¢çŒ®åˆ©ç›Š': { v17No: 75, category: 'é›†è¨ˆ' },
            'ãƒãƒ¼ã‚¸ãƒ³': { v17No: 75, category: 'é›†è¨ˆ' },
            'ï¾ï½°ï½¼ï¾ï¾': { v17No: 75, category: 'é›†è¨ˆ' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'å›ºå®šè²»åˆè¨ˆ': { v17No: 60, category: 'é›†è¨ˆ' },
            'å›ºå®šè²»è¨ˆ': { v17No: 60, category: 'é›†è¨ˆ' },
            'å›ºå®šçµŒè²»åˆè¨ˆ': { v17No: 60, category: 'é›†è¨ˆ' },
            'è²©å£²ç®¡ç†è²»åˆè¨ˆ': { v17No: 62, category: 'é›†è¨ˆ' },
            'è²©å£²ç®¡ç†è²»è¨ˆ': { v17No: 62, category: 'é›†è¨ˆ' },
            'è²©ç®¡è²»åˆè¨ˆ': { v17No: 62, category: 'é›†è¨ˆ' },
            'è²©ç®¡è²»è¨ˆ': { v17No: 62, category: 'é›†è¨ˆ' },
            'è²©ç®¡è²»': { v17No: 62, category: 'é›†è¨ˆ' },
            'ä¸€èˆ¬ç®¡ç†è²»': { v17No: 62, category: 'é›†è¨ˆ' },
            'ç®¡ç†è²»åˆè¨ˆ': { v17No: 62, category: 'é›†è¨ˆ' },
            // === ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£ãƒ»åº—èˆ—è£œå¡«ï¼ˆNo.53-54ï¼‰ ===
            'ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£': { v17No: 53, category: 'å›ºå®šè²»' },
            'ï¾›ï½²ï¾”ï¾˜ï¾ƒï½¨': { v17No: 53, category: 'å›ºå®šè²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£': { v17No: 53, category: 'å›ºå®šè²»' },  // è¡¨è¨˜æºã‚Œ
            'ï¾›ï½²ï¾”ï¾™ï¾ƒï½¨': { v17No: 53, category: 'å›ºå®šè²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'æœ¬éƒ¨ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£': { v17No: 53, category: 'å›ºå®šè²»' },
            'åº—èˆ—è£œå¡«': { v17No: 54, category: 'å›ºå®šè²»' },
            'åº—èˆ—è£œã¦ã‚“': { v17No: 54, category: 'å›ºå®šè²»' },
            'è£œå¡«': { v17No: 54, category: 'å›ºå®šè²»' },
            'è£œã¦ã‚“': { v17No: 54, category: 'å›ºå®šè²»' },
            // === å›ºå®šè²»ï¼ˆNo.55-59ï¼‰ ===
            'æ¸›ä¾¡å„Ÿå´è²»': { v17No: 55, category: 'å›ºå®šè²»' },
            'å„Ÿå´è²»': { v17No: 55, category: 'å›ºå®šè²»' },
            'è¨­å‚™å„Ÿå´': { v17No: 55, category: 'å›ºå®šè²»' },
            'å®¶è³ƒ': { v17No: 56, category: 'å›ºå®šè²»' },
            'åœ°ä»£å®¶è³ƒ': { v17No: 56, category: 'å›ºå®šè²»' },
            'åœ°ä»£': { v17No: 56, category: 'å›ºå®šè²»' },
            'åº—èˆ—å®¶è³ƒ': { v17No: 56, category: 'å›ºå®šè²»' },
            'è³ƒæ–™': { v17No: 56, category: 'å›ºå®šè²»' },
            'è­¦å‚™æ–™': { v17No: 57, category: 'å›ºå®šè²»' },
            'è­¦å‚™è²»': { v17No: 57, category: 'å›ºå®šè²»' },
            'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è²»': { v17No: 57, category: 'å›ºå®šè²»' },
            'ï½¾ï½·ï½­ï¾˜ï¾ƒï½¨è²»': { v17No: 57, category: 'å›ºå®šè²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒªãƒ¼ã‚¹æ–™': { v17No: 58, category: 'å›ºå®šè²»' },
            'ï¾˜ï½°ï½½æ–™': { v17No: 58, category: 'å›ºå®šè²»' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒªãƒ¼ã‚¹': { v17No: 58, category: 'å›ºå®šè²»' },
            'æ©Ÿå™¨ãƒªãƒ¼ã‚¹': { v17No: 58, category: 'å›ºå®šè²»' },
            'è³ƒå€Ÿæ–™': { v17No: 59, category: 'å›ºå®šè²»' },
            'å€Ÿåœ°æ–™': { v17No: 59, category: 'å›ºå®šè²»' },
            // === åˆ©ç›Šï¼ˆNo.61, 63ï¼‰ ===
            'åº—èˆ—å–¶æ¥­åˆ©ç›Š': { v17No: 61, category: 'åˆ©ç›Š' },
            'åº—èˆ—åˆ©ç›Š': { v17No: 61, category: 'åˆ©ç›Š' },
            'åº—åˆ©ç›Š': { v17No: 61, category: 'åˆ©ç›Š' },
            'åº—åˆ¥å–¶æ¥­åˆ©ç›Š': { v17No: 61, category: 'åˆ©ç›Š' },
            'å–¶æ¥­åˆ©ç›Š': { v17No: 63, category: 'åˆ©ç›Š' },
            'æœ¬éƒ¨å–¶æ¥­åˆ©ç›Š': { v17No: 63, category: 'åˆ©ç›Š' },
            // === KPIï¼ˆNo.64-70ï¼‰ ===
            'å®¢æ•°': { v17No: 64, category: 'KPI' },
            'æ¥å®¢æ•°': { v17No: 64, category: 'KPI' },
            'æ¥åº—å®¢æ•°': { v17No: 64, category: 'KPI' },
            'çµ„æ•°': { v17No: 64, category: 'KPI' },
            'å®¢å˜ä¾¡': { v17No: 65, category: 'KPI' },
            'å¹³å‡å®¢å˜ä¾¡': { v17No: 65, category: 'KPI' },
            'å˜ä¾¡': { v17No: 65, category: 'KPI' },
            'ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡': { v17No: 66, category: 'KPI' },
            'ï¾—ï¾ï¾å£²ä¸Šæ¯”ç‡': { v17No: 66, category: 'KPI' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ©ãƒ³ãƒæ¯”ç‡': { v17No: 66, category: 'KPI' },
            'Lå£²ä¸Šæ¯”ç‡': { v17No: 66, category: 'KPI' },
            'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡': { v17No: 67, category: 'KPI' },
            'ï¾ƒï¾ï½¨ï¾…ï½°å£²ä¸Šæ¯”ç‡': { v17No: 67, category: 'KPI' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'ãƒ‡ã‚£ãƒŠãƒ¼æ¯”ç‡': { v17No: 67, category: 'KPI' },
            'ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡': { v17No: 68, category: 'KPI' },
            'ï¾Œï½°ï¾„ï¾å£²ä¸Šæ¯”ç‡': { v17No: 68, category: 'KPI' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'Få£²ä¸Šæ¯”ç‡': { v17No: 68, category: 'KPI' },
            'é£Ÿå£²ä¸Šæ¯”ç‡': { v17No: 68, category: 'KPI' },
            'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡': { v17No: 69, category: 'KPI' },
            'ï¾„ï¾ï¾˜ï¾ï½¸å£²ä¸Šæ¯”ç‡': { v17No: 69, category: 'KPI' },  // åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
            'é£²å£²ä¸Šæ¯”ç‡': { v17No: 69, category: 'KPI' },
            'ãã®ä»–å£²ä¸Šæ¯”ç‡': { v17No: 70, category: 'KPI' },
            'ä»–å£²ä¸Šæ¯”ç‡': { v17No: 70, category: 'KPI' },
            // === å–¶æ¥­å¤–ãƒ»çµŒå¸¸åˆ©ç›Šï¼ˆNo.71-74ï¼‰ ===
            'å–¶æ¥­å¤–åç›Šåˆè¨ˆ': { v17No: 71, category: 'å–¶æ¥­å¤–' },
            'å–¶æ¥­å¤–åç›Š': { v17No: 71, category: 'å–¶æ¥­å¤–' },
            'å–¶æ¥­å¤–åç›Šè¨ˆ': { v17No: 71, category: 'å–¶æ¥­å¤–' },
            'å–¶æ¥­å¤–è²»ç”¨åˆè¨ˆ': { v17No: 72, category: 'å–¶æ¥­å¤–' },
            'å–¶æ¥­å¤–è²»ç”¨': { v17No: 72, category: 'å–¶æ¥­å¤–' },
            'å–¶æ¥­å¤–è²»ç”¨è¨ˆ': { v17No: 72, category: 'å–¶æ¥­å¤–' },
            'å–¶æ¥­å¤–æç›Šåˆè¨ˆ': { v17No: 73, category: 'å–¶æ¥­å¤–' },
            'å–¶æ¥­å¤–æç›Š': { v17No: 73, category: 'å–¶æ¥­å¤–' },
            'çµŒå¸¸åˆ©ç›Š': { v17No: 74, category: 'åˆ©ç›Š' },
            'çµŒå¸¸æç›Š': { v17No: 74, category: 'åˆ©ç›Š' },
            'ç¨å¼•å‰åˆ©ç›Š': { v17No: 74, category: 'åˆ©ç›Š' }
        };

        // â˜… CODE_BASED_MAP: å‹˜å®šç§‘ç›®ã‚³ãƒ¼ãƒ‰ï¼ˆBåˆ—ï¼‰ã‹ã‚‰v17Noã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        var CODE_BASED_MAP = {
            // === å£²ä¸Šé«˜ï¼ˆNo.1-4ï¼‰ ===
            '810': { v17No: 1, category: 'å£²ä¸Šé«˜', name: 'åº—èˆ—å£²ä¸Šé«˜' },
            '811': { v17No: 2, category: 'å£²ä¸Šé«˜', name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š' },
            '812': { v17No: 3, category: 'å£²ä¸Šé«˜', name: 'ãã®ä»–å£²ä¸Šé«˜' },
            '999': { v17No: 4, category: 'å£²ä¸Šé«˜', name: 'å£²ä¸Šé«˜åˆè¨ˆ' },
            // === å£²ä¸ŠåŸä¾¡ï¼ˆNo.5-15ï¼‰ ===
            '2028': { v17No: 5, category: 'å£²ä¸ŠåŸä¾¡', name: 'é£ŸææœŸé¦–æ£š' },
            '461': { v17No: 6, category: 'å£²ä¸ŠåŸä¾¡', name: 'é£Ÿæä»•å…¥é«˜' },
            '2029': { v17No: 7, category: 'å£²ä¸ŠåŸä¾¡', name: 'é£ŸææœŸæœ«æ£š' },
            '2030': { v17No: 9, category: 'å£²ä¸ŠåŸä¾¡', name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸé¦–æ£š' },
            '462': { v17No: 10, category: 'å£²ä¸ŠåŸä¾¡', name: 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜' },
            '2031': { v17No: 11, category: 'å£²ä¸ŠåŸä¾¡', name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸæœ«æ£š' },
            '463': { v17No: 13, category: 'å£²ä¸ŠåŸä¾¡', name: 'å†…éƒ¨æŒ¯æ›¿' },
            // === äººä»¶è²»ï¼ˆNo.16-26ï¼‰ ===
            '501': { v17No: 16, category: 'äººä»¶è²»', name: 'çµ¦æ–™æ‰‹å½“' },
            '509': { v17No: 19, category: 'äººä»¶è²»', name: 'é›‘çµ¦' },
            '503': { v17No: 20, category: 'äººä»¶è²»', name: 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»' },
            '504': { v17No: 21, category: 'äººä»¶è²»', name: 'æ³•å®šç¦åˆ©è²»' },
            '508': { v17No: 22, category: 'äººä»¶è²»', name: 'é€šå‹¤äº¤é€šè²»' },
            '506': { v17No: 23, category: 'äººä»¶è²»', name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥' },
            '553': { v17No: 24, category: 'äººä»¶è²»', name: 'ç¤¾å®…å®¶è³ƒ' },
            '2105': { v17No: 25, category: 'äººä»¶è²»', name: 'ä¼‘æ¥­æ‰‹å½“' },
            // === ãã®ä»–å¤‰å‹•è²»ï¼ˆNo.27-51ï¼‰ ===
            '510': { v17No: 27, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'è²©å£²ä¿ƒé€²è²»' },
            '541': { v17No: 28, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼' },
            '516': { v17No: 29, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'èª¿æŸ»è²»' },
            '514': { v17No: 30, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'è¡›ç”Ÿè²»' },
            '542': { v17No: 31, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»' },
            '520': { v17No: 32, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'é›»æ°—ä»£' },
            '521': { v17No: 33, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ã‚¬ã‚¹ä»£' },
            '522': { v17No: 34, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'æ°´é“ä»£' },
            '523': { v17No: 35, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'æ¶ˆè€—å“è²»' },
            '526': { v17No: 36, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ä¿å®ˆä¿®ç¹•è²»' },
            '527': { v17No: 37, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ç§Ÿç¨å…¬èª²' },
            '529': { v17No: 38, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'æ¥å¾…äº¤éš›è²»' },
            '530': { v17No: 39, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'æ—…è²»äº¤é€šè²»' },
            '531': { v17No: 40, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'é€šä¿¡è²»' },
            '5321': { v17No: 41, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™' },
            '532': { v17No: 42, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'æ”¯æ‰•æ‰‹æ•°æ–™' },
            '533': { v17No: 43, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ä¼šè­°è²»' },
            '534': { v17No: 44, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'è«¸ä¼šè²»' },
            '536': { v17No: 45, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'å›³æ›¸æ•™è‚²è²»' },
            '546': { v17No: 46, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ç ”ä¿®è²»' },
            '537': { v17No: 47, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'æ¥­æ…‹ç ”ç©¶è²»' },
            '518': { v17No: 48, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'æ¡ç”¨è²»' },
            '550': { v17No: 49, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'ITè²»' },
            '2128': { v17No: 50, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'å¤–æ³¨è²»' },
            '539': { v17No: 51, category: 'ãã®ä»–å¤‰å‹•è²»', name: 'é›‘è²»' },
            // === ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£ãƒ»åº—èˆ—è£œå¡«ï¼ˆNo.53-54ï¼‰ ===
            '512': { v17No: 53, category: 'å›ºå®šè²»', name: 'ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£' },
            '2124': { v17No: 53, category: 'å›ºå®šè²»', name: 'ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£' },  // åº—èˆ—åˆ¥ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£
            // === å›ºå®šè²»ï¼ˆNo.55-59ï¼‰ ===
            '528': { v17No: 55, category: 'å›ºå®šè²»', name: 'æ¸›ä¾¡å„Ÿå´è²»' },
            '554': { v17No: 56, category: 'å›ºå®šè²»', name: 'å®¶è³ƒ' },
            '552': { v17No: 57, category: 'å›ºå®šè²»', name: 'è­¦å‚™æ–™' },
            '5241': { v17No: 58, category: 'å›ºå®šè²»', name: 'ãƒªãƒ¼ã‚¹æ–™' },
            '524': { v17No: 59, category: 'å›ºå®šè²»', name: 'è³ƒå€Ÿæ–™' }
            // === åˆ©ç›Šãƒ»é›†è¨ˆã‚³ãƒ¼ãƒ‰ ===
            // 9640, 9700ã¯å‰Šé™¤ï¼ˆåˆè¨ˆå€¤ãƒ»è¨ˆç®—å€¤ã¯NAME_BASED_MAPã§å–å¾—ï¼‰
            // å–¶æ¥­åˆ©ç›Š(63), çµŒå¸¸åˆ©ç›Š(74)ç­‰ã¯CSVã®é …ç›®åã‹ã‚‰ç›´æ¥ãƒãƒƒãƒ”ãƒ³ã‚°
        };

        // å‹˜å®šç§‘ç›®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰v17Noã‚’æ¤œç´¢ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function findV17NoByCode(code) {
            if (!code) return null;
            var codeStr = String(code).trim();

            // ç›´æ¥ãƒãƒƒãƒ
            if (CODE_BASED_MAP[codeStr]) {
                return CODE_BASED_MAP[codeStr];
            }

            // è¦‹ãˆãªã„æ–‡å­—ã‚’é™¤å»ã—ã¦å†è©¦è¡Œ
            var cleanCode = codeStr.replace(/[^\d]/g, '');
            if (cleanCode !== codeStr && CODE_BASED_MAP[cleanCode]) {
                console.log('findV17NoByCode: cleaned "' + codeStr + '" to "' + cleanCode + '"');
                return CODE_BASED_MAP[cleanCode];
            }

            // ãƒ‡ãƒãƒƒã‚°ï¼šç›£è¦–å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã®å ´åˆã¯è­¦å‘Š
            var debugCodes = ['810', '2030', '2031', '503'];
            if (debugCodes.indexOf(codeStr) >= 0 || debugCodes.indexOf(cleanCode) >= 0) {
                console.warn('findV17NoByCode: ã‚³ãƒ¼ãƒ‰ "' + codeStr + '" ãŒCODE_BASED_MAPã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                console.log('CODE_BASED_MAP keys sample:', Object.keys(CODE_BASED_MAP).slice(0, 10));
            }

            return null;
        }

        // åŠè§’ã‚«ã‚¿ã‚«ãƒŠâ†’å…¨è§’ã‚«ã‚¿ã‚«ãƒŠå¤‰æ›
        function normalizeKatakana(str) {
            var kanaMap = {
                'ï½±':'ã‚¢','ï½²':'ã‚¤','ï½³':'ã‚¦','ï½´':'ã‚¨','ï½µ':'ã‚ª',
                'ï½¶':'ã‚«','ï½·':'ã‚­','ï½¸':'ã‚¯','ï½¹':'ã‚±','ï½º':'ã‚³',
                'ï½»':'ã‚µ','ï½¼':'ã‚·','ï½½':'ã‚¹','ï½¾':'ã‚»','ï½¿':'ã‚½',
                'ï¾€':'ã‚¿','ï¾':'ãƒ','ï¾‚':'ãƒ„','ï¾ƒ':'ãƒ†','ï¾„':'ãƒˆ',
                'ï¾…':'ãƒŠ','ï¾†':'ãƒ‹','ï¾‡':'ãƒŒ','ï¾ˆ':'ãƒ','ï¾‰':'ãƒ',
                'ï¾Š':'ãƒ','ï¾‹':'ãƒ’','ï¾Œ':'ãƒ•','ï¾':'ãƒ˜','ï¾':'ãƒ›',
                'ï¾':'ãƒ','ï¾':'ãƒŸ','ï¾‘':'ãƒ ','ï¾’':'ãƒ¡','ï¾“':'ãƒ¢',
                'ï¾”':'ãƒ¤','ï¾•':'ãƒ¦','ï¾–':'ãƒ¨',
                'ï¾—':'ãƒ©','ï¾˜':'ãƒª','ï¾™':'ãƒ«','ï¾š':'ãƒ¬','ï¾›':'ãƒ­',
                'ï¾œ':'ãƒ¯','ï½¦':'ãƒ²','ï¾':'ãƒ³',
                'ï¾':'ã‚›','ï¾Ÿ':'ã‚œ',
                'ï½¬':'ãƒ£','ï½­':'ãƒ¥','ï½®':'ãƒ§',
                'ï½¯':'ãƒƒ','ï½°':'ãƒ¼'
            };
            var result = '';
            for (var i = 0; i < str.length; i++) {
                var c = str[i];
                // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ã®çµåˆå‡¦ç†
                if (i + 1 < str.length) {
                    var next = str[i + 1];
                    if (next === 'ï¾' && kanaMap[c]) {
                        var base = kanaMap[c];
                        var dakuten = {'ã‚«':'ã‚¬','ã‚­':'ã‚®','ã‚¯':'ã‚°','ã‚±':'ã‚²','ã‚³':'ã‚´',
                                       'ã‚µ':'ã‚¶','ã‚·':'ã‚¸','ã‚¹':'ã‚º','ã‚»':'ã‚¼','ã‚½':'ã‚¾',
                                       'ã‚¿':'ãƒ€','ãƒ':'ãƒ‚','ãƒ„':'ãƒ…','ãƒ†':'ãƒ‡','ãƒˆ':'ãƒ‰',
                                       'ãƒ':'ãƒ','ãƒ’':'ãƒ“','ãƒ•':'ãƒ–','ãƒ˜':'ãƒ™','ãƒ›':'ãƒœ',
                                       'ã‚¦':'ãƒ´'};
                        if (dakuten[base]) {
                            result += dakuten[base];
                            i++;
                            continue;
                        }
                    }
                    if (next === 'ï¾Ÿ' && kanaMap[c]) {
                        var base = kanaMap[c];
                        var handakuten = {'ãƒ':'ãƒ‘','ãƒ’':'ãƒ”','ãƒ•':'ãƒ—','ãƒ˜':'ãƒš','ãƒ›':'ãƒ'};
                        if (handakuten[base]) {
                            result += handakuten[base];
                            i++;
                            continue;
                        }
                    }
                }
                result += kanaMap[c] || c;
            }
            return result;
        }

        // é …ç›®åã‹ã‚‰v17Noã‚’æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´å¯¾å¿œãƒ»å¼·åŒ–ç‰ˆï¼‰
        function findV17NoByName(itemName) {
            if (!itemName) return null;
            var normalized = normalizeKatakana(itemName.trim());

            // å®Œå…¨ä¸€è‡´
            if (NAME_BASED_MAP[normalized]) {
                return NAME_BASED_MAP[normalized];
            }

            // ç©ºç™½ãƒ»å…¨è§’ç©ºç™½ã‚’é™¤å»ã—ã¦å†è©¦è¡Œ
            var noSpace = normalized.replace(/[\sã€€]/g, '');
            if (noSpace !== normalized && NAME_BASED_MAP[noSpace]) {
                return NAME_BASED_MAP[noSpace];
            }

            // éƒ¨åˆ†ä¸€è‡´ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å«ã‚€ï¼‰
            // â€» çŸ­ã„é …ç›®åï¼ˆ3æ–‡å­—ä»¥ä¸‹ï¼‰ã®é€†ãƒãƒƒãƒã¯èª¤ãƒãƒƒãƒã‚’é˜²ããŸã‚ç„¡åŠ¹
            for (var key in NAME_BASED_MAP) {
                // å…¥åŠ›ãŒã‚­ãƒ¼ã‚’å«ã‚€å ´åˆï¼ˆä¾‹ï¼šã€Œåº—èˆ—å£²ä¸Šé«˜ABCã€ãŒã€Œåº—èˆ—å£²ä¸Šé«˜ã€ã‚’å«ã‚€ï¼‰
                if (normalized.indexOf(key) >= 0) {
                    return NAME_BASED_MAP[key];
                }
                // ã‚­ãƒ¼ãŒå…¥åŠ›ã‚’å«ã‚€å ´åˆï¼ˆä¾‹ï¼šã€Œåº—èˆ—å£²ä¸Šé«˜ã€ãŒã€Œå£²ä¸Šé«˜ã€ã‚’å«ã‚€ï¼‰
                // â†’ å…¥åŠ›ãŒ4æ–‡å­—ä»¥ä¸Šã®å ´åˆã®ã¿è¨±å¯ï¼ˆã€Œå£²ä¸Šã€ã®ã‚ˆã†ãªçŸ­ã„åå‰ã®èª¤ãƒãƒƒãƒé˜²æ­¢ï¼‰
                if (normalized.length >= 4 && key.indexOf(normalized) >= 0) {
                    return NAME_BASED_MAP[key];
                }
            }

            // ã•ã‚‰ã«æŸ”è»Ÿãªãƒãƒƒãƒãƒ³ã‚°ï¼šç©ºç™½é™¤å»ç‰ˆã§ã®éƒ¨åˆ†ä¸€è‡´
            for (var key in NAME_BASED_MAP) {
                var keyNoSpace = key.replace(/[\sã€€]/g, '');
                // å…¥åŠ›ãŒã‚­ãƒ¼ã‚’å«ã‚€å ´åˆ
                if (noSpace.indexOf(keyNoSpace) >= 0) {
                    return NAME_BASED_MAP[key];
                }
                // ã‚­ãƒ¼ãŒå…¥åŠ›ã‚’å«ã‚€å ´åˆ â†’ å…¥åŠ›ãŒ4æ–‡å­—ä»¥ä¸Šã®å ´åˆã®ã¿è¨±å¯
                if (noSpace.length >= 4 && keyNoSpace.indexOf(noSpace) >= 0) {
                    return NAME_BASED_MAP[key];
                }
            }

            // ãƒ‡ãƒãƒƒã‚°ï¼šç›£è¦–å¯¾è±¡ã®é …ç›®åã®å ´åˆã¯è­¦å‘Š
            var debugNames = ['åº—èˆ—å£²ä¸Šé«˜', 'é£ŸæåŸä¾¡', 'ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡', 'ãƒ‰ãƒªãƒ³ã‚¯æœŸé¦–æ£š', 'ãƒ‰ãƒªãƒ³ã‚¯æœŸæœ«æ£š', 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»'];
            if (debugNames.indexOf(normalized) >= 0) {
                console.warn('findV17NoByName: é …ç›®å "' + normalized + '" ãŒNAME_BASED_MAPã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            return null;
        }

        // â˜… è¨ˆç®—ãƒ«ãƒ¼ãƒ«ï¼ˆé¡§å®¢äºˆç®— â†’ ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›ã¸ã®å¤‰æ›ï¼‰v17æº–æ‹ 
        var CALC_RULES = {
            // === åŸä¾¡ç³»ï¼ˆç‡è¨ˆç®—ï¼‰v17 No.8,12 ===
            'FDä»•å…¥è²»': { type: 'sum', items: [8, 12], desc: 'é£ŸæåŸä¾¡+ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡', v17Ref: 'No.8,12' },
            'FDä»•å…¥è²»ç‡': { type: 'rate', numerator: 'FDä»•å…¥è²»', denominator: 'item:4', desc: '(é£ŸæåŸä¾¡+ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡)Ã·å£²ä¸Šåˆè¨ˆÃ—100', v17Ref: 'No.8å…¥åŠ›å‰æº–å‚™' },

            // === äººä»¶è²»ç³»ï¼ˆåˆè¨ˆãƒ»ç‡è¨ˆç®—ï¼‰v17 No.16-25 ===
            'å›ºå®šäººä»¶è²»åˆè¨ˆ': {
                type: 'sum',
                items: [16, 17, 18, 21, 22, 23, 24, 25],  // ãƒ˜ãƒ«ãƒ—äººä»¶è²»(20)ã¯ç‹¬ç«‹é …ç›®ã¨ã—ã¦åˆ¥é€”è¨ˆä¸Š
                desc: 'çµ¦æ–™æ‰‹å½“+åº—é•·æ˜‡çµ¦+ç¤¾å“¡çµ¦ä¸+æ³•å®šç¦åˆ©è²»+é€šå‹¤äº¤é€šè²»+è³ä¸å¼•å½“é‡‘+ç¤¾å®…å®¶è³ƒ+ä¼‘æ¥­æ‰‹å½“',
                v17Ref: 'No.16-18,21-25'
            },
            'PAäººä»¶è²»åˆè¨ˆ': { type: 'sum', items: [19], desc: 'é›‘çµ¦ï¼ˆãƒ‘ãƒ¼ãƒˆãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆï¼‰', v17Ref: 'No.19' },  // ãƒ˜ãƒ«ãƒ—äººä»¶è²»(20)ã¯å›ºå®šè²»ã¨ã—ã¦åˆ¥é€”è¨ˆä¸Š
            'PAäººä»¶è²»ç‡': { type: 'rate', numerator: 'PAäººä»¶è²»åˆè¨ˆ', denominator: 'item:4', desc: 'é›‘çµ¦Ã·å£²ä¸Šåˆè¨ˆÃ—100', v17Ref: 'No.19å…¥åŠ›å‰æº–å‚™' },

            // === å›ºå®šè²»ç³»ï¼ˆåˆè¨ˆï¼‰v17 No.56,59 / No.57,58 ===
            'åœ°ä»£å®¶è³ƒåˆè¨ˆ': { type: 'sum', items: [56, 59], desc: 'å®¶è³ƒ+è³ƒå€Ÿæ–™', v17Ref: 'No.56,59' },
            'è³‡æè²»åˆè¨ˆ': { type: 'sum', items: [57, 58], desc: 'è­¦å‚™æ–™+ãƒªãƒ¼ã‚¹æ–™', v17Ref: 'No.57,58' },

            // === ãã®ä»–å¤‰å‹•è²»ç³»ï¼ˆåˆè¨ˆï¼‰v17 No.27-51 ===
            'æ°´é“å…‰ç†±è²»åˆè¨ˆ': { type: 'sum', items: [32, 33, 34], desc: 'é›»æ°—ä»£+ã‚¬ã‚¹ä»£+æ°´é“ä»£', v17Ref: 'No.32-34' },
            'ãã®ä»–å¤‰å‹•è²»åˆè¨ˆ': {
                type: 'sum',
                items: [27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51],
                desc: 'å…¨ãã®ä»–å¤‰å‹•è²»åˆè¨ˆ',
                v17Ref: 'No.52è‡ªå‹•æ¼”ç®—'
            },

            // === å£²ä¸Šæ¯”ç‡ï¼ˆç‡è¨ˆç®—ï¼‰v17 No.66-70 ===
            'ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'item:1', denominator: 'item:4', desc: 'åº—èˆ—å£²ä¸Šé«˜Ã·å£²ä¸Šåˆè¨ˆÃ—100', v17Ref: 'No.68è‡ªå‹•æ¼”ç®—' },
            'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'item:2', denominator: 'item:4', desc: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸ŠÃ·å£²ä¸Šåˆè¨ˆÃ—100', v17Ref: 'No.69' },
            'ãã®ä»–å£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'item:3', denominator: 'item:4', desc: 'ãã®ä»–å£²ä¸ŠÃ·å£²ä¸Šåˆè¨ˆÃ—100', v17Ref: 'No.70' },
            // ãƒ©ãƒ³ãƒãƒ»ãƒ‡ã‚£ãƒŠãƒ¼æ¯”ç‡ v17 No.66-67
            'ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'ãƒ©ãƒ³ãƒå£²ä¸Š', denominator: 'item:4', fallback: 40, desc: 'ãƒ©ãƒ³ãƒå£²ä¸ŠÃ·å£²ä¸Šåˆè¨ˆÃ—100ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ40%ï¼‰', v17Ref: 'No.66' },
            'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡': { type: 'rate', numerator: 'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Š', denominator: 'item:4', fallback: 60, desc: 'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸ŠÃ·å£²ä¸Šåˆè¨ˆÃ—100ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60%ï¼‰', v17Ref: 'No.67' },

            // === å›ºå®šè²»åˆè¨ˆï¼ˆMQè¨ˆç®—ç”¨ï¼‰v17 No.60 ===
            'å›ºå®šè²»åˆè¨ˆ': {
                type: 'sum',
                items: [16, 17, 18, 21, 22, 23, 24, 25, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 55, 56, 57, 58, 59],
                desc: 'å›ºå®šäººä»¶è²»+ãã®ä»–å¤‰å‹•è²»+å›ºå®šè²»',
                v17Ref: 'No.60è‡ªå‹•æ¼”ç®—'
            },

            // === å¤‰å‹•è²»åˆè¨ˆï¼ˆMQè¨ˆç®—ç”¨ï¼‰v17 No.53 ===
            'å¤‰å‹•è²»åˆè¨ˆ': {
                type: 'formula',
                formula: 'FDä»•å…¥è²» + PAäººä»¶è²»åˆè¨ˆ',
                desc: 'åŸä¾¡+PAäººä»¶è²»',
                v17Ref: 'No.53è‡ªå‹•æ¼”ç®—'
            },

            // === å–¶æ¥­åˆ©ç›Šï¼ˆNo.63è‡ªå‹•æ¼”ç®—ï¼‰===
            'å–¶æ¥­åˆ©ç›Š': {
                type: 'diff',
                minuend: 'item:61',      // åº—èˆ—å–¶æ¥­åˆ©ç›Š
                subtrahend: 'item:62',   // è²©å£²ç®¡ç†è²»åˆè¨ˆ
                desc: 'åº—èˆ—å–¶æ¥­åˆ©ç›Š-è²©å£²ç®¡ç†è²»åˆè¨ˆ',
                v17Ref: 'No.63è‡ªå‹•æ¼”ç®—'
            }
        };

        // v17é …ç›®å®šç¾©ï¼ˆé¡§å®¢äºˆç®—_ãƒ©ã‚¯ãƒŸãƒ¼_ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨_v17_MUGENé™å®š.csvæº–æ‹ ï¼‰
        var ITEMS = {
            // === å£²ä¸Šé«˜ï¼ˆNo.1-4ï¼‰ ===
            1: { name: 'åº—èˆ—å£²ä¸Šé«˜', category: 'å£²ä¸Šé«˜', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            2: { name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š', category: 'å£²ä¸Šé«˜', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            3: { name: 'ãã®ä»–å£²ä¸Šé«˜', category: 'å£²ä¸Šé«˜', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            4: { name: 'å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰', category: 'å£²ä¸Šé«˜', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            // === å£²ä¸ŠåŸä¾¡ï¼ˆNo.5-15ï¼‰ ===
            5: { name: 'é£ŸææœŸé¦–æ£š', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'D.å‚ç…§ã®ã¿' },
            6: { name: 'é£Ÿæä»•å…¥é«˜', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'D.å‚ç…§ã®ã¿' },
            7: { name: 'é£ŸææœŸæœ«æ£š', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'D.å‚ç…§ã®ã¿' },
            8: { name: 'é£ŸæåŸä¾¡', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            9: { name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸé¦–æ£š', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'D.å‚ç…§ã®ã¿' },
            10: { name: 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'D.å‚ç…§ã®ã¿' },
            11: { name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸæœ«æ£š', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'D.å‚ç…§ã®ã¿' },
            12: { name: 'ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            13: { name: 'å†…éƒ¨æŒ¯æ›¿', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'D.å‚ç…§ã®ã¿' },
            14: { name: 'åŸä¾¡åˆè¨ˆ', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            15: { name: 'å£²ä¸Šç·åˆ©ç›Š', category: 'å£²ä¸ŠåŸä¾¡', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            // === äººä»¶è²»ï¼ˆNo.16-26ï¼‰ ===
            16: { name: 'çµ¦æ–™æ‰‹å½“', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            17: { name: 'åº—é•·æ–™ç†é•·æ˜‡çµ¦', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            18: { name: 'ç¤¾å“¡çµ¦ä¸', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            19: { name: 'é›‘çµ¦', category: 'äººä»¶è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            20: { name: 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            21: { name: 'æ³•å®šç¦åˆ©è²»', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            22: { name: 'é€šå‹¤äº¤é€šè²»', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            23: { name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            24: { name: 'ç¤¾å®…å®¶è³ƒ', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            25: { name: 'ä¼‘æ¥­æ‰‹å½“', category: 'äººä»¶è²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            26: { name: 'äººä»¶è²»åˆè¨ˆ', category: 'äººä»¶è²»', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            // === ãã®ä»–å¤‰å‹•è²»ï¼ˆNo.27-51ï¼‰ ===
            27: { name: 'è²©å£²ä¿ƒé€²è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            28: { name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            29: { name: 'èª¿æŸ»è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            30: { name: 'è¡›ç”Ÿè²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            31: { name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            32: { name: 'é›»æ°—ä»£', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            33: { name: 'ã‚¬ã‚¹ä»£', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            34: { name: 'æ°´é“ä»£', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            35: { name: 'æ¶ˆè€—å“è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            36: { name: 'ä¿å®ˆä¿®ç¹•è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            37: { name: 'ç§Ÿç¨å…¬èª²', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            38: { name: 'æ¥å¾…äº¤éš›è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            39: { name: 'æ—…è²»äº¤é€šè²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            40: { name: 'é€šä¿¡è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            41: { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            42: { name: 'æ”¯æ‰•æ‰‹æ•°æ–™', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            43: { name: 'ä¼šè­°è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            44: { name: 'è«¸ä¼šè²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            45: { name: 'å›³æ›¸æ•™è‚²è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            46: { name: 'ç ”ä¿®è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            47: { name: 'æ¥­æ…‹ç ”ç©¶è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            48: { name: 'æ¡ç”¨è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            49: { name: 'ITè²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            50: { name: 'å¤–æ³¨è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            51: { name: 'é›‘è²»', category: 'ãã®ä»–å¤‰å‹•è²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            // === é›†è¨ˆï¼ˆNo.52ï¼‰ ===
            52: { name: 'ãã®ä»–å¤‰å‹•è²»åˆè¨ˆ', category: 'é›†è¨ˆ', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            // === ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£ãƒ»åº—èˆ—è£œå¡«ï¼ˆNo.53-54ï¼‰ ===
            53: { name: 'ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£', category: 'å›ºå®šè²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            54: { name: 'åº—èˆ—è£œå¡«', category: 'å›ºå®šè²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            // === å›ºå®šè²»ï¼ˆNo.55-59ï¼‰ ===
            55: { name: 'æ¸›ä¾¡å„Ÿå´è²»', category: 'å›ºå®šè²»', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            56: { name: 'å®¶è³ƒ', category: 'å›ºå®šè²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            57: { name: 'è­¦å‚™æ–™', category: 'å›ºå®šè²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            58: { name: 'ãƒªãƒ¼ã‚¹æ–™', category: 'å›ºå®šè²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            59: { name: 'è³ƒå€Ÿæ–™', category: 'å›ºå®šè²»', inputStyle: 'B.åˆç®—ã—ã¦å…¥åŠ›' },
            // === é›†è¨ˆï¼ˆç¶šãï¼‰ ===
            60: { name: 'å›ºå®šè²»åˆè¨ˆ', category: 'é›†è¨ˆ', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            // === åˆ©ç›Šï¼ˆNo.61, 63ï¼‰ ===
            61: { name: 'åº—èˆ—å–¶æ¥­åˆ©ç›Š', category: 'åˆ©ç›Š', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            62: { name: 'è²©å£²ç®¡ç†è²»åˆè¨ˆ', category: 'é›†è¨ˆ', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            63: { name: 'å–¶æ¥­åˆ©ç›Š', category: 'åˆ©ç›Š', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            // === KPIï¼ˆNo.64-70ï¼‰ ===
            64: { name: 'å®¢æ•°', category: 'KPI', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            65: { name: 'å®¢å˜ä¾¡', category: 'KPI', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            66: { name: 'ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡', category: 'KPI', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            67: { name: 'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡', category: 'KPI', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            68: { name: 'ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡', category: 'KPI', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            69: { name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡', category: 'KPI', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            70: { name: 'ãã®ä»–å£²ä¸Šæ¯”ç‡', category: 'KPI', inputStyle: 'A.ãã®ã¾ã¾å…¥åŠ›' },
            // === è¿½åŠ é›†è¨ˆé …ç›® ===
            74: { name: 'çµŒå¸¸åˆ©ç›Š', category: 'åˆ©ç›Š', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' },
            75: { name: 'é™ç•Œåˆ©ç›Š', category: 'é›†è¨ˆ', inputStyle: 'C.è‡ªå‹•æ¼”ç®—' }
        };

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function fmt(n) { return n !== undefined && n !== null ? Math.round(n).toLocaleString('ja-JP') : '-'; }
        // å††å˜ä½è¡¨ç¤ºï¼ˆå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã¯åƒå††å˜ä½ãªã®ã§Ã—1000ã—ã¦è¡¨ç¤ºï¼‰
        function fmtYen(n) { return n !== undefined && n !== null ? Math.round(n * 1000).toLocaleString('ja-JP') : '-'; }
        function fmtRate(n) { return n !== undefined && n !== null ? n.toFixed(1) : '-'; }

        function addLog(msg, type) {
            var cssClass = 'log-' + (type || 'info');
            var prefix = { info: '[INFO] ', warn: '[WARN] ', error: '[ERROR] ', success: '[OK] ', data: '  â†’ ', month: '[æœˆ] ' }[type] || '';
            preprocessLog.push('<span class="' + cssClass + '">' + prefix + escapeHtml(msg) + '</span>');
        }

        function escapeHtml(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ/äºˆç®—è¨­å®š/äºˆç®—è©¦ç®—/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰åˆ‡ã‚Šæ›¿ãˆ
        function showMainPage(page) {
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.main-nav-tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            // ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.main-page').forEach(function(p) {
                p.classList.remove('active');
            });
            // é¸æŠã—ãŸã‚¿ãƒ–ã¨ãƒšãƒ¼ã‚¸ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (page === 'import') {
                document.querySelector('.import-tab').classList.add('active');
                document.getElementById('page-import').classList.add('active');
            } else if (page === 'budget') {
                document.querySelector('.budget-tab').classList.add('active');
                document.getElementById('page-budget').classList.add('active');
            } else if (page === 'simulation') {
                document.querySelector('.simulation-tab').classList.add('active');
                document.getElementById('page-simulation').classList.add('active');
                // â˜… ç¾åœ¨ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰äºˆç®—è©¦ç®—ã‚¿ãƒ–ã‚’è¡¨ç¤ºï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’é€£å‹•ï¼‰
                if (typeof saveCurrentStoreData === 'function' && currentStoreName) {
                    saveCurrentStoreData();
                }
                if (typeof updateSimulationStoreSelect === 'function') {
                    updateSimulationStoreSelect();
                }
                // â˜… ç¾åœ¨ã®åº—èˆ—ãŒã‚ã‚Œã°è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¿ãƒ–ã¨ã®é€£å‹•ç¢ºä¿ï¼‰
                var simSelect = document.getElementById('simulationStoreSelect');
                if (simSelect && currentStoreName && allStoresData[currentStoreName]) {
                    simSelect.value = currentStoreName;
                    if (typeof loadSimulationData === 'function') {
                        loadSimulationData();
                    }
                }
            } else if (page === 'export') {
                document.querySelector('.export-tab').classList.add('active');
                document.getElementById('page-export').classList.add('active');
            }
        }

        // â˜…â˜…â˜… ã‚µãƒ–ã‚¿ãƒ–åˆ‡æ›¿é–¢æ•°ï¼ˆæ—©æœŸå®šç¾©ï¼‰ â˜…â˜…â˜…
        function switchImportSubtab(tabName) {
            // ã‚µãƒ–ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.import-subtabs .subtab').forEach(function(btn) {
                btn.classList.remove('active');
            });
            var activeBtn = document.querySelector('.import-subtabs .subtab[onclick*="' + tabName + '"]');
            if (activeBtn) activeBtn.classList.add('active');

            // ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’æ›´æ–°
            document.querySelectorAll('.import-subtab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            var targetContent = document.getElementById('import-subtab-' + tabName);
            if (targetContent) targetContent.classList.add('active');

            // è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¿ãƒ–è¡¨ç¤ºæ™‚ã«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            if (tabName === 'settings') {
                if (typeof updateCurrentStoreList === 'function') updateCurrentStoreList();
                if (typeof updateCurrentMappingList === 'function') updateCurrentMappingList();
                if (typeof renderMappingCategoryFilter === 'function') renderMappingCategoryFilter();
            }

            // ãƒã‚¹ã‚¿è¨­å®šã‚¿ãƒ–è¡¨ç¤ºæ™‚ã®å‡¦ç†
            if (tabName === 'master') {
                // ãƒã‚¹ã‚¿è¨­å®šã‚¿ãƒ–åˆæœŸåŒ–ï¼ˆä¸€è¦§ã¯å„ç·¨é›†ãƒœã‚¿ãƒ³ã§è¡¨ç¤ºï¼‰
                console.log('ãƒã‚¹ã‚¿è¨­å®šã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
            }

            // å–è¾¼å±¥æ­´ã‚¿ãƒ–è¡¨ç¤ºæ™‚ã®å‡¦ç†
            if (tabName === 'history') {
                updateBudgetHistoryCount();
                updateHistoryStoreFilter();
                renderBudgetHistoryList();
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            var zone = document.getElementById('dropZone');
            if (zone) zone.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            var zone = document.getElementById('dropZone');
            if (zone) zone.classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            var zone = document.getElementById('dropZone');
            if (zone) zone.classList.remove('drag-over');

            var files = event.dataTransfer.files;
            if (files.length > 0) {
                addFilesToSelection(Array.from(files));
            }
        }

        function handleFileSelect(event) {
            var newFiles = Array.from(event.target.files);
            if (newFiles.length > 0) {
                addFilesToSelection(newFiles);
            }
            // å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«ã™ã‚‹ï¼‰
            event.target.value = '';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠãƒªã‚¹ãƒˆã«è¿½åŠ 
        function addFilesToSelection(newFiles) {
            newFiles.forEach(function(newFile) {
                // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è¿½åŠ 
                if (!newFile.name.toLowerCase().endsWith('.csv')) {
                    showStatus('error', newFile.name + ' ã¯CSVãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                var exists = selectedFiles.some(function(f) { return f.name === newFile.name && f.size === newFile.size; });
                if (!exists) {
                    selectedFiles.push(newFile);
                }
            });
            updateFileListDisplay();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆç¸¦ç©ã¿ï¼‰
        function updateFileListDisplay() {
            var container = document.getElementById('fileListContainer');
            var listSection = document.getElementById('selectedFilesList');
            var fileCount = document.getElementById('fileCount');
            var dropZone = document.getElementById('dropZone');

            if (selectedFiles.length === 0) {
                listSection.style.display = 'none';
                dropZone.style.display = 'block';
                return;
            }

            listSection.style.display = 'block';
            dropZone.style.display = 'none';
            fileCount.textContent = selectedFiles.length;

            var html = '';
            selectedFiles.forEach(function(file, index) {
                html += '<div class="file-item">';
                html += '  <div class="file-info">';
                html += '    <span class="file-icon">ğŸ“„</span>';
                html += '    <span class="file-name" title="' + escapeHtml(file.name) + '">' + escapeHtml(file.name) + '</span>';
                html += '    <span class="file-size">' + formatFileSize(file.size) + '</span>';
                html += '  </div>';
                html += '  <button class="remove-btn" onclick="removeSelectedFile(' + index + ')">å‰Šé™¤</button>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        function removeSelectedFile(index) {
            selectedFiles.splice(index, 1);
            updateFileListDisplay();
        }

        // é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
        function clearSelectedFiles() {
            selectedFiles = [];
            updateFileListDisplay();
        }

        // =====================
        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§æ©Ÿèƒ½
        // =====================

        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
        function showDataHistoryPage() {
            document.getElementById('dataHistoryPage').style.display = 'block';
            document.body.style.overflow = 'hidden'; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ–
            renderDataHistoryList();
            renderSavedHistoryList();
        }

        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’éè¡¨ç¤º
        function hideDataHistoryPage() {
            document.getElementById('dataHistoryPage').style.display = 'none';
            document.body.style.overflow = ''; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ–
        }

        // å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ã‚’æç”»
        function renderDataHistoryList() {
            var container = document.getElementById('dataHistoryList');
            var storeNames = Object.keys(allStoresData);

            if (storeNames.length === 0) {
                container.innerHTML = '<div class="empty-message" style="background:#fff;border-radius:10px;padding:50px;">å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }

            var html = '';
            storeNames.forEach(function(name) {
                var data = allStoresData[name];
                var totalSales = 0;
                var totalProfit = 0;
                var monthCount = 0;
                if (data.mqOutputs) {
                    for (var m = 0; m < 12; m++) {
                        if (data.mqOutputs[m]) {
                            totalSales += data.mqOutputs[m].sales || 0;
                            totalProfit += data.mqOutputs[m].operatingProfit || 0;
                            monthCount++;
                        }
                    }
                }
                var profitRate = totalSales > 0 ? (totalProfit / totalSales * 100).toFixed(1) : 0;

                html += '<div class="history-data-item">';
                html += '  <div class="item-info">';
                html += '    <div class="item-name">ğŸª ' + escapeHtml(name) + '</div>';
                html += '    <div class="item-meta">';
                html += '      <span>ğŸ“… ' + monthCount + 'ãƒ¶æœˆåˆ†</span>';
                html += '      <span>ğŸ’° å¹´é–“å£²ä¸Š: ' + fmtYen(totalSales) + 'å††</span>';
                html += '      <span>ğŸ“ˆ å–¶æ¥­åˆ©ç›Š: ' + fmtYen(totalProfit) + 'å†† (' + profitRate + '%)</span>';
                html += '    </div>';
                html += '  </div>';
                html += '  <div class="item-actions">';
                html += '    <button class="btn-view" onclick="viewAndCloseHistory(\'' + escapeJs(name) + '\')">è¡¨ç¤º</button>';
                html += '    <button class="btn-save" onclick="saveStoreWithDateTime(\'' + escapeJs(name) + '\')">ä¿å­˜</button>';
                html += '    <button class="btn-delete" onclick="deleteStoreFromHistory(\'' + escapeJs(name) + '\')">å‰Šé™¤</button>';
                html += '  </div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // ä¿å­˜æ¸ˆã¿å±¥æ­´ä¸€è¦§ã‚’æç”»
        function renderSavedHistoryList() {
            var container = document.getElementById('savedHistoryList');
            if (!container) return;

            var history = loadHistory();

            if (history.length === 0) {
                container.innerHTML = '<div class="empty-message" style="background:#fff;border-radius:10px;padding:30px;">ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>ã€ŒğŸ’¾ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã€ã§ä¿å­˜ã§ãã¾ã™ã€‚</div>';
                return;
            }

            var html = '';
            history.forEach(function(entry) {
                html += '<div class="history-data-item" style="border-left:4px solid #7b1fa2;">';
                html += '  <div class="item-info">';
                html += '    <div class="item-name" style="color:#7b1fa2;">ğŸ’¾ ' + escapeHtml(entry.title) + '</div>';
                html += '    <div class="item-meta">';
                html += '      <span>ğŸ“… ä¿å­˜æ—¥æ™‚: ' + new Date(entry.savedAt).toLocaleString('ja-JP') + '</span>';
                html += '      <span>ğŸª ' + entry.storeCount + 'åº—èˆ—</span>';
                if (entry.storeNames && entry.storeNames.length > 0) {
                    html += '      <span>(' + entry.storeNames.slice(0, 2).join(', ');
                    if (entry.storeNames.length > 2) html += ' ä»–' + (entry.storeNames.length - 2) + 'åº—èˆ—';
                    html += ')</span>';
                }
                html += '    </div>';
                html += '  </div>';
                html += '  <div class="item-actions">';
                html += '    <button class="btn" style="background:#1565c0;color:#fff;padding:8px 16px;margin-right:5px;" onclick="previewSavedHistory(\'' + entry.id + '\')">ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>';
                html += '    <button class="btn-view" onclick="loadFromHistoryAndClose(\'' + entry.id + '\')">èª­ã¿è¾¼ã¿</button>';
                html += '    <button class="btn-delete" onclick="deleteFromHistoryAndRefresh(\'' + entry.id + '\')">å‰Šé™¤</button>';
                html += '  </div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ç”»é¢ã‚’é–‰ã˜ã‚‹
        function loadFromHistoryAndClose(id) {
            loadFromHistory(id);
            hideDataHistoryPage();
        }

        // å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ãƒªã‚¹ãƒˆæ›´æ–°
        function deleteFromHistoryAndRefresh(id) {
            deleteFromHistory(id);
            renderSavedHistoryList();
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®å±¥æ­´ID
        var previewingHistoryId = null;

        // ä¿å­˜æ¸ˆã¿å±¥æ­´ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewSavedHistory(id) {
            var history = loadHistory();
            var entry = history.find(function(h) { return h.id === id; });
            if (!entry) {
                alert('å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            previewingHistoryId = id;

            // ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
            document.getElementById('previewTitle').textContent = entry.title;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’æ§‹ç¯‰
            var html = '';

            // åº—èˆ—ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            Object.keys(entry.data).forEach(function(storeName, storeIndex) {
                var storeData = entry.data[storeName];
                html += '<div style="margin-bottom:25px;background:#f8f9fa;border-radius:8px;padding:15px;border:1px solid #e0e0e0;">';
                html += '<h4 style="margin:0 0 15px 0;color:#333;font-size:16px;border-bottom:2px solid #1565c0;padding-bottom:10px;">ğŸª ' + escapeHtml(storeName) + '</h4>';

                // ãƒãƒƒãƒæ¸ˆã¿é …ç›®ã®è¡¨ç¤º
                if (storeData.matchedItems && storeData.matchedItems.length > 0) {
                    html += '<div style="margin-bottom:15px;">';
                    html += '<h5 style="margin:0 0 10px 0;color:#28a745;font-size:13px;">âœ… ãƒãƒƒãƒæ¸ˆã¿é …ç›®ï¼ˆ' + storeData.matchedItems.length + 'ä»¶ï¼‰</h5>';
                    html += '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
                    html += '<thead><tr style="background:#e8f5e9;">';
                    html += '<th style="padding:6px;border:1px solid #c8e6c9;text-align:left;">é …ç›®å</th>';
                    html += '<th style="padding:6px;border:1px solid #c8e6c9;text-align:left;">ã‚³ãƒ¼ãƒ‰</th>';
                    html += '<th style="padding:6px;border:1px solid #c8e6c9;text-align:right;">å¹´é–“åˆè¨ˆ</th>';
                    html += '</tr></thead><tbody>';

                    storeData.matchedItems.slice(0, 15).forEach(function(item) {
                        // å¹´é–“åˆè¨ˆã‚’è¨ˆç®—
                        var yearTotal = 0;
                        if (storeData.annualData && storeData.annualData[item.name]) {
                            var itemData = storeData.annualData[item.name];
                            for (var m = 0; m < 12; m++) {
                                yearTotal += (itemData[m] || 0);
                            }
                        }
                        html += '<tr>';
                        html += '<td style="padding:5px;border:1px solid #e0e0e0;">' + escapeHtml(item.name) + '</td>';
                        html += '<td style="padding:5px;border:1px solid #e0e0e0;">' + escapeHtml(item.code || '-') + '</td>';
                        html += '<td style="padding:5px;border:1px solid #e0e0e0;text-align:right;">' + formatNumber(yearTotal) + '</td>';
                        html += '</tr>';
                    });
                    if (storeData.matchedItems.length > 15) {
                        html += '<tr><td colspan="3" style="padding:5px;text-align:center;color:#888;">ä»– ' + (storeData.matchedItems.length - 15) + ' ä»¶...</td></tr>';
                    }
                    html += '</tbody></table>';
                    html += '</div>';
                }

                // ã‚¢ãƒ³ãƒãƒƒãƒé …ç›®ã®è¡¨ç¤º
                if (storeData.unmatchedItems && storeData.unmatchedItems.length > 0) {
                    html += '<div style="margin-bottom:15px;">';
                    html += '<h5 style="margin:0 0 10px 0;color:#dc3545;font-size:13px;">âŒ æœªãƒãƒƒãƒé …ç›®ï¼ˆ' + storeData.unmatchedItems.length + 'ä»¶ï¼‰</h5>';
                    html += '<div style="display:flex;flex-wrap:wrap;gap:5px;">';
                    storeData.unmatchedItems.slice(0, 10).forEach(function(item) {
                        html += '<span style="background:#f8d7da;color:#721c24;padding:3px 8px;border-radius:4px;font-size:10px;">' + escapeHtml(item.name) + '</span>';
                    });
                    if (storeData.unmatchedItems.length > 10) {
                        html += '<span style="background:#f8d7da;color:#721c24;padding:3px 8px;border-radius:4px;font-size:10px;">ä»– ' + (storeData.unmatchedItems.length - 10) + ' ä»¶...</span>';
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºï¼ˆä¸»è¦é …ç›®ï¼‰
                if (storeData.annualData && Object.keys(storeData.annualData).length > 0) {
                    var months = storeData.monthLabels || FISCAL_ORDER;
                    html += '<div>';
                    html += '<h5 style="margin:0 0 10px 0;color:#1565c0;font-size:13px;">ğŸ“Š æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸»è¦é …ç›®ï¼‰</h5>';
                    html += '<div style="overflow-x:auto;">';
                    html += '<table style="width:100%;border-collapse:collapse;font-size:10px;min-width:800px;">';
                    html += '<thead><tr style="background:#e3f2fd;">';
                    html += '<th style="padding:5px;border:1px solid #bbdefb;text-align:left;min-width:120px;">é …ç›®</th>';
                    months.forEach(function(m) {
                        html += '<th style="padding:5px;border:1px solid #bbdefb;text-align:right;width:65px;">' + m + '</th>';
                    });
                    html += '<th style="padding:5px;border:1px solid #bbdefb;text-align:right;width:80px;background:#fff3e0;">å¹´è¨ˆ</th>';
                    html += '</tr></thead><tbody>';

                    // ä¸»è¦é …ç›®ã‚’è¡¨ç¤ºï¼ˆæœ€å¤§10é …ç›®ï¼‰
                    var displayItems = Object.keys(storeData.annualData).slice(0, 10);
                    displayItems.forEach(function(itemName) {
                        var values = storeData.annualData[itemName];
                        var total = 0;
                        html += '<tr>';
                        html += '<td style="padding:4px;border:1px solid #e0e0e0;font-weight:bold;">' + escapeHtml(itemName) + '</td>';
                        for (var m = 0; m < 12; m++) {
                            var val = values[m] || 0;
                            total += val;
                            html += '<td style="padding:4px;border:1px solid #e0e0e0;text-align:right;">' + formatNumber(val) + '</td>';
                        }
                        html += '<td style="padding:4px;border:1px solid #e0e0e0;text-align:right;background:#fff8e1;font-weight:bold;">' + formatNumber(total) + '</td>';
                        html += '</tr>';
                    });
                    if (Object.keys(storeData.annualData).length > 10) {
                        html += '<tr><td colspan="14" style="padding:5px;text-align:center;color:#888;">ä»– ' + (Object.keys(storeData.annualData).length - 10) + ' é …ç›®...</td></tr>';
                    }
                    html += '</tbody></table>';
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
            });

            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('savedHistoryPreview').style.display = 'block';

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('savedHistoryPreview').scrollIntoView({ behavior: 'smooth' });
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadPreviewedData() {
            if (previewingHistoryId) {
                loadFromHistoryAndClose(previewingHistoryId);
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeHistoryPreview() {
            document.getElementById('savedHistoryPreview').style.display = 'none';
            previewingHistoryId = null;
        }

        // JavaScriptç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeJs(str) {
            return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // è¡¨ç¤ºã—ã¦å±¥æ­´ç”»é¢ã‚’é–‰ã˜ã‚‹
        function viewAndCloseHistory(name) {
            hideDataHistoryPage();
            switchStore(name);
        }

        // å¹´æœˆæ—¥æ™‚åˆ»_åº—å å½¢å¼ã§ä¿å­˜
        function saveStoreWithDateTime(name) {
            if (!allStoresData[name]) {
                alert('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            var sec = ('0' + now.getSeconds()).slice(-2);
            var saveName = y + m + d + h + min + sec + '_' + name;

            var history = loadHistory();

            var newEntry = {
                id: Date.now().toString(),
                title: saveName,
                dateTime: y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec,
                storeNames: [name],
                storeCount: 1,
                data: { [name]: JSON.parse(JSON.stringify(allStoresData[name])) },
                savedAt: now.toISOString()
            };

            history.unshift(newEntry);
            if (history.length > 50) history = history.slice(0, 50);

            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                showStatus('success', 'ä¿å­˜ã—ã¾ã—ãŸ: ' + saveName);
                renderSavedHistoryList();
                alert('ä¿å­˜å®Œäº†: ' + saveName);
            } catch (e) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            }
        }

        // å±¥æ­´ç”»é¢ã‹ã‚‰åº—èˆ—ã‚’å‰Šé™¤
        function deleteStoreFromHistory(name) {
            if (!confirm('ã€Œ' + name + 'ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            delete allStoresData[name];

            if (currentStoreName === name) {
                var remaining = Object.keys(allStoresData);
                if (remaining.length > 0) {
                    switchStore(remaining[0]);
                } else {
                    currentStoreName = '';
                }
            }

            updateStoreSelector();
            updateDataCounts();
            renderDataHistoryList();
            showStatus('info', 'ã€Œ' + name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’æ›´æ–°
        function updateDataCounts() {
            var count = Object.keys(allStoresData).length;
            document.getElementById('importedStoreCount').textContent = count;
            updateExportStoreSelect(); // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨åº—èˆ—ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
        }

        // ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ç®¡ç† =====
        var EXPORT_HISTORY_KEY = 'rakumy_export_history';
        var exportHistory = [];

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
        function showExportHistoryPage() {
            document.getElementById('exportHistoryPage').style.display = 'block';
            document.body.style.overflow = 'hidden';
            renderExportHistoryList();
        }

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ç”»é¢ã‚’éè¡¨ç¤º
        function hideExportHistoryPage() {
            document.getElementById('exportHistoryPage').style.display = 'none';
            document.body.style.overflow = '';
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨åº—èˆ—é¸æŠãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateExportStoreSelect() {
            var select = document.getElementById('exportStoreSelect');
            if (!select) return;

            var storeNames = Object.keys(allStoresData);
            var currentValue = select.value;

            select.innerHTML = '<option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>';
            storeNames.forEach(function(name) {
                var opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });

            if (storeNames.indexOf(currentValue) >= 0) {
                select.value = currentValue;
            }

            updateExportSelectedCount();
        }

        // åº—èˆ—é¸æŠå¤‰æ›´æ™‚
        function updateExportStoreSelection() {
            document.getElementById('exportAllStores').checked = false;
            updateExportSelectedCount();
        }

        // å…¨åº—èˆ—é¸æŠãƒˆã‚°ãƒ«
        function toggleExportAllStores() {
            var checkbox = document.getElementById('exportAllStores');
            var select = document.getElementById('exportStoreSelect');
            if (checkbox.checked) {
                select.value = '';
            }
            updateExportSelectedCount();
        }

        // é¸æŠåº—èˆ—æ•°ã‚’æ›´æ–°
        function updateExportSelectedCount() {
            var checkbox = document.getElementById('exportAllStores');
            var select = document.getElementById('exportStoreSelect');
            var countSpan = document.getElementById('exportSelectedCount');

            var count = 0;
            if (checkbox && checkbox.checked) {
                count = Object.keys(allStoresData).length;
            } else if (select && select.value) {
                count = 1;
            }

            if (countSpan) {
                countSpan.textContent = 'é¸æŠä¸­: ' + count + 'åº—èˆ—';
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡åº—èˆ—ã‚’å–å¾—
        function getExportTargetStores() {
            var checkbox = document.getElementById('exportAllStores');
            var select = document.getElementById('exportStoreSelect');

            if (checkbox && checkbox.checked) {
                return Object.keys(allStoresData);
            } else if (select && select.value) {
                return [select.value];
            } else if (currentStoreName) {
                return [currentStoreName];
            }
            return Object.keys(allStoresData);
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadExportHistory() {
            try {
                var data = localStorage.getItem(EXPORT_HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                return [];
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ã‚’ä¿å­˜
        function saveExportHistory(history) {
            try {
                localStorage.setItem(EXPORT_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('Export history save failed:', e);
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¥æ­´ã«è¿½åŠ 
        function addToExportHistory(exportType, storeNames, data) {
            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            var sec = ('0' + now.getSeconds()).slice(-2);

            var storeName = storeNames.length === 1 ? storeNames[0] : storeNames.length + 'åº—èˆ—';
            var saveName = y + m + d + h + min + sec + '_' + storeName + '_' + exportType;

            var history = loadExportHistory();

            var entry = {
                id: Date.now().toString(),
                title: saveName,
                exportType: exportType,
                storeNames: storeNames,
                storeCount: storeNames.length,
                dateTime: y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec,
                data: data,
                savedAt: now.toISOString()
            };

            history.unshift(entry);
            if (history.length > 100) history = history.slice(0, 100);

            saveExportHistory(history);
            updateExportHistoryCount();
            return saveName;
        }

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä»¶æ•°ã‚’æ›´æ–°
        function updateExportHistoryCount() {
            var history = loadExportHistory();
            var countSpan = document.getElementById('exportHistoryCount');
            if (countSpan) {
                countSpan.textContent = history.length;
            }
        }

        // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ä¸€è¦§ã‚’æç”»
        function renderExportHistoryList() {
            var container = document.getElementById('exportHistoryList');
            var history = loadExportHistory();

            if (history.length === 0) {
                container.innerHTML = '<div class="empty-message" style="background:#fff;border-radius:10px;padding:50px;">å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã¨å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>';
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªå®šç¾©
            var categories = [
                { key: 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV', label: 'ğŸ“Š ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV', color: '#4caf50', bgColor: '#e8f5e9' },
                { key: 'äºˆç®—ä¸€è¦§CSV', label: 'ğŸ“‹ äºˆç®—ä¸€è¦§CSV', color: '#2196f3', bgColor: '#e3f2fd' },
                { key: 'MQå‡ºåŠ›CSV', label: 'ğŸ“ˆ MQå‡ºåŠ›CSV', color: '#9c27b0', bgColor: '#f3e5f5' },
                { key: 'è¨­å®šJSON', label: 'âš™ï¸ è¨­å®šJSON', color: '#607d8b', bgColor: '#eceff1' }
            ];

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            var grouped = {};
            categories.forEach(function(cat) { grouped[cat.key] = []; });
            history.forEach(function(entry) {
                if (grouped[entry.exportType]) {
                    grouped[entry.exportType].push(entry);
                }
            });

            var html = '';

            categories.forEach(function(cat) {
                var items = grouped[cat.key];
                if (items.length === 0) return;

                html += '<div class="export-category-section" style="margin-bottom:25px;">';
                html += '  <div class="export-category-header" style="display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:' + cat.bgColor + ';border-left:4px solid ' + cat.color + ';border-radius:8px;margin-bottom:12px;">';
                html += '    <h3 style="margin:0;font-size:16px;color:' + cat.color + ';">' + cat.label + '</h3>';
                html += '    <span style="background:' + cat.color + ';color:#fff;padding:4px 12px;border-radius:15px;font-size:12px;font-weight:bold;">' + items.length + 'ä»¶</span>';
                html += '  </div>';
                html += '  <div class="export-category-items" style="display:flex;flex-direction:column;gap:10px;">';

                items.forEach(function(entry) {
                    var storeInfo = entry.storeCount === 1 ? entry.storeNames[0] : entry.storeCount + 'åº—èˆ—';

                    html += '<div class="history-data-item" style="border-left:3px solid ' + cat.color + ';">';
                    html += '  <div class="item-info">';
                    html += '    <div class="item-name" style="color:' + cat.color + ';">' + escapeHtml(storeInfo) + '</div>';
                    html += '    <div class="item-meta">';
                    html += '      <span>ğŸ“… ' + entry.dateTime + '</span>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '  <div class="item-actions">';
                    html += '    <button class="btn-view" onclick="viewExportHistoryItem(\'' + entry.id + '\')">è¡¨ç¤º</button>';
                    html += '    <button class="btn-save" onclick="downloadExportHistoryItem(\'' + entry.id + '\')">ä¿å­˜</button>';
                    html += '    <button class="btn-delete" onclick="deleteExportHistoryItem(\'' + entry.id + '\')">å‰Šé™¤</button>';
                    html += '  </div>';
                    html += '</div>';
                });

                html += '  </div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // å±¥æ­´ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadExportHistoryItem(id) {
            var history = loadExportHistory();
            var entry = history.find(function(h) { return h.id === id; });
            if (!entry) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            var filename = entry.title;
            var data = entry.data;
            var mimeType = 'text/csv;charset=utf-8;';
            var ext = '.csv';

            if (entry.exportType === 'è¨­å®šJSON') {
                mimeType = 'application/json;charset=utf-8;';
                ext = '.json';
                data = JSON.stringify(entry.data, null, 2);
            }

            if (!filename.endsWith(ext)) {
                filename += ext;
            }

            var blob = new Blob([data], { type: mimeType });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        function viewExportHistoryItem(id) {
            var history = loadExportHistory();
            var entry = history.find(function(h) { return h.id === id; });
            if (!entry) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            showDataViewModal(entry);
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDataViewModal(entry) {
            var modal = document.getElementById('dataViewModal');
            var title = document.getElementById('dataViewTitle');
            var content = document.getElementById('dataViewContent');

            title.textContent = entry.title;

            // CSVãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            var data = entry.data || '';
            // BOMã‚’é™¤å»
            if (data.charCodeAt(0) === 0xFEFF) {
                data = data.substring(1);
            }
            var lines = data.split('\n');
            var html = '<table class="data-view-table">';
            var isFirstDataRow = true;
            lines.forEach(function(line) {
                if (!line.trim()) return;
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã€ã€‘ã§å§‹ã¾ã‚‹è¡Œï¼‰
                var trimmedLine = line.trim();
                if (trimmedLine.indexOf('ã€') === 0) return;
                // æœ€åˆã®ã‚»ãƒ«ãŒç©ºã§ã‚¿ã‚¤ãƒˆãƒ«ã£ã½ã„è¡Œã‚‚ã‚¹ã‚­ãƒƒãƒ—
                var cells = line.split(',');
                if (cells.length > 1 && !cells[0].trim() && cells[1].trim().indexOf('ã€') === 0) return;

                var tag = isFirstDataRow ? 'th' : 'td';
                html += '<tr>';
                cells.forEach(function(cell) {
                    html += '<' + tag + '>' + escapeHtml(cell) + '</' + tag + '>';
                });
                html += '</tr>';
                isFirstDataRow = false;
            });
            html += '</table>';

            content.innerHTML = html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function hideDataViewModal() {
            var modal = document.getElementById('dataViewModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        // å±¥æ­´ã‹ã‚‰å‰Šé™¤
        function deleteExportHistoryItem(id) {
            if (!confirm('ã“ã®å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            var history = loadExportHistory();
            history = history.filter(function(h) { return h.id !== id; });
            saveExportHistory(history);
            renderExportHistoryList();
            updateExportHistoryCount();
            showStatus('info', 'å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å…¨å±¥æ­´ã‚¯ãƒªã‚¢
        function clearAllExportHistory() {
            if (!confirm('å…¨ã¦ã®å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            saveExportHistory([]);
            renderExportHistoryList();
            updateExportHistoryCount();
            showStatus('info', 'å…¨ã¦ã®å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ===== å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´ç®¡ç† =====
        var BUDGET_HISTORY_KEY = 'rakumy_budget_history';

        // å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadBudgetHistory() {
            try {
                var data = localStorage.getItem(BUDGET_HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('Budget history load failed:', e);
                return [];
            }
        }

        // å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´ã‚’ä¿å­˜
        function saveBudgetHistory(history) {
            try {
                localStorage.setItem(BUDGET_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('Budget history save failed:', e);
            }
        }

        // å–ã‚Šè¾¼ã¿äºˆç®—ã‚’å±¥æ­´ã«è¿½åŠ 
        function addToBudgetHistory(storeName, storeData) {
            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            var sec = ('0' + now.getSeconds()).slice(-2);
            var dateTimeDisplay = y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec;

            var history = loadBudgetHistory();

            var entry = {
                id: Date.now().toString() + '_' + storeName.replace(/\s/g, '_'),
                storeName: storeName,
                dateTime: dateTimeDisplay,
                monthCount: (storeData.activeMonths || []).length,
                itemCount: (storeData.matchedItems || []).length,
                data: JSON.parse(JSON.stringify(storeData)),
                savedAt: now.toISOString()
            };

            history.unshift(entry);
            if (history.length > 50) history = history.slice(0, 50); // æœ€å¤§50ä»¶

            saveBudgetHistory(history);
            updateBudgetHistoryCount();
            updateHistoryStoreFilter();
        }

        // å±¥æ­´ä»¶æ•°ã‚’æ›´æ–°
        function updateBudgetHistoryCount() {
            var history = loadBudgetHistory();
            var countSpan = document.getElementById('historyCount');
            if (countSpan) {
                countSpan.textContent = 'å±¥æ­´: ' + history.length + 'ä»¶';
            }
        }

        // åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
        function updateHistoryStoreFilter() {
            var history = loadBudgetHistory();
            var select = document.getElementById('historyStoreFilter');
            if (!select) return;

            var stores = {};
            history.forEach(function(entry) {
                stores[entry.storeName] = true;
            });

            var html = '<option value="">å…¨ã¦ã®åº—èˆ—</option>';
            Object.keys(stores).sort().forEach(function(name) {
                html += '<option value="' + name + '">' + name + '</option>';
            });
            select.innerHTML = html;
        }

        // å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´ä¸€è¦§ã‚’æç”»
        function renderBudgetHistoryList() {
            var tbody = document.getElementById('budgetHistoryBody');
            if (!tbody) return;

            var history = loadBudgetHistory();
            var filter = document.getElementById('historyStoreFilter');
            var filterValue = filter ? filter.value : '';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            var filtered = filterValue
                ? history.filter(function(e) { return e.storeName === filterValue; })
                : history;

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">' +
                    (filterValue ? 'é¸æŠã—ãŸåº—èˆ—ã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' : 'å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>äºˆç®—CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨è‡ªå‹•çš„ã«å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚') +
                    '</td></tr>';
                return;
            }

            var html = '';
            filtered.forEach(function(entry, index) {
                html += '<tr style="border-bottom:1px solid #e0e0e0;">';
                html += '  <td style="padding:10px;font-weight:bold;color:#333;">' + entry.storeName + '</td>';
                html += '  <td style="padding:10px;text-align:center;color:#666;font-size:11px;">' + entry.dateTime + '</td>';
                html += '  <td style="padding:10px;text-align:center;">' + entry.monthCount + 'ãƒ¶æœˆ</td>';
                html += '  <td style="padding:10px;text-align:center;">' + entry.itemCount + 'é …ç›®</td>';
                html += '  <td style="padding:10px;text-align:center;">';
                html += '    <div style="display:flex;gap:5px;justify-content:center;flex-wrap:wrap;">';
                html += '      <button onclick="showBudgetPreview(\'' + entry.id + '\')" class="btn" style="padding:5px 10px;font-size:10px;background:#9c27b0;color:#fff;border:none;border-radius:3px;" title="äºˆç®—è¡¨ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">ğŸ“Š äºˆç®—è¡¨</button>';
                html += '      <button onclick="loadBudgetFromHistory(\'' + entry.id + '\')" class="btn" style="padding:5px 10px;font-size:10px;background:#4caf50;color:#fff;border:none;border-radius:3px;" title="ã“ã®å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§äºˆç®—è¨­å®šç”»é¢ã§è¡¨ç¤ºãƒ»ç·¨é›†">ğŸ“‚ èª­è¾¼</button>';
                html += '      <button onclick="archiveBudgetHistory(\'' + entry.id + '\')" class="btn" style="padding:5px 10px;font-size:10px;background:#ff9800;color:#fff;border:none;border-radius:3px;" title="JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">ğŸ“¦ ä¿å­˜</button>';
                html += '      <button onclick="showHistoryDetail(\'' + entry.id + '\')" class="btn" style="padding:5px 10px;font-size:10px;background:#2196f3;color:#fff;border:none;border-radius:3px;" title="å±¥æ­´ã®è©³ç´°ã‚’ç¢ºèª">ğŸ‘ï¸ è©³ç´°</button>';
                html += '      <button onclick="deleteBudgetHistory(\'' + entry.id + '\')" class="btn" style="padding:5px 10px;font-size:10px;background:#f44336;color:#fff;border:none;border-radius:3px;" title="ã“ã®å±¥æ­´ã‚’å‰Šé™¤">ğŸ—‘ï¸</button>';
                html += '    </div>';
                html += '  </td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;
        }

        // å±¥æ­´ã‹ã‚‰äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰
        function loadBudgetFromHistory(historyId) {
            var history = loadBudgetHistory();
            var entry = history.find(function(e) { return e.id === historyId; });
            if (!entry) {
                showStatus('error', 'å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!confirm('ã€Œ' + entry.storeName + 'ã€ï¼ˆ' + entry.dateTime + 'ï¼‰ã®äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n\nèª­ã¿è¾¼ã‚€ã¨äºˆç®—è¨­å®šç”»é¢ã§ç·¨é›†ãƒ»ç¢ºèªã§ãã¾ã™ã€‚')) {
                return;
            }

            var storeData = entry.data;

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«å¾©å…ƒ
            storeName = entry.storeName;
            currentStoreName = entry.storeName;
            annualData = storeData.annualData || {};
            calcResults = storeData.calcResults || {};
            rakumyInputs = storeData.rakumyInputs || {};
            mqOutputs = storeData.mqOutputs || {};
            judgments = storeData.judgments || {};
            matchedItems = storeData.matchedItems || [];
            unmatchedItems = storeData.unmatchedItems || [];
            activeMonths = storeData.activeMonths || [];
            monthLabels = storeData.monthLabels || [];
            budgetColumnPositions = storeData.budgetColumnPositions || {};
            monthDetectionResults = storeData.monthDetectionResults || {};

            // allStoresDataã«ã‚‚ä¿å­˜
            allStoresData[entry.storeName] = JSON.parse(JSON.stringify(storeData));

            // å„ç¨®ç”»é¢ã‚’æ›´æ–°
            renderAllStoresSummary();
            renderInputTable();
            renderRakumyInputTable();
            renderAllTables();

            // MQè¨ˆç®—ã‚’å®Ÿè¡Œ
            executeCalcRules();
            generateRakumyInputs();
            runMQSimulation();
            saveCurrentStoreData();

            // äºˆç®—è¨­å®šç”»é¢ã«é·ç§»
            showMainPage('budget');

            showStatus('success', 'ã€Œ' + entry.storeName + 'ã€ã®äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚äºˆç®—è¨­å®šç”»é¢ã§ç·¨é›†ã§ãã¾ã™ã€‚');
        }

        // å±¥æ­´è©³ç´°ã‚’è¡¨ç¤º
        function showHistoryDetail(historyId) {
            var history = loadBudgetHistory();
            var entry = history.find(function(e) { return e.id === historyId; });
            if (!entry) return;

            var preview = document.getElementById('historyDetailPreview');
            var content = document.getElementById('historyDetailContent');
            if (!preview || !content) return;

            var storeData = entry.data;
            var html = '<table style="width:100%;font-size:11px;border-collapse:collapse;">';
            html += '<tr><td style="padding:5px;border-bottom:1px solid #ddd;font-weight:bold;width:120px;">åº—èˆ—å</td><td style="padding:5px;border-bottom:1px solid #ddd;">' + entry.storeName + '</td></tr>';
            html += '<tr><td style="padding:5px;border-bottom:1px solid #ddd;font-weight:bold;">å–è¾¼æ—¥æ™‚</td><td style="padding:5px;border-bottom:1px solid #ddd;">' + entry.dateTime + '</td></tr>';
            html += '<tr><td style="padding:5px;border-bottom:1px solid #ddd;font-weight:bold;">å¯¾è±¡æœˆ</td><td style="padding:5px;border-bottom:1px solid #ddd;">' + (storeData.monthLabels || []).join(', ') + '</td></tr>';
            html += '<tr><td style="padding:5px;border-bottom:1px solid #ddd;font-weight:bold;">ãƒãƒƒãƒé …ç›®</td><td style="padding:5px;border-bottom:1px solid #ddd;">' + (storeData.matchedItems || []).length + 'é …ç›®</td></tr>';
            html += '<tr><td style="padding:5px;border-bottom:1px solid #ddd;font-weight:bold;">æœªãƒãƒƒãƒé …ç›®</td><td style="padding:5px;border-bottom:1px solid #ddd;">' + (storeData.unmatchedItems || []).length + 'é …ç›®</td></tr>';

            // ä¸»è¦æŒ‡æ¨™ã®ã‚µãƒãƒªãƒ¼
            if (storeData.mqOutputs && Object.keys(storeData.mqOutputs).length > 0) {
                var totalSales = 0, totalProfit = 0;
                for (var m in storeData.mqOutputs) {
                    if (storeData.mqOutputs[m]) {
                        totalSales += storeData.mqOutputs[m].sales || 0;
                        totalProfit += storeData.mqOutputs[m].operatingProfit || 0;
                    }
                }
                html += '<tr><td style="padding:5px;border-bottom:1px solid #ddd;font-weight:bold;">å¹´é–“å£²ä¸Š</td><td style="padding:5px;border-bottom:1px solid #ddd;">' + Math.round(totalSales).toLocaleString() + 'å††</td></tr>';
                html += '<tr><td style="padding:5px;font-weight:bold;">å¹´é–“å–¶æ¥­åˆ©ç›Š</td><td style="padding:5px;">' + Math.round(totalProfit).toLocaleString() + 'å††</td></tr>';
            }
            html += '</table>';

            content.innerHTML = html;
            preview.style.display = 'block';
        }

        // äºˆç®—è¡¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showBudgetPreview(historyId) {
            var history = loadBudgetHistory();
            var entry = history.find(function(e) { return e.id === historyId; });
            if (!entry) {
                showStatus('error', 'å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            var storeData = entry.data;
            var modal = document.getElementById('budgetPreviewModal');
            var title = document.getElementById('budgetPreviewTitle');
            var info = document.getElementById('budgetPreviewInfo');
            var thead = document.getElementById('budgetPreviewHead');
            var tbody = document.getElementById('budgetPreviewBody');

            if (!modal || !thead || !tbody) return;

            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            title.textContent = 'ğŸ“Š äºˆç®—è¡¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - ' + entry.storeName;

            // åº—èˆ—æƒ…å ±
            info.innerHTML = '<strong>åº—èˆ—:</strong> ' + entry.storeName +
                ' | <strong>å–è¾¼æ—¥æ™‚:</strong> ' + entry.dateTime +
                ' | <strong>å¯¾è±¡æœˆ:</strong> ' + (storeData.monthLabels || []).join(', ') +
                ' | <strong>é …ç›®æ•°:</strong> ' + (storeData.matchedItems || []).length + 'é …ç›®';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç”Ÿæˆ
            var monthLabels = storeData.monthLabels || [];
            var headerHtml = '<tr style="background:#9c27b0;color:#fff;">';
            headerHtml += '<th style="padding:8px;text-align:left;min-width:50px;position:sticky;left:0;background:#9c27b0;">No</th>';
            headerHtml += '<th style="padding:8px;text-align:left;min-width:120px;">ã‚«ãƒ†ã‚´ãƒª</th>';
            headerHtml += '<th style="padding:8px;text-align:left;min-width:150px;">é …ç›®å</th>';
            for (var i = 0; i < monthLabels.length; i++) {
                headerHtml += '<th style="padding:8px;text-align:right;min-width:80px;">' + monthLabels[i] + '</th>';
            }
            headerHtml += '<th style="padding:8px;text-align:right;min-width:90px;background:#7b1fa2;">åˆè¨ˆ</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // ãƒœãƒ‡ã‚£è¡Œã‚’ç”Ÿæˆ
            var matchedItems = storeData.matchedItems || [];
            var annualData = storeData.annualData || {};
            var activeMonths = storeData.activeMonths || [];
            var bodyHtml = '';

            // ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
            var categories = {};
            matchedItems.forEach(function(item) {
                var cat = item.category || 'æœªåˆ†é¡';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(item);
            });

            var rowNum = 1;
            var categoryColors = {
                'å£²ä¸Šé«˜': '#e8f5e9',
                'å£²ä¸ŠåŸä¾¡': '#fff3e0',
                'äººä»¶è²»': '#e3f2fd',
                'æ°´é“å…‰ç†±è²»': '#fce4ec',
                'è²©ä¿ƒè²»': '#f3e5f5',
                'åº—èˆ—é‹å–¶è²»': '#e0f7fa',
                'ç®¡ç†è²»': '#eceff1',
                'æ•™è‚²ãƒ»æ¡ç”¨è²»': '#efebe9',
                'ITãƒ»å¤–æ³¨è²»': '#e8eaf6',
                'å›ºå®šè²»': '#ffebee',
                'æç›Š': '#f1f8e9'
            };

            for (var cat in categories) {
                var items = categories[cat];
                var bgColor = categoryColors[cat] || '#fafafa';

                items.forEach(function(item, idx) {
                    // rowDataã¯ item.rowData ã«ç›´æ¥æ ¼ç´ã•ã‚Œã¦ã„ã‚‹
                    // ã¾ãŸã¯ annualData[v15No] ã«ã‚ã‚‹
                    var v15No = item.v15No;
                    var rowData = item.rowData || annualData[v15No] || {};

                    bodyHtml += '<tr style="background:' + (idx % 2 === 0 ? bgColor : '#fff') + ';border-bottom:1px solid #e0e0e0;">';
                    bodyHtml += '<td style="padding:6px;text-align:center;font-size:10px;color:#666;">' + rowNum + '</td>';
                    bodyHtml += '<td style="padding:6px;font-size:10px;color:#7b1fa2;">' + cat + '</td>';
                    bodyHtml += '<td style="padding:6px;font-weight:bold;">' + item.name + '</td>';

                    var total = 0;
                    for (var m = 0; m < activeMonths.length; m++) {
                        // rowDataã®ã‚­ãƒ¼ã¯æœˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(0,1,2...)
                        var val = rowData[m] || 0;
                        total += val;
                        bodyHtml += '<td style="padding:6px;text-align:right;">' + (val ? Math.round(val).toLocaleString() : '-') + '</td>';
                    }
                    bodyHtml += '<td style="padding:6px;text-align:right;font-weight:bold;background:#f3e5f5;">' + Math.round(total).toLocaleString() + '</td>';
                    bodyHtml += '</tr>';
                    rowNum++;
                });
            }

            tbody.innerHTML = bodyHtml || '<tr><td colspan="' + (monthLabels.length + 4) + '" style="text-align:center;padding:30px;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // äºˆç®—è¡¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function hideBudgetPreviewModal() {
            var modal = document.getElementById('budgetPreviewModal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        // å±¥æ­´ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¿å­˜
        function archiveBudgetHistory(historyId) {
            var history = loadBudgetHistory();
            var entry = history.find(function(e) { return e.id === historyId; });
            if (!entry) {
                showStatus('error', 'å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
            var dateStr = entry.dateTime.replace(/[:\s]/g, '_');
            var fileName = 'budget_archive_' + entry.storeName.replace(/\s/g, '_') + '_' + dateStr + '.json';

            // JSONãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            var archiveData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                storeName: entry.storeName,
                importedAt: entry.dateTime,
                monthCount: entry.monthCount,
                itemCount: entry.itemCount,
                data: entry.data
            };

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            var blob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showStatus('success', 'ã€Œ' + entry.storeName + 'ã€ã®äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å±¥æ­´ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importBudgetArchive(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var archiveData = JSON.parse(e.target.result);

                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!archiveData.storeName || !archiveData.data) {
                        showStatus('error', 'ç„¡åŠ¹ãªã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                        return;
                    }

                    // å±¥æ­´ã«è¿½åŠ 
                    var history = loadBudgetHistory();

                    var entry = {
                        id: Date.now().toString() + '_imported_' + archiveData.storeName.replace(/\s/g, '_'),
                        storeName: archiveData.storeName,
                        dateTime: archiveData.importedAt || new Date().toISOString().slice(0, 19).replace('T', ' '),
                        monthCount: archiveData.monthCount || (archiveData.data.activeMonths || []).length,
                        itemCount: archiveData.itemCount || (archiveData.data.matchedItems || []).length,
                        data: archiveData.data,
                        savedAt: new Date().toISOString(),
                        importedFrom: file.name
                    };

                    history.unshift(entry);
                    if (history.length > 50) history = history.slice(0, 50);

                    saveBudgetHistory(history);
                    renderBudgetHistoryList();
                    updateBudgetHistoryCount();
                    updateHistoryStoreFilter();

                    showStatus('success', 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã€Œ' + archiveData.storeName + 'ã€ã‚’å±¥æ­´ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } catch (err) {
                    showStatus('error', 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');

            // inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠå¯èƒ½ã«ï¼‰
            event.target.value = '';
        }

        // å±¥æ­´ã‚’å‰Šé™¤
        function deleteBudgetHistory(historyId) {
            var history = loadBudgetHistory();
            var entry = history.find(function(e) { return e.id === historyId; });
            if (!entry) return;

            if (!confirm('ã€Œ' + entry.storeName + 'ã€ï¼ˆ' + entry.dateTime + 'ï¼‰ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            history = history.filter(function(e) { return e.id !== historyId; });
            saveBudgetHistory(history);
            renderBudgetHistoryList();
            updateBudgetHistoryCount();
            updateHistoryStoreFilter();

            // è©³ç´°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
            var preview = document.getElementById('historyDetailPreview');
            if (preview) preview.style.display = 'none';

            showStatus('info', 'å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å…¨å±¥æ­´ã‚’å‰Šé™¤
        function clearAllBudgetHistory() {
            if (!confirm('å…¨ã¦ã®å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            saveBudgetHistory([]);
            renderBudgetHistoryList();
            updateBudgetHistoryCount();
            updateHistoryStoreFilter();

            var preview = document.getElementById('historyDetailPreview');
            if (preview) preview.style.display = 'none';

            showStatus('info', 'å…¨ã¦ã®å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å±¥æ­´ã«ä¿å­˜ï¼ˆæ‰‹å‹•ä¿å­˜ï¼‰
        function saveCurrentToHistory() {
            // ä¿å­˜å¯¾è±¡ã®åº—èˆ—ã‚’é¸æŠ
            var storeNames = Object.keys(allStoresData);
            if (storeNames.length === 0) {
                showStatus('warn', 'ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«äºˆç®—CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // è¤‡æ•°åº—èˆ—ãŒã‚ã‚‹å ´åˆã¯é¸æŠè‚¢ã‚’è¡¨ç¤º
            var targetStore = currentStoreName;
            if (storeNames.length > 1) {
                var options = storeNames.map(function(name, i) {
                    return (i + 1) + ': ' + name;
                }).join('\n');
                var choice = prompt('ä¿å­˜ã™ã‚‹åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n' + options + '\n\n0: å…¨åº—èˆ—ã‚’ä¿å­˜\n\nç•ªå·ã‚’å…¥åŠ›:', '0');

                if (choice === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

                var choiceNum = parseInt(choice, 10);
                if (choiceNum === 0) {
                    // å…¨åº—èˆ—ã‚’ä¿å­˜
                    var savedCount = 0;
                    storeNames.forEach(function(name) {
                        var storeData = allStoresData[name];
                        if (storeData) {
                            addToBudgetHistory(name, storeData);
                            savedCount++;
                        }
                    });
                    renderBudgetHistoryList();
                    showStatus('success', savedCount + 'åº—èˆ—ã®äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ');
                    return;
                } else if (choiceNum >= 1 && choiceNum <= storeNames.length) {
                    targetStore = storeNames[choiceNum - 1];
                } else {
                    showStatus('error', 'ç„¡åŠ¹ãªé¸æŠã§ã™');
                    return;
                }
            }

            // å˜ä¸€åº—èˆ—ã‚’ä¿å­˜
            if (!targetStore || !allStoresData[targetStore]) {
                showStatus('warn', 'ä¿å­˜ã™ã‚‹åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveCurrentStoreData();
            addToBudgetHistory(targetStore, allStoresData[targetStore]);
            renderBudgetHistoryList();
            showStatus('success', 'ã€Œ' + targetStore + 'ã€ã®äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // â˜… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†æ™‚ã«å…¨åº—èˆ—ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆ
        function generateExportDataForAllStores() {
            var storeNames = Object.keys(allStoresData);
            if (storeNames.length === 0) return;

            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            var sec = ('0' + now.getSeconds()).slice(-2);
            var dateTimeStr = y + m + d + h + min + sec;
            var dateTimeDisplay = y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + sec;

            var history = loadExportHistory();

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            storeNames.forEach(function(name) {
                var storeData = allStoresData[name];
                if (!storeData) return;

                // ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                var rakumyData = generateRakumyInputData(name, storeData);
                var mqData = generateMQOutputData(name, storeData);

                // ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤ã‚’å±¥æ­´ã«è¿½åŠ 
                var rakumyEntry = {
                    id: Date.now().toString() + '_rakumy_' + name,
                    title: dateTimeStr + '_' + name + '_ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤',
                    exportType: 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV',
                    storeNames: [name],
                    storeCount: 1,
                    dateTime: dateTimeDisplay,
                    data: rakumyData,
                    savedAt: now.toISOString()
                };
                history.unshift(rakumyEntry);

                // MQå‡ºåŠ›ã‚’å±¥æ­´ã«è¿½åŠ 
                var mqEntry = {
                    id: Date.now().toString() + '_mq_' + name,
                    title: dateTimeStr + '_' + name + '_MQå‡ºåŠ›',
                    exportType: 'MQå‡ºåŠ›CSV',
                    storeNames: [name],
                    storeCount: 1,
                    dateTime: dateTimeDisplay,
                    data: mqData,
                    savedAt: now.toISOString()
                };
                history.unshift(mqEntry);
            });

            // å±¥æ­´ã‚’ä¿å­˜ï¼ˆæœ€å¤§100ä»¶ï¼‰
            if (history.length > 100) history = history.slice(0, 100);
            saveExportHistory(history);
            updateExportHistoryCount();
        }

        // ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generateRakumyInputData(storeName, storeData) {
            var csv = [];
            var BOM = '\uFEFF';
            var stActiveMonths = storeData.activeMonths || [];
            var labels = storeData.monthLabels || [];
            var stRakumyInputs = storeData.rakumyInputs || {};

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            var header = ['åº—èˆ—å', 'ã‚»ã‚¯ã‚·ãƒ§ãƒ³', 'é …ç›®å', 'å¤‰æ›ã‚¿ã‚¤ãƒ—'];
            labels.forEach(function(label) { header.push(label); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            // ========== æ–°ãƒ­ã‚¸ãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤æ±ºå®š + å·®ç•°æœˆç‰¹å®š ==========
            function analyzeMonthlyValuesForExport(key) {
                var values = [];
                var valueCount = {};

                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                    var roundedVal = Math.round(val * 100) / 100;
                    values.push(roundedVal);
                    valueCount[roundedVal] = (valueCount[roundedVal] || 0) + 1;
                }

                var defaultValue = 0;
                var maxCount = 0;
                for (var v in valueCount) {
                    if (valueCount[v] > maxCount) {
                        maxCount = valueCount[v];
                        defaultValue = parseFloat(v);
                    }
                }

                var diffMonths = [];
                var diffValues = {};
                for (var m = 0; m < values.length; m++) {
                    if (Math.abs(values[m] - defaultValue) > 0.01) {
                        diffMonths.push(m);
                        diffValues[m] = values[m];
                    }
                }

                return {
                    defaultValue: defaultValue,
                    diffMonths: diffMonths,
                    diffValues: diffValues,
                    hasDiff: diffMonths.length > 0
                };
            }

            // === è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰=== æ–°ãƒ­ã‚¸ãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å‡ºåŠ›
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                if (item.category !== 'cost') continue;

                var analysis = analyzeMonthlyValuesForExport(key);
                var row = [storeName, 'è²»ç”¨äºˆç®—è¨­å®š', item.name, item.type];

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæœ€é »å€¤ï¼‰ã‚’å…¨æœˆã«å‡ºåŠ›
                var total = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    row.push(Math.round(analysis.defaultValue));
                    total += analysis.defaultValue;
                }
                row.push(Math.round(total), Math.round(analysis.defaultValue));
                csv.push(row.join(','));
            }

            // === å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰=== æ–°ãƒ­ã‚¸ãƒƒã‚¯: å·®ç•°æœˆã®ã¿å€¤ã‚’å‡ºåŠ›
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                if (item.category !== 'monthly') continue;

                var baseKey = key.replace('m_', '');
                var analysis = analyzeMonthlyValuesForExport(baseKey);
                if (!analysis.hasDiff) continue;

                var row = [storeName, 'å˜æœˆè²»ç”¨äºˆç®—', item.name, item.type];
                var diffTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var isDiffMonth = analysis.diffMonths.indexOf(m) >= 0;
                    if (isDiffMonth) {
                        var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                        diffTotal += val;
                        row.push(Math.round(val));
                    } else {
                        row.push('-'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé©ç”¨æœˆã¯ã€Œ-ã€
                    }
                }
                row.push(Math.round(diffTotal), '(' + analysis.diffMonths.length + 'æœˆ)');
                csv.push(row.join(','));
            }

            // === äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰===
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                if (item.category !== 'budget') continue;

                var isRate = item.type === 'rate' || key.indexOf('Ratio') > -1;
                var row = [storeName, 'äºˆç®—è¨­å®š', item.name, item.type];
                var total = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                    total += val;
                    row.push(isRate ? Math.round(val) + '%' : Math.round(val));
                }
                if (isRate) {
                    row.push('-', Math.round(total / stActiveMonths.length) + '%');
                } else {
                    row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                }
                csv.push(row.join(','));
            }

            return BOM + csv.join('\n');
        }

        // MQå‡ºåŠ›CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generateMQOutputData(storeName, storeData) {
            var csv = [];
            var BOM = '\uFEFF';
            var stActiveMonths = storeData.activeMonths || [];
            var labels = storeData.monthLabels || [];
            var stMqOutputs = storeData.mqOutputs || {};
            var stAnnualData = storeData.annualData || {};

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            var header = ['åº—èˆ—å', 'é …ç›®'];
            labels.forEach(function(label) { header.push(label); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            // MQé …ç›®
            var mqItems = [
                { key: 'customers', name: 'å®¢æ•°', isRate: false },
                { key: 'unitPrice', name: 'å®¢å˜ä¾¡', isRate: false },
                { key: 'sales', name: 'å£²ä¸Š', isRate: false },
                { key: 'variableCost', name: 'å¤‰å‹•è²»', isRate: false },
                { key: 'variableRate', name: 'å¤‰å‹•è²»ç‡', isRate: true },
                { key: 'grossProfit', name: 'ç²—åˆ©', isRate: false },
                { key: 'grossProfitRate', name: 'ç²—åˆ©ç‡', isRate: true },
                { key: 'fixedCost', name: 'å›ºå®šè²»', isRate: false },
                { key: 'operatingProfit', name: 'å–¶æ¥­åˆ©ç›Š', isRate: false },
                { key: 'operatingProfitRate', name: 'å–¶æ¥­åˆ©ç›Šç‡', isRate: true }
            ];

            mqItems.forEach(function(item) {
                var row = [storeName, item.name];
                var total = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stMqOutputs[m] ? (stMqOutputs[m][item.key] || 0) : 0;
                    total += val;
                    row.push(item.isRate ? val.toFixed(1) + '%' : Math.round(val));
                }
                if (item.isRate) {
                    row.push('-', (total / stActiveMonths.length).toFixed(1) + '%');
                } else {
                    row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                }
                csv.push(row.join(','));
            });

            // é¡§å®¢äºˆç®—å£²ä¸Š
            var budgetSalesRow = [storeName, 'é¡§å®¢äºˆç®—å£²ä¸Š'];
            var budgetSalesTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var val = stAnnualData[5] ? (stAnnualData[5][m] || 0) : 0;
                budgetSalesTotal += val;
                budgetSalesRow.push(Math.round(val));
            }
            budgetSalesRow.push(Math.round(budgetSalesTotal), Math.round(budgetSalesTotal / stActiveMonths.length));
            csv.push(budgetSalesRow.join(','));

            // å£²ä¸Šå·®ç•°
            var salesDiffRow = [storeName, 'å£²ä¸Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
            var salesDiffTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var mqSales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                var budgetSales = stAnnualData[5] ? (stAnnualData[5][m] || 0) : 0;
                var diff = mqSales - budgetSales;
                salesDiffTotal += diff;
                salesDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff));
            }
            salesDiffRow.push((salesDiffTotal >= 0 ? '+' : '') + Math.round(salesDiffTotal), '-');
            csv.push(salesDiffRow.join(','));

            // é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Š
            var budgetProfitRow = [storeName, 'é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Š'];
            var budgetProfitTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var val = stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0;
                budgetProfitTotal += val;
                budgetProfitRow.push(Math.round(val));
            }
            budgetProfitRow.push(Math.round(budgetProfitTotal), Math.round(budgetProfitTotal / stActiveMonths.length));
            csv.push(budgetProfitRow.join(','));

            // å–¶æ¥­åˆ©ç›Šå·®ç•°
            var profitDiffRow = [storeName, 'å–¶æ¥­åˆ©ç›Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
            var profitDiffTotal = 0;
            for (var m = 0; m < stActiveMonths.length; m++) {
                var mqProfit = stMqOutputs[m] ? (stMqOutputs[m].operatingProfit || 0) : 0;
                var budgetProfit = stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0;
                var diff = mqProfit - budgetProfit;
                profitDiffTotal += diff;
                profitDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff));
            }
            profitDiffRow.push((profitDiffTotal >= 0 ? '+' : '') + Math.round(profitDiffTotal), '-');
            csv.push(profitDiffRow.join(','));

            return BOM + csv.join('\n');
        }

        // â˜… è¤‡æ•°CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importAllCSVs() {
            if (selectedFiles.length === 0) return;

            var filesToImport = selectedFiles.slice(); // ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
            var totalFiles = filesToImport.length;
            var importCount = 0;
            var errorCount = 0;

            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showStatus('info', totalFiles + 'ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');

            filesToImport.forEach(function(file, index) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        preprocessLog = [];
                        addLog('CSVãƒ•ã‚¡ã‚¤ãƒ« ' + (index + 1) + '/' + totalFiles + ': ' + file.name, 'info');
                        parseCustomerCSV(e.target.result);

                        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                        runSimulation();

                        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        saveCurrentStoreData();

                        // â˜… å–ã‚Šè¾¼ã¿äºˆç®—å±¥æ­´ã«è‡ªå‹•ä¿å­˜
                        addToBudgetHistory(storeName, allStoresData[storeName]);

                        importCount++;

                        addLog('åº—èˆ—ã€Œ' + storeName + 'ã€ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', 'success');
                    } catch (err) {
                        addLog('ã‚¨ãƒ©ãƒ¼ï¼ˆ' + file.name + 'ï¼‰: ' + err.message, 'error');
                        errorCount++;
                    }

                    // å…¨ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å®Œäº†
                    if (importCount + errorCount === totalFiles) {
                        updateStoreSelector();
                        renderAllStoresSummary();
                        updateDataCounts();

                        // æœ€åˆã®åº—èˆ—ã‚’é¸æŠ
                        var storeNames = Object.keys(allStoresData);
                        if (storeNames.length > 0 && !currentStoreName) {
                            switchStore(storeNames[0]);
                        }

                        document.getElementById('preprocessLog').innerHTML = preprocessLog.join('\n');
                        showStatus('success', importCount + 'åº—èˆ—ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†' + (errorCount > 0 ? 'ï¼ˆ' + errorCount + 'ä»¶ã‚¨ãƒ©ãƒ¼ï¼‰' : ''));

                        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†å¾Œã€è‡ªå‹•çš„ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                        generateExportDataForAllStores();

                        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†å¾Œã€é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
                        clearSelectedFiles();
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        // â˜… ç¾åœ¨ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveCurrentStoreData() {
            if (!storeName) return;

            allStoresData[storeName] = {
                annualData: JSON.parse(JSON.stringify(annualData)),
                calcResults: JSON.parse(JSON.stringify(calcResults)),
                rakumyInputs: JSON.parse(JSON.stringify(rakumyInputs)),
                mqOutputs: JSON.parse(JSON.stringify(mqOutputs)),
                judgments: JSON.parse(JSON.stringify(judgments)),
                matchedItems: JSON.parse(JSON.stringify(matchedItems)),
                unmatchedItems: JSON.parse(JSON.stringify(unmatchedItems)),
                activeMonths: activeMonths.slice(),
                monthLabels: monthLabels.slice(),
                budgetColumnPositions: JSON.parse(JSON.stringify(budgetColumnPositions)),
                monthDetectionResults: JSON.parse(JSON.stringify(monthDetectionResults))
            };
        }

        // â˜… åº—èˆ—åˆ‡ã‚Šæ›¿ãˆ
        function switchStore(name) {
            if (!name || !allStoresData[name]) return;

            currentStoreName = name;
            var data = allStoresData[name];

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å¾©å…ƒ
            storeName = name;
            annualData = data.annualData;
            calcResults = data.calcResults;
            rakumyInputs = data.rakumyInputs;
            mqOutputs = data.mqOutputs;
            judgments = data.judgments;
            matchedItems = data.matchedItems;
            unmatchedItems = data.unmatchedItems;
            activeMonths = data.activeMonths;
            monthLabels = data.monthLabels;
            budgetColumnPositions = data.budgetColumnPositions;
            monthDetectionResults = data.monthDetectionResults;

            // UIæ›´æ–°
            document.getElementById('storeSelect').value = name;
            document.getElementById('detectedStore').textContent = name;
            document.getElementById('detectedMonthCount').textContent = activeMonths.length + 'ãƒ¶æœˆ';
            document.getElementById('detectedItemCount').textContent = matchedItems.length + 'é …ç›®';
            document.getElementById('unmatchedCount').textContent = unmatchedItems.length + 'é …ç›®';

            // åº—èˆ—ãƒãƒƒãƒ—ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.store-chip').forEach(function(chip) {
                chip.classList.toggle('active', chip.dataset.store === name);
            });

            // ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»
            renderMappingTable();
            renderUnmatchedItems();
            renderMonthColsGrid();
            renderAllTables();

            // â˜… ç›®æ¨™å®¢å˜ä¾¡ã‚’åˆæœŸåŒ–
            initUnitPricesForStore(name);

            // â˜… äºˆç®—è©¦ç®—ã‚¿ãƒ–ã®åº—èˆ—ã‚»ãƒ¬ã‚¯ãƒˆã‚‚åŒæœŸ
            var simSelect = document.getElementById('simulationStoreSelect');
            if (simSelect) {
                simSelect.value = name;
                // simulationDataã‚’æ›´æ–°ï¼ˆäºˆç®—è©¦ç®—ã‚¿ãƒ–ã¨ã®é€£å‹•ã‚’ç¢ºä¿ï¼‰
                if (typeof loadSimulationData === 'function') {
                    loadSimulationData();
                }
            }

            showStatus('info', 'åº—èˆ—ã€Œ' + name + 'ã€ã‚’è¡¨ç¤ºä¸­');
        }

        // â˜… åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°
        function updateStoreSelector() {
            var storeNames = Object.keys(allStoresData);

            document.getElementById('storeSelector').style.display = storeNames.length > 0 ? 'flex' : 'none';
            document.getElementById('storeCount').textContent = storeNames.length;

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ›´æ–°
            var select = document.getElementById('storeSelect');
            select.innerHTML = '<option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>';
            storeNames.forEach(function(name) {
                var opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            if (currentStoreName) select.value = currentStoreName;

            // åº—èˆ—ãƒãƒƒãƒ—æ›´æ–°
            var listEl = document.getElementById('storeList');
            listEl.innerHTML = '';
            storeNames.forEach(function(name) {
                var chip = document.createElement('span');
                chip.className = 'store-chip' + (name === currentStoreName ? ' active' : '');
                chip.dataset.store = name;
                chip.innerHTML = name + '<span class="remove" onclick="removeStore(\'' + name.replace(/'/g, "\\'") + '\', event)">&times;</span>';
                chip.onclick = function() { switchStore(name); };
                listEl.appendChild(chip);
            });

            // äºˆç®—è©¦ç®—ã‚¿ãƒ–ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚‚æ›´æ–°
            updateSimulationStoreSelect();
        }

        // â˜… äºˆç®—è©¦ç®—ã‚¿ãƒ–ã®åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°
        function updateSimulationStoreSelect() {
            var select = document.getElementById('simulationStoreSelect');
            if (!select) return;

            var storeNames = Object.keys(allStoresData);
            select.innerHTML = '<option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>';
            storeNames.forEach(function(name) {
                var opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨ãƒ‡ãƒ¼ã‚¿å¤‰æ•°
        var simulationData = {};
        var simulationOriginal = {};

        // â˜… äºˆç®—è©¦ç®—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadSimulationData() {
            var select = document.getElementById('simulationStoreSelect');
            var selectedStore = select.value;

            var contentDiv = document.getElementById('simulationContent');
            var noDataDiv = document.getElementById('simulationNoData');
            var mqInputSection = document.getElementById('simMqInputSection');

            if (!selectedStore || !allStoresData[selectedStore]) {
                if (contentDiv) contentDiv.style.display = 'none';
                if (noDataDiv) noDataDiv.style.display = 'block';
                if (mqInputSection) mqInputSection.style.display = 'none';
                return;
            }

            // è¡¨ç¤ºåˆ‡æ›¿
            if (contentDiv) contentDiv.style.display = 'block';
            if (noDataDiv) noDataDiv.style.display = 'none';
            if (mqInputSection) mqInputSection.style.display = 'block';  // â˜… MQè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º

            // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
            simulationOriginal = JSON.parse(JSON.stringify(allStoresData[selectedStore]));
            simulationData = JSON.parse(JSON.stringify(allStoresData[selectedStore]));

            // â˜… åº—èˆ—åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¢å˜ä¾¡ã‚’äºˆç®—è©¦ç®—ãƒšãƒ¼ã‚¸ã«åŒæœŸ
            initSimUnitPrices(selectedStore);

            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
            initSimYearMonth();

            // â˜… MQè‡ªå‹•åˆæˆå€¤ã®è¡¨ç¤ºã‚’æ›´æ–°
            updateSimMqDisplay();
            updateSimAutoParamsDisplay();

            // é€£å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æç”»
            renderLinkedSimulation();
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨MQè¡¨ç¤ºæ›´æ–°
        // äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼ˆupdateSimRefDisplayã«è»¢é€ï¼‰
        function updateSimMqDisplay() {
            updateSimRefDisplay();
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«å‹•çš„ç”Ÿæˆ
        function renderSimUnitPriceTable() {
            var table = document.getElementById('simUnitPriceTable');
            if (!table) return;

            // å–ã‚Šè¾¼ã¾ã‚ŒãŸæœˆã‚’å–å¾—
            var stActiveMonths = [];
            var monthLabels = [];
            if (simulationData && simulationData.activeMonths) {
                stActiveMonths = simulationData.activeMonths;
                monthLabels = simulationData.monthLabels || [];
            }

            // æœˆæ•°è¡¨ç¤ºã‚’æ›´æ–°
            var countEl = document.getElementById('simMonthCountDisplay');
            if (countEl) countEl.textContent = stActiveMonths.length;

            if (stActiveMonths.length === 0) {
                table.innerHTML = '<tr><td style="padding:20px;text-align:center;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // æœˆåãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆè²¡å‹™å¹´åº¦: 0=4æœˆ, 1=5æœˆ, ... 11=3æœˆï¼‰
            var MONTH_NAMES = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var headerHtml = '<thead><tr style="background:#2e7d32;">';
            headerHtml += '<th style="min-width:130px;padding:6px;color:#fff;font-weight:bold;">é …ç›®</th>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var label = monthLabels[i] || MONTH_NAMES[mi] || (mi + 1) + 'æœˆ';
                headerHtml += '<th style="min-width:65px;color:#fff;font-weight:bold;">' + label + '</th>';
            }
            headerHtml += '<th style="min-width:70px;background:#1b5e20;color:#fff;font-weight:bold;">å¹³å‡</th>';
            headerHtml += '</tr></thead>';

            // ãƒœãƒ‡ã‚£è¡Œ
            var bodyHtml = '<tbody>';

            // ç·åˆ
            bodyHtml += '<tr style="background:#e8f5e9;"><td style="font-weight:bold;color:#2e7d32;">ç›®æ¨™å®¢å˜ä¾¡ï¼ˆç·åˆï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                bodyHtml += '<td><input type="number" id="simP_total_' + mi + '" step="100" style="width:55px;padding:3px;text-align:right;border:1px solid #4caf50;border-radius:3px;" onchange="updateSimUnitPriceAverage(\'total\')"></td>';
            }
            bodyHtml += '<td id="simP_total_avg" style="font-weight:bold;text-align:right;background:#c8e6c9;">Â¥--</td></tr>';

            // ãƒ©ãƒ³ãƒ
            bodyHtml += '<tr><td style="font-weight:bold;color:#1565c0;">ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ©ãƒ³ãƒï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                bodyHtml += '<td><input type="number" id="simP_lunch_' + mi + '" step="100" style="width:55px;padding:3px;text-align:right;border:1px solid #2196f3;border-radius:3px;" onchange="updateSimUnitPriceAverage(\'lunch\')"></td>';
            }
            bodyHtml += '<td id="simP_lunch_avg" style="font-weight:bold;text-align:right;background:#e3f2fd;">Â¥--</td></tr>';

            // ãƒ‡ã‚£ãƒŠãƒ¼
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                bodyHtml += '<td><input type="number" id="simP_dinner_' + mi + '" step="100" style="width:55px;padding:3px;text-align:right;border:1px solid #ff9800;border-radius:3px;" onchange="updateSimUnitPriceAverage(\'dinner\')"></td>';
            }
            bodyHtml += '<td id="simP_dinner_avg" style="font-weight:bold;text-align:right;background:#ffe0b2;">Â¥--</td></tr>';

            bodyHtml += '</tbody>';

            table.innerHTML = headerHtml + bodyHtml;
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨ç›®æ¨™å®¢å˜ä¾¡åˆæœŸåŒ–ï¼ˆæœˆåˆ¥å¯¾å¿œãƒ»å‹•çš„ï¼‰
        function initSimUnitPrices(storeName) {
            // ã¾ãšãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‹•çš„ç”Ÿæˆ
            renderSimUnitPriceTable();

            var defaults = getDefaultUnitPrice(storeName);

            // å–ã‚Šè¾¼ã¾ã‚ŒãŸæœˆã®åˆ†ã ã‘å…¥åŠ›æ¬„ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
            var stActiveMonths = (simulationData && simulationData.activeMonths) ? simulationData.activeMonths : [];
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var totalEl = document.getElementById('simP_total_' + mi);
                var lunchEl = document.getElementById('simP_lunch_' + mi);
                var dinnerEl = document.getElementById('simP_dinner_' + mi);

                if (totalEl) totalEl.value = defaults.total;
                if (lunchEl) lunchEl.value = defaults.lunch;
                if (dinnerEl) dinnerEl.value = defaults.dinner;
            }

            // å¹³å‡å€¤ã‚’æ›´æ–°
            updateSimUnitPriceAverage('total');
            updateSimUnitPriceAverage('lunch');
            updateSimUnitPriceAverage('dinner');
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨æœˆåˆ¥å®¢å˜ä¾¡ã®å¹³å‡è¨ˆç®—ï¼ˆå‹•çš„å¯¾å¿œï¼‰
        function updateSimUnitPriceAverage(type) {
            var total = 0;
            var count = 0;

            var stActiveMonths = (simulationData && simulationData.activeMonths) ? simulationData.activeMonths : [];
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var el = document.getElementById('simP_' + type + '_' + mi);
                if (el && el.value) {
                    var val = parseFloat(el.value) || 0;
                    if (val > 0) {
                        total += val;
                        count++;
                    }
                }
            }

            var avg = count > 0 ? Math.round(total / count) : 0;
            var avgEl = document.getElementById('simP_' + type + '_avg');
            if (avgEl) {
                avgEl.textContent = 'Â¥' + fmt(avg);
            }
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨æœˆåˆ¥å®¢å˜ä¾¡å–å¾—ï¼ˆå‹•çš„å¯¾å¿œï¼‰
        function getSimUnitPrices() {
            var result = {};
            var stActiveMonths = (simulationData && simulationData.activeMonths) ? simulationData.activeMonths : [];

            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var totalEl = document.getElementById('simP_total_' + mi);
                var lunchEl = document.getElementById('simP_lunch_' + mi);
                var dinnerEl = document.getElementById('simP_dinner_' + mi);

                result[mi] = {
                    total: parseFloat(totalEl?.value) || 0,
                    lunch: parseFloat(lunchEl?.value) || 0,
                    dinner: parseFloat(dinnerEl?.value) || 0
                };
            }
            return result;
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
        function resetSimUnitPricesToDefault() {
            var select = document.getElementById('simulationStoreSelect');
            var storeName = select ? select.value : '';
            if (!storeName) {
                showStatus('warn', 'åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            initSimUnitPrices(storeName);
            showStatus('info', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆ' + storeName + 'ï¼‰');
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨è‡ªå‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«å‹•çš„ç”Ÿæˆ
        function renderSimAutoParamsTable() {
            var table = document.getElementById('simAutoParamsTable');
            if (!table) return;

            var stActiveMonths = [];
            var monthLabels = [];
            if (simulationData && simulationData.activeMonths) {
                stActiveMonths = simulationData.activeMonths;
                monthLabels = simulationData.monthLabels || [];
            }

            if (stActiveMonths.length === 0) {
                table.innerHTML = '<tr><td style="padding:20px;text-align:center;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            var params = getSimMQAutoParams();
            var MONTH_NAMES = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var headerHtml = '<thead><tr style="background:#e65100;">';
            headerHtml += '<th style="min-width:100px;padding:6px;color:#fff;font-weight:bold;">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</th>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var label = monthLabels[i] || MONTH_NAMES[mi] || (mi + 1) + 'æœˆ';
                headerHtml += '<th style="min-width:65px;color:#fff;font-weight:bold;">' + label + '</th>';
            }
            headerHtml += '<th style="min-width:70px;background:#bf360c;color:#fff;font-weight:bold;">å¹³å‡</th>';
            headerHtml += '</tr></thead>';

            // ãƒœãƒ‡ã‚£è¡Œ
            var bodyHtml = '<tbody>';

            // Gï¼ˆç›®æ¨™åˆ©ç›Šï¼‰- æœˆåˆ¥
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ã€Gã€‘ç›®æ¨™åˆ©ç›Š(å††)</td>';
            var totalG = 0;
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var g = params.monthlyG[mi] || 0;
                totalG += g;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(g) + '</td>';
            }
            var avgG = Math.round(totalG / stActiveMonths.length);
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + fmtYen(avgG) + '</td></tr>';

            // Fï¼ˆå›ºå®šè²»ï¼‰- æœˆåˆ¥
            bodyHtml += '<tr><td style="font-weight:bold;color:#e65100;">ã€Fã€‘å›ºå®šè²»(å††)</td>';
            var totalF = 0;
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var f = params.monthlyF[mi] || 0;
                totalF += f;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(f) + '</td>';
            }
            var avgF = Math.round(totalF / stActiveMonths.length);
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + fmtYen(avgF) + '</td></tr>';

            // FD%ï¼ˆå…¨æœŸé–“å…±é€šï¼‰
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ã€FD%ã€‘FDç‡</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                bodyHtml += '<td style="text-align:right;color:#888;">' + params.fdRate.toFixed(1) + '%</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + params.fdRate.toFixed(1) + '%</td></tr>';

            // PA%ï¼ˆå…¨æœŸé–“å…±é€šï¼‰
            bodyHtml += '<tr><td style="font-weight:bold;color:#e65100;">ã€PA%ã€‘PAç‡</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                bodyHtml += '<td style="text-align:right;color:#888;">' + params.paRate.toFixed(1) + '%</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + params.paRate.toFixed(1) + '%</td></tr>';

            bodyHtml += '</tbody>';

            table.innerHTML = headerHtml + bodyHtml;
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨è‡ªå‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¡¨ç¤ºæ›´æ–°ï¼ˆå‹•çš„æœˆå¯¾å¿œï¼‰
        function updateSimAutoParamsDisplay() {
            renderSimAutoParamsTable();
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨è‡ªå‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
        function getSimMQAutoParams() {
            var result = {
                monthlyG: {},  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«å¤‰æ›´ï¼ˆæœˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚­ãƒ¼ã«ï¼‰
                monthlyF: {},
                fdRate: 0,
                paRate: 0,
                totalG: 0,
                avgF: 0
            };

            if (!simulationData || !simulationData.annualData) return result;

            var get = function(no, m) { return simulationData.annualData[no] ? (simulationData.annualData[no][m] || 0) : 0; };

            // å–ã‚Šè¾¼ã¾ã‚ŒãŸæœˆã®ã¿å‡¦ç†
            var stActiveMonths = simulationData.activeMonths || [];
            var monthCount = stActiveMonths.length || 1;

            // å›ºå®šè²»ãƒ»å¤‰å‹•è²»ãƒ»å£²ä¸Šã‚’è¨ˆç®—
            var totalFixedCost = 0;
            var totalVariableCost = 0;
            var totalSales = 0;

            for (var i = 0; i < stActiveMonths.length; i++) {
                var m = stActiveMonths[i];

                // No.63 = å–¶æ¥­åˆ©ç›Š
                var g = get(63, m);
                result.monthlyG[m] = g;
                result.totalG += g;

                // å›ºå®šè²»
                var fixedCost = get(56,m) + get(59,m) + get(16,m) + get(17,m) + get(18,m) + get(21,m) + get(22,m) + get(23,m) + get(24,m) + get(25,m) + get(55,m) + get(57,m) + get(58,m) +
                    get(27,m) + get(28,m) + get(29,m) + get(30,m) + get(31,m) + get(32,m) + get(33,m) + get(34,m) + get(35,m) + get(36,m) +
                    get(37,m) + get(38,m) + get(39,m) + get(40,m) + get(41,m) + get(42,m) + get(43,m) + get(44,m) + get(45,m) + get(46,m) +
                    get(47,m) + get(48,m) + get(49,m) + get(50,m) + get(51,m);
                result.monthlyF[m] = fixedCost;
                totalFixedCost += fixedCost;

                // å¤‰å‹•è²»
                var variableCost = get(6, m) + get(10, m) + get(19, m);
                totalVariableCost += variableCost;
                totalSales += get(4, m);
            }

            result.avgF = Math.round(totalFixedCost / monthCount);

            // FD%ã¨PA%ã‚’è¨ˆç®—
            if (totalSales > 0) {
                var fdCost = 0, paCost = 0;
                for (var i = 0; i < stActiveMonths.length; i++) {
                    var m = stActiveMonths[i];
                    fdCost += get(6, m) + get(10, m);
                    paCost += get(19, m);
                }
                result.fdRate = Math.round((fdCost / totalSales) * 1000) / 10;
                result.paRate = Math.round((paCost / totalSales) * 1000) / 10;
            }

            return result;
        }

        // â˜…â˜…â˜… äºˆç®—è©¦ç®—ç”¨MQå…¥åŠ›å€¤å–å¾—ï¼ˆç›®æ¨™å®¢å˜ä¾¡ã®ã¿å…¥åŠ›ã€ä»–ã¯è‡ªå‹•å–å¾—ãƒ»å‹•çš„æœˆå¯¾å¿œï¼‰â˜…â˜…â˜…
        function getSimMQInputs() {
            // ç›®æ¨™å®¢å˜ä¾¡ã¯æœˆåˆ¥å…¥åŠ›å€¤ã‹ã‚‰å–å¾—ã€G, FD%, PA%, Fã¯è‡ªå‹•è¨ˆç®—
            var unitPrices = getSimUnitPrices();  // æœˆåˆ¥å®¢å˜ä¾¡ã‚’å–å¾—ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ï¼‰
            var autoParams = getSimMQAutoParams();

            // å–ã‚Šè¾¼ã¾ã‚ŒãŸæœˆã®ã¿å‡¦ç†
            var stActiveMonths = (simulationData && simulationData.activeMonths) ? simulationData.activeMonths : [];
            var defaults = { total: 5000, lunch: 0, dinner: 5000 };

            var monthlyInputs = {};
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var up = unitPrices[mi] || defaults;
                monthlyInputs[mi] = {
                    targetProfit: autoParams.monthlyG[mi] || 0,
                    fdRate: autoParams.fdRate || 30,
                    paRate: autoParams.paRate || 10,
                    targetUnitPrice: up.total,       // æœˆåˆ¥ç·åˆå®¢å˜ä¾¡
                    targetUnitPriceLunch: up.lunch,  // æœˆåˆ¥ãƒ©ãƒ³ãƒå®¢å˜ä¾¡
                    targetUnitPriceDinner: up.dinner, // æœˆåˆ¥ãƒ‡ã‚£ãƒŠãƒ¼å®¢å˜ä¾¡
                    fixedCost: autoParams.monthlyF[mi] || 0
                };
            }
            return monthlyInputs;
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨è²»ç”¨å‚ç…§è¡¨ç¤ºã‚’æ›´æ–°
        function updateSimRefDisplay() {
            if (!simulationData || !simulationData.annualData) return;

            var totalFixedCost = 0;
            var totalVariableCost = 0;
            var totalSales = 0;
            var get = function(no, m) { return simulationData.annualData[no] ? (simulationData.annualData[no][m] || 0) : 0; };

            for (var m = 0; m < 12; m++) {
                var fixedCost = get(56,m) + get(59,m) + get(16,m) + get(17,m) + get(18,m) + get(21,m) + get(22,m) + get(23,m) + get(24,m) + get(25,m) + get(55,m) + get(57,m) + get(58,m) +
                    get(27,m) + get(28,m) + get(29,m) + get(30,m) + get(31,m) + get(32,m) + get(33,m) + get(34,m) + get(35,m) + get(36,m) +
                    get(37,m) + get(38,m) + get(39,m) + get(40,m) + get(41,m) + get(42,m) + get(43,m) + get(44,m) + get(45,m) + get(46,m) +
                    get(47,m) + get(48,m) + get(49,m) + get(50,m) + get(51,m);
                totalFixedCost += fixedCost;

                var variableCost = get(6, m) + get(10, m) + get(19, m);
                totalVariableCost += variableCost;
                totalSales += get(4, m);
            }

            var avgFixedCost = Math.round(totalFixedCost / 12);
            var variableRate = totalSales > 0 ? (totalVariableCost / totalSales * 100).toFixed(1) : 0;

            var refVarRate = document.getElementById('simRefVariableRate');
            var refFixedCost = document.getElementById('simRefFixedCost');
            if (refVarRate) refVarRate.textContent = variableRate + '%';
            if (refFixedCost) refFixedCost.textContent = fmtYen(avgFixedCost) + ' å††';
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨MQå†è¨ˆç®—ï¼ˆå‹•çš„æœˆå¯¾å¿œï¼‰
        function recalculateSimMQ() {
            if (!simulationData || !simulationData.rakumyInputs) {
                showStatus('warn', 'äºˆç®—è©¦ç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // â˜…â˜…â˜… æœˆåˆ¥MQå…¥åŠ›å€¤ã‚’å–å¾— â˜…â˜…â˜…
            var mqInputs = getSimMQInputs();
            var stActiveMonths = simulationData.activeMonths || [];
            var firstMonth = stActiveMonths[0];
            var defaultInput = mqInputs[firstMonth] || { targetProfit: 0, fdRate: 30, paRate: 10, targetUnitPrice: 5000 };

            // rakumyInputsã®å…¨MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æœˆåˆ¥ã«æ›´æ–°
            for (var m in simulationData.rakumyInputs) {
                var monthInput = mqInputs[m] || defaultInput;
                simulationData.rakumyInputs[m].targetProfit = monthInput.targetProfit;
                simulationData.rakumyInputs[m].fdRate = monthInput.fdRate;
                simulationData.rakumyInputs[m].paRate = monthInput.paRate;
                simulationData.rakumyInputs[m].targetUnitPrice = monthInput.targetUnitPrice;
            }

            // MQé€†ç®—ã‚’å†å®Ÿè¡Œ
            runSimMQSimulation();

            // è¡¨ç¤ºæ›´æ–°
            updateSimRefDisplay();
            renderLinkedSimulation();

            // MQè¨ˆç®—çµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            renderSimMQResultSummary();

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæœ€åˆã®æœˆã®å€¤ã‚’è¡¨ç¤ºï¼‰
            var m0 = defaultInput;
            showStatus('success', 'MQå†è¨ˆç®—å®Œäº†ï¼ˆ' + stActiveMonths.length + 'ãƒ¶æœˆåˆ†ï¼‰ - Pï¼ˆç·åˆï¼‰:Â¥' + fmt(m0.targetUnitPrice));
        }

        // â˜…â˜…â˜… ç›®æ¨™å®¢å˜ä¾¡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º â˜…â˜…â˜…
        function showUnitPriceConfirmModal() {
            if (!simulationData || !simulationData.rakumyInputs) {
                showStatus('warn', 'äºˆç®—è©¦ç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            var modal = document.getElementById('unitPriceConfirmModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function hideUnitPriceConfirmModal() {
            var modal = document.getElementById('unitPriceConfirmModal');
            if (modal) modal.style.display = 'none';
        }

        // â˜…â˜…â˜… ç›®æ¨™å®¢å˜ä¾¡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º â˜…â˜…â˜…
        function showUnitPriceEditModal() {
            hideUnitPriceConfirmModal();
            // åº—èˆ—åã‚’å–å¾—
            var select = document.getElementById('simulationStoreSelect');
            var storeName = select ? select.value : '';
            // å®¢å˜ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«å†æç”»ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã‚»ãƒƒãƒˆ
            initSimUnitPrices(storeName);
            var modal = document.getElementById('unitPriceEditModal');
            if (modal) {
                modal.style.display = 'flex';
            }
            // æœˆæ•°è¡¨ç¤ºã‚’æ›´æ–°
            var countEl = document.getElementById('simMonthCountDisplay2');
            if (countEl && simulationData && simulationData.activeMonths) {
                countEl.textContent = simulationData.activeMonths.length;
            }
        }

        function hideUnitPriceEditModal() {
            var modal = document.getElementById('unitPriceEditModal');
            if (modal) modal.style.display = 'none';
        }

        // â˜…â˜…â˜… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§MQè©¦ç®—å®Ÿè¡Œ â˜…â˜…â˜…
        function executeSimMQWithoutEdit() {
            hideUnitPriceConfirmModal();
            executeSimMQAndShowResult();
        }

        // â˜…â˜…â˜… ç·¨é›†å¾Œã®å€¤ã§MQè©¦ç®—å®Ÿè¡Œ â˜…â˜…â˜…
        function executeSimMQWithEdit() {
            hideUnitPriceEditModal();
            executeSimMQAndShowResult();
        }

        // â˜…â˜…â˜… ç·¨é›†ã—ãŸå®¢å˜ä¾¡ã‚’ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ â˜…â˜…â˜…
        function saveSimUnitPricesToMaster() {
            var select = document.getElementById('simulationStoreSelect');
            var storeName = select ? select.value : '';
            if (!storeName) {
                showStatus('warn', 'åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            // ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’å–å¾—
            var unitPrices = getSimUnitPrices();
            var stActiveMonths = (simulationData && simulationData.activeMonths) ? simulationData.activeMonths : [];

            if (stActiveMonths.length === 0) {
                showStatus('warn', 'æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // å¹³å‡å€¤ã‚’è¨ˆç®—
            var totalSum = 0, lunchSum = 0, dinnerSum = 0;
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var mp = unitPrices[mi] || { total: 0, lunch: 0, dinner: 0 };
                totalSum += mp.total;
                lunchSum += mp.lunch;
                dinnerSum += mp.dinner;
            }
            var avgTotal = Math.round(totalSum / stActiveMonths.length);
            var avgLunch = Math.round(lunchSum / stActiveMonths.length);
            var avgDinner = Math.round(dinnerSum / stActiveMonths.length);

            // DEFAULT_UNIT_PRICESã«ä¿å­˜
            if (!DEFAULT_UNIT_PRICES[storeName]) {
                DEFAULT_UNIT_PRICES[storeName] = { storeCode: '', total: avgTotal, lunch: avgLunch, dinner: avgDinner };
            } else {
                DEFAULT_UNIT_PRICES[storeName].total = avgTotal;
                DEFAULT_UNIT_PRICES[storeName].lunch = avgLunch;
                DEFAULT_UNIT_PRICES[storeName].dinner = avgDinner;
            }

            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜
            DEFAULT_UNIT_PRICES[storeName].monthly = {};
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var mp = unitPrices[mi] || { total: avgTotal, lunch: avgLunch, dinner: avgDinner };
                DEFAULT_UNIT_PRICES[storeName].monthly[mi] = {
                    total: mp.total,
                    lunch: mp.lunch,
                    dinner: mp.dinner
                };
            }

            // è¡¨ç¤ºæ›´æ–°
            renderMasterPricesContent();

            showStatus('success', 'ã€Œ' + storeName + 'ã€ã®å®¢å˜ä¾¡ã‚’ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆå¹³å‡: Â¥' + fmt(avgTotal) + 'ï¼‰');
        }

        // â˜…â˜…â˜… ç·¨é›†ã—ãŸå®¢å˜ä¾¡ã‚’ãƒã‚¹ã‚¿ã«ä¿å­˜ã—ã¦ã‹ã‚‰MQè©¦ç®—å®Ÿè¡Œ â˜…â˜…â˜…
        function saveAndExecuteSimMQ() {
            saveSimUnitPricesToMaster();
            // ãƒã‚¹ã‚¿å±¥æ­´ã«ã‚‚è‡ªå‹•ä¿å­˜ï¼ˆLocalStorageæ°¸ç¶šåŒ–ï¼‰
            saveMasterDataToHistory();
            hideUnitPriceEditModal();
            executeSimMQAndShowResult();
        }

        // â˜…â˜…â˜… MQè©¦ç®—å®Ÿè¡Œï¼ˆå…±é€šå‡¦ç†ï¼‰â˜…â˜…â˜…
        function executeSimMQAndShowResult() {
            // MQå†è¨ˆç®—å®Ÿè¡Œ
            recalculateSimMQ();
            // çµæœæ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            renderSimMQComparisonResult();
        }

        // â˜…â˜…â˜… MQè©¦ç®—çµæœæ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ â˜…â˜…â˜…
        function renderSimMQComparisonResult() {
            var container = document.getElementById('simMqResultSection');
            var table = document.getElementById('simMqResultTable');
            var summary = document.getElementById('simMqComparisonSummary');
            var statusEl = document.getElementById('simMqResultStatus');
            if (!container || !table) return;

            var stActiveMonths = simulationData && simulationData.activeMonths ? simulationData.activeMonths : [];
            var stMqOutputs = simulationData && simulationData.mqOutputs ? simulationData.mqOutputs : {};
            var stAnnualData = simulationData && simulationData.annualData ? simulationData.annualData : {};

            if (stActiveMonths.length === 0 || Object.keys(stMqOutputs).length === 0) {
                container.style.display = 'none';
                return;
            }

            var MONTH_NAMES = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var headerHtml = '<thead><tr style="background:#1565c0;">';
            headerHtml += '<th style="min-width:150px;padding:8px;color:#fff;font-weight:bold;">é …ç›®</th>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                headerHtml += '<th style="min-width:75px;color:#fff;font-weight:bold;">' + MONTH_NAMES[mi] + '</th>';
            }
            headerHtml += '<th style="min-width:85px;background:#0d47a1;color:#fff;font-weight:bold;">åˆè¨ˆ</th>';
            headerHtml += '</tr></thead>';

            // ãƒœãƒ‡ã‚£è¡Œ
            var bodyHtml = '<tbody>';

            // ===== é¡§å®¢äºˆç®—å£²ä¸Š =====
            var totalCustomerSales = 0;
            bodyHtml += '<tr style="background:#e3f2fd;"><td style="font-weight:bold;color:#1565c0;">ğŸ“ é¡§å®¢äºˆç®—å£²ä¸Šï¼ˆå††ï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var customerSales = stAnnualData[4] ? (stAnnualData[4][mi] || 0) : 0;
                totalCustomerSales += customerSales;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(customerSales) + '</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#bbdefb;">' + fmtYen(totalCustomerSales) + '</td></tr>';

            // ===== MQç®—å‡ºå£²ä¸Š =====
            var totalMqSales = 0;
            bodyHtml += '<tr style="background:#f3e5f5;"><td style="font-weight:bold;color:#7b1fa2;">ğŸ“Š MQç®—å‡ºå£²ä¸Šï¼ˆå††ï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var mqSales = stMqOutputs[mi] ? (stMqOutputs[mi].sales || 0) : 0;
                totalMqSales += mqSales;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(mqSales) + '</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#e1bee7;">' + fmtYen(totalMqSales) + '</td></tr>';

            // ===== å£²ä¸Šå·®ç•° =====
            var salesDiff = totalMqSales - totalCustomerSales;
            var salesDiffRate = totalCustomerSales > 0 ? ((salesDiff / totalCustomerSales) * 100).toFixed(1) : 0;
            bodyHtml += '<tr><td style="font-weight:bold;color:#ff5722;">ğŸ“‰ å£²ä¸Šå·®ç•°ï¼ˆå††ï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var customerSales = stAnnualData[4] ? (stAnnualData[4][mi] || 0) : 0;
                var mqSales = stMqOutputs[mi] ? (stMqOutputs[mi].sales || 0) : 0;
                var diff = mqSales - customerSales;
                var diffColor = diff >= 0 ? '#4caf50' : '#f44336';
                bodyHtml += '<td style="text-align:right;color:' + diffColor + ';font-weight:bold;">' + (diff >= 0 ? '+' : '') + fmtYen(diff) + '</td>';
            }
            var totalDiffColor = salesDiff >= 0 ? '#4caf50' : '#f44336';
            bodyHtml += '<td style="font-weight:bold;text-align:right;color:' + totalDiffColor + ';">' + (salesDiff >= 0 ? '+' : '') + fmtYen(salesDiff) + '</td></tr>';

            // ===== MQç›®æ¨™å®¢æ•° =====
            var totalQ = 0;
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ğŸ¯ MQç›®æ¨™å®¢æ•°ï¼ˆäººï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var q = stMqOutputs[mi] ? (stMqOutputs[mi].customers || 0) : 0;
                totalQ += q;
                bodyHtml += '<td style="text-align:right;">' + fmt(q) + '</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + fmt(totalQ) + '</td></tr>';

            // ===== ç›®æ¨™å–¶æ¥­åˆ©ç›Š =====
            var totalProfit = 0;
            bodyHtml += '<tr style="background:#e8f5e9;"><td style="font-weight:bold;color:#2e7d32;">ğŸ’° ç›®æ¨™å–¶æ¥­åˆ©ç›Šï¼ˆå††ï¼‰</td>';
            for (var i = 0; i < stActiveMonths.length; i++) {
                var mi = stActiveMonths[i];
                var profit = stMqOutputs[mi] ? (stMqOutputs[mi].operatingProfit || 0) : 0;
                totalProfit += profit;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(profit) + '</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#c8e6c9;">' + fmtYen(totalProfit) + '</td></tr>';

            bodyHtml += '</tbody>';
            table.innerHTML = headerHtml + bodyHtml;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆå£²ä¸Šå·®ç•°ã®åˆ¤å®šï¼‰
            if (statusEl) {
                if (Math.abs(salesDiff) < totalCustomerSales * 0.05) {
                    statusEl.textContent = 'âœ… äºˆç®—é”æˆå¯èƒ½ï¼ˆå·®ç•°5%ä»¥å†…ï¼‰';
                    statusEl.style.background = '#c8e6c9';
                    statusEl.style.color = '#2e7d32';
                } else if (salesDiff > 0) {
                    statusEl.textContent = 'âš ï¸ MQå£²ä¸Š > é¡§å®¢äºˆç®—ï¼ˆ+' + salesDiffRate + '%ï¼‰';
                    statusEl.style.background = '#fff3e0';
                    statusEl.style.color = '#e65100';
                } else {
                    statusEl.textContent = 'âš ï¸ MQå£²ä¸Š < é¡§å®¢äºˆç®—ï¼ˆ' + salesDiffRate + '%ï¼‰';
                    statusEl.style.background = '#ffebee';
                    statusEl.style.color = '#c62828';
                }
            }

            // æ¯”è¼ƒã‚µãƒãƒªãƒ¼ï¼ˆæ—¥æ¬¡ãƒ»æœˆæ¬¡è¡¨ç¤ºï¼‰
            if (summary) {
                var numMonths = stActiveMonths.length || 12;
                var OPERATING_DAYS = 25;
                var custSalesMonthly = Math.round(totalCustomerSales / numMonths);
                var custSalesDaily = Math.round(custSalesMonthly / OPERATING_DAYS);
                var mqSalesMonthly = Math.round(totalMqSales / numMonths);
                var mqSalesDaily = Math.round(mqSalesMonthly / OPERATING_DAYS);
                var diffMonthly = Math.round(salesDiff / numMonths);
                var diffDaily = Math.round(diffMonthly / OPERATING_DAYS);
                var totalQMonthly = Math.round(totalQ / numMonths);
                var totalQDaily = Math.round(totalQMonthly / OPERATING_DAYS);
                var totalProfitMonthly = Math.round(totalProfit / numMonths);
                var totalProfitDaily = Math.round(totalProfitMonthly / OPERATING_DAYS);

                var summaryHtml = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px;">';

                // é¡§å®¢äºˆç®—å£²ä¸Š
                summaryHtml += '<div style="text-align:center;padding:12px;background:#e3f2fd;border-radius:6px;">';
                summaryHtml += '<div style="font-size:10px;color:#666;">é¡§å®¢äºˆç®—å£²ä¸Š</div>';
                summaryHtml += '<div style="font-size:22px;font-weight:bold;color:#1565c0;">' + fmtYen(custSalesDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
                summaryHtml += '<div style="font-size:10px;color:#888;">æœˆ ' + fmtYen(custSalesMonthly) + 'å††</div>';
                summaryHtml += '</div>';

                // MQç®—å‡ºå£²ä¸Š
                summaryHtml += '<div style="text-align:center;padding:12px;background:#f3e5f5;border-radius:6px;">';
                summaryHtml += '<div style="font-size:10px;color:#666;">MQç®—å‡ºå£²ä¸Š</div>';
                summaryHtml += '<div style="font-size:22px;font-weight:bold;color:#7b1fa2;">' + fmtYen(mqSalesDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
                summaryHtml += '<div style="font-size:10px;color:#888;">æœˆ ' + fmtYen(mqSalesMonthly) + 'å††</div>';
                summaryHtml += '</div>';

                // å£²ä¸Šå·®ç•°
                summaryHtml += '<div style="text-align:center;padding:12px;background:' + (salesDiff >= 0 ? '#e8f5e9' : '#ffebee') + ';border-radius:6px;">';
                summaryHtml += '<div style="font-size:10px;color:#666;">å£²ä¸Šå·®ç•°</div>';
                summaryHtml += '<div style="font-size:22px;font-weight:bold;color:' + totalDiffColor + ';">' + (diffDaily >= 0 ? '+' : '') + fmtYen(diffDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
                summaryHtml += '<div style="font-size:10px;color:#888;">æœˆ ' + (diffMonthly >= 0 ? '+' : '') + fmtYen(diffMonthly) + 'å††ï¼ˆ' + salesDiffRate + '%ï¼‰</div>';
                summaryHtml += '</div>';

                // MQç›®æ¨™å®¢æ•°
                summaryHtml += '<div style="text-align:center;padding:12px;background:#fff3e0;border-radius:6px;">';
                summaryHtml += '<div style="font-size:10px;color:#666;">MQç›®æ¨™å®¢æ•°</div>';
                summaryHtml += '<div style="font-size:22px;font-weight:bold;color:#e65100;">' + fmt(totalQDaily) + '<span style="font-size:12px;">äºº/æ—¥</span></div>';
                summaryHtml += '<div style="font-size:10px;color:#888;">æœˆ ' + fmt(totalQMonthly) + 'äºº</div>';
                summaryHtml += '</div>';

                // ç›®æ¨™å–¶æ¥­åˆ©ç›Š
                summaryHtml += '<div style="text-align:center;padding:12px;background:' + (totalProfit >= 0 ? '#e8f5e9' : '#ffebee') + ';border-radius:6px;">';
                summaryHtml += '<div style="font-size:10px;color:#666;">ç›®æ¨™å–¶æ¥­åˆ©ç›Š</div>';
                summaryHtml += '<div style="font-size:22px;font-weight:bold;color:' + (totalProfit >= 0 ? '#2e7d32' : '#c62828') + ';">' + fmtYen(totalProfitDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
                summaryHtml += '<div style="font-size:10px;color:#888;">æœˆ ' + fmtYen(totalProfitMonthly) + 'å††</div>';
                summaryHtml += '</div>';

                summaryHtml += '</div>';

                // æ³¨é‡ˆï¼ˆå–¶æ¥­æ—¥æ•°ã¨è¨ˆç®—å¼å®šç¾©ï¼‰
                summaryHtml += '<div style="text-align:right;font-size:9px;color:#999;margin-top:10px;line-height:1.6;">';
                summaryHtml += 'â€»å–¶æ¥­æ—¥æ•° ' + OPERATING_DAYS + 'æ—¥/æœˆ æƒ³å®š<br>';
                summaryHtml += 'â€»æœˆå¹³å‡ï¼å–è¾¼æœŸé–“åˆè¨ˆÃ·' + numMonths + 'ãƒ¶æœˆã€€æ—¥å¹³å‡ï¼æœˆå¹³å‡Ã·' + OPERATING_DAYS + 'æ—¥';
                summaryHtml += '</div>';

                // è§£èª¬
                summaryHtml += '<div style="margin-top:12px;padding:10px;background:#fafafa;border-radius:4px;font-size:11px;color:#666;">';
                summaryHtml += '<strong>è§£èª¬ï¼š</strong> MQç®—å‡ºå£²ä¸Šã¯ã€Œç›®æ¨™å–¶æ¥­åˆ©ç›Šï¼ˆGï¼‰ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªå£²ä¸Šã€ã§ã™ã€‚';
                if (salesDiff > 0) {
                    summaryHtml += '<br>é¡§å®¢äºˆç®—ã‚ˆã‚ŠMQå£²ä¸ŠãŒé«˜ã„å ´åˆã€åˆ©ç›Šç›®æ¨™é”æˆã«ã¯å£²ä¸Šå¢—ã‹è²»ç”¨å‰Šæ¸›ãŒå¿…è¦ã§ã™ã€‚';
                } else if (salesDiff < 0) {
                    summaryHtml += '<br>é¡§å®¢äºˆç®—ã‚ˆã‚ŠMQå£²ä¸ŠãŒä½ã„å ´åˆã€äºˆç®—é”æˆæ™‚ã«ç›®æ¨™åˆ©ç›Šã‚’ä¸Šå›ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                } else {
                    summaryHtml += '<br>äºˆç®—ã¨é€†ç®—å€¤ãŒã»ã¼ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚';
                }
                summaryHtml += '</div>';
                summary.innerHTML = summaryHtml;
            }

            container.style.display = 'block';
        }

        // MQè¨ˆç®—çµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤ºï¼ˆäºˆç®—è©¦ç®—ã‚¿ãƒ–ç”¨ï¼‰- æ—§UIäº’æ›ç”¨
        function renderSimMQResultSummary() {
            // æ–°UIã§ã¯renderSimMQComparisonResultã‚’ä½¿ç”¨
            renderSimMQComparisonResult();
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨MQé€†ç®—
        function runSimMQSimulation() {
            if (!simulationData || !simulationData.rakumyInputs) return;

            simulationData.mqOutputs = {};
            for (var m in simulationData.rakumyInputs) {
                var r = simulationData.rakumyInputs[m];

                var fixedCost = r.fixedCostTotal || 0;
                var variableRate = ((r.fdRate || 0) + (r.paRate || 0)) / 100;
                var targetProfit = r.targetProfit || 0;
                var targetUnitPrice = r.targetUnitPrice || 4500;

                // MQé€†ç®—å¼
                var requiredGrossProfit = fixedCost + targetProfit;
                var grossProfitRate = 1 - variableRate;
                var requiredSales = grossProfitRate > 0 ? requiredGrossProfit / grossProfitRate : 0;
                var targetCustomers = targetUnitPrice > 0 ? Math.round(requiredSales * 1000 / targetUnitPrice) : 0;
                var sales = targetCustomers * targetUnitPrice / 1000;
                var variableCost = sales * variableRate;
                var grossProfit = sales - variableCost;
                var operatingProfit = grossProfit - fixedCost;

                simulationData.mqOutputs[m] = {
                    sales: Math.round(sales),
                    customers: targetCustomers,
                    unitPrice: targetUnitPrice,
                    variableCost: Math.round(variableCost),
                    variableRate: variableRate * 100,
                    grossProfit: Math.round(grossProfit),
                    grossProfitRate: sales > 0 ? grossProfit / sales * 100 : 0,
                    fixedCost: Math.round(fixedCost),
                    operatingProfit: Math.round(operatingProfit),
                    operatingProfitRate: sales > 0 ? operatingProfit / sales * 100 : 0,
                    targetProfit: targetProfit,
                    requiredGrossProfit: Math.round(requiredGrossProfit),
                    requiredSales: Math.round(requiredSales)
                };
            }
        }

        // â˜… å¹´ãƒ»æœˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
        function initSimYearMonth() {
            var simYear = document.getElementById('simYear');
            var simMonth = document.getElementById('simMonth');
            if (!simYear || !simMonth) return;

            // å¹´åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç¾åœ¨å¹´åº¦ Â± 1å¹´ï¼‰
            var now = new Date();
            var currentYear = now.getFullYear();
            var currentMonth = now.getMonth() + 1;
            var fiscalYear = currentMonth >= 4 ? currentYear : currentYear - 1;

            simYear.innerHTML = '';
            for (var y = fiscalYear - 1; y <= fiscalYear + 1; y++) {
                var opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y + 'å¹´åº¦';
                if (y === fiscalYear) opt.selected = true;
                simYear.appendChild(opt);
            }

            updateSimMonthOptions();
        }

        // â˜… æœˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°
        function updateSimMonthOptions() {
            var simMonth = document.getElementById('simMonth');
            if (!simMonth) return;

            simMonth.innerHTML = '';
            var months = ['4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ','1æœˆ','2æœˆ','3æœˆ'];
            months.forEach(function(m, i) {
                var opt = document.createElement('option');
                opt.value = i;
                opt.textContent = m;
                simMonth.appendChild(opt);
            });
        }

        // â˜… è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¤‰æ›´
        var customSelectedMonths = []; // è¤‡æ•°æœˆé¸æŠç”¨
        function changeDisplayMode() {
            var mode = document.getElementById('simDisplayMode').value;
            var singleSelector = document.getElementById('singleMonthSelector');
            var multiSelector = document.getElementById('multiMonthSelector');

            // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
            if (singleSelector) singleSelector.style.display = (mode === 'single') ? 'flex' : 'none';
            if (multiSelector) multiSelector.style.display = (mode === 'custom') ? 'block' : 'none';

            renderLinkedSimulation();
        }

        // â˜… è¤‡æ•°æœˆé¸æŠæ›´æ–°
        function updateCustomMonths() {
            customSelectedMonths = [];
            var checkboxes = document.querySelectorAll('.monthCheck:checked');
            checkboxes.forEach(function(cb) {
                customSelectedMonths.push(parseInt(cb.value));
            });
            customSelectedMonths.sort(function(a, b) { return a - b; });
            renderLinkedSimulation();
        }

        // â˜… å…¨æœˆé¸æŠ
        function selectAllMonths() {
            var checkboxes = document.querySelectorAll('.monthCheck');
            checkboxes.forEach(function(cb) { cb.checked = true; });
            updateCustomMonths();
        }

        // â˜… å…¨æœˆã‚¯ãƒªã‚¢
        function clearAllMonths() {
            var checkboxes = document.querySelectorAll('.monthCheck');
            checkboxes.forEach(function(cb) { cb.checked = false; });
            updateCustomMonths();
        }

        // â˜… å‰æœˆãƒ»æ¬¡æœˆãƒœã‚¿ãƒ³
        function prevSimMonth() {
            var simMonth = document.getElementById('simMonth');
            if (!simMonth) return;
            var idx = parseInt(simMonth.value);
            if (idx > 0) {
                simMonth.value = idx - 1;
                renderLinkedSimulation();
            }
        }

        function nextSimMonth() {
            var simMonth = document.getElementById('simMonth');
            if (!simMonth) return;
            var idx = parseInt(simMonth.value);
            if (idx < 11) {
                simMonth.value = idx + 1;
                renderLinkedSimulation();
            }
        }

        // â˜… è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰æœˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é…åˆ—ã‚’å–å¾—
        function getMonthIndicesFromMode() {
            var mode = document.getElementById('simDisplayMode');
            var selectedMode = mode ? mode.value : 'all';

            switch (selectedMode) {
                case 'all': return [0,1,2,3,4,5,6,7,8,9,10,11];
                case '1H': return [0,1,2,3,4,5]; // ä¸ŠåŠæœŸ: 4-9æœˆ
                case '2H': return [6,7,8,9,10,11]; // ä¸‹åŠæœŸ: 10-3æœˆ
                case 'Q1': return [0,1,2]; // Q1: 4-6æœˆ
                case 'Q2': return [3,4,5]; // Q2: 7-9æœˆ
                case 'Q3': return [6,7,8]; // Q3: 10-12æœˆ
                case 'Q4': return [9,10,11]; // Q4: 1-3æœˆ
                case 'single':
                    var simMonth = document.getElementById('simMonth');
                    var idx = simMonth ? parseInt(simMonth.value) : 0;
                    return [idx];
                case 'custom':
                    return customSelectedMonths.length > 0 ? customSelectedMonths : [0];
                default: return [0,1,2,3,4,5,6,7,8,9,10,11];
            }
        }

        // â˜… é€£å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æç”»ï¼ˆç·¨é›†â†’é€£å‹•ãƒ•ãƒ­ãƒ¼å½¢å¼ï¼‰
        function renderLinkedSimulation() {
            var container = document.getElementById('linkedSimulationView');
            if (!container || !simulationData.annualData) {
                if (container) container.innerHTML = '<div style="text-align:center;padding:50px;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            var allMonths = ['4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ','1æœˆ','2æœˆ','3æœˆ'];
            var get = function(no, m) { return simulationData.annualData[no] ? (simulationData.annualData[no][m] || 0) : 0; };

            // æœˆé¸æŠã®å–å¾—
            var monthIndices = getMonthIndicesFromMode();

            // åˆè¨ˆãƒ©ãƒ™ãƒ«
            var modeSelect = document.getElementById('simDisplayMode');
            var currentMode = modeSelect ? modeSelect.value : 'all';
            var totalLabel = 'åˆè¨ˆ';
            switch (currentMode) {
                case 'all': totalLabel = 'å¹´é–“'; break;
                case '1H': totalLabel = 'ä¸ŠåŠæœŸ'; break;
                case '2H': totalLabel = 'ä¸‹åŠæœŸ'; break;
                case 'Q1': totalLabel = 'Q1'; break;
                case 'Q2': totalLabel = 'Q2'; break;
                case 'Q3': totalLabel = 'Q3'; break;
                case 'Q4': totalLabel = 'Q4'; break;
                case 'custom': totalLabel = 'é¸æŠæœŸé–“'; break;
                default: totalLabel = '';
            }

            // â˜… MQè¨ˆç®—çµæœã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆå…ˆã«å®šç¾©ï¼‰
            var getMQ = function(m, field) {
                return simulationData.mqOutputs && simulationData.mqOutputs[m] ? (simulationData.mqOutputs[m][field] || 0) : 0;
            };
            var getRI = function(m, field) {
                return simulationData.rakumyInputs && simulationData.rakumyInputs[m] ? (simulationData.rakumyInputs[m][field] || 0) : 0;
            };

            // ========== ã‚µãƒãƒªãƒ¼è¨ˆç®—ï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰==========
            var custSales = 0, custProfit = 0;
            monthIndices.forEach(function(m) {
                custSales += get(4, m);
                custProfit += get(63, m);
            });

            var mqSales = 0, mqProfit = 0, mqCustomers = 0;
            monthIndices.forEach(function(m) {
                mqSales += getMQ(m, 'sales') || 0;
                mqProfit += getMQ(m, 'operatingProfit') || 0;
                mqCustomers += getMQ(m, 'customers') || 0;
            });

            var salesDiff = custSales - mqSales;
            var isAchievable = salesDiff >= 0;
            var judgmentText = isAchievable ? 'âœ… äºˆç®—é”æˆå¯èƒ½' : 'âš ï¸ å£²ä¸Šä¸è¶³';
            var judgmentColor = isAchievable ? '#2e7d32' : '#c62828';
            var judgmentBg = isAchievable ? '#e8f5e9' : '#ffebee';

            // é¡§å®¢äºˆç®—é …ç›®å®šç¾©ï¼ˆå…¨é …ç›®ï¼‰
            var customerItems = [
                // å£²ä¸Š
                { section: 'å£²ä¸Š', no: 1, name: 'åº—èˆ—å£²ä¸Šé«˜' },
                { section: 'å£²ä¸Š', no: 2, name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š' },
                { section: 'å£²ä¸Š', no: 3, name: 'ãã®ä»–å£²ä¸Šé«˜' },
                { section: 'å£²ä¸Š', no: 4, name: 'å£²ä¸Šé«˜åˆè¨ˆ', highlight: true },
                // åŸä¾¡
                { section: 'åŸä¾¡', no: 5, name: 'é£ŸææœŸé¦–æ£š' },
                { section: 'åŸä¾¡', no: 6, name: 'é£Ÿæä»•å…¥é«˜' },
                { section: 'åŸä¾¡', no: 7, name: 'é£ŸææœŸæœ«æ£š' },
                { section: 'åŸä¾¡', no: 8, name: 'é£ŸæåŸä¾¡' },
                { section: 'åŸä¾¡', no: 9, name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸé¦–æ£š' },
                { section: 'åŸä¾¡', no: 10, name: 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜' },
                { section: 'åŸä¾¡', no: 11, name: 'ãƒ‰ãƒªãƒ³ã‚¯æœŸæœ«æ£š' },
                { section: 'åŸä¾¡', no: 12, name: 'ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡' },
                { section: 'åŸä¾¡', no: 13, name: 'å†…éƒ¨æŒ¯æ›¿' },
                { section: 'åŸä¾¡', no: 14, name: 'åŸä¾¡åˆè¨ˆ', highlight: true },
                { section: 'åŸä¾¡', no: 15, name: 'å£²ä¸Šç·åˆ©ç›Š', highlight: true },
                // äººä»¶è²»
                { section: 'äººä»¶è²»', no: 16, name: 'çµ¦æ–™æ‰‹å½“' },
                { section: 'äººä»¶è²»', no: 17, name: 'åº—é•·æ–™ç†é•·æ˜‡çµ¦' },
                { section: 'äººä»¶è²»', no: 18, name: 'ç¤¾å“¡çµ¦ä¸' },
                { section: 'äººä»¶è²»', no: 19, name: 'é›‘çµ¦ï¼ˆPAï¼‰' },
                { section: 'äººä»¶è²»', no: 20, name: 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»' },
                { section: 'äººä»¶è²»', no: 21, name: 'æ³•å®šç¦åˆ©è²»' },
                { section: 'äººä»¶è²»', no: 22, name: 'é€šå‹¤äº¤é€šè²»' },
                { section: 'äººä»¶è²»', no: 23, name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥' },
                { section: 'äººä»¶è²»', no: 24, name: 'ç¤¾å®…å®¶è³ƒ' },
                { section: 'äººä»¶è²»', no: 25, name: 'ä¼‘æ¥­æ‰‹å½“' },
                { section: 'äººä»¶è²»', no: 26, name: 'äººä»¶è²»åˆè¨ˆ', highlight: true },
                // å›ºå®šè²»ï¼ˆãã®ä»–çµŒè²» + å¾“æ¥ã®å›ºå®šè²»ï¼‰
                { section: 'å›ºå®šè²»', no: 27, name: 'è²©å£²ä¿ƒé€²è²»' },
                { section: 'å›ºå®šè²»', no: 28, name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼' },
                { section: 'å›ºå®šè²»', no: 29, name: 'èª¿æŸ»è²»' },
                { section: 'å›ºå®šè²»', no: 30, name: 'è¡›ç”Ÿè²»' },
                { section: 'å›ºå®šè²»', no: 31, name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»' },
                { section: 'å›ºå®šè²»', no: 32, name: 'é›»æ°—ä»£' },
                { section: 'å›ºå®šè²»', no: 33, name: 'ã‚¬ã‚¹ä»£' },
                { section: 'å›ºå®šè²»', no: 34, name: 'æ°´é“ä»£' },
                { section: 'å›ºå®šè²»', no: 35, name: 'æ¶ˆè€—å“è²»' },
                { section: 'å›ºå®šè²»', no: 36, name: 'ä¿å®ˆä¿®ç¹•è²»' },
                { section: 'å›ºå®šè²»', no: 37, name: 'ç§Ÿç¨å…¬èª²' },
                { section: 'å›ºå®šè²»', no: 38, name: 'æ¥å¾…äº¤éš›è²»' },
                { section: 'å›ºå®šè²»', no: 39, name: 'æ—…è²»äº¤é€šè²»' },
                { section: 'å›ºå®šè²»', no: 40, name: 'é€šä¿¡è²»' },
                { section: 'å›ºå®šè²»', no: 41, name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™' },
                { section: 'å›ºå®šè²»', no: 42, name: 'æ”¯æ‰•æ‰‹æ•°æ–™' },
                { section: 'å›ºå®šè²»', no: 43, name: 'ä¼šè­°è²»' },
                { section: 'å›ºå®šè²»', no: 44, name: 'è«¸ä¼šè²»' },
                { section: 'å›ºå®šè²»', no: 45, name: 'å›³æ›¸æ•™è‚²è²»' },
                { section: 'å›ºå®šè²»', no: 46, name: 'ç ”ä¿®è²»' },
                { section: 'å›ºå®šè²»', no: 47, name: 'æ¥­æ…‹ç ”ç©¶è²»' },
                { section: 'å›ºå®šè²»', no: 48, name: 'æ¡ç”¨è²»' },
                { section: 'å›ºå®šè²»', no: 49, name: 'ITè²»' },
                { section: 'å›ºå®šè²»', no: 50, name: 'å¤–æ³¨è²»' },
                { section: 'å›ºå®šè²»', no: 51, name: 'é›‘è²»' },
                { section: 'å›ºå®šè²»', no: 52, name: 'ãã®ä»–çµŒè²»å°è¨ˆ', highlight: true },
                { section: 'å›ºå®šè²»', no: 53, name: 'ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£' },
                { section: 'å›ºå®šè²»', no: 54, name: 'åº—èˆ—è£œå¡«' },
                { section: 'å›ºå®šè²»', no: 55, name: 'æ¸›ä¾¡å„Ÿå´è²»' },
                { section: 'å›ºå®šè²»', no: 56, name: 'å®¶è³ƒ' },
                { section: 'å›ºå®šè²»', no: 57, name: 'è­¦å‚™æ–™' },
                { section: 'å›ºå®šè²»', no: 58, name: 'ãƒªãƒ¼ã‚¹æ–™' },
                { section: 'å›ºå®šè²»', no: 59, name: 'è³ƒå€Ÿæ–™' },
                // æç›Š
                { section: 'æç›Š', no: 60, name: 'è²©ç®¡è²»åˆè¨ˆ', highlight: true },
                { section: 'æç›Š', no: 63, name: 'å–¶æ¥­åˆ©ç›Š', highlight: true, profit: true }
            ];

            // ========== ãƒ©ã‚¯ãƒŸãƒ¼MQè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆCSVä»•æ§˜æº–æ‹ ï¼‰ ==========
            // å¹´é–“åˆè¨ˆã‚’è¨ˆç®—
            var calcAnnualTotal = function(no) {
                var total = 0;
                for (var m = 0; m < 12; m++) total += get(no, m);
                return total;
            };

            // å¹´é–“å£²ä¸Š
            var annualSales = calcAnnualTotal(4);

            // FDä»•å…¥è²»ï¼ˆé£ŸæåŸä¾¡+ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡ï¼‰
            var annualFDCost = calcAnnualTotal(8) + calcAnnualTotal(12);
            var fdCostRate = annualSales > 0 ? annualFDCost / annualSales : 0;

            // PAäººä»¶è²»ï¼ˆé›‘çµ¦ã®ã¿ã€‚ãƒ˜ãƒ«ãƒ—äººä»¶è²»ã¯ç¤¾å“¡å¿œæ´è²»ç”¨ã®ãŸã‚å›ºå®šè²»ã¨ã—ã¦åˆ¥é€”è¨ˆä¸Šï¼‰
            var annualPACost = calcAnnualTotal(19);
            var paCostRate = annualSales > 0 ? annualPACost / annualSales : 0;

            // å¤‰å‹•è²»åˆè¨ˆ = FDä»•å…¥è²» + PAäººä»¶è²»
            var variableCostRate = fdCostRate + paCostRate;

            // å›ºå®šäººä»¶è²»ï¼ˆçµ¦æ–™æ‰‹å½“+åº—é•·æ˜‡çµ¦+ç¤¾å“¡çµ¦ä¸+æ³•å®šç¦åˆ©è²»+é€šå‹¤äº¤é€šè²»+è³ä¸å¼•å½“é‡‘+ç¤¾å®…å®¶è³ƒ+ä¼‘æ¥­æ‰‹å½“ï¼‰
            var calcFixedLabor = function(m) {
                return get(16,m) + get(17,m) + get(18,m) + get(21,m) + get(22,m) + get(23,m) + get(24,m) + get(25,m);
            };
            var annualFixedLabor = 0;
            for (var m = 0; m < 12; m++) annualFixedLabor += calcFixedLabor(m);

            // åœ°ä»£å®¶è³ƒï¼ˆå®¶è³ƒ+è³ƒå€Ÿæ–™ï¼‰
            var calcRent = function(m) { return get(56,m) + get(59,m); };
            var annualRent = calcAnnualTotal(56) + calcAnnualTotal(59);

            // è³‡æè²»ï¼ˆè­¦å‚™æ–™+ãƒªãƒ¼ã‚¹æ–™ï¼‰
            var calcMaterial = function(m) { return get(57,m) + get(58,m); };
            var annualMaterial = calcAnnualTotal(57) + calcAnnualTotal(58);

            // æ¸›ä¾¡å„Ÿå´è²»
            var annualDepreciation = calcAnnualTotal(55);

            // ãã®ä»–çµŒè²»ï¼ˆè²©å£²ä¿ƒé€²è²»ã€œé›‘è²»ï¼šNo.27-51ã®åˆè¨ˆï¼‰- å›ºå®šè²»ã¨ã—ã¦æ‰±ã†
            var calcOtherExp = function(m) {
                var sum = 0;
                for (var i = 27; i <= 51; i++) sum += get(i, m);
                return sum;
            };
            var annualOtherExp = 0;
            for (var m = 0; m < 12; m++) annualOtherExp += calcOtherExp(m);

            // å›ºå®šè²»åˆè¨ˆ = å›ºå®šäººä»¶è²» + åœ°ä»£å®¶è³ƒ + è³‡æè²» + æ¸›ä¾¡å„Ÿå´è²» + ãã®ä»–çµŒè²»
            var annualFixedCost = annualFixedLabor + annualRent + annualMaterial + annualDepreciation + annualOtherExp;

            // é™ç•Œåˆ©ç›Š = å£²ä¸Š - å¤‰å‹•è²»
            var annualVariableCost = annualSales * variableCostRate;
            var annualMarginalProfit = annualSales - annualVariableCost;

            // å–¶æ¥­åˆ©ç›Š = é™ç•Œåˆ©ç›Š - å›ºå®šè²»
            var annualOperatingProfit = annualMarginalProfit - annualFixedCost;

            // ç²—åˆ©ç‡
            var grossProfitRate = 1 - variableCostRate;

            // å£²ä¸Šæ§‹æˆæ¯”
            var annualFoodSales = calcAnnualTotal(1);
            var annualDrinkSales = calcAnnualTotal(2);
            var annualOtherSales = calcAnnualTotal(3);
            var foodSalesRate = annualSales > 0 ? annualFoodSales / annualSales : 0;
            var drinkSalesRate = annualSales > 0 ? annualDrinkSales / annualSales : 0;
            var otherSalesRate = annualSales > 0 ? annualOtherSales / annualSales : 0;

            // MQå˜ä¾¡è¨ˆç®—
            var avgMonthlySales = annualSales / 12;
            var assumedCustomers = avgMonthlySales > 0 ? Math.round(avgMonthlySales / 3) : 100;
            var unitPrice = assumedCustomers > 0 ? avgMonthlySales / assumedCustomers : 0;
            var variableUnitCost = unitPrice * variableCostRate;
            var grossProfitUnit = unitPrice - variableUnitCost;

            // â˜… MQè¨ˆç®—çµæœã‚’å–å¾—ã™ã‚‹é–¢æ•°
            var getMQ = function(m, field) {
                return simulationData.mqOutputs && simulationData.mqOutputs[m] ? (simulationData.mqOutputs[m][field] || 0) : 0;
            };

            // â˜… rakumyInputsã‚’å–å¾—ã™ã‚‹é–¢æ•°
            var getRI = function(m, field) {
                return simulationData.rakumyInputs && simulationData.rakumyInputs[m] ? (simulationData.rakumyInputs[m][field] || 0) : 0;
            };

            // ãƒ©ã‚¯ãƒŸãƒ¼äºˆç®—é …ç›®ï¼ˆâ˜… MQè¨ˆç®—çµæœã‚’ä½¿ç”¨ï¼‰
            var rakumyItems = [
                // â˜…â˜…â˜… MQè©¦ç®—çµæœï¼ˆé¡§å®¢ã«ã¨ã£ã¦æœ€é‡è¦ï¼ï¼‰â˜…â˜…â˜…
                { section: 'MQè©¦ç®—çµæœ', name: 'ğŸ¯ ç›®æ¨™å®¢æ•°', highlight: true, isPerson: true, isCalc: true, calc: function(m) { return getMQ(m, 'customers'); } },
                { section: 'MQè©¦ç®—çµæœ', name: 'ğŸ’° å¿…è¦å£²ä¸Šï¼ˆç¨æŠœï¼‰', highlight: true, isCalc: true, calc: function(m) { return getMQ(m, 'sales'); } },
                { section: 'MQè©¦ç®—çµæœ', name: 'ğŸ“ˆ ç›®æ¨™å–¶æ¥­åˆ©ç›Š', highlight: true, isCalc: true, calc: function(m) { return getMQ(m, 'operatingProfit'); } },
                { section: 'MQè©¦ç®—çµæœ', name: 'å¿…è¦ç²—åˆ©ï¼ˆF+Gï¼‰', isCalc: true, calc: function(m) { return getMQ(m, 'requiredGrossProfit'); } },
                { section: 'MQè©¦ç®—çµæœ', name: 'ç²—åˆ©å˜ä¾¡ï¼ˆMï¼‰', isYen: true, isCalc: true, calc: function(m) {
                    var p = getRI(m, 'targetUnitPrice');
                    var vr = (getRI(m, 'fdRate') + getRI(m, 'paRate')) / 100;
                    return Math.round(p * (1 - vr));
                } },
                // å£²ä¸Šäºˆç®—ã¯ä¸Šã«çµ±åˆæ¸ˆã¿
                // å¤‰å‹•è²»äºˆç®—ï¼ˆâ˜… MQè¨ˆç®—çµæœã‚’ä½¿ç”¨ï¼‰
                { section: 'å¤‰å‹•è²»äºˆç®—', name: 'FDä»•å…¥è²»', calc: function(m) { return getMQ(m, 'sales') * fdCostRate; } },
                { section: 'å¤‰å‹•è²»äºˆç®—', name: 'PAäººä»¶è²»', calc: function(m) { return getMQ(m, 'sales') * paCostRate; } },
                { section: 'å¤‰å‹•è²»äºˆç®—', name: 'å¤‰å‹•è²»åˆè¨ˆ', highlight: true, calc: function(m) { return getMQ(m, 'variableCost'); } },
                // å›ºå®šäººä»¶è²»ï¼ˆPAäººä»¶è²»ã‚’é™¤ãäººä»¶è²»ï¼‰
                { section: 'å›ºå®šäººä»¶è²»', name: 'çµ¦æ–™æ‰‹å½“', calc: function(m) { return get(16, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'åº—é•·æ–™ç†é•·æ˜‡çµ¦', calc: function(m) { return get(17, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'ç¤¾å“¡çµ¦ä¸', calc: function(m) { return get(18, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'æ³•å®šç¦åˆ©è²»', calc: function(m) { return get(21, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'é€šå‹¤äº¤é€šè²»', calc: function(m) { return get(22, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥', calc: function(m) { return get(23, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'ç¤¾å®…å®¶è³ƒ', calc: function(m) { return get(24, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'ä¼‘æ¥­æ‰‹å½“', calc: function(m) { return get(25, m); } },
                { section: 'å›ºå®šäººä»¶è²»', name: 'å›ºå®šäººä»¶è²»åˆè¨ˆ', highlight: true, calc: function(m) { return calcFixedLabor(m); } },
                // å›ºå®šè²»ï¼ˆãã®ä»–çµŒè²» + å¾“æ¥ã®å›ºå®šè²»ï¼‰
                { section: 'å›ºå®šè²»', name: 'è²©å£²ä¿ƒé€²è²»', calc: function(m) { return get(27, m); } },
                { section: 'å›ºå®šè²»', name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', calc: function(m) { return get(28, m); } },
                { section: 'å›ºå®šè²»', name: 'èª¿æŸ»è²»', calc: function(m) { return get(29, m); } },
                { section: 'å›ºå®šè²»', name: 'è¡›ç”Ÿè²»', calc: function(m) { return get(30, m); } },
                { section: 'å›ºå®šè²»', name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', calc: function(m) { return get(31, m); } },
                { section: 'å›ºå®šè²»', name: 'é›»æ°—ä»£', calc: function(m) { return get(32, m); } },
                { section: 'å›ºå®šè²»', name: 'ã‚¬ã‚¹ä»£', calc: function(m) { return get(33, m); } },
                { section: 'å›ºå®šè²»', name: 'æ°´é“ä»£', calc: function(m) { return get(34, m); } },
                { section: 'å›ºå®šè²»', name: 'æ¶ˆè€—å“è²»', calc: function(m) { return get(35, m); } },
                { section: 'å›ºå®šè²»', name: 'ä¿å®ˆä¿®ç¹•è²»', calc: function(m) { return get(36, m); } },
                { section: 'å›ºå®šè²»', name: 'ç§Ÿç¨å…¬èª²', calc: function(m) { return get(37, m); } },
                { section: 'å›ºå®šè²»', name: 'æ¥å¾…äº¤éš›è²»', calc: function(m) { return get(38, m); } },
                { section: 'å›ºå®šè²»', name: 'æ—…è²»äº¤é€šè²»', calc: function(m) { return get(39, m); } },
                { section: 'å›ºå®šè²»', name: 'é€šä¿¡è²»', calc: function(m) { return get(40, m); } },
                { section: 'å›ºå®šè²»', name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', calc: function(m) { return get(41, m); } },
                { section: 'å›ºå®šè²»', name: 'æ”¯æ‰•æ‰‹æ•°æ–™', calc: function(m) { return get(42, m); } },
                { section: 'å›ºå®šè²»', name: 'ä¼šè­°è²»', calc: function(m) { return get(43, m); } },
                { section: 'å›ºå®šè²»', name: 'è«¸ä¼šè²»', calc: function(m) { return get(44, m); } },
                { section: 'å›ºå®šè²»', name: 'å›³æ›¸æ•™è‚²è²»', calc: function(m) { return get(45, m); } },
                { section: 'å›ºå®šè²»', name: 'ç ”ä¿®è²»', calc: function(m) { return get(46, m); } },
                { section: 'å›ºå®šè²»', name: 'æ¥­æ…‹ç ”ç©¶è²»', calc: function(m) { return get(47, m); } },
                { section: 'å›ºå®šè²»', name: 'æ¡ç”¨è²»', calc: function(m) { return get(48, m); } },
                { section: 'å›ºå®šè²»', name: 'ITè²»', calc: function(m) { return get(49, m); } },
                { section: 'å›ºå®šè²»', name: 'å¤–æ³¨è²»', calc: function(m) { return get(50, m); } },
                { section: 'å›ºå®šè²»', name: 'é›‘è²»', calc: function(m) { return get(51, m); } },
                { section: 'å›ºå®šè²»', name: 'ãã®ä»–çµŒè²»å°è¨ˆ', highlight: true, calc: function(m) { return calcOtherExp(m); } },
                { section: 'å›ºå®šè²»', name: 'ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£', calc: function(m) { return get(53, m); } },
                { section: 'å›ºå®šè²»', name: 'åº—èˆ—è£œå¡«', calc: function(m) { return get(54, m); } },
                { section: 'å›ºå®šè²»', name: 'æ¸›ä¾¡å„Ÿå´è²»', calc: function(m) { return get(55, m); } },
                { section: 'å›ºå®šè²»', name: 'å®¶è³ƒ', calc: function(m) { return get(56, m); } },
                { section: 'å›ºå®šè²»', name: 'è­¦å‚™æ–™', calc: function(m) { return get(57, m); } },
                { section: 'å›ºå®šè²»', name: 'ãƒªãƒ¼ã‚¹æ–™', calc: function(m) { return get(58, m); } },
                { section: 'å›ºå®šè²»', name: 'è³ƒå€Ÿæ–™', calc: function(m) { return get(59, m); } },
                { section: 'å›ºå®šè²»', name: 'å›ºå®šè²»åˆè¨ˆ', highlight: true, calc: function(m) {
                    // å…ƒã®MQè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼ˆãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£ãƒ»åº—èˆ—è£œå¡«ã¯å«ã¾ãªã„ï¼‰
                    return calcFixedLabor(m) + calcRent(m) + calcMaterial(m) + get(55, m) + calcOtherExp(m);
                } },
                // æç›Šï¼ˆâ˜… MQè¨ˆç®—çµæœã‚’ä½¿ç”¨ï¼‰
                { section: 'æç›Š', name: 'é™ç•Œåˆ©ç›Šï¼ˆå£²ä¸Š-å¤‰å‹•è²»ï¼‰', highlight: true, calc: function(m) {
                    return getMQ(m, 'grossProfit');
                } },
                { section: 'æç›Š', name: 'å–¶æ¥­åˆ©ç›Š', highlight: true, profit: true, calc: function(m) {
                    return getMQ(m, 'operatingProfit');
                } },
                // â˜…â˜…â˜… MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå‚ç…§ç”¨ãƒ»æœ€å¾Œã«é…ç½®ï¼‰â˜…â˜…â˜…
                { section: 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', name: 'å›ºå®šè²»ç”¨äºˆç®—ï¼ˆFï¼‰', isParam: true, calc: function(m) { return getRI(m, 'fixedCostTotal'); } },
                { section: 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', name: 'ç›®æ¨™æœˆæ¬¡åˆ©ç›Šï¼ˆGï¼‰', isParam: true, calc: function(m) { return getRI(m, 'targetProfit'); } },
                { section: 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', name: 'FDä»•å…¥è²»ç‡', isRate: true, isParam: true, calc: function(m) { return getRI(m, 'fdRate'); } },
                { section: 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', name: 'PAäººä»¶è²»ç‡', isRate: true, isParam: true, calc: function(m) { return getRI(m, 'paRate'); } },
                { section: 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', name: 'å¤‰å‹•è²»ç‡ï¼ˆFD+PAï¼‰', isRate: true, isParam: true, calc: function(m) { return getRI(m, 'fdRate') + getRI(m, 'paRate'); } },
                { section: 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', name: 'ç›®æ¨™å®¢å˜ä¾¡ï¼ˆPï¼‰', isYen: true, isParam: true, calc: function(m) { return getRI(m, 'targetUnitPrice'); } }
            ];

            // MQé€†ç®—ç”¨ã®å¤‰æ•°
            var requiredCustomers = grossProfitUnit > 0 ? Math.ceil((annualFixedCost + annualOperatingProfit) / grossProfitUnit / 12) : 0;
            var requiredSalesPerMonth = requiredCustomers * unitPrice;

            // ãƒ©ã‚¯ãƒŸãƒ¼äºˆç®—ã®å–¶æ¥­åˆ©ç›Šè¨ˆç®—é–¢æ•°ï¼ˆã‚µãƒãƒªãƒ¼ç”¨ï¼‰â˜… MQè¨ˆç®—çµæœã‚’ä½¿ç”¨
            var calcRakumyProfit = function(m) {
                return getMQ(m, 'operatingProfit');
            };

            // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆé–¢æ•°
            function buildTable(items, title, bgColor, isEditable) {
                var html = '<div style="margin-bottom:25px;">';
                html += '<h3 style="color:' + bgColor + ';font-size:14px;margin-bottom:10px;padding:8px;background:' + (isEditable ? '#e3f2fd' : '#f3e5f5') + ';border-radius:4px;">' + title + '</h3>';
                html += '<div style="overflow-x:auto;overflow-y:auto;max-height:600px;"><table class="data-table" style="font-size:10px;width:100%;">';

                // ãƒ˜ãƒƒãƒ€ãƒ¼
                html += '<thead style="position:sticky;top:0;z-index:10;"><tr style="background:#f5f5f5;">';
                html += '<th style="min-width:140px;background:' + bgColor + ';color:#fff;border:1px solid #ddd;">é …ç›®</th>';
                monthIndices.forEach(function(mi) {
                    html += '<th style="background:' + bgColor + ';color:#fff;border:1px solid #ddd;min-width:' + (isEditable ? '70px' : '60px') + ';">' + allMonths[mi] + '</th>';
                });
                html += '<th style="background:#ff9800;color:#fff;border:1px solid #ddd;min-width:80px;">' + totalLabel + 'åˆè¨ˆ</th>';
                html += '</tr></thead><tbody>';

                var lastSection = '';
                items.forEach(function(item) {
                    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼
                    if (item.section !== lastSection) {
                        var cols = monthIndices.length + 2;
                        var sectionBg = '#607d8b';
                        if (item.section === 'MQè©¦ç®—çµæœ') sectionBg = '#d32f2f';  // èµ¤ï¼ˆæœ€é‡è¦ï¼ï¼‰
                        if (item.section === 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿') sectionBg = '#78909c';  // ã‚°ãƒ¬ãƒ¼ï¼ˆå‚ç…§ç”¨ï¼‰
                        if (item.section === 'MQæŒ‡æ¨™') sectionBg = '#9c27b0';
                        if (item.section === 'MQå…¥åŠ›') sectionBg = '#4caf50';
                        if (item.section === 'MQé€†ç®—') sectionBg = '#ff9800';
                        if (item.section === 'å£²ä¸Šæ§‹æˆæ¯”') sectionBg = '#1976d2';
                        if (item.section === 'åŸä¾¡ç‡') sectionBg = '#ff5722';
                        html += '<tr><td colspan="' + cols + '" style="background:' + sectionBg + ';color:#fff;font-weight:bold;padding:5px 10px;font-size:11px;">' + item.section + '</td></tr>';
                        lastSection = item.section;
                    }

                    var rowBg = item.highlight ? '#fff8e1' : '#fff';
                    if (item.section === 'MQè©¦ç®—çµæœ') rowBg = item.highlight ? '#ffcdd2' : '#ffebee';  // èµ¤ç³»ï¼ˆç›®ç«‹ã¤ï¼‰
                    if (item.section === 'MQè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿') rowBg = '#eceff1';  // ã‚°ãƒ¬ãƒ¼ç³»ï¼ˆæ§ãˆã‚ï¼‰
                    if (item.section === 'å£²ä¸Šæ§‹æˆæ¯”') rowBg = '#e3f2fd';
                    if (item.section === 'åŸä¾¡ç‡') rowBg = '#fbe9e7';
                    if (item.section === 'MQæŒ‡æ¨™') rowBg = '#f3e5f5';
                    if (item.section === 'MQå…¥åŠ›') rowBg = item.highlight ? '#c8e6c9' : '#e8f5e9';
                    if (item.section === 'MQé€†ç®—') rowBg = item.highlight ? '#ffe0b2' : '#fff3e0';
                    html += '<tr style="background:' + rowBg + ';">';

                    // é …ç›®å
                    var label = item.no ? '[' + item.no + '] ' + item.name : item.name;
                    html += '<td style="font-weight:' + (item.highlight ? 'bold' : 'normal') + ';font-size:10px;white-space:nowrap;">' + label + '</td>';

                    // MQæŒ‡æ¨™ãƒ»å£²ä¸Šæ§‹æˆæ¯”ãƒ»åŸä¾¡ç‡ã¯å¹´é–“å€¤ã®ã¿ï¼ˆæœˆåˆ—ã¯çµåˆï¼‰
                    // â˜… MQå…¥åŠ›ã¨MQé€†ç®—ã¯æœˆåˆ¥å€¤ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
                    var isAnnualOnly = item.section === 'MQæŒ‡æ¨™' || item.section === 'å£²ä¸Šæ§‹æˆæ¯”' || item.section === 'åŸä¾¡ç‡';
                    if (isAnnualOnly) {
                        var mqVal = item.calc ? item.calc() : 0;
                        var displayVal = item.isRate ? mqVal.toFixed(1) + '%' : fmt(mqVal);
                        var valColor = item.profit ? (mqVal >= 0 ? '#2e7d32' : '#c62828') : '#7b1fa2';
                        html += '<td colspan="' + (monthIndices.length + 1) + '" style="text-align:center;font-weight:bold;font-size:14px;color:' + valColor + ';">' + displayVal + '</td>';
                    } else {
                        var total = 0;
                        var isRateItem = item.isRate;
                        monthIndices.forEach(function(m) {
                            var val = item.calc ? item.calc(m) : get(item.no, m);
                            if (!isRateItem) total += val;
                            else total = val; // ç‡ã¯æœ€å¾Œã®å€¤ã‚’ä½¿ç”¨

                            if (isEditable && item.no) {
                                // ç·¨é›†å¯èƒ½ã‚»ãƒ«ï¼ˆå††å˜ä½è¡¨ç¤ºï¼šå†…éƒ¨ãƒ‡ãƒ¼ã‚¿åƒå††Ã—1000ã§è¡¨ç¤ºï¼‰
                                var inputVal = Math.round(val * 1000);
                                html += '<td style="background:#e3f2fd;padding:2px;"><input type="number" data-no="' + item.no + '" data-month="' + m + '" data-yen="true" value="' + inputVal + '" style="width:100%;padding:3px;text-align:right;border:1px solid #90caf9;border-radius:2px;background:#fff;font-size:10px;box-sizing:border-box;" onchange="updateSimulationValue(this)"></td>';
                            } else {
                                // è¡¨ç¤ºã®ã¿ï¼ˆâ˜… å˜ä½ã«å¿œã˜ãŸè¡¨ç¤ºï¼‰
                                var valColor = item.profit ? (val >= 0 ? '#2e7d32' : '#c62828') : '#333';
                                if (item.isInput) valColor = '#2e7d32';  // å…¥åŠ›å€¤ã¯ç·‘
                                if (item.isCalc) valColor = '#c62828';   // MQè©¦ç®—çµæœã¯èµ¤ï¼ˆç›®ç«‹ã¤ï¼‰
                                if (item.isParam) valColor = '#607d8b';  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã‚°ãƒ¬ãƒ¼ï¼ˆæ§ãˆã‚ï¼‰
                                var displayVal;
                                if (item.isRate) {
                                    displayVal = val.toFixed(1) + '%';
                                } else if (item.isYen) {
                                    // å®¢å˜ä¾¡(P)ãƒ»ç²—åˆ©å˜ä¾¡(M)ã¯æ—¢ã«å††å˜ä½
                                    displayVal = fmt(val) + 'å††';
                                } else if (item.isPerson) {
                                    displayVal = fmt(val) + 'äºº';
                                } else {
                                    // ãã®ä»–é‡‘é¡ã¯åƒå††å˜ä½â†’å††å˜ä½è¡¨ç¤º
                                    displayVal = fmtYen(val);
                                }
                                html += '<td style="text-align:right;color:' + valColor + ';font-weight:' + (item.highlight ? 'bold' : 'normal') + ';">' + displayVal + '</td>';
                            }
                        });

                        // åˆè¨ˆ
                        var totalColor = item.profit ? (total >= 0 ? '#2e7d32' : '#c62828') : '#333';
                        var totalDisplay;
                        if (item.isRate) {
                            totalDisplay = '-';  // ç‡ã¯åˆè¨ˆä¸è¦
                        } else if (item.isYen) {
                            totalDisplay = '-';  // å††å˜ä½ã‚‚åˆè¨ˆä¸è¦
                        } else if (item.isPerson) {
                            totalDisplay = fmt(total) + 'äºº';
                        } else {
                            // ãã®ä»–é‡‘é¡ã¯åƒå††å˜ä½â†’å††å˜ä½è¡¨ç¤º
                            totalDisplay = fmtYen(total);
                        }
                        html += '<td style="text-align:right;background:#ffe0b2;font-weight:bold;color:' + totalColor + ';">' + totalDisplay + '</td>';
                    }
                    html += '</tr>';
                });

                html += '</tbody></table></div></div>';
                return html;
            }

            // ========== é¡§å®¢äºˆç®—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ« ==========
            function buildCompactEditTable(items, monthIndices, allMonths, totalLabel, get) {
                // MQè¨ˆç®—ã«å½±éŸ¿ã™ã‚‹æ˜ç´°é …ç›®ã®ã¿ï¼ˆåˆè¨ˆè¡Œã¯è¡¨ç¤ºã®ã¿ï¼‰
                var editableItems = [
                    // å£²ä¸Šæ˜ç´°ï¼ˆç·¨é›†å¯èƒ½ï¼‰
                    { section: 'å£²ä¸Š', no: 1, name: 'åº—èˆ—å£²ä¸Šé«˜', editable: true },
                    { section: 'å£²ä¸Š', no: 2, name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š', editable: true },
                    { section: 'å£²ä¸Š', no: 3, name: 'ãã®ä»–å£²ä¸Šé«˜', editable: true },
                    { section: 'å£²ä¸Š', no: 4, name: 'å£²ä¸Šé«˜åˆè¨ˆ', editable: false, isTotal: true },
                    // åŸä¾¡æ˜ç´°ï¼ˆç·¨é›†å¯èƒ½ï¼‰â†’ FDä»•å…¥è²»ç‡ã«å½±éŸ¿
                    { section: 'åŸä¾¡', no: 6, name: 'é£Ÿæä»•å…¥é«˜', editable: true, affects: 'FDç‡' },
                    { section: 'åŸä¾¡', no: 10, name: 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜', editable: true, affects: 'FDç‡' },
                    { section: 'åŸä¾¡', no: 14, name: 'åŸä¾¡åˆè¨ˆ', editable: false, isTotal: true },
                    // äººä»¶è²»æ˜ç´°ï¼ˆç·¨é›†å¯èƒ½ï¼‰â†’ PAäººä»¶è²»ç‡ã«å½±éŸ¿
                    { section: 'äººä»¶è²»', no: 19, name: 'é›‘çµ¦ï¼ˆPAäººä»¶è²»ï¼‰', editable: true, affects: 'PAç‡' },
                    { section: 'äººä»¶è²»', no: 16, name: 'çµ¦æ–™æ‰‹å½“ï¼ˆå›ºå®šï¼‰', editable: true, affects: 'å›ºå®šè²»' },
                    { section: 'äººä»¶è²»', no: 26, name: 'äººä»¶è²»åˆè¨ˆ', editable: false, isTotal: true },
                    // ä¸»è¦å›ºå®šè²»ï¼ˆç·¨é›†å¯èƒ½ï¼‰â†’ å›ºå®šè²»(F)ã«å½±éŸ¿
                    { section: 'å›ºå®šè²»', no: 56, name: 'å®¶è³ƒ', editable: true, affects: 'å›ºå®šè²»' },
                    { section: 'å›ºå®šè²»', no: 32, name: 'é›»æ°—ä»£', editable: true, affects: 'å›ºå®šè²»' },
                    { section: 'å›ºå®šè²»', no: 55, name: 'æ¸›ä¾¡å„Ÿå´è²»', editable: true, affects: 'å›ºå®šè²»' },
                    // ç›®æ¨™åˆ©ç›Šï¼ˆç·¨é›†å¯èƒ½ï¼‰â†’ ç›®æ¨™åˆ©ç›Š(G)ã«å½±éŸ¿
                    { section: 'ç›®æ¨™', no: 63, name: 'å–¶æ¥­åˆ©ç›Šï¼ˆç›®æ¨™ï¼‰', editable: true, affects: 'ç›®æ¨™G', isProfit: true }
                ];

                var html = '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
                html += '<thead><tr style="background:#1976d2;color:#fff;">';
                html += '<th style="padding:8px;text-align:left;min-width:120px;">é …ç›®</th>';
                monthIndices.forEach(function(mi) {
                    html += '<th style="padding:6px;min-width:60px;">' + allMonths[mi] + '</th>';
                });
                html += '<th style="padding:6px;background:#ff9800;min-width:70px;">' + totalLabel + '</th>';
                html += '</tr></thead><tbody>';

                var lastSection = '';
                editableItems.forEach(function(item) {
                    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼
                    if (item.section !== lastSection) {
                        var sectionBg = '#607d8b';
                        if (item.section === 'å£²ä¸Š') sectionBg = '#1976d2';
                        if (item.section === 'åŸä¾¡') sectionBg = '#ff5722';
                        if (item.section === 'äººä»¶è²»') sectionBg = '#9c27b0';
                        if (item.section === 'å›ºå®šè²»') sectionBg = '#795548';
                        if (item.section === 'ç›®æ¨™') sectionBg = '#4caf50';
                        html += '<tr><td colspan="' + (monthIndices.length + 2) + '" style="background:' + sectionBg + ';color:#fff;font-weight:bold;padding:5px 10px;font-size:10px;">' + item.section + '</td></tr>';
                        lastSection = item.section;
                    }

                    var rowBg = item.isTotal ? '#f5f5f5' : (item.editable ? '#fff' : '#fafafa');
                    if (item.isProfit) rowBg = '#e8f5e9';
                    html += '<tr style="background:' + rowBg + ';">';

                    // é …ç›®åï¼ˆå½±éŸ¿å…ˆã‚’è¡¨ç¤ºï¼‰
                    var label = '[' + item.no + '] ' + item.name;
                    if (item.affects) {
                        label += ' <span style="font-size:8px;color:#ff5722;">â†’' + item.affects + '</span>';
                    }
                    if (item.isTotal) {
                        label = '<span style="color:#666;">' + label + '</span>';
                    }
                    html += '<td style="padding:6px;font-weight:' + (item.isTotal ? 'bold' : 'normal') + ';font-size:10px;white-space:nowrap;">' + label + '</td>';

                    var total = 0;
                    monthIndices.forEach(function(m) {
                        var val = get(item.no, m);
                        total += val;

                        if (item.editable) {
                            // ç·¨é›†å¯èƒ½ã‚»ãƒ«ï¼ˆå††å˜ä½è¡¨ç¤ºï¼šå†…éƒ¨ãƒ‡ãƒ¼ã‚¿åƒå††Ã—1000ã§è¡¨ç¤ºï¼‰
                            var inputBg = item.isProfit ? '#c8e6c9' : '#e3f2fd';
                            var inputVal = Math.round(val * 1000);
                            html += '<td style="padding:2px;"><input type="number" data-no="' + item.no + '" data-month="' + m + '" data-yen="true" value="' + inputVal + '" style="width:100%;padding:4px;text-align:right;border:1px solid #90caf9;border-radius:3px;background:' + inputBg + ';font-size:10px;box-sizing:border-box;" onchange="updateSimulationValue(this)"></td>';
                        } else {
                            // è¡¨ç¤ºã®ã¿ï¼ˆåˆè¨ˆè¡Œï¼‰å††å˜ä½è¡¨ç¤º
                            html += '<td style="padding:6px;text-align:right;color:#666;font-weight:bold;background:#eee;">' + fmtYen(val) + '</td>';
                        }
                    });

                    // åˆè¨ˆï¼ˆå††å˜ä½è¡¨ç¤ºï¼‰
                    var totalColor = item.isProfit ? (total >= 0 ? '#2e7d32' : '#c62828') : '#333';
                    html += '<td style="padding:6px;text-align:right;background:#fff3e0;font-weight:bold;color:' + totalColor + ';">' + fmtYen(total) + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            // ========== MQçµæœãƒ†ãƒ¼ãƒ–ãƒ« ==========
            function buildMQResultTable(monthIndices, allMonths, totalLabel, getMQ, getRI) {
                var html = '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
                html += '<thead><tr style="background:#7b1fa2;color:#fff;">';
                html += '<th style="padding:8px;text-align:left;min-width:100px;">é …ç›®</th>';
                monthIndices.forEach(function(mi) {
                    html += '<th style="padding:6px;min-width:60px;">' + allMonths[mi] + '</th>';
                });
                html += '<th style="padding:6px;background:#ff9800;min-width:70px;">' + totalLabel + '</th>';
                html += '</tr></thead><tbody>';

                // MQè©¦ç®—çµæœã®ä¸»è¦é …ç›®
                var mqItems = [
                    { name: 'ğŸ¯ ç›®æ¨™å®¢æ•°', unit: 'äºº', field: 'customers', bg: '#ffebee', bold: true, isYen: false },
                    { name: 'ğŸ’° å¿…è¦å£²ä¸Š', unit: 'å††', field: 'sales', bg: '#f3e5f5', bold: true, isYen: true },
                    { name: 'ğŸ“ˆ ç›®æ¨™å–¶æ¥­åˆ©ç›Š', unit: 'å††', field: 'operatingProfit', bg: '#e8f5e9', bold: true, isYen: true },
                    { name: 'å¤‰å‹•è²»', unit: 'å††', field: 'variableCost', bg: '#fff', isYen: true },
                    { name: 'ç²—åˆ©', unit: 'å††', field: 'grossProfit', bg: '#fff', isYen: true }
                ];

                mqItems.forEach(function(item) {
                    html += '<tr style="background:' + item.bg + ';">';
                    html += '<td style="padding:6px;font-weight:' + (item.bold ? 'bold' : 'normal') + ';font-size:10px;">' + item.name + '</td>';

                    var total = 0;
                    monthIndices.forEach(function(m) {
                        var val = getMQ(m, item.field) || 0;
                        total += val;
                        var displayVal = item.isYen ? fmtYen(val) : fmt(val);
                        var color = item.bold ? '#7b1fa2' : '#333';
                        if (item.field === 'customers') color = '#e65100';
                        if (item.field === 'operatingProfit') color = val >= 0 ? '#2e7d32' : '#c62828';
                        html += '<td style="padding:6px;text-align:right;color:' + color + ';font-weight:' + (item.bold ? 'bold' : 'normal') + ';">' + displayVal + '</td>';
                    });

                    var totalColor = item.field === 'operatingProfit' ? (total >= 0 ? '#2e7d32' : '#c62828') : '#333';
                    if (item.field === 'customers') totalColor = '#e65100';
                    html += '<td style="padding:6px;text-align:right;background:#fff3e0;font-weight:bold;color:' + totalColor + ';">' + (item.isYen ? fmtYen(total) : fmt(total)) + '</td>';
                    html += '</tr>';
                });

                // MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå‚è€ƒï¼‰
                html += '<tr><td colspan="' + (monthIndices.length + 2) + '" style="padding:4px;background:#eceff1;font-size:9px;color:#666;text-align:center;">MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå‚è€ƒï¼‰</td></tr>';

                var paramItems = [
                    { name: 'å®¢å˜ä¾¡', field: 'targetUnitPrice', isYen: true },
                    { name: 'FDç‡', field: 'fdRate', isRate: true },
                    { name: 'PAç‡', field: 'paRate', isRate: true }
                ];

                paramItems.forEach(function(item) {
                    html += '<tr style="background:#f5f5f5;">';
                    html += '<td style="padding:4px;font-size:9px;color:#666;">' + item.name + '</td>';

                    monthIndices.forEach(function(m) {
                        var val = getRI(m, item.field) || 0;
                        var displayVal = item.isRate ? val.toFixed(1) + '%' : (item.isYen ? fmt(val) + 'å††' : fmt(val));
                        html += '<td style="padding:4px;text-align:right;font-size:9px;color:#888;">' + displayVal + '</td>';
                    });

                    html += '<td style="padding:4px;text-align:right;font-size:9px;color:#888;">-</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            // ========== å·®ç•°è¨ˆç®—ã¨åˆ¤å®š ==========
            var profitDiff = custProfit - mqProfit;
            var salesDiffRate = mqSales > 0 ? (salesDiff / mqSales * 100).toFixed(1) : 0;

            // çµè«–æ–‡
            var conclusionText = '';
            if (isAchievable) {
                conclusionText = 'é¡§å®¢äºˆç®—å£²ä¸Šï¼ˆ' + fmtYen(custSales) + 'å††ï¼‰ã§MQå¿…è¦å£²ä¸Šï¼ˆ' + fmtYen(mqSales) + 'å††ï¼‰ã‚’é”æˆå¯èƒ½ã§ã™ã€‚å£²ä¸Šä½™è£• +' + fmtYen(salesDiff) + 'å††';
            } else {
                conclusionText = 'MQå¿…è¦å£²ä¸Šï¼ˆ' + fmtYen(mqSales) + 'å††ï¼‰ã«å¯¾ã—ã€é¡§å®¢äºˆç®—å£²ä¸Šï¼ˆ' + fmtYen(custSales) + 'å††ï¼‰ãŒ ' + fmtYen(Math.abs(salesDiff)) + 'å†† ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å£²ä¸Šå¢—ã¾ãŸã¯è²»ç”¨å‰Šæ¸›ãŒå¿…è¦ã§ã™ã€‚';
            }

            var html = '';

            // ========== ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå·¦å³2ãƒ‘ãƒãƒ«ï¼ˆç·¨é›†â†’é€£å‹•ï¼‰==========
            html += '<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:0;margin-bottom:20px;">';

            // ========== å·¦ãƒ‘ãƒãƒ«ï¼šSTEP1 é¡§å®¢äºˆç®—ç·¨é›† ==========
            html += '<div style="background:#fff;border:3px solid #1976d2;border-radius:12px;overflow:hidden;">';
            html += '<div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%);color:#fff;padding:15px;text-align:center;">';
            html += '<div style="font-size:11px;font-weight:bold;opacity:0.9;">STEP 1</div>';
            html += '<div style="font-size:16px;font-weight:bold;">ğŸ“ é¡§å®¢äºˆç®—ï¼ˆç·¨é›†ï¼‰</div>';
            html += '<div style="font-size:10px;margin-top:5px;opacity:0.8;">æ•°å€¤ã‚’å¤‰æ›´ã™ã‚‹ã¨MQçµæœãŒè‡ªå‹•é€£å‹•</div>';
            html += '</div>';

            // é¡§å®¢äºˆç®—ã‚­ãƒ¼ã‚µãƒãƒªãƒ¼ï¼ˆæ—¥æ¬¡ãƒ»æœˆæ¬¡è¡¨ç¤ºï¼‰
            var custNumMonths = monthIndices.length || 12;
            var CUST_OPERATING_DAYS = 25;  // å–¶æ¥­æ—¥æ•°/æœˆ
            var custSalesMonthly = Math.round(custSales / custNumMonths);
            var custSalesDaily = Math.round(custSalesMonthly / CUST_OPERATING_DAYS);
            var custProfitMonthly = Math.round(custProfit / custNumMonths);
            var custProfitDaily = Math.round(custProfitMonthly / CUST_OPERATING_DAYS);

            html += '<div style="padding:15px;background:#e3f2fd;">';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';

            // å£²ä¸Šé«˜åˆè¨ˆï¼ˆæ—¥æ¬¡ãƒ¡ã‚¤ãƒ³ï¼‰
            html += '<div style="background:#fff;padding:12px;border-radius:8px;text-align:center;border:2px solid #1976d2;">';
            html += '<div style="font-size:10px;color:#666;">å£²ä¸Šé«˜åˆè¨ˆ</div>';
            html += '<div style="font-size:28px;font-weight:bold;color:#1976d2;">' + fmtYen(custSalesDaily) + '<span style="font-size:14px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#888;margin-top:4px;">æœˆ ' + fmtYen(custSalesMonthly) + 'å††</div>';
            html += '</div>';

            // å–¶æ¥­åˆ©ç›Šï¼ˆæ—¥æ¬¡ãƒ¡ã‚¤ãƒ³ï¼‰
            html += '<div style="background:#fff;padding:12px;border-radius:8px;text-align:center;border:2px solid ' + (custProfit >= 0 ? '#4caf50' : '#f44336') + ';">';
            html += '<div style="font-size:10px;color:#666;">å–¶æ¥­åˆ©ç›Š</div>';
            html += '<div style="font-size:28px;font-weight:bold;color:' + (custProfit >= 0 ? '#2e7d32' : '#c62828') + ';">' + fmtYen(custProfitDaily) + '<span style="font-size:14px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#888;margin-top:4px;">æœˆ ' + fmtYen(custProfitMonthly) + 'å††</div>';
            html += '</div>';

            html += '</div>';
            html += '<div style="text-align:right;font-size:9px;color:#999;margin-top:8px;line-height:1.6;">';
            html += 'â€»å–¶æ¥­æ—¥æ•° ' + CUST_OPERATING_DAYS + 'æ—¥/æœˆ æƒ³å®š<br>';
            html += 'â€»æœˆå¹³å‡ï¼å–è¾¼æœŸé–“åˆè¨ˆÃ·' + custNumMonths + 'ãƒ¶æœˆã€€æ—¥å¹³å‡ï¼æœˆå¹³å‡Ã·' + CUST_OPERATING_DAYS + 'æ—¥';
            html += '</div>';
            html += '</div>';

            // é¡§å®¢äºˆç®—ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸»è¦é …ç›®ã®ã¿è¡¨ç¤ºï¼‰
            html += '<div style="padding:15px;max-height:400px;overflow-y:auto;">';
            html += buildCompactEditTable(customerItems, monthIndices, allMonths, totalLabel, get);
            html += '</div>';

            // è©³ç´°å±•é–‹ãƒªãƒ³ã‚¯
            html += '<div style="padding:10px;background:#f5f5f5;text-align:center;border-top:1px solid #ddd;">';
            html += '<details style="display:inline-block;">';
            html += '<summary style="cursor:pointer;color:#1976d2;font-size:11px;">å…¨é …ç›®ã‚’è¡¨ç¤ºï¼ˆ' + customerItems.length + 'é …ç›®ï¼‰</summary>';
            html += '<div style="text-align:left;padding:10px;max-height:300px;overflow-y:auto;">' + buildTable(customerItems, '', '#1976d2', true) + '</div>';
            html += '</details></div>';

            html += '</div>';

            // ========== ä¸­å¤®ï¼šé€£å‹•çŸ¢å° ==========
            html += '<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;padding:10px;min-width:60px;">';
            html += '<div style="background:linear-gradient(90deg, #1976d2 0%, #7b1fa2 100%);color:#fff;padding:8px 15px;border-radius:20px;font-size:12px;font-weight:bold;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.2);">';
            html += '<span style="animation:pulse 1.5s infinite;">ğŸ”„</span> LIVE';
            html += '</div>';
            html += '<div style="font-size:30px;margin:10px 0;color:#7b1fa2;">â†’</div>';
            html += '<div style="font-size:10px;color:#666;text-align:center;">ç·¨é›†ã™ã‚‹ã¨<br>è‡ªå‹•é€£å‹•</div>';
            html += '</div>';

            // ========== å³ãƒ‘ãƒãƒ«ï¼šSTEP2 MQè©¦ç®—çµæœ ==========
            html += '<div style="background:#fff;border:3px solid #7b1fa2;border-radius:12px;overflow:hidden;">';
            html += '<div style="background:linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);color:#fff;padding:15px;text-align:center;">';
            html += '<div style="font-size:11px;font-weight:bold;opacity:0.9;">STEP 2ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</div>';
            html += '<div style="font-size:16px;font-weight:bold;">ğŸ“Š MQè©¦ç®—çµæœ</div>';
            html += '<div style="font-size:10px;margin-top:5px;opacity:0.8;">ç›®æ¨™é”æˆã«å¿…è¦ãªå®¢æ•°ãƒ»å£²ä¸Š</div>';
            html += '</div>';

            // MQçµæœã‚­ãƒ¼ã‚µãƒãƒªãƒ¼ï¼ˆæ—¥æ¬¡ãƒ»æœˆæ¬¡è¡¨ç¤ºï¼‰
            var numMonths = monthIndices.length || 12;
            var OPERATING_DAYS = 25;  // å–¶æ¥­æ—¥æ•°/æœˆ
            var mqCustomersMonthly = Math.round(mqCustomers / numMonths);
            var mqCustomersDaily = Math.round(mqCustomersMonthly / OPERATING_DAYS);
            var mqSalesMonthly = Math.round(mqSales / numMonths);
            var mqSalesDaily = Math.round(mqSalesMonthly / OPERATING_DAYS);

            html += '<div style="padding:15px;background:#f3e5f5;">';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';

            // ç›®æ¨™å®¢æ•°ï¼ˆæ—¥æ¬¡ãƒ¡ã‚¤ãƒ³ï¼‰
            html += '<div style="background:#fff;padding:12px;border-radius:8px;text-align:center;border:2px solid #e65100;">';
            html += '<div style="font-size:10px;color:#666;">ğŸ¯ ç›®æ¨™å®¢æ•°</div>';
            html += '<div style="font-size:28px;font-weight:bold;color:#e65100;">' + fmt(mqCustomersDaily) + '<span style="font-size:14px;">äºº/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#888;margin-top:4px;">æœˆ ' + fmt(mqCustomersMonthly) + 'äºº</div>';
            html += '</div>';

            // å¿…è¦å£²ä¸Šï¼ˆæ—¥æ¬¡ãƒ¡ã‚¤ãƒ³ï¼‰
            html += '<div style="background:#fff;padding:12px;border-radius:8px;text-align:center;border:2px solid #7b1fa2;">';
            html += '<div style="font-size:10px;color:#666;">ğŸ’° å¿…è¦å£²ä¸Š</div>';
            html += '<div style="font-size:28px;font-weight:bold;color:#7b1fa2;">' + fmtYen(mqSalesDaily) + '<span style="font-size:14px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#888;margin-top:4px;">æœˆ ' + fmtYen(mqSalesMonthly) + 'å††</div>';
            html += '</div>';

            html += '</div>';
            html += '<div style="text-align:right;font-size:9px;color:#999;margin-top:8px;line-height:1.6;">';
            html += 'â€»å–¶æ¥­æ—¥æ•° ' + OPERATING_DAYS + 'æ—¥/æœˆ æƒ³å®š<br>';
            html += 'â€»æœˆå¹³å‡ï¼å–è¾¼æœŸé–“åˆè¨ˆÃ·' + numMonths + 'ãƒ¶æœˆã€€æ—¥å¹³å‡ï¼æœˆå¹³å‡Ã·' + OPERATING_DAYS + 'æ—¥';
            html += '</div>';
            html += '</div>';

            // MQçµæœæœˆåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«
            html += '<div style="padding:15px;max-height:400px;overflow-y:auto;">';
            html += buildMQResultTable(monthIndices, allMonths, totalLabel, getMQ, getRI);
            html += '</div>';

            // è©³ç´°å±•é–‹ãƒªãƒ³ã‚¯
            html += '<div style="padding:10px;background:#f5f5f5;text-align:center;border-top:1px solid #ddd;">';
            html += '<details style="display:inline-block;">';
            html += '<summary style="cursor:pointer;color:#7b1fa2;font-size:11px;">è©³ç´°é …ç›®ã‚’è¡¨ç¤º</summary>';
            html += '<div style="text-align:left;padding:10px;max-height:300px;overflow-y:auto;">' + buildTable(rakumyItems, '', '#7b1fa2', false) + '</div>';
            html += '</details></div>';

            html += '</div>';

            html += '</div>'; // gridçµ‚äº†

            // ========== åˆ¤å®šçµæœãƒãƒ¼ï¼ˆæ—¥æ¬¡ãƒ»æœˆæ¬¡è¡¨ç¤ºå¯¾å¿œï¼‰==========
            var OPERATING_DAYS = 25;  // å–¶æ¥­æ—¥æ•°
            var numMonths = monthIndices.length || 12;

            // æ—¥æ¬¡ãƒ»æœˆæ¬¡è¨ˆç®—
            var custSalesMonthly = custSales / numMonths;
            var custSalesDaily = custSalesMonthly / OPERATING_DAYS;
            var mqSalesMonthly = mqSales / numMonths;
            var mqSalesDaily = mqSalesMonthly / OPERATING_DAYS;
            var salesDiffMonthly = salesDiff / numMonths;
            var salesDiffDaily = salesDiffMonthly / OPERATING_DAYS;

            html += '<div style="background:' + judgmentBg + ';border:3px solid ' + judgmentColor + ';border-radius:12px;padding:20px;margin-bottom:15px;">';

            // ä¸Šéƒ¨ï¼šåˆ¤å®šã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆ
            html += '<div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">';
            html += '<span style="font-size:40px;">' + (isAchievable ? 'âœ…' : 'âš ï¸') + '</span>';
            html += '<div>';
            html += '<div style="font-size:18px;font-weight:bold;color:' + judgmentColor + ';">' + judgmentText + '</div>';
            html += '<div style="font-size:11px;color:#666;margin-top:4px;">';
            if (isAchievable) {
                html += 'é¡§å®¢äºˆç®—å£²ä¸Š â‰§ MQå¿…è¦å£²ä¸Šã€€â†’ã€€<strong style="color:#2e7d32;">ä½™è£•ã‚ã‚Š</strong>';
            } else {
                html += 'é¡§å®¢äºˆç®—å£²ä¸Š ï¼œ MQå¿…è¦å£²ä¸Šã€€â†’ã€€<strong style="color:#c62828;">å£²ä¸Šå¢—ã¾ãŸã¯è²»ç”¨å‰Šæ¸›ãŒå¿…è¦</strong>';
            }
            html += '</div></div></div>';

            // ä¸‹éƒ¨ï¼šæ—¥æ¬¡ãƒ»æœˆæ¬¡ã®æ¯”è¼ƒã‚«ãƒ¼ãƒ‰
            html += '<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:15px;align-items:stretch;">';

            // å·¦ï¼šé¡§å®¢äºˆç®—å£²ä¸Š
            html += '<div style="text-align:center;padding:15px;background:#fff;border-radius:10px;border:2px solid #1976d2;">';
            html += '<div style="font-size:11px;color:#1976d2;font-weight:bold;margin-bottom:8px;">ğŸ“Š é¡§å®¢äºˆç®—å£²ä¸Š</div>';
            html += '<div style="font-size:24px;font-weight:bold;color:#1976d2;">' + fmtYen(custSalesDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#666;margin-top:4px;">æœˆ ' + fmtYen(custSalesMonthly) + 'å††</div>';
            html += '<div style="font-size:9px;color:#999;margin-top:2px;">æœŸé–“è¨ˆ ' + fmtYen(custSales) + 'å††</div>';
            html += '</div>';

            // ä¸­å¤®ï¼šVS + å·®ç•°
            html += '<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8px;">';
            html += '<div style="font-size:18px;font-weight:bold;color:#666;">vs</div>';
            var diffColor = salesDiff >= 0 ? '#2e7d32' : '#c62828';
            var diffSign = salesDiff >= 0 ? '+' : '';
            html += '<div style="background:' + (salesDiff >= 0 ? '#e8f5e9' : '#ffebee') + ';padding:8px 12px;border-radius:6px;text-align:center;">';
            html += '<div style="font-size:9px;color:#666;">å·®ç•°</div>';
            html += '<div style="font-size:14px;font-weight:bold;color:' + diffColor + ';">' + diffSign + fmtYen(salesDiffDaily) + '<span style="font-size:10px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:9px;color:' + diffColor + ';">æœˆ ' + diffSign + fmtYen(salesDiffMonthly) + 'å††</div>';
            html += '</div>';
            html += '</div>';

            // å³ï¼šMQå¿…è¦å£²ä¸Š
            html += '<div style="text-align:center;padding:15px;background:#fff;border-radius:10px;border:2px solid #7b1fa2;">';
            html += '<div style="font-size:11px;color:#7b1fa2;font-weight:bold;margin-bottom:8px;">ğŸ¯ MQå¿…è¦å£²ä¸Š</div>';
            html += '<div style="font-size:24px;font-weight:bold;color:#7b1fa2;">' + fmtYen(mqSalesDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#666;margin-top:4px;">æœˆ ' + fmtYen(mqSalesMonthly) + 'å††</div>';
            html += '<div style="font-size:9px;color:#999;margin-top:2px;">æœŸé–“è¨ˆ ' + fmtYen(mqSales) + 'å††</div>';
            html += '</div>';

            html += '</div>'; // gridçµ‚äº†
            html += '</div>'; // åˆ¤å®šçµæœãƒãƒ¼çµ‚äº†

            // ========== MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ & å®¢å˜ä¾¡å¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ==========
            html += '<div style="margin-bottom:15px;background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);border-radius:12px;border:2px solid #ff9800;overflow:hidden;">';

            // MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
            html += '<details style="background:transparent;">';
            html += '<summary style="cursor:pointer;padding:12px 15px;font-size:12px;font-weight:bold;color:#e65100;border-bottom:1px solid #ffcc80;">';
            html += 'ğŸ“‹ MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆé¡§å®¢äºˆç®—ã‹ã‚‰è‡ªå‹•å°å‡ºï¼‰';
            html += '<span style="font-size:10px;font-weight:normal;color:#666;margin-left:10px;">ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º</span>';
            html += '</summary>';
            html += '<div style="padding:15px;background:rgba(255,255,255,0.5);">';

            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
            html += '<table style="width:100%;border-collapse:collapse;font-size:11px;background:#fff;border-radius:6px;overflow:hidden;">';
            html += '<thead><tr style="background:#e65100;color:#fff;">';
            html += '<th style="padding:8px;text-align:left;">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</th>';
            html += '<th style="padding:8px;text-align:right;">å€¤</th>';
            html += '<th style="padding:8px;text-align:left;">èª¬æ˜</th>';
            html += '</tr></thead><tbody>';

            html += '<tr style="background:#fff;"><td style="padding:6px;">FDä»•å…¥è²»ç‡</td><td style="padding:6px;text-align:right;font-weight:bold;color:#ff5722;">' + (fdCostRate * 100).toFixed(1) + '%</td><td style="padding:6px;font-size:10px;color:#666;">é£Ÿæ+ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡Ã·å£²ä¸Š</td></tr>';
            html += '<tr style="background:#fafafa;"><td style="padding:6px;">PAäººä»¶è²»ç‡</td><td style="padding:6px;text-align:right;font-weight:bold;color:#ff5722;">' + (paCostRate * 100).toFixed(1) + '%</td><td style="padding:6px;font-size:10px;color:#666;">é›‘çµ¦Ã·å£²ä¸Š</td></tr>';
            html += '<tr style="background:#fff;"><td style="padding:6px;">å¤‰å‹•è²»ç‡ï¼ˆVRï¼‰</td><td style="padding:6px;text-align:right;font-weight:bold;color:#7b1fa2;">' + (variableCostRate * 100).toFixed(1) + '%</td><td style="padding:6px;font-size:10px;color:#666;">FDç‡+PAç‡</td></tr>';
            html += '<tr style="background:#fafafa;"><td style="padding:6px;">ç²—åˆ©ç‡ï¼ˆ1-VRï¼‰</td><td style="padding:6px;text-align:right;font-weight:bold;color:#7b1fa2;">' + (grossProfitRate * 100).toFixed(1) + '%</td><td style="padding:6px;font-size:10px;color:#666;">é™ç•Œåˆ©ç›Šç‡</td></tr>';
            html += '<tr style="background:#fff;"><td style="padding:6px;">å›ºå®šè²»åˆè¨ˆï¼ˆFï¼‰</td><td style="padding:6px;text-align:right;font-weight:bold;color:#795548;">' + fmtYen(annualFixedCost) + 'å††/å¹´</td><td style="padding:6px;font-size:10px;color:#666;">å›ºå®šäººä»¶è²»+åœ°ä»£å®¶è³ƒ+ãã®ä»–</td></tr>';
            html += '<tr style="background:#fafafa;"><td style="padding:6px;">ç›®æ¨™å–¶æ¥­åˆ©ç›Šï¼ˆGï¼‰</td><td style="padding:6px;text-align:right;font-weight:bold;color:#4caf50;">' + fmtYen(custProfit) + 'å††/å¹´</td><td style="padding:6px;font-size:10px;color:#666;">é¡§å®¢äºˆç®—ã®å–¶æ¥­åˆ©ç›Š</td></tr>';
            html += '<tr style="background:#e8f5e9;"><td style="padding:6px;">ç¾åœ¨ã®å®¢å˜ä¾¡ï¼ˆPï¼‰</td><td style="padding:6px;text-align:right;font-weight:bold;color:#9c27b0;">' + fmt(unitPrice) + 'å††</td><td style="padding:6px;font-size:10px;color:#666;">å£²ä¸ŠÃ·æƒ³å®šå®¢æ•°</td></tr>';

            html += '</tbody></table>';
            html += '<p style="font-size:9px;color:#888;margin:10px 0 0 0;">â€» FDç‡ãƒ»PAç‡ãƒ»å›ºå®šè²»ãƒ»ç›®æ¨™åˆ©ç›Šã¯é¡§å®¢äºˆç®—ã‚’ç·¨é›†ã™ã‚‹ã¨è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™</p>';
            html += '</div></details>';

            // MQå†è¨ˆç®—ãƒœã‚¿ãƒ³ï¼ˆé¡§å®¢äºˆç®—ç·¨é›†ãƒ»å®¢å˜ä¾¡å¤‰æ›´ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
            html += '<div style="text-align:center;padding:15px;border-top:1px solid #ffcc80;">';
            html += '<p style="font-size:11px;color:#e65100;margin:0 0 10px 0;">é¡§å®¢äºˆç®—ã®ç·¨é›†å†…å®¹ãƒ»å®¢å˜ä¾¡å¤‰æ›´ã‚’MQçµæœã«åæ˜ ã—ã¾ã™</p>';
            html += '<button onclick="showUnitPriceConfirmModal()" class="btn" style="padding:10px 30px;font-size:13px;background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);border:none;border-radius:6px;color:#fff;font-weight:bold;box-shadow:0 2px 8px rgba(255,152,0,0.3);cursor:pointer;">';
            html += 'ğŸ”„ MQå†è¨ˆç®—ã‚’å®Ÿè¡Œ';
            html += '</button>';
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;

            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            updateSimulationSummary();
        }

        // â˜… è©¦ç®—ã‚µãƒãƒªãƒ¼æ›´æ–°ï¼ˆæ—¥æ¬¡ãƒ»æœˆæ¬¡è¡¨ç¤ºï¼‰
        function updateSimulationSummary() {
            var summaryDiv = document.getElementById('simulationSummary');
            if (!summaryDiv || !simulationData.annualData || !simulationOriginal.annualData) return;

            // æœˆæ•°ã‚’å–å¾—
            var monthIndices = getMonthIndicesFromMode();
            var numMonths = monthIndices.length || 12;
            var OPERATING_DAYS = 25;

            var calcTotal = function(data, no) {
                var total = 0;
                if (data[no]) {
                    monthIndices.forEach(function(m) {
                        total += data[no][m] || 0;
                    });
                }
                return total;
            };

            var calcProfit = function(data) {
                var sales = calcTotal(data, 4);
                var costs = calcTotal(data, 8) + calcTotal(data, 12) + calcTotal(data, 18) + calcTotal(data, 19) + calcTotal(data, 27) + calcTotal(data, 32) + calcTotal(data, 33) + calcTotal(data, 34);
                return sales - costs;
            };

            var origSales = calcTotal(simulationOriginal.annualData, 4);
            var newSales = calcTotal(simulationData.annualData, 4);
            var origProfit = calcProfit(simulationOriginal.annualData);
            var newProfit = calcProfit(simulationData.annualData);

            var salesDiff = newSales - origSales;
            var profitDiff = newProfit - origProfit;

            // æ—¥æ¬¡ãƒ»æœˆæ¬¡è¨ˆç®—
            var salesMonthly = Math.round(newSales / numMonths);
            var salesDaily = Math.round(salesMonthly / OPERATING_DAYS);
            var salesDiffMonthly = Math.round(salesDiff / numMonths);
            var salesDiffDaily = Math.round(salesDiffMonthly / OPERATING_DAYS);
            var profitMonthly = Math.round(newProfit / numMonths);
            var profitDaily = Math.round(profitMonthly / OPERATING_DAYS);
            var profitDiffMonthly = Math.round(profitDiff / numMonths);
            var profitDiffDaily = Math.round(profitDiffMonthly / OPERATING_DAYS);

            var html = '<div style="display:flex;gap:20px;flex-wrap:wrap;">';

            // å£²ä¸Šé«˜
            html += '<div style="flex:1;min-width:200px;padding:15px;background:#fff;border-radius:8px;border:2px solid #2196f3;">';
            html += '<div style="font-size:10px;color:#666;">å£²ä¸Šé«˜</div>';
            html += '<div style="font-size:24px;font-weight:bold;color:#1565c0;">' + fmtYen(salesDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#888;">æœˆ ' + fmtYen(salesMonthly) + 'å††</div>';
            html += '<div style="font-size:11px;color:' + (salesDiff >= 0 ? '#2e7d32' : '#c62828') + ';margin-top:5px;">' + (salesDiffDaily >= 0 ? 'â–²' : 'â–¼') + ' ' + fmtYen(Math.abs(salesDiffDaily)) + 'å††/æ—¥ï¼ˆæœˆ ' + (salesDiffMonthly >= 0 ? '+' : '') + fmtYen(salesDiffMonthly) + 'å††ï¼‰</div>';
            html += '</div>';

            // å–¶æ¥­åˆ©ç›Š
            html += '<div style="flex:1;min-width:200px;padding:15px;background:#fff;border-radius:8px;border:2px solid ' + (newProfit >= 0 ? '#4caf50' : '#f44336') + ';">';
            html += '<div style="font-size:10px;color:#666;">å–¶æ¥­åˆ©ç›Š</div>';
            html += '<div style="font-size:24px;font-weight:bold;color:' + (newProfit >= 0 ? '#2e7d32' : '#c62828') + ';">' + fmtYen(profitDaily) + '<span style="font-size:12px;">å††/æ—¥</span></div>';
            html += '<div style="font-size:11px;color:#888;">æœˆ ' + fmtYen(profitMonthly) + 'å††</div>';
            html += '<div style="font-size:11px;color:' + (profitDiff >= 0 ? '#2e7d32' : '#c62828') + ';margin-top:5px;">' + (profitDiffDaily >= 0 ? 'â–²' : 'â–¼') + ' ' + fmtYen(Math.abs(profitDiffDaily)) + 'å††/æ—¥ï¼ˆæœˆ ' + (profitDiffMonthly >= 0 ? '+' : '') + fmtYen(profitDiffMonthly) + 'å††ï¼‰</div>';
            html += '</div>';

            html += '</div>';

            // æ³¨é‡ˆï¼ˆå–¶æ¥­æ—¥æ•°ã¨è¨ˆç®—å¼å®šç¾©ï¼‰
            html += '<div style="text-align:right;font-size:9px;color:#999;margin-top:10px;line-height:1.6;">';
            html += 'â€»å–¶æ¥­æ—¥æ•° ' + OPERATING_DAYS + 'æ—¥/æœˆ æƒ³å®š<br>';
            html += 'â€»æœˆå¹³å‡ï¼å–è¾¼æœŸé–“åˆè¨ˆÃ·' + numMonths + 'ãƒ¶æœˆã€€æ—¥å¹³å‡ï¼æœˆå¹³å‡Ã·' + OPERATING_DAYS + 'æ—¥';
            html += '</div>';

            summaryDiv.innerHTML = html;
        }

        // â˜… è©¦ç®—å€¤æ›´æ–°
        function updateSimulationValue(input) {
            var no = parseInt(input.dataset.no);
            var month = parseInt(input.dataset.month);
            var value = parseFloat(input.value) || 0;

            // å††å˜ä½å…¥åŠ›ã‚’åƒå††å˜ä½ã«å¤‰æ›ï¼ˆdata-yenå±æ€§ãŒã‚ã‚‹å ´åˆï¼‰
            if (input.dataset.yen === 'true') {
                value = value / 1000;
            }

            if (!simulationData.annualData[no]) {
                simulationData.annualData[no] = {};
            }
            simulationData.annualData[no][month] = value;

            // â˜…â˜…â˜… é¡§å®¢äºˆç®—ç·¨é›†æ™‚ã«rakumyInputs/mqOutputsã‚’è‡ªå‹•å†è¨ˆç®— â˜…â˜…â˜…
            regenerateSimRakumyInputs();
            runSimMQSimulation();
            updateSimMqDisplay();

            // å³å´ã®ãƒ©ã‚¯ãƒŸãƒ¼äºˆç®—ã‚’å†è¨ˆç®—
            renderLinkedSimulation();
        }

        // â˜… äºˆç®—è©¦ç®—ç”¨rakumyInputså†ç”Ÿæˆï¼ˆé¡§å®¢äºˆç®—ç·¨é›†æ™‚ã«å‘¼ã³å‡ºã—ï¼‰
        function regenerateSimRakumyInputs() {
            if (!simulationData || !simulationData.annualData) return;

            var get = function(no, m) { return simulationData.annualData[no] ? (simulationData.annualData[no][m] || 0) : 0; };

            // â˜…â˜…â˜… æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’å–å¾— â˜…â˜…â˜…
            var mqInputs = getSimMQInputs();

            simulationData.rakumyInputs = {};
            for (var m = 0; m < 12; m++) {
                // æœˆåˆ¥MQå…¥åŠ›å€¤ã‚’å–å¾—
                var monthInput = mqInputs[m] || mqInputs[0] || { targetProfit: 500, fdRate: 30, paRate: 10, targetUnitPrice: 4500 };

                // å›ºå®šè²»åˆè¨ˆï¼ˆè²»ç”¨äºˆç®—ã‹ã‚‰è‡ªå‹•å‚ç…§ - å…¥åŠ›ä¸è¦ï¼‰
                var fixedLabor = get(16,m) + get(17,m) + get(18,m) + get(21,m) + get(22,m) + get(23,m) + get(24,m) + get(25,m);
                var rent = get(56,m) + get(59,m);
                var material = get(57,m) + get(58,m);
                var depreciation = get(55,m);
                var otherExp = 0;
                for (var i = 27; i <= 51; i++) otherExp += get(i, m);
                var fixedCostTotal = fixedLabor + rent + material + depreciation + otherExp;

                simulationData.rakumyInputs[m] = {
                    fixedCostTotal: fixedCostTotal,              // è²»ç”¨äºˆç®—ã‹ã‚‰è‡ªå‹•å‚ç…§
                    fdRate: monthInput.fdRate,                   // â˜… æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
                    paRate: monthInput.paRate,                   // â˜… æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
                    targetProfit: monthInput.targetProfit,       // â˜… æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
                    targetUnitPrice: monthInput.targetUnitPrice, // â˜… æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
                    budgetSales: get(4, m),                      // å‚ç…§å€¤ï¼ˆé¡§å®¢äºˆç®—ï¼‰
                    budgetProfit: get(63, m)                     // å‚ç…§å€¤ï¼ˆé¡§å®¢äºˆç®—ï¼‰
                };
            }

            // è²»ç”¨å‚ç…§è¡¨ç¤ºã‚’æ›´æ–°
            updateSimRefDisplay();
        }

        // â˜… è©¦ç®—ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«æˆ»ã™
        function resetSimulationData() {
            if (!simulationOriginal.annualData) {
                showStatus('warn', 'å…ƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            simulationData = JSON.parse(JSON.stringify(simulationOriginal));
            renderLinkedSimulation();
            showStatus('info', 'è©¦ç®—ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ');
        }

        // ========== è©¦ç®—å±¥æ­´æ©Ÿèƒ½ ==========
        var SIMULATION_HISTORY_KEY = 'rakumy_simulation_history';

        // å±¥æ­´ã‚’localStorageã‹ã‚‰å–å¾—
        function getSimulationHistory() {
            try {
                var data = localStorage.getItem(SIMULATION_HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
                return [];
            }
        }

        // å±¥æ­´ã‚’localStorageã«ä¿å­˜
        function setSimulationHistory(history) {
            try {
                localStorage.setItem(SIMULATION_HISTORY_KEY, JSON.stringify(history));
                updateSimHistoryCount();
            } catch (e) {
                console.error('å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—:', e);
                showStatus('error', 'å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å±¥æ­´ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        function updateSimHistoryCount() {
            var history = getSimulationHistory();
            var countEl = document.getElementById('simHistoryCount');
            if (countEl) {
                countEl.textContent = history.length;
            }
        }

        // ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showSaveSimulationModal() {
            if (!simulationData || !simulationData.annualData) {
                showStatus('warn', 'ä¿å­˜ã™ã‚‹è©¦ç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            var modal = document.getElementById('saveSimulationModal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('simSaveName').value = '';
                document.getElementById('simSaveMemo').value = '';
                document.getElementById('simSaveName').focus();
            }
        }

        // ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideSaveSimulationModal() {
            var modal = document.getElementById('saveSimulationModal');
            if (modal) modal.style.display = 'none';
        }

        // è©¦ç®—å±¥æ­´ã‚’ä¿å­˜
        function saveSimulationHistory() {
            var nameInput = document.getElementById('simSaveName');
            var memoInput = document.getElementById('simSaveMemo');
            var name = nameInput ? nameInput.value.trim() : '';
            var memo = memoInput ? memoInput.value.trim() : '';

            if (!name) {
                showStatus('warn', 'ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                nameInput.focus();
                return;
            }

            if (!simulationData || !simulationData.annualData) {
                showStatus('warn', 'ä¿å­˜ã™ã‚‹è©¦ç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            var select = document.getElementById('simulationStoreSelect');
            var storeName = select ? select.value : '';

            // ã‚µãƒãƒªãƒ¼è¨ˆç®—
            var get = function(no, m) { return simulationData.annualData[no] ? (simulationData.annualData[no][m] || 0) : 0; };
            var totalSales = 0, totalProfit = 0;
            for (var m = 0; m < 12; m++) {
                totalSales += get(4, m);
                totalProfit += get(63, m);
            }

            var mqCustomers = 0, mqSales = 0;
            if (simulationData.mqOutputs) {
                for (var m = 0; m < 12; m++) {
                    mqCustomers += simulationData.mqOutputs[m] ? (simulationData.mqOutputs[m].customers || 0) : 0;
                    mqSales += simulationData.mqOutputs[m] ? (simulationData.mqOutputs[m].sales || 0) : 0;
                }
            }

            var historyItem = {
                id: Date.now(),
                name: name,
                memo: memo,
                storeName: storeName,
                savedAt: new Date().toISOString(),
                summary: {
                    sales: totalSales,
                    profit: totalProfit,
                    mqCustomers: mqCustomers,
                    mqSales: mqSales
                },
                data: {
                    annualData: JSON.parse(JSON.stringify(simulationData.annualData)),
                    rakumyInputs: simulationData.rakumyInputs ? JSON.parse(JSON.stringify(simulationData.rakumyInputs)) : null,
                    mqOutputs: simulationData.mqOutputs ? JSON.parse(JSON.stringify(simulationData.mqOutputs)) : null
                }
            };

            var history = getSimulationHistory();
            history.unshift(historyItem);  // æœ€æ–°ã‚’å…ˆé ­ã«

            // æœ€å¤§10ä»¶ã¾ã§ä¿å­˜
            if (history.length > 10) {
                history = history.slice(0, 10);
            }

            setSimulationHistory(history);
            hideSaveSimulationModal();
            showStatus('success', 'ã€Œ' + name + 'ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            renderSimHistoryList();
        }

        // å±¥æ­´ãƒªã‚¹ãƒˆè¡¨ç¤º/éè¡¨ç¤º
        function toggleSimHistoryList() {
            var section = document.getElementById('simHistorySection');
            if (section) {
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    renderSimHistoryList();
                } else {
                    section.style.display = 'none';
                }
            }
        }

        // å±¥æ­´ãƒªã‚¹ãƒˆæç”»
        function renderSimHistoryList() {
            var listEl = document.getElementById('simHistoryList');
            if (!listEl) return;

            var history = getSimulationHistory();

            if (history.length === 0) {
                listEl.innerHTML = '<p style="color:#666;font-size:11px;text-align:center;padding:20px;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            var html = '';
            history.forEach(function(item, index) {
                var savedDate = new Date(item.savedAt);
                var dateStr = savedDate.toLocaleDateString('ja-JP') + ' ' + savedDate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});

                html += '<div style="background:#fff;border-radius:6px;padding:12px;margin-bottom:8px;border:1px solid #ddd;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">';
                html += '<div style="flex:1;">';
                html += '<div style="font-weight:bold;color:#3949ab;font-size:12px;">' + escapeHtml(item.name) + '</div>';
                html += '<div style="font-size:10px;color:#666;margin-top:3px;">' + dateStr + ' | ' + escapeHtml(item.storeName || 'ä¸æ˜') + '</div>';
                if (item.memo) {
                    html += '<div style="font-size:10px;color:#888;margin-top:3px;font-style:italic;">' + escapeHtml(item.memo) + '</div>';
                }
                html += '<div style="font-size:10px;margin-top:5px;">';
                html += '<span style="color:#1976d2;">å£²ä¸Š: ' + fmtYen(item.summary.sales) + 'å††</span> | ';
                html += '<span style="color:' + (item.summary.profit >= 0 ? '#2e7d32' : '#c62828') + ';">åˆ©ç›Š: ' + fmtYen(item.summary.profit) + 'å††</span>';
                if (item.summary.mqCustomers) {
                    html += ' | <span style="color:#e65100;">MQå®¢æ•°: ' + fmt(item.summary.mqCustomers) + 'äºº</span>';
                }
                html += '</div>';
                html += '</div>';
                html += '<div style="display:flex;gap:5px;">';
                html += '<button class="btn" style="background:#1976d2;color:#fff;padding:5px 10px;font-size:10px;" onclick="loadSimulationFromHistory(' + item.id + ')">è¡¨ç¤º</button>';
                html += '<button class="btn" style="background:#c62828;color:#fff;padding:5px 10px;font-size:10px;" onclick="deleteSimulationHistory(' + item.id + ')">å‰Šé™¤</button>';
                html += '</div>';
                html += '</div></div>';
            });

            listEl.innerHTML = html;
        }

        // å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadSimulationFromHistory(id) {
            var history = getSimulationHistory();
            var item = history.find(function(h) { return h.id === id; });

            if (!item) {
                showStatus('error', 'å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // åº—èˆ—ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
            var select = document.getElementById('simulationStoreSelect');
            var currentStore = select ? select.value : '';

            // åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã€å±¥æ­´ã®åº—èˆ—ã‚’é¸æŠ
            if (!currentStore && item.storeName && allStoresData[item.storeName]) {
                select.value = item.storeName;
                // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                loadSimulationData();
            } else if (item.storeName && item.storeName !== currentStore) {
                var switchStore = confirm('ã“ã®å±¥æ­´ã¯ã€Œ' + item.storeName + 'ã€ã®ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n\nã€ŒOKã€: ã“ã®åº—èˆ—ã«åˆ‡ã‚Šæ›¿ãˆã¦èª­ã¿è¾¼ã¿\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: ç¾åœ¨ã®åº—èˆ—ã«èª­ã¿è¾¼ã¿');
                if (switchStore && allStoresData[item.storeName]) {
                    select.value = item.storeName;
                    loadSimulationData();
                }
            }

            // simulationDataãŒæœªåˆæœŸåŒ–ã®å ´åˆã¯åˆæœŸåŒ–
            if (!simulationData) {
                simulationData = {};
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            simulationData.annualData = JSON.parse(JSON.stringify(item.data.annualData));
            if (item.data.rakumyInputs) {
                simulationData.rakumyInputs = JSON.parse(JSON.stringify(item.data.rakumyInputs));
            }
            if (item.data.mqOutputs) {
                simulationData.mqOutputs = JSON.parse(JSON.stringify(item.data.mqOutputs));
            }

            // MQè¨ˆç®—ã‚’å†å®Ÿè¡Œï¼ˆå±¥æ­´ã«mqOutputsãŒãªã„å ´åˆã«å‚™ãˆã¦ï¼‰
            if (!item.data.mqOutputs) {
                regenerateSimRakumyInputs();
                runSimMQSimulation();
            }

            // å†æç”»
            renderLinkedSimulation();

            // å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹
            var historySection = document.getElementById('simHistorySection');
            if (historySection) historySection.style.display = 'none';

            showStatus('success', 'ã€Œ' + item.name + 'ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        }

        // å±¥æ­´ã‚’å‰Šé™¤
        function deleteSimulationHistory(id) {
            if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            var history = getSimulationHistory();
            history = history.filter(function(h) { return h.id !== id; });
            setSimulationHistory(history);
            renderSimHistoryList();
            showStatus('info', 'å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å±¥æ­´ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        document.addEventListener('DOMContentLoaded', function() {
            updateSimHistoryCount();
        });

        // â˜… è©¦ç®—å€¤ã‚’æœ¬ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
        function applySimulationData() {
            var select = document.getElementById('simulationStoreSelect');
            var selectedStore = select.value;

            if (!selectedStore || !allStoresData[selectedStore]) {
                showStatus('warn', 'åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            if (!simulationData || !simulationData.annualData) {
                showStatus('warn', 'è©¦ç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!confirm('è©¦ç®—å€¤ã‚’ã€Œ' + selectedStore + 'ã€ã®æœ¬ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å…ƒã«æˆ»ã›ã¾ã›ã‚“')) return;

            // æœ¬ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆannualDataã€rakumyInputsã€mqOutputsã™ã¹ã¦åæ˜ ï¼‰
            allStoresData[selectedStore].annualData = JSON.parse(JSON.stringify(simulationData.annualData));
            if (simulationData.rakumyInputs) {
                allStoresData[selectedStore].rakumyInputs = JSON.parse(JSON.stringify(simulationData.rakumyInputs));
            }
            if (simulationData.mqOutputs) {
                allStoresData[selectedStore].mqOutputs = JSON.parse(JSON.stringify(simulationData.mqOutputs));
            }

            // ç¾åœ¨ã®åº—èˆ—ãªã‚‰ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚‚æ›´æ–°ã—ã¦å†è¨ˆç®—
            if (currentStoreName === selectedStore) {
                annualData = allStoresData[selectedStore].annualData;
                rakumyInputs = allStoresData[selectedStore].rakumyInputs || {};
                mqOutputs = allStoresData[selectedStore].mqOutputs || {};
                executeCalcRules();
                generateRakumyInputs();
                runMQSimulation();
                saveCurrentStoreData();
            }

            showStatus('success', 'è©¦ç®—å€¤ã‚’æœ¬ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã—ã¾ã—ãŸï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ï¼‰');
        }

        // â˜… åº—èˆ—å‰Šé™¤
        function removeStore(name, event) {
            event.stopPropagation();
            if (!confirm('ã€Œ' + name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            delete allStoresData[name];

            if (currentStoreName === name) {
                currentStoreName = '';
                var remaining = Object.keys(allStoresData);
                if (remaining.length > 0) {
                    switchStore(remaining[0]);
                }
            }

            updateStoreSelector();
            renderAllStoresSummary();
        }

        // â˜… å…¨åº—èˆ—ã‚¯ãƒªã‚¢
        function clearAllStores() {
            if (!confirm('å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;

            allStoresData = {};
            currentStoreName = '';
            storeName = '';
            annualData = {};
            calcResults = {};
            rakumyInputs = {};
            mqOutputs = {};

            updateStoreSelector();
            updateDataCounts();
            document.getElementById('allStoresSummary').style.display = 'none';
            document.getElementById('importedDataSection').style.display = 'none';
            document.getElementById('exportDataSection').style.display = 'none';
            document.getElementById('detectedStore').textContent = '-';
            document.getElementById('detectedMonthCount').textContent = '-';
            document.getElementById('detectedItemCount').textContent = '-';
            document.getElementById('unmatchedCount').textContent = '-';

            showStatus('info', 'å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // â˜… ç¾åœ¨ã®åº—èˆ—ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function runSimulationForCurrentStore() {
            if (!currentStoreName) {
                showStatus('error', 'åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            runSimulation();
            saveCurrentStoreData(); // çµæœã‚’ä¿å­˜
            renderAllStoresSummary();
        }

        // â˜… å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼æç”»
        function renderAllStoresSummary() {
            var storeNames = Object.keys(allStoresData);
            if (storeNames.length === 0) {
                document.getElementById('allStoresSummary').style.display = 'none';
                return;
            }

            document.getElementById('allStoresSummary').style.display = 'block';

            var totalSales = 0, totalProfit = 0, totalCustomers = 0;
            var cardsHtml = '';

            storeNames.forEach(function(name) {
                var data = allStoresData[name];
                var storeSales = 0, storeProfit = 0, storeCustomers = 0;

                if (data.mqOutputs) {
                    for (var m in data.mqOutputs) {
                        storeSales += data.mqOutputs[m].sales || 0;
                        storeProfit += data.mqOutputs[m].operatingProfit || 0;
                        storeCustomers += data.mqOutputs[m].customers || 0;
                    }
                }

                totalSales += storeSales;
                totalProfit += storeProfit;
                totalCustomers += storeCustomers;

                var profitRate = storeSales > 0 ? (storeProfit / storeSales * 100) : 0;

                cardsHtml += '<div class="store-card' + (name === currentStoreName ? ' active' : '') + '" onclick="switchStore(\'' + name.replace(/'/g, "\\'") + '\')">';
                cardsHtml += '<h4>' + name + '</h4>';
                cardsHtml += '<div class="metric"><span>å¹´é–“å£²ä¸Š</span><span class="metric-value">' + fmtYen(storeSales) + ' å††</span></div>';
                cardsHtml += '<div class="metric"><span>å¹´é–“å–¶æ¥­åˆ©ç›Š</span><span class="metric-value">' + fmtYen(storeProfit) + ' å††</span></div>';
                cardsHtml += '<div class="metric"><span>å–¶æ¥­åˆ©ç›Šç‡</span><span class="metric-value">' + fmtRate(profitRate) + '%</span></div>';
                cardsHtml += '<div class="metric"><span>å¹´é–“å®¢æ•°</span><span class="metric-value">' + fmt(storeCustomers) + ' äºº</span></div>';
                cardsHtml += '</div>';
            });

            // åˆè¨ˆã‚«ãƒ¼ãƒ‰
            var totalProfitRate = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
            cardsHtml += '<div class="store-card total">';
            cardsHtml += '<h4>å…¨åº—èˆ—åˆè¨ˆ</h4>';
            cardsHtml += '<div class="metric"><span>å¹´é–“å£²ä¸Šåˆè¨ˆ</span><span class="metric-value">' + fmtYen(totalSales) + ' å††</span></div>';
            cardsHtml += '<div class="metric"><span>å¹´é–“å–¶æ¥­åˆ©ç›Šåˆè¨ˆ</span><span class="metric-value">' + fmtYen(totalProfit) + ' å††</span></div>';
            cardsHtml += '<div class="metric"><span>å¹³å‡å–¶æ¥­åˆ©ç›Šç‡</span><span class="metric-value">' + fmtRate(totalProfitRate) + '%</span></div>';
            cardsHtml += '<div class="metric"><span>å¹´é–“å®¢æ•°åˆè¨ˆ</span><span class="metric-value">' + fmt(totalCustomers) + ' äºº</span></div>';
            cardsHtml += '</div>';

            document.getElementById('allStoresGrid').innerHTML = cardsHtml;
        }

        function showStatus(type, msg) {
            var el = document.getElementById('importStatus');
            el.className = 'status-bar status-' + type;
            el.textContent = msg;
            el.style.display = 'block';
        }

        // CSVãƒ‘ãƒ¼ã‚µãƒ¼
        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseCustomNumber(str) {
            if (!str || str === '-' || str === '' || str === '#N/A' || str === '#DIV/0!') return 0;
            var s = String(str).trim().replace(/"/g, '');
            var isNegative = s.charAt(0) === '(' && s.charAt(s.length - 1) === ')';
            if (isNegative) s = s.substring(1, s.length - 1);
            s = s.replace(/[\s,]/g, '').replace(/%/g, '');
            var num = parseFloat(s);
            if (isNaN(num)) return 0;
            return isNegative ? -num : num;
        }

        function extractItemCode(fullCode) {
            var str = String(fullCode).trim();
            if (str.length >= 6) return str.substring(3);
            return str;
        }

        function isNumericOrEmpty(str) {
            if (!str || str.trim() === '') return true;
            var s = str.trim();
            if (s === '#N/A' || s === '#DIV/0!' || s === '#REF!' || s === '#VALUE!' || s === '-') return true;
            var cleaned = s.replace(/[,\s"()%]/g, '');
            return !isNaN(parseFloat(cleaned));
        }

        function extractItemNameFromCols(cols, endCol) {
            var nameParts = [];
            var scanEnd = Math.min(endCol, cols.length);
            for (var i = 1; i < scanEnd; i++) {
                var val = cols[i] ? cols[i].trim() : '';
                if (val && val.length > 0 && !isNumericOrEmpty(val)) {
                    nameParts.push({ col: i, value: val });
                }
            }
            var primaryName = nameParts.length > 0 ? nameParts[nameParts.length - 1].value : '';
            var hierarchy = nameParts.map(function(p) { return p.value; }).join(' > ');
            return { name: primaryName, hierarchy: hierarchy };
        }

        // â˜… æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—ã®æ­£ç¢ºãªæ¤œå‡º
        function detectBudgetColumns(lines) {
            if (lines.length < 4) return [];

            var row2 = parseCSVLine(lines[2]); // æœˆåè¡Œï¼ˆ3è¡Œç›®ï¼‰
            var row3 = parseCSVLine(lines[3]); // ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ4è¡Œç›®ï¼‰

            addLog('=== æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—ã®æ¤œå‡ºé–‹å§‹ ===', 'info');
            addLog('3è¡Œç›®ï¼ˆæœˆåè¡Œï¼‰åˆ—æ•°: ' + row2.length, 'data');
            addLog('4è¡Œç›®ï¼ˆã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼‰åˆ—æ•°: ' + row3.length, 'data');

            // â˜… é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå››åŠæœŸã€ç´¯è¨ˆãªã©ï¼‰
            var SKIP_PATTERNS = [
                /^\d*[Qqï¼±ï½‘]$/,           // 1Q, 2Q, Q1, Q2, ï¼±ï¼‘ãªã©
                /^[ä¸Šä¸‹]æœŸ$/,              // ä¸ŠæœŸ, ä¸‹æœŸ
                /^åŠæœŸ/,                   // åŠæœŸ
                /ç´¯è¨ˆ/,                    // ä¸ŠæœŸç´¯è¨ˆ, ä¸‹æœŸç´¯è¨ˆ, é€šæœŸç´¯è¨ˆ
                /åˆè¨ˆ/,                    // å¹´é–“åˆè¨ˆ, åˆè¨ˆ
                /^é€šæœŸ/,                   // é€šæœŸ
                /^å¹´[åº¦è¨ˆé–“]/,             // å¹´åº¦, å¹´è¨ˆ, å¹´é–“
                /^æœŸ[é¦–æœ«]/                // æœŸé¦–, æœŸæœ«
            ];

            function shouldSkip(cellValue) {
                for (var p = 0; p < SKIP_PATTERNS.length; p++) {
                    if (SKIP_PATTERNS[p].test(cellValue)) {
                        return true;
                    }
                }
                return false;
            }

            // ã¾ãšã€ã™ã¹ã¦ã®æœˆåã®ä½ç½®ã‚’æ¤œå‡ºï¼ˆå››åŠæœŸãƒ»ç´¯è¨ˆã¯é™¤å¤–ï¼‰
            var monthNamePositions = [];
            var skippedColumns = [];
            for (var i = 0; i < row2.length; i++) {
                var cell = row2[i].trim();
                if (!cell) continue;

                // å››åŠæœŸãƒ»ç´¯è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (shouldSkip(cell)) {
                    skippedColumns.push(cell + '(åˆ—' + i + ')');
                    continue;
                }

                // æœˆåãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹ã‹
                if (CALENDAR_MONTHS.indexOf(cell) >= 0) {
                    monthNamePositions.push({ month: cell, col: i });
                }
            }

            // ã‚¹ã‚­ãƒƒãƒ—ã—ãŸåˆ—ã‚’ãƒ­ã‚°å‡ºåŠ›
            if (skippedColumns.length > 0) {
                addLog('âœ“ é™¤å¤–ï¼ˆå››åŠæœŸãƒ»ç´¯è¨ˆï¼‰: ' + skippedColumns.join(', '), 'warn');
            }
            addLog('âœ“ æœˆåæ¤œå‡º: ' + monthNamePositions.length + 'å€‹ (' + monthNamePositions.map(function(m) { return m.month; }).join(', ') + ')', 'success');

            // å„æœˆã«ã¤ã„ã¦ã€ã€Œäºˆç®—ã€åˆ—ã‚’æ¢ã™
            var results = [];
            monthDetectionResults = [];

            for (var mi = 0; mi < monthNamePositions.length; mi++) {
                var monthInfo = monthNamePositions[mi];
                var month = monthInfo.month;
                var monthCol = monthInfo.col;

                // ã“ã®æœˆã®ç¯„å›²ï¼ˆæ¬¡ã®æœˆã®æ‰‹å‰ã¾ã§ï¼‰
                var nextMonthCol = (mi < monthNamePositions.length - 1) ? monthNamePositions[mi + 1].col : row3.length;

                // 4è¡Œç›®ã§ã“ã®æœˆã®ç¯„å›²å†…ã®ã€Œäºˆç®—ã€ã‚’æ¢ã™
                var budgetCol = -1;
                var subHeaderAtMonthCol = row3[monthCol] ? row3[monthCol].trim() : '';

                // ã¾ãšæœˆåã®åˆ—ã®ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                if (subHeaderAtMonthCol === 'äºˆç®—') {
                    budgetCol = monthCol;
                    addLog(month + ': åˆ—' + monthCol + ' (ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼: ' + subHeaderAtMonthCol + ') â†’ OK', 'success');
                } else {
                    // æœˆåã®åˆ—ãŒã€Œäºˆç®—ã€ã§ãªã„å ´åˆã€ãã®æœˆã®ç¯„å›²å†…ã§ã€Œäºˆç®—ã€ã‚’æ¢ã™
                    addLog(month + ': åˆ—' + monthCol + ' ã®ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã€Œ' + subHeaderAtMonthCol + 'ã€ï¼ˆäºˆç®—ã§ã¯ãªã„ï¼‰', 'warn');

                    for (var j = monthCol; j < nextMonthCol && j < row3.length; j++) {
                        var subHeader = row3[j] ? row3[j].trim() : '';
                        if (subHeader === 'äºˆç®—') {
                            budgetCol = j;
                            addLog(month + ': åˆ—' + j + ' ã§ã€Œäºˆç®—ã€ã‚’ç™ºè¦‹', 'success');
                            break;
                        }
                    }

                    if (budgetCol === -1) {
                        // ã€Œäºˆç®—ã€ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœˆåã®åˆ—ã‚’ãã®ã¾ã¾ä½¿ç”¨
                        budgetCol = monthCol;
                        addLog(month + ': ã€Œäºˆç®—ã€åˆ—ãŒè¦‹ã¤ã‹ã‚‰ãšã€æœˆååˆ—(' + monthCol + ')ã‚’ä½¿ç”¨', 'warn');
                    }
                }

                var finalSubHeader = row3[budgetCol] ? row3[budgetCol].trim() : '';
                var status = finalSubHeader === 'äºˆç®—' ? 'ok' : (finalSubHeader ? 'warn' : 'error');

                results.push({
                    month: month,
                    budgetCol: budgetCol,
                    subHeader: finalSubHeader,
                    status: status
                });

                monthDetectionResults.push({
                    month: month,
                    budgetCol: budgetCol,
                    monthNameCol: monthCol,
                    subHeader: finalSubHeader,
                    status: status
                });
            }

            return results;
        }

        // æœˆåˆ—æ¤œå‡ºçµæœã®è¡¨ç¤º
        function renderMonthColsGrid() {
            document.getElementById('columnDetection').style.display = 'block';
            var grid = document.getElementById('monthColsGrid');

            var html = '';
            monthDetectionResults.forEach(function(r) {
                html += '<div class="month-col-card ' + r.status + '">';
                html += '<div class="month-name">' + r.month + '</div>';
                html += '<div class="col-info">åˆ—' + r.budgetCol + '</div>';
                html += '<div class="sub-header">' + (r.subHeader || '(ç©º)') + '</div>';
                html += '</div>';
            });

            grid.innerHTML = html;

            // ã‚µãƒ³ãƒ—ãƒ«å€¤ã®è¡¨ç¤º
            if (csvLines.length > 5) {
                var sampleHtml = '<h4>å£²ä¸Šé«˜åˆè¨ˆ(999)ã®ã‚µãƒ³ãƒ—ãƒ«å€¤</h4><table class="mapping-table sample-table"><tr><th>æœˆ</th>';
                monthDetectionResults.forEach(function(r) {
                    sampleHtml += '<th>' + r.month + '</th>';
                });
                sampleHtml += '</tr><tr><td>åˆ—ä½ç½®</td>';
                monthDetectionResults.forEach(function(r) {
                    sampleHtml += '<td>åˆ—' + r.budgetCol + '</td>';
                });
                sampleHtml += '</tr><tr><td>å€¤</td>';

                // å£²ä¸Šé«˜åˆè¨ˆã®è¡Œã‚’æ¢ã™
                var sampleRow = null;
                for (var i = 4; i < csvLines.length; i++) {
                    var cols = parseCSVLine(csvLines[i]);
                    var code = extractItemCode(cols[0] || '');
                    if (code === '999') {
                        sampleRow = cols;
                        break;
                    }
                }

                if (sampleRow) {
                    monthDetectionResults.forEach(function(r) {
                        var val = sampleRow[r.budgetCol] || '';
                        var parsed = parseCustomNumber(val);
                        sampleHtml += '<td>' + fmt(parsed) + '</td>';
                    });
                } else {
                    monthDetectionResults.forEach(function() {
                        sampleHtml += '<td>-</td>';
                    });
                }

                sampleHtml += '</tr></table>';
                document.getElementById('sampleValues').innerHTML = sampleHtml;
            }
        }

        // ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ 
        function addMapping() {
            var code = document.getElementById('newCode').value.trim();
            var name = document.getElementById('newName').value.trim();
            var v15No = parseInt(document.getElementById('newV15No').value);
            var category = document.getElementById('newCategory').value;

            if (!code || !name || isNaN(v15No)) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            CUSTOMER_CODE_MAP[code] = { v15No: v15No, name: name, category: category };
            ITEMS[v15No] = { name: name, category: category };

            document.getElementById('newCode').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newV15No').value = '';

            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ : ' + code + ' â†’ [' + v15No + '] ' + name);

            if (document.getElementById('csvFile').files[0]) {
                importCSV();
            }
        }

        function quickAddMapping(code, name) {
            document.getElementById('newCode').value = code;
            document.getElementById('newName').value = name;
            var usedNos = Object.values(CUSTOMER_CODE_MAP).map(function(m) { return m.v15No; });
            for (var i = 51; i <= 100; i++) {
                if (usedNos.indexOf(i) < 0) {
                    document.getElementById('newV15No').value = i;
                    break;
                }
            }
        }

        function deleteMapping(code) {
            if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                delete CUSTOMER_CODE_MAP[code];
                renderMappingTable();
            }
        }

        function renderMappingTable() {
            var html = '<table class="mapping-table">';

            if (isEditMode) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šå…¨ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã‚’è¡¨ç¤º
                html += '<tr><th>ã‚³ãƒ¼ãƒ‰</th><th>é …ç›®å</th><th>v15 No</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ“ä½œ</th></tr>';

                var codes = Object.keys(CUSTOMER_CODE_MAP).sort(function(a, b) {
                    return CUSTOMER_CODE_MAP[a].v15No - CUSTOMER_CODE_MAP[b].v15No;
                });

                codes.forEach(function(code) {
                    var item = CUSTOMER_CODE_MAP[code];
                    var isEditing = (editingCode === code);

                    if (isEditing) {
                        // ç·¨é›†ä¸­ã®è¡Œ
                        html += '<tr style="background:#fff3cd;">';
                        html += '<td><strong>' + code + '</strong></td>';
                        html += '<td><input type="text" id="edit_name_' + code + '" value="' + item.name + '" style="width:150px;padding:3px;"></td>';
                        html += '<td><input type="number" id="edit_v15no_' + code + '" value="' + item.v15No + '" style="width:60px;padding:3px;"></td>';
                        html += '<td><select id="edit_category_' + code + '" style="padding:3px;">';
                        ['å£²ä¸Š', 'åŸä¾¡', 'å›ºå®šäººä»¶è²»', 'PAäººä»¶è²»', 'çµŒè²»', 'å›ºå®šè²»', 'åˆ©ç›Š'].forEach(function(cat) {
                            html += '<option value="' + cat + '"' + (item.category === cat ? ' selected' : '') + '>' + cat + '</option>';
                        });
                        html += '</select></td>';
                        html += '<td>';
                        html += '<button class="btn btn-success" style="padding:2px 8px;font-size:9px;margin-right:3px;" onclick="saveEditMapping(\'' + code + '\')">ä¿å­˜</button>';
                        html += '<button class="btn btn-secondary" style="padding:2px 8px;font-size:9px;" onclick="cancelEditMapping()">å–æ¶ˆ</button>';
                        html += '</td></tr>';
                    } else {
                        // é€šå¸¸è¡¨ç¤ºã®è¡Œ
                        html += '<tr>';
                        html += '<td><strong>' + code + '</strong></td>';
                        html += '<td>' + item.name + '</td>';
                        html += '<td>' + item.v15No + '</td>';
                        html += '<td><span style="background:#e0e0e0;padding:2px 6px;border-radius:3px;font-size:10px;">' + item.category + '</span></td>';
                        html += '<td>';
                        html += '<button class="btn btn-primary" style="padding:2px 8px;font-size:9px;margin-right:3px;" onclick="editMapping(\'' + code + '\')">ç·¨é›†</button>';
                        html += '<button class="btn btn-danger" style="padding:2px 8px;font-size:9px;" onclick="deleteMapping(\'' + code + '\')">å‰Šé™¤</button>';
                        html += '</td></tr>';
                    }
                });
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒƒãƒã—ãŸé …ç›®ã®ã¿è¡¨ç¤ºï¼ˆé€£ç•ªè¡¨ç¤ºï¼‰
                html += '<tr><th>No.</th><th>é …ç›®å</th><th>â†’</th><th>v17 No</th><th>ãƒ©ã‚¯ãƒŸãƒ¼é …ç›®å</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>åˆæœˆå€¤</th></tr>';
                if (matchedItems && matchedItems.length > 0) {
                    matchedItems.forEach(function(item, idx) {
                        var dispNo = item.displayIndex || (idx + 1);
                        var valueStyle = item.hasValue ? '' : 'color:#999;';
                        html += '<tr><td><strong>[' + dispNo + ']</strong></td><td>' + item.name + '</td><td style="color:#28a745;">â†’</td>';
                        html += '<td>' + item.v15No + '</td><td>' + item.v15Name + '</td><td>' + item.category + '</td>';
                        html += '<td style="' + valueStyle + '">' + (item.sampleValue || 0).toLocaleString() + '</td></tr>';
                    });
                } else {
                    html += '<tr><td colspan="7" style="text-align:center;color:#666;padding:20px;">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ãƒãƒƒãƒã—ãŸé …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</td></tr>';
                }
            }

            html += '</table>';

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ä»¶æ•°ã‚’è¡¨ç¤º
            if (isEditMode) {
                html += '<div style="margin-top:10px;font-size:11px;color:#666;">å…¨ ' + Object.keys(CUSTOMER_CODE_MAP).length + ' ä»¶ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©</div>';
            }

            document.getElementById('mappingTable').innerHTML = html;
        }

        function renderUnmatchedItems() {
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
            var matchedCount = matchedItems ? matchedItems.length : 0;
            var unmatchedCount = unmatchedItems ? unmatchedItems.length : 0;

            var matchedDisplay = document.getElementById('matchedCountDisplay');
            var unmatchedDisplay = document.getElementById('unmatchedCountDisplay');
            var unmatchedBadge = document.getElementById('unmatchedBadge');

            if (matchedDisplay) matchedDisplay.textContent = matchedCount;
            if (unmatchedDisplay) unmatchedDisplay.textContent = unmatchedCount;

            // æœªãƒãƒƒãƒãƒãƒƒã‚¸ã®è¡¨ç¤º/éè¡¨ç¤º
            if (unmatchedBadge) {
                unmatchedBadge.style.display = unmatchedCount > 0 ? 'inline-block' : 'none';
            }

            // æœªãƒãƒƒãƒã‚»ã‚¯ã‚·ãƒ§ãƒ³
            var section = document.getElementById('unmatchedSection');
            if (unmatchedCount === 0) {
                if (section) section.style.display = 'none';
                return;
            }

            if (section) section.style.display = 'block';

            // æœªãƒãƒƒãƒé …ç›®ã‚’ãƒãƒƒãƒ—å½¢å¼ã§è¡¨ç¤º
            var html = '';
            unmatchedItems.forEach(function(item) {
                html += '<div style="display:inline-flex;align-items:center;gap:5px;background:#fff;border:1px solid #ffc107;border-radius:20px;padding:5px 12px;font-size:11px;">';
                html += '<span style="font-weight:bold;color:#856404;">' + item.code + '</span>';
                html += '<span style="color:#666;">' + (item.name || '(åç§°ãªã—)') + '</span>';
                html += '<button style="background:#17a2b8;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer;" onclick="quickAddMapping(\'' + item.code + '\', \'' + (item.name || '').replace(/'/g, "\\'") + '\')">+è¿½åŠ </button>';
                html += '</div>';
            });

            var listEl = document.getElementById('unmatchedList');
            if (listEl) listEl.innerHTML = html;

            // é¡ä¼¼ãƒãƒƒãƒãƒ³ã‚°å€™è£œã‚’è¡¨ç¤º
            renderSimilarSuggestions();
        }

        // â˜… ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        var isEditMode = false;

        function toggleEditMode() {
            isEditMode = !isEditMode;
            var label = document.getElementById('editModeLabel');
            if (label) {
                label.textContent = isEditMode ? 'âœ… ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
            }
            renderMappingTable();

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ONæ™‚ã¯ãƒãƒƒãƒ”ãƒ³ã‚°è©³ç´°ã‚’è‡ªå‹•å±•é–‹
            if (isEditMode) {
                var details = document.getElementById('mappingDetails');
                if (details) details.open = true;
            }

            showStatus('info', isEditMode ? 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ' : 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸ');
        }

        // â˜… ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†é–‹å§‹
        var editingCode = null;

        function editMapping(code) {
            editingCode = code;
            renderMappingTable();
        }

        function cancelEditMapping() {
            editingCode = null;
            renderMappingTable();
        }

        function saveEditMapping(code) {
            var nameInput = document.getElementById('edit_name_' + code);
            var v15NoInput = document.getElementById('edit_v15no_' + code);
            var categorySelect = document.getElementById('edit_category_' + code);

            if (!nameInput || !v15NoInput || !categorySelect) return;

            var newName = nameInput.value.trim();
            var newV15No = parseInt(v15NoInput.value);
            var newCategory = categorySelect.value;

            if (!newName || isNaN(newV15No)) {
                alert('é …ç›®åã¨v15ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            CUSTOMER_CODE_MAP[code] = {
                v15No: newV15No,
                name: newName,
                category: newCategory
            };
            ITEMS[newV15No] = { name: newName, category: newCategory };

            editingCode = null;
            renderMappingTable();
            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ' + code);
        }

        // â˜… ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importMappingCSV(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var lines = content.split('\n');
                var codeImportCount = 0;
                var nameImportCount = 0;
                var errorCount = 0;

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ€åˆã®è¡Œï¼‰
                for (var i = 1; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line) continue;

                    var cols = line.split(',');
                    if (cols.length < 4) {
                        errorCount++;
                        continue;
                    }

                    var code = cols[0].trim();
                    var name = cols[1].trim();
                    var v17No = parseInt(cols[2].trim());
                    var category = cols[3].trim();

                    // é …ç›®åã¨v17Noã¯å¿…é ˆ
                    if (!name || isNaN(v17No)) {
                        errorCount++;
                        continue;
                    }

                    if (code) {
                        // ã‚³ãƒ¼ãƒ‰ã‚ã‚Š â†’ CUSTOMER_CODE_MAPã«è¿½åŠ 
                        CUSTOMER_CODE_MAP[code] = { v15No: v17No, name: name, category: category };
                        ITEMS[v17No] = { name: name, category: category };
                        codeImportCount++;
                    } else {
                        // ã‚³ãƒ¼ãƒ‰ãªã— â†’ NAME_BASED_MAPã«è¿½åŠ ï¼ˆé …ç›®åã§ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
                        NAME_BASED_MAP[name] = { v17No: v17No, category: category };
                        ITEMS[v17No] = { name: name, category: category };
                        nameImportCount++;
                    }
                }

                renderMappingTable();
                updateCurrentMappingList();  // è¨­å®šã‚¿ãƒ–ã®ä¸€è¦§ã‚‚æ›´æ–°

                var msg = 'ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ: ';
                var parts = [];
                if (codeImportCount > 0) parts.push('ã‚³ãƒ¼ãƒ‰ä»˜ã ' + codeImportCount + 'ä»¶');
                if (nameImportCount > 0) parts.push('åå‰ãƒ™ãƒ¼ã‚¹ ' + nameImportCount + 'ä»¶');
                if (errorCount > 0) parts.push('ã‚¨ãƒ©ãƒ¼ ' + errorCount + 'ä»¶');
                showStatus('success', msg + parts.join('ã€'));

                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = '';
            };
            reader.readAsText(file, 'UTF-8');
        }

        // â˜… ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportMappingCSV() {
            var csv = [];
            var BOM = '\uFEFF';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            csv.push('ã‚³ãƒ¼ãƒ‰,é …ç›®å,v15ç•ªå·,ã‚«ãƒ†ã‚´ãƒª');

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            for (var code in CUSTOMER_CODE_MAP) {
                var item = CUSTOMER_CODE_MAP[code];
                csv.push([code, item.name, item.v15No, item.category].join(','));
            }

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();

            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // â˜…â˜…â˜… äºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â˜…â˜…â˜…
        function downloadBudgetTemplate() {
            var csv = [];
            var BOM = '\uFEFF';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆäºˆç®—ã‚«ãƒ†ã‚´ãƒª, ç§‘ç›®ã‚³ãƒ¼ãƒ‰, äºˆç®—é …ç›®å, 1æœˆã€œ12æœˆï¼‰
            csv.push('äºˆç®—ã‚«ãƒ†ã‚´ãƒª,ç§‘ç›®ã‚³ãƒ¼ãƒ‰,äºˆç®—é …ç›®å,1æœˆ,2æœˆ,3æœˆ,4æœˆ,5æœˆ,6æœˆ,7æœˆ,8æœˆ,9æœˆ,10æœˆ,11æœˆ,12æœˆ');

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰
            var templateItems = [
                // å£²ä¸Šé«˜
                { category: 'å£²ä¸Šé«˜', code: '101', name: 'åº—èˆ—å£²ä¸Šé«˜' },
                { category: 'å£²ä¸Šé«˜', code: '102', name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š' },
                { category: 'å£²ä¸Šé«˜', code: '103', name: 'ãã®ä»–å£²ä¸Šé«˜' },
                { category: 'å£²ä¸Šé«˜', code: '104', name: 'å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰' },
                // å£²ä¸ŠåŸä¾¡
                { category: 'å£²ä¸ŠåŸä¾¡', code: '201', name: 'é£ŸææœŸé¦–æ£š' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '202', name: 'é£Ÿæä»•å…¥é«˜' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '203', name: 'é£ŸææœŸæœ«æ£š' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '204', name: 'é£ŸæåŸä¾¡' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '205', name: 'ï¾„ï¾ï¾˜ï¾ï½¸æœŸé¦–æ£š' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '206', name: 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥é«˜' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '207', name: 'ï¾„ï¾ï¾˜ï¾ï½¸æœŸæœ«æ£š' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '208', name: 'ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '209', name: 'å†…éƒ¨æŒ¯æ›¿' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '210', name: 'åŸä¾¡åˆè¨ˆ' },
                { category: 'å£²ä¸ŠåŸä¾¡', code: '211', name: 'å£²ä¸Šç·åˆ©ç›Š' },
                // äººä»¶è²»
                { category: 'äººä»¶è²»', code: '301', name: 'çµ¦æ–™æ‰‹å½“' },
                { category: 'äººä»¶è²»', code: '302', name: 'åº—é•·æ–™ç†é•·æ˜‡çµ¦' },
                { category: 'äººä»¶è²»', code: '303', name: 'ç¤¾å“¡çµ¦ä¸' },
                { category: 'äººä»¶è²»', code: '304', name: 'é›‘çµ¦' },
                { category: 'äººä»¶è²»', code: '305', name: 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»' },
                { category: 'äººä»¶è²»', code: '306', name: 'æ³•å®šç¦åˆ©è²»' },
                { category: 'äººä»¶è²»', code: '307', name: 'é€šå‹¤äº¤é€šè²»' },
                { category: 'äººä»¶è²»', code: '308', name: 'è³ä¸å¼•å½“é‡‘ç¹°å…¥' },
                { category: 'äººä»¶è²»', code: '309', name: 'ç¤¾å®…å®¶è³ƒ' },
                { category: 'äººä»¶è²»', code: '310', name: 'ä¼‘æ¥­æ‰‹å½“' },
                { category: 'äººä»¶è²»', code: '311', name: 'äººä»¶è²»åˆè¨ˆ' },
                // æ°´é“å…‰ç†±è²»
                { category: 'æ°´é“å…‰ç†±è²»', code: '401', name: 'é›»æ°—ä»£' },
                { category: 'æ°´é“å…‰ç†±è²»', code: '402', name: 'ã‚¬ã‚¹ä»£' },
                { category: 'æ°´é“å…‰ç†±è²»', code: '403', name: 'æ°´é“ä»£' },
                { category: 'æ°´é“å…‰ç†±è²»', code: '404', name: 'æ°´é“å…‰ç†±è²»åˆè¨ˆ' },
                // è²©ä¿ƒè²»
                { category: 'è²©ä¿ƒè²»', code: '501', name: 'è²©å£²ä¿ƒé€²è²»' },
                { category: 'è²©ä¿ƒè²»', code: '502', name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼' },
                { category: 'è²©ä¿ƒè²»', code: '503', name: 'èª¿æŸ»è²»' },
                { category: 'è²©ä¿ƒè²»', code: '504', name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»' },
                { category: 'è²©ä¿ƒè²»', code: '505', name: 'è²©ä¿ƒè²»åˆè¨ˆ' },
                // åº—èˆ—é‹å–¶è²»
                { category: 'åº—èˆ—é‹å–¶è²»', code: '601', name: 'è¡›ç”Ÿè²»' },
                { category: 'åº—èˆ—é‹å–¶è²»', code: '602', name: 'æ¶ˆè€—å“è²»' },
                { category: 'åº—èˆ—é‹å–¶è²»', code: '603', name: 'ä¿å®ˆä¿®ç¹•è²»' },
                { category: 'åº—èˆ—é‹å–¶è²»', code: '604', name: 'åº—èˆ—é‹å–¶è²»åˆè¨ˆ' },
                // ç®¡ç†è²»
                { category: 'ç®¡ç†è²»', code: '701', name: 'ç§Ÿç¨å…¬èª²' },
                { category: 'ç®¡ç†è²»', code: '702', name: 'æ¥å¾…äº¤éš›è²»' },
                { category: 'ç®¡ç†è²»', code: '703', name: 'æ—…è²»äº¤é€šè²»' },
                { category: 'ç®¡ç†è²»', code: '704', name: 'é€šä¿¡è²»' },
                { category: 'ç®¡ç†è²»', code: '705', name: 'ï½¸ï¾šï½¼ï¾ï½¯ï¾„æ‰‹æ•°æ–™' },
                { category: 'ç®¡ç†è²»', code: '706', name: 'æ”¯æ‰•æ‰‹æ•°æ–™' },
                { category: 'ç®¡ç†è²»', code: '707', name: 'ä¼šè­°è²»' },
                { category: 'ç®¡ç†è²»', code: '708', name: 'è«¸ä¼šè²»' },
                { category: 'ç®¡ç†è²»', code: '709', name: 'é›‘è²»' },
                { category: 'ç®¡ç†è²»', code: '710', name: 'ç®¡ç†è²»åˆè¨ˆ' },
                // æ•™è‚²ãƒ»æ¡ç”¨è²»
                { category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', code: '801', name: 'å›³æ›¸æ•™è‚²è²»' },
                { category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', code: '802', name: 'ç ”ä¿®è²»' },
                { category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', code: '803', name: 'æ¥­æ…‹ç ”ç©¶è²»' },
                { category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', code: '804', name: 'æ¡ç”¨è²»' },
                { category: 'æ•™è‚²ãƒ»æ¡ç”¨è²»', code: '805', name: 'æ•™è‚²ãƒ»æ¡ç”¨è²»åˆè¨ˆ' },
                // ITãƒ»å¤–æ³¨è²»
                { category: 'ITãƒ»å¤–æ³¨è²»', code: '901', name: 'ITè²»' },
                { category: 'ITãƒ»å¤–æ³¨è²»', code: '902', name: 'å¤–æ³¨è²»' },
                { category: 'ITãƒ»å¤–æ³¨è²»', code: '903', name: 'ITãƒ»å¤–æ³¨è²»åˆè¨ˆ' },
                { category: 'ITãƒ»å¤–æ³¨è²»', code: '904', name: 'å¤‰å‹•è²»åˆè¨ˆ' },
                { category: 'ITãƒ»å¤–æ³¨è²»', code: '905', name: 'é™ç•Œåˆ©ç›Š' },
                // å›ºå®šè²»
                { category: 'å›ºå®šè²»', code: '951', name: 'æ¸›ä¾¡å„Ÿå´è²»' },
                { category: 'å›ºå®šè²»', code: '952', name: 'å®¶è³ƒ' },
                { category: 'å›ºå®šè²»', code: '953', name: 'è­¦å‚™æ–™' },
                { category: 'å›ºå®šè²»', code: '954', name: 'ãƒªãƒ¼ã‚¹æ–™' },
                { category: 'å›ºå®šè²»', code: '955', name: 'è³ƒå€Ÿæ–™' },
                { category: 'å›ºå®šè²»', code: '956', name: 'å›ºå®šè²»åˆè¨ˆ' },
                // æç›Š
                { category: 'æç›Š', code: '991', name: 'åº—èˆ—å–¶æ¥­åˆ©ç›Š' },
                { category: 'æç›Š', code: '992', name: 'è²©å£²ç®¡ç†è²»åˆè¨ˆ' },
                { category: 'æç›Š', code: '993', name: 'å–¶æ¥­åˆ©ç›Š' }
            ];

            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡ºåŠ›
            templateItems.forEach(function(item) {
                csv.push([item.category, item.code, item.name, '', '', '', '', '', '', '', '', '', '', '', ''].join(','));
            });

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'äºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();

            showStatus('success', 'äºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ' + templateItems.length + 'é …ç›®ï¼‰');
        }

        // â˜…â˜…â˜… åº—ç•ªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â˜…â˜…â˜…
        function downloadStoreTemplate() {
            var csv = [];
            var BOM = '\uFEFF';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆå‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜å½¢å¼ï¼‰
            csv.push('åº—ç•ª,åº—å');

            // æ—¢å­˜ã®åº—èˆ—ãƒªã‚¹ãƒˆã‹ã‚‰å‡ºåŠ›ï¼ˆ_defaulté™¤ãï¼‰
            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) { return name !== '_default'; });
            storeNames.forEach(function(storeName) {
                var prices = DEFAULT_UNIT_PRICES[storeName];
                var storeCode = prices.storeCode || '';
                csv.push([storeCode, storeName].join(','));
            });

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'åº—ç•ªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();

            showStatus('success', 'åº—ç•ªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ' + storeNames.length + 'åº—èˆ—ï¼‰');
        }

        // â˜…â˜…â˜… äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â˜…â˜…â˜…
        function downloadMappingTemplate() {
            var csv = [];
            var BOM = '\uFEFF';

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            csv.push('ã‚³ãƒ¼ãƒ‰,é …ç›®å,v17No,ã‚«ãƒ†ã‚´ãƒª');

            // 1. ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆCUSTOMER_CODE_MAPï¼‰ã‹ã‚‰å‡ºåŠ›
            var sortedCodes = Object.keys(CUSTOMER_CODE_MAP).sort(function(a, b) {
                return CUSTOMER_CODE_MAP[a].v15No - CUSTOMER_CODE_MAP[b].v15No;
            });

            sortedCodes.forEach(function(code) {
                var item = CUSTOMER_CODE_MAP[code];
                csv.push([code, item.name, item.v15No, item.category].join(','));
            });

            // 2. åå‰ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆNAME_BASED_MAPï¼‰ã‹ã‚‰å‡ºåŠ›ï¼ˆã‚³ãƒ¼ãƒ‰ç©ºæ¬„ï¼‰
            var sortedNames = Object.keys(NAME_BASED_MAP).sort(function(a, b) {
                return NAME_BASED_MAP[a].v17No - NAME_BASED_MAP[b].v17No;
            });

            sortedNames.forEach(function(name) {
                var item = NAME_BASED_MAP[name];
                // ã‚³ãƒ¼ãƒ‰æ¬„ã¯ç©ºã€é …ç›®åãŒã‚­ãƒ¼
                csv.push(['', name, item.v17No, item.category || ''].join(','));
            });

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'äºˆç®—é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();

            showStatus('success', 'äºˆç®—é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆã‚³ãƒ¼ãƒ‰ä»˜ã: ' + sortedCodes.length + 'ä»¶ã€åå‰ãƒ™ãƒ¼ã‚¹: ' + sortedNames.length + 'ä»¶ï¼‰');
        }

        // â˜…â˜…â˜… æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â˜…â˜…â˜…
        function downloadUnitPriceMonthlyTemplate() {
            var csv = [];
            var BOM = '\uFEFF';
            var months = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];
            var types = ['ç·åˆ', 'ãƒ©ãƒ³ãƒ', 'ãƒ‡ã‚£ãƒŠãƒ¼'];
            var typeKeys = { 'ç·åˆ': 'total', 'ãƒ©ãƒ³ãƒ': 'lunch', 'ãƒ‡ã‚£ãƒŠãƒ¼': 'dinner' };

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            csv.push(['åº—ç•ª', 'åº—å', 'å®¢å˜ä¾¡ã‚¿ã‚¤ãƒ—'].concat(months).join(','));

            // æ—¢å­˜ã®åº—èˆ—ãƒªã‚¹ãƒˆã‹ã‚‰å‡ºåŠ›
            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) { return name !== '_default'; });
            storeNames.forEach(function(storeName) {
                var prices = DEFAULT_UNIT_PRICES[storeName];
                var storeCode = prices.storeCode || '';  // å®Ÿéš›ã®åº—ç•ªï¼ˆç©ºæ¬„å¯ï¼‰
                var monthlyData = prices.monthly || {};

                types.forEach(function(typeName) {
                    var typeKey = typeKeys[typeName];
                    var defaultValue = prices[typeKey] || 0;
                    var row = [storeCode, storeName, typeName];

                    // 12ãƒ¶æœˆåˆ†ã®å€¤ã‚’è¿½åŠ 
                    for (var m = 0; m < 12; m++) {
                        var monthValue = monthlyData[m] ? (monthlyData[m][typeKey] || defaultValue) : defaultValue;
                        row.push(monthValue);
                    }
                    csv.push(row.join(','));
                });
            });

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();

            showStatus('success', 'æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ' + storeNames.length + 'åº—èˆ— Ã— 3ã‚¿ã‚¤ãƒ— = ' + (storeNames.length * 3) + 'è¡Œï¼‰');
        }

        // â˜…â˜…â˜… æœˆåˆ¥å®¢å˜ä¾¡ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£ â˜…â˜…â˜…
        function handleUnitPriceDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            var files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                importUnitPriceMonthlyCSV(files[0]);
            } else {
                showUnitPriceImportStatus('error', 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„');
            }
        }

        function handleUnitPriceFileSelect(event) {
            var file = event.target.files[0];
            if (file) {
                importUnitPriceMonthlyCSV(file);
            }
        }

        function showUnitPriceImportStatus(type, message) {
            var container = document.getElementById('unitPriceImportStatus');
            var bgColor = type === 'success' ? '#e8f5e9' : type === 'error' ? '#ffebee' : '#fff3e0';
            var color = type === 'success' ? '#2e7d32' : type === 'error' ? '#c62828' : '#e65100';
            container.innerHTML = '<div style="padding:10px;background:' + bgColor + ';border-radius:4px;color:' + color + ';font-size:12px;">' + message + '</div>';
        }

        function importUnitPriceMonthlyCSV(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var lines = content.split(/\r?\n/).filter(function(line) { return line.trim() !== ''; });

                if (lines.length < 2) {
                    showUnitPriceImportStatus('error', 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
                var headers = lines[0].split(',');
                if (headers.length < 15) {
                    showUnitPriceImportStatus('error', 'CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆ15åˆ—å¿…è¦: åº—ç•ª,åº—å,å®¢å˜ä¾¡ã‚¿ã‚¤ãƒ—,4æœˆã€œ3æœˆï¼‰');
                    return;
                }

                var typeKeys = { 'ç·åˆ': 'total', 'ãƒ©ãƒ³ãƒ': 'lunch', 'ãƒ‡ã‚£ãƒŠãƒ¼': 'dinner' };
                var importedData = {}; // storeName -> { storeCode, total, lunch, dinner, monthly: { 0-11: { total, lunch, dinner } } }
                var importCount = 0;
                var errorCount = 0;

                for (var i = 1; i < lines.length; i++) {
                    var cols = lines[i].split(',');
                    if (cols.length < 15) continue;

                    var storeCode = cols[0].trim();  // åº—ç•ªï¼ˆç©ºæ¬„å¯ï¼‰
                    var storeName = cols[1].trim();  // åº—å
                    var typeName = cols[2].trim();
                    var typeKey = typeKeys[typeName];

                    if (!storeName || !typeKey) {
                        errorCount++;
                        continue;
                    }

                    // åº—èˆ—ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
                    if (!importedData[storeName]) {
                        importedData[storeName] = {
                            storeCode: storeCode,  // åº—ç•ªã‚’ä¿å­˜
                            total: 0, lunch: 0, dinner: 0,
                            monthly: {}
                        };
                    } else if (storeCode && !importedData[storeName].storeCode) {
                        // åº—ç•ªãŒæœªè¨­å®šã®å ´åˆã¯æ›´æ–°
                        importedData[storeName].storeCode = storeCode;
                    }

                    // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿
                    for (var m = 0; m < 12; m++) {
                        var value = parseInt(cols[3 + m], 10) || 0;
                        if (!importedData[storeName].monthly[m]) {
                            importedData[storeName].monthly[m] = { total: 0, lunch: 0, dinner: 0 };
                        }
                        importedData[storeName].monthly[m][typeKey] = value;
                    }

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦4æœˆã®å€¤ã‚’ä½¿ç”¨
                    importedData[storeName][typeKey] = parseInt(cols[3], 10) || 0;

                    importCount++;
                }

                // DEFAULT_UNIT_PRICESã«åæ˜ 
                Object.keys(importedData).forEach(function(storeName) {
                    var data = importedData[storeName];
                    if (!DEFAULT_UNIT_PRICES[storeName]) {
                        DEFAULT_UNIT_PRICES[storeName] = { storeCode: data.storeCode || '', total: 5000, lunch: 0, dinner: 5000 };
                    }
                    // åº—ç•ªã‚’æ›´æ–°ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«åº—ç•ªãŒã‚ã‚‹å ´åˆï¼‰
                    if (data.storeCode) {
                        DEFAULT_UNIT_PRICES[storeName].storeCode = data.storeCode;
                    }
                    DEFAULT_UNIT_PRICES[storeName].total = data.total;
                    DEFAULT_UNIT_PRICES[storeName].lunch = data.lunch;
                    DEFAULT_UNIT_PRICES[storeName].dinner = data.dinner;
                    DEFAULT_UNIT_PRICES[storeName].monthly = data.monthly;
                });

                var storeCount = Object.keys(importedData).length;
                showUnitPriceImportStatus('success', 'æœˆåˆ¥å®¢å˜ä¾¡ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ' + storeCount + 'åº—èˆ—ã€' + importCount + 'è¡Œèª­ã¿è¾¼ã¿' + (errorCount > 0 ? 'ã€' + errorCount + 'è¡Œã‚¨ãƒ©ãƒ¼' : '') + 'ï¼‰');

                // ãƒã‚¹ã‚¿å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
                renderMasterPricesContent();
            };

            reader.onerror = function() {
                showUnitPriceImportStatus('error', 'ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
            };

            reader.readAsText(file, 'UTF-8');
        }

        // â˜…â˜…â˜… åº—ç•ªã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£ â˜…â˜…â˜…
        function handleStoreDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('storeDropZone').classList.remove('drag-over');

            var files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.csv')) {
                importStoreCSV(files[0]);
            } else {
                document.getElementById('storeImportStatus').innerHTML = '<span style="color:#f44336;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
            }
        }

        function handleStoreFileSelect(event) {
            var file = event.target.files[0];
            if (file) {
                importStoreCSV(file);
            }
            event.target.value = '';
        }

        function importStoreCSV(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var lines = content.split('\n');
                var importCount = 0;
                var updateCount = 0;
                var newCount = 0;
                var errorCount = 0;

                for (var i = 1; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line) continue;

                    var cols = line.split(',');
                    if (cols.length < 2) {
                        errorCount++;
                        continue;
                    }

                    var storeCode = cols[0].trim(); // åº—ç•ªï¼ˆç©ºæ¬„å¯ï¼‰
                    var storeName = cols[1].trim(); // åº—å

                    if (!storeName) {
                        errorCount++;
                        continue;
                    }

                    // åº—èˆ—ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ãªã‘ã‚Œã°è¿½åŠ ã€æ—¢å­˜ãªã‚‰åº—ç•ªã‚’æ›´æ–°
                    if (!DEFAULT_UNIT_PRICES[storeName]) {
                        DEFAULT_UNIT_PRICES[storeName] = { storeCode: storeCode, total: 5000, lunch: 0, dinner: 5000 };
                        newCount++;
                    } else {
                        // æ—¢å­˜åº—èˆ—ã®åº—ç•ªã‚’æ›´æ–°
                        DEFAULT_UNIT_PRICES[storeName].storeCode = storeCode;
                        updateCount++;
                    }
                    importCount++;
                }

                updateCurrentStoreList();
                var msg = 'åº—ç•ªCSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ: ' + importCount + 'ä»¶';
                if (newCount > 0) msg += 'ï¼ˆæ–°è¦: ' + newCount + 'ä»¶ï¼‰';
                if (updateCount > 0) msg += 'ï¼ˆæ›´æ–°: ' + updateCount + 'ä»¶ï¼‰';
                if (errorCount > 0) msg += 'ï¼ˆã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶ï¼‰';
                document.getElementById('storeImportStatus').innerHTML =
                    '<span style="color:#4caf50;font-weight:bold;">' + msg + '</span>';
            };
            reader.readAsText(file, 'UTF-8');
        }

        // â˜…â˜…â˜… åº—ç•ªãƒã‚¹ã‚¿ç·¨é›†æ©Ÿèƒ½ â˜…â˜…â˜…

        // åº—ç•ªä¸€è¦§ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleStoreSummary() {
            var container = document.getElementById('storeSummaryList');
            var guide = document.getElementById('storeSummaryGuide');
            var btn = document.getElementById('toggleStoreSummaryBtn');
            if (!container) return;

            if (container.style.display === 'none') {
                // è¡¨ç¤º
                renderStoreSummary();
                container.style.display = 'block';
                if (guide) guide.style.display = 'block';
                if (btn) {
                    btn.innerHTML = 'âœ• åº—ç•ªç·¨é›†ã‚’é–‰ã˜ã‚‹';
                    btn.style.background = '#757575';
                }
            } else {
                // éè¡¨ç¤º
                container.style.display = 'none';
                if (guide) guide.style.display = 'none';
                if (btn) {
                    btn.innerHTML = 'ğŸ“‹ åº—ç•ªç·¨é›†';
                    btn.style.background = '#4caf50';
                }
            }
        }

        // åº—ç•ªä¸€è¦§ã‚’æç”»
        function renderStoreSummary() {
            var container = document.getElementById('storeSummaryList');
            if (!container) return;

            // åº—èˆ—ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆ_defaultã‚’é™¤ãï¼‰
            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) {
                return name !== '_default';
            });

            // sortOrderé †ã§ã‚½ãƒ¼ãƒˆï¼ˆsortOrderãŒãªã‘ã‚Œã°åº—ç•ªé †ã€ãã‚Œã‚‚ãªã‘ã‚Œã°åå‰é †ï¼‰
            storeNames.sort(function(a, b) {
                var storeA = DEFAULT_UNIT_PRICES[a];
                var storeB = DEFAULT_UNIT_PRICES[b];
                var orderA = storeA.sortOrder !== undefined ? storeA.sortOrder : 9999;
                var orderB = storeB.sortOrder !== undefined ? storeB.sortOrder : 9999;
                if (orderA !== orderB) return orderA - orderB;
                // sortOrderãŒåŒã˜å ´åˆã¯åº—ç•ªã§æ¯”è¼ƒ
                var codeA = storeA.storeCode || 'zzzz';
                var codeB = storeB.storeCode || 'zzzz';
                if (codeA !== codeB) return codeA.localeCompare(codeB, undefined, { numeric: true });
                return a.localeCompare(b);
            });

            if (storeNames.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">ç™»éŒ²åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<thead><tr style="background:#c8e6c9;">';
            html += '<th style="padding:10px;text-align:center;width:60px;">é †åº</th>';
            html += '<th style="padding:10px;text-align:center;width:80px;">åº—ç•ª</th>';
            html += '<th style="padding:10px;text-align:left;">åº—å</th>';
            html += '<th style="padding:10px;text-align:right;width:100px;">å®¢å˜ä¾¡(åˆè¨ˆ)</th>';
            html += '<th style="padding:10px;text-align:center;width:120px;">æ“ä½œ</th>';
            html += '</tr></thead><tbody>';

            storeNames.forEach(function(storeName, idx) {
                var store = DEFAULT_UNIT_PRICES[storeName];
                var storeCode = store.storeCode || '';
                var isFirst = idx === 0;
                var isLast = idx === storeNames.length - 1;
                var bgColor = idx % 2 === 0 ? '#fff' : '#f5f5f5';

                html += '<tr style="background:' + bgColor + ';border-bottom:1px solid #e0e0e0;">';

                // é †åºãƒœã‚¿ãƒ³
                html += '<td style="padding:8px;text-align:center;">';
                html += '<button onclick="moveStoreUp(\'' + escapeHtml(storeName).replace(/'/g, "\\'") + '\')" style="background:' + (isFirst ? '#ccc' : '#4caf50') + ';color:#fff;border:none;padding:3px 8px;border-radius:3px;cursor:' + (isFirst ? 'not-allowed' : 'pointer') + ';font-size:10px;margin-right:2px;" ' + (isFirst ? 'disabled' : '') + '>â†‘</button>';
                html += '<button onclick="moveStoreDown(\'' + escapeHtml(storeName).replace(/'/g, "\\'") + '\')" style="background:' + (isLast ? '#ccc' : '#4caf50') + ';color:#fff;border:none;padding:3px 8px;border-radius:3px;cursor:' + (isLast ? 'not-allowed' : 'pointer') + ';font-size:10px;" ' + (isLast ? 'disabled' : '') + '>â†“</button>';
                html += '</td>';

                // åº—ç•ª
                html += '<td style="padding:8px;text-align:center;">';
                if (storeCode) {
                    html += '<code style="background:#e8f5e9;padding:3px 8px;border-radius:3px;color:#2e7d32;">' + storeCode + '</code>';
                } else {
                    html += '<span style="color:#999;font-size:10px;">æœªè¨­å®š</span>';
                }
                html += '</td>';

                // åº—å
                html += '<td style="padding:8px;">' + escapeHtml(storeName) + '</td>';

                // å®¢å˜ä¾¡
                html += '<td style="padding:8px;text-align:right;">' + (store.total || 0).toLocaleString() + 'å††</td>';

                // æ“ä½œãƒœã‚¿ãƒ³
                html += '<td style="padding:8px;text-align:center;">';
                html += '<button onclick="showEditStoreModal(\'' + escapeHtml(storeName).replace(/'/g, "\\'") + '\')" style="background:#ff9800;color:#fff;border:none;padding:4px 10px;border-radius:3px;cursor:pointer;font-size:10px;margin-right:4px;">âœï¸ ç·¨é›†</button>';
                html += '<button onclick="confirmDeleteStore(\'' + escapeHtml(storeName).replace(/'/g, "\\'") + '\')" style="background:#f44336;color:#fff;border:none;padding:4px 10px;border-radius:3px;cursor:pointer;font-size:10px;">ğŸ—‘ï¸</button>';
                html += '</td>';

                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '<div style="padding:10px;text-align:right;color:#666;font-size:11px;">åˆè¨ˆ: ' + storeNames.length + 'åº—èˆ—</div>';
            container.innerHTML = html;
        }

        // åº—èˆ—ã‚’ä¸Šã«ç§»å‹•
        function moveStoreUp(storeName) {
            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) { return name !== '_default'; });
            storeNames.sort(function(a, b) {
                var orderA = DEFAULT_UNIT_PRICES[a].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[a].sortOrder : 9999;
                var orderB = DEFAULT_UNIT_PRICES[b].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[b].sortOrder : 9999;
                return orderA - orderB;
            });

            var idx = storeNames.indexOf(storeName);
            if (idx <= 0) return;

            var prevName = storeNames[idx - 1];
            var currentOrder = DEFAULT_UNIT_PRICES[storeName].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[storeName].sortOrder : idx;
            var prevOrder = DEFAULT_UNIT_PRICES[prevName].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[prevName].sortOrder : idx - 1;

            DEFAULT_UNIT_PRICES[storeName].sortOrder = prevOrder;
            DEFAULT_UNIT_PRICES[prevName].sortOrder = currentOrder;

            renderStoreSummary();
        }

        // åº—èˆ—ã‚’ä¸‹ã«ç§»å‹•
        function moveStoreDown(storeName) {
            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) { return name !== '_default'; });
            storeNames.sort(function(a, b) {
                var orderA = DEFAULT_UNIT_PRICES[a].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[a].sortOrder : 9999;
                var orderB = DEFAULT_UNIT_PRICES[b].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[b].sortOrder : 9999;
                return orderA - orderB;
            });

            var idx = storeNames.indexOf(storeName);
            if (idx < 0 || idx >= storeNames.length - 1) return;

            var nextName = storeNames[idx + 1];
            var currentOrder = DEFAULT_UNIT_PRICES[storeName].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[storeName].sortOrder : idx;
            var nextOrder = DEFAULT_UNIT_PRICES[nextName].sortOrder !== undefined ? DEFAULT_UNIT_PRICES[nextName].sortOrder : idx + 1;

            DEFAULT_UNIT_PRICES[storeName].sortOrder = nextOrder;
            DEFAULT_UNIT_PRICES[nextName].sortOrder = currentOrder;

            renderStoreSummary();
        }

        // æ–°è¦åº—ç•ªè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showAddStoreModal() {
            document.getElementById('storeEditMode').value = 'add';
            document.getElementById('storeEditOriginalName').value = '';
            document.getElementById('storeModalTitle').textContent = 'â• æ–°è¦åº—ç•ªè¿½åŠ ';
            document.getElementById('storeDeleteBtn').style.display = 'none';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('storeEditCode').value = '';
            document.getElementById('storeEditName').value = '';
            document.getElementById('storeEditTotal').value = '5000';
            document.getElementById('storeEditLunch').value = '0';
            document.getElementById('storeEditDinner').value = '5000';

            document.getElementById('storeEditModal').style.display = 'block';
        }

        // åº—ç•ªç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showEditStoreModal(storeName) {
            var store = DEFAULT_UNIT_PRICES[storeName];
            if (!store) {
                alert('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + storeName);
                return;
            }

            document.getElementById('storeEditMode').value = 'edit';
            document.getElementById('storeEditOriginalName').value = storeName;
            document.getElementById('storeModalTitle').textContent = 'âœï¸ åº—ç•ªç·¨é›†';
            document.getElementById('storeDeleteBtn').style.display = 'inline-block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('storeEditCode').value = store.storeCode || '';
            document.getElementById('storeEditName').value = storeName;
            document.getElementById('storeEditTotal').value = store.total || 5000;
            document.getElementById('storeEditLunch').value = store.lunch || 0;
            document.getElementById('storeEditDinner').value = store.dinner || 5000;

            document.getElementById('storeEditModal').style.display = 'block';
        }

        // åº—ç•ªç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        function hideStoreModal() {
            document.getElementById('storeEditModal').style.display = 'none';
        }

        // åº—ç•ªã‚’ä¿å­˜
        function saveStore() {
            var mode = document.getElementById('storeEditMode').value;
            var originalName = document.getElementById('storeEditOriginalName').value;
            var storeCode = document.getElementById('storeEditCode').value.trim();
            var storeName = document.getElementById('storeEditName').value.trim();
            var total = parseInt(document.getElementById('storeEditTotal').value) || 5000;
            var lunch = parseInt(document.getElementById('storeEditLunch').value) || 0;
            var dinner = parseInt(document.getElementById('storeEditDinner').value) || 5000;

            if (!storeName) {
                alert('åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ–°è¦è¿½åŠ æ™‚ã€æ—¢å­˜ã®åº—åã¨é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (mode === 'add' && DEFAULT_UNIT_PRICES[storeName] && storeName !== '_default') {
                alert('åŒã˜åº—åãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™: ' + storeName);
                return;
            }

            // ç·¨é›†æ™‚ã«åº—åã‚’å¤‰æ›´ã—ãŸå ´åˆ
            if (mode === 'edit' && originalName !== storeName) {
                if (DEFAULT_UNIT_PRICES[storeName] && storeName !== '_default') {
                    alert('åŒã˜åº—åãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™: ' + storeName);
                    return;
                }
                // æ—§åº—åã‚’å‰Šé™¤
                var oldStore = DEFAULT_UNIT_PRICES[originalName];
                delete DEFAULT_UNIT_PRICES[originalName];
                // æ–°ã—ã„åº—åã§ä¿å­˜ï¼ˆsortOrderã‚’å¼•ãç¶™ãï¼‰
                DEFAULT_UNIT_PRICES[storeName] = {
                    storeCode: storeCode,
                    total: total,
                    lunch: lunch,
                    dinner: dinner,
                    sortOrder: oldStore ? oldStore.sortOrder : undefined
                };
            } else {
                // æ–°è¦ã¾ãŸã¯åº—åå¤‰æ›´ãªã—
                if (!DEFAULT_UNIT_PRICES[storeName]) {
                    DEFAULT_UNIT_PRICES[storeName] = {};
                }
                DEFAULT_UNIT_PRICES[storeName].storeCode = storeCode;
                DEFAULT_UNIT_PRICES[storeName].total = total;
                DEFAULT_UNIT_PRICES[storeName].lunch = lunch;
                DEFAULT_UNIT_PRICES[storeName].dinner = dinner;
            }

            hideStoreModal();
            renderStoreSummary();
            updateCurrentStoreList();
            showStatus('success', mode === 'add' ? 'åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ' + storeName : 'åº—èˆ—ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ' + storeName);
        }

        // åº—èˆ—å‰Šé™¤ç¢ºèª
        function confirmDeleteStore(storeName) {
            if (confirm('åº—èˆ—ã€Œ' + storeName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                deleteStoreByName(storeName);
            }
        }

        // åº—èˆ—ã‚’å‰Šé™¤ï¼ˆåå‰æŒ‡å®šï¼‰
        function deleteStoreByName(storeName) {
            if (DEFAULT_UNIT_PRICES[storeName]) {
                delete DEFAULT_UNIT_PRICES[storeName];
                renderStoreSummary();
                updateCurrentStoreList();
                showStatus('success', 'åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ' + storeName);
            }
        }

        // åº—èˆ—ã‚’å‰Šé™¤ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ï¼‰
        function deleteStore() {
            var originalName = document.getElementById('storeEditOriginalName').value;
            if (!originalName) return;

            if (confirm('åº—èˆ—ã€Œ' + originalName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                deleteStoreByName(originalName);
                hideStoreModal();
            }
        }

        // åº—ç•ªè¨­å®šã‚’ä¿å­˜ï¼ˆLocalStorageï¼‰
        function saveStoreSettings() {
            try {
                var storeData = {};
                Object.keys(DEFAULT_UNIT_PRICES).forEach(function(name) {
                    if (name !== '_default') {
                        storeData[name] = DEFAULT_UNIT_PRICES[name];
                    }
                });
                localStorage.setItem('rakumy_store_settings', JSON.stringify(storeData));
                showStatus('success', 'åº—ç•ªè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ' + Object.keys(storeData).length + 'åº—èˆ—ï¼‰');
            } catch (e) {
                showStatus('error', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            }
        }

        // åº—ç•ªè¨­å®šã‚’èª­è¾¼ï¼ˆLocalStorageï¼‰
        function loadStoreSettings() {
            try {
                var saved = localStorage.getItem('rakumy_store_settings');
                if (saved) {
                    var storeData = JSON.parse(saved);
                    Object.keys(storeData).forEach(function(name) {
                        if (name !== '_default') {
                            DEFAULT_UNIT_PRICES[name] = storeData[name];
                        }
                    });
                    console.log('[loadStoreSettings] åº—ç•ªè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(storeData).length + 'åº—èˆ—');
                }
            } catch (e) {
                console.error('[loadStoreSettings] ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // â˜…â˜…â˜… å®¢å˜ä¾¡ãƒã‚¹ã‚¿ç·¨é›†æ©Ÿèƒ½ â˜…â˜…â˜…

        // å®¢å˜ä¾¡ä¸€è¦§ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleUnitPriceSummary() {
            var container = document.getElementById('unitPriceSummaryList');
            var guide = document.getElementById('unitPriceSummaryGuide');
            var btn = document.getElementById('toggleUnitPriceSummaryBtn');
            if (!container) return;

            if (container.style.display === 'none') {
                // è¡¨ç¤º
                renderUnitPriceSummary();
                container.style.display = 'block';
                if (guide) guide.style.display = 'block';
                if (btn) {
                    btn.innerHTML = 'âœ• å®¢å˜ä¾¡ç·¨é›†ã‚’é–‰ã˜ã‚‹';
                    btn.style.background = '#757575';
                }
            } else {
                // éè¡¨ç¤º
                container.style.display = 'none';
                if (guide) guide.style.display = 'none';
                if (btn) {
                    btn.innerHTML = 'ğŸ“‹ å®¢å˜ä¾¡ç·¨é›†';
                    btn.style.background = '#2196f3';
                }
            }
        }

        // å®¢å˜ä¾¡ä¸€è¦§ã‚’æç”»
        function renderUnitPriceSummary() {
            var container = document.getElementById('unitPriceSummaryList');
            if (!container) return;

            // æœˆãƒ©ãƒ™ãƒ«ï¼ˆ4æœˆå§‹ã¾ã‚Šï¼‰
            var monthLabels = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];
            var monthIndices = [3, 4, 5, 6, 7, 8, 9, 10, 11, 0, 1, 2]; // æœˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0=1æœˆï¼‰

            // åº—èˆ—ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆ_defaultã‚’é™¤ãï¼‰
            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) {
                return name !== '_default';
            });

            // sortOrderé †ã¾ãŸã¯åº—ç•ªé †ã§ã‚½ãƒ¼ãƒˆ
            storeNames.sort(function(a, b) {
                var storeA = DEFAULT_UNIT_PRICES[a];
                var storeB = DEFAULT_UNIT_PRICES[b];
                var orderA = storeA.sortOrder !== undefined ? storeA.sortOrder : 9999;
                var orderB = storeB.sortOrder !== undefined ? storeB.sortOrder : 9999;
                if (orderA !== orderB) return orderA - orderB;
                var codeA = storeA.storeCode || 'zzzz';
                var codeB = storeB.storeCode || 'zzzz';
                if (codeA !== codeB) return codeA.localeCompare(codeB, undefined, { numeric: true });
                return a.localeCompare(b);
            });

            if (storeNames.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">ç™»éŒ²åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            var html = '<div style="overflow-x:auto;">';
            html += '<table style="width:100%;border-collapse:collapse;font-size:11px;min-width:1200px;">';
            html += '<thead><tr style="background:#bbdefb;">';
            html += '<th style="padding:8px;text-align:center;width:60px;position:sticky;left:0;background:#bbdefb;z-index:1;">åº—ç•ª</th>';
            html += '<th style="padding:8px;text-align:left;min-width:120px;position:sticky;left:60px;background:#bbdefb;z-index:1;">åº—å</th>';
            html += '<th style="padding:8px;text-align:center;width:50px;">ç¨®åˆ¥</th>';
            // æœˆåˆ¥ãƒ˜ãƒƒãƒ€ãƒ¼
            for (var m = 0; m < 12; m++) {
                html += '<th style="padding:6px;text-align:right;width:65px;">' + monthLabels[m] + '</th>';
            }
            html += '<th style="padding:8px;text-align:right;width:70px;background:#fff3e0;">å¹³å‡</th>';
            html += '<th style="padding:8px;text-align:center;width:100px;">æ“ä½œ</th>';
            html += '</tr></thead><tbody>';

            storeNames.forEach(function(storeName, idx) {
                var store = DEFAULT_UNIT_PRICES[storeName];
                var storeCode = store.storeCode || '';
                var monthly = store.monthly || {};
                var bgColor = idx % 2 === 0 ? '#fff' : '#f5f5f5';
                var escapedName = escapeHtml(storeName).replace(/'/g, "\\'");

                // ç·åˆè¡Œ
                html += '<tr style="background:' + bgColor + ';border-bottom:1px solid #e8e8e8;">';
                html += '<td rowspan="3" style="padding:6px;text-align:center;position:sticky;left:0;background:' + bgColor + ';border-right:1px solid #ddd;">';
                if (storeCode) {
                    html += '<code style="background:#e3f2fd;padding:2px 6px;border-radius:3px;color:#1565c0;font-size:10px;">' + storeCode + '</code>';
                } else {
                    html += '<span style="color:#999;font-size:9px;">-</span>';
                }
                html += '</td>';
                html += '<td rowspan="3" style="padding:6px;position:sticky;left:60px;background:' + bgColor + ';border-right:1px solid #ddd;font-weight:bold;">' + escapeHtml(storeName) + '</td>';
                html += '<td style="padding:4px;text-align:center;background:#e3f2fd;color:#1565c0;font-weight:bold;font-size:10px;">ç·åˆ</td>';
                var totalSum = 0;
                for (var m = 0; m < 12; m++) {
                    var mi = monthIndices[m];
                    var val = monthly[mi] ? (monthly[mi].total || store.total || 0) : (store.total || 0);
                    totalSum += val;
                    html += '<td style="padding:4px;text-align:right;font-weight:bold;color:#1565c0;">' + val.toLocaleString() + '</td>';
                }
                html += '<td style="padding:4px;text-align:right;background:#fff3e0;font-weight:bold;color:#e65100;">' + Math.round(totalSum / 12).toLocaleString() + '</td>';
                html += '<td rowspan="3" style="padding:6px;text-align:center;vertical-align:middle;">';
                html += '<button onclick="showUnitPriceEditModal(\'' + escapedName + '\')" style="background:#2196f3;color:#fff;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:9px;margin-bottom:4px;display:block;width:100%;">âœï¸ ç·¨é›†</button>';
                html += '<button onclick="confirmDeleteUnitPrice(\'' + escapedName + '\')" style="background:#f44336;color:#fff;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:9px;display:block;width:100%;">ğŸ—‘ï¸ å‰Šé™¤</button>';
                html += '</td>';
                html += '</tr>';

                // ãƒ©ãƒ³ãƒè¡Œ
                html += '<tr style="background:' + bgColor + ';border-bottom:1px solid #e8e8e8;">';
                html += '<td style="padding:4px;text-align:center;background:#e8f5e9;color:#2e7d32;font-size:10px;">ãƒ©ãƒ³ãƒ</td>';
                var lunchSum = 0;
                for (var m = 0; m < 12; m++) {
                    var mi = monthIndices[m];
                    var val = monthly[mi] ? (monthly[mi].lunch || store.lunch || 0) : (store.lunch || 0);
                    lunchSum += val;
                    html += '<td style="padding:4px;text-align:right;color:#666;font-size:10px;">' + val.toLocaleString() + '</td>';
                }
                html += '<td style="padding:4px;text-align:right;background:#fff3e0;color:#666;font-size:10px;">' + Math.round(lunchSum / 12).toLocaleString() + '</td>';
                html += '</tr>';

                // ãƒ‡ã‚£ãƒŠãƒ¼è¡Œ
                html += '<tr style="background:' + bgColor + ';border-bottom:2px solid #bbb;">';
                html += '<td style="padding:4px;text-align:center;background:#fce4ec;color:#c2185b;font-size:10px;">ãƒ‡ã‚£ãƒŠãƒ¼</td>';
                var dinnerSum = 0;
                for (var m = 0; m < 12; m++) {
                    var mi = monthIndices[m];
                    var val = monthly[mi] ? (monthly[mi].dinner || store.dinner || 0) : (store.dinner || 0);
                    dinnerSum += val;
                    html += '<td style="padding:4px;text-align:right;color:#666;font-size:10px;">' + val.toLocaleString() + '</td>';
                }
                html += '<td style="padding:4px;text-align:right;background:#fff3e0;color:#666;font-size:10px;">' + Math.round(dinnerSum / 12).toLocaleString() + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            html += '<div style="padding:10px;display:flex;justify-content:space-between;align-items:center;color:#666;font-size:11px;">';
            html += '<span>â€» æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§å…¨æœˆã‚’è¡¨ç¤º</span>';
            html += '<span>åˆè¨ˆ: ' + storeNames.length + 'åº—èˆ—</span>';
            html += '</div>';
            container.innerHTML = html;
        }

        // å®¢å˜ä¾¡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆæœˆåˆ¥å¯¾å¿œï¼‰
        function showUnitPriceEditModal(storeName) {
            var store = DEFAULT_UNIT_PRICES[storeName];
            if (!store) {
                alert('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + storeName);
                return;
            }

            document.getElementById('unitPriceEditStoreName').value = storeName;
            document.getElementById('unitPriceStoreNameDisplay').textContent = storeName;
            document.getElementById('unitPriceModalTitle').textContent = 'ğŸ’° å®¢å˜ä¾¡ç·¨é›†: ' + storeName;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            document.getElementById('unitPriceEditTotal').value = store.total || 5000;
            document.getElementById('unitPriceEditLunch').value = store.lunch || 0;
            document.getElementById('unitPriceEditDinner').value = store.dinner || 5000;

            // æœˆåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
            renderMonthlyUnitPriceTable(store);

            document.getElementById('unitPriceEditModal').style.display = 'block';
        }

        // æœˆåˆ¥å®¢å˜ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
        function renderMonthlyUnitPriceTable(store) {
            var monthIndices = [3, 4, 5, 6, 7, 8, 9, 10, 11, 0, 1, 2]; // 4æœˆã€œ3æœˆ
            var monthly = store.monthly || {};
            var defaultTotal = store.total || 5000;
            var defaultLunch = store.lunch || 0;
            var defaultDinner = store.dinner || 5000;

            var html = '';

            // ç·åˆè¡Œ
            html += '<tr style="background:#e3f2fd;">';
            html += '<td style="padding:6px;text-align:center;font-weight:bold;color:#1565c0;">ç·åˆ</td>';
            for (var m = 0; m < 12; m++) {
                var mi = monthIndices[m];
                var val = monthly[mi] ? (monthly[mi].total !== undefined ? monthly[mi].total : defaultTotal) : defaultTotal;
                html += '<td style="padding:4px;"><input type="number" id="upTotal_' + mi + '" value="' + val + '" style="width:55px;padding:4px;font-size:11px;border:1px solid #ccc;border-radius:3px;text-align:right;"></td>';
            }
            html += '</tr>';

            // ãƒ©ãƒ³ãƒè¡Œ
            html += '<tr style="background:#e8f5e9;">';
            html += '<td style="padding:6px;text-align:center;font-weight:bold;color:#2e7d32;">ãƒ©ãƒ³ãƒ</td>';
            for (var m = 0; m < 12; m++) {
                var mi = monthIndices[m];
                var val = monthly[mi] ? (monthly[mi].lunch !== undefined ? monthly[mi].lunch : defaultLunch) : defaultLunch;
                html += '<td style="padding:4px;"><input type="number" id="upLunch_' + mi + '" value="' + val + '" style="width:55px;padding:4px;font-size:11px;border:1px solid #ccc;border-radius:3px;text-align:right;"></td>';
            }
            html += '</tr>';

            // ãƒ‡ã‚£ãƒŠãƒ¼è¡Œ
            html += '<tr style="background:#fce4ec;">';
            html += '<td style="padding:6px;text-align:center;font-weight:bold;color:#c2185b;">ãƒ‡ã‚£ãƒŠãƒ¼</td>';
            for (var m = 0; m < 12; m++) {
                var mi = monthIndices[m];
                var val = monthly[mi] ? (monthly[mi].dinner !== undefined ? monthly[mi].dinner : defaultDinner) : defaultDinner;
                html += '<td style="padding:4px;"><input type="number" id="upDinner_' + mi + '" value="' + val + '" style="width:55px;padding:4px;font-size:11px;border:1px solid #ccc;border-radius:3px;text-align:right;"></td>';
            }
            html += '</tr>';

            document.getElementById('monthlyUnitPriceBody').innerHTML = html;
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å…¨æœˆã«é©ç”¨
        function applyDefaultToAllMonths() {
            var total = parseInt(document.getElementById('unitPriceEditTotal').value) || 5000;
            var lunch = parseInt(document.getElementById('unitPriceEditLunch').value) || 0;
            var dinner = parseInt(document.getElementById('unitPriceEditDinner').value) || 5000;

            var monthIndices = [3, 4, 5, 6, 7, 8, 9, 10, 11, 0, 1, 2];
            for (var m = 0; m < 12; m++) {
                var mi = monthIndices[m];
                var totalInput = document.getElementById('upTotal_' + mi);
                var lunchInput = document.getElementById('upLunch_' + mi);
                var dinnerInput = document.getElementById('upDinner_' + mi);
                if (totalInput) totalInput.value = total;
                if (lunchInput) lunchInput.value = lunch;
                if (dinnerInput) dinnerInput.value = dinner;
            }
            showStatus('info', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å…¨æœˆã«é©ç”¨ã—ã¾ã—ãŸ');
        }

        // å®¢å˜ä¾¡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        function hideUnitPriceModal() {
            document.getElementById('unitPriceEditModal').style.display = 'none';
        }

        // å®¢å˜ä¾¡ã‚’ä¿å­˜ï¼ˆæœˆåˆ¥å¯¾å¿œï¼‰
        function saveUnitPrice() {
            var storeName = document.getElementById('unitPriceEditStoreName').value;
            if (!storeName || !DEFAULT_UNIT_PRICES[storeName]) {
                alert('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            var total = parseInt(document.getElementById('unitPriceEditTotal').value) || 5000;
            var lunch = parseInt(document.getElementById('unitPriceEditLunch').value) || 0;
            var dinner = parseInt(document.getElementById('unitPriceEditDinner').value) || 5000;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä¿å­˜
            DEFAULT_UNIT_PRICES[storeName].total = total;
            DEFAULT_UNIT_PRICES[storeName].lunch = lunch;
            DEFAULT_UNIT_PRICES[storeName].dinner = dinner;

            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            var monthIndices = [3, 4, 5, 6, 7, 8, 9, 10, 11, 0, 1, 2];
            if (!DEFAULT_UNIT_PRICES[storeName].monthly) {
                DEFAULT_UNIT_PRICES[storeName].monthly = {};
            }

            for (var m = 0; m < 12; m++) {
                var mi = monthIndices[m];
                var totalInput = document.getElementById('upTotal_' + mi);
                var lunchInput = document.getElementById('upLunch_' + mi);
                var dinnerInput = document.getElementById('upDinner_' + mi);

                if (totalInput && lunchInput && dinnerInput) {
                    DEFAULT_UNIT_PRICES[storeName].monthly[mi] = {
                        total: parseInt(totalInput.value) || total,
                        lunch: parseInt(lunchInput.value) || lunch,
                        dinner: parseInt(dinnerInput.value) || dinner
                    };
                }
            }

            hideUnitPriceModal();
            renderUnitPriceSummary();
            updateCurrentStoreList();
            showStatus('success', 'å®¢å˜ä¾¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ' + storeName);
        }

        // å®¢å˜ä¾¡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        function resetUnitPriceToDefault() {
            var storeName = document.getElementById('unitPriceEditStoreName').value;
            if (!storeName) return;

            if (confirm('ã€Œ' + storeName + 'ã€ã®å®¢å˜ä¾¡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆç·åˆ:5000å††ã€ãƒ©ãƒ³ãƒ:0å††ã€ãƒ‡ã‚£ãƒŠãƒ¼:5000å††ï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                DEFAULT_UNIT_PRICES[storeName].total = 5000;
                DEFAULT_UNIT_PRICES[storeName].lunch = 0;
                DEFAULT_UNIT_PRICES[storeName].dinner = 5000;

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚‚æ›´æ–°
                document.getElementById('unitPriceEditTotal').value = 5000;
                document.getElementById('unitPriceEditLunch').value = 0;
                document.getElementById('unitPriceEditDinner').value = 5000;

                renderUnitPriceSummary();
                updateCurrentStoreList();
                showStatus('success', 'å®¢å˜ä¾¡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ: ' + storeName);
            }
        }

        // å®¢å˜ä¾¡å‰Šé™¤ç¢ºèª
        function confirmDeleteUnitPrice(storeName) {
            if (confirm('ã€Œ' + storeName + 'ã€ã®å®¢å˜ä¾¡è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆç·åˆ:5000å††ï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                DEFAULT_UNIT_PRICES[storeName].total = 5000;
                DEFAULT_UNIT_PRICES[storeName].lunch = 0;
                DEFAULT_UNIT_PRICES[storeName].dinner = 5000;
                renderUnitPriceSummary();
                updateCurrentStoreList();
                showStatus('success', 'å®¢å˜ä¾¡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ: ' + storeName);
            }
        }

        // å®¢å˜ä¾¡è¨­å®šã‚’ä¿å­˜ï¼ˆLocalStorageï¼‰
        function saveUnitPriceSettings() {
            try {
                var priceData = {};
                Object.keys(DEFAULT_UNIT_PRICES).forEach(function(name) {
                    if (name !== '_default') {
                        priceData[name] = {
                            total: DEFAULT_UNIT_PRICES[name].total,
                            lunch: DEFAULT_UNIT_PRICES[name].lunch,
                            dinner: DEFAULT_UNIT_PRICES[name].dinner
                        };
                    }
                });
                localStorage.setItem('rakumy_unit_price_settings', JSON.stringify(priceData));
                showStatus('success', 'å®¢å˜ä¾¡è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ' + Object.keys(priceData).length + 'åº—èˆ—ï¼‰');
            } catch (e) {
                showStatus('error', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            }
        }

        // å®¢å˜ä¾¡è¨­å®šã‚’èª­è¾¼ï¼ˆLocalStorageï¼‰
        function loadUnitPriceSettings() {
            try {
                var saved = localStorage.getItem('rakumy_unit_price_settings');
                if (saved) {
                    var priceData = JSON.parse(saved);
                    Object.keys(priceData).forEach(function(name) {
                        if (name !== '_default' && DEFAULT_UNIT_PRICES[name]) {
                            DEFAULT_UNIT_PRICES[name].total = priceData[name].total;
                            DEFAULT_UNIT_PRICES[name].lunch = priceData[name].lunch;
                            DEFAULT_UNIT_PRICES[name].dinner = priceData[name].dinner;
                        }
                    });
                    console.log('[loadUnitPriceSettings] å®¢å˜ä¾¡è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(priceData).length + 'åº—èˆ—');
                }
            } catch (e) {
                console.error('[loadUnitPriceSettings] ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // â˜…â˜…â˜… ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç† â˜…â˜…â˜…
        function handleMappingDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('mappingDropZone').classList.remove('drag-over');

            var files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.csv')) {
                // æ—¢å­˜ã®importMappingCSVã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¨¡æ“¬
                var fakeEvent = { target: { files: files, value: '' } };
                importMappingCSV(fakeEvent);
                updateCurrentMappingList();
            } else {
                document.getElementById('mappingImportStatus').innerHTML = '<span style="color:#f44336;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
            }
        }

        // â˜…â˜…â˜… ç¾åœ¨ã®åº—èˆ—ä¸€è¦§ã‚’æ›´æ–° â˜…â˜…â˜…
        function updateCurrentStoreList() {
            var container = document.getElementById('currentStoreList');
            if (!container) return;

            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) { return name !== '_default'; });
            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#2e7d32;color:#fff;"><th style="padding:8px;text-align:center;">åº—ç•ª</th><th style="padding:8px;text-align:left;">åº—å</th><th style="padding:8px;text-align:right;">å®¢å˜ä¾¡(ç·åˆ)</th><th style="padding:8px;text-align:right;">å®¢å˜ä¾¡(ãƒ©ãƒ³ãƒ)</th><th style="padding:8px;text-align:right;">å®¢å˜ä¾¡(ãƒ‡ã‚£ãƒŠãƒ¼)</th></tr>';

            storeNames.forEach(function(storeName, index) {
                var prices = DEFAULT_UNIT_PRICES[storeName];
                var bgColor = index % 2 === 0 ? '#fff' : '#f5f5f5';
                var storeCode = prices.storeCode || '';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:6px 8px;text-align:center;font-family:monospace;color:' + (storeCode ? '#333' : '#999') + ';">' + (storeCode || 'æœªè¨­å®š') + '</td>';
                html += '<td style="padding:6px 8px;">' + escapeHtml(storeName) + '</td>';
                html += '<td style="padding:6px 8px;text-align:right;">' + (prices.total || 0).toLocaleString() + 'å††</td>';
                html += '<td style="padding:6px 8px;text-align:right;">' + (prices.lunch || 0).toLocaleString() + 'å††</td>';
                html += '<td style="padding:6px 8px;text-align:right;">' + (prices.dinner || 0).toLocaleString() + 'å††</td>';
                html += '</tr>';
            });

            html += '</table>';
            html += '<div style="margin-top:10px;font-size:11px;color:#666;">åˆè¨ˆ: ' + storeNames.length + 'åº—èˆ—</div>';
            container.innerHTML = html;
        }

        // â˜…â˜…â˜… ç¾åœ¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ä¸€è¦§ã‚’æ›´æ–° â˜…â˜…â˜…
        function updateCurrentMappingList() {
            var container = document.getElementById('currentMappingList');
            if (!container) return;

            var html = '';

            // === ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆCUSTOMER_CODE_MAPï¼‰ ===
            var sortedCodes = Object.keys(CUSTOMER_CODE_MAP).sort(function(a, b) {
                return CUSTOMER_CODE_MAP[a].v15No - CUSTOMER_CODE_MAP[b].v15No;
            });

            html += '<h4 style="color:#e65100;margin:0 0 10px 0;font-size:13px;">ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆCUSTOMER_CODE_MAPï¼‰</h4>';
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:20px;">';
            html += '<tr style="background:#e65100;color:#fff;"><th style="padding:8px;text-align:left;">ã‚³ãƒ¼ãƒ‰</th><th style="padding:8px;text-align:left;">é …ç›®å</th><th style="padding:8px;text-align:center;">v17No</th><th style="padding:8px;text-align:left;">ã‚«ãƒ†ã‚´ãƒª</th></tr>';

            sortedCodes.forEach(function(code, index) {
                var item = CUSTOMER_CODE_MAP[code];
                var bgColor = index % 2 === 0 ? '#fff' : '#fff8e1';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:6px 8px;font-family:monospace;">' + escapeHtml(code) + '</td>';
                html += '<td style="padding:6px 8px;">' + escapeHtml(item.name) + '</td>';
                html += '<td style="padding:6px 8px;text-align:center;">' + item.v15No + '</td>';
                html += '<td style="padding:6px 8px;">' + escapeHtml(item.category) + '</td>';
                html += '</tr>';
            });
            html += '</table>';
            html += '<div style="font-size:11px;color:#666;margin-bottom:15px;">ã‚³ãƒ¼ãƒ‰ä»˜ã: ' + sortedCodes.length + 'é …ç›®</div>';

            // === åå‰ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆNAME_BASED_MAPï¼‰===
            var sortedNames = Object.keys(NAME_BASED_MAP).sort(function(a, b) {
                return NAME_BASED_MAP[a].v17No - NAME_BASED_MAP[b].v17No;
            });

            html += '<h4 style="color:#1565c0;margin:0 0 10px 0;font-size:13px;">åå‰ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆNAME_BASED_MAPï¼‰</h4>';
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#1565c0;color:#fff;"><th style="padding:8px;text-align:left;">é …ç›®åï¼ˆã‚­ãƒ¼ï¼‰</th><th style="padding:8px;text-align:center;">v17No</th><th style="padding:8px;text-align:left;">ã‚«ãƒ†ã‚´ãƒª</th></tr>';

            sortedNames.forEach(function(name, index) {
                var item = NAME_BASED_MAP[name];
                var bgColor = index % 2 === 0 ? '#fff' : '#e3f2fd';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:6px 8px;">' + escapeHtml(name) + '</td>';
                html += '<td style="padding:6px 8px;text-align:center;">' + item.v17No + '</td>';
                html += '<td style="padding:6px 8px;">' + escapeHtml(item.category || '-') + '</td>';
                html += '</tr>';
            });
            html += '</table>';
            html += '<div style="font-size:11px;color:#666;margin-top:10px;">åå‰ãƒ™ãƒ¼ã‚¹: ' + sortedNames.length + 'é …ç›®</div>';

            container.innerHTML = html;
        }

        // â˜…â˜…â˜… ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å±¥æ­´æ©Ÿèƒ½ â˜…â˜…â˜…
        var MASTER_HISTORY_KEY = 'budgetSimulator_masterHistory';
        var MAX_MASTER_HISTORY = 10;

        function showMasterDataModal() {
            document.getElementById('masterDataModal').style.display = 'block';
            renderMasterHistoryList();
            renderMasterStoresContent();
            renderMasterItemsContent();
            renderMasterPricesContent();
            switchMasterTab('stores');
        }

        function hideMasterDataModal() {
            document.getElementById('masterDataModal').style.display = 'none';
        }

        function switchMasterTab(tab) {
            var storesBtn = document.getElementById('masterTabStores');
            var itemsBtn = document.getElementById('masterTabItems');
            var pricesBtn = document.getElementById('masterTabPrices');
            var storesContent = document.getElementById('masterStoresContent');
            var itemsContent = document.getElementById('masterItemsContent');
            var pricesContent = document.getElementById('masterPricesContent');

            // å…¨ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            storesBtn.style.background = '#e0e0e0';
            storesBtn.style.color = '#333';
            itemsBtn.style.background = '#e0e0e0';
            itemsBtn.style.color = '#333';
            pricesBtn.style.background = '#e0e0e0';
            pricesBtn.style.color = '#333';
            storesContent.style.display = 'none';
            itemsContent.style.display = 'none';
            pricesContent.style.display = 'none';

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            if (tab === 'stores') {
                storesBtn.style.background = '#4caf50';
                storesBtn.style.color = '#fff';
                storesContent.style.display = 'block';
            } else if (tab === 'items') {
                itemsBtn.style.background = '#ff9800';
                itemsBtn.style.color = '#fff';
                itemsContent.style.display = 'block';
            } else if (tab === 'prices') {
                pricesBtn.style.background = '#2196f3';
                pricesBtn.style.color = '#fff';
                pricesContent.style.display = 'block';
            }
        }

        function saveMasterDataToHistory() {
            // å¹´æœˆæ—¥æ™‚åˆ»å½¢å¼ã§è‡ªå‹•å‘½å
            var now = new Date();
            var name = now.getFullYear() + '/' +
                       String(now.getMonth() + 1).padStart(2, '0') + '/' +
                       String(now.getDate()).padStart(2, '0') + ' ' +
                       String(now.getHours()).padStart(2, '0') + ':' +
                       String(now.getMinutes()).padStart(2, '0') + ':' +
                       String(now.getSeconds()).padStart(2, '0');

            // â˜… 3ã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã¦ä¿å­˜
            var masterData = {
                id: Date.now(),
                name: name,
                savedAt: new Date().toISOString(),
                // ã‚«ãƒ†ã‚´ãƒª1: åº—ç•ªãƒã‚¹ã‚¿ï¼ˆåº—èˆ—åãƒªã‚¹ãƒˆï¼‰
                storeNames: Object.keys(DEFAULT_UNIT_PRICES),
                storeCount: Object.keys(DEFAULT_UNIT_PRICES).length,
                // ã‚«ãƒ†ã‚´ãƒª2: äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿
                codeMap: JSON.parse(JSON.stringify(CUSTOMER_CODE_MAP)),
                nameMap: JSON.parse(JSON.stringify(NAME_BASED_MAP)),
                codeMapCount: Object.keys(CUSTOMER_CODE_MAP).length,
                nameMapCount: Object.keys(NAME_BASED_MAP).length,
                // ã‚«ãƒ†ã‚´ãƒª3: å®¢å˜ä¾¡ãƒã‚¹ã‚¿ï¼ˆåº—åˆ¥ç›®æ¨™å®¢å˜ä¾¡ï¼‰
                unitPrices: JSON.parse(JSON.stringify(DEFAULT_UNIT_PRICES)),
                // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ stores ã‚‚ä¿æŒ
                stores: JSON.parse(JSON.stringify(DEFAULT_UNIT_PRICES))
            };

            var history = getMasterHistory();
            history.unshift(masterData);
            if (history.length > MAX_MASTER_HISTORY) {
                history = history.slice(0, MAX_MASTER_HISTORY);
            }

            localStorage.setItem(MASTER_HISTORY_KEY, JSON.stringify(history));
            showStatus('success', 'ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ: ' + name);
            renderMasterHistoryList();
        }

        function getMasterHistory() {
            try {
                var data = localStorage.getItem(MASTER_HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                return [];
            }
        }

        // ===== ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºé †è¨­å®šæ©Ÿèƒ½ =====
        var CATEGORY_ORDER_KEY = 'rakumy_category_order';
        var ITEM_ORDER_KEY = 'rakumy_item_order';

        // è¡¨ç¤ºé †è¨­å®šã‚’ä¿å­˜
        function saveCategorySettings() {
            try {
                // ã‚«ãƒ†ã‚´ãƒªé †ã‚’ä¿å­˜
                var categoryOrder = {};
                for (var cat in BUDGET_CATEGORY_MAP) {
                    categoryOrder[cat] = BUDGET_CATEGORY_MAP[cat].displayOrder;
                }

                // é …ç›®é †ã‚’ä¿å­˜
                var itemOrder = {};
                for (var code in CUSTOMER_CODE_MAP) {
                    var item = CUSTOMER_CODE_MAP[code];
                    if (!itemOrder[item.budgetCategory]) {
                        itemOrder[item.budgetCategory] = {};
                    }
                    itemOrder[item.budgetCategory][code] = item.sortOrder;
                }

                var settings = {
                    categoryOrder: categoryOrder,
                    itemOrder: itemOrder,
                    savedAt: new Date().toISOString()
                };

                localStorage.setItem(CATEGORY_ORDER_KEY, JSON.stringify(settings));
                showStatus('success', 'è¡¨ç¤ºé †è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (e) {
                console.error('è¡¨ç¤ºé †è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', e);
                showStatus('error', 'è¡¨ç¤ºé †è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // è¡¨ç¤ºé †è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadCategorySettings() {
            try {
                var saved = localStorage.getItem(CATEGORY_ORDER_KEY);
                if (!saved) return false;

                var settings = JSON.parse(saved);

                // ã‚«ãƒ†ã‚´ãƒªé †ã‚’å¾©å…ƒ
                if (settings.categoryOrder) {
                    for (var cat in settings.categoryOrder) {
                        if (BUDGET_CATEGORY_MAP[cat]) {
                            BUDGET_CATEGORY_MAP[cat].displayOrder = settings.categoryOrder[cat];
                        }
                    }
                }

                // é …ç›®é †ã‚’å¾©å…ƒ
                if (settings.itemOrder) {
                    for (var category in settings.itemOrder) {
                        for (var code in settings.itemOrder[category]) {
                            if (CUSTOMER_CODE_MAP[code]) {
                                CUSTOMER_CODE_MAP[code].sortOrder = settings.itemOrder[category][code];
                            }
                        }
                    }
                }

                console.log('[loadCategorySettings] è¡¨ç¤ºé †è¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                return true;
            } catch (e) {
                console.error('è¡¨ç¤ºé †è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
                return false;
            }
        }

        // è¡¨ç¤ºé †è¨­å®šã‚’åˆæœŸåŒ–
        function resetCategorySettings() {
            if (!confirm('è¡¨ç¤ºé †è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\\nï¼ˆä¿å­˜ã•ã‚ŒãŸè¨­å®šã¯å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                return;
            }

            localStorage.removeItem(CATEGORY_ORDER_KEY);

            // BUDGET_CATEGORY_MAPã‚’åˆæœŸåŒ–
            var defaultCategoryOrder = {
                'å£²ä¸Šé«˜': 1, 'å£²ä¸ŠåŸä¾¡': 2, 'äººä»¶è²»': 3, 'æ°´é“å…‰ç†±è²»': 4,
                'è²©ä¿ƒè²»': 5, 'åº—èˆ—é‹å–¶è²»': 6, 'ç®¡ç†è²»': 7, 'æ•™è‚²ãƒ»æ¡ç”¨è²»': 8,
                'ITãƒ»å¤–æ³¨è²»': 9, 'å›ºå®šè²»': 10, 'æç›Š': 11, 'ãã®ä»–å¤‰å‹•è²»': 12, 'KPI': 13
            };
            for (var cat in defaultCategoryOrder) {
                if (BUDGET_CATEGORY_MAP[cat]) {
                    BUDGET_CATEGORY_MAP[cat].displayOrder = defaultCategoryOrder[cat];
                }
            }

            // CUSTOMER_CODE_MAPã®sortOrderã‚’å†è¨­å®šï¼ˆv15Noé †ï¼‰
            var itemsByCategory = {};
            for (var code in CUSTOMER_CODE_MAP) {
                var item = CUSTOMER_CODE_MAP[code];
                if (!itemsByCategory[item.budgetCategory]) {
                    itemsByCategory[item.budgetCategory] = [];
                }
                itemsByCategory[item.budgetCategory].push({ code: code, v15No: item.v15No });
            }

            for (var category in itemsByCategory) {
                itemsByCategory[category].sort(function(a, b) { return a.v15No - b.v15No; });
                itemsByCategory[category].forEach(function(item, idx) {
                    CUSTOMER_CODE_MAP[item.code].sortOrder = idx + 1;
                });
            }

            showStatus('success', 'è¡¨ç¤ºé †è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ');
            renderCategorySummary();
            renderMappingCategoryFilter();
        }

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®ã‚«ãƒ†ã‚´ãƒªæ¤œè¨¼ï¼ˆãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ï¼‰
        function validateCategoryMapping(code, name, csvCategory) {
            var result = {
                v17No: null,
                category: null,
                matchType: 'none',
                warning: null
            };

            // 1. ç§‘ç›®ã‚³ãƒ¼ãƒ‰ã§ãƒãƒƒãƒ
            var codeMatch = CUSTOMER_CODE_MAP[code];

            // 2. é …ç›®åã§ãƒãƒƒãƒ
            var nameMatch = NAME_BASED_MAP[name];

            // 3. CSVã‚«ãƒ†ã‚´ãƒªã§ãƒãƒƒãƒ
            var categoryMatch = BUDGET_CATEGORY_MAP[csvCategory];

            // ãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯
            if (codeMatch) {
                result.v17No = codeMatch.v15No;
                result.category = codeMatch.budgetCategory;
                result.matchType = 'code';

                // CSVã‚«ãƒ†ã‚´ãƒªã¨ã®ä¸ä¸€è‡´ãƒã‚§ãƒƒã‚¯
                if (csvCategory && codeMatch.budgetCategory !== csvCategory) {
                    result.warning = 'ã‚«ãƒ†ã‚´ãƒªä¸ä¸€è‡´: ã‚³ãƒ¼ãƒ‰=' + codeMatch.budgetCategory + ', CSV=' + csvCategory;
                    console.warn('[validateCategoryMapping] ' + name + ': ' + result.warning);
                }
            } else if (nameMatch) {
                result.v17No = nameMatch.v17No;
                result.category = nameMatch.category;
                result.matchType = 'name';

                // CSVã‚«ãƒ†ã‚´ãƒªã¨ã®ä¸ä¸€è‡´ãƒã‚§ãƒƒã‚¯
                if (csvCategory && nameMatch.category !== csvCategory) {
                    result.warning = 'ã‚«ãƒ†ã‚´ãƒªä¸ä¸€è‡´: åå‰ãƒãƒƒãƒ=' + nameMatch.category + ', CSV=' + csvCategory;
                    console.warn('[validateCategoryMapping] ' + name + ': ' + result.warning);
                }
            } else if (categoryMatch) {
                result.category = csvCategory;
                result.matchType = 'category';
            }

            return result;
        }

        // ===== ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºé †è¨­å®šæ©Ÿèƒ½ã“ã“ã¾ã§ =====

        // ===== é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†æ©Ÿèƒ½ï¼ˆçµ±åˆç‰ˆï¼‰ =====

        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é¸æŠè‚¢ã‚’æç”»
        function renderMappingCategoryFilter() {
            var select = document.getElementById('mappingCategoryFilter');
            if (!select) return;

            var categories = [];
            for (var cat in BUDGET_CATEGORY_MAP) {
                categories.push({ name: cat, order: BUDGET_CATEGORY_MAP[cat].displayOrder });
            }
            categories.sort(function(a, b) { return a.order - b.order; });

            var html = '<option value="">ã™ã¹ã¦è¡¨ç¤º</option>';
            categories.forEach(function(cat) {
                html += '<option value="' + cat.name + '">' + cat.name + '</option>';
            });
            select.innerHTML = html;
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚µãƒãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleCategorySummary() {
            var container = document.getElementById('categorySummaryList');
            var guide = document.getElementById('categorySummaryGuide');
            var btn = document.getElementById('toggleCategorySummaryBtn');
            if (!container) return;

            if (container.style.display === 'none') {
                // è¡¨ç¤º
                renderCategorySummary();
                container.style.display = 'block';
                if (guide) guide.style.display = 'block';
                if (btn) {
                    btn.innerHTML = 'âœ• ã‚«ãƒ†ã‚´ãƒªç·¨é›†ã‚’é–‰ã˜ã‚‹';
                    btn.style.background = '#757575';
                }
            } else {
                // éè¡¨ç¤º
                container.style.display = 'none';
                if (guide) guide.style.display = 'none';
                if (btn) {
                    btn.innerHTML = 'ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªç·¨é›†';
                    btn.style.background = '#ff9800';
                }
            }
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚µãƒãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ï¼ˆBæ¡ˆï¼‰
        function renderCategorySummary() {
            try {
                var container = document.getElementById('categorySummaryList');
                if (!container) return;

                // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®é …ç›®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                var categoryCounts = {};
                var keys = Object.keys(CUSTOMER_CODE_MAP);
                var totalItems = 0;
                for (var i = 0; i < keys.length; i++) {
                    var code = keys[i];
                    var item = CUSTOMER_CODE_MAP[code];
                    if (!item) continue;
                    var cat = item.budgetCategory || item.category || 'æœªåˆ†é¡';
                    if (!categoryCounts[cat]) categoryCounts[cat] = 0;
                    categoryCounts[cat]++;
                    totalItems++;
                }

                // ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆï¼ˆè¡¨ç¤ºé †ï¼‰
                var categories = Object.keys(BUDGET_CATEGORY_MAP).sort(function(a, b) {
                    return BUDGET_CATEGORY_MAP[a].displayOrder - BUDGET_CATEGORY_MAP[b].displayOrder;
                });

                var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                html += '<thead><tr style="background:#ffe0b2;">';
                html += '<th style="padding:10px;text-align:center;width:60px;">é †åº</th>';
                html += '<th style="padding:10px;text-align:left;">ã‚«ãƒ†ã‚´ãƒªå</th>';
                html += '<th style="padding:10px;text-align:center;width:80px;">é …ç›®æ•°</th>';
                html += '<th style="padding:10px;text-align:center;width:80px;">å‡ºåŠ›å…ˆ</th>';
                html += '<th style="padding:10px;text-align:center;width:100px;">æ“ä½œ</th>';
                html += '</tr></thead><tbody>';

                categories.forEach(function(categoryName, idx) {
                    var catInfo = BUDGET_CATEGORY_MAP[categoryName];
                    var catColor = catInfo ? catInfo.color : '#607d8b';
                    var itemCount = categoryCounts[categoryName] || 0;
                    var isFirst = idx === 0;
                    var isLast = idx === categories.length - 1;
                    var outputLabel = catInfo && catInfo.output === 'mq' ? 'MQè¨ˆç®—' : (catInfo && catInfo.output === 'both' ? 'ä¸¡æ–¹' : 'è²»ç”¨äºˆç®—');

                    html += '<tr style="background:' + catColor + '20;border-bottom:1px solid #e0e0e0;">';

                    // é †åºãƒœã‚¿ãƒ³
                    html += '<td style="padding:10px;text-align:center;">';
                    html += '<button onclick="moveCategoryUp(\'' + categoryName + '\')" style="background:' + (isFirst ? '#ccc' : '#3f51b5') + ';color:#fff;border:none;padding:4px 10px;border-radius:3px;cursor:' + (isFirst ? 'not-allowed' : 'pointer') + ';font-size:11px;margin-right:3px;" ' + (isFirst ? 'disabled' : '') + '>â†‘</button>';
                    html += '<button onclick="moveCategoryDown(\'' + categoryName + '\')" style="background:' + (isLast ? '#ccc' : '#3f51b5') + ';color:#fff;border:none;padding:4px 10px;border-radius:3px;cursor:' + (isLast ? 'not-allowed' : 'pointer') + ';font-size:11px;" ' + (isLast ? 'disabled' : '') + '>â†“</button>';
                    html += '</td>';

                    // ã‚«ãƒ†ã‚´ãƒªå
                    html += '<td style="padding:10px;">';
                    html += '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:' + catColor + ';margin-right:8px;vertical-align:middle;"></span>';
                    html += '<strong style="color:' + catColor + ';">' + categoryName + '</strong>';
                    html += '</td>';

                    // é …ç›®æ•°
                    html += '<td style="padding:10px;text-align:center;">';
                    html += '<span style="background:' + catColor + ';color:#fff;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:bold;">' + itemCount + '</span>';
                    html += '</td>';

                    // å‡ºåŠ›å…ˆ
                    html += '<td style="padding:10px;text-align:center;font-size:10px;color:#666;">' + outputLabel + '</td>';

                    // æ“ä½œãƒœã‚¿ãƒ³
                    html += '<td style="padding:10px;text-align:center;">';
                    html += '<button onclick="showCategoryItemsModal(\'' + categoryName + '\')" style="background:#ff9800;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:bold;">';
                    html += 'ğŸ“‹ é …ç›®ä¸€è¦§';
                    html += '</button>';
                    html += '</td>';

                    html += '</tr>';
                });

                html += '</tbody></table>';
                html += '<div style="padding:10px;text-align:right;color:#666;font-size:11px;">åˆè¨ˆ: ' + categories.length + 'ã‚«ãƒ†ã‚´ãƒª / ' + totalItems + 'é …ç›®</div>';
                container.innerHTML = html;
            } catch (e) {
                console.error('[renderCategorySummary] ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // ã‚«ãƒ†ã‚´ãƒªé …ç›®ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆBæ¡ˆï¼‰
        function showCategoryItemsModal(categoryName) {
            var catInfo = BUDGET_CATEGORY_MAP[categoryName];
            var catColor = catInfo ? catInfo.color : '#ff9800';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®è‰²ã‚’å¤‰æ›´
            var header = document.getElementById('categoryItemsModalHeader');
            if (header) {
                header.style.background = 'linear-gradient(135deg, ' + catColor + ' 0%, ' + adjustColor(catColor, -20) + ' 100%)';
            }

            // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
            document.getElementById('categoryItemsModalTitle').textContent = 'ğŸ“‹ ' + categoryName + ' ã®é …ç›®ä¸€è¦§';
            document.getElementById('categoryItemsModalCategory').value = categoryName;

            // é …ç›®ãƒªã‚¹ãƒˆã‚’æç”»
            renderCategoryItemsList(categoryName);

            document.getElementById('categoryItemsModal').style.display = 'block';
        }

        // ã‚«ãƒ†ã‚´ãƒªé …ç›®ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        function hideCategoryItemsModal() {
            document.getElementById('categoryItemsModal').style.display = 'none';
        }

        // è‰²ã‚’èª¿æ•´ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function adjustColor(hex, amount) {
            var num = parseInt(hex.replace('#', ''), 16);
            var r = Math.min(255, Math.max(0, (num >> 16) + amount));
            var g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            var b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        // ã‚«ãƒ†ã‚´ãƒªå†…ã®é …ç›®ãƒªã‚¹ãƒˆã‚’æç”»ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ï¼‰
        function renderCategoryItemsList(categoryName) {
            var container = document.getElementById('categoryItemsList');
            if (!container) return;

            // æŒ‡å®šã‚«ãƒ†ã‚´ãƒªã®é …ç›®ã‚’å–å¾—
            var items = [];
            var keys = Object.keys(CUSTOMER_CODE_MAP);
            for (var i = 0; i < keys.length; i++) {
                var code = keys[i];
                var item = CUSTOMER_CODE_MAP[code];
                if (!item) continue;
                var itemCat = item.budgetCategory || item.category || 'æœªåˆ†é¡';
                if (itemCat !== categoryName) continue;
                items.push({
                    code: code,
                    name: item.name || '',
                    v15No: item.v15No || 0,
                    sortOrder: item.sortOrder || 0,
                    inputStyle: item.inputStyle || '',
                    screen: item.screen || ''
                });
            }

            // sortOrderé †ã§ã‚½ãƒ¼ãƒˆ
            items.sort(function(a, b) { return a.sortOrder - b.sortOrder; });

            if (items.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            var catInfo = BUDGET_CATEGORY_MAP[categoryName];
            var catColor = catInfo ? catInfo.color : '#ff9800';

            var html = '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
            html += '<thead><tr style="background:' + catColor + '30;">';
            html += '<th style="padding:8px;text-align:center;width:60px;">é †åº</th>';
            html += '<th style="padding:8px;text-align:center;width:80px;">ç§‘ç›®ã‚³ãƒ¼ãƒ‰</th>';
            html += '<th style="padding:8px;text-align:left;">äºˆç®—é …ç›®å</th>';
            html += '<th style="padding:8px;text-align:center;width:60px;">v17No</th>';
            html += '<th style="padding:8px;text-align:center;width:100px;">æ“ä½œ</th>';
            html += '</tr></thead><tbody>';

            items.forEach(function(item, idx) {
                var isFirst = idx === 0;
                var isLast = idx === items.length - 1;

                html += '<tr style="background:' + (idx % 2 === 0 ? '#fff' : '#fafafa') + ';border-bottom:1px solid #eee;">';

                // é †åºãƒœã‚¿ãƒ³
                html += '<td style="padding:8px;text-align:center;">';
                html += '<button onclick="moveItemUp(\'' + item.code + '\')" style="background:' + (isFirst ? '#e0e0e0' : '#ff9800') + ';color:#fff;border:none;padding:3px 8px;border-radius:3px;cursor:' + (isFirst ? 'not-allowed' : 'pointer') + ';font-size:10px;margin-right:2px;" ' + (isFirst ? 'disabled' : '') + '>â†‘</button>';
                html += '<button onclick="moveItemDown(\'' + item.code + '\')" style="background:' + (isLast ? '#e0e0e0' : '#ff9800') + ';color:#fff;border:none;padding:3px 8px;border-radius:3px;cursor:' + (isLast ? 'not-allowed' : 'pointer') + ';font-size:10px;" ' + (isLast ? 'disabled' : '') + '>â†“</button>';
                html += '</td>';

                // ç§‘ç›®ã‚³ãƒ¼ãƒ‰
                html += '<td style="padding:8px;text-align:center;"><code style="background:#e0e0e0;padding:2px 8px;border-radius:3px;">' + item.code + '</code></td>';

                // äºˆç®—é …ç›®å
                html += '<td style="padding:8px;">' + escapeHtml(item.name) + '</td>';

                // v17No
                html += '<td style="padding:8px;text-align:center;">' + (item.v15No || '-') + '</td>';

                // æ“ä½œãƒœã‚¿ãƒ³
                html += '<td style="padding:8px;text-align:center;">';
                html += '<button onclick="showEditItemMappingModal(\'' + item.code + '\')" style="background:#4caf50;color:#fff;border:none;padding:5px 12px;border-radius:3px;cursor:pointer;font-size:10px;">âœï¸ ç·¨é›†</button>';
                html += '</td>';

                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚’ä¸Šã«ç§»å‹•
        function moveCategoryUp(categoryName) {
            var categories = Object.keys(BUDGET_CATEGORY_MAP).sort(function(a, b) {
                return BUDGET_CATEGORY_MAP[a].displayOrder - BUDGET_CATEGORY_MAP[b].displayOrder;
            });
            var idx = categories.indexOf(categoryName);
            if (idx <= 0) return;

            // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã¨ä¸€ã¤ä¸Šã®ã‚«ãƒ†ã‚´ãƒªã®displayOrderã‚’äº¤æ›
            var currentOrder = BUDGET_CATEGORY_MAP[categoryName].displayOrder;
            var prevCategory = categories[idx - 1];
            var prevOrder = BUDGET_CATEGORY_MAP[prevCategory].displayOrder;

            BUDGET_CATEGORY_MAP[categoryName].displayOrder = prevOrder;
            BUDGET_CATEGORY_MAP[prevCategory].displayOrder = currentOrder;

            renderCategorySummary();
            renderMappingCategoryFilter();
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚’ä¸‹ã«ç§»å‹•
        function moveCategoryDown(categoryName) {
            var categories = Object.keys(BUDGET_CATEGORY_MAP).sort(function(a, b) {
                return BUDGET_CATEGORY_MAP[a].displayOrder - BUDGET_CATEGORY_MAP[b].displayOrder;
            });
            var idx = categories.indexOf(categoryName);
            if (idx < 0 || idx >= categories.length - 1) return;

            // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã¨ä¸€ã¤ä¸‹ã®ã‚«ãƒ†ã‚´ãƒªã®displayOrderã‚’äº¤æ›
            var currentOrder = BUDGET_CATEGORY_MAP[categoryName].displayOrder;
            var nextCategory = categories[idx + 1];
            var nextOrder = BUDGET_CATEGORY_MAP[nextCategory].displayOrder;

            BUDGET_CATEGORY_MAP[categoryName].displayOrder = nextOrder;
            BUDGET_CATEGORY_MAP[nextCategory].displayOrder = currentOrder;

            renderCategorySummary();
            renderMappingCategoryFilter();
        }

        // é …ç›®ã‚’ä¸Šã«ç§»å‹•ï¼ˆã‚«ãƒ†ã‚´ãƒªå†…ï¼‰
        function moveItemUp(code) {
            var item = CUSTOMER_CODE_MAP[code];
            if (!item) return;

            var category = item.budgetCategory;

            // åŒã˜ã‚«ãƒ†ã‚´ãƒªã®é …ç›®ã‚’sortOrderé †ã§å–å¾—
            var itemsInCat = [];
            for (var c in CUSTOMER_CODE_MAP) {
                if (CUSTOMER_CODE_MAP[c].budgetCategory === category) {
                    itemsInCat.push({ code: c, sortOrder: CUSTOMER_CODE_MAP[c].sortOrder || 0 });
                }
            }
            itemsInCat.sort(function(a, b) { return a.sortOrder - b.sortOrder; });

            var idx = itemsInCat.findIndex(function(i) { return i.code === code; });
            if (idx <= 0) return;

            // ç¾åœ¨ã®é …ç›®ã¨ä¸€ã¤ä¸Šã®é …ç›®ã®sortOrderã‚’äº¤æ›
            var prevCode = itemsInCat[idx - 1].code;
            var currentOrder = CUSTOMER_CODE_MAP[code].sortOrder || 0;
            var prevOrder = CUSTOMER_CODE_MAP[prevCode].sortOrder || 0;

            CUSTOMER_CODE_MAP[code].sortOrder = prevOrder;
            CUSTOMER_CODE_MAP[prevCode].sortOrder = currentOrder;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒªã‚¹ãƒˆã‚’å†æç”»
            var modalCat = document.getElementById('categoryItemsModalCategory');
            if (modalCat && modalCat.value) {
                renderCategoryItemsList(modalCat.value);
            }
        }

        // é …ç›®ã‚’ä¸‹ã«ç§»å‹•ï¼ˆã‚«ãƒ†ã‚´ãƒªå†…ï¼‰
        function moveItemDown(code) {
            var item = CUSTOMER_CODE_MAP[code];
            if (!item) return;

            var category = item.budgetCategory;

            // åŒã˜ã‚«ãƒ†ã‚´ãƒªã®é …ç›®ã‚’sortOrderé †ã§å–å¾—
            var itemsInCat = [];
            for (var c in CUSTOMER_CODE_MAP) {
                if (CUSTOMER_CODE_MAP[c].budgetCategory === category) {
                    itemsInCat.push({ code: c, sortOrder: CUSTOMER_CODE_MAP[c].sortOrder || 0 });
                }
            }
            itemsInCat.sort(function(a, b) { return a.sortOrder - b.sortOrder; });

            var idx = itemsInCat.findIndex(function(i) { return i.code === code; });
            if (idx < 0 || idx >= itemsInCat.length - 1) return;

            // ç¾åœ¨ã®é …ç›®ã¨ä¸€ã¤ä¸‹ã®é …ç›®ã®sortOrderã‚’äº¤æ›
            var nextCode = itemsInCat[idx + 1].code;
            var currentOrder = CUSTOMER_CODE_MAP[code].sortOrder || 0;
            var nextOrder = CUSTOMER_CODE_MAP[nextCode].sortOrder || 0;

            CUSTOMER_CODE_MAP[code].sortOrder = nextOrder;
            CUSTOMER_CODE_MAP[nextCode].sortOrder = currentOrder;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒªã‚¹ãƒˆã‚’å†æç”»
            var modalCat = document.getElementById('categoryItemsModalCategory');
            if (modalCat && modalCat.value) {
                renderCategoryItemsList(modalCat.value);
            }
        }

        // æ–°è¦é …ç›®è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showAddItemMappingModal() {
            document.getElementById('mappingEditMode').value = 'add';
            document.getElementById('mappingEditOriginalCode').value = '';
            document.getElementById('mappingModalTitle').textContent = 'â• æ–°è¦é …ç›®è¿½åŠ ';
            document.getElementById('mappingDeleteBtn').style.display = 'none';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('mappingEditCode').value = '';
            document.getElementById('mappingEditName').value = '';
            document.getElementById('mappingEditV17No').value = '';
            document.getElementById('mappingEditInputStyle').value = 'A.ãã®ã¾ã¾å…¥åŠ›';
            document.getElementById('mappingEditScreen').value = 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š';

            // ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æç”»
            renderMappingEditCategoryOptions();

            document.getElementById('itemMappingEditModal').style.display = 'block';
        }

        // é …ç›®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showEditItemMappingModal(code) {
            var item = CUSTOMER_CODE_MAP[code];
            if (!item) {
                alert('é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + code);
                return;
            }

            document.getElementById('mappingEditMode').value = 'edit';
            document.getElementById('mappingEditOriginalCode').value = code;
            document.getElementById('mappingModalTitle').textContent = 'âœï¸ é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†';
            document.getElementById('mappingDeleteBtn').style.display = 'inline-block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('mappingEditCode').value = code;
            document.getElementById('mappingEditName').value = item.name || '';
            document.getElementById('mappingEditV17No').value = item.v15No || '';
            document.getElementById('mappingEditInputStyle').value = item.inputStyle || 'A.ãã®ã¾ã¾å…¥åŠ›';
            document.getElementById('mappingEditScreen').value = item.screen || 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š';

            // ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æç”»ã—ã¦é¸æŠ
            renderMappingEditCategoryOptions();
            document.getElementById('mappingEditCategory').value = item.budgetCategory || item.category || '';

            document.getElementById('itemMappingEditModal').style.display = 'block';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function hideItemMappingModal() {
            document.getElementById('itemMappingEditModal').style.display = 'none';
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æç”»
        function renderMappingEditCategoryOptions() {
            var select = document.getElementById('mappingEditCategory');
            if (!select) return;

            var categories = [];
            for (var cat in BUDGET_CATEGORY_MAP) {
                categories.push({ name: cat, order: BUDGET_CATEGORY_MAP[cat].displayOrder });
            }
            categories.sort(function(a, b) { return a.order - b.order; });

            var html = '';
            categories.forEach(function(cat) {
                html += '<option value="' + cat.name + '">' + cat.name + '</option>';
            });
            select.innerHTML = html;
        }

        // é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¿å­˜
        function saveItemMapping() {
            var mode = document.getElementById('mappingEditMode').value;
            var originalCode = document.getElementById('mappingEditOriginalCode').value;

            var code = document.getElementById('mappingEditCode').value.trim();
            var name = document.getElementById('mappingEditName').value.trim();
            var category = document.getElementById('mappingEditCategory').value;
            var v17No = parseInt(document.getElementById('mappingEditV17No').value) || 0;
            var inputStyle = document.getElementById('mappingEditInputStyle').value;
            var screen = document.getElementById('mappingEditScreen').value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!code) {
                alert('ç§‘ç›®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!name) {
                alert('äºˆç®—é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!category) {
                alert('äºˆç®—ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // æ–°è¦è¿½åŠ æ™‚ã®ã‚³ãƒ¼ãƒ‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (mode === 'add' && CUSTOMER_CODE_MAP[code]) {
                alert('ç§‘ç›®ã‚³ãƒ¼ãƒ‰ã€Œ' + code + 'ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }

            // ç·¨é›†æ™‚ã«ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸå ´åˆã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (mode === 'edit' && code !== originalCode && CUSTOMER_CODE_MAP[code]) {
                alert('ç§‘ç›®ã‚³ãƒ¼ãƒ‰ã€Œ' + code + 'ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }

            // sortOrderã‚’æ±ºå®šï¼ˆåŒã˜ã‚«ãƒ†ã‚´ãƒªã®æœ€å¤§å€¤+1ï¼‰
            var maxSortOrder = 0;
            for (var c in CUSTOMER_CODE_MAP) {
                if (CUSTOMER_CODE_MAP[c].budgetCategory === category) {
                    maxSortOrder = Math.max(maxSortOrder, CUSTOMER_CODE_MAP[c].sortOrder || 0);
                }
            }

            // ç·¨é›†æ™‚ã«å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            if (mode === 'edit' && originalCode && originalCode !== code) {
                delete CUSTOMER_CODE_MAP[originalCode];
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            CUSTOMER_CODE_MAP[code] = {
                v15No: v17No,
                name: name,
                category: category,
                budgetCategory: category,
                sortOrder: mode === 'add' ? (maxSortOrder + 1) : (CUSTOMER_CODE_MAP[originalCode] ? CUSTOMER_CODE_MAP[originalCode].sortOrder : maxSortOrder + 1),
                inputStyle: inputStyle,
                screen: screen
            };

            // NAME_BASED_MAPã«ã‚‚è¿½åŠ ï¼ˆé …ç›®åã§ã®ãƒãƒƒãƒãƒ³ã‚°ç”¨ï¼‰
            NAME_BASED_MAP[name] = {
                v17No: v17No,
                category: category
            };

            hideItemMappingModal();
            renderCategorySummary();
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯å†æç”»
            var modalCat = document.getElementById('categoryItemsModalCategory');
            if (modalCat && modalCat.value) {
                renderCategoryItemsList(modalCat.value);
            }
            showStatus('success', mode === 'add' ? 'é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ' + name : 'é …ç›®ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ' + name);
        }

        // é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‰Šé™¤
        function deleteItemMapping() {
            var originalCode = document.getElementById('mappingEditOriginalCode').value;
            if (!originalCode) return;

            var item = CUSTOMER_CODE_MAP[originalCode];
            if (!item) return;

            if (!confirm('ã€Œ' + item.name + 'ã€ï¼ˆã‚³ãƒ¼ãƒ‰: ' + originalCode + 'ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»å‰Šé™¤ã™ã‚‹ã¨äºˆç®—CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ã“ã®é …ç›®ãŒãƒãƒƒãƒã—ãªããªã‚Šã¾ã™ã€‚')) {
                return;
            }

            // NAME_BASED_MAPã‹ã‚‰ã‚‚å‰Šé™¤
            if (NAME_BASED_MAP[item.name]) {
                delete NAME_BASED_MAP[item.name];
            }

            // CUSTOMER_CODE_MAPã‹ã‚‰å‰Šé™¤
            delete CUSTOMER_CODE_MAP[originalCode];

            hideItemMappingModal();
            renderCategorySummary();
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯å†æç”»
            var modalCat = document.getElementById('categoryItemsModalCategory');
            if (modalCat && modalCat.value) {
                renderCategoryItemsList(modalCat.value);
            }
            showStatus('success', 'é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ' + item.name);
        }

        // ===== é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†æ©Ÿèƒ½ã“ã“ã¾ã§ =====

        var selectedHistoryId = null;  // é¸æŠä¸­ã®å±¥æ­´ID
        var selectedHistoryCategory = 'all';  // å±¥æ­´ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: 'all', 'stores', 'items', 'prices'

        function switchHistoryCategory(category) {
            selectedHistoryCategory = category;
            selectedHistoryId = null;  // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ã¯é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            renderMasterHistoryList();
        }

        function renderMasterHistoryList() {
            var container = document.getElementById('masterHistoryList');
            if (!container) return;

            var history = getMasterHistory();

            // ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
            var html = '<h4 style="color:#7b1fa2;margin:0 0 10px 0;">ğŸ“‚ ä¿å­˜æ¸ˆã¿ãƒã‚¹ã‚¿å±¥æ­´ï¼ˆæœ€å¤§' + MAX_MASTER_HISTORY + 'ä»¶ï¼‰</h4>';

            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
            html += '<div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;">';
            html += '<button onclick="switchHistoryCategory(\'all\')" style="background:' + (selectedHistoryCategory === 'all' ? '#7b1fa2' : '#e0e0e0') + ';color:' + (selectedHistoryCategory === 'all' ? '#fff' : '#333') + ';border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">ğŸ“‹ ã™ã¹ã¦</button>';
            html += '<button onclick="switchHistoryCategory(\'stores\')" style="background:' + (selectedHistoryCategory === 'stores' ? '#4caf50' : '#e0e0e0') + ';color:' + (selectedHistoryCategory === 'stores' ? '#fff' : '#333') + ';border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">ğŸª åº—ç•ªãƒã‚¹ã‚¿</button>';
            html += '<button onclick="switchHistoryCategory(\'items\')" style="background:' + (selectedHistoryCategory === 'items' ? '#ff9800' : '#e0e0e0') + ';color:' + (selectedHistoryCategory === 'items' ? '#fff' : '#333') + ';border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">ğŸ“‹ äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰</button>';
            html += '<button onclick="switchHistoryCategory(\'prices\')" style="background:' + (selectedHistoryCategory === 'prices' ? '#2196f3' : '#e0e0e0') + ';color:' + (selectedHistoryCategory === 'prices' ? '#fff' : '#333') + ';border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">ğŸ’° å®¢å˜ä¾¡</button>';
            html += '</div>';

            if (history.length === 0) {
                html += '<div style="padding:20px;text-align:center;background:#f5f5f5;border-radius:8px;">' +
                    '<div style="color:#666;margin-bottom:10px;">ä¿å­˜ã•ã‚ŒãŸãƒã‚¹ã‚¿å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>' +
                    '<div style="font-size:12px;color:#999;">ä¸Šéƒ¨ã®ã€ŒğŸ’¾ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã§ãã¾ã™</div>' +
                    '</div>';
                container.innerHTML = html;
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸãƒ©ãƒ™ãƒ«ç”Ÿæˆé–¢æ•°
            function getItemLabel(item) {
                if (selectedHistoryCategory === 'all') {
                    return escapeHtml(item.name) + ' (åº—èˆ—:' + item.storeCount + ', ã‚³ãƒ¼ãƒ‰:' + (item.codeMapCount + item.nameMapCount) + ')';
                } else if (selectedHistoryCategory === 'stores') {
                    return escapeHtml(item.name) + ' (ğŸª ' + item.storeCount + 'ä»¶)';
                } else if (selectedHistoryCategory === 'items') {
                    return escapeHtml(item.name) + ' (ğŸ“‹ ' + (item.codeMapCount + item.nameMapCount) + 'é …ç›®)';
                } else if (selectedHistoryCategory === 'prices') {
                    return escapeHtml(item.name) + ' (ğŸ’° ' + item.storeCount + 'åº—èˆ—)';
                }
                return escapeHtml(item.name);
            }

            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠ
            html += '<div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;flex-wrap:wrap;">';
            html += '<select id="historySelect" onchange="previewHistoryData(this.value)" style="padding:8px 12px;border:2px solid #7b1fa2;border-radius:6px;font-size:13px;min-width:300px;background:#fff;">';
            html += '<option value="">-- å±¥æ­´ã‚’é¸æŠ --</option>';
            history.forEach(function(item) {
                var selected = selectedHistoryId === item.id ? ' selected' : '';
                html += '<option value="' + item.id + '"' + selected + '>' + getItemLabel(item) + '</option>';
            });
            html += '</select>';
            html += '<button onclick="loadSelectedHistory()" style="background:#4caf50;color:#fff;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ“¥ èª­è¾¼</button>';
            html += '<button onclick="deleteSelectedHistory()" style="background:#f44336;color:#fff;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ—‘ å‰Šé™¤</button>';
            html += '</div>';

            // é¸æŠä¸­ã®å±¥æ­´æƒ…å ±ã‚’è¡¨ç¤º
            html += '<div id="historyPreview"></div>';

            container.innerHTML = html;

            // é¸æŠä¸­ã®å±¥æ­´ãŒã‚ã‚Œã°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            if (selectedHistoryId) {
                previewHistoryData(selectedHistoryId);
            }
        }

        function previewHistoryData(idStr) {
            var id = parseInt(idStr);
            selectedHistoryId = id || null;

            var previewDiv = document.getElementById('historyPreview');
            if (!previewDiv) return;

            if (!id) {
                previewDiv.innerHTML = '';
                return;
            }

            var history = getMasterHistory();
            var item = history.find(function(h) { return h.id === id; });
            if (!item) {
                previewDiv.innerHTML = '<div style="color:#f44336;">å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸèƒŒæ™¯è‰²
            var borderColor = '#9c27b0';
            var bgColor = '#f3e5f5';
            if (selectedHistoryCategory === 'stores') { borderColor = '#4caf50'; bgColor = '#e8f5e9'; }
            else if (selectedHistoryCategory === 'items') { borderColor = '#ff9800'; bgColor = '#fff3e0'; }
            else if (selectedHistoryCategory === 'prices') { borderColor = '#2196f3'; bgColor = '#e3f2fd'; }

            var html = '<div style="background:' + bgColor + ';border:2px solid ' + borderColor + ';border-radius:8px;padding:15px;margin-top:10px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:start;">';
            html += '<div>';
            html += '<h5 style="color:' + borderColor + ';margin:0 0 8px 0;">ğŸ“‹ ' + escapeHtml(item.name) + '</h5>';
            html += '<div style="font-size:11px;color:#666;margin-bottom:8px;">ä¿å­˜æ—¥æ™‚: ' + new Date(item.savedAt).toLocaleString('ja-JP') + '</div>';

            // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸãƒãƒƒã‚¸è¡¨ç¤º
            html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
            if (selectedHistoryCategory === 'all' || selectedHistoryCategory === 'stores') {
                html += '<span style="background:#4caf50;color:#fff;padding:3px 8px;border-radius:4px;font-size:11px;">ğŸª åº—ç•ª: ' + item.storeCount + 'ä»¶</span>';
            }
            if (selectedHistoryCategory === 'all' || selectedHistoryCategory === 'items') {
                html += '<span style="background:#ff9800;color:#fff;padding:3px 8px;border-radius:4px;font-size:11px;">ğŸ“‹ é …ç›®ã‚³ãƒ¼ãƒ‰: ' + (item.codeMapCount + item.nameMapCount) + 'ä»¶</span>';
            }
            if (selectedHistoryCategory === 'all' || selectedHistoryCategory === 'prices') {
                html += '<span style="background:#2196f3;color:#fff;padding:3px 8px;border-radius:4px;font-size:11px;">ğŸ’° å®¢å˜ä¾¡: ' + item.storeCount + 'ä»¶</span>';
            }
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            var stores = item.unitPrices || item.stores;
            var storeNames = Object.keys(stores).filter(function(n) { return n !== '_default'; });

            if (selectedHistoryCategory === 'all' || selectedHistoryCategory === 'stores') {
                // åº—èˆ—ãƒªã‚¹ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã™ã¹ã¦ãƒ»åº—ç•ªãƒã‚¹ã‚¿ã‚«ãƒ†ã‚´ãƒªï¼‰
                if (storeNames.length > 0) {
                    html += '<div style="margin-top:12px;max-height:150px;overflow-y:auto;background:#fff;border-radius:4px;padding:8px;">';
                    if (selectedHistoryCategory === 'stores') {
                        html += '<div style="font-size:10px;color:#666;margin-bottom:5px;">ğŸª åº—ç•ªä¸€è¦§ï¼ˆå…ˆé ­5ä»¶ï¼‰:</div>';
                    } else {
                        html += '<div style="font-size:10px;color:#666;margin-bottom:5px;">åº—èˆ—ä¸€è¦§ï¼ˆå…ˆé ­5ä»¶ï¼‰:</div>';
                    }
                    storeNames.slice(0, 5).forEach(function(name, i) {
                        var prices = stores[name];
                        var storeCode = prices.storeCode || '';
                        html += '<div style="font-size:11px;padding:2px 0;border-bottom:1px solid #eee;">';
                        html += '<span style="color:#4caf50;font-weight:bold;">' + (storeCode || String(i+1).padStart(3,'0')) + '</span> ';
                        html += escapeHtml(name);
                        if (selectedHistoryCategory === 'all') {
                            html += ' <span style="color:#1565c0;">' + (prices.total || 0).toLocaleString() + 'å††</span>';
                        }
                        html += '</div>';
                    });
                    if (storeNames.length > 5) {
                        html += '<div style="font-size:10px;color:#999;padding-top:5px;">...ä»– ' + (storeNames.length - 5) + 'ä»¶</div>';
                    }
                    html += '</div>';
                }
            }

            if (selectedHistoryCategory === 'prices') {
                // å®¢å˜ä¾¡ã‚«ãƒ†ã‚´ãƒª: æœˆåˆ¥è¡¨ç¤º
                var MONTH_NAMES = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];
                if (storeNames.length > 0) {
                    html += '<div style="margin-top:12px;max-height:300px;overflow-y:auto;background:#fff;border-radius:4px;padding:8px;">';
                    html += '<div style="font-size:10px;color:#666;margin-bottom:8px;">ğŸ’° å®¢å˜ä¾¡ä¸€è¦§ï¼ˆå…ˆé ­3åº—èˆ—ãƒ»æœˆåˆ¥ï¼‰:</div>';
                    storeNames.slice(0, 3).forEach(function(name, i) {
                        var prices = stores[name];
                        var storeCode = prices.storeCode || '';
                        html += '<div style="margin-bottom:10px;padding:8px;background:#e3f2fd;border-radius:4px;">';
                        html += '<div style="font-weight:bold;color:#1565c0;margin-bottom:5px;">';
                        html += '<span style="color:#4caf50;">' + (storeCode || String(i+1).padStart(3,'0')) + '</span> ';
                        html += escapeHtml(name);
                        html += ' <span style="font-weight:normal;color:#666;">ï¼ˆå¹³å‡: ' + (prices.total || 0).toLocaleString() + 'å††ï¼‰</span>';
                        html += '</div>';
                        // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                        if (prices.monthly && Object.keys(prices.monthly).length > 0) {
                            html += '<div style="display:flex;flex-wrap:wrap;gap:4px;font-size:10px;">';
                            for (var mi = 0; mi < 12; mi++) {
                                var monthData = prices.monthly[mi];
                                if (monthData) {
                                    var val = monthData.total || 0;
                                    html += '<span style="background:#fff;padding:2px 6px;border-radius:3px;border:1px solid #90caf9;">';
                                    html += MONTH_NAMES[mi] + ':' + val.toLocaleString() + 'å††';
                                    html += '</span>';
                                }
                            }
                            html += '</div>';
                        } else {
                            html += '<div style="font-size:10px;color:#999;">ï¼ˆæœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ãªã—ãƒ»å…¨æœˆå…±é€šå€¤ï¼‰</div>';
                        }
                        html += '</div>';
                    });
                    if (storeNames.length > 3) {
                        html += '<div style="font-size:10px;color:#999;padding-top:5px;">...ä»– ' + (storeNames.length - 3) + 'åº—èˆ—</div>';
                    }
                    html += '</div>';
                }
            }

            if (selectedHistoryCategory === 'items') {
                // äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                var codeKeys = Object.keys(item.codeMap || {});
                var nameKeys = Object.keys(item.nameMap || {});
                html += '<div style="margin-top:12px;max-height:150px;overflow-y:auto;background:#fff;border-radius:4px;padding:8px;">';
                html += '<div style="font-size:10px;color:#666;margin-bottom:5px;">ğŸ“‹ äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ï¼ˆå…ˆé ­5ä»¶ï¼‰:</div>';
                codeKeys.slice(0, 5).forEach(function(code, i) {
                    var mapItem = item.codeMap[code];
                    html += '<div style="font-size:11px;padding:2px 0;border-bottom:1px solid #eee;">';
                    html += '<span style="color:#ff9800;font-weight:bold;">' + code + '</span> ';
                    html += escapeHtml(mapItem.name) + ' â†’ v17No:' + mapItem.v17No;
                    html += '</div>';
                });
                if (codeKeys.length > 5) {
                    html += '<div style="font-size:10px;color:#999;padding-top:5px;">...ä»– ' + (codeKeys.length - 5) + 'ä»¶</div>';
                }
                html += '<div style="font-size:10px;color:#1565c0;margin-top:8px;">ï¼‹åå‰ãƒ™ãƒ¼ã‚¹: ' + nameKeys.length + 'é …ç›®</div>';
                html += '</div>';
            }

            html += '</div>';
            previewDiv.innerHTML = html;
        }

        function loadSelectedHistory() {
            var select = document.getElementById('historySelect');
            if (!select || !select.value) {
                showStatus('warn', 'å±¥æ­´ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            loadMasterFromHistory(parseInt(select.value));
        }

        function deleteSelectedHistory() {
            var select = document.getElementById('historySelect');
            if (!select || !select.value) {
                showStatus('warn', 'å±¥æ­´ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            deleteMasterHistory(parseInt(select.value));
        }

        function loadMasterFromHistory(id) {
            var history = getMasterHistory();
            var item = history.find(function(h) { return h.id === id; });
            if (!item) {
                showStatus('error', 'ãƒã‚¹ã‚¿å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            var categoryLabel = 'ã™ã¹ã¦ã®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿';
            if (selectedHistoryCategory === 'stores') categoryLabel = 'åº—ç•ªãƒã‚¹ã‚¿';
            else if (selectedHistoryCategory === 'items') categoryLabel = 'äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿';
            else if (selectedHistoryCategory === 'prices') categoryLabel = 'å®¢å˜ä¾¡ãƒã‚¹ã‚¿';

            if (!confirm('ã€Œ' + item.name + 'ã€ã®' + categoryLabel + 'ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®' + categoryLabel + 'ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) return;

            // é¸æŠã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
            if (selectedHistoryCategory === 'all') {
                // ã™ã¹ã¦èª­ã¿è¾¼ã¿
                DEFAULT_UNIT_PRICES = JSON.parse(JSON.stringify(item.unitPrices || item.stores));
                CUSTOMER_CODE_MAP = JSON.parse(JSON.stringify(item.codeMap));
                NAME_BASED_MAP = JSON.parse(JSON.stringify(item.nameMap));
                renderMasterStoresContent();
                renderMasterItemsContent();
                renderMasterPricesContent();
                updateCurrentStoreList();
                updateCurrentMappingList();
            } else if (selectedHistoryCategory === 'stores') {
                // åº—ç•ªãƒã‚¹ã‚¿ã®ã¿ï¼ˆåº—èˆ—åãƒªã‚¹ãƒˆã®ã¿å¾©å…ƒã€å®¢å˜ä¾¡ã¯ç¶­æŒï¼‰
                var newPrices = JSON.parse(JSON.stringify(item.unitPrices || item.stores));
                Object.keys(newPrices).forEach(function(name) {
                    if (!DEFAULT_UNIT_PRICES[name]) {
                        DEFAULT_UNIT_PRICES[name] = newPrices[name];
                    }
                });
                renderMasterStoresContent();
                updateCurrentStoreList();
            } else if (selectedHistoryCategory === 'items') {
                // äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ã®ã¿
                CUSTOMER_CODE_MAP = JSON.parse(JSON.stringify(item.codeMap));
                NAME_BASED_MAP = JSON.parse(JSON.stringify(item.nameMap));
                renderMasterItemsContent();
                updateCurrentMappingList();
            } else if (selectedHistoryCategory === 'prices') {
                // å®¢å˜ä¾¡ãƒã‚¹ã‚¿ã®ã¿
                DEFAULT_UNIT_PRICES = JSON.parse(JSON.stringify(item.unitPrices || item.stores));
                renderMasterPricesContent();
            }

            showStatus('success', categoryLabel + 'ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ' + item.name);
        }

        function deleteMasterHistory(id) {
            if (!confirm('ã“ã®ãƒã‚¹ã‚¿å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            var history = getMasterHistory();
            history = history.filter(function(h) { return h.id !== id; });
            localStorage.setItem(MASTER_HISTORY_KEY, JSON.stringify(history));

            renderMasterHistoryList();
            showStatus('success', 'ãƒã‚¹ã‚¿å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        function renderMasterStoresContent() {
            var container = document.getElementById('masterStoresContent');
            if (!container) return;

            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) { return name !== '_default'; });
            var html = '<h5 style="color:#4caf50;margin:0 0 10px 0;">ğŸª åº—ç•ªãƒã‚¹ã‚¿ï¼ˆåº—èˆ—ä¸€è¦§ï¼‰</h5>';
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#4caf50;color:#fff;"><th style="padding:8px;text-align:center;width:80px;">åº—ç•ª</th><th style="padding:8px;text-align:left;">åº—å</th></tr>';

            storeNames.forEach(function(storeName, index) {
                var prices = DEFAULT_UNIT_PRICES[storeName];
                var bgColor = index % 2 === 0 ? '#fff' : '#e8f5e9';
                var storeCode = prices.storeCode || '';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:6px 8px;text-align:center;font-family:monospace;' + (storeCode ? 'font-weight:bold;' : 'color:#999;') + '">' + (storeCode || 'æœªè¨­å®š') + '</td>';
                html += '<td style="padding:6px 8px;">' + escapeHtml(storeName) + '</td>';
                html += '</tr>';
            });

            html += '</table>';
            html += '<div style="margin-top:10px;font-size:11px;color:#666;">åˆè¨ˆ: ' + storeNames.length + 'åº—èˆ—</div>';
            container.innerHTML = html;
        }

        var masterPriceType = 'total';  // 'total', 'lunch', 'dinner'

        function switchMasterPriceType(type) {
            masterPriceType = type;
            renderMasterPricesContent();
        }

        function renderMasterPricesContent() {
            var container = document.getElementById('masterPricesContent');
            if (!container) return;

            var storeNames = Object.keys(DEFAULT_UNIT_PRICES).filter(function(name) { return name !== '_default'; });
            var months = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];
            var typeLabels = { total: 'ç·åˆ', lunch: 'ãƒ©ãƒ³ãƒ', dinner: 'ãƒ‡ã‚£ãƒŠãƒ¼' };
            var typeColors = { total: '#1565c0', lunch: '#ff9800', dinner: '#9c27b0' };

            var html = '<h5 style="color:#2196f3;margin:0 0 10px 0;">ğŸ’° åº—åˆ¥æœˆåˆ¥ç›®æ¨™å®¢å˜ä¾¡ãƒã‚¹ã‚¿</h5>';

            // ã‚¿ã‚¤ãƒ—åˆ‡æ›¿ãƒœã‚¿ãƒ³
            html += '<div style="margin-bottom:10px;display:flex;gap:8px;">';
            html += '<button onclick="switchMasterPriceType(\'total\')" style="padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:11px;' +
                    (masterPriceType === 'total' ? 'background:#1565c0;color:#fff;' : 'background:#e0e0e0;color:#333;') + '">ç·åˆ</button>';
            html += '<button onclick="switchMasterPriceType(\'lunch\')" style="padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:11px;' +
                    (masterPriceType === 'lunch' ? 'background:#ff9800;color:#fff;' : 'background:#e0e0e0;color:#333;') + '">ãƒ©ãƒ³ãƒ</button>';
            html += '<button onclick="switchMasterPriceType(\'dinner\')" style="padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:11px;' +
                    (masterPriceType === 'dinner' ? 'background:#9c27b0;color:#fff;' : 'background:#e0e0e0;color:#333;') + '">ãƒ‡ã‚£ãƒŠãƒ¼</button>';
            html += '</div>';

            // æœˆåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«
            html += '<div style="overflow-x:auto;">';
            html += '<table style="width:100%;border-collapse:collapse;font-size:11px;min-width:900px;">';
            html += '<tr style="background:' + typeColors[masterPriceType] + ';color:#fff;">';
            html += '<th style="padding:6px;text-align:center;width:70px;position:sticky;left:0;background:' + typeColors[masterPriceType] + ';">åº—ç•ª</th>';
            html += '<th style="padding:6px;text-align:left;min-width:150px;position:sticky;left:70px;background:' + typeColors[masterPriceType] + ';">åº—å</th>';
            months.forEach(function(m) {
                html += '<th style="padding:6px;text-align:right;min-width:65px;">' + m + '</th>';
            });
            html += '</tr>';

            storeNames.forEach(function(storeName, index) {
                var prices = DEFAULT_UNIT_PRICES[storeName];
                var bgColor = index % 2 === 0 ? '#fff' : '#f5f5f5';
                var storeCode = prices.storeCode || '';
                var value = prices[masterPriceType] || 0;
                // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å…¨æœˆã«é©ç”¨
                var monthlyData = prices.monthly || {};

                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:4px 6px;text-align:center;font-family:monospace;font-size:10px;position:sticky;left:0;background:' + bgColor + ';' + (storeCode ? '' : 'color:#999;') + '">' + (storeCode || 'æœªè¨­å®š') + '</td>';
                html += '<td style="padding:4px 6px;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px;position:sticky;left:70px;background:' + bgColor + ';" title="' + escapeHtml(storeName) + '">' + escapeHtml(storeName) + '</td>';

                for (var m = 0; m < 12; m++) {
                    var monthValue = monthlyData[m] ? (monthlyData[m][masterPriceType] || value) : value;
                    var displayValue = monthValue > 0 ? monthValue.toLocaleString() : '-';
                    var cellColor = monthValue > 0 ? typeColors[masterPriceType] : '#999';
                    html += '<td style="padding:4px 6px;text-align:right;font-size:10px;color:' + cellColor + ';">' + displayValue + '</td>';
                }
                html += '</tr>';
            });

            html += '</table>';
            html += '</div>';
            html += '<div style="margin-top:10px;font-size:11px;color:#666;">åˆè¨ˆ: ' + storeNames.length + 'åº—èˆ— Ã— 12ãƒ¶æœˆ | è¡¨ç¤º: ç›®æ¨™å®¢å˜ä¾¡ï¼ˆ' + typeLabels[masterPriceType] + 'ï¼‰</div>';
            container.innerHTML = html;
        }

        function renderMasterItemsContent() {
            var container = document.getElementById('masterItemsContent');
            if (!container) return;

            var html = '<h5 style="color:#ff9800;margin:0 0 10px 0;">ğŸ“‹ äºˆç®—é …ç›®ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿</h5>';

            // ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹
            var sortedCodes = Object.keys(CUSTOMER_CODE_MAP).sort(function(a, b) {
                return CUSTOMER_CODE_MAP[a].v15No - CUSTOMER_CODE_MAP[b].v15No;
            });

            html += '<h6 style="color:#e65100;margin:10px 0 8px 0;">ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ï¼ˆCUSTOMER_CODE_MAPï¼‰: ' + sortedCodes.length + 'ä»¶</h6>';
            html += '<table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:15px;">';
            html += '<tr style="background:#e65100;color:#fff;"><th style="padding:6px;">ã‚³ãƒ¼ãƒ‰</th><th style="padding:6px;">é …ç›®å</th><th style="padding:6px;">v17No</th><th style="padding:6px;">ã‚«ãƒ†ã‚´ãƒª</th></tr>';

            sortedCodes.forEach(function(code, index) {
                var item = CUSTOMER_CODE_MAP[code];
                var bgColor = index % 2 === 0 ? '#fff' : '#fff8e1';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:4px 6px;font-family:monospace;">' + escapeHtml(code) + '</td>';
                html += '<td style="padding:4px 6px;">' + escapeHtml(item.name) + '</td>';
                html += '<td style="padding:4px 6px;text-align:center;">' + item.v15No + '</td>';
                html += '<td style="padding:4px 6px;">' + escapeHtml(item.category) + '</td>';
                html += '</tr>';
            });
            html += '</table>';

            // åå‰ãƒ™ãƒ¼ã‚¹
            var sortedNames = Object.keys(NAME_BASED_MAP).sort(function(a, b) {
                return NAME_BASED_MAP[a].v17No - NAME_BASED_MAP[b].v17No;
            });

            html += '<h6 style="color:#1565c0;margin:15px 0 8px 0;">åå‰ãƒ™ãƒ¼ã‚¹ï¼ˆNAME_BASED_MAPï¼‰: ' + sortedNames.length + 'ä»¶</h6>';
            html += '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
            html += '<tr style="background:#1565c0;color:#fff;"><th style="padding:6px;">é …ç›®åï¼ˆã‚­ãƒ¼ï¼‰</th><th style="padding:6px;">v17No</th><th style="padding:6px;">ã‚«ãƒ†ã‚´ãƒª</th></tr>';

            sortedNames.forEach(function(name, index) {
                var item = NAME_BASED_MAP[name];
                var bgColor = index % 2 === 0 ? '#fff' : '#e3f2fd';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:4px 6px;">' + escapeHtml(name) + '</td>';
                html += '<td style="padding:4px 6px;text-align:center;">' + item.v17No + '</td>';
                html += '<td style="padding:4px 6px;">' + escapeHtml(item.category || '-') + '</td>';
                html += '</tr>';
            });
            html += '</table>';

            container.innerHTML = html;
        }

        // â˜… æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œå‡º
        var unusedMappings = [];

        function detectUnusedMappings() {
            unusedMappings = [];

            // CSVã«å­˜åœ¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’åé›†
            var usedCodes = {};
            if (matchedItems) {
                matchedItems.forEach(function(item) {
                    usedCodes[item.code] = true;
                });
            }

            // å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒCSVã«å­˜åœ¨ã—ãªã„ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º
            for (var code in CUSTOMER_CODE_MAP) {
                if (!usedCodes[code]) {
                    unusedMappings.push({
                        code: code,
                        name: CUSTOMER_CODE_MAP[code].name,
                        v15No: CUSTOMER_CODE_MAP[code].v15No,
                        category: CUSTOMER_CODE_MAP[code].category
                    });
                }
            }

            // è¡¨ç¤ºæ›´æ–°
            var unusedBadge = document.getElementById('unusedBadge');
            var unusedDisplay = document.getElementById('unusedCountDisplay');
            var unusedSection = document.getElementById('unusedSection');

            if (unusedBadge) {
                unusedBadge.style.display = unusedMappings.length > 0 ? 'inline-block' : 'none';
            }
            if (unusedDisplay) {
                unusedDisplay.textContent = unusedMappings.length;
            }

            if (unusedMappings.length === 0) {
                if (unusedSection) unusedSection.style.display = 'none';
                showStatus('success', 'æœªä½¿ç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (unusedSection) unusedSection.style.display = 'block';

            // æœªä½¿ç”¨é …ç›®ã‚’ãƒãƒƒãƒ—å½¢å¼ã§è¡¨ç¤º
            var html = '';
            unusedMappings.forEach(function(item) {
                html += '<div style="display:inline-flex;align-items:center;gap:5px;background:#fff;border:1px solid #ff9800;border-radius:20px;padding:5px 12px;font-size:11px;">';
                html += '<span style="font-weight:bold;color:#e65100;">' + item.code + '</span>';
                html += '<span style="color:#666;">' + item.name + '</span>';
                html += '<button style="background:#dc3545;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer;" onclick="deleteSingleUnused(\'' + item.code + '\')">å‰Šé™¤</button>';
                html += '</div>';
            });

            var listEl = document.getElementById('unusedList');
            if (listEl) listEl.innerHTML = html;

            showStatus('warning', 'æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ¤œå‡ºã—ã¾ã—ãŸ: ' + unusedMappings.length + 'ä»¶');
        }

        function deleteSingleUnused(code) {
            if (confirm('ãƒãƒƒãƒ”ãƒ³ã‚°ã€Œ' + code + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                delete CUSTOMER_CODE_MAP[code];
                detectUnusedMappings();
                renderMappingTable();
            }
        }

        function removeUnusedMappings() {
            if (unusedMappings.length === 0) {
                alert('æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!confirm(unusedMappings.length + 'ä»¶ã®æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            unusedMappings.forEach(function(item) {
                delete CUSTOMER_CODE_MAP[item.code];
            });

            unusedMappings = [];
            detectUnusedMappings();
            renderMappingTable();
            showStatus('success', 'æœªä½¿ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // â˜…â˜…â˜… é«˜åº¦ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½ â˜…â˜…â˜…

        // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã«ã‚ˆã‚‹é¡ä¼¼åº¦è¨ˆç®—
        function levenshteinSimilarity(str1, str2) {
            var s1 = str1.toLowerCase();
            var s2 = str2.toLowerCase();

            if (s1 === s2) return 1.0;
            if (s1.length === 0 || s2.length === 0) return 0;

            var matrix = [];
            for (var i = 0; i <= s1.length; i++) {
                matrix[i] = [i];
                for (var j = 1; j <= s2.length; j++) {
                    if (i === 0) {
                        matrix[i][j] = j;
                    } else {
                        var cost = s1[i-1] === s2[j-1] ? 0 : 1;
                        matrix[i][j] = Math.min(
                            matrix[i-1][j] + 1,
                            matrix[i][j-1] + 1,
                            matrix[i-1][j-1] + cost
                        );
                    }
                }
            }

            var distance = matrix[s1.length][s2.length];
            var maxLen = Math.max(s1.length, s2.length);
            return 1 - (distance / maxLen);
        }

        // è¤‡åˆé¡ä¼¼åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—
        function calculateMatchScore(target, candidate) {
            if (!target || !candidate) return 0;

            var t = target.toLowerCase();
            var c = candidate.toLowerCase();

            // 1. å®Œå…¨ä¸€è‡´: 100%
            if (t === c) return 1.0;

            var score = 0;

            // 2. éƒ¨åˆ†ä¸€è‡´: 85%
            if (t.includes(c) || c.includes(t)) {
                var overlapRatio = Math.min(t.length, c.length) / Math.max(t.length, c.length);
                score = Math.max(score, 0.85 * overlapRatio + 0.15);
            }

            // 3. ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³é¡ä¼¼åº¦
            var levScore = levenshteinSimilarity(t, c);
            score = Math.max(score, levScore);

            // 4. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒœãƒ¼ãƒŠã‚¹
            var keywords = ['å£²ä¸Š', 'ä»•å…¥', 'äººä»¶è²»', 'å®¶è³ƒ', 'é›»æ°—', 'ã‚¬ã‚¹', 'æ°´é“', 'è²»', 'æ–™'];
            keywords.forEach(function(kw) {
                if (t.includes(kw) && c.includes(kw)) {
                    score = Math.min(score + 0.1, 1.0);
                }
            });

            return score;
        }

        // ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•æ¨å®šãƒ«ãƒ¼ãƒ«
        var CATEGORY_RULES = {
            'å£²ä¸Š': ['å£²ä¸Š', 'åå…¥', 'åç›Š', 'ãƒ•ãƒ¼ãƒ‰', 'ãƒ‰ãƒªãƒ³ã‚¯', 'ãƒ©ãƒ³ãƒ', 'ãƒ‡ã‚£ãƒŠãƒ¼', 'ãã®ä»–å£²ä¸Š'],
            'åŸä¾¡': ['ä»•å…¥', 'åŸä¾¡', 'é£Ÿæ', 'ææ–™', 'FD', 'ãƒ•ãƒ¼ãƒ‰ä»•å…¥', 'ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥'],
            'å›ºå®šäººä»¶è²»': ['çµ¦æ–™', 'çµ¦ä¸', 'è³ä¸', 'æ³•å®šç¦åˆ©', 'ç¤¾å®…', 'é€šå‹¤', 'ä¼‘æ¥­æ‰‹å½“', 'ç¦åˆ©åšç”Ÿ', 'ãƒ˜ãƒ«ãƒ—äººä»¶è²»'],  // ãƒ˜ãƒ«ãƒ—äººä»¶è²»ã¯ç¤¾å“¡å¿œæ´è²»ç”¨
            'PAäººä»¶è²»': ['PA', 'ãƒ‘ãƒ¼ãƒˆ', 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ', 'é›‘çµ¦'],  // é›‘çµ¦ã®ã¿ï¼ˆå£²ä¸Šé€£å‹•ï¼‰
            'çµŒè²»': ['è²©ä¿ƒ', 'åºƒå‘Š', 'è¡›ç”Ÿ', 'æ¶ˆè€—å“', 'é›»æ°—', 'ã‚¬ã‚¹', 'æ°´é“', 'é€šä¿¡', 'æ‰‹æ•°æ–™',
                    'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', 'ä¼šè­°', 'äº¤éš›', 'æ—…è²»', 'å›³æ›¸', 'ç ”ä¿®', 'æ¡ç”¨', 'IT', 'å¤–æ³¨', 'é›‘è²»',
                    'ã‚µãƒ¼ãƒ“ã‚¹', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼', 'èª¿æŸ»', 'ä¿å®ˆ', 'ä¿®ç¹•', 'ç§Ÿç¨', 'è«¸ä¼šè²»'],
            'å›ºå®šè²»': ['å®¶è³ƒ', 'è³ƒå€Ÿ', 'æ¸›ä¾¡å„Ÿå´', 'ãƒªãƒ¼ã‚¹', 'è­¦å‚™', 'åœ°ä»£'],
            'åˆ©ç›Š': ['åˆ©ç›Š', 'æç›Š', 'å–¶æ¥­åˆ©ç›Š', 'åº—èˆ—å–¶æ¥­åˆ©ç›Š']
        };

        // ã‚«ãƒ†ã‚´ãƒªæ¨å®š
        function estimateCategory(itemName) {
            if (!itemName) return { category: 'çµŒè²»', confidence: 0 };

            var name = itemName.toLowerCase();
            var scores = {};

            for (var category in CATEGORY_RULES) {
                var keywords = CATEGORY_RULES[category];
                var matchCount = 0;
                var matchedKeywords = [];

                keywords.forEach(function(kw) {
                    if (name.includes(kw.toLowerCase())) {
                        matchCount++;
                        matchedKeywords.push(kw);
                    }
                });

                if (matchCount > 0) {
                    scores[category] = { count: matchCount, keywords: matchedKeywords };
                }
            }

            var bestCategory = 'çµŒè²»';
            var bestScore = 0;
            var matchedKws = [];

            for (var cat in scores) {
                if (scores[cat].count > bestScore) {
                    bestScore = scores[cat].count;
                    bestCategory = cat;
                    matchedKws = scores[cat].keywords;
                }
            }

            return {
                category: bestCategory,
                confidence: Math.min(bestScore / 2, 1.0),
                matchedKeywords: matchedKws
            };
        }

        // ç”»é¢è¨­å®šåˆ¥ä»•åˆ†ã‘ãƒ«ãƒ¼ãƒ«ï¼ˆv17æº–æ‹ ï¼‰
        var SCREEN_MAPPING_RULES = {
            'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š': {
                categories: ['äººä»¶è²»', 'ãã®ä»–å¤‰å‹•è²»', 'å›ºå®šè²»'],
                v17Range: [16, 59],  // No.16-25(å›ºå®šäººä»¶è²»), No.27-51(ãã®ä»–å¤‰å‹•è²»), No.55-59(å›ºå®šè²»)
                excludeItems: [19, 26],  // PAäººä»¶è²»(19)ã¯æœˆæ¬¡äºˆç®—ã§ç‡å…¥åŠ›ã€äººä»¶è²»åˆè¨ˆ(26)ã¯é›†è¨ˆé …ç›®ã€‚ãƒ˜ãƒ«ãƒ—äººä»¶è²»(20)ã¯ç‹¬ç«‹é …ç›®ã¨ã—ã¦å…¥åŠ›
                description: 'å›ºå®šè²»ç”¨äºˆç®—ï¼ˆå¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã€é‡‘é¡orï¼…å…¥åŠ›ã€è¨­å®šã‚¿ã‚¤ãƒ—é¸æŠï¼‰',
                inputType: 'é‡‘é¡orï¼…',
                hasMonthlyOverride: true  // å˜æœˆè²»ç”¨äºˆç®—ã§æœˆåˆ¥ä¸Šæ›¸ãå¯
            },
            'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š>å˜æœˆè²»ç”¨äºˆç®—': {
                categories: ['äººä»¶è²»', 'ãã®ä»–å¤‰å‹•è²»', 'å›ºå®šè²»'],
                condition: 'hasMonthlyVariation',
                description: 'æœˆåˆ¥å·®ç•°ãŒã‚ã‚‹å›ºå®šè²»ç”¨ï¼ˆå¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å˜æœˆã§å¤‰æ›´ï¼‰'
            },
            'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š': {
                items: [61, 64, 65],  // ç›®æ¨™æœˆæ¬¡åˆ©ç›Š, ç›®æ¨™å®¢æ•°, ç›®æ¨™å®¢å˜ä¾¡
                rateItems: ['FDä»•å…¥è²»ç‡', 'PAäººä»¶è²»ç‡'],  // ç‡å…¥åŠ›é …ç›®
                description: 'å¤‰å‹•è²»ç”¨ï¼ˆç‡è¨­å®šï¼‰+ ç›®æ¨™å€¤'
            },
            'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š>å£²ä¸Šæ§‹æˆæ¯”è¨­å®š': {
                items: [2, 3, 66, 67, 69, 70],  // ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š, ãã®ä»–å£²ä¸Š, ãƒ©ãƒ³ãƒæ¯”ç‡, ãƒ‡ã‚£ãƒŠãƒ¼æ¯”ç‡, ãƒ‰ãƒªãƒ³ã‚¯æ¯”ç‡, ãã®ä»–æ¯”ç‡
                description: 'å£²ä¸Šæ§‹æˆæ¯”ï¼ˆãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼æ¯”ç‡ã€FDæ§‹æˆæ¯”ï¼‰'
            },
            'è‡ªå‹•': {
                categories: ['é›†è¨ˆ'],
                items: [1, 4, 14, 15, 26, 52, 53, 54, 60, 62, 63, 68],  // è‡ªå‹•æ¼”ç®—é …ç›®
                description: 'ãƒ©ã‚¯ãƒŸãƒ¼å†…ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã‚‹é …ç›®'
            },
            'å‚ç…§ã®ã¿': {
                items: [5, 6, 7, 9, 10, 11, 13],  // æ£šå¸ãƒ»ä»•å…¥ãƒ»å†…éƒ¨æŒ¯æ›¿
                description: 'ãƒ©ã‚¯ãƒŸãƒ¼ã§ã¯ç®¡ç†ã—ãªã„ãŸã‚å‚ç…§ã®ã¿'
            }
        };

        // ç”»é¢è¨­å®šè‡ªå‹•åˆ¤å®šï¼ˆv17æº–æ‹ ï¼‰
        function autoAssignScreen(itemName, category, v17No) {
            // v17ç•ªå·ã«åŸºã¥ãåˆ¤å®š

            // 1. å‚ç…§ã®ã¿ï¼ˆæ£šå¸ãƒ»ä»•å…¥ãƒ»å†…éƒ¨æŒ¯æ›¿ï¼‰
            if ([5, 6, 7, 9, 10, 11, 13].includes(v17No)) {
                return 'å‚ç…§ã®ã¿';
            }

            // 2. è‡ªå‹•æ¼”ç®—é …ç›®
            if ([1, 4, 14, 15, 26, 52, 53, 54, 60, 62, 63, 68].includes(v17No)) {
                return 'è‡ªå‹•';
            }

            // 3. å£²ä¸Šæ§‹æˆæ¯”è¨­å®š
            if ([2, 3, 66, 67, 69, 70].includes(v17No)) {
                return 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š>å£²ä¸Šæ§‹æˆæ¯”è¨­å®š';
            }

            // 4. æœˆæ¬¡äºˆç®—è¨­å®šï¼ˆç›®æ¨™å€¤ãƒ»ç‡å…¥åŠ›ï¼‰
            if ([8, 12, 19, 20, 61, 64, 65].includes(v17No)) {
                return 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š';
            }

            // 5. è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šäººä»¶è²»ãƒ»ãã®ä»–å¤‰å‹•è²»ãƒ»å›ºå®šè²»ï¼‰
            if (category === 'äººä»¶è²»' && ![19, 20, 26].includes(v17No)) {
                return 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š';
            }
            if (category === 'ãã®ä»–å¤‰å‹•è²»' || category === 'å›ºå®šè²»') {
                return 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š';
            }

            // 6. åˆ©ç›Šï¼ˆç›®æ¨™æœˆæ¬¡åˆ©ç›Šï¼‰
            if (category === 'åˆ©ç›Š') {
                return 'è¨­å®š>æœˆæ¬¡äºˆç®—è¨­å®š';
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            return 'è¨­å®š>è²»ç”¨äºˆç®—è¨­å®š';
        }

        // æ¬¡ã®åˆ©ç”¨å¯èƒ½ãªv15ç•ªå·ã‚’å–å¾—
        function getNextAvailableV15No() {
            var usedNos = Object.values(CUSTOMER_CODE_MAP).map(function(m) { return m.v15No; });
            for (var v15No in ITEMS) {
                usedNos.push(parseInt(v15No));
            }

            // 51ã‹ã‚‰100ã®ç¯„å›²ã§æœªä½¿ç”¨ç•ªå·ã‚’æ¢ã™
            for (var i = 51; i <= 200; i++) {
                if (usedNos.indexOf(i) < 0) {
                    return i;
                }
            }
            return 201;
        }

        // ã‚¹ã‚³ã‚¢ä»˜ãé¡ä¼¼å€™è£œæ¤œç´¢
        function findSimilarItemsWithScore(targetName) {
            if (!targetName) return [];

            var suggestions = [];

            // CUSTOMER_CODE_MAPã‹ã‚‰æ¤œç´¢
            for (var code in CUSTOMER_CODE_MAP) {
                var item = CUSTOMER_CODE_MAP[code];
                var score = calculateMatchScore(targetName, item.name);

                if (score >= 0.3) {
                    suggestions.push({
                        code: code,
                        name: item.name,
                        v15No: item.v15No,
                        category: item.category,
                        score: score,
                        matchType: 'existing'
                    });
                }
            }

            // RAKUMY_ITEMSã‹ã‚‰ã‚‚æ¤œç´¢
            for (var key in RAKUMY_ITEMS) {
                var rakumyItem = RAKUMY_ITEMS[key];
                if (!rakumyItem.name) continue;

                var score = calculateMatchScore(targetName, rakumyItem.name);

                if (score >= 0.3) {
                    var exists = suggestions.some(function(s) { return s.name === rakumyItem.name; });
                    if (!exists) {
                        suggestions.push({
                            code: null,
                            name: rakumyItem.name,
                            v15No: null,
                            category: rakumyItem.category || 'ä¸æ˜',
                            score: score,
                            matchType: 'rakumy'
                        });
                    }
                }
            }

            // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
            suggestions.sort(function(a, b) { return b.score - a.score; });

            return suggestions.slice(0, 10);
        }

        // â˜…â˜…â˜… ã‚¹ãƒãƒ¼ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ â˜…â˜…â˜…
        var smartImportResults = null;

        function runSmartImport() {
            if (!unmatchedItems || unmatchedItems.length === 0) {
                showStatus('info', 'æœªãƒãƒƒãƒé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            smartImportResults = {
                autoMapped: [],
                needsReview: [],
                skipped: []
            };

            unmatchedItems.forEach(function(item) {
                // é¡ä¼¼å€™è£œã‚’æ¤œç´¢ï¼ˆã‚¹ã‚³ã‚¢ä»˜ãï¼‰
                var suggestions = findSimilarItemsWithScore(item.name || '');

                // é«˜ã‚¹ã‚³ã‚¢ï¼ˆ80%ä»¥ä¸Šï¼‰ãªã‚‰è‡ªå‹•é©ç”¨å€™è£œ
                if (suggestions.length > 0 && suggestions[0].score >= 0.8 && suggestions[0].code) {
                    var best = suggestions[0];
                    smartImportResults.autoMapped.push({
                        code: item.code,
                        name: item.name,
                        mappedTo: best,
                        score: best.score
                    });
                }
                // ä¸­ã‚¹ã‚³ã‚¢ï¼ˆ50-80%ï¼‰ã¾ãŸã¯å€™è£œã‚ã‚Š â†’ ç¢ºèªç”¨ãƒªã‚¹ãƒˆã¸
                else if (suggestions.length > 0 && suggestions[0].score >= 0.5) {
                    smartImportResults.needsReview.push({
                        item: item,
                        suggestions: suggestions,
                        estimated: estimateCategory(item.name)
                    });
                }
                // ä½ã‚¹ã‚³ã‚¢ã¾ãŸã¯å€™è£œãªã— â†’ æ–°è¦é …ç›®ã¨ã—ã¦è‡ªå‹•åˆ†é¡å€™è£œ
                else {
                    var estimated = estimateCategory(item.name);
                    var screen = autoAssignScreen(item.name, estimated.category, null);
                    var newV15No = getNextAvailableV15No();

                    smartImportResults.needsReview.push({
                        item: item,
                        suggestions: suggestions,
                        estimated: estimated,
                        autoAssign: {
                            category: estimated.category,
                            screen: screen,
                            v15No: newV15No
                        },
                        isNew: true
                    });
                }
            });

            // çµæœè¡¨ç¤º
            showSmartImportModal();
        }

        function showSmartImportModal() {
            if (!smartImportResults) return;

            var modal = document.getElementById('smartImportModal');
            if (!modal) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒãªã‘ã‚Œã°ä½œæˆ
                modal = document.createElement('div');
                modal.id = 'smartImportModal';
                modal.style.cssText = 'display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;overflow:auto;';
                document.body.appendChild(modal);
            }

            var html = '<div style="position:relative;margin:30px auto;background:#fff;border-radius:12px;max-width:1200px;max-height:90vh;overflow:auto;">';
            html += '<div style="padding:20px;border-bottom:1px solid #ddd;background:linear-gradient(135deg, #1a237e 0%, #4a148c 100%);color:#fff;border-radius:12px 12px 0 0;">';
            html += '<h2 style="margin:0;">ğŸ¤– ã‚¹ãƒãƒ¼ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ</h2>';
            html += '<p style="margin:5px 0 0 0;opacity:0.9;">æœªãƒãƒƒãƒé …ç›®: ' + unmatchedItems.length + 'ä»¶ã‚’åˆ†æã—ã¾ã—ãŸ</p>';
            html += '</div>';

            html += '<div style="padding:20px;">';

            // è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°å€™è£œ
            if (smartImportResults.autoMapped.length > 0) {
                html += '<div style="margin-bottom:20px;padding:15px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50;">';
                html += '<h3 style="margin:0 0 10px 0;color:#2e7d32;">âœ… è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°å€™è£œï¼ˆ' + smartImportResults.autoMapped.length + 'ä»¶ï¼‰</h3>';
                html += '<p style="font-size:12px;color:#666;margin-bottom:10px;">é¡ä¼¼åº¦80%ä»¥ä¸Š - ä¸€æ‹¬é©ç”¨ã§ãã¾ã™</p>';
                html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                html += '<tr style="background:#c8e6c9;"><th style="padding:8px;text-align:left;">é¡§å®¢ã‚³ãƒ¼ãƒ‰</th><th>é …ç›®å</th><th>â†’</th><th>ãƒãƒƒãƒ”ãƒ³ã‚°å…ˆ</th><th>é¡ä¼¼åº¦</th><th>é¸æŠ</th></tr>';

                smartImportResults.autoMapped.forEach(function(m, idx) {
                    html += '<tr style="background:#fff;">';
                    html += '<td style="padding:8px;border-bottom:1px solid #ddd;"><strong>' + m.code + '</strong></td>';
                    html += '<td style="padding:8px;border-bottom:1px solid #ddd;">' + (m.name || '-') + '</td>';
                    html += '<td style="padding:8px;border-bottom:1px solid #ddd;color:#4caf50;">â†’</td>';
                    html += '<td style="padding:8px;border-bottom:1px solid #ddd;">[' + m.mappedTo.v15No + '] ' + m.mappedTo.name + '</td>';
                    html += '<td style="padding:8px;border-bottom:1px solid #ddd;"><span style="background:#4caf50;color:#fff;padding:2px 8px;border-radius:10px;">' + Math.round(m.score * 100) + '%</span></td>';
                    html += '<td style="padding:8px;border-bottom:1px solid #ddd;"><input type="checkbox" checked id="auto_' + idx + '"></td>';
                    html += '</tr>';
                });

                html += '</table>';
                html += '<button onclick="applyAutoMappings()" style="margin-top:10px;padding:10px 20px;background:#4caf50;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">âœ“ é¸æŠã—ãŸé …ç›®ã‚’ä¸€æ‹¬é©ç”¨</button>';
                html += '</div>';
            }

            // ç¢ºèªãŒå¿…è¦ãªé …ç›®
            if (smartImportResults.needsReview.length > 0) {
                html += '<div style="margin-bottom:20px;padding:15px;background:#fff3e0;border-radius:8px;border-left:4px solid #ff9800;">';
                html += '<h3 style="margin:0 0 10px 0;color:#e65100;">âš ï¸ ç¢ºèªãŒå¿…è¦ï¼ˆ' + smartImportResults.needsReview.length + 'ä»¶ï¼‰</h3>';
                html += '<p style="font-size:12px;color:#666;margin-bottom:10px;">å€™è£œã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦é …ç›®ã¨ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„</p>';

                smartImportResults.needsReview.forEach(function(r, idx) {
                    html += '<div style="background:#fff;border:1px solid #ddd;border-radius:6px;padding:12px;margin-bottom:10px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                    html += '<div>';
                    html += '<strong style="color:#d32f2f;">' + r.item.code + '</strong>';
                    html += '<span style="margin-left:10px;color:#666;">' + (r.item.name || '(åç§°ãªã—)') + '</span>';
                    if (r.isNew) {
                        html += '<span style="margin-left:10px;background:#2196f3;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;">æ–°è¦é …ç›®</span>';
                    }
                    html += '</div>';
                    html += '<div style="font-size:11px;color:#666;">';
                    html += 'æ¨å®šã‚«ãƒ†ã‚´ãƒª: <strong>' + r.estimated.category + '</strong>';
                    if (r.autoAssign) {
                        html += ' â†’ ' + r.autoAssign.screen;
                    }
                    html += '</div>';
                    html += '</div>';

                    // å€™è£œãŒã‚ã‚Œã°è¡¨ç¤º
                    if (r.suggestions && r.suggestions.length > 0) {
                        html += '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:5px;">';
                        r.suggestions.slice(0, 5).forEach(function(s, sIdx) {
                            var scoreColor = s.score >= 0.7 ? '#4caf50' : (s.score >= 0.5 ? '#ff9800' : '#9e9e9e');
                            html += '<label style="display:inline-flex;align-items:center;gap:5px;background:#f5f5f5;padding:5px 10px;border-radius:4px;font-size:11px;cursor:pointer;">';
                            html += '<input type="radio" name="review_' + idx + '" value="' + sIdx + '"' + (sIdx === 0 ? ' checked' : '') + '>';
                            if (s.code) {
                                html += '<span>[' + s.v15No + '] ' + s.name + '</span>';
                            } else {
                                html += '<span style="color:#666;">' + s.name + ' (å‚è€ƒ)</span>';
                            }
                            html += '<span style="background:' + scoreColor + ';color:#fff;padding:1px 5px;border-radius:8px;font-size:9px;">' + Math.round(s.score * 100) + '%</span>';
                            html += '</label>';
                        });
                        html += '</div>';
                    }

                    // æ–°è¦è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                    if (r.autoAssign) {
                        html += '<div style="margin-top:8px;padding:8px;background:#e3f2fd;border-radius:4px;font-size:11px;">';
                        html += '<label style="display:flex;align-items:center;gap:5px;cursor:pointer;">';
                        html += '<input type="radio" name="review_' + idx + '" value="new"' + (r.suggestions.length === 0 ? ' checked' : '') + '>';
                        html += '<span>ğŸ†• æ–°è¦è¿½åŠ : v15No=' + r.autoAssign.v15No + ', ã‚«ãƒ†ã‚´ãƒª=' + r.autoAssign.category + ', ç”»é¢=' + r.autoAssign.screen + '</span>';
                        html += '</label>';
                        html += '</div>';
                    }

                    html += '</div>';
                });

                html += '<button onclick="applyReviewMappings()" style="margin-top:10px;padding:10px 20px;background:#ff9800;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">âœ“ é¸æŠã—ãŸå†…å®¹ã§é©ç”¨</button>';
                html += '</div>';
            }

            // ã‚µãƒãƒªãƒ¼
            html += '<div style="padding:15px;background:#f5f5f5;border-radius:8px;text-align:center;">';
            html += '<span style="margin-right:20px;">è‡ªå‹•é©ç”¨å¯èƒ½: <strong style="color:#4caf50;">' + smartImportResults.autoMapped.length + 'ä»¶</strong></span>';
            html += '<span style="margin-right:20px;">è¦ç¢ºèª: <strong style="color:#ff9800;">' + smartImportResults.needsReview.length + 'ä»¶</strong></span>';
            html += '</div>';

            html += '</div>';

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            html += '<div style="padding:15px;border-top:1px solid #ddd;text-align:right;">';
            html += '<button onclick="hideSmartImportModal()" style="padding:10px 30px;background:#9e9e9e;color:#fff;border:none;border-radius:6px;cursor:pointer;">é–‰ã˜ã‚‹</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function hideSmartImportModal() {
            var modal = document.getElementById('smartImportModal');
            if (modal) modal.style.display = 'none';
        }

        function applyAutoMappings() {
            if (!smartImportResults || !smartImportResults.autoMapped) return;

            var appliedCount = 0;
            smartImportResults.autoMapped.forEach(function(m, idx) {
                var checkbox = document.getElementById('auto_' + idx);
                if (checkbox && checkbox.checked) {
                    CUSTOMER_CODE_MAP[m.code] = {
                        v15No: m.mappedTo.v15No,
                        name: m.name || m.mappedTo.name,
                        category: m.mappedTo.category
                    };
                    appliedCount++;
                }
            });

            showStatus('success', appliedCount + 'ä»¶ã®è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨ã—ã¾ã—ãŸ');
            hideSmartImportModal();

            // å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            if (document.getElementById('csvFile').files[0]) {
                importCSV();
            }
        }

        function applyReviewMappings() {
            if (!smartImportResults || !smartImportResults.needsReview) return;

            var appliedCount = 0;
            var newCount = 0;

            smartImportResults.needsReview.forEach(function(r, idx) {
                var selectedRadio = document.querySelector('input[name="review_' + idx + '"]:checked');
                if (!selectedRadio) return;

                var value = selectedRadio.value;

                if (value === 'new' && r.autoAssign) {
                    // æ–°è¦è¿½åŠ 
                    var newV15No = getNextAvailableV15No();
                    CUSTOMER_CODE_MAP[r.item.code] = {
                        v15No: newV15No,
                        name: r.item.name || r.item.code,
                        category: r.autoAssign.category
                    };
                    ITEMS[newV15No] = {
                        name: r.item.name || r.item.code,
                        category: r.autoAssign.category
                    };
                    newCount++;
                } else {
                    var sIdx = parseInt(value);
                    if (!isNaN(sIdx) && r.suggestions[sIdx] && r.suggestions[sIdx].code) {
                        var suggestion = r.suggestions[sIdx];
                        CUSTOMER_CODE_MAP[r.item.code] = {
                            v15No: suggestion.v15No,
                            name: r.item.name || suggestion.name,
                            category: suggestion.category
                        };
                        appliedCount++;
                    }
                }
            });

            var msg = '';
            if (appliedCount > 0) msg += appliedCount + 'ä»¶ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨';
            if (newCount > 0) msg += (msg ? 'ã€' : '') + newCount + 'ä»¶ã®æ–°è¦é …ç›®ã‚’è¿½åŠ ';

            if (msg) {
                showStatus('success', msg + 'ã—ã¾ã—ãŸ');
            }

            hideSmartImportModal();

            // å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            if (document.getElementById('csvFile').files[0]) {
                importCSV();
            }
        }

        // â˜… é¡ä¼¼é …ç›®ãƒãƒƒãƒãƒ³ã‚°ï¼ˆå¾“æ¥ç‰ˆãƒ»äº’æ›æ€§ç¶­æŒï¼‰
        function findSimilarItems(targetName) {
            var suggestions = [];
            var targetLower = targetName.toLowerCase();

            for (var code in CUSTOMER_CODE_MAP) {
                var item = CUSTOMER_CODE_MAP[code];
                var nameLower = item.name.toLowerCase();

                // å®Œå…¨ä¸€è‡´ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´ã‚’ãƒã‚§ãƒƒã‚¯
                if (nameLower.indexOf(targetLower) >= 0 || targetLower.indexOf(nameLower) >= 0) {
                    suggestions.push({
                        code: code,
                        name: item.name,
                        v15No: item.v15No,
                        category: item.category,
                        matchType: 'partial'
                    });
                }
            }

            // ãƒ©ã‚¯ãƒŸãƒ¼é …ç›®ã‹ã‚‰ã‚‚å€™è£œã‚’æ¤œç´¢
            for (var key in RAKUMY_ITEMS) {
                var rakumyItem = RAKUMY_ITEMS[key];
                if (!rakumyItem.name) continue;
                var rakumyLower = rakumyItem.name.toLowerCase();

                if (rakumyLower.indexOf(targetLower) >= 0 || targetLower.indexOf(rakumyLower) >= 0) {
                    // æ—¢ã«å€™è£œã«ãªã„ã‹ç¢ºèª
                    var exists = suggestions.some(function(s) { return s.name === rakumyItem.name; });
                    if (!exists) {
                        suggestions.push({
                            code: null,
                            name: rakumyItem.name,
                            v15No: null,
                            category: rakumyItem.category || 'ä¸æ˜',
                            matchType: 'rakumy'
                        });
                    }
                }
            }

            return suggestions.slice(0, 5); // æœ€å¤§5ä»¶
        }

        function renderSimilarSuggestions() {
            var container = document.getElementById('similarSuggestions');
            if (!container || !unmatchedItems || unmatchedItems.length === 0) {
                if (container) container.innerHTML = '';
                return;
            }

            var html = '<div style="background:#e3f2fd;border-radius:8px;padding:10px;margin-top:10px;">';
            html += '<h5 style="color:#1565c0;margin-bottom:10px;">ğŸ’¡ é¡ä¼¼é …ç›®ã®å€™è£œ</h5>';

            var hasSuggestions = false;
            unmatchedItems.forEach(function(unmatchedItem) {
                var suggestions = findSimilarItems(unmatchedItem.name || '');
                if (suggestions.length === 0) return;

                hasSuggestions = true;
                html += '<div style="margin-bottom:10px;padding:8px;background:#fff;border-radius:4px;">';
                html += '<strong style="color:#d32f2f;">' + unmatchedItem.code + ' (' + (unmatchedItem.name || 'åç§°ãªã—') + ')</strong>';
                html += '<div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:5px;">';

                suggestions.forEach(function(suggestion) {
                    var bgColor = suggestion.matchType === 'rakumy' ? '#e8f5e9' : '#fff3e0';
                    var label = suggestion.matchType === 'rakumy' ? 'ãƒ©ã‚¯ãƒŸãƒ¼' : suggestion.code;
                    html += '<span style="background:' + bgColor + ';border-radius:4px;padding:3px 8px;font-size:10px;">';
                    html += '<strong>' + label + '</strong>: ' + suggestion.name;
                    if (suggestion.code) {
                        html += ' <button style="background:#4caf50;color:#fff;border:none;border-radius:3px;padding:1px 5px;font-size:9px;cursor:pointer;" onclick="applyMappingSuggestion(\'' + unmatchedItem.code + '\', \'' + (unmatchedItem.name || '').replace(/'/g, "\\'") + '\', ' + suggestion.v15No + ', \'' + suggestion.category + '\')">é©ç”¨</button>';
                    }
                    html += '</span>';
                });

                html += '</div></div>';
            });

            if (!hasSuggestions) {
                html += '<p style="color:#666;font-size:11px;">é¡ä¼¼ã™ã‚‹é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function applyMappingSuggestion(code, name, v15No, category) {
            CUSTOMER_CODE_MAP[code] = { v15No: v15No, name: name, category: category };
            ITEMS[v15No] = { name: name, category: category };

            showStatus('success', 'ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨ã—ã¾ã—ãŸ: ' + code + ' â†’ [' + v15No + ']');

            // å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦æ›´æ–°
            if (document.getElementById('csvFile').files[0]) {
                importCSV();
            }
        }

        // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function exportAllConfig() {
            var config = {
                version: '5.8',
                mapping: CUSTOMER_CODE_MAP,
                calcRules: CALC_RULES,
                rakumyItems: RAKUMY_ITEMS,
                items: ITEMS,
                allStoresData: allStoresData // å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜
            };
            var blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'budget_config_v5.8_' + new Date().toISOString().slice(0,10) + '.json';
            link.click();
        }

        // â˜… ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportRakumyInputsCSV() {
            var targetStores = getExportTargetStores();
            if (targetStores.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var csv = [];
            var BOM = '\uFEFF'; // Excelç”¨BOM
            var isMultiStore = targetStores.length > 1;

            // å…±é€šã®æœˆãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆæœ€åˆã®åº—èˆ—ã‹ã‚‰ï¼‰
            var firstStoreData = allStoresData[targetStores[0]];
            var commonMonthLabels = firstStoreData.monthLabels || monthLabels || [];
            var commonActiveMonths = firstStoreData.activeMonths || activeMonths || [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var header = ['åº—èˆ—å', 'ã‚»ã‚¯ã‚·ãƒ§ãƒ³', 'é …ç›®å', 'å¤‰æ›ã‚¿ã‚¤ãƒ—'];
            commonMonthLabels.forEach(function(m) { header.push(m); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
            targetStores.forEach(function(stName, storeIndex) {
                var storeData = allStoresData[stName];
                if (!storeData || !storeData.rakumyInputs) return;

                var stRakumyInputs = storeData.rakumyInputs;
                var stActiveMonths = storeData.activeMonths || [];

                // åº—èˆ—é–“åŒºåˆ‡ã‚Š
                if (storeIndex > 0) {
                    csv.push('');
                }

                // ========== æ–°ãƒ­ã‚¸ãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤æ±ºå®š + å·®ç•°æœˆç‰¹å®šï¼ˆåº—èˆ—ã”ã¨ï¼‰ ==========
                function analyzeMonthlyValuesForStore(key) {
                    var values = [];
                    var valueCount = {};

                    for (var m = 0; m < stActiveMonths.length; m++) {
                        var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                        var roundedVal = Math.round(val * 100) / 100;
                        values.push(roundedVal);
                        valueCount[roundedVal] = (valueCount[roundedVal] || 0) + 1;
                    }

                    var defaultValue = 0;
                    var maxCount = 0;
                    for (var v in valueCount) {
                        if (valueCount[v] > maxCount) {
                            maxCount = valueCount[v];
                            defaultValue = parseFloat(v);
                        }
                    }

                    var diffMonths = [];
                    var diffValues = {};
                    for (var m = 0; m < values.length; m++) {
                        if (Math.abs(values[m] - defaultValue) > 0.01) {
                            diffMonths.push(m);
                            diffValues[m] = values[m];
                        }
                    }

                    return {
                        defaultValue: defaultValue,
                        diffMonths: diffMonths,
                        diffValues: diffValues,
                        hasDiff: diffMonths.length > 0
                    };
                }

                // === è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰=== æ–°ãƒ­ã‚¸ãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å‡ºåŠ›ï¼ˆå††å˜ä½ï¼‰
                for (var key in RAKUMY_ITEMS) {
                    var item = RAKUMY_ITEMS[key];
                    if (item.category !== 'cost') continue;

                    var analysis = analyzeMonthlyValuesForStore(key);
                    var row = [stName, 'è²»ç”¨äºˆç®—è¨­å®š', item.name, item.type];

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæœ€é »å€¤ï¼‰ã‚’å…¨æœˆã«å‡ºåŠ›ï¼ˆå††å˜ä½ï¼šÃ—1000ï¼‰
                    var total = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        row.push(Math.round(analysis.defaultValue * 1000));
                        total += analysis.defaultValue;
                    }
                    row.push(Math.round(total * 1000), Math.round(analysis.defaultValue * 1000));
                    csv.push(row.join(','));
                }

                // === å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰=== æ–°ãƒ­ã‚¸ãƒƒã‚¯: å·®ç•°æœˆã®ã¿å€¤ã‚’å‡ºåŠ›ï¼ˆå††å˜ä½ï¼‰
                for (var key in RAKUMY_ITEMS) {
                    var item = RAKUMY_ITEMS[key];
                    if (item.category !== 'monthly') continue;

                    var baseKey = key.replace('m_', '');
                    var analysis = analyzeMonthlyValuesForStore(baseKey);
                    if (!analysis.hasDiff) continue;

                    var row = [stName, 'å˜æœˆè²»ç”¨äºˆç®—', item.name, item.type];
                    var diffTotal = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        var isDiffMonth = analysis.diffMonths.indexOf(m) >= 0;
                        if (isDiffMonth) {
                            var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                            diffTotal += val;
                            row.push(Math.round(val * 1000));
                        } else {
                            row.push('-'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé©ç”¨æœˆã¯ã€Œ-ã€
                        }
                    }
                    row.push(Math.round(diffTotal * 1000), '(' + analysis.diffMonths.length + 'æœˆ)');
                    csv.push(row.join(','));
                }

                // === äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰===ï¼ˆå††å˜ä½ï¼‰
                for (var key in RAKUMY_ITEMS) {
                    var item = RAKUMY_ITEMS[key];
                    if (item.category !== 'budget') continue;

                    var isRate = item.type === 'rate' || key.indexOf('Ratio') > -1;
                    var row = [stName, 'äºˆç®—è¨­å®š', item.name, item.type];
                    var total = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        var val = stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0;
                        total += val;
                        row.push(isRate ? Math.round(val) + '%' : Math.round(val * 1000));
                    }
                    if (isRate) {
                        row.push('-', Math.round(total / stActiveMonths.length) + '%');
                    } else {
                        row.push(Math.round(total * 1000), Math.round(total * 1000 / stActiveMonths.length));
                    }
                    csv.push(row.join(','));
                }
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            var filename = isMultiStore
                ? 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤_å…¨' + targetStores.length + 'åº—èˆ—_' + new Date().toISOString().slice(0,10) + '.csv'
                : 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤_' + targetStores[0] + '_' + new Date().toISOString().slice(0,10) + '.csv';

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            // å±¥æ­´ã«è¿½åŠ 
            addToExportHistory('ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSV', targetStores, BOM + csv.join('\n'));
            showStatus('success', 'ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ' + targetStores.length + 'åº—èˆ—ï¼‰');
        }

        // â˜… äºˆç®—ä¸€è¦§CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportBudgetListCSV() {
            var targetStores = getExportTargetStores();
            if (targetStores.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var csv = [];
            var BOM = '\uFEFF';
            var isMultiStore = targetStores.length > 1;

            // å…±é€šã®æœˆãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆæœ€åˆã®åº—èˆ—ã‹ã‚‰ï¼‰
            var firstStoreData = allStoresData[targetStores[0]];
            var commonMonthLabels = firstStoreData.monthLabels || monthLabels || [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var header = ['åº—èˆ—å', 'ã‚»ã‚¯ã‚·ãƒ§ãƒ³', 'é …ç›®å'];
            commonMonthLabels.forEach(function(m) { header.push(m); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            var expenseKeys = ['rent', 'depreciation', 'material', 'promotion', 'sanitary', 'service',
                'electricity', 'gas', 'water', 'consumables', 'maintenance', 'communication',
                'creditFee', 'paymentFee', 'membership', 'it', 'outsource', 'misc'];

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
            targetStores.forEach(function(stName, storeIndex) {
                var storeData = allStoresData[stName];
                if (!storeData || !storeData.rakumyInputs || !storeData.mqOutputs) return;

                var stRakumyInputs = storeData.rakumyInputs;
                var stMqOutputs = storeData.mqOutputs;
                var stAnnualData = storeData.annualData || {};
                var stActiveMonths = storeData.activeMonths || [];

                // åº—èˆ—é–“åŒºåˆ‡ã‚Š
                if (storeIndex > 0) {
                    csv.push('');
                }

                // addRow: isRate=trueâ†’ç‡, isYenAlready=trueâ†’æ—¢ã«å††å˜ä½, ãã‚Œä»¥å¤–â†’åƒå††â†’å††å¤‰æ›
                function addRow(section, name, values, isRate, isYenAlready) {
                    var row = [stName, section, name];
                    var total = 0;
                    for (var m = 0; m < values.length; m++) {
                        var val = values[m] || 0;
                        total += val;
                        if (isRate) {
                            row.push(val.toFixed(1) + '%');
                        } else if (isYenAlready) {
                            row.push(Math.round(val));  // æ—¢ã«å††å˜ä½
                        } else {
                            row.push(Math.round(val * 1000));  // åƒå††â†’å††å¤‰æ›
                        }
                    }
                    if (isRate) {
                        row.push('-', (total / values.length).toFixed(1) + '%');
                    } else if (isYenAlready) {
                        row.push(Math.round(total), Math.round(total / values.length));
                    } else {
                        row.push(Math.round(total * 1000), Math.round(total * 1000 / values.length));
                    }
                    csv.push(row.join(','));
                }

                function getMonthlyData(getValue) {
                    var result = [];
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        result.push(getValue(m));
                    }
                    return result;
                }

                // ç›®æ¨™è¨­å®š
                addRow('ç›®æ¨™è¨­å®š', 'æœˆæ¬¡ç›®æ¨™åˆ©ç›Š', getMonthlyData(function(m) { return stAnnualData[63] ? (stAnnualData[63][m] || 0) : 0; }), false, false);
                addRow('ç›®æ¨™è¨­å®š', 'ç›®æ¨™FDä»•å…¥è²»ç‡', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].fdRate || 0) : 0; }), true, false);
                addRow('ç›®æ¨™è¨­å®š', 'ç›®æ¨™PAäººä»¶è²»ç‡', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0; }), true, false);
                addRow('ç›®æ¨™è¨­å®š', 'ç›®æ¨™å®¢å˜ä¾¡', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].targetUnitPrice || 0) : 0; }), false, true);  // æ—¢ã«å††å˜ä½

                // å£²ä¸Š
                addRow('å£²ä¸Š', 'å£²ä¸Š è¨ˆ', getMonthlyData(function(m) { return stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0; }), false);
                addRow('å£²ä¸Š', 'ãƒ•ãƒ¼ãƒ‰å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var ratio = stRakumyInputs[m] ? (stRakumyInputs[m].foodRatio || 0) : 0;
                    return Math.round(sales * ratio / 100);
                }), false);
                addRow('å£²ä¸Š', 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var ratio = stRakumyInputs[m] ? (stRakumyInputs[m].drinkRatio || 0) : 0;
                    return Math.round(sales * ratio / 100);
                }), false);
                addRow('å£²ä¸Š', 'ãã®ä»–å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var ratio = stRakumyInputs[m] ? (stRakumyInputs[m].otherRatio || 0) : 0;
                    return Math.round(sales * ratio / 100);
                }), false);

                // FLã‚³ã‚¹ãƒˆ
                addRow('FLã‚³ã‚¹ãƒˆ', 'FLã‚³ã‚¹ãƒˆ è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var fdRate = stRakumyInputs[m] ? (stRakumyInputs[m].fdRate || 0) : 0;
                    var fixedLabor = stRakumyInputs[m] ? (stRakumyInputs[m].fixedLabor || 0) : 0;
                    var paRate = stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0;
                    return Math.round(sales * fdRate / 100 + fixedLabor + sales * paRate / 100);
                }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'FDä»•å…¥ è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var fdRate = stRakumyInputs[m] ? (stRakumyInputs[m].fdRate || 0) : 0;
                    return Math.round(sales * fdRate / 100);
                }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'äººä»¶è²» è¨ˆ', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var fixedLabor = stRakumyInputs[m] ? (stRakumyInputs[m].fixedLabor || 0) : 0;
                    var paRate = stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0;
                    return Math.round(fixedLabor + sales * paRate / 100);
                }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'å›ºå®šäººä»¶è²»', getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m].fixedLabor || 0) : 0; }), false);
                addRow('FLã‚³ã‚¹ãƒˆ', 'PAäººä»¶è²»', getMonthlyData(function(m) {
                    var sales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var paRate = stRakumyInputs[m] ? (stRakumyInputs[m].paRate || 0) : 0;
                    return Math.round(sales * paRate / 100);
                }), false);

                // ãã®ä»–çµŒè²»
                addRow('ãã®ä»–çµŒè²»', 'ãã®ä»–çµŒè²» è¨ˆ', getMonthlyData(function(m) {
                    var total = 0;
                    expenseKeys.forEach(function(key) { total += stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0; });
                    return total;
                }), false);
                expenseKeys.forEach(function(key) {
                    var name = RAKUMY_ITEMS[key] ? RAKUMY_ITEMS[key].name : key;
                    addRow('ãã®ä»–çµŒè²»', name, getMonthlyData(function(m) { return stRakumyInputs[m] ? (stRakumyInputs[m][key] || 0) : 0; }), false);
                });

                // å–¶æ¥­åˆ©ç›Š
                addRow('å–¶æ¥­åˆ©ç›Š', 'å–¶æ¥­åˆ©ç›Š', getMonthlyData(function(m) { return stMqOutputs[m] ? (stMqOutputs[m].operatingProfit || 0) : 0; }), false);
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            var filename = isMultiStore
                ? 'äºˆç®—ä¸€è¦§_å…¨' + targetStores.length + 'åº—èˆ—_' + new Date().toISOString().slice(0,10) + '.csv'
                : 'äºˆç®—ä¸€è¦§_' + targetStores[0] + '_' + new Date().toISOString().slice(0,10) + '.csv';

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            // å±¥æ­´ã«è¿½åŠ 
            addToExportHistory('äºˆç®—ä¸€è¦§CSV', targetStores, BOM + csv.join('\n'));
            showStatus('success', 'äºˆç®—ä¸€è¦§CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ' + targetStores.length + 'åº—èˆ—ï¼‰');
        }

        // â˜… MQå‡ºåŠ›CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportMQOutputCSV() {
            var targetStores = getExportTargetStores();
            if (targetStores.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var csv = [];
            var BOM = '\uFEFF';
            var isMultiStore = targetStores.length > 1;

            // å…±é€šã®æœˆãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆæœ€åˆã®åº—èˆ—ã‹ã‚‰ï¼‰
            var firstStoreData = allStoresData[targetStores[0]];
            var commonMonthLabels = firstStoreData.monthLabels || monthLabels || [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var header = ['åº—èˆ—å', 'é …ç›®'];
            commonMonthLabels.forEach(function(m) { header.push(m); });
            header.push('åˆè¨ˆ', 'å¹³å‡');
            csv.push(header.join(','));

            // MQé …ç›®å®šç¾©: isPerson=äººæ•°, isYen=å††å˜ä½, isMoney=åƒå††â†’å††å¤‰æ›
            var mqItems = [
                { key: 'customers', name: 'å®¢æ•°', isRate: false, isPerson: true },
                { key: 'unitPrice', name: 'å®¢å˜ä¾¡', isRate: false, isYen: true },
                { key: 'sales', name: 'å£²ä¸Š', isRate: false, isMoney: true },
                { key: 'variableCost', name: 'å¤‰å‹•è²»', isRate: false, isMoney: true },
                { key: 'variableRate', name: 'å¤‰å‹•è²»ç‡', isRate: true },
                { key: 'grossProfit', name: 'ç²—åˆ©', isRate: false, isMoney: true },
                { key: 'grossProfitRate', name: 'ç²—åˆ©ç‡', isRate: true },
                { key: 'fixedCost', name: 'å›ºå®šè²»', isRate: false, isMoney: true },
                { key: 'operatingProfit', name: 'å–¶æ¥­åˆ©ç›Š', isRate: false, isMoney: true },
                { key: 'operatingProfitRate', name: 'å–¶æ¥­åˆ©ç›Šç‡', isRate: true }
            ];

            // å„åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
            targetStores.forEach(function(stName, storeIndex) {
                var storeData = allStoresData[stName];
                if (!storeData || !storeData.mqOutputs) return;

                var stMqOutputs = storeData.mqOutputs;
                var stAnnualData = storeData.annualData || {};
                var stActiveMonths = storeData.activeMonths || [];

                // åº—èˆ—é–“åŒºåˆ‡ã‚Š
                if (storeIndex > 0) {
                    csv.push('');
                }

                // MQé …ç›®ï¼ˆå††å˜ä½å¤‰æ›å¯¾å¿œï¼‰
                mqItems.forEach(function(item) {
                    var row = [stName, item.name];
                    var total = 0;
                    for (var m = 0; m < stActiveMonths.length; m++) {
                        var val = stMqOutputs[m] ? (stMqOutputs[m][item.key] || 0) : 0;
                        total += val;
                        if (item.isRate) {
                            row.push(val.toFixed(1) + '%');
                        } else if (item.isPerson || item.isYen) {
                            row.push(Math.round(val));  // äººæ•°ãƒ»å††å˜ä½ã¯ãã®ã¾ã¾
                        } else if (item.isMoney) {
                            row.push(Math.round(val * 1000));  // åƒå††â†’å††å¤‰æ›
                        } else {
                            row.push(Math.round(val));
                        }
                    }
                    if (item.isRate) {
                        row.push('-', (total / stActiveMonths.length).toFixed(1) + '%');
                    } else if (item.isPerson || item.isYen) {
                        row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                    } else if (item.isMoney) {
                        row.push(Math.round(total * 1000), Math.round(total * 1000 / stActiveMonths.length));
                    } else {
                        row.push(Math.round(total), Math.round(total / stActiveMonths.length));
                    }
                    csv.push(row.join(','));
                });

                // é¡§å®¢äºˆç®—ã¨ã®æ¯”è¼ƒï¼ˆå††å˜ä½å¤‰æ›ï¼‰
                // é¡§å®¢äºˆç®—å£²ä¸Šï¼ˆNo.4 å£²ä¸Šé«˜åˆè¨ˆï¼‰
                var budgetSalesRow = [stName, 'é¡§å®¢äºˆç®—å£²ä¸Š'];
                var budgetSalesTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stAnnualData[4] ? (stAnnualData[4][m] || 0) : 0;
                    budgetSalesTotal += val;
                    budgetSalesRow.push(Math.round(val * 1000));
                }
                budgetSalesRow.push(Math.round(budgetSalesTotal * 1000), Math.round(budgetSalesTotal * 1000 / stActiveMonths.length));
                csv.push(budgetSalesRow.join(','));

                // å£²ä¸Šå·®ç•°ï¼ˆå††å˜ä½å¤‰æ›ï¼‰
                var salesDiffRow = [stName, 'å£²ä¸Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
                var salesDiffTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var mqSales = stMqOutputs[m] ? (stMqOutputs[m].sales || 0) : 0;
                    var budgetSales = stAnnualData[4] ? (stAnnualData[4][m] || 0) : 0;
                    var diff = mqSales - budgetSales;
                    salesDiffTotal += diff;
                    salesDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff * 1000));
                }
                salesDiffRow.push((salesDiffTotal >= 0 ? '+' : '') + Math.round(salesDiffTotal * 1000), '-');
                csv.push(salesDiffRow.join(','));

                // é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Šï¼ˆNo.63 å–¶æ¥­åˆ©ç›Šï¼‰ï¼ˆå††å˜ä½å¤‰æ›ï¼‰
                var budgetProfitRow = [stName, 'é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Š'];
                var budgetProfitTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var val = stAnnualData[63] ? (stAnnualData[63][m] || 0) : 0;
                    budgetProfitTotal += val;
                    budgetProfitRow.push(Math.round(val * 1000));
                }
                budgetProfitRow.push(Math.round(budgetProfitTotal * 1000), Math.round(budgetProfitTotal * 1000 / stActiveMonths.length));
                csv.push(budgetProfitRow.join(','));

                // å–¶æ¥­åˆ©ç›Šå·®ç•°ï¼ˆå††å˜ä½å¤‰æ›ï¼‰
                var profitDiffRow = [stName, 'å–¶æ¥­åˆ©ç›Šå·®ç•°ï¼ˆMQ-äºˆç®—ï¼‰'];
                var profitDiffTotal = 0;
                for (var m = 0; m < stActiveMonths.length; m++) {
                    var mqProfit = stMqOutputs[m] ? (stMqOutputs[m].operatingProfit || 0) : 0;
                    var budgetProfit = stAnnualData[60] ? (stAnnualData[60][m] || 0) : 0;
                    var diff = mqProfit - budgetProfit;
                    profitDiffTotal += diff;
                    profitDiffRow.push((diff >= 0 ? '+' : '') + Math.round(diff * 1000));
                }
                profitDiffRow.push((profitDiffTotal >= 0 ? '+' : '') + Math.round(profitDiffTotal * 1000), '-');
                csv.push(profitDiffRow.join(','));
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            var filename = isMultiStore
                ? 'MQå‡ºåŠ›_å…¨' + targetStores.length + 'åº—èˆ—_' + new Date().toISOString().slice(0,10) + '.csv'
                : 'MQå‡ºåŠ›_' + targetStores[0] + '_' + new Date().toISOString().slice(0,10) + '.csv';

            var blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            // å±¥æ­´ã«è¿½åŠ 
            addToExportHistory('MQå‡ºåŠ›CSV', targetStores, BOM + csv.join('\n'));
            showStatus('success', 'MQå‡ºåŠ›CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆ' + targetStores.length + 'åº—èˆ—ï¼‰');
        }

        function importAllConfig(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var config = JSON.parse(e.target.result);
                    if (config.mapping) CUSTOMER_CODE_MAP = config.mapping;
                    if (config.calcRules) CALC_RULES = config.calcRules;
                    if (config.rakumyItems) RAKUMY_ITEMS = config.rakumyItems;
                    if (config.items) ITEMS = config.items;

                    // å…¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                    if (config.allStoresData) {
                        allStoresData = config.allStoresData;
                        updateStoreSelector();
                        renderAllStoresSummary();

                        var storeNames = Object.keys(allStoresData);
                        if (storeNames.length > 0) {
                            switchStore(storeNames[0]);
                        }
                        showStatus('success', 'è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ' + storeNames.length + 'åº—èˆ—ï¼‰');
                    } else {
                        showStatus('success', 'è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    }
                } catch (err) {
                    showStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importCSV() {
            var file = document.getElementById('csvFile').files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    preprocessLog = [];
                    addLog('CSVãƒ•ã‚¡ã‚¤ãƒ«: ' + file.name, 'info');
                    parseCustomerCSV(e.target.result);
                    document.getElementById('preprocessLog').innerHTML = preprocessLog.join('\n');
                    renderMappingTable();
                    renderUnmatchedItems();
                    renderMonthColsGrid();
                    showStatus('success', 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: ' + storeName + 'ï¼ˆ' + matchedItems.length + 'é …ç›®ãƒãƒƒãƒï¼‰');
                    runSimulation();
                } catch (err) {
                    addLog('ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
                    console.error(err);
                    document.getElementById('preprocessLog').innerHTML = preprocessLog.join('\n');
                    showStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCustomerCSV(csv) {
            var lines = csv.split(/\r?\n/).filter(function(l) { return l.trim(); });
            csvLines = lines; // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ä¿å­˜
            if (lines.length < 5) throw new Error('CSVã®è¡Œæ•°ãŒä¸è¶³');

            addLog('ç·è¡Œæ•°: ' + lines.length, 'info');

            // 1è¡Œç›®: åº—èˆ—æƒ…å ±
            var firstRow = parseCSVLine(lines[0]);
            storeName = '';
            for (var i = 1; i < Math.min(firstRow.length, 5); i++) {
                var cell = firstRow[i].trim();
                if (cell && cell.length > 0 && !/^\d+$/.test(cell)) {
                    storeName = cell;
                    break;
                }
            }
            if (!storeName) storeName = 'åº—èˆ—åä¸æ˜';
            document.getElementById('detectedStore').textContent = storeName;
            addLog('åº—èˆ—å: ' + storeName, 'success');

            // â˜… æœˆåˆ¥ã€Œäºˆç®—ã€åˆ—ã®æ­£ç¢ºãªæ¤œå‡º
            var budgetResults = detectBudgetColumns(lines);

            if (budgetResults.length === 0) throw new Error('æœˆã®ã€Œäºˆç®—ã€åˆ—ãŒæ¤œå‡ºã§ãã¾ã›ã‚“');

            // â˜… é‡è¤‡æ¤œå‡ºãƒã‚§ãƒƒã‚¯ - åŒã˜æœˆãŒè¤‡æ•°å›æ¤œå‡ºã•ã‚Œã¦ã„ãªã„ã‹
            addLog('', '');
            addLog('=== æœˆåˆ—é‡è¤‡ãƒã‚§ãƒƒã‚¯ ===', 'info');
            var monthCountMap = {};
            budgetResults.forEach(function(r) {
                monthCountMap[r.month] = (monthCountMap[r.month] || 0) + 1;
            });
            var hasDuplicates = false;
            for (var month in monthCountMap) {
                if (monthCountMap[month] > 1) {
                    addLog('âš ï¸ è­¦å‘Š: ã€Œ' + month + 'ã€ãŒ' + monthCountMap[month] + 'å›æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ï¼ˆæœ€åˆã®åˆ—ã®ã¿ä½¿ç”¨ï¼‰', 'warn');
                    hasDuplicates = true;
                }
            }
            if (!hasDuplicates) {
                addLog('âœ“ é‡è¤‡ãªã—ï¼ˆå„æœˆ1å›ãšã¤æ¤œå‡ºï¼‰', 'success');
            }

            // â˜… æ¤œå‡ºæœˆæ•°ãƒã‚§ãƒƒã‚¯
            if (budgetResults.length > 12) {
                addLog('âš ï¸ è­¦å‘Š: 12ãƒ¶æœˆä»¥ä¸Šã®åˆ—ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ï¼ˆ' + budgetResults.length + 'åˆ—ï¼‰ã€‚å››åŠæœŸã‚„ç´¯è¨ˆåˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
            }

            // â˜… å‰å¹´åº¦ãƒ‡ãƒ¼ã‚¿é™¤å¤–ãƒã‚§ãƒƒã‚¯ï¼ˆæš¦å¹´CSVã§1æœˆã€œ3æœˆãŒ4æœˆã‚ˆã‚Šå‰ã«ã‚ã‚‹å ´åˆï¼‰
            // 4æœˆã®åˆ—ç•ªå·ã‚’å–å¾—
            var aprilCol = -1;
            for (var ai = 0; ai < budgetResults.length; ai++) {
                if (budgetResults[ai].month === '4æœˆ') {
                    aprilCol = budgetResults[ai].budgetCol;
                    break;
                }
            }

            // 1æœˆã€œ3æœˆãŒ4æœˆã‚ˆã‚Šå·¦ï¼ˆå‰å¹´åº¦ãƒ‡ãƒ¼ã‚¿ï¼‰ã®å ´åˆã¯é™¤å¤–
            var excludedMonths = [];
            var filteredBudgetResults = [];
            if (aprilCol > 0) {
                for (var fi = 0; fi < budgetResults.length; fi++) {
                    var r = budgetResults[fi];
                    // 1æœˆã€œ3æœˆã§ã€4æœˆã‚ˆã‚Šå·¦ã«ã‚ã‚‹å ´åˆã¯å‰å¹´åº¦ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦é™¤å¤–
                    if ((r.month === '1æœˆ' || r.month === '2æœˆ' || r.month === '3æœˆ') && r.budgetCol < aprilCol) {
                        excludedMonths.push(r.month + '(åˆ—' + r.budgetCol + ')');
                    } else {
                        filteredBudgetResults.push(r);
                    }
                }
                if (excludedMonths.length > 0) {
                    addLog('', '');
                    addLog('=== å‰å¹´åº¦ãƒ‡ãƒ¼ã‚¿é™¤å¤– ===', 'warn');
                    addLog('âš ï¸ 4æœˆ(åˆ—' + aprilCol + ')ã‚ˆã‚Šå·¦ã«ã‚ã‚‹æœˆã‚’å‰å¹´åº¦ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦é™¤å¤–: ' + excludedMonths.join(', '), 'warn');
                    budgetResults = filteredBudgetResults;
                }
            }

            // ä¼šè¨ˆå¹´åº¦é †ã«ã‚½ãƒ¼ãƒˆ
            budgetColumnPositions = [];
            activeMonths = [];
            monthLabels = [];

            for (var j = 0; j < FISCAL_ORDER.length; j++) {
                var m = FISCAL_ORDER[j];
                for (var k = 0; k < budgetResults.length; k++) {
                    if (budgetResults[k].month === m) {
                        budgetColumnPositions.push(budgetResults[k]);
                        activeMonths.push(budgetColumnPositions.length - 1);
                        monthLabels.push(m);
                        break;
                    }
                }
            }

            addLog('', '');
            addLog('ä¼šè¨ˆå¹´åº¦é †: ' + monthLabels.join(' â†’ '), 'month');
            addLog('äºˆç®—åˆ—ä½ç½®: ' + budgetColumnPositions.map(function(p) { return p.month + ':åˆ—' + p.budgetCol; }).join(', '), 'data');

            // â˜… åˆ—ç•ªå·ã®é€£ç¶šæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå¤§ããªã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Šï¼‰
            var sortedCols = budgetColumnPositions.map(function(p) { return p.budgetCol; }).sort(function(a, b) { return a - b; });
            for (var ci = 1; ci < sortedCols.length; ci++) {
                var gap = sortedCols[ci] - sortedCols[ci - 1];
                if (gap > 10) {
                    addLog('âš ï¸ è­¦å‘Š: åˆ—' + sortedCols[ci - 1] + 'ã¨åˆ—' + sortedCols[ci] + 'ã®é–“ã«å¤§ããªã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚Šã¾ã™ï¼ˆ' + gap + 'åˆ—ï¼‰', 'warn');
                }
            }

            document.getElementById('detectedMonthCount').textContent = activeMonths.length + 'ãƒ¶æœˆ';

            // é …ç›®åæ¤œå‡ºç”¨ã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿åˆ—
            firstDataCol = Math.min.apply(null, budgetColumnPositions.map(function(p) { return p.budgetCol; }));
            addLog('é …ç›®åæ¤œç´¢ç¯„å›²: cols[0]ã€œcols[' + (firstDataCol - 1) + ']', 'info');

            // â˜… Eåˆ—ï¼ˆindex 4ï¼‰ã‚’åŸºæº–ã¨ã—ãŸå‹•çš„é …ç›®åæ¤œç´¢
            // ã‚»ãƒ«çµåˆè§£é™¤ã«ã‚ˆã‚Šé …ç›®åãŒå·¦ã‚·ãƒ•ãƒˆã—ã¦ã„ã‚‹å ´åˆã«å¯¾å¿œ
            var ITEM_NAME_COL = 4;  // Eåˆ—ãŒåŸºæº–ã®é …ç›®ååˆ—

            function findItemNameInRow(cols) {
                // Eåˆ— (index 4) ã‚’åŸºæº–ã«ã€å·¦ã‚·ãƒ•ãƒˆã‚’å‹•çš„ã«æ¤œå‡º
                // å„ªå…ˆé †ä½: Eåˆ— â†’ Dåˆ—ï¼ˆ1å·¦ã‚·ãƒ•ãƒˆï¼‰ â†’ Cåˆ—ï¼ˆ2å·¦ã‚·ãƒ•ãƒˆï¼‰ â†’ Båˆ—ï¼ˆ3å·¦ã‚·ãƒ•ãƒˆï¼‰

                var result = { name: '', col: -1, leftShift: 0, hierarchy: '', allNames: [] };

                // å…¨ã¦ã®åå‰å€™è£œåˆ—ã‚’åé›†ï¼ˆéšå±¤è¡¨ç¤ºç”¨ï¼‰
                for (var i = 0; i <= ITEM_NAME_COL && i < cols.length; i++) {
                    var val = cols[i] ? cols[i].trim() : '';
                    if (val && val.length > 0 && !isNumericOrEmpty(val)) {
                        result.allNames.push({ col: i, value: val });
                    }
                }

                // Eåˆ—ã‹ã‚‰å·¦æ–¹å‘ã«èµ°æŸ»ã—ã¦é …ç›®åã‚’æ¢ã™
                for (var col = ITEM_NAME_COL; col >= 0; col--) {
                    var cellValue = cols[col] ? cols[col].trim() : '';

                    // ç©ºã§ãªãã€æ•°å€¤ã§ã‚‚ãªãã€ã‚¨ãƒ©ãƒ¼å€¤ã§ã‚‚ãªã„å ´åˆã¯é …ç›®åã¨ã¿ãªã™
                    if (cellValue && cellValue.length > 0 && !isNumericOrEmpty(cellValue)) {
                        result.name = cellValue;
                        result.col = col;
                        result.leftShift = ITEM_NAME_COL - col;
                        result.hierarchy = result.allNames.map(function(n) { return n.value; }).join(' > ');
                        return result;
                    }
                }

                return result;
            }

            addLog('é …ç›®åæ¤œç´¢: Eåˆ—(index ' + ITEM_NAME_COL + ')åŸºæº–ã€å·¦ã‚·ãƒ•ãƒˆå¯¾å¿œ', 'info');

            // â˜… Phase 1: å…¨è¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€Œãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã€ï¼ˆé …ç›®åã‚ã‚Šã€å€¤ãªã—ï¼‰ã‚’åé›†
            // â€» é …ç›®åç¶™æ‰¿ç”¨ï¼ˆPhase 2ã§é …ç›®åãŒç©ºã®è¡Œã«å¯¾ã—ã¦ä½¿ç”¨ï¼‰
            addLog('', '');
            addLog('=== Phase 1: ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®åé›† ===', 'info');

            var headerRowNames = {}; // lineIdx -> itemName

            for (var lineIdx = 4; lineIdx < lines.length; lineIdx++) {
                var cols = parseCSVLine(lines[lineIdx]);
                if (cols.length < 3) continue;

                // Eåˆ—åŸºæº–ã®å‹•çš„é …ç›®åæ¤œç´¢ã‚’ä½¿ç”¨
                var nameResult = findItemNameInRow(cols);

                // ã‚³ãƒ¼ãƒ‰ãŒãªã„ã‹ã€äºˆç®—å€¤ãŒãªã„è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ã—ã¦ç™»éŒ²
                var hasCode = cols[0] && /^\d{6,}$/.test(cols[0].trim());
                var hasValue = false;
                for (var mi = 0; mi < budgetColumnPositions.length && !hasValue; mi++) {
                    var val = parseCustomNumber(cols[budgetColumnPositions[mi].budgetCol] || '');
                    if (val !== 0) hasValue = true;
                }

                if (nameResult.name && !hasCode && !hasValue) {
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼šã‚³ãƒ¼ãƒ‰ãªã—ã€å€¤ãªã—ã€é …ç›®åã‚ã‚Š
                    headerRowNames[lineIdx] = nameResult.name;
                    var shiftInfo = nameResult.leftShift > 0 ? ' (' + nameResult.leftShift + 'å·¦ã‚·ãƒ•ãƒˆ)' : '';
                    addLog('è¡Œ' + lineIdx + ': ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã€Œ' + nameResult.name + 'ã€' + shiftInfo, 'data');
                }
            }

            addLog('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: ' + Object.keys(headerRowNames).length + 'ä»¶', 'info');

            // â˜… Phase 2: ãƒ‡ãƒ¼ã‚¿è¡Œã®è§£æï¼ˆå…¨è¡Œã‚’é€£ç•ªã§å–ã‚Šè¾¼ã¿ï¼‰
            annualData = {};
            matchedItems = [];
            unmatchedItems = [];
            var displayIndex = 0;  // é€£ç•ªè¡¨ç¤ºç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå…¨è¡Œå¯¾è±¡ï¼‰

            addLog('', '');
            addLog('=== Phase 2: ãƒ‡ãƒ¼ã‚¿è¡Œã®è§£æï¼ˆã‚³ãƒ¼ãƒ‰ï¼‹é …ç›®åãƒ€ãƒ–ãƒ«ãƒãƒƒãƒãƒ³ã‚°ï¼‰===', 'info');

            // æœ€åˆã®10è¡Œã‚’è©³ç´°ãƒ‡ãƒãƒƒã‚°
            addLog('', '');
            addLog('=== ãƒ‡ãƒãƒƒã‚°: å…ˆé ­ãƒ‡ãƒ¼ã‚¿è¡Œã®è§£æ ===', 'info');

            var codeMatchCount = 0;
            var nameMatchCount = 0;
            var conflictCount = 0;  // ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨åå‰ãƒ™ãƒ¼ã‚¹ã®ç«¶åˆæ•°

            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç›£è¦–å¯¾è±¡ã®v17Noï¼ˆæ¬ è½ãŒå ±å‘Šã•ã‚Œã¦ã„ã‚‹é …ç›®ï¼‰
            var DEBUG_V17NOS = [1, 8, 9, 11, 12, 20];
            var debugMatches = {}; // v17No -> ãƒãƒƒãƒæƒ…å ±

            // ãƒ‡ãƒãƒƒã‚°ï¼šCODE_BASED_MAP/NAME_BASED_MAPã®ç¢ºèª
            addLog('', '');
            addLog('=== ã€DEBUGã€‘ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã®ç¢ºèª ===', 'info');
            addLog('CODE_BASED_MAP["810"] = ' + JSON.stringify(CODE_BASED_MAP['810'] || 'undefined'), 'data');
            addLog('CODE_BASED_MAP["2030"] = ' + JSON.stringify(CODE_BASED_MAP['2030'] || 'undefined'), 'data');
            addLog('CODE_BASED_MAP["2031"] = ' + JSON.stringify(CODE_BASED_MAP['2031'] || 'undefined'), 'data');
            addLog('CODE_BASED_MAP["503"] = ' + JSON.stringify(CODE_BASED_MAP['503'] || 'undefined'), 'data');
            addLog('NAME_BASED_MAP["é£ŸæåŸä¾¡"] = ' + JSON.stringify(NAME_BASED_MAP['é£ŸæåŸä¾¡'] || 'undefined'), 'data');
            addLog('NAME_BASED_MAP["ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡"] = ' + JSON.stringify(NAME_BASED_MAP['ãƒ‰ãƒªãƒ³ã‚¯åŸä¾¡'] || 'undefined'), 'data');

            for (var lineIdx = 4; lineIdx < lines.length; lineIdx++) {
                var cols = parseCSVLine(lines[lineIdx]);

                // æœ€åˆã®25è¡Œã¯å…¨ã¦è©³ç´°ãƒ­ã‚°å‡ºåŠ›
                if (lineIdx < 30) {
                    addLog('ã€RAWã€‘è¡Œ' + lineIdx + ': cols.length=' + cols.length + ', cols[0-4]=[' + cols.slice(0, 5).map(function(c) { return '"' + (c || '').substring(0, 12) + '"'; }).join(', ') + ']', 'data');
                }

                if (cols.length < 6) {
                    if (lineIdx < 30) {
                        addLog('ã€SKIPã€‘è¡Œ' + lineIdx + ': cols.length=' + cols.length + ' < 6', 'warn');
                    }
                    continue;
                }

                // â˜… Båˆ—ï¼ˆcols[1]ï¼‰ã‹ã‚‰å‹˜å®šç§‘ç›®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
                var accountCode = cols[1] ? cols[1].trim() : '';

                // â˜… Eåˆ—ã‚’åŸºæº–ã«é …ç›®åã‚’å‹•çš„æ¤œç´¢ï¼ˆå·¦ã‚·ãƒ•ãƒˆå¯¾å¿œï¼‰
                var nameResult = findItemNameInRow(cols);
                var itemName = nameResult.name;

                // æœ€åˆã®25è¡Œã¯å…¨ã¦è©³ç´°ãƒ­ã‚°å‡ºåŠ›
                if (lineIdx < 30) {
                    addLog('ã€PARSEã€‘è¡Œ' + lineIdx + ': code="' + accountCode + '", name="' + itemName + '" (col' + nameResult.col + ')', 'data');
                }

                // å…ˆé ­20è¡Œã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                if (lineIdx < 24) {
                    var debugCols = 'cols[0-4]: [' + cols.slice(0, 5).map(function(c) { return '"' + (c || '').substring(0, 10) + '"'; }).join(', ') + ']';
                    addLog('è¡Œ' + lineIdx + ': code=' + accountCode + ', ' + debugCols + ' â†’ é …ç›®å="' + itemName + '"', 'data');
                }

                // é …ç›®åãŒç©ºã®å ´åˆã€ç›´å‰1ã€œ3è¡Œã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‹ã‚‰ç¶™æ‰¿
                var inheritedFrom = '';
                if (!itemName) {
                    for (var lookBack = 1; lookBack <= 3 && lineIdx - lookBack >= 4; lookBack++) {
                        var prevLineIdx = lineIdx - lookBack;
                        if (headerRowNames[prevLineIdx]) {
                            itemName = headerRowNames[prevLineIdx];
                            inheritedFrom = '(ç¶™æ‰¿:è¡Œ' + prevLineIdx + ')';
                            break;
                        }
                    }
                }

                // â˜… ãƒ€ãƒ–ãƒ«ãƒãƒƒãƒãƒ³ã‚°: ã‚³ãƒ¼ãƒ‰å„ªå…ˆã€æ¬¡ã«é …ç›®åï¼ˆCåˆ—/Dåˆ—/Eåˆ—ï¼‰
                var hasValidCode = accountCode && /^\d+$/.test(accountCode);  // Båˆ—ãŒæ•°å­—ã‚³ãƒ¼ãƒ‰ã‹ã©ã†ã‹
                var codeMatch = hasValidCode ? findV17NoByCode(accountCode) : null;
                var nameMatch = findV17NoByName(itemName);

                // ãƒ‡ãƒãƒƒã‚°ï¼šæœ€åˆã®30è¡Œã¯å…¨ã¦ãƒ­ã‚°å‡ºåŠ›
                if (lineIdx < 35) {
                    var codeMatchInfo = codeMatch ? 'v17No=' + codeMatch.v17No : 'null';
                    var nameMatchInfo = nameMatch ? 'v17No=' + nameMatch.v17No : 'null';
                    addLog('ã€TRACEã€‘è¡Œ' + lineIdx + ': code="' + accountCode + '"â†’' + codeMatchInfo + ', name="' + itemName + '"â†’' + nameMatchInfo, 'data');
                }

                // â˜… ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨åå‰ãƒ™ãƒ¼ã‚¹ã®ç«¶åˆæ¤œå‡º
                if (codeMatch && nameMatch && codeMatch.v17No !== nameMatch.v17No) {
                    // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®å€¤ã‚’å–å¾—ï¼ˆè­¦å‘Šè¡¨ç¤ºç”¨ï¼‰
                    var sampleVal = parseCustomNumber(cols[budgetColumnPositions[0].budgetCol] || '');
                    addLog('âš ï¸ã€ç«¶åˆè­¦å‘Šã€‘è¡Œ' + lineIdx + ': ã‚³ãƒ¼ãƒ‰"' + accountCode + '"â†’v17No.' + codeMatch.v17No +
                           ' vs é …ç›®å"' + itemName + '"â†’v17No.' + nameMatch.v17No +
                           ' | å€¤=' + sampleVal + ' | åå‰ãƒ™ãƒ¼ã‚¹ã‚’æ¡ç”¨', 'warn');
                    // åˆè¨ˆå€¤ãƒ»è¨ˆç®—å€¤ã¯NAME_BASED_MAPã‚’å„ªå…ˆï¼ˆã‚³ãƒ¼ãƒ‰ã®å€¤ã¯ä¿¡é ¼æ€§ãŒä½ã„å ´åˆãŒã‚ã‚‹ï¼‰
                    codeMatch = null;  // ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒã‚’ç„¡åŠ¹åŒ–ã—ã¦åå‰ãƒãƒƒãƒã‚’æ¡ç”¨
                    conflictCount++;
                }

                // ãƒãƒƒãƒçµæœã‚’çµ±åˆï¼ˆåå‰å„ªå…ˆã«å¤‰æ›´ - åˆè¨ˆå€¤ãƒ»è¨ˆç®—å€¤å¯¾ç­–ï¼‰
                var finalMatch = null;
                var matchType = '';
                var matchSource = '';  // ãƒãƒƒãƒå…ƒã®åˆ—æƒ…å ±

                if (codeMatch) {
                    // Båˆ—ã®ã‚³ãƒ¼ãƒ‰ã§ãƒãƒƒãƒ
                    finalMatch = codeMatch;
                    matchType = 'code_based';
                    matchSource = 'Båˆ—ã‚³ãƒ¼ãƒ‰:' + accountCode;
                    codeMatchCount++;
                } else if (nameMatch) {
                    // ã‚³ãƒ¼ãƒ‰ãªã— â†’ Cåˆ—/Dåˆ—/Eåˆ—ã®é …ç›®åã§ãƒãƒƒãƒ
                    finalMatch = nameMatch;
                    matchType = 'name_based';
                    // ã©ã®åˆ—ã‹ã‚‰é …ç›®åã‚’å–å¾—ã—ãŸã‹
                    var colLetter = ['A', 'B', 'C', 'D', 'E'][nameResult.col] || '?';
                    matchSource = colLetter + 'åˆ—é …ç›®å';
                    nameMatchCount++;
                } else if (hasValidCode) {
                    // ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒå¤±æ•—æ™‚ï¼šCODE_BASED_MAPã«ãªã„ã‚³ãƒ¼ãƒ‰ã‚’è­¦å‘Š
                    addLog('ã€WARNã€‘è¡Œ' + lineIdx + ': ã‚³ãƒ¼ãƒ‰"' + accountCode + '"ã¯CODE_BASED_MAPã«æœªå®šç¾©', 'warn');
                }

                // ã‚³ãƒ¼ãƒ‰ã‚‚é …ç›®åã‚‚ãƒãƒƒãƒã—ãªã„å ´åˆ
                if (!finalMatch) {
                    // é …ç›®åã‚‚ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (!itemName) {
                        continue;
                    }
                    // æœªãƒãƒƒãƒã¨ã—ã¦è¨˜éŒ²
                    var hasValue = false;
                    var sampleValue = 0;
                    for (var mi = 0; mi < budgetColumnPositions.length; mi++) {
                        var val = parseCustomNumber(cols[budgetColumnPositions[mi].budgetCol] || '');
                        if (val !== 0) {
                            hasValue = true;
                            if (mi === 0) sampleValue = val;
                        }
                    }
                    var debugInfo = ' (code=' + accountCode + ', col=' + nameResult.col + ')';
                    if (hasValue) {
                        addLog('âš  è¡Œ' + lineIdx + ': ã€Œ' + itemName + 'ã€' + inheritedFrom + debugInfo + ' â†’ æœªå®šç¾©', 'warn');
                        unmatchedItems.push({
                            code: accountCode || 'NAME:' + itemName,
                            name: itemName + inheritedFrom,
                            sampleValue: sampleValue,
                            lineIdx: lineIdx
                        });
                    } else {
                        addLog('  è¡Œ' + lineIdx + ': ã€Œ' + itemName + 'ã€' + debugInfo + ' â†’ å€¤0ã€ã‚¹ã‚­ãƒƒãƒ—', 'data');
                    }
                    continue;
                }

                // ãƒãƒƒãƒæˆåŠŸ
                var v17No = finalMatch.v17No;
                var category = finalMatch.category;
                var matchedName = finalMatch.name || itemName;

                // â˜… CSVã‚«ãƒ†ã‚´ãƒªã¨ã®ãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆäºˆç®—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå½¢å¼å¯¾å¿œï¼‰
                var csvCategory = (cols[0] || '').trim();  // CSV Aåˆ—: äºˆç®—ã‚«ãƒ†ã‚´ãƒª
                if (csvCategory && BUDGET_CATEGORY_MAP[csvCategory]) {
                    // validateCategoryMappingã§æ¤œè¨¼
                    var validation = validateCategoryMapping(accountCode, itemName, csvCategory);
                    if (validation.warning) {
                        addLog('âš ï¸ã€ã‚«ãƒ†ã‚´ãƒªä¸ä¸€è‡´ã€‘è¡Œ' + lineIdx + ': ' + validation.warning, 'warn');
                    }
                    // CSVã‚«ãƒ†ã‚´ãƒªãŒæœ‰åŠ¹ãªå ´åˆã¯é …ç›®ã®budgetCategoryã‚’æ›´æ–°
                    if (CUSTOMER_CODE_MAP[accountCode]) {
                        CUSTOMER_CODE_MAP[accountCode].budgetCategory = csvCategory;
                    }
                }

                // ãƒ‡ãƒãƒƒã‚°ï¼šç›£è¦–å¯¾è±¡ã®v17NoãŒãƒãƒƒãƒã—ãŸã‹è¨˜éŒ²
                if (DEBUG_V17NOS.indexOf(v17No) >= 0) {
                    debugMatches[v17No] = {
                        lineIdx: lineIdx,
                        code: accountCode,
                        itemName: itemName,
                        matchType: matchType,
                        matchSource: matchSource
                    };
                    addLog('ã€DEBUGã€‘v17No.' + v17No + ' ãƒãƒƒãƒç™ºè¦‹: è¡Œ' + lineIdx + ', code=' + accountCode + ', name=' + itemName + ', type=' + matchType, 'success');
                }

                // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                var rowData = {};
                var hasValue = false;
                var firstValue = 0;

                for (var mi = 0; mi < budgetColumnPositions.length; mi++) {
                    var budgetCol = budgetColumnPositions[mi].budgetCol;
                    var rawValue = cols[budgetCol] || '';
                    var value = parseCustomNumber(rawValue);
                    if (value !== 0) {
                        hasValue = true;
                        if (firstValue === 0) firstValue = value;
                    }
                    rowData[mi] = value;
                    // â˜… annualDataã¸ã®æ ¼ç´ã¯é‡è¤‡ãƒã‚§ãƒƒã‚¯å¾Œã«è¡Œã†ï¼ˆã“ã“ã§ã¯è¡Œã‚ãªã„ï¼‰
                }

                // â˜… å€¤ãŒãªã„é …ç›®ï¼ˆ#DIV/0!ã‚„ç©ºã‚»ãƒ«ãªã©ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
                // ãŸã ã—ã€ç›£è¦–å¯¾è±¡v17Noã¯0å€¤ã§ã‚‚è¨˜éŒ²ã™ã‚‹ï¼ˆå·®ç•°åˆ†æã®ãŸã‚ï¼‰
                var watchV17Nos = [1, 8, 9, 11, 12, 20];
                if (!hasValue && watchV17Nos.indexOf(v17No) < 0) {
                    addLog('  è¡Œ' + lineIdx + ': ã€Œ' + matchedName + 'ã€â†’ v17No.' + v17No + ' ãƒãƒƒãƒã™ã‚‹ã‚‚å€¤0ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¨ˆç®—é …ç›®ï¼‰', 'data');
                    continue;
                }
                if (!hasValue && watchV17Nos.indexOf(v17No) >= 0) {
                    addLog('  è¡Œ' + lineIdx + ': ã€Œ' + matchedName + 'ã€â†’ v17No.' + v17No + ' å€¤0ã ãŒç›£è¦–å¯¾è±¡ã®ãŸã‚è¨˜éŒ²', 'warn');
                }

                // â˜… å…¨è¡Œã‚’é€£ç•ªã§ç™»éŒ²
                displayIndex++;

                // å·¦ã‚·ãƒ•ãƒˆè¡¨ç¤ºï¼ˆEåˆ—åŸºæº–ï¼‰
                var positionLabel = '';
                if (nameResult.leftShift === 1) {
                    positionLabel = '[1å·¦ã‚·ãƒ•ãƒˆ:Dåˆ—]';
                } else if (nameResult.leftShift === 2) {
                    positionLabel = '[2å·¦ã‚·ãƒ•ãƒˆ:Cåˆ—]';
                } else if (nameResult.leftShift >= 3) {
                    positionLabel = '[' + nameResult.leftShift + 'å·¦ã‚·ãƒ•ãƒˆ]';
                }

                // ãƒãƒƒãƒã‚¿ã‚¤ãƒ—è¡¨ç¤ºï¼ˆã©ã®åˆ—ã‹ã‚‰ãƒãƒƒãƒã—ãŸã‹æ˜ç¤ºï¼‰
                var matchLabel = '[' + matchSource + ']';
                // â˜… åŒä¸€v17Noã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒå„ªå…ˆï¼‰
                var existingIdx = -1;
                for (var ei = 0; ei < matchedItems.length; ei++) {
                    if (matchedItems[ei].v15No === v17No) {
                        existingIdx = ei;
                        break;
                    }
                }

                if (existingIdx >= 0) {
                    var existing = matchedItems[existingIdx];
                    // æ—¢å­˜ãŒname_basedã§ä»Šå›ãŒcode_basedãªã‚‰ç½®ãæ›ãˆ
                    if (existing.matchType === 'name_based' && matchType === 'code_based') {
                        addLog('  è¡Œ' + lineIdx + ': v17No.' + v17No + ' æ—¢å­˜ã®é …ç›®åãƒãƒƒãƒã‚’ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒã§ä¸Šæ›¸ã', 'data');
                        // â˜… annualDataã‹ã‚‰æ—¢å­˜ã®å€¤ã‚’æ¸›ç®—ï¼ˆç½®ãæ›ãˆã®ãŸã‚ï¼‰
                        if (annualData[v17No] && existing.rowData) {
                            for (var rmi = 0; rmi < budgetColumnPositions.length; rmi++) {
                                var oldValue = existing.rowData[rmi] || 0;
                                annualData[v17No][rmi] = (annualData[v17No][rmi] || 0) - oldValue;
                            }
                        }
                        // ç½®ãæ›ãˆå‡¦ç†ã¯ä¸‹ã§è¡Œã†
                    } else {
                        // ãã‚Œä»¥å¤–ã¯é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—ï¼ˆannualDataã«ã‚‚è¿½åŠ ã—ãªã„ï¼‰
                        addLog('  è¡Œ' + lineIdx + ': ã€Œ' + matchedName + 'ã€â†’ v17No.' + v17No + ' é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢å­˜: ' + existing.name + 'ï¼‰', 'data');
                        continue;
                    }
                }

                addLog('â˜… [' + displayIndex + '] è¡Œ' + lineIdx + ': ã€Œ' + matchedName + 'ã€' + positionLabel + ' ' + matchLabel + ' â†’ v17No.' + v17No + ' (' + category + ') åˆæœˆå€¤=' + firstValue, 'success');

                // â˜… annualDataã«æ ¼ç´ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯é€šéå¾Œã®ã¿ï¼‰
                for (var ami = 0; ami < budgetColumnPositions.length; ami++) {
                    annualData[v17No] = annualData[v17No] || {};
                    annualData[v17No][ami] = (annualData[v17No][ami] || 0) + rowData[ami];
                }

                // budgetCategoryã¨sortOrderã‚’å–å¾—ï¼ˆCSVã‚«ãƒ†ã‚´ãƒªã¾ãŸã¯ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã‹ã‚‰ï¼‰
                var itemBudgetCategory = csvCategory || (CUSTOMER_CODE_MAP[accountCode] ? CUSTOMER_CODE_MAP[accountCode].budgetCategory : category);
                var itemSortOrder = CUSTOMER_CODE_MAP[accountCode] ? (CUSTOMER_CODE_MAP[accountCode].sortOrder || 0) : 0;

                var newItem = {
                    displayIndex: displayIndex,  // é€£ç•ªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                    lineIdx: lineIdx,            // å…ƒCSVè¡Œç•ªå·
                    code: accountCode || 'NAME:' + itemName,
                    name: matchedName,
                    hierarchy: nameResult.hierarchy || (category + ' > ' + matchedName),
                    v15No: v17No,
                    v15Name: ITEMS[v17No] ? ITEMS[v17No].name : matchedName,
                    category: category,
                    budgetCategory: itemBudgetCategory,  // â˜… äºˆç®—ã‚«ãƒ†ã‚´ãƒªï¼ˆè¡¨ç¤ºé †åˆ¶å¾¡ç”¨ï¼‰
                    sortOrder: itemSortOrder,            // â˜… ã‚«ãƒ†ã‚´ãƒªå†…è¡¨ç¤ºé †
                    matchType: matchType,
                    sampleValue: firstValue,
                    hasValue: hasValue,
                    rowData: rowData  // ã“ã®è¡Œã®æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿
                };

                // æ—¢å­˜ã‚¨ãƒ³ãƒˆãƒªã®ç½®ãæ›ãˆ or æ–°è¦è¿½åŠ 
                if (existingIdx >= 0) {
                    matchedItems[existingIdx] = newItem;
                } else {
                    matchedItems.push(newItem);
                }

                // ç›£è¦–å¯¾è±¡v17Noã®å ´åˆã€è¿½åŠ ç¢ºèªãƒ­ã‚°
                if (DEBUG_V17NOS.indexOf(v17No) >= 0) {
                    addLog('ã€PUSHç¢ºèªã€‘v17No.' + v17No + ' ã‚’ matchedItems[' + (matchedItems.length - 1) + '] ã«è¿½åŠ å®Œäº†', 'success');
                }
            }

            // â˜… ç¤¾å“¡çµ¦ä¸(v17No.18)ã¨çµ¦æ–™æ‰‹å½“(v17No.16)ã®å„ªå…ˆåˆ¶å¾¡
            // ä¸¡æ–¹å­˜åœ¨ã™ã‚‹å ´åˆã€ç¤¾å“¡çµ¦ä¸ã‚’å„ªå…ˆã—çµ¦æ–™æ‰‹å½“ã‚’å‰Šé™¤ï¼ˆäºŒé‡è¨ˆä¸Šé˜²æ­¢ï¼‰
            var hasNo16 = false, hasNo18 = false;
            var no16Idx = -1;
            for (var pi = 0; pi < matchedItems.length; pi++) {
                if (matchedItems[pi].v15No === 16) { hasNo16 = true; no16Idx = pi; }
                if (matchedItems[pi].v15No === 18) { hasNo18 = true; }
            }
            if (hasNo16 && hasNo18) {
                addLog('', '');
                addLog('â˜… é‡è¤‡äººä»¶è²»ã®å„ªå…ˆåˆ¶å¾¡ â˜…', 'info');
                addLog('  ç¤¾å“¡çµ¦ä¸(v17No.18)ã¨çµ¦æ–™æ‰‹å½“(v17No.16)ãŒä¸¡æ–¹å­˜åœ¨', 'info');
                addLog('  â†’ çµ¦æ–™æ‰‹å½“ã‚’å‰Šé™¤ï¼ˆç¤¾å“¡çµ¦ä¸ã‚’å„ªå…ˆï¼‰', 'info');
                matchedItems.splice(no16Idx, 1);
                // annualDataã‹ã‚‰ã‚‚å‰Šé™¤
                delete annualData[16];
            }

            // å‡¦ç†çµæœã‚µãƒãƒªãƒ¼
            addLog('', '');
            addLog('=== å‡¦ç†çµæœã‚µãƒãƒªãƒ¼ ===', 'info');
            addLog('ç·ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ' + (lines.length - 4) + 'è¡Œ', 'info');
            addLog('ãƒãƒƒãƒæˆåŠŸ: ' + matchedItems.length + 'è¡Œ', 'success');
            addLog('  â”œ ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ (Båˆ—): ' + codeMatchCount + 'è¡Œ', 'success');
            addLog('  â”” é …ç›®åãƒãƒƒãƒ (C/D/Eåˆ—): ' + nameMatchCount + 'è¡Œ', 'success');
            if (conflictCount > 0) {
                addLog('âš ï¸ ç«¶åˆæ¤œå‡ºï¼ˆåå‰ãƒ™ãƒ¼ã‚¹æ¡ç”¨ï¼‰: ' + conflictCount + 'ä»¶', 'warn');
            }
            addLog('ãƒãƒƒãƒ”ãƒ³ã‚°æœªå®šç¾©: ' + unmatchedItems.length + 'è¡Œ', 'warn');

            // æœªãƒãƒƒãƒé …ç›®ã®è©³ç´°
            if (unmatchedItems.length > 0) {
                addLog('', '');
                addLog('--- æœªãƒãƒƒãƒé …ç›®ä¸€è¦§ï¼ˆCODE_BASED_MAP/NAME_BASED_MAPã«è¿½åŠ ãŒå¿…è¦ï¼‰---', 'warn');
                unmatchedItems.forEach(function(item) {
                    addLog('  ã€Œ' + item.name + 'ã€(code=' + item.code + ', è¡Œ' + item.lineIdx + ', å€¤=' + item.sampleValue + ')', 'warn');
                });
            }

            // ãƒãƒƒãƒã—ãŸv17Noã®ä¸€è¦§
            var matchedV17Nos = matchedItems.map(function(item) { return item.v15No; });
            var uniqueV17Nos = matchedV17Nos.filter(function(v, i, a) { return a.indexOf(v) === i; }).sort(function(a, b) { return a - b; });
            addLog('', '');
            addLog('ä½¿ç”¨v17Noä¸€è¦§: [' + uniqueV17Nos.join(', ') + ']ï¼ˆ' + uniqueV17Nos.length + 'ç¨®é¡ï¼‰', 'info');

            // ãƒ‡ãƒãƒƒã‚°ï¼šç›£è¦–å¯¾è±¡v17Noã®ãƒãƒƒãƒçŠ¶æ³ã‚µãƒãƒªãƒ¼
            addLog('', '');
            addLog('=== ã€DEBUGã€‘ç›£è¦–å¯¾è±¡v17Noã®ãƒãƒƒãƒçŠ¶æ³ ===', 'info');
            DEBUG_V17NOS.forEach(function(v17) {
                if (debugMatches[v17]) {
                    var m = debugMatches[v17];
                    addLog('âœ“ v17No.' + v17 + ': ãƒãƒƒãƒæˆåŠŸï¼ˆè¡Œ' + m.lineIdx + ', code=' + m.code + ', ' + m.matchType + 'ï¼‰', 'success');
                } else {
                    // ãƒãƒƒãƒã—ãªã‹ã£ãŸç†ç”±ã‚’èª¿æŸ»
                    var expectedCode = null;
                    var expectedName = null;
                    for (var code in CODE_BASED_MAP) {
                        if (CODE_BASED_MAP[code].v17No === v17) {
                            expectedCode = code;
                            break;
                        }
                    }
                    for (var name in NAME_BASED_MAP) {
                        if (NAME_BASED_MAP[name].v17No === v17) {
                            expectedName = name;
                            break;
                        }
                    }
                    addLog('âœ— v17No.' + v17 + ': ãƒãƒƒãƒãªã—ï¼ˆæœŸå¾…ã‚³ãƒ¼ãƒ‰=' + expectedCode + ', æœŸå¾…é …ç›®å=' + expectedName + 'ï¼‰', 'warn');
                }
            });

            document.getElementById('detectedItemCount').textContent = matchedItems.length + 'è¡Œ';
            document.getElementById('unmatchedCount').textContent = unmatchedItems.length + 'è¡Œ';

            // â˜… æœ€çµ‚ç¢ºèªï¼šmatchedItemsã®å…¨å†…å®¹ã‚’ãƒ­ã‚°å‡ºåŠ›
            addLog('', '');
            addLog('=== ã€æœ€çµ‚ç¢ºèªã€‘matchedItemsé…åˆ—ã®å†…å®¹ï¼ˆãƒ‘ãƒ¼ã‚¹å®Œäº†æ™‚ç‚¹ï¼‰===', 'info');
            addLog('é…åˆ—é•·: ' + matchedItems.length + 'ä»¶', 'info');

            // v15Noåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
            var v15NoMap = {};
            matchedItems.forEach(function(item) {
                var key = item.v15No || 'undefined';
                if (!v15NoMap[key]) v15NoMap[key] = [];
                v15NoMap[key].push(item.name);
            });

            var sortedV15Nos = Object.keys(v15NoMap).map(function(k) { return parseInt(k) || 0; }).sort(function(a,b) { return a-b; });
            sortedV15Nos.forEach(function(v15No) {
                var names = v15NoMap[v15No];
                addLog('  v17No.' + v15No + ': ' + names.join(', '), 'data');
            });

            // ç›£è¦–å¯¾è±¡ãƒã‚§ãƒƒã‚¯
            var watchV15Nos = [1, 8, 9, 11, 12, 20];
            var presentWatch = watchV15Nos.filter(function(n) { return v15NoMap[n]; });
            var missingWatch = watchV15Nos.filter(function(n) { return !v15NoMap[n]; });
            addLog('', '');
            addLog('ç›£è¦–å¯¾è±¡v17Noå­˜åœ¨ç¢ºèª:', 'info');
            addLog('  å­˜åœ¨: [' + presentWatch.join(', ') + ']', presentWatch.length > 0 ? 'success' : 'warn');
            if (missingWatch.length > 0) {
                addLog('  æ¬ è½: [' + missingWatch.join(', ') + '] â† ã“ã“ã«å•é¡Œã‚ã‚Šï¼', 'error');
            } else {
                addLog('  æ¬ è½: ãªã—ï¼ˆå…¨ã¦å­˜åœ¨ï¼‰', 'success');
            }
        }

        // ================== ã“ã“ã‹ã‚‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç† ==================

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function runSimulation() {
            if (activeMonths.length === 0) return;
            executeCalcRules();
            judgeSettings();
            generateRakumyInputs();
            runMQSimulation();
            renderAllTables();
            showStatus('success', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†');
        }

        function executeCalcRules() {
            calcResults = {};
            for (var m = 0; m < activeMonths.length; m++) {
                calcResults[m] = {};
                for (var iter = 0; iter < 3; iter++) {
                    for (var ruleName in CALC_RULES) {
                        var rule = CALC_RULES[ruleName];
                        try {
                            calcResults[m][ruleName] = evaluateRule(rule, m);
                        } catch (e) {}
                    }
                }
            }

            // â˜… å–¶æ¥­åˆ©ç›Šï¼ˆNo.63ï¼‰ã®å–ã‚Šè¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯
            // æ–¹æ³•1ï¼ˆå„ªå…ˆï¼‰: NAME_BASED_MAPçµŒç”±ã§CSVã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            // æ–¹æ³•2ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰: CALC_RULESçµŒç”±ã§è¨ˆç®—ï¼ˆåº—èˆ—å–¶æ¥­åˆ©ç›Š - è²©å£²ç®¡ç†è²»åˆè¨ˆï¼‰
            // â€» ã‚³ãƒ¼ãƒ‰9640ã¯ä¸æ­£ç¢ºãªå€¤ã®ãŸã‚å‰Šé™¤æ¸ˆã¿
            var hasNo63FromCSV = annualData[63] && activeMonths.some(function(m) {
                return annualData[63][m] !== undefined && annualData[63][m] !== null && annualData[63][m] !== 0;
            });

            if (hasNo63FromCSV) {
                // æ–¹æ³•1: NAME_BASED_MAPã§CSVã‹ã‚‰ç›´æ¥å–ã‚Šè¾¼ã¿æ¸ˆã¿
                console.log('ã€å–¶æ¥­åˆ©ç›Š No.63ã€‘æ–¹æ³•1æ¡ç”¨: NAME_BASED_MAPã§CSVã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
                console.log('  ã‚¤ãƒ³ãƒãƒ¼ãƒˆå€¤:', JSON.stringify(annualData[63]));
                addLog('âœ… å–¶æ¥­åˆ©ç›Š(No.63): NAME_BASED_MAPã§æ­£å¸¸ã«ãƒãƒƒãƒ”ãƒ³ã‚°', 'success');
            } else if (calcResults[0] && calcResults[0]['å–¶æ¥­åˆ©ç›Š'] !== undefined) {
                // æ–¹æ³•2: è¨ˆç®—ã§ç”Ÿæˆï¼ˆCSVã«ã€Œå–¶æ¥­åˆ©ç›Šã€è¡ŒãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                if (!annualData[63]) annualData[63] = {};
                for (var m = 0; m < activeMonths.length; m++) {
                    var calcValue = calcResults[m]['å–¶æ¥­åˆ©ç›Š'] || 0;
                    annualData[63][m] = calcValue;
                }
                console.log('ã€å–¶æ¥­åˆ©ç›Š No.63ã€‘æ–¹æ³•2æ¡ç”¨: è¨ˆç®—ã§ç”Ÿæˆï¼ˆCALC_RULESçµŒç”±ï¼‰');
                console.log('  è¨ˆç®—å¼: åº—èˆ—å–¶æ¥­åˆ©ç›Š(No.61) - è²©å£²ç®¡ç†è²»åˆè¨ˆ(No.62)');
                console.log('  è¨ˆç®—çµæœ:', JSON.stringify(annualData[63]));
                addLog('âš ï¸ å–¶æ¥­åˆ©ç›Š(No.63): CSVã«ã€Œå–¶æ¥­åˆ©ç›Šã€è¡Œãªã—â†’è¨ˆç®—ã§ç”Ÿæˆ', 'warn');
            }

            // â˜…â˜…â˜… å–¶æ¥­åˆ©ç›Šãƒˆãƒªãƒ—ãƒ«ãƒã‚§ãƒƒã‚¯ â˜…â˜…â˜…
            addLog('', '');
            addLog('=== å–¶æ¥­åˆ©ç›Šãƒˆãƒªãƒ—ãƒ«ãƒã‚§ãƒƒã‚¯ ===', 'info');

            // ãƒã‚§ãƒƒã‚¯1: NAME_BASED_MAPã§ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚ŒãŸã‹
            var check1Pass = hasNo63FromCSV;
            addLog('â‘  NAME_BASED_MAPãƒãƒƒãƒ”ãƒ³ã‚°: ' + (check1Pass ? 'âœ… OK' : 'âš ï¸ è¨ˆç®—ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯'), check1Pass ? 'success' : 'warn');

            // ãƒã‚§ãƒƒã‚¯2: ã‚³ãƒ¼ãƒ‰9640ãŒæ¤œå‡ºã•ã‚ŒãŸã‹è­¦å‘Š
            var code9640Detected = false;
            for (var ci = 0; ci < csvLines.length; ci++) {
                var checkCols = csvLines[ci].split(',');
                for (var cj = 0; cj < Math.min(5, checkCols.length); cj++) {
                    var checkVal = checkCols[cj] ? checkCols[cj].trim() : '';
                    if (checkVal === '9640' || checkVal === "'9640" || checkVal === '"9640"') {
                        code9640Detected = true;
                        break;
                    }
                }
                if (code9640Detected) break;
            }
            if (code9640Detected) {
                addLog('â‘¡ ã‚³ãƒ¼ãƒ‰9640æ¤œå‡º: âš ï¸ è­¦å‘Š - CSVã«9640ãŒå­˜åœ¨ã—ã¾ã™ï¼ˆå€¤ã¯ç„¡è¦–ã•ã‚ŒNAME_BASED_MAPå„ªå…ˆï¼‰', 'warn');
            } else {
                addLog('â‘¡ ã‚³ãƒ¼ãƒ‰9640æ¤œå‡º: âœ… OKï¼ˆCSVã«9640ãªã—ï¼‰', 'success');
            }

            // ãƒã‚§ãƒƒã‚¯3: è¨ˆç®—æ¤œè¨¼ï¼ˆåº—èˆ—å–¶æ¥­åˆ©ç›Š - è²©å£²ç®¡ç†è²»åˆè¨ˆ = å–¶æ¥­åˆ©ç›Šï¼‰
            var check3Pass = true;
            var calcMismatches = [];
            if (annualData[61] && annualData[62] && annualData[63]) {
                for (var vm = 0; vm < activeMonths.length; vm++) {
                    var item61 = annualData[61][vm] || 0;  // åº—èˆ—å–¶æ¥­åˆ©ç›Š
                    var item62 = annualData[62][vm] || 0;  // è²©å£²ç®¡ç†è²»åˆè¨ˆ
                    var item63 = annualData[63][vm] || 0;  // å–¶æ¥­åˆ©ç›Š
                    var calcProfit = item61 - item62;
                    var diff = Math.abs(item63 - calcProfit);
                    // 1000å††ä»¥ä¸Šã®å·®ç•°ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Š
                    if (diff > 1000) {
                        check3Pass = false;
                        calcMismatches.push({
                            month: monthLabels[vm],
                            item61: item61,
                            item62: item62,
                            item63: item63,
                            calc: calcProfit,
                            diff: diff
                        });
                    }
                }
            } else {
                check3Pass = false;
                addLog('â‘¢ è¨ˆç®—æ¤œè¨¼: âš ï¸ è­¦å‘Š - No.61/62/63ã®ã„ãšã‚Œã‹ãŒå–å¾—ã§ãã¾ã›ã‚“', 'warn');
            }

            if (check3Pass) {
                addLog('â‘¢ è¨ˆç®—æ¤œè¨¼: âœ… OKï¼ˆåº—èˆ—å–¶æ¥­åˆ©ç›Š - è²©å£²ç®¡ç†è²»åˆè¨ˆ â‰’ å–¶æ¥­åˆ©ç›Šï¼‰', 'success');
            } else if (calcMismatches.length > 0) {
                addLog('â‘¢ è¨ˆç®—æ¤œè¨¼: âš ï¸ å·®ç•°ã‚ã‚Šï¼ˆé¡§å®¢äºˆç®—è¡¨ã®ã‚³ãƒ¼ãƒ‰èª¤ã‚Šã®å¯èƒ½æ€§ï¼‰', 'warn');
                for (var mi = 0; mi < calcMismatches.length; mi++) {
                    var mm = calcMismatches[mi];
                    addLog('   ' + mm.month + ': åº—èˆ—å–¶æ¥­åˆ©ç›Š(' + mm.item61 + ') - è²©å£²ç®¡ç†è²»(' + mm.item62 + ') = ' + mm.calc + ' â‰  å–¶æ¥­åˆ©ç›Š(' + mm.item63 + ') [å·®ç•°: ' + mm.diff + ']', 'warn');
                }
                addLog('   â†’ NAME_BASED_MAPã®å€¤ã‚’æ¡ç”¨ï¼ˆã‚³ãƒ¼ãƒ‰9640ã®èª¤ãƒãƒƒãƒ”ãƒ³ã‚°å¯¾ç­–ï¼‰', 'info');
            }

            // ç·åˆåˆ¤å®š
            var allPass = check1Pass && !code9640Detected && check3Pass;
            addLog('', '');
            if (allPass) {
                addLog('ã€å–¶æ¥­åˆ©ç›Šãƒˆãƒªãƒ—ãƒ«ãƒã‚§ãƒƒã‚¯çµæœã€‘âœ… ã™ã¹ã¦OK', 'success');
            } else {
                addLog('ã€å–¶æ¥­åˆ©ç›Šãƒˆãƒªãƒ—ãƒ«ãƒã‚§ãƒƒã‚¯çµæœã€‘âš ï¸ ä¸€éƒ¨è­¦å‘Šã‚ã‚Šï¼ˆNAME_BASED_MAPã®å€¤ã‚’æ¡ç”¨ï¼‰', 'warn');
            }
        }

        function evaluateRule(rule, mi) {
            var get = function(no) { return annualData[no] ? (annualData[no][mi] || 0) : 0; };
            if (rule.type === 'sum') {
                var sum = 0;
                for (var i = 0; i < rule.items.length; i++) sum += get(rule.items[i]);
                return sum;
            } else if (rule.type === 'rate') {
                var num = parseSourceValue(rule.numerator, mi);
                var denom = parseSourceValue(rule.denominator, mi);
                return denom > 0 ? (num / denom * 100) : 0;
            } else if (rule.type === 'diff') {
                // æ¸›ç®—ã‚¿ã‚¤ãƒ—: minuend - subtrahendï¼ˆå–¶æ¥­åˆ©ç›Š = åº—èˆ—å–¶æ¥­åˆ©ç›Š - è²©å£²ç®¡ç†è²»åˆè¨ˆ ãªã©ï¼‰
                var minuend = parseSourceValue(rule.minuend, mi);
                var subtrahend = parseSourceValue(rule.subtrahend, mi);
                return minuend - subtrahend;
            } else if (rule.type === 'default') {
                return rule.value || 0;
            }
            return 0;
        }

        function parseSourceValue(source, mi) {
            if (typeof source === 'string') {
                if (source.startsWith('item:')) {
                    var no = parseInt(source.substring(5));
                    return annualData[no] ? (annualData[no][mi] || 0) : 0;
                }
                return calcResults[mi][source] || 0;
            }
            return 0;
        }

        function judgeSettings() {
            judgments = {};
            [10, 15, 16, 17, 18, 19, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50].forEach(function(itemNo) {
                var values = activeMonths.map(function(mi) { return annualData[itemNo] ? (annualData[itemNo][mi] || 0) : 0; });
                var allSame = values.every(function(v) { return Math.abs(v - values[0]) < 0.01; });
                judgments[itemNo] = { isAnnual: allSame };
            });
        }

        // â˜… ãƒ©ã‚¯ãƒŸãƒ¼å…¥åŠ›å€¤ã®ç”Ÿæˆï¼ˆå¤‰æ›ã‚¿ã‚¤ãƒ—ã‚’æ˜ç¤ºï¼‰
        // transformType: 'direct'=ç›´æ¥è»¢è¨˜, 'sum'=åˆè¨ˆ, 'rate'=ç‡è¨ˆç®—, 'calc'=é€†ç®—
        // category: 'cost'=è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰, 'budget'=äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰, 'monthly'=å˜æœˆè²»ç”¨äºˆç®—
        var RAKUMY_ITEMS = {
            // === è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- 29é …ç›®ã™ã¹ã¦ ===
            // â˜… v17 ITEMSç•ªå·ã«ä¿®æ­£æ¸ˆã¿ï¼ˆ2026/01/01ï¼‰
            rent: { name: 'åœ°ä»£å®¶è³ƒ', source: 'calc:åœ°ä»£å®¶è³ƒåˆè¨ˆ', type: 'sum', category: 'cost', desc: 'å®¶è³ƒ+è³ƒå€Ÿæ–™' },
            fixedLabor: { name: 'å›ºå®šäººä»¶è²»', source: 'calc:å›ºå®šäººä»¶è²»åˆè¨ˆ', type: 'sum', category: 'cost', desc: 'çµ¦æ–™+æ³•å®šç¦åˆ©+é€šå‹¤+è³ä¸+ç¤¾å®…+ä¼‘æ¥­' },
            depreciation: { name: 'æ¸›ä¾¡å„Ÿå´è²»', source: 'item:55', type: 'direct', category: 'cost', desc: '' },
            material: { name: 'è³‡æè²»', source: 'calc:è³‡æè²»åˆè¨ˆ', type: 'sum', category: 'cost', desc: 'è­¦å‚™æ–™+ãƒªãƒ¼ã‚¹æ–™' },
            promotion: { name: 'è²©å£²ä¿ƒé€²è²»', source: 'item:27', type: 'direct', category: 'cost', desc: '' },
            menuCopy: { name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', source: 'item:28', type: 'direct', category: 'cost', desc: '' },
            survey: { name: 'èª¿æŸ»è²»', source: 'item:29', type: 'direct', category: 'cost', desc: '' },
            sanitary: { name: 'è¡›ç”Ÿè²»', source: 'item:30', type: 'direct', category: 'cost', desc: '' },
            service: { name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', source: 'item:31', type: 'direct', category: 'cost', desc: '' },
            electricity: { name: 'é›»æ°—ä»£', source: 'item:32', type: 'direct', category: 'cost', desc: '' },
            gas: { name: 'ã‚¬ã‚¹ä»£', source: 'item:33', type: 'direct', category: 'cost', desc: '' },
            water: { name: 'æ°´é“ä»£', source: 'item:34', type: 'direct', category: 'cost', desc: '' },
            consumables: { name: 'æ¶ˆè€—å“è²»', source: 'item:35', type: 'direct', category: 'cost', desc: '' },
            maintenance: { name: 'ä¿å®ˆä¿®ç¹•è²»', source: 'item:36', type: 'direct', category: 'cost', desc: '' },
            taxes: { name: 'ç§Ÿç¨å…¬èª²', source: 'item:37', type: 'direct', category: 'cost', desc: '' },
            entertainment: { name: 'æ¥å¾…äº¤éš›è²»', source: 'item:38', type: 'direct', category: 'cost', desc: '' },
            travel: { name: 'æ—…è²»äº¤é€šè²»', source: 'item:39', type: 'direct', category: 'cost', desc: '' },
            communication: { name: 'é€šä¿¡è²»', source: 'item:40', type: 'direct', category: 'cost', desc: '' },
            creditFee: { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', source: 'item:41', type: 'direct', category: 'cost', desc: '' },
            paymentFee: { name: 'æ”¯æ‰•æ‰‹æ•°æ–™', source: 'item:42', type: 'direct', category: 'cost', desc: '' },
            meeting: { name: 'ä¼šè­°è²»', source: 'item:43', type: 'direct', category: 'cost', desc: '' },
            membership: { name: 'è«¸ä¼šè²»', source: 'item:44', type: 'direct', category: 'cost', desc: '' },
            education: { name: 'å›³æ›¸æ•™è‚²è²»', source: 'item:45', type: 'direct', category: 'cost', desc: '' },
            training: { name: 'ç ”ä¿®è²»', source: 'item:46', type: 'direct', category: 'cost', desc: '' },
            research: { name: 'æ¥­æ…‹ç ”ç©¶è²»', source: 'item:47', type: 'direct', category: 'cost', desc: '' },
            recruitment: { name: 'æ¡ç”¨è²»', source: 'item:48', type: 'direct', category: 'cost', desc: '' },
            it: { name: 'ITè²»', source: 'item:49', type: 'direct', category: 'cost', desc: '' },
            outsource: { name: 'å¤–æ³¨è²»', source: 'item:50', type: 'direct', category: 'cost', desc: '' },
            misc: { name: 'é›‘è²»', source: 'item:51', type: 'direct', category: 'cost', desc: '' },

            // === äºˆç®—è¨­å®šï¼ˆå¤‰å‹•è²»ç”¨ï¼‰- MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===
            fdRate: { name: 'FDä»•å…¥è²»ç‡', source: 'calc:FDä»•å…¥è²»ç‡', type: 'rate', category: 'budget', desc: 'FDä»•å…¥è²»Ã·å£²ä¸ŠÃ—100' },
            paRate: { name: 'PAäººä»¶è²»ç‡', source: 'calc:PAäººä»¶è²»ç‡', type: 'rate', category: 'budget', desc: 'PAäººä»¶è²»Ã·å£²ä¸ŠÃ—100' },
            targetUnitPrice: { name: 'ç›®æ¨™å®¢å˜ä¾¡ï¼ˆç¨æŠœï¼‰', source: 'derived', type: 'input', category: 'budget', desc: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤' },
            targetCustomers: { name: 'ç›®æ¨™å®¢æ•°', source: 'derived', type: 'calc', category: 'budget', desc: 'è‡ªå‹•è¨ˆç®—' },
            lunchRatio: { name: 'ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ©ãƒ³ãƒå£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            dinnerRatio: { name: 'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            foodRatio: { name: 'ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ•ãƒ¼ãƒ‰å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            drinkRatio: { name: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡', source: 'calc:ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },
            otherRatio: { name: 'ãã®ä»–å£²ä¸Šæ¯”ç‡', source: 'calc:ãã®ä»–å£²ä¸Šæ¯”ç‡', type: 'rate', category: 'budget', desc: 'ãã®ä»–å£²ä¸ŠÃ·å£²ä¸ŠÃ—100' },

            // === å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- 28é …ç›®ï¼ˆåœ°ä»£å®¶è³ƒã‚’é™¤ãï¼‰===
            // â˜… v17 ITEMSç•ªå·ã«ä¿®æ­£æ¸ˆã¿ï¼ˆ2026/01/01ï¼‰
            m_fixedLabor: { name: 'å›ºå®šäººä»¶è²»', source: 'calc:å›ºå®šäººä»¶è²»åˆè¨ˆ', type: 'sum', category: 'monthly', desc: 'çµ¦æ–™+æ³•å®šç¦åˆ©+é€šå‹¤+è³ä¸+ç¤¾å®…+ä¼‘æ¥­' },
            m_depreciation: { name: 'æ¸›ä¾¡å„Ÿå´è²»', source: 'item:55', type: 'direct', category: 'monthly', desc: '' },
            m_material: { name: 'è³‡æè²»', source: 'calc:è³‡æè²»åˆè¨ˆ', type: 'sum', category: 'monthly', desc: 'è­¦å‚™æ–™+ãƒªãƒ¼ã‚¹æ–™' },
            m_promotion: { name: 'è²©å£²ä¿ƒé€²è²»', source: 'item:27', type: 'direct', category: 'monthly', desc: '' },
            m_menuCopy: { name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ”ãƒ¼', source: 'item:28', type: 'direct', category: 'monthly', desc: '' },
            m_survey: { name: 'èª¿æŸ»è²»', source: 'item:29', type: 'direct', category: 'monthly', desc: '' },
            m_sanitary: { name: 'è¡›ç”Ÿè²»', source: 'item:30', type: 'direct', category: 'monthly', desc: '' },
            m_service: { name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»', source: 'item:31', type: 'direct', category: 'monthly', desc: '' },
            m_electricity: { name: 'é›»æ°—ä»£', source: 'item:32', type: 'direct', category: 'monthly', desc: '' },
            m_gas: { name: 'ã‚¬ã‚¹ä»£', source: 'item:33', type: 'direct', category: 'monthly', desc: '' },
            m_water: { name: 'æ°´é“ä»£', source: 'item:34', type: 'direct', category: 'monthly', desc: '' },
            m_consumables: { name: 'æ¶ˆè€—å“è²»', source: 'item:35', type: 'direct', category: 'monthly', desc: '' },
            m_maintenance: { name: 'ä¿å®ˆä¿®ç¹•è²»', source: 'item:36', type: 'direct', category: 'monthly', desc: '' },
            m_taxes: { name: 'ç§Ÿç¨å…¬èª²', source: 'item:37', type: 'direct', category: 'monthly', desc: '' },
            m_entertainment: { name: 'æ¥å¾…äº¤éš›è²»', source: 'item:38', type: 'direct', category: 'monthly', desc: '' },
            m_travel: { name: 'æ—…è²»äº¤é€šè²»', source: 'item:39', type: 'direct', category: 'monthly', desc: '' },
            m_communication: { name: 'é€šä¿¡è²»', source: 'item:40', type: 'direct', category: 'monthly', desc: '' },
            m_creditFee: { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™', source: 'item:41', type: 'direct', category: 'monthly', desc: '' },
            m_paymentFee: { name: 'æ”¯æ‰•æ‰‹æ•°æ–™', source: 'item:42', type: 'direct', category: 'monthly', desc: '' },
            m_meeting: { name: 'ä¼šè­°è²»', source: 'item:43', type: 'direct', category: 'monthly', desc: '' },
            m_membership: { name: 'è«¸ä¼šè²»', source: 'item:44', type: 'direct', category: 'monthly', desc: '' },
            m_education: { name: 'å›³æ›¸æ•™è‚²è²»', source: 'item:45', type: 'direct', category: 'monthly', desc: '' },
            m_training: { name: 'ç ”ä¿®è²»', source: 'item:46', type: 'direct', category: 'monthly', desc: '' },
            m_research: { name: 'æ¥­æ…‹ç ”ç©¶è²»', source: 'item:47', type: 'direct', category: 'monthly', desc: '' },
            m_recruitment: { name: 'æ¡ç”¨è²»', source: 'item:48', type: 'direct', category: 'monthly', desc: '' },
            m_it: { name: 'ITè²»', source: 'item:49', type: 'direct', category: 'monthly', desc: '' },
            m_outsource: { name: 'å¤–æ³¨è²»', source: 'item:50', type: 'direct', category: 'monthly', desc: '' },
            m_misc: { name: 'é›‘è²»', source: 'item:51', type: 'direct', category: 'monthly', desc: '' }
        };

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ³å®šå®¢å˜ä¾¡ï¼ˆå††ï¼‰- ã“ã‚Œã‚’åŸºã«å®¢æ•°ã‚’é€†ç®—
        var DEFAULT_UNIT_PRICE = 4500;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®æƒ³å®šå®¢å˜ä¾¡ã‚’å–å¾—
        function getTargetUnitPrice() {
            var input = document.getElementById('targetUnitPriceInput');
            if (input && input.value) {
                var val = parseInt(input.value) || DEFAULT_UNIT_PRICE;
                return Math.max(100, Math.min(50000, val));
            }
            return DEFAULT_UNIT_PRICE;
        }

        // æƒ³å®šå®¢å˜ä¾¡ã‚’æ›´æ–°
        function updateTargetUnitPrice() {
            var val = getTargetUnitPrice();
            showStatus('info', 'æƒ³å®šå®¢å˜ä¾¡ã‚’ ' + fmt(val) + ' å††ã«è¨­å®šã—ã¾ã—ãŸã€‚MQå†è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦çµæœã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
        }

        // MQå†è¨ˆç®—
        function recalculateMQ() {
            console.log('=== recalculateMQ é–‹å§‹ ===');

            if (Object.keys(annualData).length === 0) {
                showStatus('warn', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            console.log('1. executeCalcRules å®Ÿè¡Œ');
            executeCalcRules();

            console.log('2. generateRakumyInputs å®Ÿè¡Œ');
            generateRakumyInputs();
            console.log('rakumyInputs[0]:', rakumyInputs[0]);

            console.log('3. runMQSimulation å®Ÿè¡Œ');
            runMQSimulation();
            console.log('mqOutputs[0]:', mqOutputs[0]);

            console.log('4. renderAllTables å®Ÿè¡Œ');
            renderAllTables();

            // å¹´é–“ã‚µãƒãƒªãƒ¼ã‚’è¨ˆç®—
            var mqInputs = getMQInputs();
            var totalG = 0, avgFD = 0, avgPA = 0, avgP = 0;
            for (var m = 0; m < 12; m++) {
                if (mqInputs[m]) {
                    totalG += mqInputs[m].targetProfit;
                    avgFD += mqInputs[m].fdRate;
                    avgPA += mqInputs[m].paRate;
                    avgP += mqInputs[m].targetUnitPrice;
                }
            }
            avgFD = (avgFD / 12).toFixed(1);
            avgPA = (avgPA / 12).toFixed(1);
            avgP = Math.round(avgP / 12);

            // MQè¨ˆç®—çµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            console.log('recalculateMQ: renderMQResultSummaryå‘¼ã³å‡ºã—å‰ - mqOutputs:', Object.keys(mqOutputs).length, 'activeMonths:', activeMonths.length);
            renderMQResultSummary();

            // â˜…â˜…â˜… é‡è¦: allStoresDataã«ä¿å­˜ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«åæ˜  â˜…â˜…â˜…
            saveCurrentStoreData();

            showStatus('success', 'MQå†è¨ˆç®—å®Œäº†ï¼ˆæœˆåˆ¥ï¼‰ - å¹´é–“G:' + fmtYen(totalG) + 'å†† å¹³å‡FD:' + avgFD + '% PA:' + avgPA + '% P:' + fmt(avgP) + 'å††');
        }

        // MQè¨ˆç®—çµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤ºï¼ˆãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤ã‚¿ãƒ–ç”¨ï¼‰
        function renderMQResultSummary() {
            console.log('=== renderMQResultSummary é–‹å§‹ ===');
            var container = document.getElementById('mqResultSummary');
            var table = document.getElementById('mqResultTable');
            console.log('container:', container, 'table:', table);
            if (!container || !table) {
                console.log('container ã¾ãŸã¯ table ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            console.log('activeMonths:', activeMonths, 'length:', activeMonths.length);
            console.log('mqOutputs keys:', Object.keys(mqOutputs), 'length:', Object.keys(mqOutputs).length);
            console.log('mqOutputs[0]:', mqOutputs[0]);

            if (activeMonths.length === 0 || Object.keys(mqOutputs).length === 0) {
                console.log('ãƒ‡ãƒ¼ã‚¿ãªã—ã§æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³');
                container.style.display = 'none';
                return;
            }

            var MONTH_NAMES = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var headerHtml = '<thead><tr style="background:#2e7d32;">';
            headerHtml += '<th style="min-width:120px;padding:6px;color:#fff;font-weight:bold;">é …ç›®</th>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                headerHtml += '<th style="min-width:70px;color:#fff;font-weight:bold;">' + MONTH_NAMES[mi] + '</th>';
            }
            headerHtml += '<th style="min-width:80px;background:#1b5e20;color:#fff;font-weight:bold;">åˆè¨ˆ/å¹³å‡</th>';
            headerHtml += '</tr></thead>';

            // ãƒœãƒ‡ã‚£è¡Œ
            var bodyHtml = '<tbody>';

            // ç›®æ¨™å®¢æ•°
            var totalQ = 0;
            bodyHtml += '<tr style="background:#e8f5e9;"><td style="font-weight:bold;color:#2e7d32;">ğŸ¯ ç›®æ¨™å®¢æ•°ï¼ˆäººï¼‰</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var q = mqOutputs[i] ? (mqOutputs[i].customers || 0) : 0;
                totalQ += q;
                bodyHtml += '<td style="text-align:right;font-weight:bold;">' + fmt(q) + '</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#c8e6c9;">' + fmt(totalQ) + '</td></tr>';

            // ç›®æ¨™å£²ä¸Š
            var totalS = 0;
            bodyHtml += '<tr><td style="font-weight:bold;color:#1565c0;">ğŸ’° ç›®æ¨™å£²ä¸Šï¼ˆå††ï¼‰</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var s = mqOutputs[i] ? (mqOutputs[i].sales || 0) : 0;
                totalS += s;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(s) + '</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#bbdefb;">' + fmtYen(totalS) + '</td></tr>';

            // ç›®æ¨™å–¶æ¥­åˆ©ç›Š
            var totalProfit = 0;
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ğŸ“ˆ ç›®æ¨™å–¶æ¥­åˆ©ç›Šï¼ˆå††ï¼‰</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var profit = mqOutputs[i] ? (mqOutputs[i].operatingProfit || 0) : 0;
                totalProfit += profit;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(profit) + '</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + fmtYen(totalProfit) + '</td></tr>';

            // é™ç•Œåˆ©ç›Šå˜ä¾¡Mï¼ˆP Ã— (1 - VR)ã§è¨ˆç®—ï¼‰
            var totalM = 0;
            bodyHtml += '<tr><td style="font-weight:bold;color:#7b1fa2;">ğŸ“Š é™ç•Œåˆ©ç›Šå˜ä¾¡Mï¼ˆå††ï¼‰</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var out = mqOutputs[i];
                var m = 0;
                if (out) {
                    var vr = (out.variableRate || 0) / 100;
                    m = Math.round((out.unitPrice || 0) * (1 - vr));
                }
                totalM += m;
                bodyHtml += '<td style="text-align:right;">' + fmt(m) + '</td>';
            }
            var avgM = activeMonths.length > 0 ? Math.round(totalM / activeMonths.length) : 0;
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#e1bee7;">' + fmt(avgM) + '</td></tr>';

            bodyHtml += '</tbody>';

            table.innerHTML = headerHtml + bodyHtml;
            container.style.display = 'block';
            console.log('=== renderMQResultSummary å®Œäº† - è¡¨ç¤ºè¨­å®šæ¸ˆã¿ ===');
        }

        // â˜…â˜…â˜… MQå…¥åŠ›å€¤å–å¾—é–¢æ•°ç¾¤ï¼ˆç›®æ¨™å®¢å˜ä¾¡ã®ã¿å…¥åŠ›ã€ä»–ã¯è‡ªå‹•å–å¾—ï¼‰â˜…â˜…â˜…
        function getMQInputs() {
            // æœˆåˆ¥ã®MQå…¥åŠ›å€¤ã‚’å–å¾—ï¼ˆå–ã‚Šè¾¼ã¾ã‚ŒãŸæœˆã®ã¿ï¼‰
            // G, FD%, PA%, Fã¯é¡§å®¢äºˆç®—ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã€Pã®ã¿å…¥åŠ›
            var monthlyInputs = {};
            var autoParams = getMQAutoParams(); // é¡§å®¢äºˆç®—ã‹ã‚‰è‡ªå‹•å–å¾—
            var defaults = getDefaultUnitPrice(currentStoreName);

            for (var i = 0; i < activeMonths.length; i++) {
                var m = activeMonths[i];
                // ç›®æ¨™å®¢å˜ä¾¡ã¯å…¥åŠ›å€¤ã‹ã‚‰å–å¾—ï¼ˆç·åˆ/ãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰
                var unitPrice = parseInt(document.getElementById('mqP_total_' + m)?.value) || defaults.total;
                var lunchUnitPrice = parseInt(document.getElementById('mqP_lunch_' + m)?.value) || defaults.lunch;
                var dinnerUnitPrice = parseInt(document.getElementById('mqP_dinner_' + m)?.value) || defaults.dinner;

                monthlyInputs[m] = {
                    targetProfit: autoParams.monthlyG[m] || 0, // é¡§å®¢äºˆç®—No.63ã®æœˆæ¬¡å€¤
                    fdRate: autoParams.fdRate || 30,
                    paRate: autoParams.paRate || 10,
                    targetUnitPrice: unitPrice,
                    targetUnitPriceLunch: lunchUnitPrice,    // ãƒ©ãƒ³ãƒå®¢å˜ä¾¡è¿½åŠ 
                    targetUnitPriceDinner: dinnerUnitPrice,  // ãƒ‡ã‚£ãƒŠãƒ¼å®¢å˜ä¾¡è¿½åŠ 
                    fixedCost: autoParams.monthlyF[m] || 0 // å›ºå®šè²»ã‚‚è‡ªå‹•å–å¾—
                };
            }
            return monthlyInputs;
        }

        // é¡§å®¢äºˆç®—ã‹ã‚‰è‡ªå‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
        function getMQAutoParams() {
            var result = {
                monthlyG: {}, // æœˆåˆ¥ç›®æ¨™åˆ©ç›Šï¼ˆNo.63å–¶æ¥­åˆ©ç›Šï¼‰- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼
                monthlyF: {}, // æœˆåˆ¥å›ºå®šè²» - ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼
                fdRate: 0,
                paRate: 0,
                totalG: 0,
                avgF: 0
            };

            if (Object.keys(annualData).length === 0) return result;

            var monthCount = activeMonths.length || 1;

            // å›ºå®šè²»ãƒ»å¤‰å‹•è²»ãƒ»å£²ä¸Šã‚’è¨ˆç®—
            var totalFixedCost = 0;
            var totalVariableCost = 0;
            var totalSales = 0;

            for (var i = 0; i < activeMonths.length; i++) {
                var m = activeMonths[i];
                var get = function(no) { return annualData[no] ? (annualData[no][m] || 0) : 0; };
                var getCalc = function(name) { return calcResults[m] ? (calcResults[m][name] || 0) : 0; };

                // No.63 = å–¶æ¥­åˆ©ç›Š
                var g = annualData[63] ? (annualData[63][m] || 0) : 0;
                result.monthlyG[m] = g;
                result.totalG += g;

                // å›ºå®šè²» = åœ°ä»£å®¶è³ƒ + å›ºå®šäººä»¶è²» + ãã®ä»–è²©ç®¡è²»
                var fixedCost = getCalc('åœ°ä»£å®¶è³ƒåˆè¨ˆ') + getCalc('å›ºå®šäººä»¶è²»åˆè¨ˆ') + get(55) + getCalc('è³‡æè²»åˆè¨ˆ') +
                    get(27) + get(28) + get(29) + get(30) + get(31) + get(32) + get(33) + get(34) + get(35) + get(36) +
                    get(37) + get(38) + get(39) + get(40) + get(41) + get(42) + get(43) + get(44) + get(45) + get(46) +
                    get(47) + get(48) + get(49) + get(50) + get(51);
                result.monthlyF[m] = fixedCost;
                totalFixedCost += fixedCost;

                // å¤‰å‹•è²» = é£Ÿæä»•å…¥ + ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥ + PAäººä»¶è²»
                var variableCost = get(6) + get(10) + get(19);
                totalVariableCost += variableCost;
                totalSales += get(4);
            }

            result.avgF = Math.round(totalFixedCost / monthCount);

            // FD%ã¨PA%ã‚’è¨ˆç®—
            if (totalSales > 0) {
                var fdCost = 0, paCost = 0;
                for (var i = 0; i < activeMonths.length; i++) {
                    var m = activeMonths[i];
                    var get = function(no) { return annualData[no] ? (annualData[no][m] || 0) : 0; };
                    fdCost += get(6) + get(10); // é£Ÿæ + ãƒ‰ãƒªãƒ³ã‚¯
                    paCost += get(19); // PAäººä»¶è²»
                }
                result.fdRate = Math.round((fdCost / totalSales) * 1000) / 10;
                result.paRate = Math.round((paCost / totalSales) * 1000) / 10;
            }

            return result;
        }

        // MQãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«å‹•çš„ç”Ÿæˆï¼ˆäºˆç®—è¨­å®šã‚¿ãƒ–ç”¨ï¼‰
        function renderMQAutoParamsTable() {
            var table = document.getElementById('mqAutoParamsTable');
            if (!table) return;

            if (activeMonths.length === 0) {
                table.innerHTML = '<tr><td style="padding:20px;text-align:center;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            var params = getMQAutoParams();
            var MONTH_NAMES = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var headerHtml = '<thead><tr style="background:#e65100;">';
            headerHtml += '<th style="min-width:100px;padding:6px;color:#fff;font-weight:bold;">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</th>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var label = MONTH_NAMES[mi] || (mi + 1) + 'æœˆ';
                headerHtml += '<th style="min-width:65px;color:#fff;font-weight:bold;">' + label + '</th>';
            }
            headerHtml += '<th style="min-width:70px;background:#bf360c;color:#fff;font-weight:bold;">å¹³å‡</th>';
            headerHtml += '</tr></thead>';

            // ãƒœãƒ‡ã‚£è¡Œ
            var bodyHtml = '<tbody>';

            // Gï¼ˆç›®æ¨™åˆ©ç›Šï¼‰- æœˆåˆ¥
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ã€Gã€‘ç›®æ¨™åˆ©ç›Š(å††)</td>';
            var totalG = 0;
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var g = params.monthlyG[mi] || 0;
                totalG += g;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(g) + '</td>';
            }
            var avgG = Math.round(totalG / activeMonths.length);
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + fmtYen(avgG) + '</td></tr>';

            // Fï¼ˆå›ºå®šè²»ï¼‰- æœˆåˆ¥
            bodyHtml += '<tr><td style="font-weight:bold;color:#e65100;">ã€Fã€‘å›ºå®šè²»(å††)</td>';
            var totalF = 0;
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var f = params.monthlyF[mi] || 0;
                totalF += f;
                bodyHtml += '<td style="text-align:right;">' + fmtYen(f) + '</td>';
            }
            var avgF = Math.round(totalF / activeMonths.length);
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + fmtYen(avgF) + '</td></tr>';

            // FD%ï¼ˆå…¨æœŸé–“å…±é€šï¼‰
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ã€FD%ã€‘FDç‡</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                bodyHtml += '<td style="text-align:right;color:#888;">' + params.fdRate.toFixed(1) + '%</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + params.fdRate.toFixed(1) + '%</td></tr>';

            // PA%ï¼ˆå…¨æœŸé–“å…±é€šï¼‰
            bodyHtml += '<tr><td style="font-weight:bold;color:#e65100;">ã€PA%ã€‘PAç‡</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                bodyHtml += '<td style="text-align:right;color:#888;">' + params.paRate.toFixed(1) + '%</td>';
            }
            bodyHtml += '<td style="font-weight:bold;text-align:right;background:#ffe0b2;">' + params.paRate.toFixed(1) + '%</td></tr>';

            bodyHtml += '</tbody>';

            table.innerHTML = headerHtml + bodyHtml;
        }

        // è‡ªå‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¡¨ç¤ºã‚’æ›´æ–°
        function updateMQAutoParamsDisplay() {
            renderMQAutoParamsTable();
        }

        // åº—èˆ—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¢å˜ä¾¡ã‚’å–å¾—
        function getDefaultUnitPrice(storeName) {
            return DEFAULT_UNIT_PRICES[storeName] || DEFAULT_UNIT_PRICES['_default'];
        }

        // ç›®æ¨™å®¢å˜ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«å‹•çš„ç”Ÿæˆï¼ˆäºˆç®—è¨­å®šã‚¿ãƒ–ç”¨ï¼‰
        function renderMQUnitPriceTable() {
            var table = document.getElementById('mqUnitPriceTable');
            if (!table) return;

            // æœˆæ•°è¡¨ç¤ºã‚’æ›´æ–°
            var countEl = document.getElementById('mqMonthCountDisplay');
            if (countEl) countEl.textContent = activeMonths.length;

            if (activeMonths.length === 0) {
                table.innerHTML = '<tr><td style="padding:20px;text-align:center;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            var MONTH_NAMES = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            var headerHtml = '<thead><tr style="background:#2e7d32;">';
            headerHtml += '<th style="min-width:130px;padding:6px;color:#fff;font-weight:bold;">é …ç›®</th>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                var label = MONTH_NAMES[mi] || (mi + 1) + 'æœˆ';
                headerHtml += '<th style="min-width:65px;color:#fff;font-weight:bold;">' + label + '</th>';
            }
            headerHtml += '<th style="min-width:70px;background:#1b5e20;color:#fff;font-weight:bold;">å¹³å‡</th>';
            headerHtml += '</tr></thead>';

            // ãƒœãƒ‡ã‚£è¡Œ
            var bodyHtml = '<tbody>';

            // ç·åˆ
            bodyHtml += '<tr style="background:#e8f5e9;"><td style="font-weight:bold;color:#2e7d32;">ç›®æ¨™å®¢å˜ä¾¡ï¼ˆç·åˆï¼‰</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                bodyHtml += '<td><input type="number" id="mqP_total_' + mi + '" step="100" style="width:55px;padding:3px;text-align:right;border:1px solid #4caf50;border-radius:3px;" onchange="updateUnitPriceAverage(\'total\')"></td>';
            }
            bodyHtml += '<td id="mqP_total_avg" style="font-weight:bold;text-align:right;background:#c8e6c9;">Â¥--</td></tr>';

            // ãƒ©ãƒ³ãƒ
            bodyHtml += '<tr><td style="font-weight:bold;color:#1565c0;">ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ©ãƒ³ãƒï¼‰</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                bodyHtml += '<td><input type="number" id="mqP_lunch_' + mi + '" step="100" style="width:55px;padding:3px;text-align:right;border:1px solid #2196f3;border-radius:3px;" onchange="updateUnitPriceAverage(\'lunch\')"></td>';
            }
            bodyHtml += '<td id="mqP_lunch_avg" style="font-weight:bold;text-align:right;background:#e3f2fd;">Â¥--</td></tr>';

            // ãƒ‡ã‚£ãƒŠãƒ¼
            bodyHtml += '<tr style="background:#fff3e0;"><td style="font-weight:bold;color:#e65100;">ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ï¼‰</td>';
            for (var i = 0; i < activeMonths.length; i++) {
                var mi = activeMonths[i];
                bodyHtml += '<td><input type="number" id="mqP_dinner_' + mi + '" step="100" style="width:55px;padding:3px;text-align:right;border:1px solid #ff9800;border-radius:3px;" onchange="updateUnitPriceAverage(\'dinner\')"></td>';
            }
            bodyHtml += '<td id="mqP_dinner_avg" style="font-weight:bold;text-align:right;background:#ffe0b2;">Â¥--</td></tr>';

            bodyHtml += '</tbody>';

            table.innerHTML = headerHtml + bodyHtml;
        }

        // ç›®æ¨™å®¢å˜ä¾¡ã‚’åˆæœŸåŒ–ï¼ˆåº—èˆ—åˆ‡æ›¿æ™‚ã«å‘¼ã³å‡ºã—ãƒ»å‹•çš„æœˆå¯¾å¿œï¼‰
        function initUnitPricesForStore(storeName) {
            // ã¾ãšãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‹•çš„ç”Ÿæˆ
            renderMQUnitPriceTable();

            var defaults = getDefaultUnitPrice(storeName);

            // åº—èˆ—åã‚’è¡¨ç¤º
            var storeDisplay = document.getElementById('mqStoreNameDisplay');
            if (storeDisplay) storeDisplay.textContent = 'åº—èˆ—: ' + storeName;

            // storeUnitPricesã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if (!storeUnitPrices[storeName]) {
                storeUnitPrices[storeName] = {};
                for (var i = 0; i < activeMonths.length; i++) {
                    var m = activeMonths[i];
                    storeUnitPrices[storeName][m] = {
                        total: defaults.total,
                        lunch: defaults.lunch,
                        dinner: defaults.dinner
                    };
                }
            }

            // UIã«å€¤ã‚’ã‚»ãƒƒãƒˆï¼ˆå–ã‚Šè¾¼ã¾ã‚ŒãŸæœˆã®ã¿ï¼‰
            for (var i = 0; i < activeMonths.length; i++) {
                var m = activeMonths[i];
                var data = storeUnitPrices[storeName][m] || { total: defaults.total, lunch: defaults.lunch, dinner: defaults.dinner };
                var totalEl = document.getElementById('mqP_total_' + m);
                var lunchEl = document.getElementById('mqP_lunch_' + m);
                var dinnerEl = document.getElementById('mqP_dinner_' + m);

                if (totalEl) totalEl.value = data.total;
                if (lunchEl) lunchEl.value = data.lunch;
                if (dinnerEl) dinnerEl.value = data.dinner;
            }

            // å¹³å‡å€¤ã‚’æ›´æ–°
            updateUnitPriceAverage('total');
            updateUnitPriceAverage('lunch');
            updateUnitPriceAverage('dinner');

            // è‡ªå‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¡¨ç¤ºã‚’æ›´æ–°
            updateMQAutoParamsDisplay();
        }

        // ç›®æ¨™å®¢å˜ä¾¡ã®å¹³å‡ã‚’æ›´æ–°ï¼ˆå‹•çš„æœˆå¯¾å¿œï¼‰
        function updateUnitPriceAverage(type) {
            var total = 0;
            var count = 0;

            for (var i = 0; i < activeMonths.length; i++) {
                var m = activeMonths[i];
                var el = document.getElementById('mqP_' + type + '_' + m);
                if (el) {
                    var val = parseInt(el.value) || 0;
                    total += val;
                    if (val > 0) count++;

                    // storeUnitPricesã«ä¿å­˜
                    if (currentStoreName) {
                        if (!storeUnitPrices[currentStoreName]) storeUnitPrices[currentStoreName] = {};
                        if (!storeUnitPrices[currentStoreName][m]) storeUnitPrices[currentStoreName][m] = {};
                        storeUnitPrices[currentStoreName][m][type] = val;
                    }
                }
            }

            var avg = count > 0 ? Math.round(total / count) : 0;
            var avgEl = document.getElementById('mqP_' + type + '_avg');
            if (avgEl) avgEl.textContent = 'Â¥' + fmt(avg);
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆï¼ˆå‹•çš„æœˆå¯¾å¿œï¼‰
        function resetUnitPricesToDefault() {
            if (!currentStoreName) {
                showStatus('warn', 'åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            var defaults = getDefaultUnitPrice(currentStoreName);

            // storeUnitPricesã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå–ã‚Šè¾¼ã¾ã‚ŒãŸæœˆã®ã¿ï¼‰
            storeUnitPrices[currentStoreName] = {};
            for (var i = 0; i < activeMonths.length; i++) {
                var m = activeMonths[i];
                storeUnitPrices[currentStoreName][m] = {
                    total: defaults.total,
                    lunch: defaults.lunch,
                    dinner: defaults.dinner
                };
            }

            // UIã‚’æ›´æ–°
            initUnitPricesForStore(currentStoreName);
            showStatus('info', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆ' + currentStoreName + 'ï¼‰');
        }

        // â˜…â˜…â˜… ãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤ã‚¿ãƒ–ç”¨ï¼šãƒã‚¹ã‚¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…
        function resetMQUnitPricesToDefault() {
            if (!currentStoreName) {
                showStatus('warn', 'åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            if (!confirm('ã€Œ' + currentStoreName + 'ã€ã®å®¢å˜ä¾¡ã‚’ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            resetUnitPricesToDefault();
        }

        // â˜…â˜…â˜… ãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤ã‚¿ãƒ–ç”¨ï¼šå®¢å˜ä¾¡ã‚’ãƒã‚¹ã‚¿ã«ä¿å­˜ â˜…â˜…â˜…
        function saveMQUnitPricesToMaster() {
            if (!currentStoreName) {
                showStatus('warn', 'åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            if (activeMonths.length === 0) {
                showStatus('warn', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’å–å¾—
            var totalSum = 0, lunchSum = 0, dinnerSum = 0;
            var monthlyData = {};

            for (var i = 0; i < activeMonths.length; i++) {
                var m = activeMonths[i];
                var totalEl = document.getElementById('mqP_total_' + m);
                var lunchEl = document.getElementById('mqP_lunch_' + m);
                var dinnerEl = document.getElementById('mqP_dinner_' + m);

                var total = totalEl ? parseInt(totalEl.value) || 0 : 0;
                var lunch = lunchEl ? parseInt(lunchEl.value) || 0 : 0;
                var dinner = dinnerEl ? parseInt(dinnerEl.value) || 0 : 0;

                totalSum += total;
                lunchSum += lunch;
                dinnerSum += dinner;

                monthlyData[m] = { total: total, lunch: lunch, dinner: dinner };
            }

            // å¹³å‡å€¤ã‚’è¨ˆç®—
            var monthCount = activeMonths.length;
            var avgTotal = Math.round(totalSum / monthCount);
            var avgLunch = Math.round(lunchSum / monthCount);
            var avgDinner = Math.round(dinnerSum / monthCount);

            // DEFAULT_UNIT_PRICESã«ä¿å­˜
            if (!DEFAULT_UNIT_PRICES[currentStoreName]) {
                DEFAULT_UNIT_PRICES[currentStoreName] = { storeCode: '', total: avgTotal, lunch: avgLunch, dinner: avgDinner };
            } else {
                DEFAULT_UNIT_PRICES[currentStoreName].total = avgTotal;
                DEFAULT_UNIT_PRICES[currentStoreName].lunch = avgLunch;
                DEFAULT_UNIT_PRICES[currentStoreName].dinner = avgDinner;
            }

            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜
            DEFAULT_UNIT_PRICES[currentStoreName].monthly = {};
            for (var m in monthlyData) {
                DEFAULT_UNIT_PRICES[currentStoreName].monthly[m] = monthlyData[m];
            }

            // LocalStorageã«ä¿å­˜
            saveUnitPriceSettings();

            // ãƒã‚¹ã‚¿è¨­å®šã‚¿ãƒ–ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ï¼‰
            if (typeof renderUnitPriceSummary === 'function') {
                renderUnitPriceSummary();
            }

            showStatus('success', 'ã€Œ' + currentStoreName + 'ã€ã®å®¢å˜ä¾¡ã‚’ãƒã‚¹ã‚¿ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆå¹³å‡: Â¥' + fmt(avgTotal) + 'ï¼‰');
        }

        // æ—§é–¢æ•°äº’æ›ç”¨
        function applyDefaultMQValues() {
            resetUnitPricesToDefault();
        }

        // æ—§é–¢æ•°äº’æ›ç”¨
        function updateMQInputSummary() {
            updateUnitPriceAverage('total');
            updateUnitPriceAverage('lunch');
            updateUnitPriceAverage('dinner');
        }

        // è²»ç”¨è¨­å®šç¢ºèªæ¬„ï¼ˆå‚ç…§è¡¨ç¤ºï¼‰ã‚’æ›´æ–°
        function updateMQRefDisplay() {
            if (Object.keys(annualData).length === 0) return;

            // å›ºå®šè²»åˆè¨ˆã‚’è¨ˆç®—ï¼ˆé¡§å®¢äºˆç®—ã‹ã‚‰å‚ç…§ï¼‰
            var totalFixedCost = 0;
            var totalVariableCost = 0;
            var totalSales = 0;
            var monthlyFixedCosts = [];

            for (var m = 0; m < activeMonths.length; m++) {
                var get = function(no) { return annualData[no] ? (annualData[no][m] || 0) : 0; };
                var getCalc = function(name) { return calcResults[m] ? (calcResults[m][name] || 0) : 0; };

                var fixedCost = getCalc('åœ°ä»£å®¶è³ƒåˆè¨ˆ') + getCalc('å›ºå®šäººä»¶è²»åˆè¨ˆ') + get(55) + getCalc('è³‡æè²»åˆè¨ˆ') +
                    get(27) + get(28) + get(29) + get(30) + get(31) + get(32) + get(33) + get(34) + get(35) + get(36) +
                    get(37) + get(38) + get(39) + get(40) + get(41) + get(42) + get(43) + get(44) + get(45) + get(46) +
                    get(47) + get(48) + get(49) + get(50) + get(51);
                totalFixedCost += fixedCost;
                monthlyFixedCosts.push(fixedCost);

                var variableCost = get(6) + get(10) + get(19);  // é£Ÿæä»•å…¥ + ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥ + PAäººä»¶è²»
                totalVariableCost += variableCost;
                totalSales += get(4);
            }

            var avgFixedCost = activeMonths.length > 0 ? Math.round(totalFixedCost / activeMonths.length) : 0;
            var variableRate = totalSales > 0 ? (totalVariableCost / totalSales * 100).toFixed(1) : 0;

            var refVarRate = document.getElementById('mqRefVariableRate');
            var refFixedCost = document.getElementById('mqRefFixedCost');
            if (refVarRate) refVarRate.textContent = variableRate + '%';
            if (refFixedCost) refFixedCost.textContent = fmtYen(avgFixedCost) + ' å††';

            // æœˆåˆ¥å›ºå®šè²»ã‚’MQå…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤ºï¼ˆå††å˜ä½è¡¨ç¤ºï¼‰
            for (var m = 0; m < 12; m++) {
                var fEl = document.getElementById('mqF_' + m);
                if (fEl) {
                    var val = monthlyFixedCosts[m] || 0;
                    fEl.textContent = fmtYen(val);
                }
            }
            var fTotal = document.getElementById('mqF_total');
            if (fTotal) fTotal.textContent = fmtYen(totalFixedCost);

            // MQå…¥åŠ›ã‚µãƒãƒªãƒ¼ã‚‚æ›´æ–°
            updateMQInputSummary();
        }

        function generateRakumyInputs() {
            rakumyInputs = {};

            // â˜…â˜…â˜… æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’å–å¾— â˜…â˜…â˜…
            var mqInputs = getMQInputs();

            for (var m = 0; m < activeMonths.length; m++) {
                var get = function(no) { return annualData[no] ? (annualData[no][m] || 0) : 0; };
                var getCalc = function(name) { return calcResults[m][name] || 0; };

                // â˜… æœˆåˆ¥MQå…¥åŠ›å€¤ã‚’å–å¾—
                var monthInput = mqInputs[m] || { targetProfit: 500, fdRate: 30, paRate: 10, targetUnitPrice: 4500 };

                // â˜… é¡§å®¢äºˆç®—å€¤ï¼ˆå‚è€ƒå€¤ã¨ã—ã¦ä¿å­˜ï¼‰
                var budgetSales = get(4);           // é¡§å®¢äºˆç®—ã®å£²ä¸Šé«˜åˆè¨ˆï¼ˆNo.4ï¼‰
                var budgetProfit = get(63);         // é¡§å®¢äºˆç®—ã®å–¶æ¥­åˆ©ç›Šï¼ˆNo.63ï¼‰

                // â˜… å›ºå®šè²»ç”¨åˆè¨ˆï¼ˆè²»ç”¨äºˆç®—è¨­å®šã‹ã‚‰è‡ªå‹•å‚ç…§ - å…¥åŠ›ä¸è¦ï¼‰
                var fixedCostTotal = getCalc('åœ°ä»£å®¶è³ƒåˆè¨ˆ') + getCalc('å›ºå®šäººä»¶è²»åˆè¨ˆ') + get(55) + getCalc('è³‡æè²»åˆè¨ˆ') +
                    get(27) + get(28) + get(29) + get(30) + get(31) + get(32) + get(33) + get(34) + get(35) + get(36) +
                    get(37) + get(38) + get(39) + get(40) + get(41) + get(42) + get(43) + get(44) + get(45) + get(46) +
                    get(47) + get(48) + get(49) + get(50) + get(51);

                rakumyInputs[m] = {
                    // è²»ç”¨äºˆç®—è¨­å®šï¼ˆå›ºå®šè²»ç”¨ï¼‰- v17Noã«å¯¾å¿œï¼ˆå‚ç…§ç”¨ï¼‰
                    rent: getCalc('åœ°ä»£å®¶è³ƒåˆè¨ˆ'),
                    fixedLabor: getCalc('å›ºå®šäººä»¶è²»åˆè¨ˆ'),
                    depreciation: get(55),
                    material: getCalc('è³‡æè²»åˆè¨ˆ'),
                    promotion: get(27), menuCopy: get(28), survey: get(29), sanitary: get(30), service: get(31),
                    electricity: get(32), gas: get(33), water: get(34), consumables: get(35), maintenance: get(36),
                    taxes: get(37), entertainment: get(38), travel: get(39), communication: get(40),
                    creditFee: get(41), paymentFee: get(42), meeting: get(43), membership: get(44),
                    education: get(45), training: get(46), research: get(47), recruitment: get(48),
                    it: get(49), outsource: get(50), misc: get(51),

                    // â˜…â˜…â˜… MQå…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆæœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’ä½¿ç”¨ï¼‰â˜…â˜…â˜…
                    fdRate: monthInput.fdRate,                    // æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
                    paRate: monthInput.paRate,                    // æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
                    targetUnitPrice: monthInput.targetUnitPrice,  // æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆç·åˆï¼‰
                    targetUnitPriceLunch: monthInput.targetUnitPriceLunch,    // æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆãƒ©ãƒ³ãƒï¼‰
                    targetUnitPriceDinner: monthInput.targetUnitPriceDinner,  // æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ï¼‰
                    targetProfit: monthInput.targetProfit,        // æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
                    fixedCostTotal: fixedCostTotal,               // è²»ç”¨äºˆç®—ã‹ã‚‰è‡ªå‹•å‚ç…§

                    // å£²ä¸Šæ§‹æˆæ¯”ï¼ˆå‚ç…§ç”¨ï¼‰
                    lunchRatio: getCalc('ãƒ©ãƒ³ãƒå£²ä¸Šæ¯”ç‡'),
                    dinnerRatio: getCalc('ãƒ‡ã‚£ãƒŠãƒ¼å£²ä¸Šæ¯”ç‡'),
                    foodRatio: getCalc('ãƒ•ãƒ¼ãƒ‰å£²ä¸Šæ¯”ç‡'),
                    drinkRatio: getCalc('ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šæ¯”ç‡'),
                    otherRatio: getCalc('ãã®ä»–å£²ä¸Šæ¯”ç‡'),

                    // å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- å‚ç…§ç”¨
                    m_fixedLabor: getCalc('å›ºå®šäººä»¶è²»åˆè¨ˆ'),
                    m_depreciation: get(55),
                    m_material: getCalc('è³‡æè²»åˆè¨ˆ'),
                    m_promotion: get(27), m_menuCopy: get(28), m_survey: get(29), m_sanitary: get(30), m_service: get(31),
                    m_electricity: get(32), m_gas: get(33), m_water: get(34), m_consumables: get(35), m_maintenance: get(36),
                    m_taxes: get(37), m_entertainment: get(38), m_travel: get(39), m_communication: get(40),
                    m_creditFee: get(41), m_paymentFee: get(42), m_meeting: get(43), m_membership: get(44),
                    m_education: get(45), m_training: get(46), m_research: get(47), m_recruitment: get(48),
                    m_it: get(49), m_outsource: get(50), m_misc: get(51),

                    // å‚è€ƒå€¤ï¼ˆé¡§å®¢äºˆç®—å€¤ï¼‰
                    budgetSales: budgetSales,
                    budgetProfit: budgetProfit
                };
            }

            // è²»ç”¨è¨­å®šç¢ºèªæ¬„ã‚’æ›´æ–°
            updateMQRefDisplay();
        }

        // â˜…â˜…â˜… ãƒ©ã‚¯ãƒŸãƒ¼MQè¨ˆç®—ï¼ˆé€†ç®—å¼ï¼‰â˜…â˜…â˜…
        // å…¥åŠ›: å›ºå®šè²»ã€å¤‰å‹•è²»ç‡ã€ç›®æ¨™æœˆæ¬¡åˆ©ç›Šã€ç›®æ¨™å®¢å˜ä¾¡
        // è¨ˆç®—: å¿…è¦é™ç•Œåˆ©ç›Š â†’ å¿…è¦å£²ä¸Š â†’ ç›®æ¨™å®¢æ•°
        function runMQSimulation() {
            mqOutputs = {};
            for (var m = 0; m < activeMonths.length; m++) {
                var r = rakumyInputs[m];

                // â˜… å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                var fixedCost = r.fixedCostTotal;          // å›ºå®šè²»åˆè¨ˆ
                var variableRate = (r.fdRate + r.paRate) / 100;  // å¤‰å‹•è²»ç‡ï¼ˆå°æ•°ï¼‰
                var targetProfit = r.targetProfit;         // ç›®æ¨™æœˆæ¬¡åˆ©ç›Š
                var targetUnitPrice = r.targetUnitPrice;   // ç›®æ¨™å®¢å˜ä¾¡

                // â˜…â˜…â˜… MQé€†ç®—å¼ â˜…â˜…â˜…
                // 1. å¿…è¦ãªé™ç•Œåˆ©ç›Š = å›ºå®šè²» + ç›®æ¨™æœˆæ¬¡åˆ©ç›Š
                var requiredGrossProfit = fixedCost + targetProfit;

                // 2. å¿…è¦ãªå£²ä¸Š = é™ç•Œåˆ©ç›Š / (1 - å¤‰å‹•è²»ç‡)
                //    é™ç•Œåˆ©ç›Š = å£²ä¸Š Ã— (1 - å¤‰å‹•è²»ç‡) ãªã®ã§
                //    å£²ä¸Š = é™ç•Œåˆ©ç›Š / (1 - å¤‰å‹•è²»ç‡)
                var grossProfitRate = 1 - variableRate;  // é™ç•Œåˆ©ç›Šç‡
                var requiredSales = grossProfitRate > 0 ? requiredGrossProfit / grossProfitRate : 0;

                // 3. ç›®æ¨™å®¢æ•° = å£²ä¸Š / å®¢å˜ä¾¡
                //    å£²ä¸Šã¯åƒå††å˜ä½ã€å®¢å˜ä¾¡ã¯å††å˜ä½ãªã®ã§: å®¢æ•° = å£²ä¸Š Ã— 1000 / å®¢å˜ä¾¡
                var targetCustomers = targetUnitPrice > 0 ? Math.round(requiredSales * 1000 / targetUnitPrice) : 0;

                // â˜… æ¤œç®—ï¼šå®¢æ•° Ã— å®¢å˜ä¾¡ã§å£²ä¸Šã‚’å†è¨ˆç®—ï¼ˆç«¯æ•°èª¿æ•´ï¼‰
                var sales = targetCustomers * targetUnitPrice / 1000;

                // â˜… MQè¨ˆç®—çµæœ
                var variableCost = sales * variableRate;
                var grossProfit = sales - variableCost;
                var operatingProfit = grossProfit - fixedCost;

                mqOutputs[m] = {
                    // å£²ä¸Šãƒ»å®¢æ•°ï¼ˆMQé€†ç®—çµæœï¼‰
                    sales: Math.round(sales),
                    customers: targetCustomers,
                    unitPrice: targetUnitPrice,

                    // å¤‰å‹•è²»
                    variableCost: Math.round(variableCost),
                    variableRate: variableRate * 100,

                    // é™ç•Œåˆ©ç›Š
                    grossProfit: Math.round(grossProfit),
                    grossProfitRate: sales > 0 ? grossProfit / sales * 100 : 0,

                    // å›ºå®šè²»
                    fixedCost: Math.round(fixedCost),

                    // å–¶æ¥­åˆ©ç›Šï¼ˆMQè¨ˆç®—çµæœï¼‰
                    operatingProfit: Math.round(operatingProfit),
                    operatingProfitRate: sales > 0 ? operatingProfit / sales * 100 : 0,

                    // é€†ç®—ã§ä½¿ç”¨ã—ãŸç›®æ¨™åˆ©ç›Šï¼ˆå‚è€ƒï¼‰
                    targetProfit: targetProfit,
                    requiredGrossProfit: Math.round(requiredGrossProfit),
                    requiredSales: Math.round(requiredSales)
                };
            }
        }

        // ========== å·®ç•°åˆ†ææ©Ÿèƒ½ ==========
        function showDifferenceAnalysis() {
            if (Object.keys(annualData).length === 0) {
                showStatus('warn', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            var analysis = performDifferenceAnalysis();
            showDifferenceAnalysisModal(analysis);
        }

        function performDifferenceAnalysis() {
            var result = {
                summary: { totalBudget: 0, totalMQ: 0, totalDiff: 0 },
                monthly: [],
                items: []
            };

            // æœˆåˆ¥å·®ç•°
            for (var m = 0; m < activeMonths.length; m++) {
                var budgetSales = annualData[4] ? (annualData[4][m] || 0) : 0;  // No.4 å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰
                var mqSales = mqOutputs[m] ? (mqOutputs[m].sales || 0) : 0;
                var diff = mqSales - budgetSales;
                var diffRate = budgetSales > 0 ? (diff / budgetSales * 100) : 0;

                result.summary.totalBudget += budgetSales;
                result.summary.totalMQ += mqSales;
                result.summary.totalDiff += diff;

                result.monthly.push({
                    month: monthLabels[m],
                    budgetSales: budgetSales,
                    mqSales: mqSales,
                    diff: diff,
                    diffRate: diffRate
                });
            }

            // é …ç›®åˆ¥å·®ç•°åˆ†æ
            var itemAnalysis = [
                { name: 'å£²ä¸Šé«˜', budget: result.summary.totalBudget, mq: result.summary.totalMQ, diff: result.summary.totalDiff },
                { name: 'å¤‰å‹•è²»', budget: calcTotalByItemNo(6) + calcTotalByItemNo(7), mq: sumMQField('variableCost'), diff: 0 },
                { name: 'å›ºå®šè²»', budget: calcTotalByItemNo(8), mq: sumMQField('fixedCost'), diff: 0 },
                { name: 'å–¶æ¥­åˆ©ç›Š', budget: calcTotalByItemNo(9) || (result.summary.totalBudget - calcTotalByItemNo(6) - calcTotalByItemNo(7) - calcTotalByItemNo(8)), mq: sumMQField('operatingProfit'), diff: 0 }
            ];

            itemAnalysis.forEach(function(item) {
                item.diff = item.mq - item.budget;
                item.diffRate = item.budget !== 0 ? (item.diff / Math.abs(item.budget) * 100) : 0;
            });

            result.items = itemAnalysis;

            // å·®ç•°ã®åŸå› åˆ†æ
            result.causes = analyzeDifferenceCauses();

            return result;
        }

        function calcTotalByItemNo(no) {
            var total = 0;
            if (annualData[no]) {
                for (var m = 0; m < activeMonths.length; m++) {
                    total += annualData[no][m] || 0;
                }
            }
            return total;
        }

        function sumMQField(field) {
            var total = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                if (mqOutputs[m]) {
                    total += mqOutputs[m][field] || 0;
                }
            }
            return total;
        }

        function analyzeDifferenceCauses() {
            var causes = [];
            var targetUnitPrice = getTargetUnitPrice();

            // 1. ä¸¸ã‚èª¤å·®ã®ç¢ºèª
            var totalBudgetSales = calcTotalByItemNo(5);
            var totalMQSales = sumMQField('sales');
            var salesDiff = Math.abs(totalMQSales - totalBudgetSales);
            var salesDiffRate = totalBudgetSales > 0 ? (salesDiff / totalBudgetSales * 100) : 0;

            if (salesDiffRate > 0.1) {
                causes.push({
                    type: 'rounding',
                    severity: salesDiffRate > 1 ? 'high' : 'medium',
                    title: 'å£²ä¸Šè¨ˆç®—ã®ä¸¸ã‚èª¤å·®',
                    detail: 'å®¢æ•°ãƒ»å®¢å˜ä¾¡ã®é€†ç®—æ™‚ã®ä¸¸ã‚å‡¦ç†ã«ã‚ˆã‚Šã€å£²ä¸Šã« ' + salesDiffRate.toFixed(2) + '% ã®å·®ç•°ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚',
                    suggestion: 'å®¢å˜ä¾¡ã‚’èª¿æ•´ã—ã¦å·®ç•°ã‚’ç¸®å°ã§ãã¾ã™ã€‚ç¾åœ¨ã®è¨­å®š: ' + fmt(targetUnitPrice) + 'å††'
                });
            }

            // 2. å¤‰å‹•è²»ç‡ã®ç¢ºèª
            for (var m = 0; m < activeMonths.length; m++) {
                var r = rakumyInputs[m];
                if (r) {
                    var budgetSales = annualData[4] ? (annualData[4][m] || 0) : 0;  // No.4 å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰
                    var expectedVarCost = budgetSales * (r.fdRate + r.paRate) / 100;
                    var actualVarCost = mqOutputs[m] ? mqOutputs[m].variableCost : 0;
                    var varDiff = Math.abs(actualVarCost - expectedVarCost);
                    if (varDiff > 10) {
                        causes.push({
                            type: 'variable_cost',
                            severity: 'low',
                            title: monthLabels[m] + ': å¤‰å‹•è²»è¨ˆç®—ã®å·®ç•°',
                            detail: 'å¤‰å‹•è²»ç‡é©ç”¨æ™‚ã« ' + fmtYen(Math.round(varDiff)) + ' å††ã®å·®ç•°ãŒã‚ã‚Šã¾ã™ã€‚',
                            suggestion: 'MQè¨ˆç®—ã§ã¯MQå£²ä¸Šã«å¤‰å‹•è²»ç‡ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã€å…ƒã®äºˆç®—å£²ä¸Šã¨ç•°ãªã‚Šã¾ã™ã€‚'
                        });
                        break; // 1å›ã ã‘è¡¨ç¤º
                    }
                }
            }

            // 3. å®¢å˜ä¾¡è¨­å®šã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
            var avgActualUnitPrice = 0;
            var validMonths = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                if (mqOutputs[m] && mqOutputs[m].unitPrice > 0) {
                    avgActualUnitPrice += mqOutputs[m].unitPrice;
                    validMonths++;
                }
            }
            avgActualUnitPrice = validMonths > 0 ? Math.round(avgActualUnitPrice / validMonths) : targetUnitPrice;

            if (Math.abs(avgActualUnitPrice - targetUnitPrice) > 100) {
                causes.push({
                    type: 'unit_price',
                    severity: 'info',
                    title: 'å®¢å˜ä¾¡è¨­å®šã®ç¢ºèª',
                    detail: 'è¨­å®šå®¢å˜ä¾¡ ' + fmt(targetUnitPrice) + 'å†† ã«å¯¾ã—ã€è¨ˆç®—ä¸Šã®å¹³å‡å®¢å˜ä¾¡ã¯ ' + fmt(avgActualUnitPrice) + 'å†† ã§ã™ã€‚',
                    suggestion: 'å®Ÿç¸¾å®¢å˜ä¾¡ã«è¿‘ã„å€¤ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šæ­£ç¢ºãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¯èƒ½ã§ã™ã€‚'
                });
            }

            return causes;
        }

        function showDifferenceAnalysisModal(analysis) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä½œæˆ
            var modal = document.createElement('div');
            modal.id = 'differenceAnalysisModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';

            var content = document.createElement('div');
            content.style.cssText = 'background:#fff;border-radius:12px;max-width:900px;max-height:90vh;overflow:auto;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,0.3);';

            // ã‚¿ã‚¤ãƒˆãƒ«
            var html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">';
            html += '<h2 style="margin:0;color:#d84315;">ğŸ“Š å·®ç•°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h2>';
            html += '<button onclick="document.getElementById(\'differenceAnalysisModal\').remove()" style="background:#f44336;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;">âœ• é–‰ã˜ã‚‹</button>';
            html += '</div>';

            // ã‚µãƒãƒªãƒ¼
            var diffRate = analysis.summary.totalBudget > 0 ? (analysis.summary.totalDiff / analysis.summary.totalBudget * 100) : 0;
            var diffColor = Math.abs(diffRate) < 1 ? '#4caf50' : (Math.abs(diffRate) < 5 ? '#ff9800' : '#f44336');
            html += '<div style="background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px;">';
            html += '<h3 style="margin:0 0 15px 0;color:#333;">å¹´é–“ã‚µãƒãƒªãƒ¼</h3>';
            html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;">';
            html += '<div style="background:#fff;padding:15px;border-radius:8px;text-align:center;border-left:4px solid #2196f3;"><div style="font-size:11px;color:#666;">é¡§å®¢äºˆç®—å£²ä¸Š</div><div style="font-size:20px;font-weight:bold;color:#1565c0;">' + fmtYen(Math.round(analysis.summary.totalBudget)) + '</div></div>';
            html += '<div style="background:#fff;padding:15px;border-radius:8px;text-align:center;border-left:4px solid #9c27b0;"><div style="font-size:11px;color:#666;">MQç®—å‡ºå£²ä¸Š</div><div style="font-size:20px;font-weight:bold;color:#7b1fa2;">' + fmtYen(Math.round(analysis.summary.totalMQ)) + '</div></div>';
            html += '<div style="background:#fff;padding:15px;border-radius:8px;text-align:center;border-left:4px solid ' + diffColor + ';"><div style="font-size:11px;color:#666;">å·®ç•°</div><div style="font-size:20px;font-weight:bold;color:' + diffColor + ';">' + (analysis.summary.totalDiff >= 0 ? '+' : '') + fmtYen(Math.round(analysis.summary.totalDiff)) + '</div></div>';
            html += '<div style="background:#fff;padding:15px;border-radius:8px;text-align:center;border-left:4px solid ' + diffColor + ';"><div style="font-size:11px;color:#666;">å·®ç•°ç‡</div><div style="font-size:20px;font-weight:bold;color:' + diffColor + ';">' + (diffRate >= 0 ? '+' : '') + diffRate.toFixed(2) + '%</div></div>';
            html += '</div></div>';

            // æœˆåˆ¥å·®ç•°ãƒ†ãƒ¼ãƒ–ãƒ«
            html += '<div style="margin-bottom:20px;">';
            html += '<h3 style="margin:0 0 10px 0;color:#333;">ğŸ“… æœˆåˆ¥å£²ä¸Šå·®ç•°</h3>';
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#e3f2fd;"><th style="padding:8px;border:1px solid #ddd;">æœˆ</th><th style="padding:8px;border:1px solid #ddd;">é¡§å®¢äºˆç®—</th><th style="padding:8px;border:1px solid #ddd;">MQå£²ä¸Š</th><th style="padding:8px;border:1px solid #ddd;">å·®ç•°</th><th style="padding:8px;border:1px solid #ddd;">å·®ç•°ç‡</th></tr>';
            analysis.monthly.forEach(function(m) {
                var color = Math.abs(m.diffRate) < 1 ? '#4caf50' : (Math.abs(m.diffRate) < 5 ? '#ff9800' : '#f44336');
                html += '<tr><td style="padding:6px;border:1px solid #ddd;text-align:center;">' + m.month + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;">' + fmtYen(Math.round(m.budgetSales)) + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;">' + fmtYen(Math.round(m.mqSales)) + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;color:' + color + ';">' + (m.diff >= 0 ? '+' : '') + fmtYen(Math.round(m.diff)) + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;color:' + color + ';">' + (m.diffRate >= 0 ? '+' : '') + m.diffRate.toFixed(2) + '%</td></tr>';
            });
            html += '</table></div>';

            // é …ç›®åˆ¥å·®ç•°
            html += '<div style="margin-bottom:20px;">';
            html += '<h3 style="margin:0 0 10px 0;color:#333;">ğŸ“‹ é …ç›®åˆ¥å·®ç•°</h3>';
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#fce4ec;"><th style="padding:8px;border:1px solid #ddd;">é …ç›®</th><th style="padding:8px;border:1px solid #ddd;">é¡§å®¢äºˆç®—</th><th style="padding:8px;border:1px solid #ddd;">MQç®—å‡º</th><th style="padding:8px;border:1px solid #ddd;">å·®ç•°</th><th style="padding:8px;border:1px solid #ddd;">å·®ç•°ç‡</th></tr>';
            analysis.items.forEach(function(item) {
                var color = Math.abs(item.diffRate) < 1 ? '#4caf50' : (Math.abs(item.diffRate) < 5 ? '#ff9800' : '#f44336');
                html += '<tr><td style="padding:6px;border:1px solid #ddd;">' + item.name + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;">' + fmtYen(Math.round(item.budget)) + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;">' + fmtYen(Math.round(item.mq)) + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;color:' + color + ';">' + (item.diff >= 0 ? '+' : '') + fmtYen(Math.round(item.diff)) + '</td>';
                html += '<td style="padding:6px;border:1px solid #ddd;text-align:right;color:' + color + ';">' + (item.diffRate >= 0 ? '+' : '') + item.diffRate.toFixed(2) + '%</td></tr>';
            });
            html += '</table></div>';

            // åŸå› åˆ†æ
            if (analysis.causes && analysis.causes.length > 0) {
                html += '<div style="margin-bottom:20px;">';
                html += '<h3 style="margin:0 0 10px 0;color:#333;">ğŸ” å·®ç•°ã®åŸå› åˆ†æ</h3>';
                analysis.causes.forEach(function(cause) {
                    var bgColor = cause.severity === 'high' ? '#ffebee' : (cause.severity === 'medium' ? '#fff8e1' : '#e8f5e9');
                    var borderColor = cause.severity === 'high' ? '#f44336' : (cause.severity === 'medium' ? '#ff9800' : '#4caf50');
                    html += '<div style="background:' + bgColor + ';border-left:4px solid ' + borderColor + ';padding:12px;border-radius:4px;margin-bottom:10px;">';
                    html += '<div style="font-weight:bold;color:#333;margin-bottom:5px;">' + cause.title + '</div>';
                    html += '<div style="font-size:12px;color:#666;margin-bottom:5px;">' + cause.detail + '</div>';
                    html += '<div style="font-size:11px;color:#1565c0;">ğŸ’¡ ' + cause.suggestion + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // å®¢å˜ä¾¡èª¿æ•´ã®ãƒ’ãƒ³ãƒˆ
            html += '<div style="background:#e8f5e9;padding:15px;border-radius:8px;border:2px solid #4caf50;">';
            html += '<h4 style="margin:0 0 10px 0;color:#2e7d32;">ğŸ’¡ å·®ç•°ã‚’ç¸®å°ã™ã‚‹ã«ã¯</h4>';
            html += '<ul style="margin:0;padding-left:20px;font-size:12px;color:#333;">';
            html += '<li>æƒ³å®šå®¢å˜ä¾¡ã‚’å®Ÿç¸¾ã«è¿‘ã„å€¤ã«èª¿æ•´ã—ã¦ãã ã•ã„</li>';
            html += '<li>å¤‰å‹•è²»ç‡ï¼ˆFDä»•å…¥è²»ç‡ã€PAäººä»¶è²»ç‡ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>';
            html += '<li>MQå£²ä¸Š = å®¢æ•° Ã— å®¢å˜ä¾¡ / 1000 ã§è¨ˆç®—ã•ã‚Œã‚‹ãŸã‚ã€ä¸¸ã‚èª¤å·®ã¯é¿ã‘ã‚‰ã‚Œã¾ã›ã‚“</li>';
            html += '</ul></div>';

            content.innerHTML = html;
            modal.appendChild(content);
            document.body.appendChild(modal);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', function(e) {
                if (e.target === modal) modal.remove();
            });
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderAllTables() {
            console.log('=== renderAllTables é–‹å§‹ ===');
            console.log('matchedItems:', matchedItems ? matchedItems.length + 'ä»¶' : 'null/undefined');
            console.log('currentStoreName:', currentStoreName);
            console.log('storeName:', storeName);

            renderInputTable();
            renderCalcTable();
            renderRakumyTables();
            renderMqAutoInputsDisplay();  // â˜… MQè‡ªå‹•åˆæˆå…¥åŠ›å€¤ã®è¡¨ç¤º
            renderOutputTable();
            renderBudgetListTable();
            renderSummary();

            console.log('=== renderAllTables çµ‚äº† ===');
        }

        // â˜… MQè‡ªå‹•åˆæˆå…¥åŠ›å€¤ã®è¡¨ç¤º
        function renderMqAutoInputsDisplay() {
            var container = document.getElementById('mqAutoInputsDisplay');
            if (!container) return;

            var html = '';

            // å¹´é–“å¹³å‡å€¤ã‚’è¨ˆç®—
            var totalFixedCost = 0, totalTargetProfit = 0, avgFdRate = 0, avgPaRate = 0;
            var monthCount = activeMonths.length || 1;

            for (var m = 0; m < activeMonths.length; m++) {
                if (rakumyInputs[m]) {
                    totalFixedCost += rakumyInputs[m].fixedCostTotal || 0;
                    totalTargetProfit += rakumyInputs[m].targetProfit || 0;
                    avgFdRate += rakumyInputs[m].fdRate || 0;
                    avgPaRate += rakumyInputs[m].paRate || 0;
                }
            }
            avgFdRate = avgFdRate / monthCount;
            avgPaRate = avgPaRate / monthCount;
            var avgVR = avgFdRate + avgPaRate;

            // å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚«ãƒ¼ãƒ‰
            var items = [
                { label: 'ã€Fã€‘å›ºå®šè²»ç”¨äºˆç®—ï¼ˆå¹´é–“ï¼‰', value: fmtYen(totalFixedCost), unit: 'å††', color: '#2e7d32', desc: 'è²»ç”¨äºˆç®—è¨­å®šã®å›ºå®šè²»é …ç›®åˆè¨ˆ' },
                { label: 'ã€Gã€‘ç›®æ¨™æœˆæ¬¡åˆ©ç›Šï¼ˆå¹´é–“ï¼‰', value: fmtYen(totalTargetProfit), unit: 'å††', color: '#1565c0', desc: 'é¡§å®¢äºˆç®—ã®å–¶æ¥­åˆ©ç›Šï¼ˆNo.63ï¼‰' },
                { label: 'ã€FD%ã€‘FDä»•å…¥è²»ç‡ï¼ˆå¹³å‡ï¼‰', value: avgFdRate.toFixed(1), unit: '%', color: '#ff5722', desc: 'é£Ÿæ+ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥è²»/å£²ä¸Š' },
                { label: 'ã€PA%ã€‘PAäººä»¶è²»ç‡ï¼ˆå¹³å‡ï¼‰', value: avgPaRate.toFixed(1), unit: '%', color: '#9c27b0', desc: 'PAäººä»¶è²»/å£²ä¸Š' },
                { label: 'ã€VRã€‘å¤‰å‹•è²»ç‡ï¼ˆFD+PAï¼‰', value: avgVR.toFixed(1), unit: '%', color: '#e65100', desc: 'FDä»•å…¥è²»ç‡+PAäººä»¶è²»ç‡' }
            ];

            items.forEach(function(item) {
                html += '<div style="background:#fff;border-radius:6px;padding:12px;border-left:4px solid ' + item.color + ';">';
                html += '<div style="font-size:11px;color:#666;margin-bottom:5px;">' + item.label + '</div>';
                html += '<div style="font-size:20px;font-weight:bold;color:' + item.color + ';">' + item.value + ' <span style="font-size:12px;font-weight:normal;">' + item.unit + '</span></div>';
                html += '<div style="font-size:10px;color:#999;margin-top:5px;">' + item.desc + '</div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function createMonthHeaders() {
            var html = '<tr><th>é …ç›®</th>';
            for (var i = 0; i < monthLabels.length; i++) {
                html += '<th class="month-header">' + monthLabels[i] + '</th>';
            }
            html += '<th class="total-col">åˆè¨ˆ</th><th class="avg-col">å¹³å‡</th></tr>';
            return html;
        }

        function renderInputTable() {
            var table = document.getElementById('inputTable');
            var html = createMonthHeaders();

            // ãƒ‡ãƒãƒƒã‚°ï¼šmatchedItemsã®å†…å®¹ã‚’ç¢ºèªï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨UIä¸¡æ–¹ã«å‡ºåŠ›ï¼‰
            console.log('=== renderInputTable ãƒ‡ãƒãƒƒã‚° ===');
            console.log('matchedItems.length =', matchedItems ? matchedItems.length : 'null/undefined');

            if (matchedItems && matchedItems.length > 0) {
                // å…¨ã‚¢ã‚¤ãƒ†ãƒ ã®v15Noä¸€è¦§
                var v15Nos = matchedItems.map(function(item) { return item.v15No; }).sort(function(a,b) { return a-b; });
                console.log('å…¨v15Noå€¤:', v15Nos.join(', '));

                // ç›£è¦–å¯¾è±¡ã®æ¬ è½ãƒã‚§ãƒƒã‚¯
                var watchList = [1, 8, 9, 11, 12, 20];
                var missing = watchList.filter(function(n) { return v15Nos.indexOf(n) === -1; });
                var present = watchList.filter(function(n) { return v15Nos.indexOf(n) >= 0; });

                console.log('ç›£è¦–å¯¾è±¡(1,8,9,11,12,20)ã®å­˜åœ¨çŠ¶æ³:');
                console.log('  å­˜åœ¨:', present.join(', ') || 'ãªã—');
                console.log('  æ¬ è½:', missing.join(', ') || 'ãªã—');

                // å„ã‚¢ã‚¤ãƒ†ãƒ ã®è©³ç´°
                matchedItems.forEach(function(item, idx) {
                    if (watchList.indexOf(item.v15No) >= 0) {
                        console.log('  [' + idx + '] v15No=' + item.v15No + ', name=' + item.name + ', code=' + item.code);
                    }
                });

                if (missing.length > 0) {
                    console.warn('è­¦å‘Š: ç›£è¦–å¯¾è±¡v17Noæ¬ è½ =', missing.join(', '));
                }
            } else {
                console.warn('è­¦å‘Š: matchedItemsãŒç©ºã¾ãŸã¯æœªå®šç¾©');
            }
            console.log('=== ãƒ‡ãƒãƒƒã‚°çµ‚äº† ===');

            // â˜… matchedItemsã‚’v17Noé †ã§è¡¨ç¤º
            if (matchedItems && matchedItems.length > 0) {
                // v15No(v17No)ã§ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
                var sortedItems = matchedItems.slice().sort(function(a, b) {
                    return (a.v15No || 0) - (b.v15No || 0);
                });

                sortedItems.forEach(function(item, idx) {
                    // v17Noï¼ˆv15Noï¼‰ã§è¡¨ç¤º
                    var displayNo = item.v15No || (idx + 1);
                    var itemName = item.name || 'ä¸æ˜';
                    var v17No = item.v15No;

                    // â˜… annualDataã‹ã‚‰å€¤ã‚’å–å¾—ï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§çµ±ä¸€ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼‰
                    // åˆè¨ˆã‚’å…ˆã«è¨ˆç®—ï¼ˆ0å€¤ã®è¡Œã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ï¼‰
                    var total = 0;
                    for (var m = 0; m < activeMonths.length; m++) {
                        var val = annualData[v17No] ? (annualData[v17No][m] || 0) : 0;
                        total += val;
                    }

                    // åˆè¨ˆãŒ0ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆéè¡¨ç¤ºï¼‰
                    if (total === 0) return;

                    html += '<tr><td>[' + displayNo + '] ' + itemName + '</td>';
                    for (var m = 0; m < activeMonths.length; m++) {
                        // â˜… annualDataã‹ã‚‰å€¤ã‚’å–å¾—ï¼ˆmatchedItems.rowDataã§ã¯ãªãï¼‰- å††å˜ä½è¡¨ç¤º
                        var val = annualData[v17No] ? (annualData[v17No][m] || 0) : 0;
                        var cellClass = val === 0 ? 'input-cell zero-value' : 'input-cell';
                        html += '<td class="' + cellClass + '">' + fmtYen(val) + '</td>';
                    }
                    html += '<td class="total-col">' + fmtYen(total) + '</td><td class="avg-col">' + fmtYen(Math.round(total / activeMonths.length)) + '</td></tr>';
                });
            } else {
                html += '<tr><td colspan="' + (activeMonths.length + 3) + '" style="text-align:center;color:#999;padding:20px;">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„</td></tr>';
            }

            table.innerHTML = html;
        }

        function renderCalcTable() {
            var table = document.getElementById('calcTable');
            var html = createMonthHeaders();
            for (var name in CALC_RULES) {
                var isRate = CALC_RULES[name].type === 'rate';
                html += '<tr><td>' + name + '</td>';
                var total = 0;
                for (var m = 0; m < activeMonths.length; m++) {
                    var val = calcResults[m][name] || 0;
                    total += val;
                    // ç‡ä»¥å¤–ã¯å††å˜ä½è¡¨ç¤º
                    html += '<td class="calc-cell">' + (isRate ? fmtRate(val) + '%' : fmtYen(val)) + '</td>';
                }
                html += isRate ? '<td class="total-col">-</td><td class="avg-col">' + fmtRate(total / activeMonths.length) + '%</td></tr>' : '<td class="total-col">' + fmtYen(total) + '</td><td class="avg-col">' + fmtYen(total / activeMonths.length) + '</td></tr>';
            }
            table.innerHTML = html;
        }

        function renderRakumyTables() {
            var costTable = document.getElementById('rakumyCostTable');
            var budgetTable = document.getElementById('rakumyBudgetTable');
            var monthlyTable = document.getElementById('rakumyMonthlyTable');

            var costHtml = createMonthHeaders();
            var budgetHtml = createMonthHeaders();
            var monthlyHtml = createMonthHeaders();
            var monthlyCount = 0; // å˜æœˆè²»ç”¨äºˆç®—ã«è¡¨ç¤ºã™ã‚‹é …ç›®æ•°

            // ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸ç”Ÿæˆ
            function getTypeBadge(type) {
                switch (type) {
                    case 'direct': return '<span class="type-direct">ç›´æ¥</span>';
                    case 'sum': return '<span class="type-sum">åˆè¨ˆ</span>';
                    case 'rate': return '<span class="type-rate">ç‡</span>';
                    case 'input': return '<span class="type-input">å…¥åŠ›</span>';
                    case 'calc': return '<span class="type-output">å‡ºåŠ›</span>';
                    default: return '';
                }
            }

            // ========== æ–°ãƒ­ã‚¸ãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤æ±ºå®š + å·®ç•°æœˆç‰¹å®š ==========
            // æœˆåˆ¥å€¤ã‚’åˆ†æã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæœ€é »å€¤ï¼‰ã¨å·®ç•°æœˆã‚’ç‰¹å®š
            function analyzeMonthlyValues(key) {
                var values = [];
                var valueCount = {};

                // å…¨æœˆã®å€¤ã‚’åé›†
                for (var m = 0; m < activeMonths.length; m++) {
                    var val = rakumyInputs[m] ? (rakumyInputs[m][key] || 0) : 0;
                    // å°æ•°ç‚¹ä»¥ä¸‹ã‚’ä¸¸ã‚ã¦æ¯”è¼ƒï¼ˆ0.01ã®èª¤å·®ã‚’å¸åï¼‰
                    var roundedVal = Math.round(val * 100) / 100;
                    values.push(roundedVal);
                    valueCount[roundedVal] = (valueCount[roundedVal] || 0) + 1;
                }

                // æœ€é »å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰ã‚’æ±ºå®š
                var defaultValue = 0;
                var maxCount = 0;
                for (var v in valueCount) {
                    if (valueCount[v] > maxCount) {
                        maxCount = valueCount[v];
                        defaultValue = parseFloat(v);
                    }
                }

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ç•°ãªã‚‹æœˆã‚’ç‰¹å®š
                var diffMonths = [];
                var diffValues = {};
                for (var m = 0; m < values.length; m++) {
                    if (Math.abs(values[m] - defaultValue) > 0.01) {
                        diffMonths.push(m);
                        diffValues[m] = values[m];
                    }
                }

                return {
                    defaultValue: defaultValue,      // æœ€é »å€¤ï¼ˆå¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                    diffMonths: diffMonths,          // å·®ç•°ãŒã‚ã‚‹æœˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                    diffValues: diffValues,          // å·®ç•°æœˆã®å€¤ { monthIndex: value }
                    hasDiff: diffMonths.length > 0,  // å·®ç•°ãŒã‚ã‚‹ã‹ã©ã†ã‹
                    allSame: diffMonths.length === 0 // å…¨æœˆåŒä¸€ã‹ã©ã†ã‹
                };
            }

            // æ—§ãƒ­ã‚¸ãƒƒã‚¯äº’æ›ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
            function hasMonthlyVariation(key) {
                return analyzeMonthlyValues(key).hasDiff;
            }

            // RAKUMY_ITEMSã‚’ä½¿ã£ã¦ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«æç”»
            for (var key in RAKUMY_ITEMS) {
                var item = RAKUMY_ITEMS[key];
                var isRate = item.type === 'rate' || key.indexOf('Ratio') > -1;
                var typeBadge = getTypeBadge(item.type);
                var descText = item.desc ? ' <span style="color:#888;font-size:9px;">(' + item.desc + ')</span>' : '';

                // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«æŒ¯ã‚Šåˆ†ã‘
                if (item.category === 'cost') {
                    // è²»ç”¨äºˆç®—è¨­å®šï¼šæ–°ãƒ­ã‚¸ãƒƒã‚¯ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæœ€é »å€¤ï¼‰ã‚’è¡¨ç¤ºã€å·®ç•°æœˆã¯ãƒãƒ¼ã‚¯
                    var analysis = analyzeMonthlyValues(key);
                    var rowHtml;

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦è¡¨ç¤º
                    var badgeText = analysis.hasDiff
                        ? '<span class="annual-badge">å¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span><span class="monthly-badge" style="margin-left:4px;">+å˜æœˆèª¿æ•´' + analysis.diffMonths.length + 'ä»¶</span>'
                        : '<span class="annual-badge">å¹´é–“å›ºå®š</span>';

                    rowHtml = '<tr><td>' + item.name + ' ' + typeBadge + ' ' + badgeText + descText + '</td>';

                    for (var m = 0; m < activeMonths.length; m++) {
                        var isDiffMonth = analysis.diffMonths.indexOf(m) >= 0;
                        if (isDiffMonth) {
                            // å·®ç•°æœˆ: å˜æœˆè²»ç”¨äºˆç®—ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã™ï¼ˆå††å˜ä½è¡¨ç¤ºï¼‰
                            var diffVal = analysis.diffValues[m];
                            rowHtml += '<td class="rakumy-cell" style="background:#fff3e0;color:#e65100;font-weight:bold;" title="å˜æœˆè²»ç”¨äºˆç®—ã§ä¸Šæ›¸ã: ' + fmtYen(diffVal) + '">' + fmtYen(analysis.defaultValue) + 'â†’<span style="font-size:10px;">' + fmtYen(diffVal) + '</span></td>';
                        } else {
                            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤é©ç”¨æœˆï¼ˆå††å˜ä½è¡¨ç¤ºï¼‰
                            rowHtml += '<td class="rakumy-cell">' + fmtYen(analysis.defaultValue) + '</td>';
                        }
                    }

                    // åˆè¨ˆãƒ»å¹³å‡ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãƒ™ãƒ¼ã‚¹ï¼ˆå®Ÿéš›ã®ãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤ï¼‰- å††å˜ä½è¡¨ç¤º
                    var total = analysis.defaultValue * activeMonths.length;
                    rowHtml += '<td class="total-col">' + fmtYen(total) + '</td><td class="avg-col">' + fmtYen(analysis.defaultValue) + '</td></tr>';
                    costHtml += rowHtml;
                } else if (item.category === 'budget') {
                    var rowHtml = '<tr><td>' + item.name + ' ' + typeBadge + descText + '</td>';
                    var total = 0;
                    for (var m = 0; m < activeMonths.length; m++) {
                        var val = rakumyInputs[m][key] || 0;
                        total += val;
                        // ç‡ä»¥å¤–ã¯å††å˜ä½è¡¨ç¤º
                        rowHtml += '<td class="rakumy-cell">' + (isRate ? fmtRate(val) + '%' : fmtYen(val)) + '</td>';
                    }
                    if (isRate) {
                        rowHtml += '<td class="total-col">-</td><td class="avg-col">' + fmtRate(total / activeMonths.length) + '%</td></tr>';
                    } else {
                        rowHtml += '<td class="total-col">' + fmtYen(total) + '</td><td class="avg-col">' + fmtYen(total / activeMonths.length) + '</td></tr>';
                    }
                    budgetHtml += rowHtml;
                } else if (item.category === 'monthly') {
                    // å˜æœˆè²»ç”¨äºˆç®—ï¼šæ–°ãƒ­ã‚¸ãƒƒã‚¯ - å·®ç•°æœˆã®ã¿å€¤ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœˆã¯ã€Œ-ã€ï¼‰
                    var baseKey = key.replace('m_', ''); // m_fixedLabor â†’ fixedLabor
                    var analysis = analyzeMonthlyValues(baseKey);

                    if (analysis.hasDiff) {
                        var rowHtml = '<tr><td>' + item.name + ' ' + typeBadge + ' <span style="color:#e65100;font-size:10px;">(' + analysis.diffMonths.length + 'æœˆåˆ†ä¸Šæ›¸ã)</span>' + descText + '</td>';
                        var diffTotal = 0;

                        for (var m = 0; m < activeMonths.length; m++) {
                            var isDiffMonth = analysis.diffMonths.indexOf(m) >= 0;
                            if (isDiffMonth) {
                                // å·®ç•°æœˆ: å®Ÿéš›ã®å€¤ã‚’è¡¨ç¤ºï¼ˆä¸Šæ›¸ãè¨­å®šå€¤ï¼‰- å††å˜ä½è¡¨ç¤º
                                var val = rakumyInputs[m][key] || 0;
                                diffTotal += val;
                                rowHtml += '<td class="rakumy-cell" style="background:#fff3e0;color:#e65100;font-weight:bold;">' + fmtYen(val) + '</td>';
                            } else {
                                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé©ç”¨æœˆ: è¨­å®šä¸è¦ï¼ˆã€Œ-ã€è¡¨ç¤ºï¼‰
                                rowHtml += '<td class="rakumy-cell" style="color:#ccc;text-align:center;">-</td>';
                            }
                        }

                        // åˆè¨ˆã¯å·®ç•°æœˆã®åˆè¨ˆã®ã¿ï¼ˆå††å˜ä½è¡¨ç¤ºï¼‰
                        rowHtml += '<td class="total-col" style="color:#e65100;">' + fmtYen(diffTotal) + '</td>';
                        rowHtml += '<td class="avg-col" style="color:#888;">(' + analysis.diffMonths.length + 'æœˆ)</td></tr>';
                        monthlyHtml += rowHtml;
                        monthlyCount++;
                    }
                }
            }

            // å˜æœˆè²»ç”¨äºˆç®—ãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (monthlyCount === 0) {
                monthlyHtml += '<tr><td colspan="' + (activeMonths.length + 3) + '" style="text-align:center;color:#888;padding:20px;">å…¨é …ç›®ãŒå¹´é–“ã§åŒä¸€å€¤ã®ãŸã‚ã€å˜æœˆèª¿æ•´ã¯ä¸è¦ã§ã™ã€‚<br>è²»ç”¨äºˆç®—è¨­å®šã®å¹´é–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒå…¨æœˆã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</td></tr>';
            }

            // å‚è€ƒå€¤ï¼šé¡§å®¢äºˆç®—å£²ä¸Šï¼ˆMQå‡ºåŠ›ã¨ã®æ¯”è¼ƒç”¨ï¼‰- å††å˜ä½è¡¨ç¤º
            budgetHtml += '<tr style="background:#fff3e0;"><td>ã€å‚è€ƒã€‘é¡§å®¢äºˆç®—å£²ä¸Š <span class="type-output">å‡ºåŠ›</span></td>';
            var refTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = rakumyInputs[m].budgetSales || 0;
                refTotal += val;
                budgetHtml += '<td class="rakumy-cell">' + fmtYen(val) + '</td>';
            }
            budgetHtml += '<td class="total-col">' + fmtYen(refTotal) + '</td><td class="avg-col">' + fmtYen(refTotal / activeMonths.length) + '</td></tr>';

            costTable.innerHTML = costHtml;
            budgetTable.innerHTML = budgetHtml;
            monthlyTable.innerHTML = monthlyHtml;

            // å˜æœˆè²»ç”¨äºˆç®—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            var monthlyHeader = document.querySelector('.rakumy-category.monthly h4');
            if (monthlyHeader) {
                monthlyHeader.textContent = 'å˜æœˆè²»ç”¨äºˆç®—ï¼ˆå›ºå®šè²»ç”¨ï¼‰- ' + monthlyCount + 'é …ç›®ï¼ˆæœˆåˆ¥å·®ç•°ãŒã‚ã‚‹é …ç›®ã®ã¿è¡¨ç¤ºï¼‰';
            }
        }

        function renderOutputTable() {
            var table = document.getElementById('outputTable');
            var html = createMonthHeaders();

            // â˜…â˜…â˜… MQé€†ç®—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ â˜…â˜…â˜…
            // === STEP 0: MQå…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆè²»ç”¨äºˆç®—è¨­å®šã‹ã‚‰å‚ç…§ï¼‰ ===
            html += '<tr style="background:#4caf50;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;text-align:center;padding:12px;font-size:14px;">ã€STEP 0ã€‘MQå…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆè²»ç”¨äºˆç®—è¨­å®šã‹ã‚‰å‚ç…§ï¼‰</td></tr>';

            // å›ºå®šè²»ç”¨äºˆç®—ï¼ˆFï¼‰- å††å˜ä½è¡¨ç¤º
            html += '<tr style="background:#e8f5e9;"><td style="padding-left:10px;"><strong>F</strong> å›ºå®šè²»ç”¨äºˆç®—</td>';
            var fixedTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = rakumyInputs[m] ? rakumyInputs[m].fixedCostTotal : 0;
                fixedTotal += val;
                html += '<td class="output-cell" style="background:#e8f5e9;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#c8e6c9;">' + fmtYen(fixedTotal) + '</td><td class="avg-col" style="background:#c8e6c9;">' + fmtYen(fixedTotal / activeMonths.length) + '</td></tr>';

            // å¤‰å‹•è²»ç‡ï¼ˆVRï¼‰
            html += '<tr style="background:#e8f5e9;"><td style="padding-left:10px;"><strong>VR</strong> å¤‰å‹•è²»ç‡ï¼ˆFD%+PA%ï¼‰</td>';
            for (var m = 0; m < activeMonths.length; m++) {
                var fdRate = rakumyInputs[m] ? rakumyInputs[m].fdRate : 0;
                var paRate = rakumyInputs[m] ? rakumyInputs[m].paRate : 0;
                html += '<td class="output-cell" style="background:#e8f5e9;">' + fmtRate(fdRate + paRate) + '%</td>';
            }
            html += '<td class="total-col" style="background:#c8e6c9;">-</td><td class="avg-col" style="background:#c8e6c9;">-</td></tr>';

            // === STEP 1-3: MQå…¥åŠ›å€¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›/é¡§å®¢äºˆç®—ã‹ã‚‰åˆæˆï¼‰ ===
            html += '<tr style="background:#2196f3;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;text-align:center;padding:12px;font-size:14px;">ã€STEP 1-3ã€‘MQå…¥åŠ›å€¤</td></tr>';

            // ç›®æ¨™æœˆæ¬¡åˆ©ç›Šï¼ˆGï¼‰- å††å˜ä½è¡¨ç¤º
            html += '<tr style="background:#e3f2fd;"><td style="padding-left:10px;"><strong>G</strong> ç›®æ¨™æœˆæ¬¡åˆ©ç›Š</td>';
            var profitTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = rakumyInputs[m] ? rakumyInputs[m].targetProfit : 0;
                profitTotal += val;
                html += '<td class="output-cell" style="background:#e3f2fd;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;">' + fmtYen(profitTotal) + '</td><td class="avg-col" style="background:#bbdefb;">' + fmtYen(profitTotal / activeMonths.length) + '</td></tr>';

            // FDä»•å…¥è²»ç‡
            html += '<tr style="background:#e3f2fd;"><td style="padding-left:10px;"><strong>FD%</strong> FDä»•å…¥è²»ç‡</td>';
            for (var m = 0; m < activeMonths.length; m++) {
                var val = rakumyInputs[m] ? rakumyInputs[m].fdRate : 0;
                html += '<td class="output-cell" style="background:#e3f2fd;">' + fmtRate(val) + '%</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;">-</td><td class="avg-col" style="background:#bbdefb;">-</td></tr>';

            // PAäººä»¶è²»ç‡
            html += '<tr style="background:#e3f2fd;"><td style="padding-left:10px;"><strong>PA%</strong> PAäººä»¶è²»ç‡</td>';
            for (var m = 0; m < activeMonths.length; m++) {
                var val = rakumyInputs[m] ? rakumyInputs[m].paRate : 0;
                html += '<td class="output-cell" style="background:#e3f2fd;">' + fmtRate(val) + '%</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;">-</td><td class="avg-col" style="background:#bbdefb;">-</td></tr>';

            // ç›®æ¨™å®¢å˜ä¾¡ï¼ˆPï¼‰
            html += '<tr style="background:#e3f2fd;"><td style="padding-left:10px;"><strong>P</strong> ç›®æ¨™å®¢å˜ä¾¡ï¼ˆç¨æŠœï¼‰</td>';
            for (var m = 0; m < activeMonths.length; m++) {
                var val = rakumyInputs[m] ? rakumyInputs[m].targetUnitPrice : 0;
                html += '<td class="output-cell" style="background:#e3f2fd;">' + fmt(val) + 'å††</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;">-</td><td class="avg-col" style="background:#bbdefb;">-</td></tr>';

            // === MQé€†ç®—éç¨‹ ===
            html += '<tr style="background:#ff9800;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;text-align:center;padding:12px;font-size:14px;">ã€MQé€†ç®—ã€‘å¿…è¦ç²—åˆ© â†’ å¿…è¦å£²ä¸Š â†’ ç›®æ¨™å®¢æ•°</td></tr>';

            // ç²—åˆ©ç‡ï¼ˆMR = 100% - VRï¼‰
            html += '<tr style="background:#fff3e0;"><td style="padding-left:10px;"><strong>MR</strong> ç²—åˆ©ç‡ï¼ˆ100%-VRï¼‰</td>';
            for (var m = 0; m < activeMonths.length; m++) {
                var vr = mqOutputs[m] ? mqOutputs[m].variableRate : 0;
                var mr = 100 - vr;
                html += '<td class="output-cell" style="background:#fff3e0;">' + fmtRate(mr) + '%</td>';
            }
            html += '<td class="total-col" style="background:#ffe0b2;">-</td><td class="avg-col" style="background:#ffe0b2;">-</td></tr>';

            // ç²—åˆ©å˜ä¾¡ï¼ˆM = P Ã— MRï¼‰
            html += '<tr style="background:#fff3e0;"><td style="padding-left:10px;"><strong>M</strong> ç²—åˆ©å˜ä¾¡ï¼ˆPÃ—MRï¼‰</td>';
            for (var m = 0; m < activeMonths.length; m++) {
                var p = rakumyInputs[m] ? rakumyInputs[m].targetUnitPrice : 0;
                var vr = mqOutputs[m] ? mqOutputs[m].variableRate : 0;
                var mr = (100 - vr) / 100;
                var margin = p * mr;
                html += '<td class="output-cell" style="background:#fff3e0;">' + fmt(Math.round(margin)) + 'å††</td>';
            }
            html += '<td class="total-col" style="background:#ffe0b2;">-</td><td class="avg-col" style="background:#ffe0b2;">-</td></tr>';

            // å¿…è¦ç²—åˆ©ï¼ˆF + Gï¼‰- å††å˜ä½è¡¨ç¤º
            html += '<tr style="background:#fff3e0;"><td style="padding-left:10px;"><strong>F+G</strong> å¿…è¦ç²—åˆ©ï¼ˆå›ºå®šè²»+ç›®æ¨™åˆ©ç›Šï¼‰</td>';
            var reqGrossTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = mqOutputs[m] ? mqOutputs[m].requiredGrossProfit : 0;
                reqGrossTotal += val;
                html += '<td class="output-cell" style="background:#fff3e0;font-weight:bold;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#ffe0b2;font-weight:bold;">' + fmtYen(reqGrossTotal) + '</td><td class="avg-col" style="background:#ffe0b2;">' + fmtYen(reqGrossTotal / activeMonths.length) + '</td></tr>';

            // å¿…è¦å£²ä¸Šï¼ˆ(F+G) / MRï¼‰- å††å˜ä½è¡¨ç¤º
            html += '<tr style="background:#fff3e0;"><td style="padding-left:10px;"><strong>(F+G)/MR</strong> å¿…è¦å£²ä¸Š</td>';
            var reqSalesTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = mqOutputs[m] ? mqOutputs[m].requiredSales : 0;
                reqSalesTotal += val;
                html += '<td class="output-cell" style="background:#fff3e0;font-weight:bold;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#ffe0b2;font-weight:bold;">' + fmtYen(reqSalesTotal) + '</td><td class="avg-col" style="background:#ffe0b2;">' + fmtYen(reqSalesTotal / activeMonths.length) + '</td></tr>';

            // ç›®æ¨™å®¢æ•°ï¼ˆQ = å¿…è¦å£²ä¸ŠÃ—1000 / Pï¼‰
            html += '<tr style="background:#ffcc80;"><td style="padding-left:10px;"><strong>Q</strong> ç›®æ¨™å®¢æ•°ï¼ˆå¿…è¦å£²ä¸ŠÃ—1000/Pï¼‰</td>';
            var customerTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = mqOutputs[m] ? mqOutputs[m].customers : 0;
                customerTotal += val;
                html += '<td class="output-cell" style="background:#ffcc80;font-weight:bold;color:#e65100;">' + fmt(val) + 'äºº</td>';
            }
            html += '<td class="total-col" style="background:#ffb74d;font-weight:bold;color:#e65100;">' + fmt(customerTotal) + '</td><td class="avg-col" style="background:#ffb74d;">' + fmt(customerTotal / activeMonths.length) + '</td></tr>';

            // === STEP 4: MQå‡ºåŠ›çµæœ ===
            html += '<tr style="background:#9c27b0;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;text-align:center;padding:12px;font-size:14px;">ã€STEP 4ã€‘MQå‡ºåŠ›çµæœï¼ˆãƒ©ã‚¯ãƒŸãƒ¼äºˆç®—å€¤ï¼‰</td></tr>';

            var outputItems = [
                { key: 'sales', name: 'äºˆç®—å£²ä¸Šï¼ˆPÃ—Qï¼‰', highlight: true },
                { key: 'variableCost', name: 'å¤‰å‹•è²»ï¼ˆå£²ä¸ŠÃ—VRï¼‰' },
                { key: 'grossProfit', name: 'ç²—åˆ©ï¼ˆå£²ä¸Š-å¤‰å‹•è²»ï¼‰', highlight: true },
                { key: 'operatingProfit', name: 'å–¶æ¥­åˆ©ç›Šï¼ˆç²—åˆ©-Fï¼‰', highlight: true, profit: true }
            ];
            outputItems.forEach(function(item) {
                var bgColor = item.highlight ? '#f3e5f5' : '#fafafa';
                var totalBg = item.highlight ? '#e1bee7' : '#f5f5f5';
                html += '<tr style="background:' + bgColor + ';"><td style="padding-left:10px;' + (item.highlight ? 'font-weight:bold;' : '') + '">' + item.name + '</td>';
                var total = 0;
                for (var m = 0; m < activeMonths.length; m++) {
                    var val = mqOutputs[m][item.key] || 0;
                    total += val;
                    var textColor = item.profit ? (val >= 0 ? '#2e7d32' : '#c62828') : '#333';
                    html += '<td class="output-cell" style="background:' + bgColor + ';color:' + textColor + ';' + (item.highlight ? 'font-weight:bold;' : '') + '">' + fmtYen(val) + '</td>';
                }
                var totalColor = item.profit ? (total >= 0 ? '#2e7d32' : '#c62828') : '#333';
                html += '<td class="total-col" style="background:' + totalBg + ';color:' + totalColor + ';font-weight:bold;">' + fmtYen(total) + '</td><td class="avg-col" style="background:' + totalBg + ';">' + fmtYen(total / activeMonths.length) + '</td></tr>';
            });

            // === é¡§å®¢äºˆç®—ã¨ã®æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===
            html += '<tr style="background:#1565c0;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;text-align:center;padding:12px;font-size:14px;">â”â”â” é¡§å®¢äºˆç®—ã¨ã®æ¯”è¼ƒ â”â”â”</td></tr>';

            // ===== å£²ä¸Šæ¯”è¼ƒã‚°ãƒ«ãƒ¼ãƒ— =====
            html += '<tr style="background:#263238;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;padding:8px;">ã€å£²ä¸Šã€‘å¯¾æ¯”</td></tr>';

            // MQè¨ˆç®—å£²ä¸Š
            html += '<tr style="background:#e3f2fd;border-left:4px solid #1565c0;"><td style="padding-left:20px;font-weight:bold;">MQè¨ˆç®—å€¤ï¼ˆå£²ä¸Šï¼‰</td>';
            var mqSalesTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = mqOutputs[m].sales || 0;
                mqSalesTotal += val;
                html += '<td class="output-cell" style="background:#e3f2fd;font-weight:bold;color:#1565c0;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;font-weight:bold;color:#1565c0;">' + fmtYen(mqSalesTotal) + '</td><td class="avg-col" style="background:#bbdefb;">' + fmtYen(mqSalesTotal / activeMonths.length) + '</td></tr>';

            // é¡§å®¢äºˆç®—å£²ä¸Šï¼ˆItem 4 = å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰ï¼‰
            html += '<tr style="background:#fff8e1;border-left:4px solid #f57c00;"><td style="padding-left:20px;font-weight:bold;">é¡§å®¢äºˆç®—ï¼ˆå£²ä¸Šï¼‰</td>';
            var budgetSalesTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = annualData[4] ? (annualData[4][m] || 0) : 0;
                budgetSalesTotal += val;
                html += '<td class="output-cell" style="background:#fff8e1;font-weight:bold;color:#e65100;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#ffecb3;font-weight:bold;color:#e65100;">' + fmtYen(budgetSalesTotal) + '</td><td class="avg-col" style="background:#ffecb3;">' + fmtYen(budgetSalesTotal / activeMonths.length) + '</td></tr>';

            // å£²ä¸Šå·®ç•°
            html += '<tr style="background:#eceff1;border-left:4px solid #607d8b;"><td style="padding-left:20px;">å·®ç•°ï¼ˆMQ - äºˆç®—ï¼‰</td>';
            var salesDiffTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var mqSales = mqOutputs[m].sales || 0;
                var budgetSales = annualData[4] ? (annualData[4][m] || 0) : 0;  // No.4 å£²ä¸Šé«˜åˆè¨ˆï¼ˆç¨æŠœï¼‰
                var diff = mqSales - budgetSales;
                salesDiffTotal += diff;
                var color = diff >= 0 ? '#2e7d32' : '#c62828';
                var bgColor = diff >= 0 ? '#e8f5e9' : '#ffebee';
                html += '<td class="output-cell" style="color:' + color + ';background:' + bgColor + ';font-weight:bold;">' + (diff >= 0 ? '+' : '') + fmtYen(diff) + '</td>';
            }
            var diffColor = salesDiffTotal >= 0 ? '#2e7d32' : '#c62828';
            var diffBg = salesDiffTotal >= 0 ? '#c8e6c9' : '#ffcdd2';
            html += '<td class="total-col" style="color:' + diffColor + ';background:' + diffBg + ';font-weight:bold;">' + (salesDiffTotal >= 0 ? '+' : '') + fmtYen(salesDiffTotal) + '</td><td class="avg-col" style="background:#eceff1;">-</td></tr>';

            // ===== å–¶æ¥­åˆ©ç›Šæ¯”è¼ƒã‚°ãƒ«ãƒ¼ãƒ— =====
            html += '<tr style="background:#263238;color:white;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;padding:8px;">ã€å–¶æ¥­åˆ©ç›Šã€‘å¯¾æ¯”</td></tr>';

            // MQè¨ˆç®—å–¶æ¥­åˆ©ç›Š
            html += '<tr style="background:#e3f2fd;border-left:4px solid #1565c0;"><td style="padding-left:20px;font-weight:bold;">MQè¨ˆç®—å€¤ï¼ˆå–¶æ¥­åˆ©ç›Šï¼‰</td>';
            var mqProfitTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = mqOutputs[m].operatingProfit || 0;
                mqProfitTotal += val;
                html += '<td class="output-cell" style="background:#e3f2fd;font-weight:bold;color:#1565c0;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#bbdefb;font-weight:bold;color:#1565c0;">' + fmtYen(mqProfitTotal) + '</td><td class="avg-col" style="background:#bbdefb;">' + fmtYen(mqProfitTotal / activeMonths.length) + '</td></tr>';

            // é¡§å®¢äºˆç®—å–¶æ¥­åˆ©ç›Šï¼ˆItem 63 = å–¶æ¥­åˆ©ç›Šï¼‰
            html += '<tr style="background:#fff8e1;border-left:4px solid #f57c00;"><td style="padding-left:20px;font-weight:bold;">é¡§å®¢äºˆç®—ï¼ˆå–¶æ¥­åˆ©ç›Šï¼‰</td>';
            var budgetProfitTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var val = annualData[63] ? (annualData[63][m] || 0) : 0;
                budgetProfitTotal += val;
                html += '<td class="output-cell" style="background:#fff8e1;font-weight:bold;color:#e65100;">' + fmtYen(val) + '</td>';
            }
            html += '<td class="total-col" style="background:#ffecb3;font-weight:bold;color:#e65100;">' + fmtYen(budgetProfitTotal) + '</td><td class="avg-col" style="background:#ffecb3;">' + fmtYen(budgetProfitTotal / activeMonths.length) + '</td></tr>';

            // å–¶æ¥­åˆ©ç›Šå·®ç•°
            html += '<tr style="background:#eceff1;border-left:4px solid #607d8b;"><td style="padding-left:20px;">å·®ç•°ï¼ˆMQ - äºˆç®—ï¼‰</td>';
            var profitDiffTotal = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                var mqProfit = mqOutputs[m].operatingProfit || 0;
                var budgetProfit = annualData[63] ? (annualData[63][m] || 0) : 0;
                var diff = mqProfit - budgetProfit;
                profitDiffTotal += diff;
                var color = diff >= 0 ? '#2e7d32' : '#c62828';
                var bgColor = diff >= 0 ? '#e8f5e9' : '#ffebee';
                html += '<td class="output-cell" style="color:' + color + ';background:' + bgColor + ';font-weight:bold;">' + (diff >= 0 ? '+' : '') + fmtYen(diff) + '</td>';
            }
            var profitDiffColor = profitDiffTotal >= 0 ? '#2e7d32' : '#c62828';
            var profitDiffBg = profitDiffTotal >= 0 ? '#c8e6c9' : '#ffcdd2';
            html += '<td class="total-col" style="color:' + profitDiffColor + ';background:' + profitDiffBg + ';font-weight:bold;">' + (profitDiffTotal >= 0 ? '+' : '') + fmtYen(profitDiffTotal) + '</td><td class="avg-col" style="background:#eceff1;">-</td></tr>';

            table.innerHTML = html;
        }

        function renderBudgetListTable() {
            var table = document.getElementById('budgetListTable');
            if (!table) {
                console.warn('budgetListTable not found');
                return;
            }

            console.log('=== renderBudgetListTable é–‹å§‹ ===');
            console.log('mqOutputs:', mqOutputs);
            console.log('rakumyInputs:', rakumyInputs);
            console.log('activeMonths.length:', activeMonths ? activeMonths.length : 'undefined');

            var html = createMonthHeaders();

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆé‡‘é¡ã¯å††å˜ä½è¡¨ç¤ºï¼‰
            function addRow(name, values, isRate, style) {
                var rowStyle = style ? ' style="' + style + '"' : '';
                html += '<tr' + rowStyle + '><td>' + name + '</td>';
                var total = 0;
                for (var m = 0; m < values.length; m++) {
                    var val = values[m] || 0;
                    total += val;
                    html += '<td class="output-cell">' + (isRate ? fmtRate(val) + '%' : fmtYen(val)) + '</td>';
                }
                if (isRate) {
                    html += '<td class="total-col">-</td><td class="avg-col">' + fmtRate(total / values.length) + '%</td></tr>';
                } else {
                    html += '<td class="total-col">' + fmtYen(total) + '</td><td class="avg-col">' + fmtYen(total / values.length) + '</td></tr>';
                }
            }

            function addSectionHeader(title, bgColor) {
                html += '<tr style="background:' + bgColor + ';color:#fff;"><td colspan="' + (activeMonths.length + 3) + '" style="font-weight:bold;padding:8px;">' + title + '</td></tr>';
            }

            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
            function getMonthlyData(getValue) {
                var result = [];
                for (var m = 0; m < activeMonths.length; m++) {
                    try {
                        result.push(getValue(m));
                    } catch (e) {
                        console.error('getMonthlyData error at month ' + m + ':', e);
                        result.push(0);
                    }
                }
                return result;
            }

            // å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
            function getMqOut(m, key) {
                return mqOutputs && mqOutputs[m] ? (mqOutputs[m][key] || 0) : 0;
            }
            function getRakumy(m, key) {
                return rakumyInputs && rakumyInputs[m] ? (rakumyInputs[m][key] || 0) : 0;
            }

            // ===== ç›®æ¨™è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('ç›®æ¨™è¨­å®š', '#1565c0');
            addRow('æœˆæ¬¡ç›®æ¨™åˆ©ç›Š', getMonthlyData(function(m) { return annualData[63] ? (annualData[63][m] || 0) : 0; }), false);
            addRow('ç›®æ¨™FDä»•å…¥è²»ç‡', getMonthlyData(function(m) { return getRakumy(m, 'fdRate'); }), true);
            addRow('ç›®æ¨™PAäººä»¶è²»ç‡', getMonthlyData(function(m) { return getRakumy(m, 'paRate'); }), true);
            addRow('ç›®æ¨™å®¢å˜ä¾¡', getMonthlyData(function(m) { return getRakumy(m, 'targetUnitPrice'); }), false);
            // ãƒ©ãƒ³ãƒãƒ»ãƒ‡ã‚£ãƒŠãƒ¼å®¢å˜ä¾¡ã¯ãƒ©ã‚¯ãƒŸãƒ¼è¨­å®šå€¤ã‚¿ãƒ–ã®å…¥åŠ›å€¤ã‚’ä½¿ç”¨
            addRow('ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ©ãƒ³ãƒï¼‰', getMonthlyData(function(m) {
                return getRakumy(m, 'targetUnitPriceLunch');
            }), false);
            addRow('ç›®æ¨™å®¢å˜ä¾¡ï¼ˆãƒ‡ã‚£ãƒŠãƒ¼ï¼‰', getMonthlyData(function(m) {
                return getRakumy(m, 'targetUnitPriceDinner');
            }), false);

            // ===== å£²ä¸Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('å£²ä¸Š', '#2e7d32');
            addRow('å£²ä¸Š è¨ˆ', getMonthlyData(function(m) { return getMqOut(m, 'sales'); }), false);
            addRow('ãƒ•ãƒ¼ãƒ‰å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                var sales = getMqOut(m, 'sales');
                var foodRatio = getRakumy(m, 'foodRatio');
                return Math.round(sales * foodRatio / 100);
            }), false);
            addRow('ã€€ãƒ•ãƒ¼ãƒ‰å£²ä¸Šãƒ©ãƒ³ãƒ', getMonthlyData(function(m) {
                var sales = getMqOut(m, 'sales');
                var foodRatio = getRakumy(m, 'foodRatio');
                var lunchRatio = getRakumy(m, 'lunchRatio');
                return Math.round(sales * foodRatio / 100 * lunchRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ•ãƒ¼ãƒ‰å£²ä¸Šãƒ‡ã‚£ãƒŠãƒ¼', getMonthlyData(function(m) {
                var sales = getMqOut(m, 'sales');
                var foodRatio = getRakumy(m, 'foodRatio');
                var dinnerRatio = getRakumy(m, 'dinnerRatio');
                return Math.round(sales * foodRatio / 100 * dinnerRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Š è¨ˆ', getMonthlyData(function(m) {
                var sales = getMqOut(m, 'sales');
                var drinkRatio = getRakumy(m, 'drinkRatio');
                return Math.round(sales * drinkRatio / 100);
            }), false);
            addRow('ã€€ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šãƒ©ãƒ³ãƒ', getMonthlyData(function(m) {
                var sales = getMqOut(m, 'sales');
                var drinkRatio = getRakumy(m, 'drinkRatio');
                var lunchRatio = getRakumy(m, 'lunchRatio');
                return Math.round(sales * drinkRatio / 100 * lunchRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ‰ãƒªãƒ³ã‚¯å£²ä¸Šãƒ‡ã‚£ãƒŠãƒ¼', getMonthlyData(function(m) {
                var sales = getMqOut(m, 'sales');
                var drinkRatio = getRakumy(m, 'drinkRatio');
                var dinnerRatio = getRakumy(m, 'dinnerRatio');
                return Math.round(sales * drinkRatio / 100 * dinnerRatio / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ãã®ä»–å£²ä¸Š è¨ˆï¼ˆã‚µãƒ¼ãƒ“ã‚¹æ–™ç­‰ï¼‰', getMonthlyData(function(m) {
                var sales = getMqOut(m, 'sales');
                var otherRatio = getRakumy(m, 'otherRatio');
                return Math.round(sales * otherRatio / 100);
            }), false);

            // ===== FLã‚³ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('FLã‚³ã‚¹ãƒˆ', '#f57c00');
            addRow('FLã‚³ã‚¹ãƒˆ è¨ˆ', getMonthlyData(function(m) {
                var fdCost = getMqOut(m, 'sales') * getRakumy(m, 'fdRate') / 100;
                var fixedLabor = getRakumy(m, 'fixedLabor');
                var paLabor = getMqOut(m, 'sales') * getRakumy(m, 'paRate') / 100;
                return Math.round(fdCost + fixedLabor + paLabor);
            }), false);
            addRow('FDä»•å…¥ è¨ˆ', getMonthlyData(function(m) {
                return Math.round(getMqOut(m, 'sales') * getRakumy(m, 'fdRate') / 100);
            }), false);
            addRow('ã€€ãƒ•ãƒ¼ãƒ‰ä»•å…¥', getMonthlyData(function(m) {
                var fdCost = getMqOut(m, 'sales') * getRakumy(m, 'fdRate') / 100;
                var foodRatio = getRakumy(m, 'foodRatio') || 70;
                var totalRatio = foodRatio + (getRakumy(m, 'drinkRatio') || 30);
                return Math.round(fdCost * foodRatio / totalRatio);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ‰ãƒªãƒ³ã‚¯ä»•å…¥', getMonthlyData(function(m) {
                var fdCost = getMqOut(m, 'sales') * getRakumy(m, 'fdRate') / 100;
                var drinkRatio = getRakumy(m, 'drinkRatio') || 30;
                var totalRatio = (getRakumy(m, 'foodRatio') || 70) + drinkRatio;
                return Math.round(fdCost * drinkRatio / totalRatio);
            }), false, 'background:#f5f5f5;');
            addRow('äººä»¶è²» è¨ˆ', getMonthlyData(function(m) {
                var fixedLabor = getRakumy(m, 'fixedLabor');
                var paLabor = getMqOut(m, 'sales') * getRakumy(m, 'paRate') / 100;
                var helpLabor = annualData[20] ? (annualData[20][m] || 0) : 0;  // No.20 ãƒ˜ãƒ«ãƒ—äººä»¶è²»
                return Math.round(fixedLabor + paLabor + helpLabor);
            }), false);
            addRow('ã€€å›ºå®šäººä»¶è²»', getMonthlyData(function(m) { return getRakumy(m, 'fixedLabor'); }), false, 'background:#f5f5f5;');
            addRow('ã€€PAäººä»¶è²»', getMonthlyData(function(m) {
                return Math.round(getMqOut(m, 'sales') * getRakumy(m, 'paRate') / 100);
            }), false, 'background:#f5f5f5;');
            addRow('ã€€ãƒ˜ãƒ«ãƒ—äººä»¶è²»', getMonthlyData(function(m) { return annualData[20] ? (annualData[20][m] || 0) : 0; }), false, 'background:#f5f5f5;');

            // ===== ãã®ä»–çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('ãã®ä»–çµŒè²»', '#7b1fa2');
            // ãã®ä»–çµŒè²»åˆè¨ˆ
            var otherExpenseItems = ['rent', 'depreciation', 'material', 'promotion', 'menuCopy', 'survey', 'sanitary', 'service',
                'electricity', 'gas', 'water', 'consumables', 'maintenance', 'taxes', 'entertainment', 'travel',
                'communication', 'creditFee', 'paymentFee', 'meeting', 'membership', 'education', 'training',
                'research', 'recruitment', 'it', 'outsource', 'misc'];

            addRow('ãã®ä»–çµŒè²» è¨ˆ', getMonthlyData(function(m) {
                var total = 0;
                otherExpenseItems.forEach(function(key) {
                    total += getRakumy(m, key);
                });
                return total;
            }), false);

            // å€‹åˆ¥çµŒè²»é …ç›®ï¼ˆè²»ç”¨äºˆç®—è¨­å®šã®å€¤ã‚’ä½¿ç”¨ï¼‰
            var expenseMapping = [
                { key: 'rent', name: 'åœ°ä»£å®¶è³ƒ' },
                { key: 'material', name: 'è³‡æè²»' },
                { key: 'it', name: 'ITè²»' },
                { key: 'gas', name: 'ã‚¬ã‚¹ä»£' },
                { key: 'service', name: 'ã‚µãƒ¼ãƒ“ã‚¹è²»' },
                { key: 'maintenance', name: 'ä¿å®ˆä¿®ç¹•è²»' },
                { key: 'outsource', name: 'å¤–æ³¨è²»' },
                { key: 'paymentFee', name: 'æ”¯æ‰•æ‰‹æ•°æ–™' },
                { key: 'water', name: 'æ°´é“ä»£' },
                { key: 'consumables', name: 'æ¶ˆè€—å“è²»' },
                { key: 'depreciation', name: 'æ¸›ä¾¡å„Ÿå´è²»' },
                { key: 'sanitary', name: 'è¡›ç”Ÿè²»' },
                { key: 'survey', name: 'èª¿æŸ»è²»' },
                { key: 'membership', name: 'è«¸ä¼šè²»' },
                { key: 'promotion', name: 'è²©å£²ä¿ƒé€²è²»' },
                { key: 'communication', name: 'é€šä¿¡è²»' },
                { key: 'misc', name: 'é›‘è²»' },
                { key: 'electricity', name: 'é›»æ°—ä»£' },
                { key: 'creditFee', name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ‰‹æ•°æ–™' }
            ];

            expenseMapping.forEach(function(exp) {
                addRow('ã€€' + exp.name, getMonthlyData(function(m) { return getRakumy(m, exp.key); }), false, 'background:#f5f5f5;');
            });

            // ===== å–¶æ¥­åˆ©ç›Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
            addSectionHeader('å–¶æ¥­åˆ©ç›Š', '#c62828');
            addRow('å–¶æ¥­åˆ©ç›Š', getMonthlyData(function(m) { return getMqOut(m, 'operatingProfit'); }), false, 'font-weight:bold;');

            table.innerHTML = html;
            console.log('=== renderBudgetListTable å®Œäº† ===');
        }

        function renderSummary() {
            var totalSales = 0, totalProfit = 0, totalCustomers = 0, totalVariableRate = 0;
            for (var m = 0; m < activeMonths.length; m++) {
                if (mqOutputs && mqOutputs[m]) {
                    totalSales += mqOutputs[m].sales || 0;
                    totalProfit += mqOutputs[m].operatingProfit || 0;
                    totalCustomers += mqOutputs[m].customers || 0;
                    totalVariableRate += mqOutputs[m].variableRate || 0;
                }
            }
            document.getElementById('summaryGrid').innerHTML = '<div class="summary-card"><div class="summary-label">å¹´é–“å£²ä¸Š</div><div class="summary-value">' + fmtYen(totalSales) + '</div><div class="summary-sub">å††</div></div><div class="summary-card"><div class="summary-label">å¹´é–“å–¶æ¥­åˆ©ç›Š</div><div class="summary-value">' + fmtYen(totalProfit) + '</div><div class="summary-sub">å††</div></div><div class="summary-card"><div class="summary-label">å–¶æ¥­åˆ©ç›Šç‡</div><div class="summary-value">' + fmtRate(totalSales > 0 ? totalProfit / totalSales * 100 : 0) + '%</div></div><div class="summary-card"><div class="summary-label">å¹´é–“å®¢æ•°</div><div class="summary-value">' + fmt(totalCustomers) + '</div><div class="summary-sub">äºº</div></div><div class="summary-card"><div class="summary-label">å¹³å‡å®¢å˜ä¾¡</div><div class="summary-value">' + fmt(totalCustomers > 0 ? Math.round(totalSales * 1000 / totalCustomers) : 0) + '</div><div class="summary-sub">å††</div></div><div class="summary-card"><div class="summary-label">å¤‰å‹•è²»ç‡</div><div class="summary-value">' + fmtRate(totalVariableRate / activeMonths.length) + '%</div></div>';

            var judgeHtml = '<table class="annual-table" style="max-width:500px;"><tr><th>é …ç›®</th><th>åˆ¤å®š</th><th>è¨­å®šå…ˆ</th></tr>';
            [{ name: 'åœ°ä»£å®¶è³ƒ', no: 47 }, { name: 'å›ºå®šäººä»¶è²»', no: 10 }, { name: 'é›»æ°—ä»£', no: 26 }, { name: 'ã‚¬ã‚¹ä»£', no: 27 }, { name: 'æ°´é“ä»£', no: 28 }].forEach(function(item) {
                var j = judgments[item.no];
                if (j) judgeHtml += '<tr><td>' + item.name + '</td><td>' + (j.isAnnual ? '<span class="annual-badge">å…¨æœˆåŒä¸€</span>' : '<span class="monthly-badge">æœˆåˆ¥å·®ç•°</span>') + '</td><td>' + (j.isAnnual ? 'è²»ç”¨äºˆç®—è¨­å®š' : 'å˜æœˆè²»ç”¨è¨­å®š') + '</td></tr>';
            });
            judgeHtml += '</table>';
            document.getElementById('judgmentResults').innerHTML = judgeHtml;
        }

        // =====================
        // å±¥æ­´ç®¡ç†æ©Ÿèƒ½
        // =====================
        var HISTORY_KEY = 'rakumy_budget_history';

        // ç¾åœ¨ã®æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime() {
            var now = new Date();
            var y = now.getFullYear();
            var m = ('0' + (now.getMonth() + 1)).slice(-2);
            var d = ('0' + now.getDate()).slice(-2);
            var h = ('0' + now.getHours()).slice(-2);
            var min = ('0' + now.getMinutes()).slice(-2);
            return y + '-' + m + '-' + d + '_' + h + ':' + min;
        }

        // ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼ˆsaveToHistoryã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
        function saveCurrentImportData() {
            saveToHistory();
        }

        // å±¥æ­´ã‚’ä¿å­˜
        function saveToHistory() {
            if (Object.keys(allStoresData).length === 0) {
                alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            var history = loadHistory();
            var storeNames = Object.keys(allStoresData).join(', ');
            var dateTime = formatDateTime();
            var title = dateTime + '_' + storeNames;

            var newEntry = {
                id: Date.now().toString(),
                title: title,
                dateTime: dateTime,
                storeNames: Object.keys(allStoresData),
                storeCount: Object.keys(allStoresData).length,
                data: JSON.parse(JSON.stringify(allStoresData)), // Deep copy
                savedAt: new Date().toISOString()
            };

            history.unshift(newEntry); // æœ€æ–°ã‚’å…ˆé ­ã«

            // æœ€å¤§20ä»¶ã¾ã§ä¿æŒ
            if (history.length > 20) {
                history = history.slice(0, 20);
            }

            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                showStatus('success', 'å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ: ' + title);
                renderSavedHistoryList();
            } catch (e) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                console.error(e);
            }
        }

        // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadHistory() {
            try {
                var data = localStorage.getItem(HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
                return [];
            }
        }

        // å±¥æ­´ã‹ã‚‰å¾©å…ƒ
        function loadFromHistory(id) {
            var history = loadHistory();
            var entry = history.find(function(h) { return h.id === id; });
            if (!entry) {
                alert('å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (Object.keys(allStoresData).length > 0) {
                if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            allStoresData = JSON.parse(JSON.stringify(entry.data)); // Deep copy

            // æœ€åˆã®åº—èˆ—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            var storeNames = Object.keys(allStoresData);
            if (storeNames.length > 0) {
                currentStoreName = storeNames[0];
                var storeData = allStoresData[currentStoreName];
                annualData = storeData.annualData || {};
                calcResults = storeData.calcResults || {};
                rakumyInputs = storeData.rakumyInputs || {};
                mqOutputs = storeData.mqOutputs || {};
                judgments = storeData.judgments || {};
                matchedItems = storeData.matchedItems || [];
                unmatchedItems = storeData.unmatchedItems || [];
                activeMonths = storeData.activeMonths || [];
                monthLabels = storeData.monthLabels || [];
                storeName = currentStoreName;
            }

            // UIæ›´æ–°
            updateStoreSelector();
            updateAllStoresSummary();
            renderAllTables();

            showStatus('success', 'å±¥æ­´ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ: ' + entry.title);
        }

        // å±¥æ­´ã‚’å‰Šé™¤
        function deleteFromHistory(id) {
            if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            var history = loadHistory();
            history = history.filter(function(h) { return h.id !== id; });

            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderSavedHistoryList();
            showStatus('info', 'å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å…¨å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
        function clearAllHistory() {
            if (!confirm('å…¨ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            localStorage.removeItem(HISTORY_KEY);
            renderSavedHistoryList();
            showStatus('info', 'å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å±¥æ­´ãƒªã‚¹ãƒˆã‚’æç”»
        function renderHistoryList() {
            var historySection = document.getElementById('historySection');
            var historyList = document.getElementById('historyList');
            var history = loadHistory();

            // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (!historySection || !historyList) {
                return;
            }

            if (history.length === 0) {
                historySection.style.display = 'none';
                return;
            }

            historySection.style.display = 'block';
            var html = '';

            history.forEach(function(entry) {
                html += '<div class="history-item">';
                html += '<div class="history-title">' + escapeHtml(entry.title) + '</div>';
                html += '<div class="history-meta">';
                html += '<span>ä¿å­˜æ—¥æ™‚: ' + new Date(entry.savedAt).toLocaleString('ja-JP') + '</span>';
                html += '</div>';
                html += '<div class="history-stores">';
                html += '<span>åº—èˆ—æ•°: ' + entry.storeCount + 'åº—èˆ—</span>';
                if (entry.storeNames && entry.storeNames.length > 0) {
                    html += ' (' + entry.storeNames.slice(0, 3).join(', ');
                    if (entry.storeNames.length > 3) html += ' ä»–' + (entry.storeNames.length - 3) + 'åº—èˆ—';
                    html += ')';
                }
                html += '</div>';
                html += '<div class="history-actions">';
                html += '<button class="load-btn" onclick="loadFromHistory(\'' + entry.id + '\')">èª­ã¿è¾¼ã¿</button>';
                html += '<button class="delete-btn" onclick="deleteFromHistory(\'' + entry.id + '\')">å‰Šé™¤</button>';
                html += '</div>';
                html += '</div>';
            });

            historyList.innerHTML = html;
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#39;');
        }

        // å±¥æ­´åˆæœŸåŒ–
        function initHistory() {
            renderSavedHistoryList();
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('info', 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            initHistory();
            updateExportHistoryCount();
            // ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºé †è¨­å®šã®èª­ã¿è¾¼ã¿
            loadCategorySettings();
            // åº—ç•ªè¨­å®šã®èª­ã¿è¾¼ã¿
            loadStoreSettings();
            // å®¢å˜ä¾¡è¨­å®šã®èª­ã¿è¾¼ã¿
            loadUnitPriceSettings();
            // é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ä¸€è¦§ã¯è¨­å®šã‚¿ãƒ–è¡¨ç¤ºæ™‚ã«æç”»ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯åˆæœŸåŒ–ã®ã¿
            renderMappingCategoryFilter();
        });
    </script>
</body>
</html>
